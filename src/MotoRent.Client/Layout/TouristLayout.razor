@inherits LayoutComponentBase
@using MotoRent.Domain.Tourist
@using MotoRent.Services.Tourist
@using MotoRent.Client.Layout.Templates
@inject NavigationManager NavigationManager
@inject ITenantResolverService TenantResolver
@inject IJSRuntime JS

<ModalContainer />
<ToastContainer />

@* Cascade tenant context to all tourist components *@
<CascadingValue Value="m_tenantContext" IsFixed="false">
    @if (m_loading)
    {
        @* Loading State *@
        <div class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-secondary">Loading rental shop...</p>
            </div>
        </div>
    }
    else if (m_tenantContext?.IsLoaded == true)
    {
        @* Inject dynamic theme CSS variables and tourist CSS *@
        <HeadContent>
            <link rel="stylesheet" href="css/tourist.css" />
            <style>
                :root {
                    --tenant-primary: @m_tenantContext.Branding.PrimaryColor;
                    --tenant-secondary: @m_tenantContext.Branding.SecondaryColor;
                    --tenant-accent: @m_tenantContext.Branding.AccentColor;
                    --tenant-text-on-primary: @m_tenantContext.Branding.TextOnPrimary;
                }

                /* Override Tabler primary color for tenant branding */
                .btn-primary {
                    --tblr-btn-bg: var(--tenant-primary);
                    --tblr-btn-border-color: var(--tenant-primary);
                    --tblr-btn-hover-bg: var(--tenant-secondary);
                    --tblr-btn-hover-border-color: var(--tenant-secondary);
                }

                .btn-outline-primary {
                    --tblr-btn-color: var(--tenant-primary);
                    --tblr-btn-border-color: var(--tenant-primary);
                    --tblr-btn-hover-bg: var(--tenant-primary);
                    --tblr-btn-hover-border-color: var(--tenant-primary);
                }

                .text-primary {
                    color: var(--tenant-primary) !important;
                }

                .bg-primary {
                    background-color: var(--tenant-primary) !important;
                }

                /* Tourist hero gradient */
                .tourist-hero {
                    background: linear-gradient(135deg, var(--tenant-primary) 0%, var(--tenant-secondary) 100%);
                    color: var(--tenant-text-on-primary);
                }

                .tourist-header {
                    border-bottom: 2px solid var(--tenant-primary);
                }
            </style>
            @if (!string.IsNullOrEmpty(m_tenantContext.Branding.CustomCss))
            {
                <style>@((MarkupString)m_tenantContext.Branding.CustomCss)</style>
            }
        </HeadContent>

        @* Render layout based on template selection *@
        @switch (m_tenantContext.Branding.LayoutTemplate?.ToLower())
        {
            case "classic":
                <ClassicTouristTemplate Context="@m_tenantContext">@Body</ClassicTouristTemplate>
                break;
            case "minimal":
                <MinimalTouristTemplate Context="@m_tenantContext">@Body</MinimalTouristTemplate>
                break;
            default:
                <ModernTouristTemplate Context="@m_tenantContext">@Body</ModernTouristTemplate>
                break;
        }
    }
    else
    {
        @* Tenant Not Found *@
        <TenantNotFound />
    }
</CascadingValue>

@code {
    private TenantContext? m_tenantContext;
    private bool m_loading = true;
    private string? m_currentAccountNo;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation changes to detect tenant changes
        NavigationManager.LocationChanged += OnLocationChanged;
        await LoadTenantFromUrl();
    }

    protected override async Task OnParametersSetAsync()
    {
        var accountNo = ExtractAccountNoFromUrl();
        if (accountNo != m_currentAccountNo)
        {
            await LoadTenantFromUrl();
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        var accountNo = ExtractAccountNoFromUrl();
        if (accountNo != m_currentAccountNo)
        {
            await LoadTenantFromUrl();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadTenantFromUrl()
    {
        var accountNo = ExtractAccountNoFromUrl();
        m_currentAccountNo = accountNo;

        if (string.IsNullOrEmpty(accountNo))
        {
            m_tenantContext = null;
            m_loading = false;
            return;
        }

        try
        {
            m_loading = true;
            m_tenantContext = await TenantResolver.ResolveByAccountNoAsync(accountNo);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tenant: {ex.Message}");
            m_tenantContext = null;
        }
        finally
        {
            m_loading = false;
        }
    }

    private string? ExtractAccountNoFromUrl()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var path = uri.AbsolutePath;

            // Pattern: /tourist/{accountNo}/...
            if (path.StartsWith("/tourist/", StringComparison.OrdinalIgnoreCase))
            {
                var segments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
                if (segments.Length >= 2)
                {
                    return segments[1];
                }
            }
        }
        catch
        {
            // Ignore URL parsing errors
        }

        return null;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
