@inherits LayoutComponentBase
@inject IJSRuntime JS

<MudThemeProvider Theme="MotoRent.Client.MotoRentTheme.Theme" @bind-IsDarkMode="@m_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
                       OnClick="@(_ => m_drawerOpen = !m_drawerOpen)" />
        <MudIcon Icon="@Icons.Material.Filled.TwoWheeler" Class="mr-2" />
        <MudText Typo="Typo.h6" Class="ml-2">MotoRent</MudText>
        <MudSpacer />
        <MudIconButton Icon="@(m_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit" OnClick="@(_ => m_isDarkMode = !m_isDarkMode)" />
    </MudAppBar>

    <MudDrawer @bind-Open="m_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="my-4 pt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@* PWA Install Banner *@
@if (m_showInstallBanner && m_isInstallable)
{
    <MudPaper Elevation="4" Style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; background: linear-gradient(135deg, #00897B 0%, #00695C 100%);">
        <MudContainer MaxWidth="MaxWidth.Large">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="py-3">
                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                    <MudAvatar Color="Color.Surface" Size="Size.Large">
                        <MudIcon Icon="@Icons.Material.Filled.TwoWheeler" Color="Color.Primary" />
                    </MudAvatar>
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body1" Style="color: white; font-weight: 500;">
                            Install MotoRent App
                        </MudText>
                        <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8);">
                            Quick access, offline support, and notifications
                        </MudText>
                    </MudStack>
                </MudStack>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Text" Style="color: rgba(255,255,255,0.8);"
                               OnClick="DismissInstallBanner">
                        Not Now
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Surface"
                               StartIcon="@Icons.Material.Filled.GetApp"
                               OnClick="InstallApp">
                        Install
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudContainer>
    </MudPaper>
}

@code {
    private bool m_drawerOpen = true;
    private bool m_isDarkMode;
    private bool m_showInstallBanner = true;
    private bool m_isInstallable;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckInstallability();
        }
    }

    private async Task CheckInstallability()
    {
        try
        {
            var isStandalone = await JS.InvokeAsync<bool>("MotoRentPwa.isStandalone");
            m_isInstallable = await JS.InvokeAsync<bool>("MotoRentPwa.isInstallable");

            // Don't show if already running as PWA
            if (isStandalone)
            {
                m_showInstallBanner = false;
            }

            // Check if user previously dismissed
            var dismissed = await JS.InvokeAsync<string?>("localStorage.getItem", "pwa-install-dismissed");
            if (!string.IsNullOrEmpty(dismissed) && DateTimeOffset.TryParse(dismissed, out var dismissedDate))
            {
                // Show again after 7 days
                if ((DateTimeOffset.Now - dismissedDate).TotalDays < 7)
                {
                    m_showInstallBanner = false;
                }
            }

            StateHasChanged();
        }
        catch
        {
            m_isInstallable = false;
        }
    }

    private async Task InstallApp()
    {
        try
        {
            await JS.InvokeVoidAsync("MotoRentPwa.showInstallPrompt");
            m_showInstallBanner = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Install failed: {ex.Message}");
        }
    }

    private async Task DismissInstallBanner()
    {
        m_showInstallBanner = false;
        await JS.InvokeVoidAsync("localStorage.setItem", "pwa-install-dismissed", DateTimeOffset.Now.ToString("O"));
        StateHasChanged();
    }
}
