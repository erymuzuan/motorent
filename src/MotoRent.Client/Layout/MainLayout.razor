@inherits LayoutComponentBase
@using System.Globalization
@using Microsoft.Extensions.Localization
@using MotoRent.Client.Pages
@inject IJSRuntime Js
@inject IRequestContext RequestContext
@inject CoreDataContext CoreContext
@inject IBinaryStore BinaryStore
@inject NavigationManager Navigation
@inject IStringLocalizer<MainLayout> Localizer
@inject AuthenticationStateProvider AuthStateProvider

<ModalContainer />
<ToastContainer />

<div class="d-flex flex-column min-vh-100">
    @* Combined Header + Menu with single gradient *@
    <div class="mr-navbar-gradient">
        @* Top Navigation Bar *@
        <header class="navbar navbar-expand-md d-print-none sticky-top">
            <div class="container-xl">
                <LogoHeader OnToggle="ToggleNavbar" HomeUrl="@m_homeUrl" DefaultName="@m_orgName" />
            <div class="navbar-nav flex-row order-md-last">
                @* Theme Toggle *@
                <div class="nav-item d-none d-md-flex me-3">
                    <a href="#" class="nav-link px-0" @onclick="ToggleTheme" @onclick:preventDefault>
                        @if (m_isDarkMode)
                        {
                            <i class="ti ti-sun"></i>
                        }
                        else
                        {
                            <i class="ti ti-moon"></i>
                        }
                    </a>
                </div>
                @* Language Toggle *@
                <div class="nav-item d-none d-md-flex me-3">
                    <div class="dropdown">
                        <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" aria-label="@Localizer["SelectLanguage"]" @onclick:preventDefault>
                            <i class="ti ti-language"></i>
                            <span class="ms-1 text-uppercase small fw-bold">@CultureInfo.CurrentCulture.TwoLetterISOLanguageName</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="#" class="dropdown-item @(CultureInfo.CurrentCulture.TwoLetterISOLanguageName == "en" ? "active" : "")" 
                               @onclick='() => SetCulture("en")' @onclick:preventDefault>
                                <span class="avatar avatar-xs me-2">EN</span> English
                            </a>
                            <a href="#" class="dropdown-item @(CultureInfo.CurrentCulture.TwoLetterISOLanguageName == "th" ? "active" : "")" 
                               @onclick='() => SetCulture("th")' @onclick:preventDefault>
                                <span class="avatar avatar-xs me-2">TH</span> ไทย (Thai)
                            </a>
                        </div>
                    </div>
                </div>
                @* Till Status Button (replaces shop selector) *@
                <AuthorizeView Policy="RequireTenantStaff">
                    <Authorized>
                        <TillStatusButton />
                    </Authorized>
                </AuthorizeView>
                @* User Profile Dropdown *@
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown"
                       aria-label="Open user menu">
                        @if (!string.IsNullOrWhiteSpace(m_userPhotoUrl))
                        {
                            <span class="avatar avatar-sm" style="background-image: url('@m_userPhotoUrl')"></span>
                        }
                        else if (!string.IsNullOrWhiteSpace(m_userInitials))
                        {
                            <span class="avatar avatar-sm bg-primary text-white">@m_userInitials</span>
                        }
                        else
                        {
                            <span class="avatar avatar-sm bg-primary text-white">
                                <i class="ti ti-user"></i>
                            </span>
                        }
                        <div class="d-none d-xl-block ps-2">
                            <div>@(RequestContext.GetUserName() ?? "User")</div>
                            <div class="mt-1 small text-secondary">@(RequestContext.GetAccountNo() ?? "Not signed in")</div>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                        <a href="/account/profile" class="dropdown-item">@Localizer["Profile"]</a>
                        <a href="/account/settings" class="dropdown-item">@Localizer["Settings"]</a>

                        @* Show Super Admin link for super admins (not when impersonating) *@
                        <AuthorizeView Roles="@UserAccount.SUPER_ADMIN">
                            <Authorized>
                                <div class="dropdown-divider"></div>
                                <a href="/super-admin/start-page" class="dropdown-item text-purple">
                                    <i class="ti ti-shield-cog me-2"></i>@Localizer["SuperAdmin"]
                                </a>
                            </Authorized>
                        </AuthorizeView>

                        @* Show impersonation status when impersonating *@
                        <AuthorizeView Policy="@UserAccount.POLICY_SUPER_ADMIN_IMPERSONATE">
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-header text-warning">
                                <i class="ti ti-user-search me-1"></i>@Localizer["Impersonating"]
                            </div>
                            <a href="/account/back-super-admin" class="dropdown-item text-info">
                                <i class="ti ti-arrow-back me-2"></i>@Localizer["BackToSuperAdmin"]
                            </a>
                        </AuthorizeView>

                        <div class="dropdown-divider"></div>
                        <a href="/account/logoff" class="dropdown-item">@Localizer["Logout"]</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

        @* Main Navigation Menu *@
        <div class="navbar-expand-md">
            <div class="collapse navbar-collapse @(m_navbarOpen ? "show" : "")" id="navbar-menu">
                <nav class="navbar navbar-expand">
                    <div class="container-xl justify-content-start">
                        <NavMenu />
                    </div>
                </nav>
            </div>
        </div>
    </div>

    @* Page Content *@
    <main class="flex-grow-1 py-4">
        <div class="container-xl">
            <ErrorBoundary @ref="m_errorBoundary">
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent Context="ex">
                    <ErrorPage Exception="ex" ErrorBoundary="m_errorBoundary" />
                </ErrorContent>
            </ErrorBoundary>
        </div>
    </main>

    @* Footer *@
    <footer class="footer footer-transparent d-print-none border-top py-3">
        <div class="container-xl">
            <div class="row text-center align-items-center flex-row-reverse">
                <div class="col-lg-auto ms-lg-auto">
                    <ul class="list-inline list-inline-dots mb-0">
                        <li class="list-inline-item">
                            <a href="/docs" class="link-secondary">@Localizer["Documentation"]</a>
                        </li>
                        <li class="list-inline-item">
                            <a href="/help" class="link-secondary">@Localizer["Help"]</a>
                        </li>
                    </ul>
                </div>
                <div class="col-12 col-lg-auto mt-3 mt-lg-0">
                    <ul class="list-inline list-inline-dots mb-0">
                        <li class="list-inline-item">
                            Copyright &copy; @DateTime.Now.Year @m_orgName. All rights reserved.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
</div>

@* PWA Install Banner *@
@if (m_showInstallBanner && m_isInstallable)
{
    <div class="position-fixed bottom-0 start-0 end-0" style="z-index: 1050;">
        <div class="alert alert-primary alert-dismissible m-3 shadow-lg" role="alert"
             style="background: linear-gradient(135deg, var(--tblr-primary) 0%, var(--tblr-primary-darken, #00695C) 100%); border: none;">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <span class="avatar bg-white">
                        <img src="images/icons/ios/40.png" alt="@m_orgName" width="28" height="28" />
                    </span>
                </div>
                <div class="flex-fill">
                    <h4 class="alert-title text-white mb-1">@Localizer["InstallAppTitle"]</h4>
                    <div class="text-white-50">@Localizer["InstallAppSubtitle"]</div>
                </div>
                <div class="ms-auto">
                    <button type="button" class="btn btn-ghost-light me-2" @onclick="DismissInstallBanner">
                        @Localizer["NotNow"]
                    </button>
                    <button type="button" class="btn btn-light" @onclick="InstallApp">
                        <i class="ti ti-download me-1"></i>
                        @Localizer["Install"]
                    </button>
                </div>
            </div>
            <a class="btn-close btn-close-white" @onclick="DismissInstallBanner"></a>
        </div>
    </div>
}

@code {
    private ErrorBoundary? m_errorBoundary;
    private bool m_navbarOpen;
    private bool m_isDarkMode;
    private bool m_showInstallBanner = true;
    private bool m_isInstallable;
    private string? m_userPhotoUrl;
    private string? m_userInitials;
    private string m_homeUrl = "/";
    private string m_orgName = "MotoRent";


    private string CurrentPathAndQuery =>
        new Uri(this.Navigation.Uri).GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);

    protected override async Task OnInitializedAsync()
    {
        await this.LoadUserProfileAsync();
        await this.LoadOrganizationNameAsync();
        await this.DetermineHomeUrlAsync();
    }

    private async Task LoadOrganizationNameAsync()
    {
        try
        {
            var accountNo = this.RequestContext.GetAccountNo();
            if (string.IsNullOrEmpty(accountNo)) return;

            var org = await this.CoreContext.LoadOneAsync<Organization>(o => o.AccountNo == accountNo);
            if (org != null && !string.IsNullOrWhiteSpace(org.Name))
            {
                this.m_orgName = org.Name;
            }
        }
        catch
        {
            // Silently fail - use default name
        }
    }

    private async Task DetermineHomeUrlAsync()
    {
        try
        {
            var authState = await this.AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                var isSuperAdmin = user.IsInRole(UserAccount.SUPER_ADMIN);
                var hasTenantRole = UserAccount.AllRoles.Any(role => user.IsInRole(role));

                // SuperAdmin without tenant access (not impersonating) should go to super admin page
                if (isSuperAdmin && !hasTenantRole)
                {
                    m_homeUrl = "/super-admin/start-page";
                }
                else if (hasTenantRole)
                {
                    m_homeUrl = "/dashboard";
                }
            }
            else
            {
                m_homeUrl = "/";
            }
        }
        catch
        {
            // Silently fail - default to "/"
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load user profile after first render (when auth is ready)
            if (string.IsNullOrEmpty(m_userPhotoUrl) && string.IsNullOrEmpty(m_userInitials))
            {
                await LoadUserProfileAsync();
                StateHasChanged();
            }
            await this.CheckInstallability();
            await this.ApplyTheme();
        }
    }

    private async Task LoadUserProfileAsync()
    {
        try
        {
            var userName = this.RequestContext.GetUserName();
            if (string.IsNullOrEmpty(userName)) return;

            var user = await this.CoreContext.LoadOneAsync<User>(u => u.UserName == userName);
            if (user == null) return;

            // Set photo URL if available
            if (!string.IsNullOrWhiteSpace(user.PhotoStoreId))
            {
                m_userPhotoUrl = this.BinaryStore.GetImageUrl(user.PhotoStoreId);
            }

            // Set initials from full name
            if (!string.IsNullOrWhiteSpace(user.FullName))
            {
                var parts = user.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                m_userInitials = parts.Length >= 2
                    ? $"{parts[0][0]}{parts[1][0]}".ToUpper()
                    : user.FullName.Length >= 2
                        ? user.FullName[..2].ToUpper()
                        : user.FullName.ToUpper();
            }
        }
        catch
        {
            // Silently fail - avatar will show default icon
        }
    }

    private void ToggleNavbar()
    {
        this.m_navbarOpen = !this.m_navbarOpen;
    }

    private void SetCulture(string culture)
    {
        var uri = new Uri(this.Navigation.Uri).GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);
        var query = $"?culture={Uri.EscapeDataString(culture)}&redirectUri={Uri.EscapeDataString(uri)}";
        this.Navigation.NavigateTo("/Culture/Set" + query, forceLoad: true);
    }

    private async Task ToggleTheme()
    {
        this.m_isDarkMode = !this.m_isDarkMode;
        await this.ApplyTheme();
    }

    private async Task ApplyTheme()
    {
        var theme = this.m_isDarkMode ? "dark" : "light";
        await this.Js.InvokeVoidAsync("eval", $"document.body.setAttribute('data-bs-theme', '{theme}')");
    }

    private async Task CheckInstallability()
    {
        try
        {
            var isStandalone = await this.Js.InvokeAsync<bool>("MotoRentPwa.isStandalone");
            this.m_isInstallable = await this.Js.InvokeAsync<bool>("MotoRentPwa.isInstallable");

            // Don't show if already running as PWA
            if (isStandalone)
            {
                this.m_showInstallBanner = false;
            }

            // Check if user previously dismissed
            var dismissed = await this.Js.InvokeAsync<string?>("localStorage.getItem", "pwa-install-dismissed");
            if (!string.IsNullOrEmpty(dismissed) && DateTimeOffset.TryParse(dismissed, out var dismissedDate))
            {
                // Show again after 7 days
                if ((DateTimeOffset.Now - dismissedDate).TotalDays < 7)
                {
                    this.m_showInstallBanner = false;
                }
            }

            this.StateHasChanged();
        }
        catch
        {
            this.m_isInstallable = false;
        }
    }

    private async Task InstallApp()
    {
        try
        {
            await this.Js.InvokeVoidAsync("MotoRentPwa.showInstallPrompt");
            this.m_showInstallBanner = false;
            this.StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Install failed: {ex.Message}");
        }
    }

    private async Task DismissInstallBanner()
    {
        this.m_showInstallBanner = false;
        await this.Js.InvokeVoidAsync("localStorage.setItem", "pwa-install-dismissed", DateTimeOffset.Now.ToString("O"));
        this.StateHasChanged();
    }
}
