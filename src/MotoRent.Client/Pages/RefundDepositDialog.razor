@inherits LocalizedDialogBase<Deposit, RefundDepositDialog>
@inject DepositService DepositService

<form id="@FormId" @onsubmit="ProcessRefund" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="alert alert-info mb-3">
            <div class="d-flex align-items-center">
                <i class="ti ti-info-circle me-2"></i>
                <span>Refunding deposit of <strong>@FormatCurrency(Entity.Amount)</strong> to <strong>@RenterName</strong></span>
            </div>
        </div>

        <h4 class="mb-3">Refund Method</h4>

        <div class="mb-3">
            <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column gap-2">
                <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="refund-method" value="Cash" class="form-selectgroup-input"
                           checked="@(m_refundMethod == "Cash")" @onchange="@(() => m_refundMethod = "Cash")" />
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                        <div class="me-3">
                            <span class="form-selectgroup-check"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="ti ti-cash text-success fs-2 me-2"></i>
                            <span>Cash</span>
                        </div>
                    </div>
                </label>

                @if (Entity.DepositType == "CardPreAuth")
                {
                    <label class="form-selectgroup-item flex-fill">
                        <input type="radio" name="refund-method" value="Card" class="form-selectgroup-input"
                               checked="@(m_refundMethod == "Card")" @onchange="@(() => m_refundMethod = "Card")" />
                        <div class="form-selectgroup-label d-flex align-items-center p-3">
                            <div class="me-3">
                                <span class="form-selectgroup-check"></span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="ti ti-credit-card text-primary fs-2 me-2"></i>
                                <span>Return to Card @(!string.IsNullOrEmpty(Entity.CardLast4) ? $"(****{Entity.CardLast4})" : "")</span>
                            </div>
                        </div>
                    </label>
                }

                <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="refund-method" value="BankTransfer" class="form-selectgroup-input"
                           checked="@(m_refundMethod == "BankTransfer")" @onchange="@(() => m_refundMethod = "BankTransfer")" />
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                        <div class="me-3">
                            <span class="form-selectgroup-check"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="ti ti-building-bank text-info fs-2 me-2"></i>
                            <span>Bank Transfer</span>
                        </div>
                    </div>
                </label>

                <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="refund-method" value="QRCode" class="form-selectgroup-input"
                           checked="@(m_refundMethod == "QRCode")" @onchange="@(() => m_refundMethod = "QRCode")" />
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                        <div class="me-3">
                            <span class="form-selectgroup-check"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="ti ti-qrcode text-secondary fs-2 me-2"></i>
                            <span>QR Code (PromptPay)</span>
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <div class="mt-4">
            <label class="form-check">
                <input type="checkbox" class="form-check-input" @bind="m_confirmed" />
                <span class="form-check-label">
                    I confirm the refund of @FormatCurrency(Entity.Amount) has been processed via @m_refundMethod
                </span>
            </label>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        Cancel
    </button>
    <button type="submit" form="@FormId" class="btn btn-success" disabled="@(!m_confirmed || Saving)">
        @if (Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-cash-off me-1"></i>
        Process Refund
    </button>
</div>

@code {
    [Parameter] public string RenterName { get; set; } = "";

    private string m_refundMethod = "Cash";
    private bool m_confirmed;

    protected override void OnInitialized()
    {
        // Default to card refund if original deposit was card pre-auth
        if (this.Entity.DepositType == "CardPreAuth")
        {
            this.m_refundMethod = "Card";
        }
    }

    private async Task ProcessRefund()
    {
        this.Saving = true;
        try
        {
            var result = await this.DepositService.RefundDepositAsync(this.Entity.DepositId, this.m_refundMethod, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError($"Failed to process refund: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            this.Saving = false;
        }
    }
}
