@inherits MotoRentDialogBase<Deposit>
@using MotoRent.Domain.Entities
@using MotoRent.Services
@inject DepositService DepositService

<MudDialog>
    <TitleContent>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.MoneyOff" Color="Color.Success" />
            <MudText Typo="Typo.h6">Refund Deposit</MudText>
        </MudStack>
    </TitleContent>

    <DialogContent>
        <MudStack Spacing="3">
            <MudAlert Severity="Severity.Info" Dense="true">
                <MudText>
                    Refunding deposit of <strong>@FormatCurrency(Entity.Amount)</strong> to <strong>@RenterName</strong>
                </MudText>
            </MudAlert>

            <MudText Typo="Typo.subtitle1">Refund Method</MudText>

            <MudRadioGroup T="string" @bind-Value="m_refundMethod">
                <MudStack Spacing="2">
                    <MudRadio T="string" Value="@("Cash")" Color="Color.Primary">
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Money" Color="Color.Success" Size="Size.Small" />
                            <MudText>Cash</MudText>
                        </MudStack>
                    </MudRadio>

                    @if (Entity.DepositType == "CardPreAuth")
                    {
                        <MudRadio T="string" Value="@("Card")" Color="Color.Primary">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CreditCard" Color="Color.Primary" Size="Size.Small" />
                                <MudText>Return to Card @(!string.IsNullOrEmpty(Entity.CardLast4) ? $"(****{Entity.CardLast4})" : "")</MudText>
                            </MudStack>
                        </MudRadio>
                    }

                    <MudRadio T="string" Value="@("BankTransfer")" Color="Color.Primary">
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" Size="Size.Small" />
                            <MudText>Bank Transfer</MudText>
                        </MudStack>
                    </MudRadio>

                    <MudRadio T="string" Value="@("QRCode")" Color="Color.Primary">
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.QrCode" Color="Color.Secondary" Size="Size.Small" />
                            <MudText>QR Code (PromptPay)</MudText>
                        </MudStack>
                    </MudRadio>
                </MudStack>
            </MudRadioGroup>

            <MudCheckBox T="bool" @bind-Value="m_confirmed" Color="Color.Success"
                         Label="@($"I confirm the refund of {FormatCurrency(Entity.Amount)} has been processed via {m_refundMethod}")" />
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Success" Variant="Variant.Filled"
                   Disabled="@(!m_confirmed || m_saving)"
                   OnClick="ProcessRefund">
            @if (m_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Process Refund
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public string RenterName { get; set; } = "";

    private string m_refundMethod = "Cash";
    private bool m_confirmed;
    private bool m_saving;

    protected override void OnInitialized()
    {
        // Default to card refund if original deposit was card pre-auth
        if (Entity.DepositType == "CardPreAuth")
        {
            m_refundMethod = "Card";
        }
    }

    private async Task ProcessRefund()
    {
        m_saving = true;
        try
        {
            var result = await DepositService.RefundDepositAsync(Entity.DepositId, m_refundMethod, UserName);

            if (result.Success)
            {
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                ShowError($"Failed to process refund: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            ShowError($"Error: {ex.Message}");
        }
        finally
        {
            m_saving = false;
        }
    }
}
