@inherits LocalizedDialogBase<Deposit, RefundDepositDialog>
@inject DepositService DepositService

<form id="@FormId" @onsubmit="ProcessRefund" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="alert alert-info mb-3">
            <div class="d-flex align-items-center">
                <i class="ti ti-info-circle me-2"></i>
                <span>@Localizer["RefundDepositHint", FormatCurrency(Entity.Amount), RenterName]</span>
            </div>
        </div>

        <h4 class="mb-3">@Localizer["RefundMethod"]</h4>

        <div class="mb-3">
            <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column gap-2">
                <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="refund-method" value="Cash" class="form-selectgroup-input"
                           checked="@(m_refundMethod == "Cash")" @onchange="@(() => m_refundMethod = "Cash")" />
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                        <div class="me-3">
                            <span class="form-selectgroup-check"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="ti ti-cash text-success fs-2 me-2"></i>
                            <span>@Localizer["Cash"]</span>
                        </div>
                    </div>
                </label>

                @if (Entity.DepositType == "CardPreAuth")
                {
                    <label class="form-selectgroup-item flex-fill">
                        <input type="radio" name="refund-method" value="Card" class="form-selectgroup-input"
                               checked="@(m_refundMethod == "Card")" @onchange="@(() => m_refundMethod = "Card")" />
                        <div class="form-selectgroup-label d-flex align-items-center p-3">
                            <div class="me-3">
                                <span class="form-selectgroup-check"></span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="ti ti-credit-card text-primary fs-2 me-2"></i>
                                <span>@Localizer["ReturnToCard", Entity.CardLast4 ?? ""]</span>
                            </div>
                        </div>
                    </label>
                }

                <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="refund-method" value="BankTransfer" class="form-selectgroup-input"
                           checked="@(m_refundMethod == "BankTransfer")" @onchange="@(() => m_refundMethod = "BankTransfer")" />
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                        <div class="me-3">
                            <span class="form-selectgroup-check"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="ti ti-building-bank text-info fs-2 me-2"></i>
                            <span>@Localizer["BankTransfer"]</span>
                        </div>
                    </div>
                </label>

                <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="refund-method" value="QRCode" class="form-selectgroup-input"
                           checked="@(m_refundMethod == "QRCode")" @onchange="@(() => m_refundMethod = "QRCode")" />
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                        <div class="me-3">
                            <span class="form-selectgroup-check"></span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="ti ti-qrcode text-secondary fs-2 me-2"></i>
                            <span>@Localizer["QRCode"]</span>
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <div class="mt-4">
            <label class="form-check">
                <input type="checkbox" class="form-check-input" @bind="m_confirmed" />
                <span class="form-check-label">
                    @Localizer["ConfirmRefundProcessed", FormatCurrency(Entity.Amount), Localizer[m_refundMethod]]
                </span>
            </label>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="@FormId" class="btn btn-success" disabled="@(!m_confirmed || Saving)">
        @if (Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-cash-off me-1"></i>
        @Localizer["ProcessRefund"]
    </button>
</div>

@code {
    [Parameter] public string RenterName { get; set; } = string.Empty;

    private string m_refundMethod = "Cash";
    private bool m_confirmed;

    private async Task ProcessRefund()
    {
        this.Saving = true;
        try
        {
            var result = await this.DepositService.RefundDepositAsync(this.Entity.DepositId, this.m_refundMethod, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError(Localizer["RefundFailed", result.Message ?? ""]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["Error", ex.Message]);
        }
        finally
        {
            this.Saving = false;
        }
    }
}
