@inherits LocalizedDialogBase<Agent, AgentDialog>
@inject AgentService AgentService

<form id="@FormId" @onsubmit="SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(this.ActiveTab == "general" ? "active" : "")"
                        @onclick="@(() => this.ActiveTab = "general")">
                    <i class="ti ti-user me-1"></i>
                    @this.Localizer["General"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(this.ActiveTab == "commission" ? "active" : "")"
                        @onclick="@(() => this.ActiveTab = "commission")">
                    <i class="ti ti-percentage me-1"></i>
                    @this.Localizer["Commission"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(this.ActiveTab == "surcharge" ? "active" : "")"
                        @onclick="@(() => this.ActiveTab = "surcharge")">
                    <i class="ti ti-plus me-1"></i>
                    @this.Localizer["Surcharge"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(this.ActiveTab == "invoicing" ? "active" : "")"
                        @onclick="@(() => this.ActiveTab = "invoicing")">
                    <i class="ti ti-file-invoice me-1"></i>
                    @this.Localizer["Invoicing"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(this.ActiveTab == "payment" ? "active" : "")"
                        @onclick="@(() => this.ActiveTab = "payment")">
                    <i class="ti ti-building-bank me-1"></i>
                    @this.Localizer["Payment"]
                </button>
            </li>
        </ul>

        <div class="tab-content">
            @* General Tab *@
            <div class="tab-pane fade @(this.ActiveTab == "general" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label required">@this.Localizer["AgentCode"]</label>
                        <input type="text" class="form-control" @bind="this.Entity.AgentCode"
                               placeholder="TG-001" @bind:event="oninput" />
                        <small class="form-hint">@this.Localizer["AgentCodeHint"]</small>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label required">@this.Localizer["AgentType"]</label>
                        <select class="form-select" @bind="this.Entity.AgentType">
                            @foreach (var type in AgentType.All)
                            {
                                <option value="@type">@this.Localizer[type]</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label required">@this.Localizer["Status"]</label>
                        <select class="form-select" @bind="this.Entity.Status">
                            @foreach (var status in AgentStatus.All)
                            {
                                <option value="@status">@this.Localizer[status]</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">@this.Localizer["AgentName"]</label>
                        <input type="text" class="form-control" @bind="this.Entity.Name" required
                               placeholder="@this.Localizer["AgentNamePlaceholder"]" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["ContactPerson"]</label>
                        <input type="text" class="form-control" @bind="this.Entity.ContactPerson"
                               placeholder="@this.Localizer["ContactPersonPlaceholder"]" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["Phone"]</label>
                        <input type="tel" class="form-control" @bind="this.Entity.Phone"
                               placeholder="+66 XX XXX XXXX" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["Email"]</label>
                        <input type="email" class="form-control" @bind="this.Entity.Email"
                               placeholder="agent@example.com" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">@this.Localizer["Address"]</label>
                        <textarea class="form-control" @bind="this.Entity.Address" rows="2"
                                  placeholder="@this.Localizer["AddressPlaceholder"]"></textarea>
                    </div>

                    <div class="col-12">
                        <label class="form-label">@this.Localizer["Notes"]</label>
                        <textarea class="form-control" @bind="this.Entity.Notes" rows="2"
                                  placeholder="@this.Localizer["NotesPlaceholder"]"></textarea>
                    </div>
                </div>
            </div>

            @* Commission Tab *@
            <div class="tab-pane fade @(this.ActiveTab == "commission" ? "show active" : "")">
                <div class="alert alert-info mb-3">
                    <i class="ti ti-info-circle me-2"></i>
                    @this.Localizer["CommissionInfo"]
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label required">@this.Localizer["CommissionType"]</label>
                        <select class="form-select" @bind="this.Entity.CommissionType">
                            <option value="@AgentCommissionType.Percentage">@this.Localizer["Percentage"]</option>
                            <option value="@AgentCommissionType.FixedPerBooking">@this.Localizer["FixedPerBooking"]</option>
                            <option value="@AgentCommissionType.FixedPerVehicle">@this.Localizer["FixedPerVehicle"]</option>
                            <option value="@AgentCommissionType.FixedPerDay">@this.Localizer["FixedPerDay"]</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">@this.Localizer["CommissionRate"]</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="this.Entity.CommissionRate"
                                   step="0.01" min="0" />
                            <span class="input-group-text">
                                @(this.Entity.CommissionType == AgentCommissionType.Percentage ? "%" : "฿")
                            </span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["MinCommission"]</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="this.Entity.MinCommission"
                                   step="1" min="0" placeholder="@this.Localizer["Optional"]" />
                            <span class="input-group-text">฿</span>
                        </div>
                        <small class="form-hint">@this.Localizer["MinCommissionHint"]</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["MaxCommission"]</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="this.Entity.MaxCommission"
                                   step="1" min="0" placeholder="@this.Localizer["Optional"]" />
                            <span class="input-group-text">฿</span>
                        </div>
                        <small class="form-hint">@this.Localizer["MaxCommissionHint"]</small>
                    </div>
                </div>

                @* Commission Preview *@
                <div class="card bg-light mt-3">
                    <div class="card-body">
                        <h4 class="card-title">@this.Localizer["CommissionPreview"]</h4>
                        <p class="text-secondary mb-0">
                            @this.GetCommissionPreview()
                        </p>
                    </div>
                </div>
            </div>

            @* Surcharge Tab *@
            <div class="tab-pane fade @(this.ActiveTab == "surcharge" ? "show active" : "")">
                <div class="alert alert-warning mb-3">
                    <i class="ti ti-alert-triangle me-2"></i>
                    @this.Localizer["SurchargeWarning"]
                </div>

                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" @bind="this.Entity.AllowSurcharge" />
                            <span class="form-check-label">@this.Localizer["AllowSurcharge"]</span>
                        </label>
                        <small class="form-hint">@this.Localizer["AllowSurchargeHint"]</small>
                    </div>

                    @if (this.Entity.AllowSurcharge)
                    {
                        <div class="col-md-6">
                            <label class="form-label">@this.Localizer["SurchargeType"]</label>
                            <select class="form-select" @bind="this.Entity.SurchargeType">
                                <option value="@AgentCommissionType.Percentage">@this.Localizer["Percentage"]</option>
                                <option value="@AgentCommissionType.FixedPerBooking">@this.Localizer["FixedPerBooking"]</option>
                                <option value="@AgentCommissionType.FixedPerVehicle">@this.Localizer["FixedPerVehicle"]</option>
                                <option value="@AgentCommissionType.FixedPerDay">@this.Localizer["FixedPerDay"]</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">@this.Localizer["DefaultSurchargeRate"]</label>
                            <div class="input-group">
                                <input type="number" class="form-control" @bind="this.Entity.DefaultSurchargeRate"
                                       step="0.01" min="0" />
                                <span class="input-group-text">
                                    @(this.Entity.SurchargeType == AgentCommissionType.Percentage ? "%" : "฿")
                                </span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-check form-switch">
                                <input type="checkbox" class="form-check-input" @bind="this.Entity.SurchargeHiddenFromCustomer" />
                                <span class="form-check-label">@this.Localizer["HideSurchargeFromCustomer"]</span>
                            </label>
                            <small class="form-hint">@this.Localizer["HideSurchargeHint"]</small>
                        </div>
                    }
                </div>
            </div>

            @* Invoicing Tab *@
            <div class="tab-pane fade @(this.ActiveTab == "invoicing" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" @bind="this.Entity.CanGenerateInvoice" />
                            <span class="form-check-label">@this.Localizer["CanGenerateInvoice"]</span>
                        </label>
                        <small class="form-hint">@this.Localizer["CanGenerateInvoiceHint"]</small>
                    </div>

                    @if (this.Entity.CanGenerateInvoice)
                    {
                        <div class="col-md-6">
                            <label class="form-label">@this.Localizer["InvoicePrefix"]</label>
                            <input type="text" class="form-control" @bind="this.Entity.InvoicePrefix"
                                   placeholder="HTL-INV-" />
                            <small class="form-hint">@this.Localizer["InvoicePrefixHint"]</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">@this.Localizer["DefaultInvoiceNotes"]</label>
                            <textarea class="form-control" @bind="this.Entity.InvoiceNotes" rows="3"
                                      placeholder="@this.Localizer["InvoiceNotesPlaceholder"]"></textarea>
                        </div>
                    }
                </div>
            </div>

            @* Payment Tab *@
            <div class="tab-pane fade @(this.ActiveTab == "payment" ? "show active" : "")">
                <div class="alert alert-info mb-3">
                    <i class="ti ti-info-circle me-2"></i>
                    @this.Localizer["PaymentInfo"]
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["BankName"]</label>
                        <select class="form-select" @bind="this.Entity.BankName">
                            <option value="">@this.Localizer["SelectBank"]</option>
                            <option value="Bangkok Bank">Bangkok Bank</option>
                            <option value="Kasikorn Bank">Kasikorn Bank (KBank)</option>
                            <option value="Siam Commercial Bank">Siam Commercial Bank (SCB)</option>
                            <option value="Krungthai Bank">Krungthai Bank</option>
                            <option value="Bank of Ayudhya">Bank of Ayudhya (Krungsri)</option>
                            <option value="TMBThanachart Bank">TMBThanachart Bank (ttb)</option>
                            <option value="Government Savings Bank">Government Savings Bank (GSB)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["BankAccountNo"]</label>
                        <input type="text" class="form-control" @bind="this.Entity.BankAccountNo"
                               placeholder="XXX-X-XXXXX-X" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["BankAccountName"]</label>
                        <input type="text" class="form-control" @bind="this.Entity.BankAccountName"
                               placeholder="@this.Localizer["AccountNamePlaceholder"]" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@this.Localizer["PromptPayId"]</label>
                        <input type="text" class="form-control" @bind="this.Entity.PromptPayId"
                               placeholder="@this.Localizer["PromptPayPlaceholder"]" />
                        <small class="form-hint">@this.Localizer["PromptPayHint"]</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @this.Localizer["Cancel"]
    </button>
    <button type="submit" form="@this.FormId" class="btn btn-primary" disabled="@this.Saving">
        @if (this.Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-device-floppy me-1"></i>
        @this.SaveButtonText
    </button>
</div>

@code {
    private string ActiveTab { get; set; } = "general";

    protected override void OnInitialized()
    {
        this.FormValid = true;
    }

    private string GetCommissionPreview()
    {
        var example = 3000m; // Example booking of 3000 THB
        var commission = this.Entity.CommissionType switch
        {
            AgentCommissionType.Percentage => example * this.Entity.CommissionRate / 100m,
            AgentCommissionType.FixedPerBooking => this.Entity.CommissionRate,
            AgentCommissionType.FixedPerVehicle => this.Entity.CommissionRate * 2, // Assume 2 vehicles
            AgentCommissionType.FixedPerDay => this.Entity.CommissionRate * 3, // Assume 3 days
            _ => 0m
        };

        // Apply min/max
        if (this.Entity.MinCommission.HasValue && commission < this.Entity.MinCommission.Value)
            commission = this.Entity.MinCommission.Value;
        if (this.Entity.MaxCommission.HasValue && commission > this.Entity.MaxCommission.Value)
            commission = this.Entity.MaxCommission.Value;

        return this.Entity.CommissionType switch
        {
            AgentCommissionType.Percentage =>
                $"For a ฿{example:N0} booking: ฿{commission:N0} commission ({this.Entity.CommissionRate}%)",
            AgentCommissionType.FixedPerBooking =>
                $"฿{this.Entity.CommissionRate:N0} per booking",
            AgentCommissionType.FixedPerVehicle =>
                $"For 2 vehicles: ฿{commission:N0} commission (฿{this.Entity.CommissionRate:N0}/vehicle)",
            AgentCommissionType.FixedPerDay =>
                $"For 3 days: ฿{commission:N0} commission (฿{this.Entity.CommissionRate:N0}/day)",
            _ => ""
        };
    }

    private async Task SaveAsync()
    {
        this.Saving = true;

        try
        {
            // Generate agent code if new and empty
            if (this.IsNew && string.IsNullOrWhiteSpace(this.Entity.AgentCode))
            {
                this.Entity.AgentCode = await this.AgentService.GenerateAgentCodeAsync(this.Entity.AgentType);
            }

            var result = this.IsNew
                ? await this.AgentService.CreateAgentAsync(this.Entity, this.UserName)
                : await this.AgentService.UpdateAgentAsync(this.Entity, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError($"Save failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            this.Saving = false;
        }
    }
}
