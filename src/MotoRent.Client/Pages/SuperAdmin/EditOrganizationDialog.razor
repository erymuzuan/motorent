@using MotoRent.Domain.Core
@inherits MotoRentComponentBase
@inject IDirectoryService DirectoryService

<form id="edit-org-form" @onsubmit="SaveOrganization" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label required">Organization Name</label>
                <input type="text" class="form-control" @bind="m_organization.Name" required />
            </div>
            <div class="col-md-6">
                <label class="form-label">Account No (Schema)</label>
                <input type="text" class="form-control" value="@m_organization.AccountNo" disabled />
                <small class="form-hint">Cannot be changed after creation</small>
            </div>

            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">Contact Information</h4>
            </div>

            <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" @bind="m_organization.Email" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" @bind="m_organization.Phone" />
            </div>

            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">Address</h4>
            </div>

            <div class="col-12">
                <label class="form-label">Street</label>
                <input type="text" class="form-control" @bind="m_organization.Address.Street" />
            </div>
            <div class="col-md-6">
                <label class="form-label">City</label>
                <input type="text" class="form-control" @bind="m_organization.Address.City" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Province/State</label>
                <input type="text" class="form-control" @bind="m_organization.Address.Province" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Postal Code</label>
                <input type="text" class="form-control" @bind="m_organization.Address.PostalCode" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Country</label>
                <input type="text" class="form-control" @bind="m_organization.Address.Country" />
            </div>

            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">Regional Settings</h4>
            </div>

            <div class="col-md-4">
                <label class="form-label">Currency</label>
                <select class="form-select" @bind="m_organization.Currency">
                    <option value="THB">THB - Thai Baht</option>
                    <option value="USD">USD - US Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="MYR">MYR - Malaysian Ringgit</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Language</label>
                <select class="form-select" @bind="m_organization.Language">
                    <option value="th-TH">Thai</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Timezone (UTC offset)</label>
                <input type="number" class="form-control" @bind="m_timezone" min="-12" max="14" />
            </div>

            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">Status</h4>
            </div>

            <div class="col-12">
                <label class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" @bind="m_organization.IsActive" />
                    <span class="form-check-label">@(m_organization.IsActive ? "Active" : "Inactive")</span>
                </label>
            </div>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel" disabled="@m_isSaving">
        Cancel
    </button>
    <button type="submit" form="edit-org-form" class="btn btn-primary" disabled="@m_isSaving">
        @if (m_isSaving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>Saving...</span>
        }
        else
        {
            <i class="ti ti-device-floppy me-1"></i>
            <span>Save Changes</span>
        }
    </button>
</div>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }
    [Parameter] public Organization Organization { get; set; } = null!;

    private Organization m_organization = new();
    private double m_timezone = 7;
    private bool m_isSaving;

    protected override void OnParametersSet()
    {
        // Clone the organization for editing
        this.m_organization = new Organization
        {
            OrganizationId = this.Organization.OrganizationId,
            AccountNo = this.Organization.AccountNo,
            Name = this.Organization.Name,
            Currency = this.Organization.Currency,
            Timezone = this.Organization.Timezone,
            Language = this.Organization.Language,
            FirstDay = this.Organization.FirstDay,
            Subscriptions = this.Organization.Subscriptions,
            IsActive = this.Organization.IsActive,
            WebSite = this.Organization.WebSite,
            DefaultStartPage = this.Organization.DefaultStartPage,
            CompanyNo = this.Organization.CompanyNo,
            TaxNo = this.Organization.TaxNo,
            LogoStoreId = this.Organization.LogoStoreId,
            SmallLogoStoreId = this.Organization.SmallLogoStoreId,
            Email = this.Organization.Email,
            Phone = this.Organization.Phone,
            Address = new Address
            {
                Street = this.Organization.Address?.Street,
                City = this.Organization.Address?.City,
                Province = this.Organization.Address?.Province,
                PostalCode = this.Organization.Address?.PostalCode,
                Country = this.Organization.Address?.Country ?? "Thailand"
            }
        };
        this.m_timezone = this.m_organization.Timezone ?? 7;
    }

    private void Cancel() => this.ModalInstance?.Cancel();

    private async Task SaveOrganization()
    {
        if (string.IsNullOrWhiteSpace(this.m_organization.Name))
        {
            this.ShowError("Organization name is required");
            return;
        }

        this.m_isSaving = true;

        try
        {
            this.m_organization.Timezone = this.m_timezone;
            await this.DirectoryService.SaveOrganizationAsync(this.m_organization);

            this.ModalInstance?.Close(this.m_organization);
        }
        catch (Exception ex)
        {
            this.ShowError($"Error saving organization: {ex.Message}");
        }
        finally
        {
            this.m_isSaving = false;
        }
    }
}
