@page "/super-admin/impersonate"
@rendermode InteractiveServer
@using System.Security.Cryptography
@using System.Text
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Core
@using MotoRent.Domain.DataContext
@attribute [Authorize(Roles = UserAccount.SUPER_ADMIN)]
@inject CoreDataContext CoreContext
@inject ISubscriptionService SubscriptionService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS

<PageTitle>Impersonate User - MotoRent</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h4">Impersonate User</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Sign in as another user to troubleshoot issues or test functionality
            </MudText>
        </div>
        <MudButton Variant="Variant.Text" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.ArrowBack" Href="/super-admin/start-page">
            Back to Dashboard
        </MudButton>
    </MudStack>

    <!-- Search and Filter -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="m_searchTerm" Placeholder="Search by username, email, or name..."
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="ApplyFilters"
                          Style="max-width: 400px;" />

            <MudSelect T="string" Value="m_organizationFilter" Label="Organization"
                       Style="width: 250px;" ValueChanged="OnOrganizationFilterChanged" Clearable="true">
                @foreach (var org in m_organizations)
                {
                    <MudSelectItem Value="@org.AccountNo">@org.Name (@org.AccountNo)</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </MudPaper>

    @if (m_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <!-- Users DataGrid -->
    <MudPaper Elevation="2">
        <MudDataGrid T="User" Items="@m_filteredUsers" Hover="true" Striped="true"
                     Loading="@m_loading" Dense="true">
            <Columns>
                <PropertyColumn Property="x => x.UserName" Title="Username" />
                <PropertyColumn Property="x => x.FullName" Title="Full Name" />
                <PropertyColumn Property="x => x.Email" Title="Email" />
                <TemplateColumn Title="Provider">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@GetProviderColor(context.Item.CredentialProvider)">
                            @context.Item.CredentialProvider
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Status">
                    <CellTemplate>
                        @if (context.Item.IsLockedOut)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error">Locked</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Organizations">
                    <CellTemplate>
                        <MudStack Row="true" Spacing="1" Wrap="Wrap.Wrap">
                            @foreach (var account in context.Item.AccountCollection)
                            {
                                var org = m_organizations.FirstOrDefault(o => o.AccountNo == account.AccountNo);
                                var tooltip = $"{org?.Name ?? account.AccountNo}\nRoles: {string.Join(", ", account.Roles)}";
                                <MudTooltip Text="@tooltip">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                             OnClick="@(() => ImpersonateUser(context.Item, account))"
                                             Style="cursor: pointer;">
                                        @account.AccountNo
                                        <MudIcon Icon="@Icons.Material.Filled.Login" Size="Size.Small" Class="ml-1" />
                                    </MudChip>
                                </MudTooltip>
                            }
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                            <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy"
                                         OnClick="@(() => ShowImpersonationUrls(context.Item))">
                                Copy Impersonation URL
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Visibility"
                                         OnClick="@(() => ViewUserDetails(context.Item))">
                                View Details
                            </MudMenuItem>
                        </MudMenu>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <NoRecordsContent>
                <MudText>No users found matching your criteria.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudDataGridPager T="User" PageSizeOptions="new[] { 10, 20, 50, 100 }" />
            </PagerContent>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    private List<User> m_users = [];
    private List<User> m_filteredUsers = [];
    private List<Organization> m_organizations = [];
    private bool m_loading = true;
    private string? m_searchTerm;
    private string? m_organizationFilter;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        m_loading = true;
        try
        {
            // Load all users
            var usersQuery = CoreContext.Users.OrderBy(u => u.UserName);
            var usersResult = await CoreContext.LoadAsync(usersQuery, page: 1, size: 1000);
            m_users = usersResult.ItemCollection
                .Where(u => u.AccountCollection.Count > 0) // Only users with org membership
                .ToList();

            // Load all organizations for filter dropdown
            var orgs = await SubscriptionService.GetAllOrganizationsAsync();
            m_organizations = orgs.ToList();

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            m_loading = false;
        }
    }

    private void ApplyFilters()
    {
        m_filteredUsers = m_users
            .Where(MatchesSearch)
            .Where(MatchesOrganization)
            .ToList();
    }

    private bool MatchesSearch(User user)
    {
        if (string.IsNullOrWhiteSpace(m_searchTerm)) return true;
        var term = m_searchTerm.ToLowerInvariant();
        return (user.UserName?.ToLowerInvariant().Contains(term) ?? false) ||
               (user.FullName?.ToLowerInvariant().Contains(term) ?? false) ||
               (user.Email?.ToLowerInvariant().Contains(term) ?? false);
    }

    private bool MatchesOrganization(User user)
    {
        if (string.IsNullOrWhiteSpace(m_organizationFilter)) return true;
        return user.AccountCollection.Any(a => a.AccountNo == m_organizationFilter);
    }

    private void OnOrganizationFilterChanged(string? value)
    {
        m_organizationFilter = value;
        ApplyFilters();
    }

    private void ImpersonateUser(User user, UserAccount account)
    {
        var hash = ComputeMd5Hash($"{user.UserName}:{account.AccountNo}");
        var url = $"/account/impersonate?user={Uri.EscapeDataString(user.UserName)}&account={Uri.EscapeDataString(account.AccountNo)}&hash={hash}";
        NavigationManager.NavigateTo(url, forceLoad: true);
    }

    private async Task ShowImpersonationUrls(User user)
    {
        var parameters = new DialogParameters<ImpersonationUrlDialog>
        {
            { x => x.User, user },
            { x => x.Organizations, m_organizations }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<ImpersonationUrlDialog>("Impersonation URLs", parameters, options);
    }

    private async Task ViewUserDetails(User user)
    {
        var accounts = string.Join("\n", user.AccountCollection.Select(a =>
            $"  - {a.AccountNo}: {string.Join(", ", a.Roles)}"));

        var message = $"""
            Username: {user.UserName}
            Full Name: {user.FullName}
            Email: {user.Email}
            Provider: {user.CredentialProvider}
            Locked: {user.IsLockedOut}

            Accounts:
            {accounts}
            """;

        await DialogService.ShowMessageBox("User Details", message, yesText: "Close");
    }

    private static string ComputeMd5Hash(string input)
    {
        var inputBytes = Encoding.UTF8.GetBytes(input);
        var hashBytes = MD5.HashData(inputBytes);
        return Convert.ToHexString(hashBytes).ToLowerInvariant();
    }

    private static Color GetProviderColor(string provider) => provider switch
    {
        User.GOOGLE => Color.Error,
        User.MICROSOFT => Color.Info,
        _ => Color.Default
    };
}
