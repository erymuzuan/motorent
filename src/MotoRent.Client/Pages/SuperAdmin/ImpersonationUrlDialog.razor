@using System.Security.Cryptography
@using System.Text
@using MotoRent.Domain.Core
@inherits MotoRentComponentBase
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<div class="modal-body">
    <p class="mb-4">
        Impersonation URLs for <strong>@User.FullName</strong> (@User.UserName)
    </p>

    @foreach (var account in User.AccountCollection)
    {
        var org = Organizations.FirstOrDefault(o => o.AccountNo == account.AccountNo);
        var url = GenerateUrl(account.AccountNo);

        <div class="card mb-2">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h4 class="mb-0">@(org?.Name ?? account.AccountNo)</h4>
                        <small class="text-secondary">Roles: @string.Join(", ", account.Roles)</small>
                    </div>
                    <div class="btn-list">
                        <button type="button" class="btn btn-icon btn-ghost-primary" title="Copy URL"
                                @onclick="@(() => CopyToClipboard(url))">
                            <i class="ti ti-copy"></i>
                        </button>
                        <button type="button" class="btn btn-icon btn-ghost-success" title="Impersonate"
                                @onclick="@(() => Impersonate(url))">
                            <i class="ti ti-login"></i>
                        </button>
                    </div>
                </div>
                <div class="input-group input-group-flat">
                    <span class="input-group-text">
                        <i class="ti ti-link"></i>
                    </span>
                    <input type="text" class="form-control form-control-sm" value="@url" readonly
                           style="font-size: 0.75rem;" />
                </div>
            </div>
        </div>
    }
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        Close
    </button>
</div>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }
    [Parameter] public User User { get; set; } = null!;
    [Parameter] public List<Organization> Organizations { get; set; } = [];

    private string GenerateUrl(string accountNo)
    {
        var hash = ComputeMd5Hash($"{this.User.UserName}:{accountNo}");
        var baseUrl = this.NavigationManager.BaseUri.TrimEnd('/');
        return $"{baseUrl}/account/impersonate?user={Uri.EscapeDataString(this.User.UserName)}&account={Uri.EscapeDataString(accountNo)}&hash={hash}";
    }

    private async Task CopyToClipboard(string url)
    {
        await this.JS.InvokeVoidAsync("navigator.clipboard.writeText", url);
        this.ShowSuccess("URL copied to clipboard");
    }

    private void Impersonate(string url)
    {
        this.NavigationManager.NavigateTo(url, forceLoad: true);
    }

    private void Cancel() => this.ModalInstance?.Cancel();

    private static string ComputeMd5Hash(string input)
    {
        var inputBytes = Encoding.UTF8.GetBytes(input);
        var hashBytes = MD5.HashData(inputBytes);
        return Convert.ToHexString(hashBytes).ToLowerInvariant();
    }
}
