@page "/super-admin/organizations"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Core
@attribute [Authorize(Roles = UserAccount.SUPER_ADMIN)]
@inject ISubscriptionService SubscriptionService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Organizations - MotoRent</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h4">Organizations</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Manage tenant organizations and their subscriptions
            </MudText>
        </div>
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateDialog">
            New Organization
        </MudButton>
    </MudStack>

    @if (m_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }

    <MudPaper Elevation="2">
        <MudDataGrid T="Organization" Items="@m_organizations" Hover="true" Striped="true"
                     Loading="@m_loading" Dense="true" Filterable="true" FilterMode="DataGridFilterMode.Simple">
            <Columns>
                <PropertyColumn Property="x => x.AccountNo" Title="Account No" />
                <PropertyColumn Property="x => x.Name" Title="Name" />
                <PropertyColumn Property="x => x.Currency" Title="Currency" />
                <PropertyColumn Property="x => x.Language" Title="Language" />
                <TemplateColumn Title="Status">
                    <CellTemplate>
                        @if (context.Item.IsActive)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error">Inactive</MudChip>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Location">
                    <CellTemplate>
                        @if (context.Item.Address != null)
                        {
                            <MudText Typo="Typo.body2">@context.Item.Address.City, @context.Item.Address.Province</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                         OnClick="@(() => OpenEditDialog(context.Item))">
                                Edit
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.People"
                                         OnClick="@(() => ViewUsers(context.Item))">
                                View Users
                            </MudMenuItem>
                            @if (context.Item.IsActive)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Block" Color="Color.Warning"
                                             OnClick="@(() => DeactivateOrganization(context.Item))">
                                    Deactivate
                                </MudMenuItem>
                            }
                            else
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success"
                                             OnClick="@(() => ActivateOrganization(context.Item))">
                                    Activate
                                </MudMenuItem>
                            }
                        </MudMenu>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="Organization" PageSizeOptions="new[] { 10, 20, 50 }" />
            </PagerContent>
        </MudDataGrid>
    </MudPaper>
</MudContainer>

@code {
    private List<Organization> m_organizations = [];
    private bool m_loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationsAsync();
    }

    private async Task LoadOrganizationsAsync()
    {
        m_loading = true;
        try
        {
            var orgs = await SubscriptionService.GetAllOrganizationsAsync();
            m_organizations = orgs.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading organizations: {ex.Message}", Severity.Error);
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters<CreateOrganizationDialog>();

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<CreateOrganizationDialog>("New Organization", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadOrganizationsAsync();
            Snackbar.Add("Organization created successfully!", Severity.Success);
        }
    }

    private async Task OpenEditDialog(Organization organization)
    {
        var parameters = new DialogParameters<EditOrganizationDialog>
        {
            { x => x.Organization, organization }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<EditOrganizationDialog>("Edit Organization", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadOrganizationsAsync();
            Snackbar.Add("Organization updated successfully!", Severity.Success);
        }
    }

    private async Task ViewUsers(Organization organization)
    {
        var parameters = new DialogParameters<OrganizationUsersDialog>
        {
            { x => x.Organization, organization }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<OrganizationUsersDialog>($"Users - {organization.Name}", parameters, options);
    }

    private async Task DeactivateOrganization(Organization organization)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Deactivate Organization",
            $"Are you sure you want to deactivate {organization.Name}? Users will not be able to log in.",
            yesText: "Deactivate",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            organization.IsActive = false;
            // Save through directory service would be needed here
            await LoadOrganizationsAsync();
            Snackbar.Add($"{organization.Name} has been deactivated.", Severity.Warning);
        }
    }

    private async Task ActivateOrganization(Organization organization)
    {
        organization.IsActive = true;
        // Save through directory service would be needed here
        await LoadOrganizationsAsync();
        Snackbar.Add($"{organization.Name} has been activated.", Severity.Success);
    }
}
