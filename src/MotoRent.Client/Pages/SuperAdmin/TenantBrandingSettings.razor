@page "/super-admin/organizations/{AccountNo}/branding"
@rendermode InteractiveServer
@using MotoRent.Domain.Core
@using MotoRent.Domain.Tourist
@using MotoRent.Services.Tourist
@using MotoRent.Client.Controls
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = UserAccount.SUPER_ADMIN)]
@inherits MotoRentComponentBase
@inject OrganizationService OrganizationService

<PageTitle>Tenant Branding - @AccountNo - MotoRent</PageTitle>

<div class="container-xl mt-4">
    <!-- Page Header -->
    <div class="page-header d-print-none mb-4">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="/super-admin/organizations/@AccountNo/edit" class="btn btn-ghost-secondary btn-icon">
                    <i class="ti ti-arrow-left"></i>
                </a>
            </div>
            <div class="col">
                <h2 class="page-title">
                    <i class="ti ti-brush me-2"></i>Tenant Branding
                </h2>
                <p class="text-secondary mb-0">@m_organization?.Name (@AccountNo)</p>
            </div>
            <div class="col-auto">
                <a href="/tourist/@AccountNo/browse" target="_blank" class="btn btn-outline-primary">
                    <i class="ti ti-external-link me-1"></i>
                    Preview Portal
                </a>
            </div>
        </div>
    </div>

    @if (m_loading)
    {
        <div class="card">
            <div class="card-body">
                <div class="progress progress-sm">
                    <div class="progress-bar progress-bar-indeterminate"></div>
                </div>
                <p class="text-center text-secondary mt-3">Loading organization...</p>
            </div>
        </div>
    }
    else if (m_organization == null)
    {
        <div class="card">
            <div class="card-body">
                <div class="empty">
                    <div class="empty-icon">
                        <i class="ti ti-alert-circle"></i>
                    </div>
                    <p class="empty-title">Organization not found</p>
                    <div class="empty-action">
                        <a href="/super-admin/organizations" class="btn btn-primary">
                            <i class="ti ti-arrow-left me-1"></i>Back to Organizations
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Left Column: Settings -->
            <div class="col-lg-8">
                <!-- Domain Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-world-www me-2"></i>
                            Domain Configuration
                        </h3>
                        <span class="badge bg-purple ms-2">SuperAdmin Only</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="ti ti-info-circle me-2"></i>
                            Tourists can access this tenant's portal via:
                            <ul class="mb-0 mt-2">
                                <li><code>motorent.co.th/tourist/@AccountNo/browse</code></li>
                                @if (!string.IsNullOrWhiteSpace(m_customDomain))
                                {
                                    <li><code>@m_customDomain/browse</code> (custom domain)</li>
                                }
                            </ul>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Custom Domain</label>
                                <input type="text" class="form-control" @bind="m_customDomain"
                                       placeholder="rent.adam.co.th" />
                                <small class="text-secondary">
                                    Set a custom domain for this tenant's tourist portal.
                                    DNS must point to our server.
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Subdomain</label>
                                <div class="input-group">
                                    <input type="text" class="form-control bg-light" value="@AccountNo.ToLowerInvariant()" disabled />
                                    <span class="input-group-text">.motorent.co.th</span>
                                </div>
                                <small class="text-secondary">
                                    Subdomain is auto-assigned based on AccountNo
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Colors -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-palette me-2"></i>
                            Brand Colors
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Primary</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <input type="color" class="form-control form-control-color border-0 p-0"
                                               style="width: 30px; height: 30px;"
                                               @bind="m_branding.PrimaryColor" />
                                    </span>
                                    <input type="text" class="form-control" @bind="m_branding.PrimaryColor" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Secondary</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <input type="color" class="form-control form-control-color border-0 p-0"
                                               style="width: 30px; height: 30px;"
                                               @bind="m_branding.SecondaryColor" />
                                    </span>
                                    <input type="text" class="form-control" @bind="m_branding.SecondaryColor" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Accent</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <input type="color" class="form-control form-control-color border-0 p-0"
                                               style="width: 30px; height: 30px;"
                                               @bind="m_branding.AccentColor" />
                                    </span>
                                    <input type="text" class="form-control" @bind="m_branding.AccentColor" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Text on Primary</label>
                                <div class="input-group">
                                    <span class="input-group-text p-1">
                                        <input type="color" class="form-control form-control-color border-0 p-0"
                                               style="width: 30px; height: 30px;"
                                               @bind="m_branding.TextOnPrimary" />
                                    </span>
                                    <input type="text" class="form-control" @bind="m_branding.TextOnPrimary" />
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-ghost-secondary btn-sm" @onclick="ResetColors">
                                <i class="ti ti-refresh me-1"></i>Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Layout & Content -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-layout me-2"></i>
                            Layout & Content
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Layout Template</label>
                                <select class="form-select" @bind="m_branding.LayoutTemplate">
                                    <option value="Modern">Modern</option>
                                    <option value="Classic">Classic</option>
                                    <option value="Minimal">Minimal</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Tagline</label>
                                <input type="text" class="form-control" @bind="m_branding.Tagline"
                                       placeholder="Your catchy tagline here" maxlength="100" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hero Image URL</label>
                                <input type="url" class="form-control" @bind="m_branding.HeroImageUrl"
                                       placeholder="https://example.com/hero.jpg" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label pt-4">
                                    <div class="form-check form-switch">
                                        <input type="checkbox" class="form-check-input"
                                               @bind="m_branding.ShowContactInfo" id="showContact" />
                                        <label class="form-check-label" for="showContact">
                                            Show contact info in footer
                                        </label>
                                    </div>
                                </label>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Footer Text</label>
                                <textarea class="form-control" @bind="m_branding.FooterText" rows="2"
                                          placeholder="Additional footer information"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom CSS (SuperAdmin Only) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-code me-2"></i>
                            Custom CSS
                        </h3>
                        <span class="badge bg-purple ms-2">SuperAdmin Only</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-3">
                            <i class="ti ti-alert-triangle me-2"></i>
                            <strong>Caution:</strong> Custom CSS can break the layout.
                            Do not use <code>url()</code>, <code>expression()</code>, or <code>javascript:</code>.
                        </div>
                        <label class="form-label">CSS Overrides</label>
                        <textarea class="form-control font-monospace @(m_cssIssues.Count > 0 ? "is-invalid" : "")"
                                  @bind="m_branding.CustomCss" @bind:after="ValidateCss" rows="10"
                                  placeholder="/* Add custom CSS here */
.tourist-hero {
    background-image: url('...') !important;
}
.card {
    border-radius: 12px;
}"></textarea>
                        @if (m_cssIssues.Count > 0)
                        {
                            <div class="invalid-feedback d-block">
                                <ul class="mb-0 ps-3">
                                    @foreach (var issue in m_cssIssues)
                                    {
                                        <li>@issue</li>
                                    }
                                </ul>
                            </div>
                        }
                        <small class="text-secondary">
                            Available CSS variables: <code>--tenant-primary</code>, <code>--tenant-secondary</code>,
                            <code>--tenant-accent</code>, <code>--tenant-text-on-primary</code>
                        </small>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card mb-4">
                    <div class="card-footer d-flex justify-content-between">
                        <a href="/super-admin/organizations/@AccountNo/edit" class="btn btn-ghost-secondary">
                            <i class="ti ti-arrow-left me-1"></i>Back to Organization
                        </a>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" @onclick="SaveDomainAsync"
                                    disabled="@m_savingDomain">
                                @if (m_savingDomain)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="ti ti-world me-1"></i>Save Domain
                            </button>
                            <button type="button" class="btn btn-primary" @onclick="SaveBrandingAsync"
                                    disabled="@m_savingBranding">
                                @if (m_savingBranding)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="ti ti-device-floppy me-1"></i>Save Branding
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Preview -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 80px;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-eye me-2"></i>
                            Live Preview
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="preview-container" style="transform: scale(0.5); transform-origin: top left; height: 350px; overflow: hidden;">
                            <div style="width: 200%; background: #f8f9fa; min-height: 700px;">
                                @* Header *@
                                <div style="background: @m_branding.PrimaryColor; color: @m_branding.TextOnPrimary; padding: 1rem;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong>@m_organization?.Name</strong>
                                        <div class="d-flex gap-3">
                                            <span style="font-size: 0.9rem;">Browse</span>
                                            <span style="font-size: 0.9rem;">My Rentals</span>
                                        </div>
                                    </div>
                                </div>

                                @* Hero *@
                                <div style="background: linear-gradient(135deg, @m_branding.PrimaryColor 0%, @m_branding.SecondaryColor 100%);
                                            color: @m_branding.TextOnPrimary; padding: 2.5rem; text-align: center;">
                                    <h3 class="mb-2">Rent a Motorbike</h3>
                                    <p style="opacity: 0.9;">@(m_branding.Tagline ?? "Explore Thailand on two wheels")</p>
                                </div>

                                @* Content *@
                                <div style="padding: 1.5rem;">
                                    <div class="d-flex gap-2 mb-3">
                                        <span class="badge" style="background: @m_branding.PrimaryColor; color: @m_branding.TextOnPrimary;">
                                            All Bikes
                                        </span>
                                        <span class="badge" style="border: 1px solid @m_branding.PrimaryColor; color: @m_branding.PrimaryColor; background: transparent;">
                                            Scooter
                                        </span>
                                        <span class="badge" style="border: 1px solid @m_branding.PrimaryColor; color: @m_branding.PrimaryColor; background: transparent;">
                                            Sport
                                        </span>
                                    </div>

                                    <div class="row g-2">
                                        @for (int i = 0; i < 2; i++)
                                        {
                                            <div class="col-6">
                                                <div class="card">
                                                    <div style="height: 80px; background: #dee2e6;"></div>
                                                    <div class="card-body p-2">
                                                        <small class="fw-bold d-block">Honda Click 125</small>
                                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                                            <small style="color: @m_branding.PrimaryColor;">350 THB</small>
                                                            <button type="button" class="btn btn-sm py-0 px-2"
                                                                    style="background: @m_branding.PrimaryColor; color: @m_branding.TextOnPrimary; font-size: 0.7rem;">
                                                                Book
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                @* Footer *@
                                <div style="background: #1d273b; color: white; padding: 1rem; margin-top: 2rem;">
                                    <small>&copy; @DateTime.Now.Year @m_organization?.Name</small>
                                    @if (!string.IsNullOrEmpty(m_branding.FooterText))
                                    {
                                        <small class="d-block mt-1 opacity-75">@m_branding.FooterText</small>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-center">
                        <a href="/tourist/@AccountNo/browse" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="ti ti-external-link me-1"></i>
                            Open Full Preview
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public new string AccountNo { get; set; } = "";

    private Organization? m_organization;
    private TenantBranding m_branding = new();
    private string? m_customDomain;
    private bool m_loading = true;
    private bool m_savingBranding;
    private bool m_savingDomain;
    private List<string> m_cssIssues = [];

    private void ValidateCss()
    {
        m_cssIssues = CssSanitizer.GetSecurityIssues(m_branding.CustomCss);
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadOrganizationAsync();
    }

    private async Task LoadOrganizationAsync()
    {
        m_loading = true;
        try
        {
            m_organization = await OrganizationService.GetOrganizationByAccountNoAsync(AccountNo);
            if (m_organization != null)
            {
                m_customDomain = m_organization.CustomDomain;

                // Clone branding
                m_branding = new TenantBranding
                {
                    PrimaryColor = m_organization.Branding.PrimaryColor,
                    SecondaryColor = m_organization.Branding.SecondaryColor,
                    AccentColor = m_organization.Branding.AccentColor,
                    TextOnPrimary = m_organization.Branding.TextOnPrimary,
                    LayoutTemplate = m_organization.Branding.LayoutTemplate,
                    CustomCss = m_organization.Branding.CustomCss,
                    HeroImageUrl = m_organization.Branding.HeroImageUrl,
                    FooterText = m_organization.Branding.FooterText,
                    ShowContactInfo = m_organization.Branding.ShowContactInfo,
                    Tagline = m_organization.Branding.Tagline,
                    SocialLinks = m_organization.Branding.SocialLinks
                };
            }
        }
        catch (Exception ex)
        {
            ShowError($"Error loading organization: {ex.Message}");
        }
        finally
        {
            m_loading = false;
        }
    }

    private void ResetColors()
    {
        m_branding.PrimaryColor = "#00897B";
        m_branding.SecondaryColor = "#004D40";
        m_branding.AccentColor = "#26A69A";
        m_branding.TextOnPrimary = "#FFFFFF";
    }

    private async Task SaveBrandingAsync()
    {
        m_savingBranding = true;
        try
        {
            // Sanitize custom CSS before saving
            if (!string.IsNullOrEmpty(m_branding.CustomCss))
            {
                m_branding.CustomCss = CssSanitizer.Sanitize(m_branding.CustomCss);
                ValidateCss(); // Re-validate after sanitization
            }

            var result = await OrganizationService.UpdateBrandingAsync(AccountNo, m_branding, UserName);
            if (result.Success)
            {
                ShowSuccess("Branding settings saved successfully. Custom CSS has been sanitized for security.");
            }
            else
            {
                ShowError(result.Message ?? "Failed to save branding");
            }
        }
        catch (Exception ex)
        {
            ShowError($"Error saving branding: {ex.Message}");
        }
        finally
        {
            m_savingBranding = false;
        }
    }

    private async Task SaveDomainAsync()
    {
        m_savingDomain = true;
        try
        {
            var result = await OrganizationService.UpdateCustomDomainAsync(AccountNo, m_customDomain, UserName);
            if (result.Success)
            {
                ShowSuccess("Custom domain saved successfully");
            }
            else
            {
                ShowError(result.Message ?? "Failed to save domain");
            }
        }
        catch (Exception ex)
        {
            ShowError($"Error saving domain: {ex.Message}");
        }
        finally
        {
            m_savingDomain = false;
        }
    }
}
