@using MotoRent.Domain.Core
@using MotoRent.Client.Controls
@inherits MotoRentComponentBase
@inject ISubscriptionService SubscriptionService

<form id="create-org-form" @onsubmit="CreateOrganization" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="row g-3">
            <!-- Organization Logo -->
            <div class="col-12">
                <div class="row align-items-center">
                    <div class="col-auto" style="width: 180px;">
                        <ImageUpload StoreId="@m_organization.LogoStoreId"
                                     StoreIdChanged="@(id => m_organization.LogoStoreId = id)"
                                     Title="Organization Logo"
                                     HelpHint="Upload logo (200x200px)"
                                     NoImage=""
                                     HideImage="@string.IsNullOrEmpty(m_organization.LogoStoreId)" />
                    </div>
                    <div class="col">
                        <div class="mb-3">
                            <label class="form-label required">Organization Name</label>
                            <input type="text" class="form-control" @bind="m_organization.Name" required />
                        </div>
                        <div>
                            <label class="form-label">Account No (Schema)</label>
                            <input type="text" class="form-control" @bind="m_accountNo"
                                   placeholder="Auto-generated if empty" />
                            <small class="form-hint">Unique identifier for database schema</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <hr class="my-2" />
                <h4 class="subheader mt-2 mb-2">
                    <i class="ti ti-user-shield me-2"></i>Administrator Account
                </h4>
                <small class="form-hint d-block mb-3">
                    This person will be the organization administrator with full access.
                </small>
            </div>

            <div class="col-md-6">
                <label class="form-label required">Admin Full Name</label>
                <input type="text" class="form-control" @bind="m_adminName" required
                       placeholder="e.g., John Smith" />
            </div>
            <div class="col-md-6">
                <label class="form-label required">Admin Email</label>
                <input type="email" class="form-control" @bind="m_adminEmail" required
                       placeholder="e.g., john@example.com" />
                <small class="form-hint">This will be used as the login username</small>
            </div>
            <div class="col-md-6">
                <label class="form-label required">Authentication Provider</label>
                <select class="form-select" @bind="m_adminProvider">
                    <option value="@User.GOOGLE">Google</option>
                    <option value="@User.MICROSOFT">Microsoft</option>
                </select>
                <small class="form-hint">How the admin will sign in</small>
            </div>

            <div class="col-12">
                <hr class="my-2" />
                <h4 class="subheader mt-2 mb-2">
                    <i class="ti ti-mail me-2"></i>Organization Contact
                </h4>
            </div>

            <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" @bind="m_organization.Email"
                       placeholder="contact@company.com" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" @bind="m_organization.Phone"
                       placeholder="+66 XX XXX XXXX" />
            </div>

            <div class="col-12">
                <hr class="my-2" />
                <h4 class="subheader mt-2 mb-2">
                    <i class="ti ti-map-pin me-2"></i>Address
                </h4>
            </div>

            <div class="col-12">
                <label class="form-label">Street</label>
                <input type="text" class="form-control" @bind="m_organization.Address.Street" />
            </div>
            <div class="col-md-6">
                <label class="form-label">City</label>
                <input type="text" class="form-control" @bind="m_organization.Address.City" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Province/State</label>
                <input type="text" class="form-control" @bind="m_organization.Address.Province" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Postal Code</label>
                <input type="text" class="form-control" @bind="m_organization.Address.PostalCode" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Country</label>
                <input type="text" class="form-control" @bind="m_organization.Address.Country" />
            </div>

            <div class="col-12">
                <hr class="my-2" />
                <h4 class="subheader mt-2 mb-2">
                    <i class="ti ti-world me-2"></i>Regional Settings
                </h4>
            </div>

            <div class="col-md-4">
                <label class="form-label">Currency</label>
                <select class="form-select" @bind="m_organization.Currency">
                    <option value="THB">THB - Thai Baht</option>
                    <option value="USD">USD - US Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="MYR">MYR - Malaysian Ringgit</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Language</label>
                <select class="form-select" @bind="m_organization.Language">
                    <option value="th-TH">Thai</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Timezone (UTC offset)</label>
                <input type="number" class="form-control" @bind="m_timezone" min="-12" max="14" />
            </div>
        </div>

        @if (m_isCreating)
        {
            <div class="card bg-light mt-4">
                <div class="card-body">
                    <h4 class="subheader">Provisioning Progress</h4>
                    <div class="progress progress-sm my-2">
                        <div class="progress-bar progress-bar-indeterminate"></div>
                    </div>
                    <span class="small text-secondary">@m_progressMessage</span>
                </div>
            </div>
        }
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel" disabled="@m_isCreating">
        Cancel
    </button>
    <button type="button" class="btn btn-primary" @onclick="CreateOrganization" disabled="@m_isCreating">
        @if (m_isCreating)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>Creating...</span>
        }
        else
        {
            <i class="ti ti-plus me-1"></i>
            <span>Create Organization</span>
        }
    </button>
</div>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }

    private Organization m_organization = new()
    {
        Currency = "THB",
        Language = "th-TH",
        IsActive = true,
        Address = new Address { Country = "Thailand" }
    };
    private string m_accountNo = "";
    private double m_timezone = 7;
    private bool m_isCreating;
    private string m_progressMessage = "";

    // Admin fields
    private string m_adminName = "";
    private string m_adminEmail = "";
    private string m_adminProvider = User.GOOGLE;

    private void Cancel() => this.ModalInstance?.Cancel();

    private async Task CreateOrganization()
    {
        if (string.IsNullOrWhiteSpace(this.m_organization.Name))
        {
            this.ShowError("Organization name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(this.m_adminName))
        {
            this.ShowError("Administrator name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(this.m_adminEmail))
        {
            this.ShowError("Administrator email is required");
            return;
        }

        this.m_isCreating = true;
        this.m_progressMessage = "Initializing...";

        try
        {
            // Generate or validate AccountNo
            if (string.IsNullOrWhiteSpace(this.m_accountNo))
            {
                this.m_accountNo = await this.SubscriptionService.CreateAccountNoAsync(
                    this.m_organization.Name.Replace(" ", ""));
            }
            else
            {
                this.m_accountNo = await this.SubscriptionService.CreateAccountNoAsync(this.m_accountNo);
            }

            // Check if AccountNo is available
            if (!await this.SubscriptionService.IsAccountNoAvailableAsync(this.m_accountNo))
            {
                this.ShowError($"Account No '{this.m_accountNo}' is already in use.");
                this.m_isCreating = false;
                return;
            }

            this.m_organization.AccountNo = this.m_accountNo;
            this.m_organization.Timezone = this.m_timezone;

            // Create admin info
            var adminInfo = new OrganizationAdminInfo
            {
                FullName = this.m_adminName,
                Email = this.m_adminEmail,
                Provider = this.m_adminProvider
            };

            // Create the organization with schema and admin
            await this.SubscriptionService.CreateOrganizationWithAdminAsync(this.m_organization, adminInfo, progress =>
            {
                this.m_progressMessage = progress.Message;
                this.InvokeAsync(this.StateHasChanged);
            });

            this.ModalInstance?.Close(this.m_organization);
        }
        catch (Exception ex)
        {
            this.ShowError($"Error creating organization: {ex.Message}");
            this.m_isCreating = false;
        }
    }
}
