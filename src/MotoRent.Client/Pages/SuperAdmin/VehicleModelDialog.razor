@using MotoRent.Domain.Core
@using MotoRent.Domain.Entities
@inherits LocalizedComponentBase<VehicleModelDialog>
@inject VehicleLookupService LookupService

<form id="vehicle-model-form" @onsubmit="SaveModel" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="row g-3">
            <!-- Basic Info -->
            <div class="col-md-6">
                <label class="form-label required">@Localizer["MakeBrand"]</label>
                <input type="text" class="form-control" @bind="m_model.Make" required
                       list="makes-list" placeholder="@Localizer["MakePlaceholder"]" />
                <datalist id="makes-list">
                    @foreach (var make in m_existingMakes)
                    {
                        <option value="@make" />
                    }
                </datalist>
            </div>
            <div class="col-md-6">
                <label class="form-label required">@Localizer["ModelName"]</label>
                <input type="text" class="form-control" @bind="m_model.Model" required
                       placeholder="@Localizer["ModelPlaceholder"]" />
            </div>

            <div class="col-md-6">
                <label class="form-label required">@Localizer["VehicleType"]</label>
                <select class="form-select" @bind="m_model.VehicleType" required>
                    @foreach (var type in Enum.GetValues<VehicleType>())
                    {
                        <option value="@type">@type</option>
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["CountryOfOrigin"]</label>
                <select class="form-select" @bind="m_model.CountryOfOrigin">
                    <option value="">@Localizer["NotSpecified"]</option>
                    <option value="Japan">@Localizer["CountryJapan"]</option>
                    <option value="Thailand">@Localizer["CountryThailand"]</option>
                    <option value="Germany">@Localizer["CountryGermany"]</option>
                    <option value="South Korea">@Localizer["CountrySouthKorea"]</option>
                    <option value="Italy">@Localizer["CountryItaly"]</option>
                    <option value="USA">@Localizer["CountryUSA"]</option>
                    <option value="China">@Localizer["CountryChina"]</option>
                </select>
            </div>

            <!-- Type-Specific Fields -->
            @if (m_model.VehicleType == VehicleType.Motorbike)
            {
                <div class="col-12">
                    <h4 class="subheader mt-2 mb-2">@Localizer["MotorbikeSpecs"]</h4>
                </div>
                <div class="col-md-6">
                    <label class="form-label">@Localizer["EngineCC"]</label>
                    <input type="number" class="form-control" @bind="m_model.EngineCC"
                           min="50" max="2000" placeholder="@Localizer["EngineCCPlaceholder"]" />
                </div>
            }
            else if (m_model.VehicleType == VehicleType.Car)
            {
                <div class="col-12">
                    <h4 class="subheader mt-2 mb-2">@Localizer["CarSpecs"]</h4>
                </div>
                <div class="col-md-4">
                    <label class="form-label">@Localizer["Segment"]</label>
                    <select class="form-select" @bind="m_model.Segment">
                        <option value="">@Localizer["NotSpecified"]</option>
                        @foreach (var segment in Enum.GetValues<CarSegment>())
                        {
                            <option value="@segment">@segment</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">@Localizer["EngineLiters"]</label>
                    <input type="number" class="form-control" @bind="m_model.EngineLiters"
                           min="0.5" max="8" step="0.1" placeholder="@Localizer["EngineLitersPlaceholder"]" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">@Localizer["SeatCount"]</label>
                    <input type="number" class="form-control" @bind="m_model.SeatCount"
                           min="2" max="12" placeholder="@Localizer["SeatCountPlaceholder"]" />
                </div>
            }
            else if (m_model.VehicleType == VehicleType.Van)
            {
                <div class="col-12">
                    <h4 class="subheader mt-2 mb-2">@Localizer["VanSpecs"]</h4>
                </div>
                <div class="col-md-6">
                    <label class="form-label">@Localizer["SeatCount"]</label>
                    <input type="number" class="form-control" @bind="m_model.SeatCount"
                           min="4" max="50" placeholder="@Localizer["VanSeatCountPlaceholder"]" />
                </div>
            }

            <!-- Year Range -->
            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">@Localizer["ProductionYears"]</h4>
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["YearFrom"]</label>
                <input type="number" class="form-control" @bind="m_model.YearFrom"
                       min="1990" max="@DateTime.Now.Year" placeholder="@Localizer["YearFromPlaceholder"]" />
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["YearTo"]</label>
                <input type="number" class="form-control" @bind="m_model.YearTo"
                       min="1990" max="@(DateTime.Now.Year + 1)" placeholder="@Localizer["YearToPlaceholder"]" />
            </div>

            <!-- Suggested Pricing -->
            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">@Localizer["SuggestedPricing"]</h4>
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["SuggestedDailyRate"]</label>
                <div class="input-group">
                    <span class="input-group-text">@Localizer["CurrencySymbol"]</span>
                    <input type="number" class="form-control" @bind="m_model.SuggestedDailyRate"
                           min="0" step="50" placeholder="@Localizer["DailyRatePlaceholder"]" />
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["SuggestedDeposit"]</label>
                <div class="input-group">
                    <span class="input-group-text">@Localizer["CurrencySymbol"]</span>
                    <input type="number" class="form-control" @bind="m_model.SuggestedDeposit"
                           min="0" step="500" placeholder="@Localizer["DepositPlaceholder"]" />
                </div>
            </div>

            <!-- Aliases & Settings -->
            <div class="col-12">
                <h4 class="subheader mt-2 mb-2">@Localizer["RecognitionSettings"]</h4>
            </div>
            <div class="col-12">
                <label class="form-label">@Localizer["Aliases"]</label>
                <input type="text" class="form-control" @bind="m_aliasesText"
                       placeholder="@Localizer["AliasesPlaceholder"]" />
                <small class="form-hint">@Localizer["AliasesHint"]</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">@Localizer["DisplayOrder"]</label>
                <input type="number" class="form-control" @bind="m_model.DisplayOrder"
                       min="1" max="999" />
                <small class="form-hint">@Localizer["DisplayOrderHint"]</small>
            </div>
            <div class="col-md-6">
                <label class="form-label mt-4">@Localizer["Status"]</label>
                <label class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" @bind="m_model.IsActive" />
                    <span class="form-check-label">@(m_model.IsActive ? Localizer["Active"] : Localizer["Inactive"])</span>
                </label>
            </div>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel" disabled="@m_isSaving">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="vehicle-model-form" class="btn btn-primary" disabled="@m_isSaving">
        @if (m_isSaving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>@Localizer["Saving"]</span>
        }
        else
        {
            <i class="ti ti-device-floppy me-1"></i>
            <span>@(IsNew ? Localizer["CreateModel"] : Localizer["SaveChanges"])</span>
        }
    </button>
</div>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }
    [Parameter] public VehicleModel Model { get; set; } = null!;
    [Parameter] public bool IsNew { get; set; }

    private VehicleModel m_model = new();
    private List<string> m_existingMakes = [];
    private string m_aliasesText = "";
    private bool m_isSaving;

    protected override async Task OnInitializedAsync()
    {
        this.m_existingMakes = await this.LookupService.GetMakesAsync();
    }

    protected override void OnParametersSet()
    {
        // Clone the model for editing
        this.m_model = new VehicleModel
        {
            VehicleModelId = this.Model.VehicleModelId,
            Make = this.Model.Make,
            Model = this.Model.Model,
            VehicleType = this.Model.VehicleType,
            Segment = this.Model.Segment,
            EngineCC = this.Model.EngineCC,
            EngineLiters = this.Model.EngineLiters,
            SeatCount = this.Model.SeatCount,
            YearFrom = this.Model.YearFrom,
            YearTo = this.Model.YearTo,
            IsActive = this.Model.IsActive,
            DisplayOrder = this.Model.DisplayOrder,
            Aliases = this.Model.Aliases ?? [],
            SuggestedDailyRate = this.Model.SuggestedDailyRate,
            SuggestedDeposit = this.Model.SuggestedDeposit,
            ImageStoreId = this.Model.ImageStoreId,
            CountryOfOrigin = this.Model.CountryOfOrigin
        };

        this.m_aliasesText = string.Join(", ", this.m_model.Aliases);
    }

    private void Cancel() => this.ModalInstance?.Cancel();

    private async Task SaveModel()
    {
        if (string.IsNullOrWhiteSpace(this.m_model.Make))
        {
            this.ShowError(Localizer["MakeRequired"]);
            return;
        }

        if (string.IsNullOrWhiteSpace(this.m_model.Model))
        {
            this.ShowError(Localizer["ModelRequired"]);
            return;
        }

        this.m_isSaving = true;

        try
        {
            // Parse aliases from text
            this.m_model.Aliases = this.m_aliasesText
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .Distinct()
                .ToArray();

            SubmitOperation result;
            if (this.IsNew)
            {
                result = await this.LookupService.CreateModelAsync(this.m_model, this.UserName);
            }
            else
            {
                result = await this.LookupService.UpdateModelAsync(this.m_model, this.UserName);
            }

            if (result.Success)
            {
                this.ModalInstance?.Close(this.m_model);
            }
            else
            {
                this.ShowError(result.Message ?? Localizer["FailedToSave"]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorSaving", ex.Message]);
        }
        finally
        {
            this.m_isSaving = false;
        }
    }
}
