@page "/super-admin/organizations/create"
@rendermode InteractiveServer
@using MotoRent.Domain.Core
@using MotoRent.Client.Controls
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = UserAccount.SUPER_ADMIN)]
@inherits MotoRentComponentBase
@inject ISubscriptionService SubscriptionService
@inject TransliterationService TransliterationService

<PageTitle>Create Organization - MotoRent</PageTitle>

<div class="container-xl mt-4">
    <!-- Page Header -->
    <div class="page-header d-print-none mb-4">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="/super-admin/organizations" class="btn btn-ghost-secondary btn-icon">
                    <i class="ti ti-arrow-left"></i>
                </a>
            </div>
            <div class="col">
                <h2 class="page-title">Create New Organization</h2>
                <p class="text-secondary mb-0">Set up a new tenant with administrator account</p>
            </div>
        </div>
    </div>

    <form id="create-org-form" @onsubmit="CreateOrganizationAsync" @onsubmit:preventDefault>
        <div class="row">
            <!-- Left Column: Basic Info & Logo -->
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-building me-2"></i>Organization
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 text-center">
                            <ImageUpload StoreId="@m_organization.LogoStoreId"
                                         StoreIdChanged="@(id => m_organization.LogoStoreId = id)"
                                         Title="Organization Logo"
                                         HelpHint="Upload logo (200x200px)"
                                         NoImage=""
                                         HideImage="@string.IsNullOrEmpty(m_organization.LogoStoreId)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label required">Organization Name</label>
                            <input type="text" class="form-control" @bind="m_organization.Name"
                                   @bind:event="oninput" @onblur="GenerateAccountNo" required
                                   placeholder="e.g., Phuket Motor Rentals" />
                        </div>

                        <div>
                            <label class="form-label required">Account No (Schema)</label>
                            <input type="text" class="form-control @(m_accountNoError != null ? "is-invalid" : "")"
                                   @bind="m_accountNo" @bind:event="oninput"
                                   @onblur="ValidateAccountNo"
                                   pattern="[A-Za-z0-9]+" required
                                   placeholder="e.g., PhuketMotors" />
                            @if (m_accountNoError != null)
                            {
                                <div class="invalid-feedback">@m_accountNoError</div>
                            }
                            else
                            {
                                <small class="form-hint">English letters and numbers only, no spaces or special characters</small>
                            }
                        </div>
                    </div>
                </div>

                <!-- Regional Settings Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-world me-2"></i>Regional Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Currency</label>
                            <select class="form-select" @bind="m_organization.Currency">
                                <option value="THB">THB - Thai Baht</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="MYR">MYR - Malaysian Ringgit</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Language</label>
                            <select class="form-select" @bind="m_organization.Language">
                                <option value="th-TH">Thai</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Timezone</label>
                            <select class="form-select" @bind="m_timezone">
                                <option value="-12">(GMT -12:00) International Date Line West</option>
                                <option value="-11">(GMT -11:00) Midway Island, Samoa</option>
                                <option value="-10">(GMT -10:00) Hawaii</option>
                                <option value="-9">(GMT -9:00) Alaska</option>
                                <option value="-8">(GMT -8:00) Pacific Time (US & Canada)</option>
                                <option value="-7">(GMT -7:00) Mountain Time (US & Canada)</option>
                                <option value="-6">(GMT -6:00) Central Time (US & Canada), Mexico City</option>
                                <option value="-5">(GMT -5:00) Eastern Time (US & Canada), Bogota</option>
                                <option value="-4">(GMT -4:00) Atlantic Time (Canada), Caracas</option>
                                <option value="-3.5">(GMT -3:30) Newfoundland</option>
                                <option value="-3">(GMT -3:00) Brasilia, Buenos Aires</option>
                                <option value="-2">(GMT -2:00) Mid-Atlantic</option>
                                <option value="-1">(GMT -1:00) Azores, Cape Verde Islands</option>
                                <option value="0">(GMT) Western Europe Time, London, Lisbon, Casablanca</option>
                                <option value="1">(GMT +1:00) Brussels, Copenhagen, Madrid, Paris</option>
                                <option value="2">(GMT +2:00) Kaliningrad, South Africa</option>
                                <option value="3">(GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg</option>
                                <option value="3.5">(GMT +3:30) Tehran</option>
                                <option value="4">(GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi</option>
                                <option value="4.5">(GMT +4:30) Kabul</option>
                                <option value="5">(GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent</option>
                                <option value="5.5">(GMT +5:30) Bombay, Calcutta, Madras, New Delhi</option>
                                <option value="5.75">(GMT +5:45) Kathmandu, Pokhara</option>
                                <option value="6">(GMT +6:00) Almaty, Dhaka, Colombo</option>
                                <option value="6.5">(GMT +6:30) Yangon, Mandalay</option>
                                <option value="7">(GMT +7:00) Bangkok, Hanoi, Jakarta</option>
                                <option value="8">(GMT +8:00) Kuala Lumpur, Perth, Singapore, Hong Kong</option>
                                <option value="8.75">(GMT +8:45) Eucla</option>
                                <option value="9">(GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk</option>
                                <option value="9.5">(GMT +9:30) Adelaide, Darwin</option>
                                <option value="10">(GMT +10:00) Eastern Australia, Guam, Vladivostok</option>
                                <option value="10.5">(GMT +10:30) Lord Howe Island</option>
                                <option value="11">(GMT +11:00) Magadan, Solomon Islands, New Caledonia</option>
                                <option value="11.5">(GMT +11:30) Norfolk Island</option>
                                <option value="12">(GMT +12:00) Auckland, Wellington, Fiji, Kamchatka</option>
                                <option value="12.75">(GMT +12:45) Chatham Islands</option>
                                <option value="13">(GMT +13:00) Apia, Nukualofa</option>
                                <option value="14">(GMT +14:00) Line Islands, Tokelau</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Admin, Contact, Address -->
            <div class="col-lg-8">
                <!-- Administrator Account Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-user-shield me-2"></i>Administrator Account
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="ti ti-info-circle me-2"></i>
                            This person will be the organization administrator with full access.
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label required">Full Name</label>
                                <input type="text" class="form-control" @bind="m_adminName" required
                                       placeholder="e.g., Somchai Jaidee" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">Email</label>
                                <input type="email" class="form-control" @bind="m_adminEmail" required
                                       placeholder="e.g., somchai@example.com" />
                                <small class="form-hint">This will be used as the login username</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">Authentication Provider</label>
                                <select class="form-select" @bind="m_adminProvider">
                                    <option value="@User.GOOGLE">Google</option>
                                    <option value="@User.MICROSOFT">Microsoft</option>
                                </select>
                                <small class="form-hint">How the admin will sign in</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organization Contact Card -->
                <div class="card mb-3">
                    <div class="card-header d-flex align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="ti ti-mail me-2"></i>Organization Contact
                        </h3>
                        <button type="button" class="btn btn-sm btn-ghost-secondary ms-auto"
                                @onclick="CopyAdminToContact"
                                disabled="@string.IsNullOrWhiteSpace(m_adminEmail)">
                            <i class="ti ti-copy me-1"></i>Copy from Admin
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" @bind="m_organization.Email"
                                       placeholder="contact@company.com" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" @bind="m_organization.Phone"
                                       placeholder="+66 XX XXX XXXX" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Address Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-map-pin me-2"></i>Address
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Street</label>
                                <input type="text" class="form-control" @bind="m_organization.Address.Street"
                                       placeholder="123 Patong Beach Road" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">City</label>
                                <input type="text" class="form-control" @bind="m_organization.Address.City"
                                       placeholder="Patong" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Province/State</label>
                                <input type="text" class="form-control" @bind="m_organization.Address.Province"
                                       placeholder="Phuket" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Postal Code</label>
                                <input type="text" class="form-control" @bind="m_organization.Address.PostalCode"
                                       placeholder="83150" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Country</label>
                                <input type="text" class="form-control" @bind="m_organization.Address.Country" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        @if (m_isCreating)
        {
            <div class="card bg-azure-lt mb-3">
                <div class="card-body">
                    <h4 class="card-title">Provisioning Progress</h4>
                    <div class="progress progress-sm my-2">
                        <div class="progress-bar progress-bar-indeterminate bg-azure"></div>
                    </div>
                    <span class="text-secondary">@m_progressMessage</span>
                </div>
            </div>
        }

        <!-- Action Buttons -->
        <div class="card">
            <div class="card-footer d-flex justify-content-between">
                <a href="/super-admin/organizations" class="btn btn-ghost-secondary">
                    <i class="ti ti-arrow-left me-1"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary" disabled="@m_isCreating">
                    @if (m_isCreating)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span>Creating...</span>
                    }
                    else
                    {
                        <i class="ti ti-plus me-1"></i>
                        <span>Create Organization</span>
                    }
                </button>
            </div>
        </div>
    </form>
</div>

@code {
    private Organization m_organization = new()
    {
        Currency = "THB",
        Language = "th-TH",
        IsActive = true,
        Address = new Address { Country = "Thailand" }
    };
    private string m_accountNo = "";
    private string? m_accountNoError;
    private double m_timezone = 7;
    private bool m_isCreating;
    private string m_progressMessage = "";

    // Admin fields
    private string m_adminName = "";
    private string m_adminEmail = "";
    private string m_adminProvider = User.GOOGLE;

    // Regex for valid AccountNo: English letters and numbers only
    private static readonly System.Text.RegularExpressions.Regex s_accountNoRegex =
        new(@"^[A-Za-z0-9]+$", System.Text.RegularExpressions.RegexOptions.Compiled);

    private async Task GenerateAccountNo()
    {
        if (!string.IsNullOrWhiteSpace(this.m_organization.Name))
        {
            // Transliterate non-English text to English first
            var transliterated = await this.TransliterationService.TransliterateToEnglishAsync(this.m_organization.Name);
            var generated = await this.SubscriptionService.CreateAccountNoAsync(transliterated);
            // Sanitize: keep only English letters and numbers
            this.m_accountNo = System.Text.RegularExpressions.Regex.Replace(generated, @"[^A-Za-z0-9]", "");
            this.ValidateAccountNo();
        }
    }

    private void ValidateAccountNo()
    {
        if (string.IsNullOrWhiteSpace(this.m_accountNo))
        {
            this.m_accountNoError = "Account No is required";
            return;
        }

        if (this.m_accountNo.Contains(' '))
        {
            this.m_accountNoError = "Spaces are not allowed";
            return;
        }

        if (!s_accountNoRegex.IsMatch(this.m_accountNo))
        {
            this.m_accountNoError = "Only English letters (A-Z, a-z) and numbers (0-9) are allowed";
            return;
        }

        this.m_accountNoError = null;
    }

    private void CopyAdminToContact()
    {
        if (!string.IsNullOrWhiteSpace(this.m_adminEmail))
        {
            this.m_organization.Email = this.m_adminEmail;
        }
    }

    private async Task CreateOrganizationAsync()
    {
        if (string.IsNullOrWhiteSpace(this.m_organization.Name))
        {
            this.ShowError("Organization name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(this.m_adminName))
        {
            this.ShowError("Administrator name is required");
            return;
        }

        if (string.IsNullOrWhiteSpace(this.m_adminEmail))
        {
            this.ShowError("Administrator email is required");
            return;
        }

        // Validate AccountNo
        this.ValidateAccountNo();
        if (this.m_accountNoError != null)
        {
            this.ShowError(this.m_accountNoError);
            return;
        }

        this.m_isCreating = true;
        this.m_progressMessage = "Initializing...";

        try
        {

            // Check if AccountNo is available
            if (!await this.SubscriptionService.IsAccountNoAvailableAsync(this.m_accountNo))
            {
                this.ShowError($"Account No '{this.m_accountNo}' is already in use.");
                this.m_isCreating = false;
                return;
            }

            this.m_organization.AccountNo = this.m_accountNo;
            this.m_organization.Timezone = this.m_timezone;

            // Create admin info
            var adminInfo = new OrganizationAdminInfo
            {
                FullName = this.m_adminName,
                Email = this.m_adminEmail,
                Provider = this.m_adminProvider
            };

            // Create the organization with schema and admin
            await this.SubscriptionService.CreateOrganizationWithAdminAsync(this.m_organization, adminInfo, progress =>
            {
                this.m_progressMessage = progress.Message;
                this.InvokeAsync(this.StateHasChanged);
            });

            this.ShowSuccess($"Organization '{this.m_organization.Name}' created successfully!");
            this.NavigationManager.NavigateTo("/super-admin/organizations");
        }
        catch (Exception ex)
        {
            this.ShowError($"Error creating organization: {ex.Message}");
            this.m_isCreating = false;
        }
    }
}
