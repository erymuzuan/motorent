@page "/super-admin/support-requests/{Id:int}"
@rendermode InteractiveServer
@inherits MotoRentComponentBase
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Core
@using MotoRent.Domain.Helps
@using TaskStatus = MotoRent.Domain.Helps.TaskStatus
@using MotoRent.Domain.DataContext
@attribute [Authorize(Roles = UserAccount.SUPER_ADMIN)]
@inject CoreDataContext CoreDataContext

<PageTitle>@(m_request?.No ?? "Support Request") - MotoRent</PageTitle>

<div class="container-xl mt-4">
    @if (m_loading)
    {
        <div class="progress progress-sm mb-4">
            <div class="progress-bar progress-bar-indeterminate"></div>
        </div>
    }
    else if (m_request == null)
    {
        <div class="alert alert-danger">
            <i class="ti ti-alert-circle me-2"></i>
            Support request not found.
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <div class="mb-1">
                    <a href="/super-admin/support-requests" class="text-secondary">
                        <i class="ti ti-arrow-left me-1"></i>Back to Support Requests
                    </a>
                </div>
                <h4 class="mb-1">@m_request.No - @m_request.Title</h4>
                <p class="text-secondary mb-0">
                    Created by @m_request.RequestedBy on @m_request.Timestamp.ToString("g")
                </p>
            </div>
            <div class="d-flex gap-2">
                @if (!string.IsNullOrEmpty(m_request.ObjectUri))
                {
                    <a href="@m_request.ObjectUri" target="_blank" class="btn btn-outline-primary">
                        <i class="ti ti-external-link me-2"></i>
                        View Source
                    </a>
                }
                <button type="button" class="btn btn-primary" @onclick="SaveAsync" disabled="@m_saving">
                    @if (m_saving)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    <i class="ti ti-device-floppy me-2"></i>
                    Save Changes
                </button>
            </div>
        </div>

        <div class="row">
            @* Main content *@
            <div class="col-lg-8">
                @* Status and Assignment Card *@
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Status & Assignment</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Status</label>
                                <select class="form-select" @bind="m_request.Status">
                                    @foreach (var status in Enum.GetValues<TaskStatus>())
                                    {
                                        <option value="@status">@status</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Priority</label>
                                <select class="form-select" @bind="m_request.Priority">
                                    @foreach (var priority in Enum.GetValues<TaskPriority>())
                                    {
                                        <option value="@priority">@priority</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Assigned To</label>
                                <input type="text" class="form-control" @bind="m_request.AssignedTo"
                                       placeholder="Enter assignee..." />
                            </div>
                        </div>
                    </div>
                </div>

                @* Details Card *@
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Details</h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Area</label>
                                <input type="text" class="form-control" @bind="m_request.Area"
                                       placeholder="e.g., Billing, Rental, Settings..." />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Difficulty</label>
                                <select class="form-select" @bind="m_request.Difficulty">
                                    <option value="">Select difficulty...</option>
                                    @foreach (var diff in Enum.GetValues<Difficulty>())
                                    {
                                        <option value="@diff">@diff</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estimated Effort (hours)</label>
                                <input type="number" class="form-control" @bind="m_request.EstimatedEffortHour"
                                       step="0.5" min="0" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reason</label>
                                <input type="text" class="form-control" @bind="m_request.Reason"
                                       placeholder="Root cause or reason..." />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Reproduction Steps</label>
                                <textarea class="form-control" rows="3" @bind="m_request.ReproSteps"
                                          placeholder="Steps to reproduce the issue..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                @* System Info Card *@
                @if (!string.IsNullOrEmpty(m_request.SystemInfo))
                {
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title">Original Message</h3>
                        </div>
                        <div class="card-body">
                            <div class="markdown">
                                @((MarkupString)m_request.SystemInfo)
                            </div>
                        </div>
                    </div>
                }

                @* Discussion Card *@
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Discussion (@m_request.Discussions.Count)</h3>
                    </div>
                    <div class="card-body">
                        @if (m_request.Discussions.Count == 0)
                        {
                            <p class="text-muted mb-3">No discussion yet.</p>
                        }
                        else
                        {
                            <div class="divide-y mb-3">
                                @foreach (var discussion in m_request.Discussions.OrderByDescending(x => x.Timestamp))
                                {
                                    <div class="py-3">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <span class="avatar avatar-sm bg-primary-subtle">
                                                @GetInitials(discussion.User)
                                            </span>
                                            <strong>@discussion.User</strong>
                                            <small class="text-muted">@GetTimeAgo(discussion.Timestamp)</small>
                                        </div>
                                        <div class="ms-5">
                                            @((MarkupString)(discussion.Text ?? ""))
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        @* Add Discussion *@
                        <div class="border-top pt-3">
                            <label class="form-label">Add Response</label>
                            <textarea class="form-control mb-2" rows="3" @bind="m_newDiscussion"
                                      placeholder="Type your response..."></textarea>
                            <button type="button" class="btn btn-primary" @onclick="AddDiscussion"
                                    disabled="@(string.IsNullOrWhiteSpace(m_newDiscussion))">
                                <i class="ti ti-send me-2"></i>
                                Add Response
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @* Sidebar *@
            <div class="col-lg-4">
                @* Info Card *@
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Information</h3>
                    </div>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-5 text-secondary">Ticket No</div>
                                <div class="col-7"><strong>@m_request.No</strong></div>
                            </div>
                        </div>
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-5 text-secondary">Account</div>
                                <div class="col-7">@m_request.AccountNo</div>
                            </div>
                        </div>
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-5 text-secondary">Entity Type</div>
                                <div class="col-7">@m_request.Type</div>
                            </div>
                        </div>
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-5 text-secondary">Entity ID</div>
                                <div class="col-7">@m_request.EntityId</div>
                            </div>
                        </div>
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-5 text-secondary">Comment ID</div>
                                <div class="col-7">@m_request.CommentId</div>
                            </div>
                        </div>
                    </div>
                </div>

                @* Metrics Card *@
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">Metrics</h3>
                    </div>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-6 text-secondary">Created</div>
                                <div class="col-6">@m_request.Timestamp.ToString("g")</div>
                            </div>
                        </div>
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-6 text-secondary">First Response</div>
                                <div class="col-6">
                                    @if (m_request.TotalMinutesResponded.HasValue)
                                    {
                                        <span class="text-success">@FormatMinutes(m_request.TotalMinutesResponded.Value)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Pending</span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="list-group-item">
                            <div class="row">
                                <div class="col-6 text-secondary">Resolution Time</div>
                                <div class="col-6">
                                    @if (m_request.TotalMinutesResolved.HasValue)
                                    {
                                        <span class="text-success">@FormatMinutes(m_request.TotalMinutesResolved.Value)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Pending</span>
                                    }
                                </div>
                            </div>
                        </div>
                        @if (m_request.ResolvedTimestamp.HasValue)
                        {
                            <div class="list-group-item">
                                <div class="row">
                                    <div class="col-6 text-secondary">Resolved At</div>
                                    <div class="col-6">@m_request.ResolvedTimestamp.Value.ToString("g")</div>
                                </div>
                            </div>
                        }
                        @if (m_request.ClosedTimestamp.HasValue)
                        {
                            <div class="list-group-item">
                                <div class="row">
                                    <div class="col-6 text-secondary">Closed At</div>
                                    <div class="col-6">@m_request.ClosedTimestamp.Value.ToString("g")</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* Actions Card *@
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            @if (m_request.Status != TaskStatus.Done)
                            {
                                <button type="button" class="btn btn-success" @onclick="MarkAsResolved">
                                    <i class="ti ti-check me-2"></i>
                                    Mark as Resolved
                                </button>
                            }
                            @if (m_request.Status != TaskStatus.InProgress)
                            {
                                <button type="button" class="btn btn-warning" @onclick="MarkAsInProgress">
                                    <i class="ti ti-player-play me-2"></i>
                                    Mark as In Progress
                                </button>
                            }
                            @if (m_request.Status != TaskStatus.Cancelled)
                            {
                                <button type="button" class="btn btn-outline-danger" @onclick="CancelRequest">
                                    <i class="ti ti-x me-2"></i>
                                    Cancel Request
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private SupportRequest? m_request;
    private bool m_loading = true;
    private bool m_saving;
    private string? m_newDiscussion;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        m_loading = true;
        try
        {
            m_request = await CoreDataContext.LoadOneAsync<SupportRequest>(x => x.SupportRequestId == Id);
        }
        catch (Exception ex)
        {
            ShowError($"Error loading support request: {ex.Message}");
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task SaveAsync()
    {
        if (m_request == null) return;

        m_saving = true;
        try
        {
            using var session = CoreDataContext.OpenSession(UserName);
            session.Attach(m_request);
            var result = await session.SubmitChanges("UpdateSupportRequest");

            if (result.Success)
                ShowSuccess("Support request saved successfully.");
            else
                ShowError($"Failed to save: {result.Message ?? result.Errors.FirstOrDefault()?.Message}");
        }
        catch (Exception ex)
        {
            ShowError($"Error saving support request: {ex.Message}");
        }
        finally
        {
            m_saving = false;
        }
    }

    private async Task AddDiscussion()
    {
        if (m_request == null || string.IsNullOrWhiteSpace(m_newDiscussion)) return;

        m_request.Discussions.Add(new Discussion
        {
            Timestamp = DateTimeOffset.Now,
            User = UserName,
            Text = m_newDiscussion
        });

        m_newDiscussion = string.Empty;
        await SaveAsync();
    }

    private async Task MarkAsResolved()
    {
        if (m_request == null) return;

        m_request.Status = TaskStatus.Done;
        m_request.ResolvedTimestamp = DateTimeOffset.Now;
        m_request.TotalMinutesResolved = (DateTimeOffset.Now - m_request.Timestamp).TotalMinutes;
        await SaveAsync();
    }

    private async Task MarkAsInProgress()
    {
        if (m_request == null) return;

        m_request.Status = TaskStatus.InProgress;
        await SaveAsync();
    }

    private async Task CancelRequest()
    {
        if (m_request == null) return;

        var confirmed = await DialogService.ConfirmYesNoAsync(
            "Are you sure you want to cancel this support request?",
            "Cancel Request");

        if (confirmed)
        {
            m_request.Status = TaskStatus.Cancelled;
            m_request.ClosedTimestamp = DateTimeOffset.Now;
            await SaveAsync();
        }
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name[..Math.Min(2, name.Length)].ToUpper();
    }

    private string GetTimeAgo(DateTimeOffset timestamp)
    {
        var diff = DateTimeOffset.Now - timestamp;
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";
        return timestamp.ToString("MMM d");
    }

    private string FormatMinutes(double minutes)
    {
        if (minutes < 60) return $"{minutes:F0} min";
        if (minutes < 1440) return $"{minutes / 60:F1} hrs";
        return $"{minutes / 1440:F1} days";
    }
}
