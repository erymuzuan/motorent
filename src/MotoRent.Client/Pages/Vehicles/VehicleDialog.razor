@using MotoRent.Domain.Entities
@inherits LocalizedDialogBase<Vehicle, VehicleDialog>
@inject VehicleService VehicleService
@inject VehicleOwnerService VehicleOwnerService

<form id="@FormId" @onsubmit="SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="row g-3">
            @* Vehicle Type Selection *@
            <div class="col-12">
                <label class="form-label required">@Localizer["VehicleType"]</label>
                <div class="btn-group w-100" role="group">
                    @foreach (VehicleType type in Enum.GetValues<VehicleType>())
                    {
                        <input type="radio" class="btn-check" name="vehicleType" id="type-@type"
                               checked="@(Entity.VehicleType == type)"
                               @onchange="@(() => OnVehicleTypeChanged(type))"
                               disabled="@(!IsNew)" />
                        <label class="btn btn-outline-primary" for="type-@type">
                            <i class="ti @GetVehicleTypeIcon(type) me-1"></i>
                            @GetVehicleTypeLabel(type)
                        </label>
                    }
                </div>
            </div>

            @* Basic Info - All vehicle types *@
            <div class="col-md-6">
                <label class="form-label required">@Localizer["LicensePlate"]</label>
                <input type="text" class="form-control" @bind="Entity.LicensePlate" required
                       placeholder="e.g., 1กก 1234" />
            </div>

            <div class="col-md-6">
                <label class="form-label required">@Localizer["Status"]</label>
                <select class="form-select" @bind="Entity.Status" required>
                    @foreach (var status in VehicleStatus.AllStatuses)
                    {
                        <option value="@status">@Localizer[status]</option>
                    }
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label required">@Localizer["Brand"]</label>
                <input type="text" class="form-control" @bind="Entity.Brand" required
                       list="brandSuggestions" placeholder="e.g., Honda, Yamaha, Toyota" />
                <datalist id="brandSuggestions">
                    @foreach (var brand in GetBrandSuggestions())
                    {
                        <option value="@brand" />
                    }
                </datalist>
            </div>

            <div class="col-md-6">
                <label class="form-label required">@Localizer["Model"]</label>
                <input type="text" class="form-control" @bind="Entity.Model" required
                       placeholder="@GetModelPlaceholder()" />
            </div>

            @* Car-specific: Segment *@
            @if (Entity.VehicleType == VehicleType.Car)
            {
                <div class="col-md-6">
                    <label class="form-label required">@Localizer["Segment"]</label>
                    <select class="form-select" @bind="Entity.Segment" required>
                        <option value="">@Localizer["SelectSegment"]</option>
                        @foreach (CarSegment segment in Enum.GetValues<CarSegment>())
                        {
                            <option value="@segment">@GetSegmentLabel(segment)</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">@Localizer["Transmission"]</label>
                    <select class="form-select" @bind="Entity.Transmission">
                        <option value="">@Localizer["Select"]</option>
                        <option value="Automatic">@Localizer["Automatic"]</option>
                        <option value="Manual">@Localizer["Manual"]</option>
                    </select>
                </div>
            }

            @* Engine specs - Motorbikes and Cars *@
            @if (Entity.VehicleType == VehicleType.Motorbike || Entity.VehicleType == VehicleType.Car)
            {
                <div class="col-md-4">
                    <label class="form-label @(Entity.VehicleType == VehicleType.Motorbike ? "required" : "")">
                        @(Entity.VehicleType == VehicleType.Motorbike ? Localizer["EngineCC"] : Localizer["EngineLiters"])
                    </label>
                    @if (Entity.VehicleType == VehicleType.Motorbike)
                    {
                        <input type="number" class="form-control" @bind="Entity.EngineCC" required
                               min="50" max="2000" placeholder="125" />
                    }
                    else
                    {
                        <input type="number" class="form-control" @bind="Entity.EngineLiters"
                               min="0.5" max="8" step="0.1" placeholder="1.5" />
                    }
                </div>
            }

            @* Capacity - Cars, Vans, Boats *@
            @if (Entity.VehicleType == VehicleType.Boat)
            {
                <div class="col-md-4">
                    <label class="form-label">@Localizer["PassengerCapacity"]</label>
                    <input type="number" class="form-control" @bind="Entity.PassengerCapacity"
                           min="1" max="50" placeholder="12" />
                </div>
            }
            else if (Entity.VehicleType == VehicleType.Car || Entity.VehicleType == VehicleType.Van)
            {
                <div class="col-md-4">
                    <label class="form-label">@Localizer["SeatCount"]</label>
                    <input type="number" class="form-control" @bind="Entity.SeatCount"
                           min="1" max="50" placeholder="5" />
                </div>
            }

            <div class="col-md-4">
                <label class="form-label">@Localizer["Color"]</label>
                <input type="text" class="form-control" @bind="Entity.Color"
                       placeholder="e.g., Black, White, Red" />
            </div>

            <div class="col-md-4">
                <label class="form-label">@Localizer["Year"]</label>
                <input type="number" class="form-control" @bind="Entity.Year"
                       min="2000" max="@DateTime.Now.Year" />
            </div>

            @* Pricing Section *@
            <div class="col-12">
                <hr class="my-2" />
                <h4 class="mb-3">
                    <i class="ti ti-currency-baht me-1"></i>@Localizer["Pricing"]
                </h4>
            </div>

            @if (Entity.VehicleType == VehicleType.JetSki)
            {
                @* Interval pricing for Jet Ski *@
                <div class="col-md-4">
                    <label class="form-label">@Localizer["Rate15Min"]</label>
                    <div class="input-group">
                        <span class="input-group-text">฿</span>
                        <input type="number" class="form-control" @bind="Entity.Rate15Min"
                               min="0" step="50" placeholder="500" />
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">@Localizer["Rate30Min"]</label>
                    <div class="input-group">
                        <span class="input-group-text">฿</span>
                        <input type="number" class="form-control" @bind="Entity.Rate30Min"
                               min="0" step="50" placeholder="800" />
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label required">@Localizer["Rate1Hour"]</label>
                    <div class="input-group">
                        <span class="input-group-text">฿</span>
                        <input type="number" class="form-control" @bind="Entity.Rate1Hour" required
                               min="0" step="100" placeholder="1500" />
                    </div>
                </div>
            }
            else
            {
                @* Daily pricing for all other vehicles *@
                <div class="col-md-6">
                    <label class="form-label required">@Localizer["DailyRate"]</label>
                    <div class="input-group">
                        <span class="input-group-text">฿</span>
                        <input type="number" class="form-control" @bind="Entity.DailyRate" required
                               min="0" step="50" placeholder="@GetDailyRatePlaceholder()" />
                    </div>
                </div>
            }

            <div class="col-md-6">
                <label class="form-label required">@Localizer["DepositAmount"]</label>
                <div class="input-group">
                    <span class="input-group-text">฿</span>
                    <input type="number" class="form-control" @bind="Entity.DepositAmount" required
                           min="0" step="500" placeholder="@GetDepositPlaceholder()" />
                </div>
            </div>

            @* Driver/Guide options - Boats and Vans *@
            @if (Entity.VehicleType == VehicleType.Boat || Entity.VehicleType == VehicleType.Van)
            {
                <div class="col-12">
                    <hr class="my-2" />
                    <h4 class="mb-3">
                        <i class="ti ti-user me-1"></i>@Localizer["DriverGuideOptions"]
                    </h4>
                </div>

                <div class="col-md-6">
                    <label class="form-label">@Localizer["DriverDailyFee"]</label>
                    <div class="input-group">
                        <span class="input-group-text">฿</span>
                        <input type="number" class="form-control" @bind="Entity.DriverDailyFee"
                               min="0" step="100" placeholder="1000" />
                    </div>
                    <small class="text-secondary">@Localizer["DriverFeeHint"]</small>
                </div>

                <div class="col-md-6">
                    <label class="form-label">@Localizer["GuideDailyFee"]</label>
                    <div class="input-group">
                        <span class="input-group-text">฿</span>
                        <input type="number" class="form-control" @bind="Entity.GuideDailyFee"
                               min="0" step="100" placeholder="800" />
                    </div>
                    <small class="text-secondary">@Localizer["GuideFeeHint"]</small>
                </div>
            }

            @* Mileage tracking - Motorbikes, Cars, Vans *@
            @if (Entity.VehicleType == VehicleType.Motorbike || Entity.VehicleType == VehicleType.Car || Entity.VehicleType == VehicleType.Van)
            {
                <div class="col-12">
                    <hr class="my-2" />
                    <h4 class="mb-3">
                        <i class="ti ti-gauge me-1"></i>@Localizer["MaintenanceTracking"]
                    </h4>
                </div>

                <div class="col-md-6">
                    <label class="form-label">@Localizer["CurrentMileage"]</label>
                    <input type="number" class="form-control" @bind="Entity.Mileage"
                           min="0" placeholder="0" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">@Localizer["LastServiceDate"]</label>
                    <input type="date" class="form-control" @bind="m_lastServiceDate" />
                </div>
            }

            <div class="col-12">
                <label class="form-label">@Localizer["Notes"]</label>
                <textarea class="form-control" @bind="Entity.Notes" rows="3"
                          placeholder="@Localizer["NotesPlaceholder"]"></textarea>
            </div>

            @* Third-Party Owner Section *@
            <div class="col-12">
                <hr class="my-2" />
                <h4 class="mb-3">
                    <i class="ti ti-user-dollar me-1"></i>@Localizer["ThirdPartyOwner"]
                </h4>
            </div>

            <div class="col-12">
                <label class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" @bind="m_isThirdPartyOwned" />
                    <span class="form-check-label">@Localizer["IsThirdPartyOwned"]</span>
                </label>
                <small class="form-hint">@Localizer["ThirdPartyHint"]</small>
            </div>

            @if (m_isThirdPartyOwned)
            {
                <div class="col-md-6">
                    <label class="form-label required">@Localizer["Owner"]</label>
                    <select class="form-select" @bind="Entity.VehicleOwnerId" required>
                        <option value="">@Localizer["SelectOwner"]</option>
                        @foreach (var owner in m_owners)
                        {
                            <option value="@owner.VehicleOwnerId">@owner.Name</option>
                        }
                    </select>
                    @if (m_owners.Count == 0)
                    {
                        <small class="text-warning">
                            <i class="ti ti-alert-triangle me-1"></i>
                            @Localizer["NoOwnersConfigured"]. <a href="/settings/vehicle-owners" target="_blank">@Localizer["AddOwnerFirst"]</a>.
                        </small>
                    }
                </div>

                <div class="col-md-6">
                    <label class="form-label required">@Localizer["PaymentModel"]</label>
                    <select class="form-select" @bind="Entity.OwnerPaymentModel" required>
                        <option value="@OwnerPaymentModel.DailyRate">@Localizer["DailyRateModel"]</option>
                        <option value="@OwnerPaymentModel.RevenueShare">@Localizer["RevenueShareModel"]</option>
                    </select>
                </div>

                @if (Entity.OwnerPaymentModel is OwnerPaymentModel.DailyRate or null)
                {
                    <div class="col-md-6">
                        <label class="form-label required">@Localizer["OwnerDailyRate"]</label>
                        <div class="input-group">
                            <span class="input-group-text">฿</span>
                            <input type="number" class="form-control" @bind="Entity.OwnerDailyRate"
                                   min="0" step="50" placeholder="200" required />
                        </div>
                        <small class="text-secondary">@Localizer["OwnerDailyRateHint"]</small>
                    </div>
                }
                else
                {
                    <div class="col-md-6">
                        <label class="form-label required">@Localizer["RevenueSharePercent"]</label>
                        <div class="input-group">
                            <input type="number" class="form-control" @bind="m_revenueSharePercent"
                                   min="0" max="100" step="5" placeholder="30" required />
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-secondary">@Localizer["RevenueShareHint"]</small>
                    </div>
                }

                <div class="col-12">
                    <div class="alert alert-info py-2 mb-0">
                        <i class="ti ti-info-circle me-1"></i>
                        <strong>@Localizer["HowItWorks"]</strong>
                        @if (Entity.OwnerPaymentModel is OwnerPaymentModel.DailyRate or null)
                        {
                            <span>@Localizer["DailyRateModelDesc"]</span>
                        }
                        else
                        {
                            <span>@Localizer["RevenueShareModelDesc"]</span>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="@FormId" class="btn btn-primary" disabled="@Saving">
        @if (Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-device-floppy me-1"></i>
        @SaveButtonText
    </button>
</div>

@code {
    private DateTime? m_lastServiceDate;
    private bool m_isThirdPartyOwned;
    private decimal? m_revenueSharePercent;
    private List<VehicleOwner> m_owners = [];

    protected override async Task OnInitializedAsync()
    {
        this.m_lastServiceDate = this.Entity.LastServiceDate?.DateTime;
        this.FormValid = true;

        // Initialize third-party owner state from Entity
        this.m_isThirdPartyOwned = this.Entity is { VehicleOwnerId: > 0 };

        // Convert decimal to percentage for display (0.30 -> 30)
        if (this.Entity.OwnerRevenueSharePercent is { } share)
        {
            this.m_revenueSharePercent = share * 100;
        }

        // Load owners
        await this.LoadOwnersAsync();
    }

    private async Task LoadOwnersAsync()
    {
        try
        {
            var result = await this.VehicleOwnerService.GetOwnersAsync(
                isActive: true,
                searchTerm: null,
                page: 1,
                pageSize: 100);
            this.m_owners = result.ItemCollection;
        }
        catch
        {
            // Silently fail - owners dropdown will be empty
            this.m_owners = [];
        }
    }

    private void OnVehicleTypeChanged(VehicleType type)
    {
        this.Entity.VehicleType = type;

        // Set default duration type based on vehicle type
        this.Entity.DurationType = type == VehicleType.JetSki
            ? RentalDurationType.FixedInterval
            : RentalDurationType.Daily;

        // Clear type-specific fields when changing type
        if (type != VehicleType.Car)
        {
            this.Entity.Segment = null;
            this.Entity.Transmission = null;
            this.Entity.EngineLiters = null;
            this.Entity.SeatCount = null;
        }

        if (type == VehicleType.JetSki)
        {
            // Clear daily rate for jet skis
            this.Entity.DailyRate = 0;
        }
        else
        {
            // Clear interval rates for non-jet ski
            this.Entity.Rate15Min = null;
            this.Entity.Rate30Min = null;
            this.Entity.Rate1Hour = null;
        }

        if (type != VehicleType.Boat && type != VehicleType.Van)
        {
            this.Entity.DriverDailyFee = null;
            this.Entity.GuideDailyFee = null;
            this.Entity.PassengerCapacity = null;
        }

        this.StateHasChanged();
    }

    private async Task SaveAsync()
    {
        this.Saving = true;

        try
        {
            this.Entity.LastServiceDate = this.m_lastServiceDate.HasValue
                ? new DateTimeOffset(this.m_lastServiceDate.Value)
                : null;

            // Handle third-party owner fields
            if (this.m_isThirdPartyOwned)
            {
                // Convert percentage to decimal (30 -> 0.30)
                if (this.Entity.OwnerPaymentModel is OwnerPaymentModel.RevenueShare && this.m_revenueSharePercent is { } percent)
                {
                    this.Entity.OwnerRevenueSharePercent = percent / 100m;
                    this.Entity.OwnerDailyRate = null; // Clear daily rate when using revenue share
                }
                else
                {
                    this.Entity.OwnerRevenueSharePercent = null; // Clear percentage when using daily rate
                }

                // Set owner name for denormalization
                var selectedOwner = this.m_owners.FirstOrDefault(o => o.VehicleOwnerId == this.Entity.VehicleOwnerId);
                this.Entity.VehicleOwnerName = selectedOwner?.Name;
            }
            else
            {
                // Clear all owner fields when not third-party owned
                this.Entity.VehicleOwnerId = null;
                this.Entity.VehicleOwnerName = null;
                this.Entity.OwnerPaymentModel = null;
                this.Entity.OwnerDailyRate = null;
                this.Entity.OwnerRevenueSharePercent = null;
            }

            var result = this.IsNew
                ? await this.VehicleService.CreateVehicleAsync(this.Entity, this.UserName)
                : await this.VehicleService.UpdateVehicleAsync(this.Entity, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError(Localizer["SaveFailed", result.Message ?? ""]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["Error", ex.Message]);
        }
        finally
        {
            this.Saving = false;
        }
    }

    private static string GetVehicleTypeIcon(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "ti-motorbike",
        VehicleType.Car => "ti-car",
        VehicleType.JetSki => "ti-sailboat",
        VehicleType.Boat => "ti-ship",
        VehicleType.Van => "ti-bus",
        _ => "ti-car"
    };

    private string GetVehicleTypeLabel(VehicleType type) => type switch
    {
        VehicleType.Motorbike => Localizer["Motorbike"],
        VehicleType.Car => Localizer["Car"],
        VehicleType.JetSki => Localizer["JetSki"],
        VehicleType.Boat => Localizer["Boat"],
        VehicleType.Van => Localizer["Van"],
        _ => Localizer["Vehicle"]
    };

    private string GetSegmentLabel(CarSegment segment) => segment switch
    {
        CarSegment.SmallSedan => Localizer["SmallSedan"],
        CarSegment.BigSedan => Localizer["BigSedan"],
        CarSegment.SUV => Localizer["SUV"],
        CarSegment.Pickup => Localizer["Pickup"],
        CarSegment.Hatchback => Localizer["Hatchback"],
        CarSegment.Minivan => Localizer["Minivan"],
        CarSegment.Luxury => Localizer["Luxury"],
        _ => segment.ToString()
    };

    private List<string> GetBrandSuggestions() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => ["Honda", "Yamaha", "Suzuki", "Kawasaki", "Vespa", "GPX"],
        VehicleType.Car => ["Toyota", "Honda", "Mazda", "Nissan", "Mitsubishi", "Isuzu", "Mercedes", "BMW"],
        VehicleType.JetSki => ["Yamaha", "Sea-Doo", "Kawasaki", "Honda"],
        VehicleType.Boat => ["Yamaha", "Bayliner", "Sea Ray", "Boston Whaler"],
        VehicleType.Van => ["Toyota", "Hyundai", "Mercedes", "Ford", "Nissan"],
        _ => []
    };

    private string GetModelPlaceholder() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => "e.g., Click 125, PCX 160, Aerox 155",
        VehicleType.Car => "e.g., Camry, Civic, CX-5",
        VehicleType.JetSki => "e.g., VX Cruiser, GTI 130",
        VehicleType.Boat => "e.g., Center Console 24ft",
        VehicleType.Van => "e.g., Hiace, H1, Sprinter",
        _ => "Model name"
    };

    private string GetDailyRatePlaceholder() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => "300",
        VehicleType.Car => "1500",
        VehicleType.Boat => "5000",
        VehicleType.Van => "2500",
        _ => "1000"
    };

    private string GetDepositPlaceholder() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => "2000",
        VehicleType.Car => "10000",
        VehicleType.JetSki => "5000",
        VehicleType.Boat => "20000",
        VehicleType.Van => "10000",
        _ => "5000"
    };
}
