@page "/vehicles/{VehicleId}/inspection"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Models.VehicleInspection
@using MotoRent.Client.Controls.VehicleInspection
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<VehicleInspectionPage>
@inject VehicleService VehicleService
@inject VehicleInspectionService VehicleInspectionService
@inject NavigationManager NavigationManager

<MotoRentPageTitle>@Localizer["VehicleInspection"] - @m_vehicle?.LicensePlate</MotoRentPageTitle>

<TablerHeader Title="@Localizer["VehicleInspection"]" PreTitle="@m_headerPreTitle">
    <a href="@m_backUrl" class="btn btn-ghost-secondary me-2">
        <i class="ti ti-arrow-left me-1"></i>
        @Localizer["Back"]
    </a>
    @if (!m_loading && m_vehicle != null)
    {
        <button type="button" class="btn btn-primary" disabled="@m_saving" @onclick="SaveInspectionAsync">
            @if (m_saving)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
            }
            else
            {
                <i class="ti ti-device-floppy me-1"></i>
            }
            @Localizer["Save"]
        </button>
    }
</TablerHeader>

<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Card" Rows="6">
    @if (m_notFound)
    {
        <div class="alert alert-danger">
            <div class="d-flex">
                <div class="me-3">
                    <i class="ti ti-alert-circle" style="font-size: 2rem;"></i>
                </div>
                <div>
                    <h4 class="alert-title">@Localizer["VehicleNotFound"]</h4>
                    <div class="text-secondary">
                        @Localizer["VehicleNotFoundDesc", VehicleId]
                    </div>
                    <div class="mt-3">
                        <a href="/vehicles" class="btn btn-outline-danger">
                            <i class="ti ti-arrow-left me-1"></i>
                            @Localizer["BackToFleet"]
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (m_vehicle != null)
    {
        <div class="row g-3">
            @* Left Column: 3D Inspector *@
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-3d-cube-sphere me-2"></i>
                            @Localizer["3DInspection"]
                        </h3>
                        <div class="card-actions">
                            <span class="badge bg-primary-lt">
                                @m_vehicle.Brand @m_vehicle.Model
                            </span>
                            <span class="badge bg-secondary-lt ms-1">
                                @m_vehicle.LicensePlate
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <VehicleInspector @ref="m_vehicleInspector"
                                          ModelPath="@GetVehicleModelPath()"
                                          Height="450"
                                          Markers="@m_inspectionMarkers"
                                          MarkersChanged="OnInspectionMarkersChanged"
                                          OnMarkerAdded="OnMarkerAdded"
                                          OnMarkerSelected="OnMarkerSelected"
                                          ShowMarkersList="false" />
                    </div>
                </div>

                @* Inspection Context Info *@
                @if (!string.IsNullOrEmpty(m_inspectionContextLabel))
                {
                    <div class="card mt-3">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center gap-2">
                                <i class="ti @m_inspectionContextIcon text-primary"></i>
                                <span class="fw-medium">@m_inspectionContextLabel</span>
                                @if (m_existingInspection != null)
                                {
                                    <span class="badge bg-success-lt ms-auto">
                                        <i class="ti ti-check me-1"></i>
                                        @Localizer["ExistingInspection"]
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                }

                @* Previous Inspections *@
                @if (m_previousInspections.Count > 0)
                {
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="ti ti-history me-2"></i>
                                @Localizer["PreviousInspections"]
                            </h3>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table">
                                <thead>
                                    <tr>
                                        <th>@Localizer["Date"]</th>
                                        <th>@Localizer["Type"]</th>
                                        <th>@Localizer["Condition"]</th>
                                        <th>@Localizer["Markers"]</th>
                                        <th>@Localizer["Inspector"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var inspection in m_previousInspections.Take(5))
                                    {
                                        <tr class="@(inspection.VehicleInspectionId == m_existingInspection?.VehicleInspectionId ? "table-active" : "")">
                                            <td>@FormatDateTime(inspection.InspectedAt)</td>
                                            <td>
                                                <span class="badge @GetInspectionTypeBadgeClass(inspection.InspectionType)">
                                                    @Localizer[inspection.InspectionType]
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge @GetConditionBadgeClass(inspection.OverallCondition)">
                                                    @Localizer[inspection.OverallCondition]
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary-lt">@inspection.Markers.Count</span>
                                                @if (inspection.NewDamageCount > 0)
                                                {
                                                    <span class="badge bg-danger-lt ms-1">+@inspection.NewDamageCount @Localizer["New"]</span>
                                                }
                                            </td>
                                            <td class="text-secondary">@inspection.Inspector?.UserName</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>

            @* Right Column: Marker Details & Settings *@
            <div class="col-lg-4">
                @* Marker Detail Panel *@
                <MarkerDetailPanel Marker="@m_selectedMarker"
                                   MarkerChanged="OnMarkerUpdated"
                                   ShowPhotos="true"
                                   OnAddPhoto="OnAddMarkerPhoto" />

                @* Markers List *@
                @if (m_inspectionMarkers.Count > 0)
                {
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="ti ti-list-check me-1"></i>
                                @Localizer["DamageMarkers"] (@m_inspectionMarkers.Count)
                            </h5>
                        </div>
                        <div class="list-group list-group-flush" style="max-height: 250px; overflow-y: auto;">
                            @for (int i = 0; i < m_inspectionMarkers.Count; i++)
                            {
                                var idx = i;
                                var marker = m_inspectionMarkers[i];
                                <button type="button"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(m_selectedMarker?.MarkerId == marker.MarkerId ? "active" : "")"
                                        @onclick="@(() => SelectMarkerByIndex(idx))">
                                    <span>
                                        <span class="badge bg-secondary rounded-pill me-1">@(idx + 1)</span>
                                        @marker.DamageType
                                        @if (!string.IsNullOrEmpty(marker.LocationDescription))
                                        {
                                            <small class="text-muted ms-1">(@marker.LocationDescription)</small>
                                        }
                                    </span>
                                    <span class="d-flex align-items-center gap-1">
                                        <span class="badge @GetSeverityBadgeClass(marker.Severity)">
                                            @marker.Severity
                                        </span>
                                        @if (marker.IsPreExisting)
                                        {
                                            <span class="badge bg-secondary">@Localizer["PreExisting"]</span>
                                        }
                                    </span>
                                </button>
                            }
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between small">
                                <span>@Localizer["EstimatedTotal"]:</span>
                                <strong class="text-danger">
                                    @FormatCurrency(m_inspectionMarkers.Sum(m => m.EstimatedCost ?? 0))
                                </strong>
                            </div>
                        </div>
                    </div>
                }

                @* Inspection Settings *@
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="ti ti-settings me-1"></i>
                            @Localizer["InspectionSettings"]
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">@Localizer["OverallCondition"]</label>
                            <select class="form-select" @bind="m_overallCondition">
                                <option value="Excellent">@Localizer["Excellent"]</option>
                                <option value="Good">@Localizer["Good"]</option>
                                <option value="Fair">@Localizer["Fair"]</option>
                                <option value="Poor">@Localizer["Poor"]</option>
                                <option value="Damaged">@Localizer["Damaged"]</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">@Localizer["Notes"]</label>
                            <textarea class="form-control" rows="3" @bind="m_notes"
                                      placeholder="@Localizer["NotesPlaceholder"]"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</LoadingSkeleton>

@code {
    [Parameter] public string VehicleId { get; set; } = "";

    [SupplyParameterFromQuery(Name = "accidentId")]
    public string? AccidentIdParam { get; set; }

    [SupplyParameterFromQuery(Name = "rentalId")]
    public string? RentalIdParam { get; set; }

    [SupplyParameterFromQuery(Name = "maintenanceId")]
    public string? MaintenanceIdParam { get; set; }

    private int m_vehicleId;
    private int? m_accidentId;
    private int? m_rentalId;
    private int? m_maintenanceId;

    private Vehicle? m_vehicle;
    private VehicleInspection? m_existingInspection;
    private List<VehicleInspection> m_previousInspections = [];

    private VehicleInspector? m_vehicleInspector;
    private List<DamageMarker> m_inspectionMarkers = [];
    private DamageMarker? m_selectedMarker;

    private string m_overallCondition = "Good";
    private string? m_notes;

    private bool m_loading = true;
    private bool m_notFound;
    private bool m_saving;
    private string m_headerPreTitle = "";
    private string m_backUrl = "/vehicles";
    private string m_inspectionContextLabel = "";
    private string m_inspectionContextIcon = "ti-clipboard-check";

    protected override async Task OnParametersSetAsync()
    {
        m_vehicleId = DecodeId(VehicleId);

        // Parse context IDs from query parameters
        m_accidentId = !string.IsNullOrEmpty(AccidentIdParam) ? DecodeId(AccidentIdParam) : null;
        m_rentalId = !string.IsNullOrEmpty(RentalIdParam) ? DecodeId(RentalIdParam) : null;
        m_maintenanceId = !string.IsNullOrEmpty(MaintenanceIdParam) ? (int?)int.Parse(MaintenanceIdParam) : null;

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        m_loading = true;
        m_notFound = false;
        try
        {
            // Load vehicle
            m_vehicle = await VehicleService.GetVehicleByIdAsync(m_vehicleId);
            if (m_vehicle == null)
            {
                m_notFound = true;
                return;
            }

            m_headerPreTitle = $"{m_vehicle.Brand} {m_vehicle.Model} - {m_vehicle.LicensePlate}";

            // Determine context and set labels/back URL
            ConfigureContext();

            // Load existing inspection for this context
            await LoadExistingInspectionAsync();

            // Load previous inspections for this vehicle
            m_previousInspections = await VehicleInspectionService.GetByVehicleAsync(m_vehicleId);
        }
        catch (Exception ex)
        {
            ShowError(Localizer["ErrorLoadingData", ex.Message]);
            Logger.LogError(ex, "Failed to load vehicle inspection data for vehicle {VehicleId}", m_vehicleId);
        }
        finally
        {
            m_loading = false;
        }
    }

    private void ConfigureContext()
    {
        if (m_accidentId.HasValue)
        {
            m_inspectionContextLabel = Localizer["AccidentInspection"];
            m_inspectionContextIcon = "ti-car-crash";
            m_backUrl = $"/accidents/{EncodeId(m_accidentId.Value)}";
        }
        else if (m_rentalId.HasValue)
        {
            m_inspectionContextLabel = Localizer["RentalInspection"];
            m_inspectionContextIcon = "ti-receipt";
            m_backUrl = $"/rentals/view/{EncodeId(m_rentalId.Value)}";
        }
        else if (m_maintenanceId.HasValue)
        {
            m_inspectionContextLabel = Localizer["MaintenanceInspection"];
            m_inspectionContextIcon = "ti-tool";
            m_backUrl = $"/maintenance/{m_maintenanceId.Value}";
        }
        else
        {
            m_inspectionContextLabel = Localizer["RoutineInspection"];
            m_inspectionContextIcon = "ti-clipboard-check";
            m_backUrl = $"/vehicles/{VehicleId}";
        }
    }

    private async Task LoadExistingInspectionAsync()
    {
        // Try to find existing inspection for the context
        if (m_accidentId.HasValue)
        {
            m_existingInspection = await LoadInspectionByAccidentIdAsync(m_accidentId.Value);
        }
        else if (m_rentalId.HasValue)
        {
            // Could be pre-rental or post-rental - get the most recent for the rental
            var rentalInspections = await VehicleInspectionService.GetByRentalAsync(m_rentalId.Value);
            m_existingInspection = rentalInspections.LastOrDefault();
        }

        // If we found an existing inspection, populate the markers and settings
        if (m_existingInspection != null)
        {
            m_inspectionMarkers = [.. m_existingInspection.Markers];
            m_overallCondition = m_existingInspection.OverallCondition;
            m_notes = m_existingInspection.Notes;
        }
        else
        {
            // If no existing inspection, check for previous inspections to pre-populate pre-existing markers
            var latestInspection = await VehicleInspectionService.GetLatestAsync(m_vehicleId);
            if (latestInspection != null)
            {
                // Copy markers as pre-existing
                m_inspectionMarkers = latestInspection.Markers.Select(m => new DamageMarker
                {
                    MarkerId = Guid.NewGuid(),
                    Position = m.Position,
                    DamageType = m.DamageType,
                    Severity = m.Severity,
                    LocationDescription = m.LocationDescription,
                    Description = m.Description,
                    EstimatedCost = m.EstimatedCost,
                    IsPreExisting = true,
                    CreatedAt = m.CreatedAt,
                    CreatedBy = m.CreatedBy
                }).ToList();
                m_overallCondition = latestInspection.OverallCondition;
            }
        }
    }

    private async Task<VehicleInspection?> LoadInspectionByAccidentIdAsync(int accidentId)
    {
        // Get all inspections for this vehicle and filter by accident ID
        var inspections = await VehicleInspectionService.GetByVehicleAsync(m_vehicleId);
        return inspections.FirstOrDefault(i => i.AccidentId == accidentId);
    }

    private async Task SaveInspectionAsync()
    {
        if (m_vehicle == null) return;

        m_saving = true;
        try
        {
            // Get camera state for restoring view later
            var cameraState = m_vehicleInspector != null
                ? await m_vehicleInspector.GetCameraStateAsync()
                : null;

            SubmitOperation result;

            if (m_existingInspection != null)
            {
                // Update existing inspection
                m_existingInspection.Markers = m_inspectionMarkers;
                m_existingInspection.OverallCondition = m_overallCondition;
                m_existingInspection.Notes = m_notes;
                m_existingInspection.SavedCameraState = cameraState;

                result = await VehicleInspectionService.UpdateAsync(m_existingInspection, UserName);
            }
            else if (m_accidentId.HasValue)
            {
                // Create new accident inspection
                result = await VehicleInspectionService.CreateAccidentInspectionAsync(
                    m_vehicleId,
                    m_accidentId.Value,
                    m_inspectionMarkers,
                    m_overallCondition,
                    m_notes,
                    cameraState,
                    UserName);
            }
            else
            {
                // Create a routine inspection
                var inspection = new VehicleInspection
                {
                    VehicleId = m_vehicleId,
                    RentalId = m_rentalId,
                    MaintenanceRecordId = m_maintenanceId,
                    InspectionType = GetInspectionType(),
                    Markers = m_inspectionMarkers,
                    OverallCondition = m_overallCondition,
                    Notes = m_notes,
                    SavedCameraState = cameraState,
                    ModelPath = GetVehicleModelPath()
                };

                result = await VehicleInspectionService.CreateAsync(inspection, UserName);
            }

            if (result.Success)
            {
                ShowSuccess(Localizer["InspectionSaved"]);
                NavigationManager.NavigateTo(m_backUrl);
            }
            else
            {
                ShowError(Localizer["SaveFailed", result.Message ?? ""]);
            }
        }
        catch (Exception ex)
        {
            ShowError(Localizer["ErrorSaving", ex.Message]);
            Logger.LogError(ex, "Failed to save vehicle inspection");
        }
        finally
        {
            m_saving = false;
        }
    }

    private string GetInspectionType()
    {
        if (m_accidentId.HasValue) return "Accident";
        if (m_maintenanceId.HasValue) return "Maintenance";
        if (m_rentalId.HasValue) return "PostRental";
        return "Routine";
    }

    private string GetVehicleModelPath()
    {
        if (m_vehicle == null) return "models/vehicles/scooter-generic.glb";

        return VehicleInspectionService.GetModelPath(
            m_vehicle.VehicleType,
            m_vehicle.EngineCC);
    }

    private void OnInspectionMarkersChanged(List<DamageMarker> markers)
    {
        m_inspectionMarkers = markers;
    }

    private void OnMarkerAdded(DamageMarker marker)
    {
        m_selectedMarker = marker;
    }

    private void OnMarkerSelected(DamageMarker marker)
    {
        m_selectedMarker = marker;
    }

    private void OnMarkerUpdated(DamageMarker marker)
    {
        if (m_selectedMarker != null && m_vehicleInspector != null)
        {
            m_vehicleInspector.UpdateMarker(marker);
            m_selectedMarker = marker;
        }
    }

    private void SelectMarkerByIndex(int index)
    {
        if (index >= 0 && index < m_inspectionMarkers.Count)
        {
            m_selectedMarker = m_inspectionMarkers[index];
        }
    }

    private async Task OnAddMarkerPhoto()
    {
        // TODO: Implement photo upload for marker
        await Task.CompletedTask;
    }

    private static string GetSeverityBadgeClass(string severity) => severity switch
    {
        "Minor" => "bg-success",
        "Moderate" => "bg-warning text-dark",
        "Major" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetInspectionTypeBadgeClass(string type) => type switch
    {
        "PreRental" => "bg-info-lt text-info",
        "PostRental" => "bg-primary-lt text-primary",
        "Accident" => "bg-danger-lt text-danger",
        "Maintenance" => "bg-warning-lt text-warning",
        "Routine" => "bg-secondary-lt text-secondary",
        _ => "bg-secondary-lt"
    };

    private static string GetConditionBadgeClass(string condition) => condition switch
    {
        "Excellent" => "bg-success",
        "Good" => "bg-success-lt text-success",
        "Fair" => "bg-warning-lt text-warning",
        "Poor" => "bg-orange-lt text-orange",
        "Damaged" => "bg-danger",
        _ => "bg-secondary"
    };
}
