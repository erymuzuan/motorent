@using MotoRent.Client.Components.Vehicles
@using MotoRent.Client.Components.Shared
@using MotoRent.Domain.Lookups
@inherits LocalizedComponentBase<VehicleForm>
@inject VehicleLookupService LookupService

<div class="row">
    @* Left Column: Basic Info & Images *@
    <div class="col-lg-4">
        @* Quick Recognition Panel (for new vehicles only) *@
        @if (IsNew)
        {
            <VehicleRecognitionPanel SuggestedVehicleType="@Entity.VehicleType"
                                     OnApply="ApplyRecognitionResult" />
        }

        @* Basic Info Card *@
        <div class="mr-form-panel mb-3">
            <div class="mr-form-panel-header">
                <div class="mr-form-panel-header-icon">
                    <i class="ti ti-info-circle"></i>
                </div>
                <h3 class="mr-form-panel-title">@Localizer["BasicInfo"]</h3>
            </div>
            <div class="mr-form-panel-body">
                @* Vehicle Type *@
                <div class="mb-3">
                    <label class="mr-form-label">@Localizer["VehicleType"] <span class="required">*</span></label>
                    @if (IsNew)
                    {
                        <div class="mr-quick-select">
                            @foreach (VehicleType type in Enum.GetValues<VehicleType>())
                            {
                                <button type="button"
                                        class="mr-quick-select-btn @(Entity.VehicleType == type ? "active" : "")"
                                        @onclick="@(() => OnVehicleTypeChanged(type))">
                                    <i class="ti @GetVehicleTypeIcon(type) me-1"></i>
                                    @GetVehicleTypeLabel(type)
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mt-2">
                            <span class="mr-detail-badge" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                                <i class="ti @GetVehicleTypeIcon(Entity.VehicleType) me-1"></i>
                                @GetVehicleTypeLabel(Entity.VehicleType)
                            </span>
                        </div>
                        <div class="mr-form-hint">
                            <i class="ti ti-info-circle"></i>
                            @Localizer["VehicleTypeCannotChange"]
                        </div>
                    }
                </div>

                @* License Plate *@
                <div class="mb-3">
                    <label class="mr-form-label">@Localizer["LicensePlate"] <span class="required">*</span></label>
                    <input type="text" class="mr-form-control" @bind="Entity.LicensePlate" required
                           placeholder="@Localizer["LicensePlatePlaceholder"]" />
                </div>

                @* Brand & Model *@
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="mr-form-label">@Localizer["Brand"] <span class="required">*</span></label>
                        <input type="text" class="mr-form-control" @bind="Entity.Brand" required
                               list="brandSuggestions" placeholder="@Localizer["BrandPlaceholder"]" />
                        <datalist id="brandSuggestions">
                            @foreach (var brand in GetBrandSuggestions())
                            {
                                <option value="@brand" />
                            }
                        </datalist>
                    </div>
                    <div class="col-6">
                        <label class="mr-form-label">@Localizer["Model"] <span class="required">*</span></label>
                        <input type="text" class="mr-form-control" @bind="Entity.Model" required
                               placeholder="@GetModelPlaceholder()" />
                    </div>
                </div>

                @* Color & Year *@
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="mr-form-label">@Localizer["Color"]</label>
                        <input type="text" class="mr-form-control" @bind="Entity.Color"
                               placeholder="@Localizer["ColorPlaceholder"]" />
                    </div>
                    <div class="col-6">
                        <label class="mr-form-label">@Localizer["Year"]</label>
                        <input type="number" class="mr-form-control" @bind="Entity.Year"
                               min="2000" max="@DateTime.Now.Year" />
                    </div>
                </div>

                @* Status *@
                <div class="mb-0">
                    <label class="mr-form-label">@Localizer["Status"] <span class="required">*</span></label>
                    <select class="mr-form-control" @bind="Entity.Status" required>
                        @foreach (VehicleStatus status in Enum.GetValues<VehicleStatus>())
                        {
                            <option value="@status">@GetStatusLabel(status)</option>
                        }
                    </select>
                </div>
            </div>
        </div>

        @* Vehicle Images *@
        @if (!IsNew && Entity.VehicleId > 0)
        {
            <VehicleImageGallery VehicleId="@Entity.VehicleId"
                                 PrimaryImageChanged="OnPrimaryImageChanged"
                                 ImagesChanged="OnImagesChanged" />
        }
        else if (IsNew)
        {
            <div class="mr-form-panel mb-3">
                <div class="mr-form-panel-header">
                    <div class="mr-form-panel-header-icon">
                        <i class="ti ti-photo"></i>
                    </div>
                    <h3 class="mr-form-panel-title">@Localizer["VehicleImages"]</h3>
                </div>
                <div class="mr-form-panel-body">
                    <div class="mr-info-panel">
                        <div class="mr-info-panel-icon">
                            <i class="ti ti-info-circle"></i>
                        </div>
                        <div>
                            <div class="mr-info-panel-title">@Localizer["SaveToAddImages"]</div>
                            <p class="mr-info-panel-text">@Localizer["SaveToAddImagesHint"]</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* Right Column: Type-Specific & Pricing *@
    <div class="col-lg-8">
        @* Type-Specific Fields Card *@
        <div class="mr-form-panel mb-3">
            <div class="mr-form-panel-header">
                <div class="mr-form-panel-header-icon">
                    <i class="ti @GetVehicleTypeIcon(Entity.VehicleType)"></i>
                </div>
                <h3 class="mr-form-panel-title">@GetVehicleTypeLabel(Entity.VehicleType) @Localizer["Details"]</h3>
            </div>
            <div class="mr-form-panel-body">
                <div class="row g-3">
                    @* Car-specific: Segment & Transmission *@
                    @if (Entity.VehicleType == VehicleType.Car)
                    {
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["Segment"] <span class="required">*</span></label>
                            <select class="mr-form-control" @bind="Entity.Segment" required>
                                <option value="">@Localizer["SelectSegment"]...</option>
                                @foreach (CarSegment segment in Enum.GetValues<CarSegment>())
                                {
                                    <option value="@segment">@GetSegmentLabel(segment)</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["Transmission"]</label>
                            <select class="mr-form-control" @bind="Entity.Transmission">
                                <option value="">@Localizer["Select"]...</option>
                                <option value="Automatic">@Localizer["Automatic"]</option>
                                <option value="Manual">@Localizer["Manual"]</option>
                            </select>
                        </div>
                    }

                    @* Engine specs - Motorbikes and Cars *@
                    @if (Entity.VehicleType == VehicleType.Motorbike)
                    {
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["EngineCC"] <span class="required">*</span></label>
                            <div class="mr-input-group">
                                <input type="number" class="mr-form-control" @bind="Entity.EngineCC" required
                                       min="50" max="2000" placeholder="125" />
                                <span class="mr-input-group-text">cc</span>
                            </div>
                        </div>
                    }
                    else if (Entity.VehicleType == VehicleType.Car)
                    {
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["EngineLiters"]</label>
                            <div class="mr-input-group">
                                <input type="number" class="mr-form-control" @bind="Entity.EngineLiters"
                                       min="0.5" max="8" step="0.1" placeholder="1.5" />
                                <span class="mr-input-group-text">L</span>
                            </div>
                        </div>
                    }

                    @* Capacity - Cars, Vans, Boats *@
                    @if (Entity.VehicleType == VehicleType.Boat)
                    {
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["PassengerCapacity"]</label>
                            <div class="mr-input-group">
                                <input type="number" class="mr-form-control" @bind="Entity.PassengerCapacity"
                                       min="1" max="50" placeholder="12" />
                                <span class="mr-input-group-text">@Localizer["Persons"]</span>
                            </div>
                        </div>
                    }
                    else if (Entity.VehicleType == VehicleType.Car || Entity.VehicleType == VehicleType.Van)
                    {
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["SeatCount"]</label>
                            <div class="mr-input-group">
                                <input type="number" class="mr-form-control" @bind="Entity.SeatCount"
                                       min="1" max="50" placeholder="5" />
                                <span class="mr-input-group-text">@Localizer["Seats"]</span>
                            </div>
                        </div>
                    }

                    @* Empty state for types with minimal details *@
                    @if (Entity.VehicleType == VehicleType.JetSki)
                    {
                        <div class="col-12">
                            <div class="mr-info-panel">
                                <div class="mr-info-panel-icon">
                                    <i class="ti ti-info-circle"></i>
                                </div>
                                <div>
                                    <p class="mr-info-panel-text mb-0">@Localizer["JetSkiNoExtraFields"]</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Pricing Card *@
        <div class="mr-form-panel mb-3">
            <div class="mr-form-panel-header">
                <div class="mr-form-panel-header-icon">
                    <i class="ti ti-currency-baht"></i>
                </div>
                <h3 class="mr-form-panel-title">@Localizer["Pricing"]</h3>
            </div>
            <div class="mr-form-panel-body">
                <div class="row g-3">
                    @if (Entity.VehicleType == VehicleType.JetSki)
                    {
                        @* Interval pricing for Jet Ski *@
                        <div class="col-md-4">
                            <label class="mr-form-label">@Localizer["Rate15Min"]</label>
                            <div class="mr-input-group">
                                <span class="mr-input-group-text">฿</span>
                                <input type="number" class="mr-form-control mr-mono" @bind="Entity.Rate15Min"
                                       min="0" step="50" placeholder="500" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="mr-form-label">@Localizer["Rate30Min"]</label>
                            <div class="mr-input-group">
                                <span class="mr-input-group-text">฿</span>
                                <input type="number" class="mr-form-control mr-mono" @bind="Entity.Rate30Min"
                                       min="0" step="50" placeholder="800" />
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="mr-form-label">@Localizer["Rate1Hour"] <span class="required">*</span></label>
                            <div class="mr-input-group">
                                <span class="mr-input-group-text">฿</span>
                                <input type="number" class="mr-form-control mr-mono" @bind="Entity.Rate1Hour" required
                                       min="0" step="100" placeholder="1500" />
                            </div>
                        </div>
                    }
                    else
                    {
                        @* Daily pricing for all other vehicles *@
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["DailyRate"] <span class="required">*</span></label>
                            <div class="mr-input-group">
                                <span class="mr-input-group-text">฿</span>
                                <input type="number" class="mr-form-control mr-mono" @bind="Entity.DailyRate" required
                                       min="0" step="50" placeholder="@GetDailyRatePlaceholder()" />
                                <span class="mr-input-group-text">/ @Localizer["Day"]</span>
                            </div>
                        </div>
                    }

                    <div class="col-md-6">
                        <label class="mr-form-label">@Localizer["DepositAmount"] <span class="required">*</span></label>
                        <div class="mr-input-group">
                            <span class="mr-input-group-text">฿</span>
                            <input type="number" class="mr-form-control mr-mono" @bind="Entity.DepositAmount" required
                                   min="0" step="500" placeholder="@GetDepositPlaceholder()" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Driver/Guide Options - Boats and Vans *@
        @if (Entity.VehicleType == VehicleType.Boat || Entity.VehicleType == VehicleType.Van)
        {
            <div class="mr-form-panel mb-3">
                <div class="mr-form-panel-header">
                    <div class="mr-form-panel-header-icon">
                        <i class="ti ti-user"></i>
                    </div>
                    <h3 class="mr-form-panel-title">@Localizer["DriverGuideOptions"]</h3>
                </div>
                <div class="mr-form-panel-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["DriverDailyFee"]</label>
                            <div class="mr-input-group">
                                <span class="mr-input-group-text">฿</span>
                                <input type="number" class="mr-form-control mr-mono" @bind="Entity.DriverDailyFee"
                                       min="0" step="100" placeholder="1000" />
                                <span class="mr-input-group-text">/ @Localizer["Day"]</span>
                            </div>
                            <div class="mr-form-hint">
                                <i class="ti ti-info-circle"></i>
                                @Localizer["DriverFeeHint"]
                            </div>
                        </div>

                        @if (Entity.VehicleType == VehicleType.Boat)
                        {
                            <div class="col-md-6">
                                <label class="mr-form-label">@Localizer["GuideDailyFee"]</label>
                                <div class="mr-input-group">
                                    <span class="mr-input-group-text">฿</span>
                                    <input type="number" class="mr-form-control mr-mono" @bind="Entity.GuideDailyFee"
                                           min="0" step="100" placeholder="800" />
                                    <span class="mr-input-group-text">/ @Localizer["Day"]</span>
                                </div>
                                <div class="mr-form-hint">
                                    <i class="ti ti-info-circle"></i>
                                    @Localizer["GuideFeeHint"]
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @* Maintenance Tracking - Motorbikes, Cars, Vans *@
        @if (Entity.VehicleType == VehicleType.Motorbike || Entity.VehicleType == VehicleType.Car || Entity.VehicleType == VehicleType.Van)
        {
            <div class="mr-form-panel mb-3">
                <div class="mr-form-panel-header">
                    <div class="mr-form-panel-header-icon">
                        <i class="ti ti-gauge"></i>
                    </div>
                    <h3 class="mr-form-panel-title">@Localizer["MaintenanceTracking"]</h3>
                    @if (!IsNew && Entity.VehicleId > 0)
                    {
                        <div class="ms-auto">
                            <a href="/maintenance/alerts" class="btn btn-ghost-primary btn-sm">
                                <i class="ti ti-settings-cog me-1"></i>
                                @Localizer["MaintenancePage"]
                            </a>
                        </div>
                    }
                </div>
                <div class="mr-form-panel-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["CurrentMileage"]</label>
                            <div class="mr-input-group">
                                <input type="number" class="mr-form-control mr-mono" @bind="Entity.Mileage"
                                       min="0" placeholder="0" />
                                <span class="mr-input-group-text">km</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="mr-form-label">@Localizer["LastServiceDate"]</label>
                            <input type="date" class="mr-form-control" @bind="LastServiceDate" />
                        </div>
                    </div>

                    @* Maintenance Summary Widget - Only for existing vehicles *@
                    @if (!IsNew && Entity.VehicleId > 0)
                    {
                        <div class="mt-3 pt-3 border-top">
                            <h4 class="mb-2 fw-medium">@Localizer["ServiceStatus"]</h4>
                            <VehicleMaintenanceWidget VehicleId="@Entity.VehicleId"
                                                      CurrentMileage="@Entity.Mileage" />
                        </div>
                    }
                </div>
            </div>
        }

        @* Notes Card *@
        <div class="mr-form-panel mb-3">
            <div class="mr-form-panel-header">
                <div class="mr-form-panel-header-icon">
                    <i class="ti ti-notes"></i>
                </div>
                <h3 class="mr-form-panel-title">@Localizer["Notes"]</h3>
            </div>
            <div class="mr-form-panel-body">
                <textarea class="mr-form-control" @bind="Entity.Notes" rows="3"
                          placeholder="@Localizer["NotesPlaceholder"]"></textarea>
            </div>
        </div>
    </div>
</div>

@code {
    /// <summary>
    /// The vehicle entity to edit.
    /// </summary>
    [Parameter]
    public Vehicle Entity { get; set; } = new();

    /// <summary>
    /// Whether this is a new vehicle being created.
    /// </summary>
    [Parameter]
    public bool IsNew { get; set; }

    /// <summary>
    /// Last service date (bound to date input).
    /// </summary>
    [Parameter]
    public DateTime? LastServiceDate { get; set; }

    /// <summary>
    /// Callback when last service date changes.
    /// </summary>
    [Parameter]
    public EventCallback<DateTime?> LastServiceDateChanged { get; set; }

    /// <summary>
    /// Callback when vehicle type is changed.
    /// </summary>
    [Parameter]
    public EventCallback<VehicleType> VehicleTypeChanged { get; set; }

    private async Task OnVehicleTypeChanged(VehicleType type)
    {
        this.Entity.VehicleType = type;

        // Set default duration type based on vehicle type
        this.Entity.DurationType = type == VehicleType.JetSki
            ? RentalDurationType.FixedInterval
            : RentalDurationType.Daily;

        // Clear type-specific fields when changing type
        if (type != VehicleType.Car)
        {
            this.Entity.Segment = null;
            this.Entity.Transmission = null;
            this.Entity.EngineLiters = null;
            this.Entity.SeatCount = null;
        }

        if (type == VehicleType.JetSki)
        {
            this.Entity.DailyRate = 0;
        }
        else
        {
            this.Entity.Rate15Min = null;
            this.Entity.Rate30Min = null;
            this.Entity.Rate1Hour = null;
        }

        if (type != VehicleType.Boat && type != VehicleType.Van)
        {
            this.Entity.DriverDailyFee = null;
            this.Entity.GuideDailyFee = null;
            this.Entity.PassengerCapacity = null;
        }

        await this.VehicleTypeChanged.InvokeAsync(type);
        this.StateHasChanged();
    }

    private void OnPrimaryImageChanged(string? storeId)
    {
        // Could update Entity.ImagePath if you want to store primary image reference
    }

    private void OnImagesChanged()
    {
        // Refresh if needed
    }

    #region Recognition Integration

    private List<string> m_lookupMakes = [];
    private List<VehicleModel> m_lookupModels = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadLookupsAsync();
    }

    private async Task LoadLookupsAsync()
    {
        try
        {
            this.m_lookupMakes = await this.LookupService.GetMakesAsync(this.Entity.VehicleType);
            this.m_lookupModels = await this.LookupService.GetModelsByTypeAsync(this.Entity.VehicleType);
        }
        catch
        {
            // Fall back to defaults if lookup service fails
        }
    }

    private async Task ApplyRecognitionResult(VehicleRecognitionResult result)
    {
        if (result.VehicleType.HasValue)
        {
            await OnVehicleTypeChanged(result.VehicleType.Value);
        }

        if (!string.IsNullOrEmpty(result.RecognizedMake))
        {
            this.Entity.Brand = result.RecognizedMake;
        }

        if (!string.IsNullOrEmpty(result.RecognizedModel))
        {
            this.Entity.Model = result.RecognizedModel;
        }

        if (!string.IsNullOrEmpty(result.Color))
        {
            this.Entity.Color = result.Color;
        }

        if (result.Year.HasValue)
        {
            this.Entity.Year = result.Year.Value;
        }

        if (!string.IsNullOrEmpty(result.LicensePlate))
        {
            this.Entity.LicensePlate = result.LicensePlate;
        }

        if (result.EngineCC.HasValue && this.Entity.VehicleType == VehicleType.Motorbike)
        {
            this.Entity.EngineCC = result.EngineCC.Value;
        }

        if (result.Segment.HasValue && this.Entity.VehicleType == VehicleType.Car)
        {
            this.Entity.Segment = result.Segment.Value;
        }

        // If we have a matched lookup model, apply suggested pricing
        if (result.MatchedVehicleModel != null)
        {
            if (result.MatchedVehicleModel.SuggestedDailyRate.HasValue && this.Entity.DailyRate == 0)
            {
                this.Entity.DailyRate = result.MatchedVehicleModel.SuggestedDailyRate.Value;
            }
            if (result.MatchedVehicleModel.SuggestedDeposit.HasValue && this.Entity.DepositAmount == 0)
            {
                this.Entity.DepositAmount = result.MatchedVehicleModel.SuggestedDeposit.Value;
            }
        }

        this.StateHasChanged();
    }

    #endregion

    #region Helper Methods

    private static string GetVehicleTypeIcon(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "ti-motorbike",
        VehicleType.Car => "ti-car",
        VehicleType.JetSki => "ti-sailboat",
        VehicleType.Boat => "ti-ship",
        VehicleType.Van => "ti-bus",
        _ => "ti-car"
    };

    private string GetVehicleTypeLabel(VehicleType type) => type switch
    {
        VehicleType.Motorbike => Localizer["Motorbike"],
        VehicleType.Car => Localizer["Car"],
        VehicleType.JetSki => Localizer["JetSki"],
        VehicleType.Boat => Localizer["Boat"],
        VehicleType.Van => Localizer["Van"],
        _ => Localizer["Vehicle"]
    };

    private string GetSegmentLabel(CarSegment segment) => segment switch
    {
        CarSegment.SmallSedan => Localizer["SmallSedan"],
        CarSegment.BigSedan => Localizer["BigSedan"],
        CarSegment.SUV => Localizer["SUV"],
        CarSegment.Pickup => Localizer["Pickup"],
        CarSegment.Hatchback => Localizer["Hatchback"],
        CarSegment.Minivan => Localizer["Minivan"],
        CarSegment.Luxury => Localizer["Luxury"],
        _ => segment.ToString()
    };

    private string GetStatusLabel(VehicleStatus status) => status switch
    {
        VehicleStatus.Available => Localizer["Available"],
        VehicleStatus.Rented => Localizer["Rented"],
        VehicleStatus.Maintenance => Localizer["Maintenance"],
        VehicleStatus.Reserved => Localizer["Reserved"],
        VehicleStatus.Retired => Localizer["Retired"],
        _ => status.ToString()
    };

    private List<string> GetBrandSuggestions()
    {
        // Use lookup-based brands if available, fall back to defaults
        if (this.m_lookupMakes.Count > 0)
            return this.m_lookupMakes;

        return Entity.VehicleType switch
        {
            VehicleType.Motorbike => ["Honda", "Yamaha", "Suzuki", "Kawasaki", "Vespa", "GPX"],
            VehicleType.Car => ["Toyota", "Honda", "Mazda", "Nissan", "Mitsubishi", "Isuzu", "Mercedes", "BMW"],
            VehicleType.JetSki => ["Yamaha", "Sea-Doo", "Kawasaki", "Honda"],
            VehicleType.Boat => ["Yamaha", "Bayliner", "Sea Ray", "Boston Whaler"],
            VehicleType.Van => ["Toyota", "Hyundai", "Mercedes", "Ford", "Nissan"],
            _ => []
        };
    }

    private string GetModelPlaceholder() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => "e.g., Click 125, PCX 160",
        VehicleType.Car => "e.g., Camry, Civic, CX-5",
        VehicleType.JetSki => "e.g., VX Cruiser, GTI 130",
        VehicleType.Boat => "e.g., Center Console 24ft",
        VehicleType.Van => "e.g., Hiace, H1, Sprinter",
        _ => "Model name"
    };

    private string GetDailyRatePlaceholder() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => "300",
        VehicleType.Car => "1500",
        VehicleType.Boat => "5000",
        VehicleType.Van => "2500",
        _ => "1000"
    };

    private string GetDepositPlaceholder() => Entity.VehicleType switch
    {
        VehicleType.Motorbike => "2000",
        VehicleType.Car => "10000",
        VehicleType.JetSki => "5000",
        VehicleType.Boat => "20000",
        VehicleType.Van => "10000",
        _ => "5000"
    };

    #endregion
}
