@page "/vehicles/{VehicleId}/edit"

@using MotoRent.Domain.Entities
@using MotoRent.Client.Components.Shared
@inherits LocalizedComponentBase<EditVehicle>
@inject VehicleService VehicleService

<MotoRentPageTitle>@Localizer["EditVehicle"] - @m_vehicle.LicensePlate</MotoRentPageTitle>

<div class="container-xl">
    @* Page Header *@
    <div class="page-header d-print-none mb-4">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="/vehicles" class="btn btn-ghost-secondary btn-icon">
                    <i class="ti ti-arrow-left"></i>
                </a>
            </div>
            <div class="col">
                <h2 class="page-title">@Localizer["EditVehicle"]</h2>
                <p class="text-secondary mb-0">
                    <i class="ti @GetVehicleTypeIcon(m_vehicle.VehicleType) me-1"></i>
                    @m_vehicle.Brand @m_vehicle.Model (@m_vehicle.LicensePlate)
                </p>
            </div>
            <div class="col-auto">
                <span class="badge @GetStatusBadgeClass(m_vehicle.Status) fs-6">
                    <i class="ti @GetStatusIcon(m_vehicle.Status) me-1"></i>
                    @m_vehicle.Status
                </span>
            </div>
        </div>
    </div>

    @if (m_loading)
    {
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p class="text-center text-secondary">@Localizer["LoadingVehicle"]...</p>
            </div>
        </div>
    }
    else if (m_vehicle.VehicleId == 0)
    {
        <div class="card">
            <div class="card-body">
                <div class="empty py-5">
                    <div class="empty-icon">
                        <i class="ti ti-alert-circle" style="font-size: 3rem;"></i>
                    </div>
                    <p class="empty-title">@Localizer["VehicleNotFound"]</p>
                    <p class="empty-subtitle text-secondary">
                        @Localizer["VehicleNotFoundDescription"]
                    </p>
                    <div class="empty-action">
                        <a href="/vehicles" class="btn btn-primary">
                            <i class="ti ti-arrow-left me-1"></i>@Localizer["BackToFleet"]
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <form id="edit-vehicle-form" @onsubmit="SaveAsync" @onsubmit:preventDefault>
            <VehicleForm Entity="@m_vehicle"
                         IsNew="false"
                         LastServiceDate="@m_lastServiceDate"
                         LastServiceDateChanged="@((d) => m_lastServiceDate = d)" />

            @* Action Buttons *@
            <div class="card">
                <div class="card-footer d-flex justify-content-between">
                    <a href="/vehicles" class="btn btn-ghost-secondary">
                        <i class="ti ti-arrow-left me-1"></i>@Localizer["Cancel"]
                    </a>
                    <button type="submit" class="btn btn-primary" disabled="@m_saving">
                        @if (m_saving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>@Localizer["Saving"]...</span>
                        }
                        else
                        {
                            <i class="ti ti-device-floppy me-1"></i>
                            <span>@Localizer["SaveChanges"]</span>
                        }
                    </button>
                </div>
            </div>
        </form>
    }
</div>

@code {
    [Parameter]
    public string VehicleId { get; set; } = "";

    private int m_vehicleId;
    private Vehicle m_vehicle = new();
    private DateTime? m_lastServiceDate;
    private bool m_loading = true;
    private bool m_saving;

    protected override async Task OnParametersSetAsync()
    {
        m_vehicleId = DecodeId(VehicleId);
        await LoadVehicleAsync();
    }

    private async Task LoadVehicleAsync()
    {
        this.m_loading = true;
        try
        {
            var vehicle = await this.VehicleService.GetVehicleByIdAsync(m_vehicleId);
            if (vehicle != null)
            {
                // Clone to prevent direct modification
                this.m_vehicle = vehicle.Clone();
                this.m_lastServiceDate = this.m_vehicle.LastServiceDate?.DateTime;
            }
            else
            {
                this.m_vehicle = new Vehicle();
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading vehicle: {ex.Message}");
            this.m_vehicle = new Vehicle();
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task SaveAsync()
    {
        this.m_saving = true;
        try
        {
            // Set last service date if provided
            this.m_vehicle.LastServiceDate = this.m_lastServiceDate.HasValue
                ? new DateTimeOffset(this.m_lastServiceDate.Value)
                : null;

            var result = await this.VehicleService.UpdateVehicleAsync(this.m_vehicle, this.UserName);

            if (result.Success)
            {
                this.ShowSuccess(Localizer["VehicleUpdatedSuccess"]);
            }
            else
            {
                this.ShowError(result.Message ?? Localizer["SaveFailed"]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"{Localizer["Error"]}: {ex.Message}");
        }
        finally
        {
            this.m_saving = false;
        }
    }

    private static string GetVehicleTypeIcon(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "ti-motorbike",
        VehicleType.Car => "ti-car",
        VehicleType.JetSki => "ti-sailboat",
        VehicleType.Boat => "ti-ship",
        VehicleType.Van => "ti-bus",
        _ => "ti-car"
    };

    private static string GetStatusBadgeClass(VehicleStatus status) => status switch
    {
        VehicleStatus.Available => "bg-success-lt text-success",
        VehicleStatus.Rented => "bg-primary-lt text-primary",
        VehicleStatus.Maintenance => "bg-warning-lt text-warning",
        VehicleStatus.Reserved => "bg-info-lt text-info",
        VehicleStatus.Retired => "bg-danger-lt text-danger",
        _ => "bg-secondary-lt text-secondary"
    };

    private static string GetStatusIcon(VehicleStatus status) => status switch
    {
        VehicleStatus.Available => "ti-circle-check",
        VehicleStatus.Rented => "ti-steering-wheel",
        VehicleStatus.Maintenance => "ti-tool",
        VehicleStatus.Reserved => "ti-clock",
        VehicleStatus.Retired => "ti-archive",
        _ => "ti-circle"
    };
}
