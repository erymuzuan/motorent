@using MotoRent.Domain.Core
@using MotoRent.Domain.DataContext
@inherits LocalizedDialogBase<User, ShopUserDialog>
@inject CoreDataContext CoreContext
@inject ISubscriptionService SubscriptionService
@inject IDirectoryService DirectoryService

<div class="modal-body">
    @if (this.IsNew)
    {
        <!-- Create New User -->
        <div class="mb-3">
            <label class="form-label required">@Localizer["Provider"]</label>
            <select class="form-select" @bind="this.m_provider">
                <option value="@User.GOOGLE">Google</option>
                <option value="@User.MICROSOFT">Microsoft</option>
                <option value="@User.LINE">LINE</option>
            </select>
            <small class="form-hint">
                <i class="ti ti-info-circle me-1"></i>
                @Localizer["ProviderHint"]
            </small>
        </div>

        <div class="mb-3">
            <label class="form-label required">@Localizer["Username"]</label>
            <input type="email" class="form-control @(this.m_emailError != null ? "is-invalid" : "")"
                   placeholder="@Localizer["UsernamePlaceholder"]"
                   @bind="this.m_newUserEmail" @bind:event="oninput" />
            @if (this.m_emailError != null)
            {
                <div class="invalid-feedback">@this.m_emailError</div>
            }
        </div>

        <div class="mb-3">
            <label class="form-label required">@Localizer["FullName"]</label>
            <input type="text" class="form-control @(this.m_nameError != null ? "is-invalid" : "")"
                   placeholder="@Localizer["FullNamePlaceholder"]"
                   @bind="this.m_newUserFullName" @bind:event="oninput" />
            @if (this.m_nameError != null)
            {
                <div class="invalid-feedback">@this.m_nameError</div>
            }
        </div>
    }
    else
    {
        <!-- Edit mode - show user info -->
        <div class="d-flex align-items-center mb-3 p-3 bg-light rounded">
            <span class="avatar avatar-md me-3 bg-primary-lt">
                @(this.Entity.FullName?.FirstOrDefault().ToString().ToUpperInvariant() ?? "U")
            </span>
            <div>
                <div class="fw-bold">@this.Entity.FullName</div>
                <div class="text-secondary">@this.Entity.Email</div>
            </div>
        </div>
    }

    <!-- Role Selection (common for both tabs) -->
    <div class="mb-3">
        <label class="form-label">@Localizer["SelectRoles"]</label>
        <div class="space-y-2">
            @foreach (var role in UserAccount.AllRoles)
            {
                <label class="form-check">
                    <input type="checkbox" class="form-check-input"
                           checked="@this.m_selectedRoles.Contains(role)"
                           @onchange="@(e => this.ToggleRole(role, (bool)(e.Value ?? false)))" />
                    <span class="form-check-label">
                        <span class="badge @GetRoleBadgeClass(role) me-2">@this.GetRoleDisplayName(role)</span>
                        <span class="text-secondary">@this.GetRoleDescription(role)</span>
                    </span>
                </label>
            }
        </div>
        @if (this.m_roleError != null)
        {
            <div class="text-danger small mt-2">
                <i class="ti ti-alert-circle me-1"></i>
                @this.m_roleError
            </div>
        }
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @CommonLocalizer["Cancel"]
    </button>
    <button type="button" class="btn btn-primary" @onclick="this.SaveAsync" disabled="@this.Saving">
        @if (this.Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-check me-1"></i>
        @this.SaveButtonText
    </button>
</div>

@code {
    [Parameter] public new string AccountNo { get; set; } = "";

    private string? m_newUserEmail;
    private string? m_newUserFullName;
    private string m_provider = User.GOOGLE;
    private string? m_emailError;
    private string? m_nameError;
    private string? m_roleError;
    private HashSet<string> m_selectedRoles = [];

    protected override Task OnInitializedAsync()
    {
        if (!this.IsNew)
        {
            // Edit mode - load existing roles
            var account = this.Entity.AccountCollection.FirstOrDefault(a => a.AccountNo == this.AccountNo);
            if (account != null)
            {
                this.m_selectedRoles = account.Roles.ToHashSet();
            }
        }
        return Task.CompletedTask;
    }

    private void ToggleRole(string role, bool selected)
    {
        if (selected)
        {
            this.m_selectedRoles.Add(role);
        }
        else
        {
            // Prevent current user from removing their own OrgAdmin role
            if (role == UserAccount.ORG_ADMIN && !this.IsNew && this.Entity.UserName == this.UserName)
            {
                this.ShowWarning(Localizer["CannotRemoveOwnOrgAdmin"]);
                return;
            }
            this.m_selectedRoles.Remove(role);
        }
        this.m_roleError = null;
    }

    private async Task SaveAsync()
    {
        // Validate role selection
        if (this.m_selectedRoles.Count == 0)
        {
            this.m_roleError = Localizer["AtLeastOneRole"];
            return;
        }

        if (this.IsNew)
        {
            await this.SaveNewAsync();
        }
        else
        {
            await this.SaveEditAsync();
        }
    }

    private async Task SaveNewAsync()
    {
        this.m_emailError = null;
        this.m_nameError = null;

        if (string.IsNullOrWhiteSpace(this.m_newUserEmail))
        {
            this.m_emailError = Localizer["UsernameRequired"];
            return;
        }

        if (!IsValidEmail(this.m_newUserEmail))
        {
            this.m_emailError = Localizer["InvalidEmail"];
            return;
        }

        if (string.IsNullOrWhiteSpace(this.m_newUserFullName))
        {
            this.m_nameError = Localizer["FullNameRequired"];
            return;
        }

        // Check if user already exists
        var normalizedEmail = this.m_newUserEmail.ToLowerInvariant().Trim();
        var existingUser = await this.CoreContext.LoadOneAsync<User>(u => u.UserName == normalizedEmail);

        if (existingUser != null)
        {
            // User exists - check if already in org
            if (existingUser.AccountCollection.Any(a => a.AccountNo == this.AccountNo))
            {
                this.m_emailError = Localizer["UserAlreadyInOrg"];
                return;
            }

            // User exists but not in this org - OrgAdmin cannot add users from other orgs
            this.m_emailError = Localizer["UserExistsContactAdmin"];
            return;
        }

        // Create brand new user
        this.Saving = true;
        try
        {
            var newUser = new User
            {
                UserName = normalizedEmail,
                Email = normalizedEmail,
                FullName = this.m_newUserFullName.Trim(),
                CredentialProvider = this.m_provider
            };

            var userAccount = new UserAccount
            {
                AccountNo = this.AccountNo,
                IsFavourite = true
            };
            userAccount.Roles.AddRange(this.m_selectedRoles);
            newUser.AccountCollection.Add(userAccount);

            await this.DirectoryService.SaveUserProfileAsync(newUser);
            this.ShowSuccess(Localizer["UserCreated", newUser.FullName]);
            this.Close();
        }
        catch (Exception ex)
        {
            this.ShowError($"Error creating user: {ex.Message}");
        }
        finally
        {
            this.Saving = false;
        }
    }

    private async Task SaveEditAsync()
    {
        this.Saving = true;
        try
        {
            // Update user's roles in this organization
            var account = this.Entity.AccountCollection.FirstOrDefault(a => a.AccountNo == this.AccountNo);
            if (account != null)
            {
                account.Roles.Clear();
                account.Roles.AddRange(this.m_selectedRoles);
                await this.DirectoryService.SaveUserProfileAsync(this.Entity);
                this.ShowSuccess(Localizer["RolesUpdated", this.Entity.FullName ?? this.Entity.UserName]);
                this.Close();
            }
            else
            {
                this.ShowError("User account not found");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error updating roles: {ex.Message}");
        }
        finally
        {
            this.Saving = false;
        }
    }

    private static bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email.Trim();
        }
        catch
        {
            return false;
        }
    }

    private string GetRoleDisplayName(string role) => role switch
    {
        UserAccount.ORG_ADMIN => Localizer["RoleOrgAdmin"],
        UserAccount.SHOP_MANAGER => Localizer["RoleShopManager"],
        UserAccount.STAFF => Localizer["RoleStaff"],
        UserAccount.MECHANIC => Localizer["RoleMechanic"],
        _ => role
    };

    private string GetRoleDescription(string role) => role switch
    {
        UserAccount.ORG_ADMIN => Localizer["RoleOrgAdminDesc"],
        UserAccount.SHOP_MANAGER => Localizer["RoleShopManagerDesc"],
        UserAccount.STAFF => Localizer["RoleStaffDesc"],
        UserAccount.MECHANIC => Localizer["RoleMechanicDesc"],
        _ => ""
    };

    private static string GetRoleBadgeClass(string role) => role switch
    {
        UserAccount.ORG_ADMIN => "bg-primary",
        UserAccount.SHOP_MANAGER => "bg-purple",
        UserAccount.STAFF => "bg-info",
        UserAccount.MECHANIC => "bg-warning",
        _ => "bg-secondary"
    };
}
