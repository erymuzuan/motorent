@page "/settings/organization"
@page "/settings/organization/{Panel}"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Core
@using MotoRent.Domain.Settings
@using MotoRent.Domain.Storage
@attribute [Authorize(Roles = "OrgAdmin")]
@inherits LocalizedComponentBase<OrganizationSettings>
@inject OrganizationService OrganizationService
@inject IBinaryStore BinaryStore

<MotoRentPageTitle>@Localizer["OrganizationSettings"]</MotoRentPageTitle>

<TablerHeader Title="@Localizer["OrganizationSettings"]" PreTitle="@Localizer["ManageYourOrganization"]">
    <button type="button" class="btn btn-primary" @onclick="SaveAsync" disabled="@m_saving">
        @if (m_saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-device-floppy me-1"></i>
        @CommonLocalizer["Save"]
    </button>
</TablerHeader>

<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Card">
    @if (m_organization != null)
    {
        <div class="row">
            @* Panel Navigation *@
            <div class="col-lg-3 col-md-4">
                <div class="card sticky-top" style="top: 80px;">
                    <div class="list-group list-group-flush">
                        <a href="/settings/organization/profile"
                           class="list-group-item list-group-item-action @(CurrentPanel == "profile" ? "active" : "")">
                            <i class="ti ti-building me-2"></i>@Localizer["Profile"]
                        </a>
                        <a href="/settings/organization/address"
                           class="list-group-item list-group-item-action @(CurrentPanel == "address" ? "active" : "")">
                            <i class="ti ti-map-pin me-2"></i>@Localizer["Address"]
                        </a>
                        <a href="/settings/organization/workflow"
                           class="list-group-item list-group-item-action @(CurrentPanel == "workflow" ? "active" : "")">
                            <i class="ti ti-settings me-2"></i>@Localizer["RentalWorkflow"]
                        </a>
                        <a href="/settings/organization/notifications"
                           class="list-group-item list-group-item-action @(CurrentPanel == "notifications" ? "active" : "")">
                            <i class="ti ti-bell me-2"></i>@Localizer["Notifications"]
                        </a>
                        <a href="/settings/organization/payments"
                           class="list-group-item list-group-item-action @(CurrentPanel == "payments" ? "active" : "")">
                            <i class="ti ti-credit-card me-2"></i>@Localizer["Payments"]
                        </a>
                    </div>
                </div>
            </div>

            @* Panel Content *@
            <div class="col-lg-9 col-md-8">
                @switch (CurrentPanel)
                {
                    case "profile":
                        @ProfilePanel()
                        break;
                    case "address":
                        @AddressPanel()
                        break;
                    case "workflow":
                        @WorkflowPanel()
                        break;
                    case "notifications":
                        @NotificationsPanel()
                        break;
                    case "payments":
                        @PaymentsPanel()
                        break;
                }
            </div>
        </div>
    }
</LoadingSkeleton>

@code {
    [Parameter]
    public string? Panel { get; set; }

    private string CurrentPanel => string.IsNullOrWhiteSpace(Panel) ? "profile" : Panel.ToLowerInvariant();

    private Organization? m_organization;
    private bool m_loading = true;
    private bool m_saving;

    // Settings values
    private bool m_requirePreInspection;
    private bool m_requireDamagePhotos;
    private bool m_requireDeposit;
    private int m_defaultRentalPeriod = 3;
    private bool m_allowOnlineReservation = true;
    private bool m_requireIdVerification = true;

    private bool m_sendRentalConfirmation = true;
    private bool m_sendPaymentReceipt = true;
    private int m_reminderDaysBeforeReturn = 1;
    private bool m_sendLateReturnAlert = true;

    private string m_defaultPaymentMethod = "Cash";
    private string m_acceptedMethods = "Cash,Card,PromptPay,BankTransfer";
    private string? m_promptPayId;
    private string? m_bankName;
    private string? m_bankAccountNo;
    private string? m_bankAccountName;
    private decimal m_defaultDepositAmount = 3000;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        m_loading = true;
        try
        {
            m_organization = await OrganizationService.GetOrganizationByAccountNoAsync(AccountNo);

            if (m_organization != null)
            {
                // Load settings
                await LoadSettingsAsync();
            }
        }
        catch (Exception ex)
        {
            ShowError($"Error loading organization: {ex.Message}");
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task LoadSettingsAsync()
    {
        // Workflow settings
        m_requirePreInspection = await SettingConfig.GetBoolAsync(SettingKeys.Rental_RequirePreInspection, defaultValue: false);
        m_requireDamagePhotos = await SettingConfig.GetBoolAsync(SettingKeys.Rental_RequireDamagePhotos, defaultValue: false);
        m_requireDeposit = await SettingConfig.GetBoolAsync(SettingKeys.Rental_RequireDeposit, defaultValue: true);
        m_defaultRentalPeriod = await SettingConfig.GetIntAsync(SettingKeys.Rental_DefaultRentalPeriod, defaultValue: 3);
        m_allowOnlineReservation = await SettingConfig.GetBoolAsync(SettingKeys.Rental_AllowOnlineReservation, defaultValue: true);
        m_requireIdVerification = await SettingConfig.GetBoolAsync(SettingKeys.Rental_RequireIdVerification, defaultValue: true);

        // Notification settings
        m_sendRentalConfirmation = await SettingConfig.GetBoolAsync(SettingKeys.Notification_SendRentalConfirmation, defaultValue: true);
        m_sendPaymentReceipt = await SettingConfig.GetBoolAsync(SettingKeys.Notification_SendPaymentReceipt, defaultValue: true);
        m_reminderDaysBeforeReturn = await SettingConfig.GetIntAsync(SettingKeys.Notification_ReminderDaysBeforeReturn, defaultValue: 1);
        m_sendLateReturnAlert = await SettingConfig.GetBoolAsync(SettingKeys.Notification_SendLateReturnAlert, defaultValue: true);

        // Payment settings
        m_defaultPaymentMethod = await SettingConfig.GetStringAsync(SettingKeys.Payment_DefaultMethod, defaultValue: "Cash") ?? "Cash";
        m_acceptedMethods = string.Join(",", await SettingConfig.GetArrayAsync(SettingKeys.Payment_AcceptedMethods));
        if (string.IsNullOrWhiteSpace(m_acceptedMethods))
            m_acceptedMethods = "Cash,Card,PromptPay,BankTransfer";
        m_promptPayId = await SettingConfig.GetStringAsync(SettingKeys.Payment_PromptPayId);
        m_bankName = await SettingConfig.GetStringAsync(SettingKeys.Payment_BankName);
        m_bankAccountNo = await SettingConfig.GetStringAsync(SettingKeys.Payment_BankAccountNo);
        m_bankAccountName = await SettingConfig.GetStringAsync(SettingKeys.Payment_BankAccountName);
        m_defaultDepositAmount = await SettingConfig.GetDecimalAsync(SettingKeys.Deposit_DefaultAmount, defaultValue: 3000);
    }

    private async Task SaveAsync()
    {
        if (m_organization == null) return;

        m_saving = true;
        try
        {
            // Save organization profile
            var result = await OrganizationService.UpdateOrganizationAsync(m_organization, UserName);

            if (!result.Success)
            {
                ShowError(result.Message ?? "Failed to save organization");
                return;
            }

            // Save settings based on current panel
            await SaveSettingsAsync();

            ShowSuccess(Localizer["SettingsSaved"]);
        }
        catch (Exception ex)
        {
            ShowError($"Error saving: {ex.Message}");
        }
        finally
        {
            m_saving = false;
        }
    }

    private async Task SaveSettingsAsync()
    {
        // Workflow settings
        await SettingConfig.SetValueAsync(SettingKeys.Rental_RequirePreInspection, m_requirePreInspection);
        await SettingConfig.SetValueAsync(SettingKeys.Rental_RequireDamagePhotos, m_requireDamagePhotos);
        await SettingConfig.SetValueAsync(SettingKeys.Rental_RequireDeposit, m_requireDeposit);
        await SettingConfig.SetValueAsync(SettingKeys.Rental_DefaultRentalPeriod, m_defaultRentalPeriod);
        await SettingConfig.SetValueAsync(SettingKeys.Rental_AllowOnlineReservation, m_allowOnlineReservation);
        await SettingConfig.SetValueAsync(SettingKeys.Rental_RequireIdVerification, m_requireIdVerification);

        // Notification settings
        await SettingConfig.SetValueAsync(SettingKeys.Notification_SendRentalConfirmation, m_sendRentalConfirmation);
        await SettingConfig.SetValueAsync(SettingKeys.Notification_SendPaymentReceipt, m_sendPaymentReceipt);
        await SettingConfig.SetValueAsync(SettingKeys.Notification_ReminderDaysBeforeReturn, m_reminderDaysBeforeReturn);
        await SettingConfig.SetValueAsync(SettingKeys.Notification_SendLateReturnAlert, m_sendLateReturnAlert);

        // Payment settings
        await SettingConfig.SetValueAsync(SettingKeys.Payment_DefaultMethod, m_defaultPaymentMethod);
        await SettingConfig.SetValueAsync(SettingKeys.Payment_AcceptedMethods, m_acceptedMethods.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries));
        await SettingConfig.SetValueAsync(SettingKeys.Payment_PromptPayId, m_promptPayId ?? "");
        await SettingConfig.SetValueAsync(SettingKeys.Payment_BankName, m_bankName ?? "");
        await SettingConfig.SetValueAsync(SettingKeys.Payment_BankAccountNo, m_bankAccountNo ?? "");
        await SettingConfig.SetValueAsync(SettingKeys.Payment_BankAccountName, m_bankAccountName ?? "");
        await SettingConfig.SetValueAsync(SettingKeys.Deposit_DefaultAmount, m_defaultDepositAmount);
    }

    #region Panel Render Fragments

    private RenderFragment ProfilePanel() => __builder =>
    {
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-building me-2"></i>@Localizer["OrganizationProfile"]
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label required">@Localizer["OrganizationName"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.Name" maxlength="100" />
                        <small class="text-secondary">@Localizer["DisplayedInHeader"]</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">@Localizer["Logo"]</label>
                        @if (!string.IsNullOrWhiteSpace(m_organization!.LogoStoreId))
                        {
                            <div class="mb-2">
                                <img src="@BinaryStore.GetImageUrl(m_organization.LogoStoreId)" alt="Logo" class="img-thumbnail" style="max-height: 80px;" />
                            </div>
                        }
                        <small class="text-secondary">@Localizer["UploadInBrandingSettings"]</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Phone"]</label>
                        <input type="tel" class="form-control" @bind="m_organization!.Phone" placeholder="+66-xxx-xxx-xxxx" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Email"]</label>
                        <input type="email" class="form-control" @bind="m_organization!.Email" placeholder="contact@example.com" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Website"]</label>
                        <input type="url" class="form-control" @bind="m_organization!.WebSite" placeholder="https://example.com" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["TaxId"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.TaxNo" placeholder="Tax ID / VAT Number" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["CompanyRegistrationNo"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.CompanyNo" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["DefaultCurrency"]</label>
                        <select class="form-select" @bind="m_organization!.Currency">
                            <option value="THB">THB - Thai Baht</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="MYR">MYR - Malaysian Ringgit</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Timezone"]</label>
                        <select class="form-select" @bind="m_organization!.Timezone">
                            <option value="7">UTC+7 (Thailand)</option>
                            <option value="8">UTC+8 (Malaysia/Singapore)</option>
                            <option value="0">UTC+0 (GMT)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Language"]</label>
                        <select class="form-select" @bind="m_organization!.Language">
                            <option value="th-TH">Thai</option>
                            <option value="en-US">English</option>
                            <option value="ms-MY">Bahasa Melayu</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment AddressPanel() => __builder =>
    {
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-map-pin me-2"></i>@Localizer["HeadquartersAddress"]
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">@Localizer["Street"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.Address.Street" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["City"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.Address.City" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Province"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.Address.Province" placeholder="e.g. Phuket, Krabi" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["PostalCode"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.Address.PostalCode" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Country"]</label>
                        <input type="text" class="form-control" @bind="m_organization!.Address.Country" />
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment WorkflowPanel() => __builder =>
    {
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-settings me-2"></i>@Localizer["RentalWorkflowSettings"]
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-12">
                        <h4 class="mb-3">@Localizer["CheckInProcess"]</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_requirePreInspection" id="preInspection" />
                                    <label class="form-check-label" for="preInspection">
                                        @Localizer["RequirePreInspection"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["RequirePreInspectionDescription"]</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_requireDamagePhotos" id="damagePhotos" />
                                    <label class="form-check-label" for="damagePhotos">
                                        @Localizer["RequireDamagePhotos"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["RequireDamagePhotosDescription"]</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_requireDeposit" id="deposit" />
                                    <label class="form-check-label" for="deposit">
                                        @Localizer["RequireDeposit"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["RequireDepositDescription"]</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_requireIdVerification" id="idVerification" />
                                    <label class="form-check-label" for="idVerification">
                                        @Localizer["RequireIdVerification"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["RequireIdVerificationDescription"]</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr />
                        <h4 class="mb-3">@Localizer["DefaultValues"]</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["DefaultRentalPeriod"]</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" @bind="m_defaultRentalPeriod" min="1" max="30" />
                                    <span class="input-group-text">@Localizer["Days"]</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["DefaultDepositAmount"]</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" @bind="m_defaultDepositAmount" min="0" step="500" />
                                    <span class="input-group-text">@m_organization!.Currency</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr />
                        <h4 class="mb-3">@Localizer["OnlinePortal"]</h4>
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" @bind="m_allowOnlineReservation" id="onlineReservation" />
                            <label class="form-check-label" for="onlineReservation">
                                @Localizer["AllowOnlineReservation"]
                            </label>
                        </div>
                        <small class="text-secondary">@Localizer["AllowOnlineReservationDescription"]</small>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment NotificationsPanel() => __builder =>
    {
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-bell me-2"></i>@Localizer["NotificationSettings"]
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-12">
                        <h4 class="mb-3">@Localizer["EmailNotifications"]</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_sendRentalConfirmation" id="rentalConfirmation" />
                                    <label class="form-check-label" for="rentalConfirmation">
                                        @Localizer["SendRentalConfirmation"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["SendRentalConfirmationDescription"]</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_sendPaymentReceipt" id="paymentReceipt" />
                                    <label class="form-check-label" for="paymentReceipt">
                                        @Localizer["SendPaymentReceipt"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["SendPaymentReceiptDescription"]</small>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" @bind="m_sendLateReturnAlert" id="lateReturnAlert" />
                                    <label class="form-check-label" for="lateReturnAlert">
                                        @Localizer["SendLateReturnAlert"]
                                    </label>
                                </div>
                                <small class="text-secondary">@Localizer["SendLateReturnAlertDescription"]</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr />
                        <h4 class="mb-3">@Localizer["Reminders"]</h4>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["ReminderDaysBeforeReturn"]</label>
                            <div class="input-group">
                                <input type="number" class="form-control" @bind="m_reminderDaysBeforeReturn" min="0" max="7" />
                                <span class="input-group-text">@Localizer["DaysBeforeReturn"]</span>
                            </div>
                            <small class="text-secondary">@Localizer["ReminderDaysDescription"]</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment PaymentsPanel() => __builder =>
    {
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-credit-card me-2"></i>@Localizer["PaymentSettings"]
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-12">
                        <h4 class="mb-3">@Localizer["PaymentMethods"]</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["DefaultPaymentMethod"]</label>
                                <select class="form-select" @bind="m_defaultPaymentMethod">
                                    <option value="Cash">@Localizer["Cash"]</option>
                                    <option value="Card">@Localizer["CreditDebitCard"]</option>
                                    <option value="PromptPay">PromptPay</option>
                                    <option value="BankTransfer">@Localizer["BankTransfer"]</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["AcceptedPaymentMethods"]</label>
                                <div>
                                    @foreach (var method in new[] { "Cash", "Card", "PromptPay", "BankTransfer" })
                                    {
                                        <div class="form-check form-check-inline">
                                            <input type="checkbox" class="form-check-input"
                                                   id="@($"method_{method}")"
                                                   checked="@m_acceptedMethods.Contains(method)"
                                                   @onchange="@(e => TogglePaymentMethod(method, (bool)e.Value!))" />
                                            <label class="form-check-label" for="@($"method_{method}")">@GetMethodDisplayName(method)</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr />
                        <h4 class="mb-3">PromptPay</h4>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["PromptPayId"]</label>
                            <input type="text" class="form-control" @bind="m_promptPayId" placeholder="Phone number or Citizen ID" />
                            <small class="text-secondary">@Localizer["PromptPayIdDescription"]</small>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr />
                        <h4 class="mb-3">@Localizer["BankTransfer"]</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["BankName"]</label>
                                <input type="text" class="form-control" @bind="m_bankName" placeholder="e.g. Bangkok Bank, SCB" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["BankAccountNo"]</label>
                                <input type="text" class="form-control" @bind="m_bankAccountNo" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer["BankAccountName"]</label>
                                <input type="text" class="form-control" @bind="m_bankAccountName" placeholder="Account holder name" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    #endregion

    #region Helper Methods

    private void TogglePaymentMethod(string method, bool enabled)
    {
        var methods = m_acceptedMethods.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();

        if (enabled && !methods.Contains(method))
        {
            methods.Add(method);
        }
        else if (!enabled && methods.Contains(method))
        {
            methods.Remove(method);
        }

        m_acceptedMethods = string.Join(",", methods);
    }

    private string GetMethodDisplayName(string method) => method switch
    {
        "Cash" => Localizer["Cash"],
        "Card" => Localizer["CreditDebitCard"],
        "PromptPay" => "PromptPay",
        "BankTransfer" => Localizer["BankTransfer"],
        _ => method
    };

    #endregion
}
