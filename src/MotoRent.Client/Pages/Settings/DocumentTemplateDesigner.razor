@page "/settings/templates/designer"
@page "/settings/templates/designer/{TemplateId:int}"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Core
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Models
@using MotoRent.Services
@using MotoRent.Services.Core
@using MotoRent.Client.Components.Templates
@using MotoRent.Client.Services
@implements IDisposable
@attribute [Authorize(Policy = "RequireTenantOrgAdmin")]
@inherits LocalizedComponentBase<DocumentTemplateDesigner>
@inject DocumentTemplateService TemplateService
@inject DocumentTemplateAiService AiService
@inject DesignerState DesignerState
@inject ITemplateDataResolver DataResolver
@inject IHtmlTemplateRenderer HtmlRenderer
@inject OrganizationService OrganizationService

<MotoRentPageTitle>@this.Localizer["PageTitle"]</MotoRentPageTitle>

<TablerHeader Title="@this.Localizer["Header"]"
              PreTitle="@(this.m_template.DocumentTemplateId == 0 ? this.Localizer["CreateNewTemplate"] : this.Localizer["EditTemplate"])">
    <div class="btn-list">
        <button type="button" class="btn btn-outline-secondary"
                @onclick="() => this.m_showAiSidebar = !this.m_showAiSidebar">
            <i class="ti ti-sparkles me-1 text-accent"></i>
            @this.Localizer["AiSuggester"]
        </button>
        <button type="button" class="btn btn-outline-primary" @onclick="this.TogglePreview">
            <i class="ti ti-eye me-1"></i>
            @this.Localizer["Preview"]
        </button>
        <button type="button" class="btn btn-primary" @onclick="this.SaveTemplateAsync" disabled="@this.m_saving">
            @if (this.m_saving)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            else
            {
                <i class="ti ti-device-floppy me-1"></i>
            }
            @this.Localizer["SaveTemplate"]
        </button>
    </div>
</TablerHeader>

<div class="container-fluid mt-4">
    <LoadingSkeleton Loading="@this.m_loading" Mode="LoadingSkeleton.PlaceholderMode.Card">
        <div class="row g-4">
            @* Left Sidebar - Template Info & Block Library *@
            <div class="col-lg-2">
                <div class="card mb-3">
                    <div class="card-header">
                        <h3 class="card-title">@this.Localizer["TemplateInfo"]</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">@this.Localizer["Name"]</label>
                            <input type="text" class="form-control" @bind="this.m_template.Name"
                                   placeholder="@this.Localizer["NamePlaceholder"]"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">@this.Localizer["DocumentType"]</label>
                            <select class="form-select" @bind="this.m_template.Type">
                                @foreach (DocumentType type in Enum.GetValues(typeof(DocumentType)))
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">@this.Localizer["BlockLibrary"]</h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("heading")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "heading"'>
                                <i class="ti ti-heading me-2"></i> @this.Localizer["Heading"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("text")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "text"'>
                                <i class="ti ti-type me-2"></i> @this.Localizer["TextBlock"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("table")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "table"'>
                                <i class="ti ti-table me-2"></i> @this.Localizer["DataTable"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("image")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "image"'>
                                <i class="ti ti-photo me-2"></i> @this.Localizer["ImageLogo"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("divider")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "divider"'>
                                <i class="ti ti-minus me-2"></i> @this.Localizer["DividerLine"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("signature")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "signature"'>
                                <i class="ti ti-pencil me-2"></i> @this.Localizer["Signature"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("two-columns")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "two-columns"'>
                                <i class="ti ti-columns me-2"></i> @this.Localizer["TwoColumns"]
                            </button>
                            <button class="list-group-item list-group-item-action"
                                    @onclick='() => this.AddBlock("spacer")' draggable="true"
                                    @ondragstart='() => this.DesignerState.DraggingBlockType = "spacer"'>
                                <i class="ti ti-separator-horizontal me-2"></i> @this.Localizer["Spacer"]
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @* Main Canvas Editor *@
            <div class="col-lg-7">
                <DocumentCanvas Layout="this.m_layout"
                                SelectedBlock="this.DesignerState.SelectedBlock"
                                OnBlockSelected="b => this.DesignerState.SetSelectedBlock(b)"
                                OnBlockAdded="this.AddBlock"/>
            </div>

            @* Right Sidebar - Properties & AI *@
            <div class="col-lg-3">
                <BlockPropertyEditor Block="this.DesignerState.SelectedBlock"
                                     OnDeleteRequested="this.DeleteSelectedBlock"/>

                                @if (this.m_showAiSidebar)

                                {

                                    <div class="card mt-3">

                                        <div class="card-header bg-primary-lt">

                                            <h3 class="card-title">

                                                <i class="ti ti-sparkles me-2"></i>

                                                @this.Localizer["AiSuggester"]

                                            </h3>

                                        </div>

                                        <div class="card-body">

                                            <div class="mb-3">

                                                <label class="form-label">@this.Localizer["AiContextLabel"]</label>

                                                <textarea class="form-control" @bind="this.m_aiContext" rows="3"

                                                          placeholder="@this.Localizer["AiContextPlaceholder"]"></textarea>

                                            </div>

                                            <button class="btn btn-primary w-100 mb-3" @onclick="this.GetAiSuggestions"

                                                    disabled="@this.m_loadingAi">

                                                @if (this.m_loadingAi)

                                                {

                                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>

                                                }

                                                @this.Localizer["SuggestClauses"]

                                            </button>

                

                                            <div class="list-group list-group-flush border-top overflow-auto" style="max-height: 400px;">

                                                @foreach (var suggestion in this.m_aiSuggestions)

                                                {

                                                    <div class="list-group-item p-3 border-bottom cursor-pointer hover-bg-light"

                                                         @onclick="() => this.AddClauseToLayout(suggestion)">

                                                        <div class="text-secondary small mb-2">@this.Localizer["ClickToAdd"]</div>

                                                        <div class="fw-medium text-wrap">@suggestion</div>

                                                    </div>

                                                }

                                            </div>

                                        </div>

                                    </div>

                                }

                            </div>

                        </div>

                    </LoadingSkeleton>

                </div>

                

                @* Preview Modal *@

                @if (this.m_showPreview)

                {

                    <div class="modal modal-blur fade show d-block" tabindex="-1" role="dialog">

                        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">

                            <div class="modal-content">

                                <div class="modal-header">

                                    <h5 class="modal-title">@this.Localizer["PreviewTitle"]</h5>

                                    <button type="button" class="btn-close" @onclick="this.TogglePreview"></button>

                                </div>

                                <div class="modal-body p-0" style="height: 600px; overflow-y: auto;">

                                    <iframe srcdoc="@this.m_previewHtml" style="width: 100%; height: 100%; border: none;"></iframe>

                                </div>

                                <div class="modal-footer">

                                    <button type="button" class="btn btn-secondary"

                                            @onclick="this.TogglePreview">@this.CommonLocalizer["Close"]</button>

                                </div>

                            </div>

                        </div>

                    </div>

                    <div class="modal-backdrop fade show"></div>

                }

@code {
    [Parameter] public int? TemplateId { get; set; }
    [SupplyParameterFromQuery] public string? Type { get; set; }

    private DocumentTemplate m_template = new();
    private DocumentLayout m_layout = new();
    private bool m_loading = true;
    private bool m_saving;
    private bool m_showPreview;
    private string? m_previewHtml;

    // AI Features
    private bool m_showAiSidebar = true;
    private string m_aiContext = "";
    private List<string> m_aiSuggestions = [];
    private bool m_loadingAi;

    protected override async Task OnInitializedAsync()
    {
        this.DesignerState.OnStateChanged += this.StateHasChanged;
        await this.LoadDataAsync();
    }

    public void Dispose()
    {
        this.DesignerState.OnStateChanged -= this.StateHasChanged;
    }

    private async Task GetAiSuggestions()
    {
        this.m_loadingAi = true;
        try
        {
            this.m_aiSuggestions = await this.AiService.GetSuggestedClausesAsync(this.m_template.Type, this.m_aiContext);
        }
        catch (Exception ex)
        {
            this.ShowError($"AI Suggestion failed: {ex.Message}");
        }
        finally
        {
            this.m_loadingAi = false;
        }
    }

    private void AddClauseToLayout(string clause)
    {
        if (!this.m_layout.Sections.Any()) this.m_layout.Sections.Add(new LayoutSection { Name = "Main Content" });
        var section = this.m_layout.Sections.Last();
        var block = new TextBlock { Content = clause };
        section.Blocks.Add(block);
        this.DesignerState.SetSelectedBlock(block);
        this.ShowSuccess("Clause added to layout");
    }

    private async Task LoadDataAsync()
    {
        this.m_loading = true;
        try
        {
            if (this.TemplateId > 0)
            {
                var template = await this.TemplateService.GetTemplateByIdAsync(this.TemplateId.Value);
                if (template != null)
                {
                    this.m_template = template;
                    var layout = await this.TemplateService.GetTemplateLayoutAsync(this.m_template.StoreId);
                    if (layout != null) this.m_layout = layout;
                }
            }
            else
            {
                this.m_template = new DocumentTemplate
                {
                    Type = Enum.TryParse<DocumentType>(this.Type, true, out var t) ? t : DocumentType.Receipt,
                    Status = DocumentTemplateStatus.Draft
                };
                this.m_layout = new DocumentLayout
                {
                    Sections = [new LayoutSection { Name = "Main Content" }]
                };
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading template: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private void DeleteSelectedBlock()
    {
        if (this.DesignerState.SelectedBlock == null) return;

        foreach (var section in this.m_layout.Sections)
        {
            if (section.Blocks.Contains(this.DesignerState.SelectedBlock))
            {
                section.Blocks.Remove(this.DesignerState.SelectedBlock);
                this.DesignerState.SetSelectedBlock(null);
                return;
            }
        }
    }

    private void AddBlock(string type)
    {
        if (!this.m_layout.Sections.Any()) this.m_layout.Sections.Add(new LayoutSection { Name = "Main Content" });

        var section = this.m_layout.Sections.Last();
        LayoutBlock block = type switch
        {
            "heading" => new HeadingBlock { Content = "New Heading", Level = 2, HorizontalAlignment = "Center", IsBold = true },
            "text" => new TextBlock { Content = "New Text Block", HorizontalAlignment = "Left" },
            "image" => new ImageBlock { Width = 200 },
            "table" => new TableBlock
            {
                Columns =
                [
                    new TableColumn { Header = "Item", BindingPath = "Description" },
                    new TableColumn { Header = "Qty", BindingPath = "Quantity" },
                    new TableColumn { Header = "Price", BindingPath = "Price" }
                ]
            },
            "divider" => new DividerBlock { Thickness = 1, Color = "#eeeeee" },
            "signature" => new SignatureBlock { Label = "Authorized Signature" },
            "two-columns" => new TwoColumnBlock(),
            "spacer" => new SpacerBlock { Height = 20 },
            _ => new TextBlock { Content = "New Block" }
        };

        section.Blocks.Add(block);
        this.DesignerState.SetSelectedBlock(block);
    }

    private async Task TogglePreview()
    {
        if (!this.m_showPreview)
        {
            // Prepare sample data for preview
            var sampleData = await this.GetSampleDataAsync();
            this.m_previewHtml = this.HtmlRenderer.RenderHtml(this.m_layout, sampleData);
        }

        this.m_showPreview = !this.m_showPreview;
    }

    private async Task<Dictionary<string, object?>> GetSampleDataAsync()
    {
        var org = await this.OrganizationService.GetOrganizationByAccountNoAsync(this.AccountNo);
        var staff = new User { FullName = this.UserName, UserName = this.UserName };
        var booking = new Booking { BookingRef = "PRV-001", CustomerName = "John Preview" };
        return this.DataResolver.Resolve(booking, org ?? new Organization { Name = "Preview Org" }, staff);
    }

    private async Task SaveTemplateAsync()
    {
        if (string.IsNullOrWhiteSpace(this.m_template.Name))
        {
            this.ShowError("Template name is required");
            return;
        }

        this.m_saving = true;
        try
        {
            var result = await this.TemplateService.SaveTemplateAsync(this.m_template, this.m_layout, this.UserName);
            if (result.Success)
            {
                this.ShowSuccess("Template saved successfully");
                if (this.TemplateId == null || this.TemplateId == 0)
                {
                    this.NavigationManager.NavigateTo($"/settings/templates/designer/{this.m_template.DocumentTemplateId}");
                }
            }
            else
            {
                this.ShowError(result.Message ?? "Failed to save template");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error saving template: {ex.Message}");
        }
        finally
        {
            this.m_saving = false;
        }
    }

}