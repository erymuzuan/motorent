@page "/settings/schedule"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantManager")]
@inherits LocalizedComponentBase<ShopScheduleCalendar>
@inject ShopScheduleService ScheduleService
@inject ShopService ShopService

<MotoRentPageTitle>Shop Schedule</MotoRentPageTitle>

<TablerHeader Title="Operating Schedule" PreTitle="Settings">
    <div class="btn-list">
        @if (m_selectedShopId > 0)
        {
            <button type="button" class="btn btn-outline-secondary" @onclick="CopyPreviousWeek" disabled="@m_loading">
                <i class="ti ti-copy me-1"></i>
                Copy Previous Week
            </button>
            <button type="button" class="btn btn-primary" @onclick="SaveChangesAsync" disabled="@(!m_hasChanges || m_saving)">
                @if (m_saving)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                }
                <i class="ti ti-device-floppy me-1"></i>
                Save Changes
            </button>
        }
    </div>
</TablerHeader>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <label class="form-label">Shop</label>
                <select class="form-select" @bind="m_selectedShopId" @bind:after="LoadDataAsync">
                    <option value="0">Select shop...</option>
                    @foreach (var shop in m_shops)
                    {
                        <option value="@shop.ShopId">@shop.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Starting Week</label>
                <input type="date" class="form-control" @bind="m_startDate" @bind:after="LoadDataAsync" />
            </div>
            <div class="col-md-4 text-end">
                @if (m_hasChanges)
                {
                    <span class="badge bg-warning">Unsaved Changes</span>
                }
            </div>
        </div>
    </div>
</div>

@if (m_selectedShopId == 0)
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="ti ti-calendar mb-3" style="font-size: 3rem; color: var(--tblr-secondary);"></i>
            <h3 class="text-secondary">Select a shop</h3>
            <p class="text-secondary">Choose a shop to view and manage its operating schedule.</p>
        </div>
    </div>
}
else
{
    <LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-vcenter mb-0 schedule-table">
                        <thead>
                            <tr class="bg-light">
                                <th style="width: 100px;">Week</th>
                                @foreach (var day in s_daysOfWeek)
                                {
                                    <th class="text-center">@day</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @for (int week = 0; week < 8; week++)
                            {
                                var weekStart = m_startDate.AddDays(week * 7 - (int)m_startDate.DayOfWeek + 1);
                                <tr>
                                    <td class="bg-light text-nowrap">
                                        <small class="text-secondary">Week @(week + 1)</small><br />
                                        <strong>@weekStart.ToString("MMM d")</strong>
                                    </td>
                                    @for (int dayOffset = 0; dayOffset < 7; dayOffset++)
                                    {
                                        var date = weekStart.AddDays(dayOffset);
                                        var schedule = GetScheduleForDate(date);
                                        var isToday = date == DateOnly.FromDateTime(DateTime.Today);
                                        var isPast = date < DateOnly.FromDateTime(DateTime.Today);

                                        <td class="schedule-cell @(isToday ? "today" : "") @(isPast ? "past" : "") @(!schedule.IsOpen ? "closed" : "")"
                                            @onclick="@(() => EditSchedule(schedule))">
                                            <div class="d-flex flex-column align-items-center">
                                                <small class="text-secondary">@date.Day</small>
                                                @if (schedule.IsOpen)
                                                {
                                                    <span class="badge bg-success-lt text-success">
                                                        @schedule.OpenTime.ToString(@"hh\:mm")-@schedule.CloseTime.ToString(@"hh\:mm")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary-lt text-secondary">Closed</span>
                                                }
                                                @if (!string.IsNullOrEmpty(schedule.Note))
                                                {
                                                    <small class="text-primary mt-1" title="@schedule.Note">
                                                        <i class="ti ti-note"></i>
                                                    </small>
                                                }
                                            </div>
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </LoadingSkeleton>

    @* Edit Schedule Modal *@
    @if (m_editingSchedule != null)
    {
        <div class="modal modal-blur fade show" style="display: block;" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            Edit Schedule - @m_editingSchedule.Date.ToString("ddd, MMM d, yyyy")
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-check form-switch">
                                <input type="checkbox" class="form-check-input"
                                       checked="@m_editingSchedule.IsOpen"
                                       @onchange="@(e => m_editingSchedule.IsOpen = (bool)(e.Value ?? false))" />
                                <span class="form-check-label">Open</span>
                            </label>
                        </div>

                        @if (m_editingSchedule.IsOpen)
                        {
                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label">Open Time</label>
                                    <input type="time" class="form-control"
                                           value="@m_editingSchedule.OpenTime.ToString(@"hh\:mm")"
                                           @onchange="@(e => m_editingSchedule.OpenTime = TimeSpan.Parse(e.Value?.ToString() ?? "08:00"))" />
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Close Time</label>
                                    <input type="time" class="form-control"
                                           value="@m_editingSchedule.CloseTime.ToString(@"hh\:mm")"
                                           @onchange="@(e => m_editingSchedule.CloseTime = TimeSpan.Parse(e.Value?.ToString() ?? "18:00"))" />
                                </div>
                            </div>
                        }

                        <div class="mt-3">
                            <label class="form-label">Note (optional)</label>
                            <input type="text" class="form-control" @bind="m_editingSchedule.Note"
                                   placeholder="e.g., Holiday, Extended hours, etc." />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost-secondary" @onclick="CloseEditModal">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="ApplyScheduleEdit">
                            <i class="ti ti-check me-1"></i>
                            Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
}

<style>
    .schedule-table {
        table-layout: fixed;
    }

    .schedule-cell {
        cursor: pointer;
        transition: background-color 0.15s ease;
        vertical-align: middle;
        text-align: center;
        padding: 0.5rem !important;
    }

    .schedule-cell:hover {
        background-color: rgba(var(--tblr-primary-rgb), 0.1);
    }

    .schedule-cell.today {
        background-color: rgba(var(--tblr-primary-rgb), 0.15);
        border: 2px solid var(--tblr-primary) !important;
    }

    .schedule-cell.past {
        opacity: 0.6;
    }

    .schedule-cell.closed {
        background-color: rgba(var(--tblr-secondary-rgb), 0.05);
    }
</style>

@code {
    private static readonly string[] s_daysOfWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    private List<Shop> m_shops = [];
    private List<ShopSchedule> m_schedules = [];
    private bool m_loading;
    private bool m_saving;
    private bool m_hasChanges;
    private int m_selectedShopId;
    private DateOnly m_startDate = DateOnly.FromDateTime(DateTime.Today);
    private ShopSchedule? m_editingSchedule;
    private ShopSchedule? m_originalSchedule;

    protected override async Task OnInitializedAsync()
    {
        // Load shops
        var shopsResult = await this.ShopService.GetShopsAsync(null, true, 1, 100);
        this.m_shops = shopsResult.ItemCollection;

        // Auto-select first shop if available
        if (this.m_shops.Count > 0)
        {
            this.m_selectedShopId = this.m_shops[0].ShopId;
            await this.LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        if (this.m_selectedShopId == 0)
        {
            this.m_schedules.Clear();
            return;
        }

        this.m_loading = true;
        try
        {
            // Calculate date range for 8 weeks
            var weekStart = this.m_startDate.AddDays(-(int)this.m_startDate.DayOfWeek + 1);
            var endDate = weekStart.AddDays(8 * 7 - 1);

            // Ensure schedule exists for this range
            await this.ScheduleService.EnsureScheduleExistsAsync(this.m_selectedShopId, this.UserName, 8);

            // Load schedule
            this.m_schedules = await this.ScheduleService.GetScheduleAsync(
                this.m_selectedShopId, weekStart, endDate);

            this.m_hasChanges = false;
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading schedule: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private ShopSchedule GetScheduleForDate(DateOnly date)
    {
        var schedule = this.m_schedules.FirstOrDefault(s => s.Date == date);
        if (schedule != null) return schedule;

        // Create temporary schedule for display
        schedule = new ShopSchedule
        {
            ShopId = this.m_selectedShopId,
            Date = date,
            IsOpen = true,
            OpenTime = new TimeSpan(8, 0, 0),
            CloseTime = new TimeSpan(18, 0, 0)
        };
        this.m_schedules.Add(schedule);
        return schedule;
    }

    private void EditSchedule(ShopSchedule schedule)
    {
        // Clone for editing
        this.m_originalSchedule = schedule;
        this.m_editingSchedule = new ShopSchedule
        {
            ShopScheduleId = schedule.ShopScheduleId,
            ShopId = schedule.ShopId,
            Date = schedule.Date,
            IsOpen = schedule.IsOpen,
            OpenTime = schedule.OpenTime,
            CloseTime = schedule.CloseTime,
            Note = schedule.Note
        };
    }

    private void CloseEditModal()
    {
        this.m_editingSchedule = null;
        this.m_originalSchedule = null;
    }

    private void ApplyScheduleEdit()
    {
        if (this.m_editingSchedule == null || this.m_originalSchedule == null) return;

        // Apply changes to original schedule
        this.m_originalSchedule.IsOpen = this.m_editingSchedule.IsOpen;
        this.m_originalSchedule.OpenTime = this.m_editingSchedule.OpenTime;
        this.m_originalSchedule.CloseTime = this.m_editingSchedule.CloseTime;
        this.m_originalSchedule.Note = this.m_editingSchedule.Note;

        this.m_hasChanges = true;
        this.CloseEditModal();
    }

    private async Task SaveChangesAsync()
    {
        this.m_saving = true;
        try
        {
            var result = await this.ScheduleService.BatchUpdateScheduleAsync(
                this.m_schedules, this.UserName);

            if (result.Success)
            {
                this.m_hasChanges = false;
                this.ShowSuccess("Schedule saved successfully");
            }
            else
            {
                this.ShowError($"Save failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error saving schedule: {ex.Message}");
        }
        finally
        {
            this.m_saving = false;
        }
    }

    private async Task CopyPreviousWeek()
    {
        if (this.m_selectedShopId == 0) return;

        // Find the first week in view
        var weekStart = this.m_startDate.AddDays(-(int)this.m_startDate.DayOfWeek + 1);
        var previousWeekStart = weekStart.AddDays(-7);

        try
        {
            var result = await this.ScheduleService.CopyWeekAsync(
                this.m_selectedShopId, previousWeekStart, weekStart, this.UserName);

            if (result.Success)
            {
                await this.LoadDataAsync();
                this.ShowSuccess("Previous week schedule copied");
            }
            else
            {
                this.ShowError($"Copy failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error copying schedule: {ex.Message}");
        }
    }
}
