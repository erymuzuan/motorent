@page "/damage-reports"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<DamageReports>
@inject DamageReportService DamageReportService

<MotoRentPageTitle>@Localizer["DamageReports"]</MotoRentPageTitle>

<TablerHeader Title="@Localizer["DamageReports"]" PreTitle="@Localizer["Finance"]">
    <span class="text-secondary">@Localizer["ManageDamageHint"]</span>
</TablerHeader>

<div class="row row-deck row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["PendingClaims"]</div>
                <div class="h2 text-warning">@m_costSummary.PendingCount</div>
                <div class="text-secondary small">@Localizer["EstCost"] @FormatCurrency(m_costSummary.PendingEstimatedCost)</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["Charged"]</div>
                <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-currency-dollar text-success fs-2"></i>
                    <span class="h3">@m_costSummary.ChargedCount</span>
                </div>
                <div class="text-secondary small">@FormatCurrency(m_costSummary.ChargedAmount)</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["Waived"]</div>
                <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-discount-off text-secondary fs-2"></i>
                    <span class="h3">@m_costSummary.WaivedCount</span>
                </div>
                <div class="text-secondary small">@FormatCurrency(m_costSummary.WaivedAmount)</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["InsuranceClaims"]</div>
                <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-shield-check text-info fs-2"></i>
                    <span class="h3">@m_costSummary.InsuranceClaimCount</span>
                </div>
                <div class="text-secondary small">@FormatCurrency(m_costSummary.InsuranceClaimAmount)</div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 0 ? "active" : "")" @onclick="@(() => SetActiveTab(0))">
                    <i class="ti ti-list me-1"></i> @Localizer["All"]
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 1 ? "active" : "")" @onclick="@(() => SetActiveTab(1))">
                    <i class="ti ti-clock me-1"></i> @Localizer["Pending"]
                    @if (m_costSummary.PendingCount > 0)
                    {
                        <span class="badge bg-warning ms-1">@m_costSummary.PendingCount</span>
                    }
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 2 ? "active" : "")" @onclick="@(() => SetActiveTab(2))">
                    <i class="ti ti-currency-dollar me-1"></i> @Localizer["Charged"]
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 3 ? "active" : "")" @onclick="@(() => SetActiveTab(3))">
                    <i class="ti ti-discount-off me-1"></i> @Localizer["Waived"]
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 4 ? "active" : "")" @onclick="@(() => SetActiveTab(4))">
                    <i class="ti ti-shield-check me-1"></i> @Localizer["Insurance"]
                </button>
            </li>
        </ul>
    </div>
</div>

<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table" Rows="10" Columns="8">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table table-striped">
                <thead>
                    <tr>
                        <th>@Localizer["ID"]</th>
                        <th>@Localizer["Reported"]</th>
                        <th>@Localizer["Renter"]</th>
                        <th>@Localizer["Vehicle"]</th>
                        <th>@Localizer["Severity"]</th>
                        <th>@Localizer["EstCost"]</th>
                        <th>@Localizer["ActualCost"]</th>
                        <th>@Localizer["Status"]</th>
                        <th class="w-1">@Localizer["Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @if (m_damageReports.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center text-secondary py-4">
                                <i class="ti ti-alert-triangle-off mb-2" style="font-size: 2rem;"></i>
                                <div>@Localizer["NoDamageReportsFound"]</div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in m_damageReports)
                        {
                            <tr>
                                <td>@item.DamageReport.DamageReportId</td>
                                <td>@FormatDate(item.DamageReport.ReportedOn)</td>
                                <td>@item.RenterName</td>
                                <td>@item.VehicleName</td>
                                <td>
                                    <span class="badge @GetSeverityBadgeClass(item.DamageReport.Severity)">
                                        <i class="ti @GetSeverityIcon(item.DamageReport.Severity) me-1"></i>
                                        @Localizer[item.DamageReport.Severity ?? ""]
                                    </span>
                                </td>
                                <td class="fw-bold text-warning">@FormatCurrency(item.DamageReport.EstimatedCost)</td>
                                <td>
                                    @if (item.DamageReport.ActualCost.HasValue)
                                    {
                                        <span class="fw-bold text-success">@FormatCurrency(item.DamageReport.ActualCost.Value)</span>
                                    }
                                    else
                                    {
                                        <span class="text-secondary">-</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(item.DamageReport.Status)">
                                        @Localizer[item.DamageReport.Status ?? ""]
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <button type="button" class="btn btn-icon btn-ghost-primary" title="@Localizer["ViewDetails"]"
                                                @onclick="@(() => OpenDetailsDialog(item))">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                        @if (item.DamageReport.Status == "Pending")
                                        {
                                            <button type="button" class="btn btn-icon btn-ghost-success" title="@Localizer["MarkAsCharged"]"
                                                    @onclick="@(() => OpenUpdateDialog(item))">
                                                <i class="ti ti-check"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                            @if (item.Photos.Count > 0)
                            {
                                <tr class="bg-light">
                                    <td colspan="9" class="py-2">
                                        <div class="d-flex gap-2 align-items-center">
                                            <span class="text-secondary small me-2">
                                                <i class="ti ti-photo me-1"></i>
                                                @Localizer["PhotosCount", item.Photos.Count]
                                            </span>
                                            @foreach (var photo in item.Photos.Take(4))
                                            {
                                                <a href="/api/damage-photos/file/@photo.ImagePath" target="_blank" class="avatar avatar-sm">
                                                    <img src="/api/damage-photos/file/@photo.ImagePath" alt="Damage photo"
                                                         class="rounded" style="object-fit: cover;" />
                                                </a>
                                            }
                                            @if (item.Photos.Count > 4)
                                            {
                                                <span class="text-secondary small">@Localizer["MorePhotos", item.Photos.Count - 4]</span>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</LoadingSkeleton>

@code {
    private bool m_loading = true;
    private int m_activeTab;
    private List<DamageReportWithDetails> m_damageReports = [];
    private DamageCostSummary m_costSummary = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        m_loading = true;
        try
        {
            m_costSummary = await DamageReportService.GetCostSummaryAsync(ShopId);
            await LoadReportsAsync();
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task LoadReportsAsync()
    {
        var status = m_activeTab switch
        {
            1 => "Pending",
            2 => "Charged",
            3 => "Waived",
            4 => "InsuranceClaim",
            _ => null
        };

        m_damageReports = await DamageReportService.GetWithDetailsAsync(ShopId, status);
    }

    private async Task SetActiveTab(int tab)
    {
        m_activeTab = tab;
        m_loading = true;
        await LoadReportsAsync();
        m_loading = false;
    }

    private async Task OpenDetailsDialog(DamageReportWithDetails item)
    {
        var result = await DialogService
            .Create<DamageReportDialog>(Localizer["DamageReportTitle", item.DamageReport.DamageReportId])
            .WithParameter(x => x.Entity, item.DamageReport)
            .WithParameter(x => x.RenterName, item.RenterName)
            .WithParameter(x => x.VehicleName, item.VehicleName)
            .WithParameter(x => x.Photos, item.Photos)
            .WithParameter(x => x.IsUpdateMode, false)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await LoadDataAsync();
        }
    }

    private async Task OpenUpdateDialog(DamageReportWithDetails item)
    {
        var result = await DialogService
            .Create<DamageReportDialog>(Localizer["UpdateDamageReportTitle", item.DamageReport.DamageReportId])
            .WithParameter(x => x.Entity, item.DamageReport)
            .WithParameter(x => x.RenterName, item.RenterName)
            .WithParameter(x => x.VehicleName, item.VehicleName)
            .WithParameter(x => x.Photos, item.Photos)
            .WithParameter(x => x.IsUpdateMode, true)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await LoadDataAsync();
        }
    }

    private static string GetSeverityBadgeClass(string? severity) => severity switch
    {
        "Minor" => "bg-info",
        "Moderate" => "bg-warning",
        "Major" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetSeverityIcon(string? severity) => severity switch
    {
        "Minor" => "ti-info-circle",
        "Moderate" => "ti-alert-triangle",
        "Major" => "ti-alert-octagon",
        _ => "ti-help"
    };

    private static string GetStatusBadgeClass(string? status) => status switch
    {
        "Pending" => "bg-warning",
        "Charged" => "bg-success",
        "Waived" => "bg-secondary",
        "InsuranceClaim" => "bg-info",
        _ => "bg-secondary"
    };
}
