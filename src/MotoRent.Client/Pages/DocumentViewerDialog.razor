@using System.Text.Json
@inherits MotoRentComponentBase
@inject HttpClient Http

<div class="modal-body">
    <div class="row g-3">
        @* Document Image *@
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body p-2">
                    @if (!string.IsNullOrEmpty(m_imageUrl))
                    {
                        <img src="@m_imageUrl" alt="Document" class="rounded img-fluid"
                             style="width: 100%; max-height: 400px; object-fit: contain;" />
                    }
                    else
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center py-5">
                            <i class="ti ti-photo-off text-secondary mb-2" style="font-size: 3rem;"></i>
                            <span class="text-secondary">Image not available</span>
                        </div>
                    }
                </div>
            </div>

            <div class="d-flex justify-content-center gap-1 mt-2">
                <button type="button" class="btn btn-icon btn-ghost-secondary" title="Zoom In" @onclick="ZoomIn">
                    <i class="ti ti-zoom-in"></i>
                </button>
                <button type="button" class="btn btn-icon btn-ghost-secondary" title="Zoom Out" @onclick="ZoomOut">
                    <i class="ti ti-zoom-out"></i>
                </button>
                <button type="button" class="btn btn-icon btn-ghost-secondary" title="Rotate" @onclick="RotateImage">
                    <i class="ti ti-rotate-clockwise"></i>
                </button>
                <button type="button" class="btn btn-icon btn-ghost-secondary" title="Full Screen" @onclick="OpenFullScreen">
                    <i class="ti ti-external-link"></i>
                </button>
            </div>
        </div>

        @* Extracted Data *@
        <div class="col-12 col-md-6">
            <h4 class="mb-2">Extracted Information</h4>

            @if (m_extractedData != null)
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <tbody>
                            @if (!string.IsNullOrEmpty(m_extractedData.FullName))
                            {
                                <tr>
                                    <td class="fw-bold" style="width: 40%;">Full Name</td>
                                    <td>@m_extractedData.FullName</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.GivenName))
                            {
                                <tr>
                                    <td class="fw-bold">Given Name</td>
                                    <td>@m_extractedData.GivenName</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Surname))
                            {
                                <tr>
                                    <td class="fw-bold">Surname</td>
                                    <td>@m_extractedData.Surname</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.DocumentNumber))
                            {
                                <tr>
                                    <td class="fw-bold">Document Number</td>
                                    <td>@m_extractedData.DocumentNumber</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Nationality))
                            {
                                <tr>
                                    <td class="fw-bold">Nationality</td>
                                    <td>@m_extractedData.Nationality</td>
                                </tr>
                            }
                            @if (m_extractedData.DateOfBirth.HasValue)
                            {
                                <tr>
                                    <td class="fw-bold">Date of Birth</td>
                                    <td>@m_extractedData.DateOfBirth.Value.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Gender))
                            {
                                <tr>
                                    <td class="fw-bold">Gender</td>
                                    <td>@(m_extractedData.Gender == "M" ? "Male" : m_extractedData.Gender == "F" ? "Female" : m_extractedData.Gender)</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.PlaceOfBirth))
                            {
                                <tr>
                                    <td class="fw-bold">Place of Birth</td>
                                    <td>@m_extractedData.PlaceOfBirth</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Address))
                            {
                                <tr>
                                    <td class="fw-bold">Address</td>
                                    <td>@m_extractedData.Address</td>
                                </tr>
                            }
                            @if (m_extractedData.DateOfIssue.HasValue)
                            {
                                <tr>
                                    <td class="fw-bold">Issue Date</td>
                                    <td>@m_extractedData.DateOfIssue.Value.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                            @if (m_extractedData.DateOfExpiry.HasValue)
                            {
                                <tr>
                                    <td class="fw-bold">Expiry Date</td>
                                    <td>
                                        @m_extractedData.DateOfExpiry.Value.ToString("yyyy-MM-dd")
                                        @if (m_extractedData.DateOfExpiry.Value < DateTimeOffset.Now)
                                        {
                                            <span class="badge bg-danger ms-2">Expired</span>
                                        }
                                    </td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.IssuingAuthority))
                            {
                                <tr>
                                    <td class="fw-bold">Issuing Authority</td>
                                    <td>@m_extractedData.IssuingAuthority</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.IssuingCountry))
                            {
                                <tr>
                                    <td class="fw-bold">Issuing Country</td>
                                    <td>@m_extractedData.IssuingCountry</td>
                                </tr>
                            }
                            @if (m_extractedData.VehicleClasses?.Any() == true)
                            {
                                <tr>
                                    <td class="fw-bold">Vehicle Classes</td>
                                    <td>@string.Join(", ", m_extractedData.VehicleClasses)</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Restrictions))
                            {
                                <tr>
                                    <td class="fw-bold">Restrictions</td>
                                    <td>@m_extractedData.Restrictions</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (!string.IsNullOrEmpty(m_extractedData.Error))
                {
                    <div class="alert alert-warning mt-2">
                        <i class="ti ti-alert-triangle me-2"></i>
                        @m_extractedData.Error
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info">
                    <i class="ti ti-info-circle me-2"></i>
                    No extracted data available for this document.
                </div>
            }

            <hr class="my-3" />

            @* Document Info *@
            <h5 class="mb-2">Document Details</h5>
            <table class="table table-sm">
                <tbody>
                    <tr>
                        <td class="fw-bold" style="width: 40%;">Type</td>
                        <td>@GetDocumentTypeLabel()</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Uploaded</td>
                        <td>@Document.UploadedOn.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Status</td>
                        <td>
                            @if (Document.IsVerified)
                            {
                                <span class="badge bg-success">
                                    <i class="ti ti-check me-1"></i>Verified
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-warning">
                                    <i class="ti ti-alert-triangle me-1"></i>Pending Verification
                                </span>
                            }
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-outline-secondary" @onclick="ReprocessOcr" disabled="@m_processing">
        @if (m_processing)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-refresh me-1"></i>
        Re-scan OCR
    </button>
    <div class="ms-auto"></div>

    @if (!Document.IsVerified)
    {
        <button type="button" class="btn btn-success" @onclick="VerifyDocument" disabled="@m_processing">
            <i class="ti ti-circle-check me-1"></i>
            Mark as Verified
        </button>
    }
    else
    {
        <button type="button" class="btn btn-outline-warning" @onclick="UnverifyDocument" disabled="@m_processing">
            <i class="ti ti-circle-minus me-1"></i>
            Remove Verification
        </button>
    }

    <button type="button" class="btn btn-ghost-secondary" @onclick="Close">
        Close
    </button>
</div>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }
    [Parameter] public Document Document { get; set; } = new();

    private ExtractedDocumentData? m_extractedData;
    private string? m_imageUrl;
    private bool m_processing;

    protected override void OnInitialized()
    {
        this.LoadExtractedData();
        this.LoadImageUrl();
    }

    private void LoadExtractedData()
    {
        if (!string.IsNullOrEmpty(this.Document.ExtractedData))
        {
            try
            {
                this.m_extractedData = JsonSerializer.Deserialize<ExtractedDocumentData>(
                    this.Document.ExtractedData,
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            catch
            {
                // Ignore parsing errors
            }
        }
    }

    private void LoadImageUrl()
    {
        if (!string.IsNullOrEmpty(this.Document.ImagePath))
        {
            this.m_imageUrl = $"/api/documents/file/{this.Document.ImagePath}";
        }
    }

    private string GetDocumentTypeLabel() => this.Document.DocumentType switch
    {
        "Passport" => "Passport",
        "NationalId" => "National ID Card",
        "DrivingLicense" => "Driving License",
        _ => "Document"
    };

    private string GetDocumentIcon() => this.Document.DocumentType switch
    {
        "Passport" => "ti ti-id-badge",
        "NationalId" => "ti ti-credit-card",
        "DrivingLicense" => "ti ti-car",
        _ => "ti ti-file-description"
    };

    private void ZoomIn()
    {
        // TODO: Implement zoom functionality via JS
    }

    private void ZoomOut()
    {
        // TODO: Implement zoom functionality via JS
    }

    private void RotateImage()
    {
        // TODO: Implement rotation via JS
    }

    private void OpenFullScreen()
    {
        // TODO: Open image in new tab
    }

    private async Task VerifyDocument()
    {
        await this.SetVerification(true);
    }

    private async Task UnverifyDocument()
    {
        await this.SetVerification(false);
    }

    private async Task SetVerification(bool isVerified)
    {
        this.m_processing = true;
        this.StateHasChanged();

        try
        {
            var response = await this.Http.PostAsJsonAsync(
                $"/api/documents/{this.Document.DocumentId}/verify",
                new { IsVerified = isVerified });

            if (response.IsSuccessStatusCode)
            {
                this.Document.IsVerified = isVerified;
                this.ShowSuccess(isVerified ? "Document verified" : "Verification removed");
            }
            else
            {
                this.ShowError("Failed to update verification status");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            this.m_processing = false;
            this.StateHasChanged();
        }
    }

    private async Task ReprocessOcr()
    {
        this.m_processing = true;
        this.StateHasChanged();

        try
        {
            var response = await this.Http.PostAsync($"/api/documents/{this.Document.DocumentId}/reprocess", null);

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<ReprocessResponse>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (result?.ExtractedData != null)
                {
                    this.m_extractedData = result.ExtractedData;
                    this.Document.ExtractedData = JsonSerializer.Serialize(this.m_extractedData);
                    this.ShowSuccess("OCR re-processing complete");
                }
            }
            else
            {
                this.ShowError("Failed to reprocess document");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            this.m_processing = false;
            this.StateHasChanged();
        }
    }

    private void Close()
    {
        this.ModalInstance?.Close(this.Document);
    }

    private class ReprocessResponse
    {
        public int? DocumentId { get; set; }
        public string? FilePath { get; set; }
        public ExtractedDocumentData? ExtractedData { get; set; }
    }
}
