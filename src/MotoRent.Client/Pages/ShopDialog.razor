@inherits LocalizedDialogBase<Shop, ShopDialog>
@inject ShopService ShopService

<form id="@FormId" @onsubmit="SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "basic" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "basic")">
                    <i class="ti ti-building-store me-1"></i>
                    Basic Info
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "terms" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "terms")">
                    <i class="ti ti-file-text me-1"></i>
                    Terms & Conditions
                </button>
            </li>
        </ul>

        <div class="tab-content">
            @* Basic Info Tab *@
            <div class="tab-pane fade @(m_activeTab == "basic" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label required">Shop Name</label>
                        <input type="text" class="form-control" @bind="Entity.Name" required
                               placeholder="e.g., MotoRent Patong Beach" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">Location/Area</label>
                        <select class="form-select" @bind="Entity.Location" required>
                            <option value="">Select location...</option>
                            <option value="Phuket - Patong">Phuket - Patong</option>
                            <option value="Phuket - Kata">Phuket - Kata</option>
                            <option value="Phuket - Karon">Phuket - Karon</option>
                            <option value="Phuket - Kamala">Phuket - Kamala</option>
                            <option value="Phuket - Rawai">Phuket - Rawai</option>
                            <option value="Krabi - Ao Nang">Krabi - Ao Nang</option>
                            <option value="Krabi - Railay">Krabi - Railay</option>
                            <option value="Koh Samui">Koh Samui</option>
                            <option value="Koh Phangan">Koh Phangan</option>
                            <option value="Chiang Mai">Chiang Mai</option>
                            <option value="Pai">Pai</option>
                            <option value="Bangkok">Bangkok</option>
                            <option value="Pattaya">Pattaya</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label required">Full Address</label>
                        <textarea class="form-control" @bind="Entity.Address" required rows="2"
                                  placeholder="Street address, city, postal code"></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">Phone Number</label>
                        <input type="tel" class="form-control" @bind="Entity.Phone" required
                               placeholder="+66 XX XXX XXXX" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-control" @bind="Entity.Email"
                               placeholder="shop@motorent.com" />
                    </div>

                    <div class="col-12">
                        <label class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" @bind="Entity.IsActive" />
                            <span class="form-check-label">Active</span>
                        </label>
                        <small class="form-hint">Inactive shops won't appear in selection lists</small>
                    </div>
                </div>
            </div>

            @* Terms & Conditions Tab *@
            <div class="tab-pane fade @(m_activeTab == "terms" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="mb-2">Rental Agreement Terms</h6>
                        <p class="text-secondary small mb-3">
                            These terms will be displayed to renters during check-in and included in the rental agreement.
                        </p>
                        <textarea class="form-control" @bind="Entity.TermsAndConditions" rows="15"
                                  placeholder="Enter your rental terms and conditions..."></textarea>
                    </div>

                    @if (string.IsNullOrEmpty(Entity.TermsAndConditions))
                    {
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-primary" @onclick="InsertDefaultTerms">
                                <i class="ti ti-file-plus me-1"></i>
                                Insert Default Terms
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        Cancel
    </button>
    <button type="submit" form="@FormId" class="btn btn-primary" disabled="@Saving">
        @if (Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-device-floppy me-1"></i>
        @SaveButtonText
    </button>
</div>

@code {
    private string m_activeTab = "basic";

    protected override void OnInitialized()
    {
        this.FormValid = true;
    }

    private async Task SaveAsync()
    {
        this.Saving = true;

        try
        {
            var result = this.IsNew
                ? await this.ShopService.CreateShopAsync(this.Entity, this.UserName)
                : await this.ShopService.UpdateShopAsync(this.Entity, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError($"Save failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            this.Saving = false;
        }
    }

    private void InsertDefaultTerms()
    {
        this.Entity.TermsAndConditions = """
            RENTAL AGREEMENT TERMS AND CONDITIONS

            1. RENTAL PERIOD
            - The rental period begins at the time of vehicle pickup and ends at the agreed return time.
            - Late returns may incur additional daily charges.
            - Extensions must be requested at least 24 hours before the scheduled return time.

            2. DRIVER REQUIREMENTS
            - Renter must possess a valid driving license appropriate for the vehicle type.
            - International Driving Permit (IDP) is required for foreign licenses.
            - Renter must be at least 18 years of age.

            3. VEHICLE USE
            - The vehicle is for personal transportation only.
            - Subletting or unauthorized use is prohibited.
            - The vehicle must not be used for racing, off-road driving, or illegal purposes.

            4. FUEL POLICY
            - Vehicle is provided with a full tank of fuel.
            - Vehicle must be returned with a full tank.
            - Refueling charges apply if returned with less fuel.

            5. INSURANCE & LIABILITY
            - Basic insurance is included in the rental rate.
            - Renter is responsible for any damage not covered by insurance.
            - Deductible applies in case of accident or damage.

            6. DEPOSIT
            - A security deposit is required at the time of rental.
            - Deposit will be refunded upon safe return of the vehicle.
            - Deductions may be made for damages, traffic fines, or fuel.

            7. BREAKDOWN & ACCIDENTS
            - Contact the shop immediately in case of breakdown or accident.
            - File a police report for any accident.
            - Do not attempt unauthorized repairs.

            8. RETURN CONDITIONS
            - Vehicle must be returned clean and in the same condition.
            - Return at the agreed location and time.
            - Inspection will be conducted upon return.

            By signing this agreement, the renter acknowledges having read and accepted these terms.
            """;
    }
}
