@inherits LocalizedDialogBase<Shop, ShopDialog>
@inject ShopService ShopService

<form id="@FormId" @onsubmit="SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "basic" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "basic")">
                    <i class="ti ti-building-store me-1"></i>
                    @Localizer["BasicInfo"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "hours" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "hours")">
                    <i class="ti ti-clock me-1"></i>
                    @Localizer["OperatingHours"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "fees" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "fees")">
                    <i class="ti ti-currency-baht me-1"></i>
                    @Localizer["Fees"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "terms" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "terms")">
                    <i class="ti ti-file-text me-1"></i>
                    @Localizer["Terms"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "location" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "location")">
                    <i class="ti ti-map-pin me-1"></i>
                    @Localizer["GpsLocation"]
                </button>
            </li>
        </ul>

        <div class="tab-content">
            @* Basic Info Tab *@
            <div class="tab-pane fade @(m_activeTab == "basic" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label required">@Localizer["ShopName"]</label>
                        <input type="text" class="form-control" @bind="Entity.Name" required
                               placeholder="@Localizer["ShopNamePlaceholder"]" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">@Localizer["LocationArea"]</label>
                        <select class="form-select" @bind="Entity.Location" required>
                            <option value="">@Localizer["SelectLocation"]</option>
                            <option value="Phuket - Patong">Phuket - Patong</option>
                            <option value="Phuket - Kata">Phuket - Kata</option>
                            <option value="Phuket - Karon">Phuket - Karon</option>
                            <option value="Phuket - Kamala">Phuket - Kamala</option>
                            <option value="Phuket - Rawai">Phuket - Rawai</option>
                            <option value="Krabi - Ao Nang">Krabi - Ao Nang</option>
                            <option value="Krabi - Railay">Krabi - Railay</option>
                            <option value="Koh Samui">Koh Samui</option>
                            <option value="Koh Phangan">Koh Phangan</option>
                            <option value="Chiang Mai">Chiang Mai</option>
                            <option value="Pai">Pai</option>
                            <option value="Bangkok">Bangkok</option>
                            <option value="Pattaya">Pattaya</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label required">@Localizer["FullAddress"]</label>
                        <textarea class="form-control" @bind="Entity.Address" required rows="2"
                                  placeholder="@Localizer["AddressPlaceholder"]"></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label required">@Localizer["PhoneNumber"]</label>
                        <input type="tel" class="form-control" @bind="Entity.Phone" required
                               placeholder="+66 XX XXX XXXX" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["EmailAddress"]</label>
                        <input type="email" class="form-control" @bind="Entity.Email"
                               placeholder="shop@motorent.com" />
                    </div>

                    <div class="col-12">
                        <label class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" @bind="Entity.IsActive" />
                            <span class="form-check-label">@Localizer["Active"]</span>
                        </label>
                        <small class="form-hint">@Localizer["InactiveHint"]</small>
                    </div>
                </div>
            </div>

            @* Operating Hours Tab *@
            <div class="tab-pane fade @(m_activeTab == "hours" ? "show active" : "")">
                <div class="mb-3">
                    <h6 class="mb-1">@Localizer["DefaultWeeklyHours"]</h6>
                    <p class="text-secondary small mb-3">
                        @Localizer["HoursHint"]
                    </p>
                </div>

                @if (Entity.DefaultHours.Count == 0)
                {
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="ti ti-info-circle me-2"></i>
                        <span>@Localizer["NoHoursConfigured"]</span>
                    </div>
                    <button type="button" class="btn btn-outline-primary mb-3" @onclick="InitializeDefaultHours">
                        <i class="ti ti-clock-plus me-1"></i>
                        @Localizer["InitializeHours"]
                    </button>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-vcenter table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">@Localizer["Day"]</th>
                                    <th style="width: 80px;">@Localizer["Open"]</th>
                                    <th style="width: 120px;">@Localizer["From"]</th>
                                    <th style="width: 120px;">@Localizer["To"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var dayHours in Entity.DefaultHours.OrderBy(d => ((int)d.DayOfWeek + 6) % 7))
                                {
                                    <tr class="@(dayHours.IsOpen ? "" : "text-secondary")">
                                        <td>@dayHours.DayOfWeek.ToString()</td>
                                        <td>
                                            <label class="form-check form-switch mb-0">
                                                <input type="checkbox" class="form-check-input"
                                                       checked="@dayHours.IsOpen"
                                                       @onchange="@(e => dayHours.IsOpen = (bool)(e.Value ?? false))" />
                                            </label>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm"
                                                   value="@dayHours.OpenTime.ToString(@"hh\:mm")"
                                                   disabled="@(!dayHours.IsOpen)"
                                                   @onchange="@(e => dayHours.OpenTime = TimeSpan.Parse(e.Value?.ToString() ?? "08:00"))" />
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm"
                                                   value="@dayHours.CloseTime.ToString(@"hh\:mm")"
                                                   disabled="@(!dayHours.IsOpen)"
                                                   @onchange="@(e => dayHours.CloseTime = TimeSpan.Parse(e.Value?.ToString() ?? "18:00"))" />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

            @* Out-of-Hours Fees Tab *@
            <div class="tab-pane fade @(m_activeTab == "fees" ? "show active" : "")">
                <div class="mb-3">
                    <h6 class="mb-1">@Localizer["FeeBands"]</h6>
                    <p class="text-secondary small mb-3">
                        @Localizer["FeeBandsHint"]
                    </p>
                </div>

                @if (Entity.OutOfHoursBands.Count > 0)
                {
                    <div class="table-responsive mb-3">
                        <table class="table table-vcenter table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">@Localizer["Name"]</th>
                                    <th style="width: 120px;">@Localizer["From"]</th>
                                    <th style="width: 120px;">@Localizer["To"]</th>
                                    <th style="width: 120px;">@Localizer["Fee"]</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var band in Entity.OutOfHoursBands)
                                {
                                    <tr>
                                        <td>
                                            <input type="text" class="form-control form-control-sm"
                                                   @bind="band.Name" placeholder="@Localizer["BandNamePlaceholder"]" />
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm"
                                                   value="@band.StartTime.ToString(@"hh\:mm")"
                                                   @onchange="@(e => band.StartTime = TimeSpan.Parse(e.Value?.ToString() ?? "18:00"))" />
                                        </td>
                                        <td>
                                            <input type="time" class="form-control form-control-sm"
                                                   value="@band.EndTime.ToString(@"hh\:mm")"
                                                   @onchange="@(e => band.EndTime = TimeSpan.Parse(e.Value?.ToString() ?? "20:00"))" />
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm"
                                                   @bind="band.Fee" min="0" step="50" />
                                        </td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-icon btn-ghost-danger btn-sm"
                                                    @onclick="@(() => RemoveBand(band))">
                                                <i class="ti ti-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <i class="ti ti-info-circle me-2"></i>
                        <span>@Localizer["NoFeesConfigured"]</span>
                    </div>
                }

                <div class="btn-list">
                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AddBand">
                        <i class="ti ti-plus me-1"></i>
                        @Localizer["AddBand"]
                    </button>
                    @if (Entity.OutOfHoursBands.Count == 0)
                    {
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="InsertDefaultBands">
                            <i class="ti ti-template me-1"></i>
                            @Localizer["InsertDefaultBands"]
                        </button>
                    }
                </div>

                @if (Entity.OutOfHoursBands.Any(b => b.StartTime > b.EndTime))
                {
                    <div class="alert alert-warning mt-3 d-flex align-items-center">
                        <i class="ti ti-alert-triangle me-2"></i>
                        <span>@Localizer["OvernightHint"]</span>
                    </div>
                }
            </div>

            @* Terms & Conditions Tab *@
            <div class="tab-pane fade @(m_activeTab == "terms" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="mb-2">@Localizer["RentalTerms"]</h6>
                        <p class="text-secondary small mb-3">
                            @Localizer["TermsHint"]
                        </p>
                        <textarea class="form-control" @bind="Entity.TermsAndConditions" rows="15"
                                  placeholder="@Localizer["TermsPlaceholder"]"></textarea>
                    </div>

                    @if (string.IsNullOrEmpty(Entity.TermsAndConditions))
                    {
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-primary" @onclick="InsertDefaultTerms">
                                <i class="ti ti-file-plus me-1"></i>
                                @Localizer["InsertDefaultTerms"]
                            </button>
                        </div>
                    }
                </div>
            </div>

            @* GPS Location Tab *@
            <div class="tab-pane fade @(m_activeTab == "location" ? "show active" : "")">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="mb-1">@Localizer["ShopGpsTitle"]</h6>
                        <p class="text-secondary small mb-3">
                            @Localizer["GpsHint"]
                        </p>
                    </div>

                    <div class="col-12">
                        <GpsLocationEditor @bind-Location="Entity.GpsLocation" />
                    </div>

                    @if (Entity.GpsLocation?.HasValue == true)
                    {
                        <div class="col-12">
                            <LocationMapView Location="@Entity.GpsLocation"
                                             LocationLabel="@Entity.Name"
                                             Height="280"
                                             ShowDirectionsButton="false" />
                        </div>
                    }
                    else
                    {
                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="ti ti-info-circle me-2"></i>
                                <span>@Localizer["NoGpsSet"]</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="@FormId" class="btn btn-primary" disabled="@Saving">
        @if (Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-device-floppy me-1"></i>
        @SaveButtonText
    </button>
</div>

@code {
    private string m_activeTab = "basic";

    protected override void OnInitialized()
    {
        this.FormValid = true;
    }

    private async Task SaveAsync()
    {
        this.Saving = true;

        try
        {
            var result = this.IsNew
                ? await this.ShopService.CreateShopAsync(this.Entity, this.UserName)
                : await this.ShopService.UpdateShopAsync(this.Entity, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError(Localizer["SaveFailed", result.Message ?? ""]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["Error", ex.Message]);
        }
        finally
        {
            this.Saving = false;
        }
    }

    private void InsertDefaultTerms()
    {
        this.Entity.TermsAndConditions = """
            RENTAL AGREEMENT TERMS AND CONDITIONS

            1. RENTAL PERIOD
            - The rental period begins at the time of vehicle pickup and ends at the agreed return time.
            - Late returns may incur additional daily charges.
            - Extensions must be requested at least 24 hours before the scheduled return time.

            2. DRIVER REQUIREMENTS
            - Renter must possess a valid driving license appropriate for the vehicle type.
            - International Driving Permit (IDP) is required for foreign licenses.
            - Renter must be at least 18 years of age.

            3. VEHICLE USE
            - The vehicle is for personal transportation only.
            - Subletting or unauthorized use is prohibited.
            - The vehicle must not be used for racing, off-road driving, or illegal purposes.

            4. FUEL POLICY
            - Vehicle is provided with a full tank of fuel.
            - Vehicle must be returned with a full tank.
            - Refueling charges apply if returned with less fuel.

            5. INSURANCE & LIABILITY
            - Basic insurance is included in the rental rate.
            - Renter is responsible for any damage not covered by insurance.
            - Deductible applies in case of accident or damage.

            6. DEPOSIT
            - A security deposit is required at the time of rental.
            - Deposit will be refunded upon safe return of the vehicle.
            - Deductions may be made for damages, traffic fines, or fuel.

            7. BREAKDOWN & ACCIDENTS
            - Contact the shop immediately in case of breakdown or accident.
            - File a police report for any accident.
            - Do not attempt unauthorized repairs.

            8. RETURN CONDITIONS
            - Vehicle must be returned clean and in the same condition.
            - Return at the agreed location and time.
            - Inspection will be conducted upon return.

            By signing this agreement, the renter acknowledges having read and accepted these terms.
            """;
    }

    #region Operating Hours Helpers

    private void InitializeDefaultHours()
    {
        this.Entity.DefaultHours.Clear();
        foreach (DayOfWeek day in Enum.GetValues<DayOfWeek>())
        {
            this.Entity.DefaultHours.Add(new DailyHoursTemplate
            {
                DayOfWeek = day,
                IsOpen = true,
                OpenTime = new TimeSpan(8, 0, 0),
                CloseTime = new TimeSpan(18, 0, 0)
            });
        }
    }

    #endregion

    #region Out-of-Hours Fees Helpers

    private void AddBand()
    {
        this.Entity.OutOfHoursBands.Add(new OutOfHoursBand
        {
            Name = "",
            StartTime = new TimeSpan(18, 0, 0),
            EndTime = new TimeSpan(20, 0, 0),
            Fee = 200
        });
    }

    private void RemoveBand(OutOfHoursBand band)
    {
        this.Entity.OutOfHoursBands.Remove(band);
    }

    private void InsertDefaultBands()
    {
        this.Entity.OutOfHoursBands.Clear();
        this.Entity.OutOfHoursBands.AddRange(
        [
            new OutOfHoursBand
            {
                Name = "Early Morning",
                StartTime = new TimeSpan(6, 0, 0),
                EndTime = new TimeSpan(8, 0, 0),
                Fee = 200
            },
            new OutOfHoursBand
            {
                Name = "Evening",
                StartTime = new TimeSpan(18, 0, 0),
                EndTime = new TimeSpan(20, 0, 0),
                Fee = 200
            },
            new OutOfHoursBand
            {
                Name = "Late Evening",
                StartTime = new TimeSpan(20, 0, 0),
                EndTime = new TimeSpan(22, 0, 0),
                Fee = 300
            },
            new OutOfHoursBand
            {
                Name = "Night",
                StartTime = new TimeSpan(22, 0, 0),
                EndTime = new TimeSpan(6, 0, 0),
                Fee = 500
            }
        ]);
    }

    #endregion
}
