@inherits MotoRentComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Services
@using MotoRent.Client.Pages.Rentals
@inject InsuranceService InsuranceService
@inject AccessoryService AccessoryService
@inject ServiceLocationService LocationService
@inject RentalPricingService PricingService
@inject ShopScheduleService ScheduleService
@inject ShopService ShopService
@inject OperatingHoursService HoursService

<div class="d-flex flex-column gap-4">
    <div>
        <h5 class="mb-1">Configure Rental</h5>
        <p class="text-secondary mb-0">Set the rental period and select optional insurance and accessories</p>
    </div>

    <div class="row g-4">
        <div class="col-12 col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">Rental Period</h6>

                    <div class="row g-3 align-items-end">
                        <div class="col-12 col-sm-5">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control"
                                   @bind="m_startDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-12 col-sm-5">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control"
                                   @bind="m_endDate" min="@((m_startDate ?? DateTime.Today).ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-12 col-sm-2 text-center">
                            <small class="text-secondary d-block">Duration</small>
                            <span class="text-primary fw-bold" style="font-size: 1.5rem;">@this.Config.Days</span>
                            <small class="text-secondary">days</small>
                        </div>
                    </div>

                    <div class="btn-group btn-group-sm mt-3" role="group">
                        <button type="button" class="btn btn-outline-secondary" @onclick="@(() => SetDays(1))">1 Day</button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="@(() => SetDays(3))">3 Days</button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="@(() => SetDays(7))">1 Week</button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="@(() => SetDays(14))">2 Weeks</button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="@(() => SetDays(30))">1 Month</button>
                    </div>
                </div>
            </div>

            @* Driver/Guide Options - Only for Boats and Vans *@
            @if (this.SelectedVehicle?.HasDriverOption == true || this.SelectedVehicle?.HasGuideOption == true)
            {
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="ti ti-user me-2"></i>Driver & Guide Options
                        </h6>

                        <div class="d-flex flex-column gap-3">
                            @if (this.SelectedVehicle.HasDriverOption)
                            {
                                <label class="form-selectgroup-item">
                                    <input type="checkbox" class="form-selectgroup-input"
                                           checked="@m_includeDriver"
                                           @onchange="@((ChangeEventArgs e) => ToggleDriver((bool)(e.Value ?? false)))" />
                                    <span class="form-selectgroup-label d-flex justify-content-between align-items-center w-100">
                                        <span class="d-flex align-items-center gap-2">
                                            <i class="ti ti-steering-wheel text-azure" style="font-size: 1.25rem;"></i>
                                            <span class="d-flex flex-column">
                                                <span class="fw-medium">Include Driver</span>
                                                <small class="text-secondary">Professional driver for your trip</small>
                                            </span>
                                        </span>
                                        <span class="text-primary fw-medium">
                                            @FormatCurrency(this.SelectedVehicle.DriverDailyFee ?? 0)/day
                                        </span>
                                    </span>
                                </label>
                            }

                            @if (this.SelectedVehicle.HasGuideOption)
                            {
                                <label class="form-selectgroup-item">
                                    <input type="checkbox" class="form-selectgroup-input"
                                           checked="@m_includeGuide"
                                           @onchange="@((ChangeEventArgs e) => ToggleGuide((bool)(e.Value ?? false)))" />
                                    <span class="form-selectgroup-label d-flex justify-content-between align-items-center w-100">
                                        <span class="d-flex align-items-center gap-2">
                                            <i class="ti ti-map text-teal" style="font-size: 1.25rem;"></i>
                                            <span class="d-flex flex-column">
                                                <span class="fw-medium">Include Tour Guide</span>
                                                <small class="text-secondary">Local guide for sightseeing</small>
                                            </span>
                                        </span>
                                        <span class="text-primary fw-medium">
                                            @FormatCurrency(this.SelectedVehicle.GuideDailyFee ?? 0)/day
                                        </span>
                                    </span>
                                </label>
                            }
                        </div>
                    </div>
                </div>
            }

            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">Insurance Package</h6>

                    @if (m_loadingInsurance)
                    {
                        <div class="progress progress-sm">
                            <div class="progress-bar progress-bar-indeterminate"></div>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex flex-column gap-3">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="insurance" class="form-selectgroup-input"
                                       checked="@(m_selectedInsuranceId == null)"
                                       @onchange="@(() => SelectInsurance(null))" />
                                <span class="form-selectgroup-label d-flex align-items-start gap-3 w-100">
                                    <span class="d-flex flex-column">
                                        <span class="fw-medium">No Insurance</span>
                                        <small class="text-secondary">You are responsible for all damage costs</small>
                                    </span>
                                </span>
                            </label>

                            @foreach (var insurance in m_insurances)
                            {
                                <label class="form-selectgroup-item">
                                    <input type="radio" name="insurance" class="form-selectgroup-input"
                                           checked="@(m_selectedInsuranceId == insurance.InsuranceId)"
                                           @onchange="@(() => SelectInsurance(insurance.InsuranceId))" />
                                    <span class="form-selectgroup-label d-flex justify-content-between align-items-start w-100">
                                        <span class="d-flex flex-column">
                                            <span class="fw-medium">@insurance.Name</span>
                                            <small class="text-secondary">@insurance.Description</small>
                                            <small class="text-muted">
                                                Max coverage: @FormatCurrency(insurance.MaxCoverage) |
                                                Deductible: @FormatCurrency(insurance.Deductible)
                                            </small>
                                        </span>
                                        <span class="text-primary fw-medium ms-3">
                                            @FormatCurrency(insurance.DailyRate)/day
                                        </span>
                                    </span>
                                </label>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">Accessories</h6>

                    @if (m_loadingAccessories)
                    {
                        <div class="progress progress-sm">
                            <div class="progress-bar progress-bar-indeterminate"></div>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex flex-column gap-2">
                            @foreach (var accessory in m_accessories)
                            {
                                var selection = m_accessorySelections.FirstOrDefault(a => a.AccessoryId == accessory.AccessoryId);
                                var isSelected = selection != null;

                                <div class="card bg-light">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center gap-3">
                                                <label class="form-check mb-0">
                                                    <input class="form-check-input" type="checkbox"
                                                           checked="@isSelected"
                                                           @onchange="@((ChangeEventArgs e) => ToggleAccessory(accessory, (bool)(e.Value ?? false)))" />
                                                </label>
                                                <div class="d-flex flex-column">
                                                    <span>
                                                        @accessory.Name
                                                        @if (accessory.IsIncluded)
                                                        {
                                                            <span class="badge bg-success ms-2">Free</span>
                                                        }
                                                    </span>
                                                    <small class="text-secondary">
                                                        @(accessory.IsIncluded ? "Included with rental" : $"{FormatCurrency(accessory.DailyRate)}/day")
                                                    </small>
                                                </div>
                                            </div>

                                            @if (isSelected && !accessory.IsIncluded)
                                            {
                                                <div style="width: 80px;">
                                                    <input type="number" class="form-control form-control-sm"
                                                           min="1" max="@accessory.QuantityAvailable"
                                                           @bind="selection!.Quantity" @bind:after="UpdateConfig" />
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @* Pick-up/Drop-off Location *@
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="ti ti-map-pin me-2"></i>Pick-up & Drop-off
                    </h6>

                    @if (m_loadingLocations)
                    {
                        <div class="progress progress-sm">
                            <div class="progress-bar progress-bar-indeterminate"></div>
                        </div>
                    }
                    else
                    {
                        <div class="row g-3">
                            @* Pickup Location *@
                            <div class="col-12">
                                <label class="form-label">Pick-up Location</label>
                                <select class="form-select" @bind="m_pickupLocationId" @bind:after="OnLocationChanged">
                                    <option value="0">At Shop (Free)</option>
                                    @foreach (var location in m_pickupLocations)
                                    {
                                        <option value="@location.ServiceLocationId">
                                            @location.Name
                                            @if (location.PickupFee > 0)
                                            {
                                                @($" (+{FormatCurrency(location.PickupFee)})")
                                            }
                                        </option>
                                    }
                                </select>
                            </div>

                            @* Pickup Time *@
                            <div class="col-md-6">
                                <label class="form-label">Pick-up Time</label>
                                <input type="time" class="form-control"
                                       value="@m_pickupTime.ToString(@"hh\:mm")"
                                       @onchange="OnPickupTimeChanged" />
                                @if (m_pickupOutOfHoursBand != null)
                                {
                                    <small class="text-warning mt-1 d-block">
                                        <i class="ti ti-clock-exclamation me-1"></i>
                                        @m_pickupOutOfHoursBand.BandName: +@FormatCurrency(m_pickupOutOfHoursBand.Fee)
                                    </small>
                                }
                            </div>

                            @* Dropoff Location *@
                            <div class="col-12 mt-3">
                                <label class="form-label">Drop-off Location (Expected)</label>
                                <select class="form-select" @bind="m_dropoffLocationId" @bind:after="OnLocationChanged">
                                    <option value="0">At Shop (Free)</option>
                                    @foreach (var location in m_dropoffLocations)
                                    {
                                        <option value="@location.ServiceLocationId">
                                            @location.Name
                                            @if (location.DropoffFee > 0)
                                            {
                                                @($" (+{FormatCurrency(location.DropoffFee)})")
                                            }
                                        </option>
                                    }
                                </select>
                            </div>

                            @* Dropoff Time *@
                            <div class="col-md-6">
                                <label class="form-label">Expected Drop-off Time</label>
                                <input type="time" class="form-control"
                                       value="@m_dropoffTime.ToString(@"hh\:mm")"
                                       @onchange="OnDropoffTimeChanged" />
                                @if (m_dropoffOutOfHoursBand != null)
                                {
                                    <small class="text-warning mt-1 d-block">
                                        <i class="ti ti-clock-exclamation me-1"></i>
                                        @m_dropoffOutOfHoursBand.BandName: +@FormatCurrency(m_dropoffOutOfHoursBand.Fee)
                                    </small>
                                }
                            </div>
                        </div>

                        @if (this.Config.LocationPricing?.HasAnyFees == true)
                        {
                            <div class="alert alert-info mt-3 mb-0 py-2">
                                <small>
                                    <i class="ti ti-info-circle me-1"></i>
                                    Location/timing fees: <strong>@FormatCurrency(this.Config.LocationFeesTotal)</strong>
                                </small>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="card" style="position: sticky; top: 20px;">
                <div class="card-body">
                    <h6 class="card-title mb-3">Price Summary</h6>

                    @if (this.SelectedVehicle != null)
                    {
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex justify-content-between">
                                <span>@GetVehicleTypeLabel(this.SelectedVehicle.VehicleType) (@this.Config.Days days x @FormatCurrency(this.SelectedVehicle.DailyRate))</span>
                                <span>@FormatCurrency(this.Config.VehicleTotal)</span>
                            </div>

                            @if (m_includeDriver && this.SelectedVehicle.HasDriverOption)
                            {
                                <div class="d-flex justify-content-between">
                                    <span>Driver (@this.Config.Days days)</span>
                                    <span>@FormatCurrency(this.Config.DriverTotal)</span>
                                </div>
                            }

                            @if (m_includeGuide && this.SelectedVehicle.HasGuideOption)
                            {
                                <div class="d-flex justify-content-between">
                                    <span>Tour Guide (@this.Config.Days days)</span>
                                    <span>@FormatCurrency(this.Config.GuideTotal)</span>
                                </div>
                            }

                            @if (m_selectedInsuranceId.HasValue)
                            {
                                var insurance = m_insurances.FirstOrDefault(i => i.InsuranceId == m_selectedInsuranceId);
                                if (insurance != null)
                                {
                                    <div class="d-flex justify-content-between">
                                        <span>@insurance.Name (@this.Config.Days days)</span>
                                        <span>@FormatCurrency(this.Config.InsuranceTotal)</span>
                                    </div>
                                }
                            }

                            @foreach (var acc in m_accessorySelections.Where(a => !m_accessories.First(x => x.AccessoryId == a.AccessoryId).IsIncluded))
                            {
                                var accessory = m_accessories.First(a => a.AccessoryId == acc.AccessoryId);
                                <div class="d-flex justify-content-between">
                                    <span>@accessory.Name x@acc.Quantity</span>
                                    <span>@FormatCurrency(accessory.DailyRate * acc.Quantity * this.Config.Days)</span>
                                </div>
                            }

                            @* Location and Out-of-Hours Fees *@
                            @if (this.Config.LocationPricing?.HasAnyFees == true)
                            {
                                @if (this.Config.LocationPricing.PickupLocationFee > 0)
                                {
                                    <div class="d-flex justify-content-between text-secondary">
                                        <span>
                                            <i class="ti ti-map-pin me-1"></i>
                                            Pickup: @this.Config.LocationPricing.PickupLocationName
                                        </span>
                                        <span>@FormatCurrency(this.Config.LocationPricing.PickupLocationFee)</span>
                                    </div>
                                }
                                @if (this.Config.LocationPricing.DropoffLocationFee > 0)
                                {
                                    <div class="d-flex justify-content-between text-secondary">
                                        <span>
                                            <i class="ti ti-map-pin me-1"></i>
                                            Dropoff: @this.Config.LocationPricing.DropoffLocationName
                                        </span>
                                        <span>@FormatCurrency(this.Config.LocationPricing.DropoffLocationFee)</span>
                                    </div>
                                }
                                @if (this.Config.LocationPricing.IsOutOfHoursPickup)
                                {
                                    <div class="d-flex justify-content-between text-warning">
                                        <span>
                                            <i class="ti ti-clock me-1"></i>
                                            Pickup: @this.Config.LocationPricing.OutOfHoursPickupBand
                                        </span>
                                        <span>@FormatCurrency(this.Config.LocationPricing.OutOfHoursPickupFee)</span>
                                    </div>
                                }
                                @if (this.Config.LocationPricing.IsOutOfHoursDropoff)
                                {
                                    <div class="d-flex justify-content-between text-warning">
                                        <span>
                                            <i class="ti ti-clock me-1"></i>
                                            Dropoff: @this.Config.LocationPricing.OutOfHoursDropoffBand
                                        </span>
                                        <span>@FormatCurrency(this.Config.LocationPricing.OutOfHoursDropoffFee)</span>
                                    </div>
                                }
                            }

                            <hr class="my-2">

                            <div class="d-flex justify-content-between">
                                <span class="fw-semibold" style="font-size: 1.1rem;">Total</span>
                                <span class="text-primary fw-bold" style="font-size: 1.25rem;">
                                    @FormatCurrency(this.Config.TotalAmount)
                                </span>
                            </div>

                            <hr class="my-2">

                            <div class="d-flex justify-content-between">
                                <span class="text-secondary">Required Deposit</span>
                                <span class="fw-medium">@FormatCurrency(this.SelectedVehicle.DepositAmount)</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Vehicle? SelectedVehicle { get; set; }
    [Parameter] public RentalConfig Config { get; set; } = new();
    [Parameter] public EventCallback<RentalConfig> ConfigChanged { get; set; }


    private List<Insurance> m_insurances = [];
    private List<Accessory> m_accessories = [];
    private List<AccessorySelectionModel> m_accessorySelections = [];
    private bool m_loadingInsurance;
    private bool m_loadingAccessories;

    private DateTime? m_startDate;
    private DateTime? m_endDate;
    private int? m_selectedInsuranceId;
    private bool m_includeDriver;
    private bool m_includeGuide;

    // Location fields
    private List<ServiceLocation> m_pickupLocations = [];
    private List<ServiceLocation> m_dropoffLocations = [];
    private int m_pickupLocationId;
    private int m_dropoffLocationId;
    private TimeSpan m_pickupTime = new(10, 0, 0);
    private TimeSpan m_dropoffTime = new(10, 0, 0);
    private bool m_loadingLocations;
    private OutOfHoursResult? m_pickupOutOfHoursBand;
    private OutOfHoursResult? m_dropoffOutOfHoursBand;
    private Shop? m_shop;

    protected override async Task OnInitializedAsync()
    {
        this.m_startDate = DateTime.Today;
        this.m_endDate = DateTime.Today.AddDays(3);

        await Task.WhenAll(
            this.LoadInsurances(),
            this.LoadAccessories(),
            this.LoadLocations()
        );

        await this.UpdateConfigAsync();
    }

    private async Task LoadInsurances()
    {
        this.m_loadingInsurance = true;
        try
        {
            this.m_insurances = await this.InsuranceService.GetActiveInsurancesAsync(this.ShopId);
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading insurances: {ex.Message}");
        }
        finally
        {
            this.m_loadingInsurance = false;
        }
    }

    private async Task LoadAccessories()
    {
        this.m_loadingAccessories = true;
        try
        {
            var result = await this.AccessoryService.GetAccessoriesAsync(this.ShopId);
            this.m_accessories = result.ItemCollection.Where(a => a.QuantityAvailable > 0).ToList();

            // Auto-select included accessories
            foreach (var accessory in this.m_accessories.Where(a => a.IsIncluded))
            {
                this.m_accessorySelections.Add(new AccessorySelectionModel
                {
                    AccessoryId = accessory.AccessoryId,
                    Quantity = 1
                });
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading accessories: {ex.Message}");
        }
        finally
        {
            this.m_loadingAccessories = false;
        }
    }

    private async Task LoadLocations()
    {
        this.m_loadingLocations = true;
        try
        {
            // Load shop for out-of-hours bands
            this.m_shop = await this.ShopService.GetShopByIdAsync(this.ShopId);

            // Load pickup locations
            this.m_pickupLocations = await this.LocationService.GetActiveLocationsAsync(
                this.ShopId, pickupOnly: true, dropoffOnly: null);

            // Load dropoff locations
            this.m_dropoffLocations = await this.LocationService.GetActiveLocationsAsync(
                this.ShopId, pickupOnly: null, dropoffOnly: true);
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading locations: {ex.Message}");
        }
        finally
        {
            this.m_loadingLocations = false;
        }
    }

    private async Task SetDays(int days)
    {
        this.m_startDate = DateTime.Today;
        this.m_endDate = DateTime.Today.AddDays(days - 1);
        await this.UpdateConfigAsync();
    }

    private async Task SelectInsurance(int? insuranceId)
    {
        this.m_selectedInsuranceId = insuranceId;
        await this.UpdateConfigAsync();
    }

    private async Task ToggleAccessory(Accessory accessory, bool selected)
    {
        if (selected)
        {
            if (!this.m_accessorySelections.Any(a => a.AccessoryId == accessory.AccessoryId))
            {
                this.m_accessorySelections.Add(new AccessorySelectionModel
                {
                    AccessoryId = accessory.AccessoryId,
                    Quantity = 1
                });
            }
        }
        else
        {
            this.m_accessorySelections.RemoveAll(a => a.AccessoryId == accessory.AccessoryId);
        }
        await this.UpdateConfigAsync();
    }

    private async Task ToggleDriver(bool include)
    {
        this.m_includeDriver = include;
        await this.UpdateConfigAsync();
    }

    private async Task ToggleGuide(bool include)
    {
        this.m_includeGuide = include;
        await this.UpdateConfigAsync();
    }

    private async Task OnLocationChanged()
    {
        // Update selected locations
        this.Config.PickupLocationId = this.m_pickupLocationId > 0 ? this.m_pickupLocationId : null;
        this.Config.PickupLocation = this.m_pickupLocations.FirstOrDefault(l => l.ServiceLocationId == this.m_pickupLocationId);

        this.Config.DropoffLocationId = this.m_dropoffLocationId > 0 ? this.m_dropoffLocationId : null;
        this.Config.DropoffLocation = this.m_dropoffLocations.FirstOrDefault(l => l.ServiceLocationId == this.m_dropoffLocationId);

        await this.UpdateConfigAsync();
    }

    private async Task OnPickupTimeChanged(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var time))
        {
            this.m_pickupTime = time;
            this.Config.PickupTime = time;
            await this.UpdateOutOfHoursBandsAsync();
            await this.UpdateConfigAsync();
        }
    }

    private async Task OnDropoffTimeChanged(ChangeEventArgs e)
    {
        if (TimeSpan.TryParse(e.Value?.ToString(), out var time))
        {
            this.m_dropoffTime = time;
            this.Config.DropoffTime = time;
            await this.UpdateOutOfHoursBandsAsync();
            await this.UpdateConfigAsync();
        }
    }

    private async Task UpdateOutOfHoursBandsAsync()
    {
        if (!this.m_startDate.HasValue || !this.m_endDate.HasValue) return;

        // Calculate pickup out-of-hours band
        var pickupDateTime = new DateTimeOffset(
            DateTime.SpecifyKind(this.m_startDate.Value, DateTimeKind.Utc), TimeSpan.Zero)
            .Add(this.m_pickupTime);
        this.m_pickupOutOfHoursBand = await this.HoursService.GetOutOfHoursFeeAsync(this.ShopId, pickupDateTime);

        // Calculate dropoff out-of-hours band
        var dropoffDateTime = new DateTimeOffset(
            DateTime.SpecifyKind(this.m_endDate.Value, DateTimeKind.Utc), TimeSpan.Zero)
            .Add(this.m_dropoffTime);
        this.m_dropoffOutOfHoursBand = await this.HoursService.GetOutOfHoursFeeAsync(this.ShopId, dropoffDateTime);
    }

    private void UpdateConfig() => _ = this.UpdateConfigAsync();

    private async Task UpdateConfigAsync()
    {
        if (this.m_startDate.HasValue)
            this.Config.StartDate = new DateTimeOffset(DateTime.SpecifyKind(this.m_startDate.Value, DateTimeKind.Utc), TimeSpan.Zero);
        if (this.m_endDate.HasValue)
            this.Config.EndDate = new DateTimeOffset(DateTime.SpecifyKind(this.m_endDate.Value, DateTimeKind.Utc), TimeSpan.Zero);

        this.Config.SelectedInsuranceId = this.m_selectedInsuranceId;
        this.Config.SelectedInsurance = this.m_selectedInsuranceId.HasValue
            ? this.m_insurances.FirstOrDefault(i => i.InsuranceId == this.m_selectedInsuranceId)
            : null;

        if (this.SelectedVehicle != null)
        {
            this.Config.VehicleTotal = this.SelectedVehicle.DailyRate * this.Config.Days;

            // Driver/Guide options
            this.Config.IncludeDriver = this.m_includeDriver && this.SelectedVehicle.HasDriverOption;
            this.Config.IncludeGuide = this.m_includeGuide && this.SelectedVehicle.HasGuideOption;
            this.Config.DriverDailyFee = this.SelectedVehicle.DriverDailyFee ?? 0;
            this.Config.GuideDailyFee = this.SelectedVehicle.GuideDailyFee ?? 0;
        }

        this.Config.InsuranceTotal = this.Config.SelectedInsurance?.DailyRate * this.Config.Days ?? 0;

        this.Config.SelectedAccessories = this.m_accessorySelections
            .Select(s => new RentalConfig.AccessorySelection
            {
                Accessory = this.m_accessories.First(a => a.AccessoryId == s.AccessoryId),
                Quantity = s.Quantity
            }).ToList();

        this.Config.AccessoriesTotal = this.Config.SelectedAccessories
            .Where(a => !a.Accessory.IsIncluded)
            .Sum(a => a.Accessory.DailyRate * a.Quantity * this.Config.Days);

        // Calculate location and out-of-hours pricing
        await this.CalculateLocationPricingAsync();

        await this.ConfigChanged.InvokeAsync(this.Config);
    }

    private async Task CalculateLocationPricingAsync()
    {
        if (!this.m_startDate.HasValue || !this.m_endDate.HasValue) return;

        var pickupDateTime = this.Config.StartDate.Add(this.m_pickupTime);
        var dropoffDateTime = this.Config.EndDate.Add(this.m_dropoffTime);

        this.Config.LocationPricing = await this.PricingService.CalculateLocationPricingAsync(
            this.ShopId,
            pickupDateTime,
            dropoffDateTime,
            this.Config.PickupLocation,
            this.Config.DropoffLocation);

        // Update out-of-hours bands for display
        await this.UpdateOutOfHoursBandsAsync();
    }

    private static string GetVehicleTypeLabel(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "Motorbike",
        VehicleType.Car => "Car",
        VehicleType.JetSki => "Jet Ski",
        VehicleType.Boat => "Boat",
        VehicleType.Van => "Van",
        _ => "Vehicle"
    };

    private class AccessorySelectionModel
    {
        public int AccessoryId { get; set; }
        public int Quantity { get; set; } = 1;
    }
}
