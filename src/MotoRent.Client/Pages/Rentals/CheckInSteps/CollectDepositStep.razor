@inherits LocalizedComponentBase<CheckIn>
@using MotoRent.Client.Pages.Rentals

<div class="d-flex flex-column gap-4">
    <div>
        <h5 class="mb-1 mr-text-primary" style="font-weight: 600;">
            <i class="ti ti-wallet me-2" style="color: var(--mr-accent-primary);"></i>
            @Localizer["PaymentDeposit"]
        </h5>
        <p class="mr-text-muted mb-0">@Localizer["PaymentDepositDesc"]</p>
    </div>

    <div class="mr-summary-cards" style="grid-template-columns: repeat(2, 1fr);">
        <div class="mr-summary-card">
            <div class="mr-summary-icon info">
                <i class="ti ti-shopping-cart"></i>
            </div>
            <div class="mr-summary-content">
                <h4>@Localizer["RentalAmount"]</h4>
                <div class="mr-value">@FormatCurrency(this.RentalAmount)</div>
            </div>
        </div>
        <div class="mr-summary-card">
            <div class="mr-summary-icon pending">
                <i class="ti ti-shield"></i>
            </div>
            <div class="mr-summary-content">
                <h4>@Localizer["RequiredDeposit"]</h4>
                <div class="mr-value">@FormatCurrency(this.RequiredAmount)</div>
            </div>
        </div>
    </div>

    @* Rental Payment Method *@
    <div class="card">
        <div class="card-body">
            <h6 class="card-title mb-3">@Localizer["RentalPaymentMethod"]</h6>

            <div class="d-flex flex-wrap gap-3">
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "Cash")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "Cash")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-cash text-success"></i>
                        @Localizer["Cash"]
                    </span>
                </label>
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "Card")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "Card")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-credit-card text-primary"></i>
                        @Localizer["Card"]
                    </span>
                </label>
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "BankTransfer")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "BankTransfer")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-building-bank text-info"></i>
                        @Localizer["BankTransfer"]
                    </span>
                </label>
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "QRCode")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "QRCode")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-qrcode text-secondary"></i>
                        @Localizer["QRCode"]
                    </span>
                </label>
            </div>

            @if (this.DepositInfo.PaymentMethod != "Cash")
            {
                <div class="mt-3">
                    <label class="form-label">@Localizer["TransactionReference"]</label>
                    <input type="text" class="form-control" placeholder="e.g., TXN-123456"
                           @bind="this.DepositInfo.PaymentTransactionRef" />
                </div>
            }
        </div>
    </div>

    <hr>

    <div class="card">
        <div class="card-body">
            <h6 class="card-title mb-3">@Localizer["DepositType"]</h6>

            <div class="d-flex flex-column gap-3">
                <label class="form-selectgroup-item">
                    <input type="radio" name="depositType" class="form-selectgroup-input"
                           checked="@(this.DepositInfo.DepositType == "Cash")"
                           @onchange="@(() => this.DepositInfo.DepositType = "Cash")" />
                    <span class="form-selectgroup-label d-flex align-items-center gap-3">
                        <i class="ti ti-cash text-success" style="font-size: 1.5rem;"></i>
                        <span class="d-flex flex-column">
                            <span class="fw-medium">@Localizer["Cash"]</span>
                            <small class="text-secondary">@Localizer["CashDepositDesc"]</small>
                        </span>
                    </span>
                </label>

                <label class="form-selectgroup-item">
                    <input type="radio" name="depositType" class="form-selectgroup-input"
                           checked="@(this.DepositInfo.DepositType == "CardPreAuth")"
                           @onchange="@(() => this.DepositInfo.DepositType = "CardPreAuth")" />
                    <span class="form-selectgroup-label d-flex align-items-center gap-3">
                        <i class="ti ti-credit-card text-primary" style="font-size: 1.5rem;"></i>
                        <span class="d-flex flex-column">
                            <span class="fw-medium">@Localizer["CardPreAuth"]</span>
                            <small class="text-secondary">@Localizer["CardPreAuthDesc"]</small>
                        </span>
                    </span>
                </label>

                <label class="form-selectgroup-item">
                    <input type="radio" name="depositType" class="form-selectgroup-input"
                           checked="@(this.DepositInfo.DepositType == "Passport")"
                           @onchange="@(() => this.DepositInfo.DepositType = "Passport")" />
                    <span class="form-selectgroup-label d-flex align-items-center gap-3">
                        <i class="ti ti-id-badge text-warning" style="font-size: 1.5rem;"></i>
                        <span class="d-flex flex-column">
                            <span class="fw-medium">@Localizer["PassportHold"]</span>
                            <small class="text-secondary">@Localizer["PassportHoldDesc"]</small>
                        </span>
                    </span>
                </label>
            </div>
        </div>
    </div>

    @if (this.DepositInfo.DepositType == "Cash")
    {
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">@Localizer["CashCollection"]</h6>
                <div class="row g-3">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">@Localizer["AmountCollected"]</label>
                        <div class="input-group">
                            <span class="input-group-text">฿</span>
                            <input type="number" class="form-control" min="0" max="100000"
                                   @bind="this.DepositInfo.Amount" />
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                @onclick="@(() => this.DepositInfo.Amount = this.RequiredAmount)">
                            @Localizer["SetTo"] @FormatCurrency(this.RequiredAmount)
                        </button>
                    </div>
                </div>

                @if (this.DepositInfo.Amount < this.RequiredAmount)
                {
                    <div class="alert alert-warning mt-3">
                        <i class="ti ti-alert-triangle me-2"></i>
                        @Localizer["AmountLessHint", FormatCurrency(this.RequiredAmount - this.DepositInfo.Amount)]
                    </div>
                }
                else if (this.DepositInfo.Amount > this.RequiredAmount)
                {
                    <div class="alert alert-info mt-3">
                        <i class="ti ti-info-circle me-2"></i>
                        @Localizer["AmountExceedsHint", FormatCurrency(this.DepositInfo.Amount - this.RequiredAmount)]
                    </div>
                }
            </div>
        </div>
    }
    else if (this.DepositInfo.DepositType == "CardPreAuth")
    {
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">@Localizer["CardPreAuthDetails"]</h6>
                <div class="row g-3">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">@Localizer["CardLast4"]</label>
                        <input type="text" class="form-control" maxlength="4" placeholder="1234"
                               @bind="this.DepositInfo.CardLast4" />
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">@Localizer["AuthReference"]</label>
                        <input type="text" class="form-control" placeholder="e.g., AUTH-123456"
                               @bind="this.DepositInfo.TransactionRef" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">@Localizer["PreAuthAmount"]</label>
                        <div class="input-group">
                            <span class="input-group-text">฿</span>
                            <input type="number" class="form-control" min="0" max="100000"
                                   @bind="this.DepositInfo.Amount" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (this.DepositInfo.DepositType == "Passport")
    {
        <div class="card">
            <div class="card-body">
                <div class="alert alert-warning mb-3">
                    <i class="ti ti-alert-triangle me-2"></i>
                    @Localizer["PassportHoldWarning"]
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">@Localizer["PassportNumber"]</label>
                        <input type="text" class="form-control"
                               @bind="this.DepositInfo.TransactionRef" />
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-body">
            <label class="form-check">
                <input class="form-check-input" type="checkbox"
                       checked="@this.DepositInfo.IsCollected"
                       @onchange="OnIsCollectedChanged" />
                <span class="form-check-label">@GetConfirmationText()</span>
            </label>
        </div>
    </div>

    @if (this.DepositInfo.IsCollected)
    {
        <div class="alert alert-success d-flex align-items-center gap-2">
            <i class="ti ti-circle-check"></i>
            <span>
                @Localizer["DepositConfirmed"]: @Localizer[this.DepositInfo.DepositType] -
                @if (this.DepositInfo.DepositType != "Passport")
                {
                    @FormatCurrency(this.DepositInfo.Amount)
                }
                else
                {
                    <span>@Localizer["PassportHeld"]</span>
                }
            </span>
        </div>
    }
</div>

@code {
    [Parameter] public decimal RequiredAmount { get; set; }
    [Parameter] public decimal RentalAmount { get; set; }
    [Parameter] public DepositInfo DepositInfo { get; set; } = new();
    [Parameter] public EventCallback<DepositInfo> DepositInfoChanged { get; set; }

    protected override void OnInitialized()
    {
        if (this.DepositInfo.Amount == 0)
            this.DepositInfo.Amount = this.RequiredAmount;
    }

    private async Task OnIsCollectedChanged(ChangeEventArgs e)
    {
        this.DepositInfo.IsCollected = (bool)(e.Value ?? false);
        await this.DepositInfoChanged.InvokeAsync(this.DepositInfo);
    }

    private string GetConfirmationText()
    {
        return this.DepositInfo.DepositType switch
        {
            "Cash" => Localizer["ConfirmCashCollected", FormatCurrency(this.DepositInfo.Amount)],
            "CardPreAuth" => Localizer["ConfirmCardPreAuth", FormatCurrency(this.DepositInfo.Amount)],
            "Passport" => Localizer["ConfirmPassportCollected"],
            _ => Localizer["ConfirmDepositCollected"]
        };
    }
}
