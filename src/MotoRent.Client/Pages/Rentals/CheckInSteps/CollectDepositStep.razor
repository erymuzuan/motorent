@inherits MotoRentComponentBase
@using MotoRent.Client.Pages.Rentals

<div class="d-flex flex-column gap-4">
    <div>
        <h5 class="mb-1">Payment & Deposit</h5>
        <p class="text-secondary mb-0">Collect the rental payment and security deposit before proceeding</p>
    </div>

    <div class="row g-3">
        <div class="col-12 col-md-6">
            <div class="alert alert-info d-flex align-items-center gap-2">
                <i class="ti ti-shopping-cart"></i>
                <span>Rental Amount: <strong>@FormatCurrency(this.RentalAmount)</strong></span>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="alert alert-warning d-flex align-items-center gap-2">
                <i class="ti ti-shield"></i>
                <span>Required Deposit: <strong>@FormatCurrency(this.RequiredAmount)</strong></span>
            </div>
        </div>
    </div>

    @* Rental Payment Method *@
    <div class="card">
        <div class="card-body">
            <h6 class="card-title mb-3">Rental Payment Method</h6>

            <div class="d-flex flex-wrap gap-3">
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "Cash")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "Cash")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-cash text-success"></i>
                        Cash
                    </span>
                </label>
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "Card")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "Card")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-credit-card text-primary"></i>
                        Card
                    </span>
                </label>
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "BankTransfer")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "BankTransfer")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-building-bank text-info"></i>
                        Bank Transfer
                    </span>
                </label>
                <label class="form-check">
                    <input type="radio" name="paymentMethod" class="form-check-input"
                           checked="@(this.DepositInfo.PaymentMethod == "QRCode")"
                           @onchange="@(() => this.DepositInfo.PaymentMethod = "QRCode")" />
                    <span class="form-check-label d-flex align-items-center gap-1">
                        <i class="ti ti-qrcode text-secondary"></i>
                        QR Code
                    </span>
                </label>
            </div>

            @if (this.DepositInfo.PaymentMethod != "Cash")
            {
                <div class="mt-3">
                    <label class="form-label">Transaction Reference</label>
                    <input type="text" class="form-control" placeholder="e.g., TXN-123456"
                           @bind="this.DepositInfo.PaymentTransactionRef" />
                </div>
            }
        </div>
    </div>

    <hr>

    <div class="card">
        <div class="card-body">
            <h6 class="card-title mb-3">Deposit Type</h6>

            <div class="d-flex flex-column gap-3">
                <label class="form-selectgroup-item">
                    <input type="radio" name="depositType" class="form-selectgroup-input"
                           checked="@(this.DepositInfo.DepositType == "Cash")"
                           @onchange="@(() => this.DepositInfo.DepositType = "Cash")" />
                    <span class="form-selectgroup-label d-flex align-items-center gap-3">
                        <i class="ti ti-cash text-success" style="font-size: 1.5rem;"></i>
                        <span class="d-flex flex-column">
                            <span class="fw-medium">Cash</span>
                            <small class="text-secondary">Collect cash deposit from the renter</small>
                        </span>
                    </span>
                </label>

                <label class="form-selectgroup-item">
                    <input type="radio" name="depositType" class="form-selectgroup-input"
                           checked="@(this.DepositInfo.DepositType == "CardPreAuth")"
                           @onchange="@(() => this.DepositInfo.DepositType = "CardPreAuth")" />
                    <span class="form-selectgroup-label d-flex align-items-center gap-3">
                        <i class="ti ti-credit-card text-primary" style="font-size: 1.5rem;"></i>
                        <span class="d-flex flex-column">
                            <span class="fw-medium">Card Pre-Authorization</span>
                            <small class="text-secondary">Hold the amount on the renter's credit/debit card</small>
                        </span>
                    </span>
                </label>

                <label class="form-selectgroup-item">
                    <input type="radio" name="depositType" class="form-selectgroup-input"
                           checked="@(this.DepositInfo.DepositType == "Passport")"
                           @onchange="@(() => this.DepositInfo.DepositType = "Passport")" />
                    <span class="form-selectgroup-label d-flex align-items-center gap-3">
                        <i class="ti ti-id-badge text-warning" style="font-size: 1.5rem;"></i>
                        <span class="d-flex flex-column">
                            <span class="fw-medium">Passport Hold</span>
                            <small class="text-secondary">Hold the renter's passport as deposit (not recommended)</small>
                        </span>
                    </span>
                </label>
            </div>
        </div>
    </div>

    @if (this.DepositInfo.DepositType == "Cash")
    {
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">Cash Collection</h6>
                <div class="row g-3">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Amount Collected (THB)</label>
                        <div class="input-group">
                            <span class="input-group-text">฿</span>
                            <input type="number" class="form-control" min="0" max="100000"
                                   @bind="this.DepositInfo.Amount" />
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 d-flex align-items-end">
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                @onclick="@(() => this.DepositInfo.Amount = this.RequiredAmount)">
                            Set to @FormatCurrency(this.RequiredAmount)
                        </button>
                    </div>
                </div>

                @if (this.DepositInfo.Amount < this.RequiredAmount)
                {
                    <div class="alert alert-warning mt-3">
                        <i class="ti ti-alert-triangle me-2"></i>
                        Amount is less than required deposit. Please collect @FormatCurrency(this.RequiredAmount - this.DepositInfo.Amount) more.
                    </div>
                }
                else if (this.DepositInfo.Amount > this.RequiredAmount)
                {
                    <div class="alert alert-info mt-3">
                        <i class="ti ti-info-circle me-2"></i>
                        Amount exceeds required deposit by @FormatCurrency(this.DepositInfo.Amount - this.RequiredAmount).
                    </div>
                }
            </div>
        </div>
    }
    else if (this.DepositInfo.DepositType == "CardPreAuth")
    {
        <div class="card">
            <div class="card-body">
                <h6 class="card-title mb-3">Card Pre-Authorization Details</h6>
                <div class="row g-3">
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Card Last 4 Digits</label>
                        <input type="text" class="form-control" maxlength="4" placeholder="1234"
                               @bind="this.DepositInfo.CardLast4" />
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Authorization Reference</label>
                        <input type="text" class="form-control" placeholder="e.g., AUTH-123456"
                               @bind="this.DepositInfo.TransactionRef" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Pre-Auth Amount (THB)</label>
                        <div class="input-group">
                            <span class="input-group-text">฿</span>
                            <input type="number" class="form-control" min="0" max="100000"
                                   @bind="this.DepositInfo.Amount" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (this.DepositInfo.DepositType == "Passport")
    {
        <div class="card">
            <div class="card-body">
                <div class="alert alert-warning mb-3">
                    <i class="ti ti-alert-triangle me-2"></i>
                    <strong>Note:</strong> Holding passports as deposit is not recommended and may be illegal in some jurisdictions.
                    Consider using cash or card pre-authorization instead.
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Passport Number (for reference)</label>
                        <input type="text" class="form-control"
                               @bind="this.DepositInfo.TransactionRef" />
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card">
        <div class="card-body">
            <label class="form-check">
                <input class="form-check-input" type="checkbox" @bind="this.DepositInfo.IsCollected" />
                <span class="form-check-label">@GetConfirmationText()</span>
            </label>
        </div>
    </div>

    @if (this.DepositInfo.IsCollected)
    {
        <div class="alert alert-success d-flex align-items-center gap-2">
            <i class="ti ti-circle-check"></i>
            <span>
                Deposit confirmed: @this.DepositInfo.DepositType -
                @if (this.DepositInfo.DepositType != "Passport")
                {
                    @FormatCurrency(this.DepositInfo.Amount)
                }
                else
                {
                    <span>Passport held</span>
                }
            </span>
        </div>
    }
</div>

@code {
    [Parameter] public decimal RequiredAmount { get; set; }
    [Parameter] public decimal RentalAmount { get; set; }
    [Parameter] public DepositInfo DepositInfo { get; set; } = new();
    [Parameter] public EventCallback<DepositInfo> DepositInfoChanged { get; set; }

    protected override void OnInitialized()
    {
        if (this.DepositInfo.Amount == 0)
            this.DepositInfo.Amount = this.RequiredAmount;
    }

    private string GetConfirmationText()
    {
        return this.DepositInfo.DepositType switch
        {
            "Cash" => $"I confirm that I have collected {FormatCurrency(this.DepositInfo.Amount)} in cash as deposit",
            "CardPreAuth" => $"I confirm that the card pre-authorization of {FormatCurrency(this.DepositInfo.Amount)} has been successfully processed",
            "Passport" => "I confirm that the renter's passport has been collected and stored securely",
            _ => "I confirm the deposit has been collected"
        };
    }
}
