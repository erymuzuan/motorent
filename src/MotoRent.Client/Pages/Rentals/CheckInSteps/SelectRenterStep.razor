@inherits LocalizedComponentBase<CheckIn>
@using MotoRent.Domain.Entities
@using MotoRent.Services
@inject RenterService RenterService

<div class="d-flex flex-column gap-4">
    <div>
        <h5 class="mb-1 mr-text-primary" style="font-weight: 600;">
            <i class="ti ti-user me-2" style="color: var(--mr-accent-primary);"></i>
            @Localizer["SelectRenter"]
        </h5>
        <p class="mr-text-muted mb-0">@Localizer["SelectRenterDesc"]</p>
    </div>

    <div class="mb-3">
        <label class="mr-form-label">@Localizer["SearchRenter"]</label>
        <div class="mr-search-box" style="max-width: 100%;">
            <i class="ti ti-search"></i>
            <input type="text" placeholder="@Localizer["SearchRenterPlaceholder"]"
                   @bind="m_searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyup" />
        </div>
        @if (m_showSearchResults && m_searchResults.Count > 0)
        {
            <div class="mr-card mt-2" style="max-height: 300px; overflow-y: auto;">
                @foreach (var renter in m_searchResults)
                {
                    <div class="d-flex align-items-center gap-3 p-3 border-bottom" style="cursor: pointer; border-color: var(--mr-border-light) !important;"
                         @onclick="@(() => SelectRenterItem(renter))">
                        <span class="avatar avatar-sm" style="background: var(--mr-accent-gradient); color: white;">
                            @renter.FullName?.FirstOrDefault()
                        </span>
                        <div class="d-flex flex-column">
                            <span class="mr-text-primary" style="font-weight: 500;">@renter.FullName</span>
                            <small class="mr-text-muted">
                                @renter.Phone @(renter.Nationality != null ? $"| {renter.Nationality}" : "")
                            </small>
                        </div>
                    </div>
                }
            </div>
        }
        else if (m_showSearchResults && !string.IsNullOrWhiteSpace(m_searchTerm))
        {
            <div class="mr-card mt-2 p-3">
                <span class="mr-text-muted">@Localizer["NoRentersFound"]</span>
            </div>
        }
    </div>

    <hr style="border-color: var(--mr-border-light);">

    <button type="button" class="mr-btn-action view w-100 justify-content-center" @onclick="@(() => OnCreateNew.InvokeAsync())">
        <i class="ti ti-user-plus"></i>
        @Localizer["CreateNewRenter"]
    </button>

    @if (m_recentRenters.Count > 0)
    {
        <div class="mt-4">
            <h6 class="mb-3 mr-text-primary" style="font-weight: 600;">
                <i class="ti ti-clock me-1" style="color: var(--mr-accent-secondary);"></i>
                @Localizer["RecentRenters"]
            </h6>
            <div class="d-flex flex-column gap-2">
                @foreach (var renter in m_recentRenters.Take(5))
                {
                    var isSelected = this.SelectedRenter?.RenterId == renter.RenterId;
                    <div class="mr-card p-3" style="cursor: pointer; @(isSelected ? "border: 2px solid var(--mr-accent-primary); background: var(--mr-accent-bg);" : "")"
                         @onclick="@(() => SelectRenterItem(renter))">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <span class="avatar avatar-sm" style="background: var(--mr-accent-gradient); color: white;">
                                    @renter.FullName?.FirstOrDefault()
                                </span>
                                <div class="d-flex flex-column">
                                    <span class="mr-text-primary" style="font-weight: 500;">@renter.FullName</span>
                                    <small class="mr-text-muted">
                                        @renter.Phone
                                        @if (!string.IsNullOrEmpty(renter.Nationality))
                                        {
                                            <span> | @renter.Nationality</span>
                                        }
                                    </small>
                                </div>
                            </div>
                            @if (isSelected)
                            {
                                <i class="ti ti-circle-check" style="font-size: 1.5rem; color: var(--mr-accent-primary);"></i>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @if (this.SelectedRenter != null)
    {
        <hr style="border-color: var(--mr-border-light);">
        <div class="mr-info-panel">
            <div class="mr-info-panel-icon success">
                <i class="ti ti-user-check"></i>
            </div>
            <div>
                <div class="mr-info-panel-title">@Localizer["Selected"]: <strong>@this.SelectedRenter.FullName</strong></div>
                <div class="mr-info-panel-desc">@this.SelectedRenter.Phone</div>
            </div>
        </div>

        <div class="mr-form-panel mt-3">
            <div class="mr-form-panel-header" data-bs-toggle="collapse" data-bs-target="#renterDetailsPanel" style="cursor: pointer;">
                <div class="mr-form-panel-header-icon">
                    <i class="ti ti-id"></i>
                </div>
                <h3 class="mr-form-panel-title">@Localizer["RenterDetails"]</h3>
                <i class="ti ti-chevron-down ms-auto"></i>
            </div>
            <div id="renterDetailsPanel" class="collapse">
                <div class="mr-form-panel-body">
                    <div class="mr-field-grid">
                        <div class="mr-field">
                            <div class="mr-field-label">@Localizer["Nationality"]</div>
                            <div class="mr-field-value">@(this.SelectedRenter.Nationality ?? "-")</div>
                        </div>
                        <div class="mr-field">
                            <div class="mr-field-label">@Localizer["PassportID"]</div>
                            <div class="mr-field-value mr-mono">@(this.SelectedRenter.PassportNo ?? this.SelectedRenter.NationalIdNo ?? "-")</div>
                        </div>
                        <div class="mr-field">
                            <div class="mr-field-label">@Localizer["Email"]</div>
                            <div class="mr-field-value">@(this.SelectedRenter.Email ?? "-")</div>
                        </div>
                        <div class="mr-field">
                            <div class="mr-field-label">@Localizer["Hotel"]</div>
                            <div class="mr-field-value">@(this.SelectedRenter.HotelName ?? "-")</div>
                        </div>
                        <div class="mr-field" style="grid-column: 1 / -1;">
                            <div class="mr-field-label">@Localizer["DrivingLicense"]</div>
                            <div class="mr-field-value mr-mono">
                                @(this.SelectedRenter.DrivingLicenseNo ?? "-")
                                @if (!string.IsNullOrEmpty(this.SelectedRenter.DrivingLicenseCountry))
                                {
                                    <span class="mr-text-muted"> (@this.SelectedRenter.DrivingLicenseCountry)</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public Renter? SelectedRenter { get; set; }
    [Parameter] public EventCallback<Renter?> SelectedRenterChanged { get; set; }
    [Parameter] public EventCallback OnCreateNew { get; set; }

    private List<Renter> m_recentRenters = [];
    private List<Renter> m_searchResults = [];
    private bool m_loading;
    private string? m_searchTerm;
    private bool m_showSearchResults;
    private System.Timers.Timer? m_debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await this.LoadRecentRenters();
    }

    private async Task LoadRecentRenters()
    {
        this.m_loading = true;
        try
        {
            var result = await this.RenterService.GetRentersAsync(page: 1, pageSize: 10);
            this.m_recentRenters = result.ItemCollection;
        }
        catch (Exception ex)
        {
            this.ShowError(this.Localizer["ErrorLoading", ex.Message]);
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task OnSearchKeyup(KeyboardEventArgs e)
    {
        this.m_debounceTimer?.Stop();
        this.m_debounceTimer?.Dispose();

        this.m_debounceTimer = new System.Timers.Timer(300);
        this.m_debounceTimer.Elapsed += async (sender, args) =>
        {
            this.m_debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                await this.SearchRenters();
                this.StateHasChanged();
            });
        };
        this.m_debounceTimer.Start();
    }

    private async Task SearchRenters()
    {
        if (string.IsNullOrWhiteSpace(this.m_searchTerm))
        {
            this.m_searchResults = this.m_recentRenters.Take(5).ToList();
            this.m_showSearchResults = false;
            return;
        }

        var result = await this.RenterService.GetRentersAsync(this.m_searchTerm, page: 1, pageSize: 10);
        this.m_searchResults = result.ItemCollection;
        this.m_showSearchResults = true;
    }

    private async Task SelectRenterItem(Renter renter)
    {
        this.SelectedRenter = renter;
        this.m_showSearchResults = false;
        this.m_searchTerm = renter.FullName;
        await this.SelectedRenterChanged.InvokeAsync(renter);
    }
}
