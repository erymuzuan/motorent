@inherits MotoRentComponentBase
@using MotoRent.Client.Controls
@using MotoRent.Domain.Entities
@using MotoRent.Client.Pages.Rentals

<div class="d-flex flex-column gap-4">
    <div>
        <h5 class="mb-1">Agreement & Signature</h5>
        <p class="text-secondary mb-0">Review the rental summary and collect the renter's signature</p>
    </div>

    <div class="row g-4">
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">Rental Summary</h6>

                    @if (this.Renter != null && this.Vehicle != null)
                    {
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">Renter</small>
                                <span class="fw-medium">@this.Renter.FullName</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">Phone</small>
                                <span>@this.Renter.Phone</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">Passport/ID</small>
                                <span>@(this.Renter.PassportNo ?? this.Renter.NationalIdNo ?? "-")</span>
                            </div>

                            <hr class="my-2">

                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@GetVehicleTypeLabel(this.Vehicle.VehicleType)</small>
                                <span class="fw-medium">@this.Vehicle.Brand @this.Vehicle.Model</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">License Plate</small>
                                <span>@this.Vehicle.LicensePlate</span>
                            </div>
                            @if (this.Vehicle.Mileage.HasValue && this.Vehicle.Mileage > 0)
                            {
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Current Mileage</small>
                                    <span>@this.Vehicle.Mileage.Value.ToString("N0") km</span>
                                </div>
                            }

                            <hr class="my-2">

                            @if (this.IsIntervalRental && this.IntervalConfig != null)
                            {
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Duration</small>
                                    <span>@GetIntervalLabel(this.IntervalConfig.IntervalMinutes)</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Start Time</small>
                                    <span>@this.IntervalConfig.StartDateTime.DateTime.ToString("HH:mm")</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Rate</small>
                                    <span>@FormatCurrency(this.IntervalConfig.RentalRate)</span>
                                </div>
                            }
                            else if (this.Config != null)
                            {
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Rental Period</small>
                                    <span>
                                        @FormatDate(this.Config.StartDate) - @FormatDate(this.Config.EndDate) (@this.Config.Days days)
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Daily Rate</small>
                                    <span>@FormatCurrency(this.Vehicle.DailyRate)</span>
                                </div>

                                @if (this.Config.IncludeDriver)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">Driver</small>
                                        <span>@FormatCurrency(this.Config.DriverTotal)</span>
                                    </div>
                                }

                                @if (this.Config.IncludeGuide)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">Tour Guide</small>
                                        <span>@FormatCurrency(this.Config.GuideTotal)</span>
                                    </div>
                                }

                                @if (this.Config.SelectedInsurance != null)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">Insurance</small>
                                        <span>@this.Config.SelectedInsurance.Name</span>
                                    </div>
                                }

                                @if (this.Config.SelectedAccessories.Count > 0)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">Accessories</small>
                                        <span>
                                            @string.Join(", ", this.Config.SelectedAccessories.Select(a => a.Accessory.Name))
                                        </span>
                                    </div>
                                }
                            }

                            <hr class="my-2">

                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">Deposit</small>
                                <span>
                                    @this.DepositInfo?.DepositType - @FormatCurrency(this.DepositInfo?.Amount ?? 0)
                                </span>
                            </div>

                            <hr class="my-2">

                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold" style="font-size: 1.1rem;">Total Amount</span>
                                <span class="text-primary fw-bold" style="font-size: 1.5rem;">
                                    @FormatCurrency(GetTotalAmount())
                                </span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">Terms & Conditions</h6>

                    <div class="card bg-light" style="max-height: 200px; overflow-y: auto;">
                        <div class="card-body p-3">
                            <p class="mb-0" style="white-space: pre-line; font-size: 0.875rem;">@m_agreementText</p>
                        </div>
                    </div>

                    <label class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" @bind="m_termsAccepted" />
                        <span class="form-check-label">I have read and explained the terms to the renter</span>
                    </label>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">Renter's Signature</h6>

                    <SignaturePad @ref="m_signaturePad"
                                  Width="100%"
                                  Height="200"
                                  OnSignatureChanged="OnSignatureChanged" />

                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="ClearSignature">
                            <i class="ti ti-eraser me-1"></i>
                            Clear
                        </button>
                    </div>

                    @if (!string.IsNullOrEmpty(this.SignatureData))
                    {
                        <div class="alert alert-success d-flex align-items-center gap-2 mt-3 py-2">
                            <i class="ti ti-signature"></i>
                            <span>Signature captured</span>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning d-flex align-items-center gap-2 mt-3 py-2">
                            <i class="ti ti-alert-triangle"></i>
                            <span>Please have the renter sign above</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-success btn-lg" disabled="@(!CanComplete)"
                @onclick="@(() => this.OnComplete.InvokeAsync())">
            <i class="ti ti-circle-check me-2"></i>
            Complete Check-In
        </button>
    </div>
</div>

@code {
    [Parameter] public Renter? Renter { get; set; }
    [Parameter] public Vehicle? Vehicle { get; set; }
    [Parameter] public RentalConfig? Config { get; set; }
    [Parameter] public IntervalRentalConfig? IntervalConfig { get; set; }
    [Parameter] public DepositInfo? DepositInfo { get; set; }
    [Parameter] public string? SignatureData { get; set; }
    [Parameter] public EventCallback<string?> SignatureDataChanged { get; set; }
    [Parameter] public EventCallback OnComplete { get; set; }


    private SignaturePad? m_signaturePad;
    private bool m_termsAccepted;

    private bool IsIntervalRental => this.Vehicle?.UsesIntervalPricing == true;
    private bool CanComplete => this.m_termsAccepted && !string.IsNullOrEmpty(this.SignatureData);

    private decimal GetTotalAmount() =>
        this.IsIntervalRental ? (this.IntervalConfig?.TotalAmount ?? 0) : (this.Config?.TotalAmount ?? 0);

    private static string GetVehicleTypeLabel(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "Motorbike",
        VehicleType.Car => "Car",
        VehicleType.JetSki => "Jet Ski",
        VehicleType.Boat => "Boat",
        VehicleType.Van => "Van",
        _ => "Vehicle"
    };

    private static string GetIntervalLabel(int minutes) => minutes switch
    {
        15 => "15 minutes",
        30 => "30 minutes",
        60 => "1 hour",
        _ => $"{minutes} minutes"
    };

    private string m_agreementText = @"VEHICLE RENTAL AGREEMENT

I, the undersigned renter, agree to the following terms and conditions:

1. VEHICLE CONDITION: I acknowledge that I have received the vehicle in good working condition and agree to return it in the same condition.

2. LIABILITY: I am fully responsible for any damage, loss, or theft of the vehicle during the rental period, including but not limited to accidents, scratches, dents, and mechanical damage.

3. INSURANCE: Any insurance coverage is subject to the terms of the selected insurance package. I understand the deductible and coverage limits.

4. VALID LICENSE: I confirm that I hold a valid license appropriate for this vehicle type and will carry it at all times while operating the vehicle.

5. TRAFFIC LAWS: I agree to follow all applicable laws and regulations of Thailand. I am responsible for all violations and fines incurred during the rental period.

6. NO SUB-RENTAL: I will not lend, sub-rent, or allow any unauthorized person to operate the vehicle.

7. FUEL: I will return the vehicle with the same fuel level as at pick-up, or pay the refueling charge (if applicable).

8. LATE RETURN: If I fail to return the vehicle by the agreed date/time, I will pay additional rental charges plus any late fees.

9. DEPOSIT: I understand that my deposit may be used to cover any damages, additional charges, or unpaid fees.

10. EMERGENCY: In case of accident or breakdown, I will immediately contact the rental shop at the provided number.

11. SAFETY: I agree to wear appropriate safety equipment as required (helmets, life jackets, etc.) and follow all safety instructions provided.

By signing below, I acknowledge that I have read, understood, and agree to all terms and conditions stated above.";

    private async Task OnSignatureChanged(string signatureData)
    {
        this.SignatureData = signatureData;
        await this.SignatureDataChanged.InvokeAsync(signatureData);
    }

    private async Task ClearSignature()
    {
        if (this.m_signaturePad != null)
        {
            await this.m_signaturePad.Clear();
        }
        this.SignatureData = null;
        await this.SignatureDataChanged.InvokeAsync(null);
    }
}
