@inherits LocalizedComponentBase<CheckIn>
@using MotoRent.Domain.Entities
@using MotoRent.Client.Pages.Rentals
@inject IJSRuntime JS

<div class="d-flex flex-column gap-4">
    <div>
        <h5 class="mb-1">@Localizer["AgreementSignature"]</h5>
        <p class="text-secondary mb-0">@Localizer["AgreementSignatureDesc"]</p>
    </div>

    <div class="row g-4">
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">@Localizer["RentalSummary"]</h6>

                    @if (this.Renter != null && this.Vehicle != null)
                    {
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@Localizer["Renter"]</small>
                                <span class="fw-medium">@this.Renter.FullName</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@Localizer["Phone"]</small>
                                <span>@this.Renter.Phone</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@Localizer["PassportID"]</small>
                                <span>@(this.Renter.PassportNo ?? this.Renter.NationalIdNo ?? "-")</span>
                            </div>

                            <hr class="my-2">

                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@GetVehicleTypeLabel(this.Vehicle.VehicleType)</small>
                                <span class="fw-medium">@this.Vehicle.Brand @this.Vehicle.Model</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@Localizer["LicensePlate"]</small>
                                <span>@this.Vehicle.LicensePlate</span>
                            </div>
                            @if (this.Vehicle.Mileage.HasValue && this.Vehicle.Mileage > 0)
                            {
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">@Localizer["CurrentMileage"]</small>
                                    <span>@this.Vehicle.Mileage.Value.ToString("N0") km</span>
                                </div>
                            }

                            <hr class="my-2">

                            @if (this.IsIntervalRental && this.IntervalConfig != null)
                            {
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">@Localizer["Duration"]</small>
                                    <span>@GetIntervalLabel(this.IntervalConfig.IntervalMinutes)</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">@Localizer["StartTime"]</small>
                                    <span>@this.IntervalConfig.StartDateTime.DateTime.ToString("HH:mm")</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">@Localizer["Rate"]</small>
                                    <span>@FormatCurrency(this.IntervalConfig.RentalRate)</span>
                                </div>
                            }
                            else if (this.Config != null)
                            {
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">@Localizer["RentalPeriod"]</small>
                                    <span>
                                        @FormatDate(this.Config.StartDate) - @FormatDate(this.Config.EndDate) (@this.Config.Days @Localizer["Days"])
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">@Localizer["DailyRate"]</small>
                                    <span>@FormatCurrency(this.Vehicle.DailyRate)</span>
                                </div>

                                @if (this.Config.IncludeDriver)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">@Localizer["Driver"]</small>
                                        <span>@FormatCurrency(this.Config.DriverTotal)</span>
                                    </div>
                                }

                                @if (this.Config.IncludeGuide)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">@Localizer["TourGuideDesc"]</small>
                                        <span>@FormatCurrency(this.Config.GuideTotal)</span>
                                    </div>
                                }

                                @if (this.Config.SelectedInsurance != null)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">@Localizer["Insurance"]</small>
                                        <span>@this.Config.SelectedInsurance.Name</span>
                                    </div>
                                }

                                @if (this.Config.SelectedAccessories.Count > 0)
                                {
                                    <div class="d-flex justify-content-between">
                                        <small class="text-secondary">@Localizer["Accessories"]</small>
                                        <span>
                                            @string.Join(", ", this.Config.SelectedAccessories.Select(a => a.Accessory.Name))
                                        </span>
                                    </div>
                                }
                            }

                            <hr class="my-2">

                            <div class="d-flex justify-content-between">
                                <small class="text-secondary">@Localizer["Deposit"]</small>
                                <span>
                                    @Localizer[this.DepositInfo?.DepositType ?? ""] - @FormatCurrency(this.DepositInfo?.Amount ?? 0)
                                </span>
                            </div>

                            <hr class="my-2">

                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold" style="font-size: 1.1rem;">@Localizer["TotalAmount"]</span>
                                <span class="text-primary fw-bold" style="font-size: 1.5rem;">
                                    @FormatCurrency(GetTotalAmount())
                                </span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title mb-3">@Localizer["TermsConditions"]</h6>

                    <div class="card bg-light" style="max-height: 200px; overflow-y: auto;">
                        <div class="card-body p-3">
                            <p class="mb-0" style="white-space: pre-line; font-size: 0.875rem;">@m_agreementText</p>
                        </div>
                    </div>

                    <label class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" @bind="m_termsAccepted" />
                        <span class="form-check-label">@Localizer["ExplainTermsConfirm"]</span>
                    </label>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">@Localizer["PrintAgreement"]</h6>

                    <p class="text-secondary mb-3">
                        @Localizer["PrintAgreementDesc"]
                    </p>

                    <button type="button" class="btn btn-outline-primary btn-lg w-100" @onclick="PrintAgreement">
                        <i class="ti ti-printer me-2"></i>
                        @Localizer["PrintAgreement"]
                    </button>

                    @if (m_agreementPrinted)
                    {
                        <div class="alert alert-success d-flex align-items-center gap-2 mt-3 py-2">
                            <i class="ti ti-check"></i>
                            <span>@Localizer["AgreementPrinted"]</span>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info d-flex align-items-center gap-2 mt-3 py-2">
                            <i class="ti ti-info-circle"></i>
                            <span>@Localizer["PrintAgreementHint"]</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mt-4">
        <button type="button" class="btn btn-success btn-lg" disabled="@(!CanComplete)"
                @onclick="@(() => this.OnComplete.InvokeAsync())">
            <i class="ti ti-circle-check me-2"></i>
            @Localizer["CompleteCheckIn"]
        </button>
    </div>
</div>

@code {
    [Parameter] public Renter? Renter { get; set; }
    [Parameter] public Vehicle? Vehicle { get; set; }
    [Parameter] public bool IsIntervalRental { get; set; }
    [Parameter] public IntervalRentalConfig? IntervalConfig { get; set; }
    [Parameter] public RentalConfig? Config { get; set; }
    [Parameter] public DepositInfo? DepositInfo { get; set; }
    [Parameter] public EventCallback OnComplete { get; set; }

    private string m_agreementText = string.Empty;
    private bool m_termsAccepted;
    private bool m_agreementPrinted;

    private bool CanComplete => m_termsAccepted && m_agreementPrinted;

    protected override void OnInitialized()
    {
        m_agreementText = GetAgreementText();
    }

    private string GetAgreementText()
    {
        return Localizer["AgreementTextTemplate"].Value;
    }

    private decimal GetTotalAmount()
    {
        if (IsIntervalRental && IntervalConfig != null)
            return IntervalConfig.RentalRate + (DepositInfo?.Amount ?? 0);

        if (Config != null)
        {
            return Config.VehicleTotal + Config.InsuranceTotal + Config.AccessoriesTotal
                   + Config.DriverTotal + Config.GuideTotal + (DepositInfo?.Amount ?? 0);
        }

        return DepositInfo?.Amount ?? 0;
    }

    private async Task PrintAgreement()
    {
        await JS.InvokeVoidAsync("window.print");
        m_agreementPrinted = true;
    }

    private string GetVehicleTypeLabel(VehicleType type) => type switch
    {
        VehicleType.Motorbike => Localizer["Motorbike"],
        VehicleType.Car => Localizer["Car"],
        VehicleType.JetSki => Localizer["JetSki"],
        VehicleType.Boat => Localizer["Boat"],
        VehicleType.Van => Localizer["Van"],
        _ => Localizer["Vehicle"]
    };

    private string GetIntervalLabel(int minutes) => minutes switch
    {
        15 => Localizer["15Min"],
        30 => Localizer["30Min"],
        60 => Localizer["1Hour"],
        _ => $"{minutes} {Localizer["Minutes"]}"
    };
}
