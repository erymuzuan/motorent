@page "/rentals/checkin"
@page "/rentals/checkin/{BookingRef}"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Client.Pages.Rentals.CheckInSteps
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Models
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<CheckIn>
@inject RentalService RentalService
@inject RenterService RenterService
@inject VehicleService VehicleService
@inject BookingService BookingService
@inject TillService TillService

<MotoRentPageTitle>@Localizer["PageTitle"]</MotoRentPageTitle>

<div class="mr-page-header mr-animate-in">
    <div class="container-xl">
        <nav class="mr-breadcrumb">
            <span class="mr-breadcrumb-item"><a href="/"><i class="ti ti-home"></i></a></span>
            <span class="mr-breadcrumb-separator"><i class="ti ti-chevron-right"></i></span>
            <span class="mr-breadcrumb-item"><a href="/rentals">@Localizer["Rentals"]</a></span>
            <span class="mr-breadcrumb-separator"><i class="ti ti-chevron-right"></i></span>
            <span class="mr-breadcrumb-item active">@Localizer["CheckIn"]</span>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mr-page-title">
                    <i class="ti ti-login"></i>
                    @Localizer["Header"]
                </h1>
                <p class="mr-page-subtitle">@Localizer["SubHeader"]</p>
            </div>
            <a href="/rentals" class="mr-btn-header-action">
                <i class="ti ti-arrow-left"></i>
                @CommonLocalizer["BackToList"]
            </a>
        </div>
    </div>
</div>

<div class="container-xl">
<div class="mr-card mr-animate-in mr-animate-delay-1">
    <div class="mr-card-body p-4">
        @* Step indicators with enhanced styling *@
        <div class="mr-filter-tabs mb-4" style="justify-content: center;">
            @for (int i = 0; i < m_stepKeys.Length; i++)
            {
                var stepIndex = i;
                var isActive = m_activeStep == stepIndex;
                var isCompleted = m_activeStep > stepIndex;
                <button type="button"
                        class="mr-filter-tab @(isActive ? "active" : "") @(isCompleted ? "text-success" : "")"
                        disabled="@(stepIndex > m_activeStep)"
                        @onclick="@(() => GoToStep(stepIndex))">
                    @if (isCompleted)
                    {
                        <i class="ti ti-check me-1"></i>
                    }
                    else
                    {
                        <span class="me-1">@(stepIndex + 1).</span>
                    }
                    @Localizer[m_stepKeys[stepIndex]]
                </button>
            }
        </div>

        <hr class="my-4" style="border-color: var(--mr-border-light);" />

        @* Step content *@
        @switch (m_activeStep)
        {
            case 0:
                <SelectRenterStep @bind-SelectedRenter="m_selectedRenter"
                                  OnCreateNew="OpenCreateRenterDialog" />
                break;
            case 1:
                <SelectVehicleStep @bind-SelectedVehicle="m_selectedVehicle" />
                break;
            case 2:
                @if (m_selectedVehicle?.UsesIntervalPricing == true)
                {
                    <ConfigureIntervalRentalStep SelectedVehicle="m_selectedVehicle"
                                                 @bind-Config="m_intervalConfig" />
                }
                else
                {
                    <ConfigureRentalStep SelectedVehicle="m_selectedVehicle"
                                         @bind-Config="m_rentalConfig" />
                }
                break;
            case 3:
                <CollectDepositStep RequiredAmount="@(m_selectedVehicle?.DepositAmount ?? 0)"
                                    RentalAmount="@GetRentalTotalAmount()"
                                    @bind-DepositInfo="m_depositInfo" />
                break;
            case 4:
                <PreInspectionStep @bind-InspectionInfo="m_preInspection" />
                break;
            case 5:
                <AgreementSignatureStep Renter="@m_selectedRenter"
                                        Vehicle="@m_selectedVehicle"
                                        Config="@m_rentalConfig"
                                        IntervalConfig="@m_intervalConfig"
                                        DepositInfo="@m_depositInfo"
                                        OnComplete="CompleteCheckIn" />
                break;
        }

        @* Navigation buttons *@
        <div class="d-flex justify-content-between mt-4 pt-3" style="border-top: 1px solid var(--mr-border-light);">
            <button type="button" class="mr-btn-cancel"
                    disabled="@(m_activeStep == 0)"
                    @onclick="PreviousStep">
                <i class="ti ti-arrow-left"></i>
                @CommonLocalizer["Previous"]
            </button>

            @if (m_activeStep < 5)
            {
                <button type="button" class="mr-btn-primary-action"
                        disabled="@(!CanProceedToNextStep())"
                        @onclick="NextStep">
                    @CommonLocalizer["Next"]
                    <i class="ti ti-arrow-right"></i>
                </button>
            }
        </div>
    </div>
</div>
</div>

@if (m_processing)
{
    <div class="modal-backdrop show" style="opacity: 0.8;"></div>
    <div class="d-flex flex-column align-items-center justify-content-center position-fixed top-50 start-50 translate-middle" style="z-index: 1060;">
        <div class="mr-card p-4 text-center" style="min-width: 200px;">
            <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: var(--mr-accent-primary);" role="status"></div>
            <h5 class="mr-text-primary mb-0">@Localizer["ProcessingMessage"]</h5>
        </div>
    </div>
}

@code {
    private readonly string[] m_stepKeys = ["Renter", "Vehicle", "Configure", "Deposit", "Inspection", "Agreement"];
    private int m_activeStep;
    private bool m_processing;

    // Booking pre-fill support
    [Parameter] public string? BookingRef { get; set; }
    private Booking? m_sourceBooking;
    private BookingItem? m_sourceBookingItem;
    private bool m_loadingBooking;

    // Active till session for check-in
    private TillSession? m_tillSession;

    protected override async Task OnInitializedAsync()
    {
        // Require an active till session for check-in
        m_tillSession = await this.TillService.GetActiveSessionForUserAsync(this.UserName);
        if (m_tillSession == null)
        {
            this.ToastService.ShowWarning(this.Localizer["TillSessionRequired"]);
            this.NavigationManager.NavigateTo("/staff/till");
            return;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Load booking if BookingRef is provided
        if (!string.IsNullOrEmpty(this.BookingRef) && this.m_sourceBooking == null)
        {
            await this.LoadBookingAsync();
        }
    }

    private async Task LoadBookingAsync()
    {
        this.m_loadingBooking = true;
        try
        {
            this.m_sourceBooking = await this.BookingService.GetBookingByRefAsync(this.BookingRef!);

            if (this.m_sourceBooking == null)
            {
                this.ShowError(this.Localizer["BookingNotFound", this.BookingRef!]);
                this.NavigationManager.NavigateTo("/bookings");
                return;
            }

            // Check booking status - must be Pending or Confirmed
            if (this.m_sourceBooking.Status != BookingStatus.Pending &&
                this.m_sourceBooking.Status != BookingStatus.Confirmed)
            {
                this.ShowWarning(this.Localizer["BookingNotAvailableForCheckIn"]);
                this.NavigationManager.NavigateTo($"/bookings/{this.BookingRef}");
                return;
            }

            // Get the first pending item for check-in
            this.m_sourceBookingItem = this.m_sourceBooking.Items
                .FirstOrDefault(i => i.ItemStatus == "Pending");

            if (this.m_sourceBookingItem == null)
            {
                this.ShowWarning(this.Localizer["NoItemsToCheckIn"]);
                this.NavigationManager.NavigateTo($"/bookings/{this.BookingRef}");
                return;
            }

            // Pre-fill from booking
            await this.PrefillFromBookingAsync();
        }
        catch (Exception ex)
        {
            this.ShowError(this.Localizer["ErrorLoading", ex.Message]);
        }
        finally
        {
            this.m_loadingBooking = false;
        }
    }

    private async Task PrefillFromBookingAsync()
    {
        if (this.m_sourceBooking == null || this.m_sourceBookingItem == null)
            return;

        // Step 1: Create or find renter from booking customer info
        if (this.m_sourceBooking.RenterId.HasValue && this.m_sourceBooking.RenterId > 0)
        {
            // Link to existing renter
            this.m_selectedRenter = await this.RenterService.GetRenterByIdAsync(this.m_sourceBooking.RenterId.Value);
        }
        else
        {
            // Create new renter from booking customer info
            var newRenter = new Renter
            {
                FullName = this.m_sourceBooking.CustomerName ?? "",
                Phone = this.m_sourceBooking.CustomerPhone ?? "",
                Email = this.m_sourceBooking.CustomerEmail ?? "",
                Nationality = this.m_sourceBooking.CustomerNationality ?? "",
                PassportNo = this.m_sourceBooking.CustomerPassportNo ?? "",
                HotelName = this.m_sourceBooking.HotelName ?? ""
            };
            this.m_selectedRenter = newRenter;
        }

        // Step 2: Find matching vehicle at current shop
        var currentShopId = this.RequestContext.GetShopId();

        // Check if preferred vehicle ID is set and available
        if (this.m_sourceBookingItem.PreferredVehicleId.HasValue)
        {
            var preferredVehicle = await this.VehicleService.GetVehicleByIdAsync(
                this.m_sourceBookingItem.PreferredVehicleId.Value);
            if (preferredVehicle?.Status == VehicleStatus.Available)
            {
                this.m_selectedVehicle = preferredVehicle;
            }
        }

        // If no preferred vehicle or not available, find by group key
        if (this.m_selectedVehicle == null && !string.IsNullOrEmpty(this.m_sourceBookingItem.VehicleGroupKey))
        {
            this.m_selectedVehicle = await this.VehicleService.GetAvailableVehicleFromGroupAsync(
                currentShopId,
                this.m_sourceBookingItem.VehicleGroupKey,
                this.m_sourceBookingItem.PreferredColor);
        }

        // Step 3: Pre-fill rental configuration
        if (this.m_selectedVehicle != null)
        {
            this.m_rentalConfig.StartDate = this.m_sourceBooking.StartDate.DateTime;
            this.m_rentalConfig.EndDate = this.m_sourceBooking.EndDate.DateTime;

            // Pre-select insurance if specified in booking
            if (this.m_sourceBookingItem.InsuranceId.HasValue)
            {
                this.m_rentalConfig.SelectedInsuranceId = this.m_sourceBookingItem.InsuranceId;
            }
        }

        // Show booking info toast
        this.ShowInfo(this.Localizer["BookingLoaded", this.BookingRef!]);
    }

    // Step 1: Renter selection
    private Renter? m_selectedRenter;

    // Step 2: Vehicle selection
    private Vehicle? m_selectedVehicle;

    // Step 3: Rental configuration (daily rentals)
    private RentalConfig m_rentalConfig = new();

    // Step 3: Interval configuration (jet skis)
    private IntervalRentalConfig m_intervalConfig = new();

    // Step 4: Deposit information
    private DepositInfo m_depositInfo = new();

    // Step 5: Pre-rental inspection
    private InspectionInfo? m_preInspection;

    private bool IsIntervalRental => this.m_selectedVehicle?.UsesIntervalPricing == true;

    private decimal GetRentalTotalAmount() =>
        this.IsIntervalRental ? this.m_intervalConfig.TotalAmount : this.m_rentalConfig.TotalAmount;

    private bool CanProceedToNextStep()
    {
        return this.m_activeStep switch
        {
            0 => this.m_selectedRenter != null,
            1 => this.m_selectedVehicle != null,
            2 => this.IsIntervalRental ? this.m_intervalConfig.IsValid : this.m_rentalConfig.IsValid,
            3 => this.m_depositInfo.IsCollected,
            4 => this.m_preInspection != null, // Pre-rental inspection required
            5 => true, // Completion validation is handled by AgreementSignatureStep
            _ => false
        };
    }

    private void NextStep()
    {
        if (this.m_activeStep < 5 && this.CanProceedToNextStep())
            this.m_activeStep++;
    }

    private void PreviousStep()
    {
        if (this.m_activeStep > 0)
            this.m_activeStep--;
    }

    private void GoToStep(int step)
    {
        // Only allow going back to previous steps
        if (step < this.m_activeStep)
            this.m_activeStep = step;
    }

    private async Task OpenCreateRenterDialog()
    {
        var renter = new Renter();

        var result = await this.DialogService
            .Create<RenterDialog>(this.CommonLocalizer["AddRenter"])
            .WithParameter(x => x.Entity, renter)
            .WithParameter(x => x.IsNew, true)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            this.m_selectedRenter = renter;
            this.ShowSuccess(this.Localizer["RenterCreatedSuccess"]);
        }
    }

    private async Task CompleteCheckIn()
    {
        if (this.m_selectedRenter == null || this.m_selectedVehicle == null || this.m_tillSession == null)
        {
            this.ShowError(this.Localizer["ValidationError"]);
            return;
        }

        this.m_processing = true;
        try
        {
            var request = new CheckInRequest
            {
                // Use till session's shop ID
                ShopId = this.m_tillSession.ShopId,
                TillSessionId = this.m_tillSession.TillSessionId,
                RenterId = this.m_selectedRenter.RenterId,
                VehicleId = this.m_selectedVehicle.VehicleId,
                SignatureImagePath = null, // Physical signature collected on printed agreement
                SignedByIp = "127.0.0.1",
                // Payment info
                PaymentMethod = this.m_depositInfo.PaymentMethod,
                PaymentTransactionRef = this.m_depositInfo.PaymentTransactionRef,
                // Deposit info
                DepositType = this.m_depositInfo.DepositType,
                DepositAmount = this.m_depositInfo.Amount,
                CardLast4 = this.m_depositInfo.CardLast4,
                TransactionRef = this.m_depositInfo.TransactionRef,
                // Pre-rental inspection
                PreRentalInspection = this.m_preInspection
            };

            if (this.IsIntervalRental)
            {
                // Interval rental (jet ski)
                request.DurationType = RentalDurationType.FixedInterval;
                request.StartDate = this.m_intervalConfig.StartDateTime;
                request.ExpectedEndDate = this.m_intervalConfig.EndDateTime;
                request.IntervalMinutes = this.m_intervalConfig.IntervalMinutes;
                request.RentalRate = this.m_intervalConfig.RentalRate;
                request.TotalAmount = this.m_intervalConfig.TotalAmount;
            }
            else
            {
                // Daily rental
                request.DurationType = RentalDurationType.Daily;
                request.StartDate = this.m_rentalConfig.StartDate;
                request.ExpectedEndDate = this.m_rentalConfig.EndDate;
                request.MileageStart = this.m_selectedVehicle.Mileage ?? 0;
                request.RentalRate = this.m_selectedVehicle.DailyRate;
                request.TotalAmount = this.m_rentalConfig.TotalAmount;
                request.InsuranceId = this.m_rentalConfig.SelectedInsuranceId;
                request.IncludeDriver = this.m_rentalConfig.IncludeDriver;
                request.IncludeGuide = this.m_rentalConfig.IncludeGuide;
                request.DriverFee = this.m_rentalConfig.DriverTotal;
                request.GuideFee = this.m_rentalConfig.GuideTotal;
                request.Accessories = this.m_rentalConfig.SelectedAccessories
                    .Select(a => new AccessorySelection
                    {
                        AccessoryId = a.Accessory.AccessoryId,
                        Quantity = a.Quantity,
                        ChargedAmount = a.TotalAmount
                    }).ToList();
            }

            var result = await this.RentalService.CheckInAsync(request, this.UserName);

            if (result.Success)
            {
                // Record payment to till session (all payment methods)
                await this.RecordPaymentToTillAsync(result.RentalId);

                // If this check-in is from a booking, update the booking
                if (this.m_sourceBooking != null && this.m_sourceBookingItem != null)
                {
                    await this.BookingService.CheckInItemAsync(
                        this.m_sourceBooking.BookingId,
                        this.m_sourceBookingItem.ItemId,
                        this.m_selectedVehicle!.VehicleId,
                        this.m_tillSession!.ShopId,
                        result.RentalId,
                        this.UserName);
                }

                this.ShowSuccess(this.GetLocalizedText("CheckInSuccess", result.RentalId));
                this.NavigationManager.NavigateTo("/rentals");
            }
            else
            {
                this.ShowError(this.GetLocalizedText("CheckInFailed", result.Message ?? "Unknown error"));
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoading", ex.Message]);
        }
        finally
        {
            this.m_processing = false;
        }
    }

    /// <summary>
    /// Records the rental and deposit payments to the till session.
    /// All payment methods are recorded (cash affects drawer, others for reporting).
    /// </summary>
    private async Task RecordPaymentToTillAsync(int rentalId)
    {
        if (this.m_tillSession == null) return;

        try
        {
            var rentalNo = $"#{rentalId}";

            // Record rental payment to till (all payment methods)
            if (this.m_rentalConfig.TotalAmount > 0 || this.m_intervalConfig.TotalAmount > 0)
            {
                var totalAmount = this.IsIntervalRental ? this.m_intervalConfig.TotalAmount : this.m_rentalConfig.TotalAmount;
                var paymentMethod = this.m_depositInfo.PaymentMethod;

                await this.TillService.RecordRentalPaymentToTillAsync(
                    this.m_tillSession.TillSessionId,
                    paymentMethod,
                    null, // paymentId - will be linked later
                    rentalId,
                    totalAmount,
                    $"Rental payment {rentalNo}",
                    this.UserName);
            }

            // Record deposit to till (if cash deposit)
            if (this.m_depositInfo.Amount > 0 && this.m_depositInfo.DepositType == "Cash")
            {
                await this.TillService.RecordDepositToTillAsync(
                    this.m_tillSession.TillSessionId,
                    null, // depositId - will be linked later
                    rentalId,
                    this.m_depositInfo.Amount,
                    $"Security deposit {rentalNo}",
                    this.UserName);
            }
        }
        catch (Exception ex)
        {
            // Log but don't fail the check-in if till recording fails
            this.Logger.LogError(ex, "Failed to record payment to till session");
        }
    }
}
