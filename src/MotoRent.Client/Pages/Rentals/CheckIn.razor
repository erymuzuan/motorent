@page "/rentals/checkin"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<CheckIn>
@using MotoRent.Client.Controls
@using MotoRent.Client.Pages.Rentals.CheckInSteps
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Models
@inject RentalService RentalService
@inject RenterService RenterService
@inject VehicleService VehicleService
@inject InsuranceService InsuranceService
@inject AccessoryService AccessoryService

<MotoRentPageTitle>@Localizer["PageTitle"]</MotoRentPageTitle>

<div class="mr-page-header mr-animate-in">
    <div class="container-xl">
        <nav class="mr-breadcrumb">
            <span class="mr-breadcrumb-item"><a href="/"><i class="ti ti-home"></i></a></span>
            <span class="mr-breadcrumb-separator"><i class="ti ti-chevron-right"></i></span>
            <span class="mr-breadcrumb-item"><a href="/rentals">@Localizer["Rentals"]</a></span>
            <span class="mr-breadcrumb-separator"><i class="ti ti-chevron-right"></i></span>
            <span class="mr-breadcrumb-item active">@Localizer["CheckIn"]</span>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mr-page-title">
                    <i class="ti ti-login"></i>
                    @Localizer["Header"]
                </h1>
                <p class="mr-page-subtitle">@Localizer["SubHeader"]</p>
            </div>
            <a href="/rentals" class="mr-btn-header-action">
                <i class="ti ti-arrow-left"></i>
                @CommonLocalizer["BackToList"]
            </a>
        </div>
    </div>
</div>

<div class="container-xl">
<div class="mr-card mr-animate-in mr-animate-delay-1">
    <div class="mr-card-body p-4">
        @* Step indicators with enhanced styling *@
        <div class="mr-filter-tabs mb-4" style="justify-content: center;">
            @for (int i = 0; i < m_stepKeys.Length; i++)
            {
                var stepIndex = i;
                var isActive = m_activeStep == stepIndex;
                var isCompleted = m_activeStep > stepIndex;
                <button type="button"
                        class="mr-filter-tab @(isActive ? "active" : "") @(isCompleted ? "text-success" : "")"
                        disabled="@(stepIndex > m_activeStep)"
                        @onclick="@(() => GoToStep(stepIndex))">
                    @if (isCompleted)
                    {
                        <i class="ti ti-check me-1"></i>
                    }
                    else
                    {
                        <span class="me-1">@(stepIndex + 1).</span>
                    }
                    @Localizer[m_stepKeys[stepIndex]]
                </button>
            }
        </div>

        <hr class="my-4" style="border-color: var(--mr-border-light);" />

        @* Step content *@
        @switch (m_activeStep)
        {
            case 0:
                <SelectRenterStep @bind-SelectedRenter="m_selectedRenter"
                                  OnCreateNew="OpenCreateRenterDialog" />
                break;
            case 1:
                <SelectVehicleStep @bind-SelectedVehicle="m_selectedVehicle" />
                break;
            case 2:
                @if (m_selectedVehicle?.UsesIntervalPricing == true)
                {
                    <ConfigureIntervalRentalStep SelectedVehicle="m_selectedVehicle"
                                                 @bind-Config="m_intervalConfig" />
                }
                else
                {
                    <ConfigureRentalStep SelectedVehicle="m_selectedVehicle"
                                         @bind-Config="m_rentalConfig" />
                }
                break;
            case 3:
                <CollectDepositStep RequiredAmount="@(m_selectedVehicle?.DepositAmount ?? 0)"
                                    RentalAmount="@GetRentalTotalAmount()"
                                    @bind-DepositInfo="m_depositInfo" />
                break;
            case 4:
                <PreInspectionStep @bind-InspectionInfo="m_preInspection" />
                break;
            case 5:
                <AgreementSignatureStep Renter="@m_selectedRenter"
                                        Vehicle="@m_selectedVehicle"
                                        Config="@m_rentalConfig"
                                        IntervalConfig="@m_intervalConfig"
                                        DepositInfo="@m_depositInfo"
                                        OnComplete="CompleteCheckIn" />
                break;
        }

        @* Navigation buttons *@
        <div class="d-flex justify-content-between mt-4 pt-3" style="border-top: 1px solid var(--mr-border-light);">
            <button type="button" class="mr-btn-cancel"
                    disabled="@(m_activeStep == 0)"
                    @onclick="PreviousStep">
                <i class="ti ti-arrow-left"></i>
                @CommonLocalizer["Previous"]
            </button>

            @if (m_activeStep < 5)
            {
                <button type="button" class="mr-btn-primary-action"
                        disabled="@(!CanProceedToNextStep())"
                        @onclick="NextStep">
                    @CommonLocalizer["Next"]
                    <i class="ti ti-arrow-right"></i>
                </button>
            }
        </div>
    </div>
</div>
</div>

@if (m_processing)
{
    <div class="modal-backdrop show" style="opacity: 0.8;"></div>
    <div class="d-flex flex-column align-items-center justify-content-center position-fixed top-50 start-50 translate-middle" style="z-index: 1060;">
        <div class="mr-card p-4 text-center" style="min-width: 200px;">
            <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: var(--mr-accent-primary);" role="status"></div>
            <h5 class="mr-text-primary mb-0">@Localizer["ProcessingMessage"]</h5>
        </div>
    </div>
}

@code {
    private readonly string[] m_stepKeys = ["Renter", "Vehicle", "Configure", "Deposit", "Inspection", "Agreement"];
    private int m_activeStep;
    private bool m_processing;

    // Step 1: Renter selection
    private Renter? m_selectedRenter;

    // Step 2: Vehicle selection
    private Vehicle? m_selectedVehicle;

    // Step 3: Rental configuration (daily rentals)
    private RentalConfig m_rentalConfig = new();

    // Step 3: Interval configuration (jet skis)
    private IntervalRentalConfig m_intervalConfig = new();

    // Step 4: Deposit information
    private DepositInfo m_depositInfo = new();

    // Step 5: Pre-rental inspection
    private InspectionInfo? m_preInspection;

    private bool IsIntervalRental => this.m_selectedVehicle?.UsesIntervalPricing == true;

    private decimal GetRentalTotalAmount() =>
        this.IsIntervalRental ? this.m_intervalConfig.TotalAmount : this.m_rentalConfig.TotalAmount;

    private bool CanProceedToNextStep()
    {
        return this.m_activeStep switch
        {
            0 => this.m_selectedRenter != null,
            1 => this.m_selectedVehicle != null,
            2 => this.IsIntervalRental ? this.m_intervalConfig.IsValid : this.m_rentalConfig.IsValid,
            3 => this.m_depositInfo.IsCollected,
            4 => this.m_preInspection != null, // Pre-rental inspection required
            5 => true, // Completion validation is handled by AgreementSignatureStep
            _ => false
        };
    }

    private void NextStep()
    {
        if (this.m_activeStep < 5 && this.CanProceedToNextStep())
            this.m_activeStep++;
    }

    private void PreviousStep()
    {
        if (this.m_activeStep > 0)
            this.m_activeStep--;
    }

    private void GoToStep(int step)
    {
        // Only allow going back to previous steps
        if (step < this.m_activeStep)
            this.m_activeStep = step;
    }

    private async Task OpenCreateRenterDialog()
    {
        var renter = new Renter { ShopId = this.ShopId };

        var result = await this.DialogService
            .Create<RenterDialog>(this.CommonLocalizer["AddRenter"])
            .WithParameter(x => x.Entity, renter)
            .WithParameter(x => x.IsNew, true)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            this.m_selectedRenter = renter;
            this.ShowSuccess(this.Localizer["RenterCreatedSuccess"]);
        }
    }

    private async Task CompleteCheckIn()
    {
        if (this.m_selectedRenter == null || this.m_selectedVehicle == null)
        {
            this.ShowError(this.Localizer["ValidationError"]);
            return;
        }

        this.m_processing = true;
        try
        {
            var request = new CheckInRequest
            {
                ShopId = this.ShopId,
                RenterId = this.m_selectedRenter.RenterId,
                VehicleId = this.m_selectedVehicle.VehicleId,
                SignatureImagePath = null, // Physical signature collected on printed agreement
                SignedByIp = "127.0.0.1",
                // Payment info
                PaymentMethod = this.m_depositInfo.PaymentMethod,
                PaymentTransactionRef = this.m_depositInfo.PaymentTransactionRef,
                // Deposit info
                DepositType = this.m_depositInfo.DepositType,
                DepositAmount = this.m_depositInfo.Amount,
                CardLast4 = this.m_depositInfo.CardLast4,
                TransactionRef = this.m_depositInfo.TransactionRef,
                // Pre-rental inspection
                PreRentalInspection = this.m_preInspection
            };

            if (this.IsIntervalRental)
            {
                // Interval rental (jet ski)
                request.DurationType = RentalDurationType.FixedInterval;
                request.StartDate = this.m_intervalConfig.StartDateTime;
                request.ExpectedEndDate = this.m_intervalConfig.EndDateTime;
                request.IntervalMinutes = this.m_intervalConfig.IntervalMinutes;
                request.RentalRate = this.m_intervalConfig.RentalRate;
                request.TotalAmount = this.m_intervalConfig.TotalAmount;
            }
            else
            {
                // Daily rental
                request.DurationType = RentalDurationType.Daily;
                request.StartDate = this.m_rentalConfig.StartDate;
                request.ExpectedEndDate = this.m_rentalConfig.EndDate;
                request.MileageStart = this.m_selectedVehicle.Mileage ?? 0;
                request.RentalRate = this.m_selectedVehicle.DailyRate;
                request.TotalAmount = this.m_rentalConfig.TotalAmount;
                request.InsuranceId = this.m_rentalConfig.SelectedInsuranceId;
                request.IncludeDriver = this.m_rentalConfig.IncludeDriver;
                request.IncludeGuide = this.m_rentalConfig.IncludeGuide;
                request.DriverFee = this.m_rentalConfig.DriverTotal;
                request.GuideFee = this.m_rentalConfig.GuideTotal;
                request.Accessories = this.m_rentalConfig.SelectedAccessories
                    .Select(a => new AccessorySelection
                    {
                        AccessoryId = a.Accessory.AccessoryId,
                        Quantity = a.Quantity,
                        ChargedAmount = a.TotalAmount
                    }).ToList();
            }

            var result = await this.RentalService.CheckInAsync(request, this.UserName);

            if (result.Success)
            {
                this.ShowSuccess(this.GetLocalizedText("CheckInSuccess", result.RentalId));
                this.NavigationManager.NavigateTo("/rentals");
            }
            else
            {
                this.ShowError(this.GetLocalizedText("CheckInFailed", result.Message ?? "Unknown error"));
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoading", ex.Message]);
        }
        finally
        {
            this.m_processing = false;
        }
    }
}
