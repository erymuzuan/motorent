@page "/rentals/checkin"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<CheckIn>
@using MotoRent.Client.Controls
@using MotoRent.Client.Pages.Rentals.CheckInSteps
@using MotoRent.Domain.Entities
@inject RentalService RentalService
@inject RenterService RenterService
@inject VehicleService VehicleService
@inject InsuranceService InsuranceService
@inject AccessoryService AccessoryService

<MotoRentPageTitle>@Localizer["PageTitle"]</MotoRentPageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0">@Localizer["Header"]</h2>
        <small class="text-secondary">@Localizer["SubHeader"]</small>
    </div>
    <a href="/rentals" class="btn btn-outline-secondary">
        <i class="ti ti-arrow-left me-1"></i>
        @CommonLocalizer["BackToList"]
    </a>
</div>

<div class="card">
    <div class="card-body">
        @* Step indicators *@
        <div class="steps steps-counter steps-primary mb-4">
            @for (int i = 0; i < m_stepKeys.Length; i++)
            {
                var stepIndex = i;
                var isActive = m_activeStep == stepIndex;
                var isCompleted = m_activeStep > stepIndex;
                <a href="#" class="step-item @(isActive ? "active" : "") @(isCompleted ? "step-item-completed" : "")"
                   @onclick="@(() => GoToStep(stepIndex))" @onclick:preventDefault>
                    @Localizer[m_stepKeys[stepIndex]]
                </a>
            }
        </div>

        <hr class="my-4" />

        @* Step content *@
        @switch (m_activeStep)
        {
            case 0:
                <SelectRenterStep @bind-SelectedRenter="m_selectedRenter"
                                  OnCreateNew="OpenCreateRenterDialog" />
                break;
            case 1:
                <SelectVehicleStep @bind-SelectedVehicle="m_selectedVehicle" />
                break;
            case 2:
                @if (m_selectedVehicle?.UsesIntervalPricing == true)
                {
                    <ConfigureIntervalRentalStep SelectedVehicle="m_selectedVehicle"
                                                 @bind-Config="m_intervalConfig" />
                }
                else
                {
                    <ConfigureRentalStep SelectedVehicle="m_selectedVehicle"
                                         @bind-Config="m_rentalConfig" />
                }
                break;
            case 3:
                <CollectDepositStep RequiredAmount="@(m_selectedVehicle?.DepositAmount ?? 0)"
                                    RentalAmount="@GetRentalTotalAmount()"
                                    @bind-DepositInfo="m_depositInfo" />
                break;
            case 4:
                <AgreementSignatureStep Renter="@m_selectedRenter"
                                        Vehicle="@m_selectedVehicle"
                                        Config="@m_rentalConfig"
                                        IntervalConfig="@m_intervalConfig"
                                        DepositInfo="@m_depositInfo"
                                        OnComplete="CompleteCheckIn" />
                break;
        }

        @* Navigation buttons *@
        <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-ghost-secondary"
                    disabled="@(m_activeStep == 0)"
                    @onclick="PreviousStep">
                <i class="ti ti-arrow-left me-1"></i>
                @CommonLocalizer["Previous"]
            </button>

            @if (m_activeStep < 4)
            {
                <button type="button" class="btn btn-primary"
                        disabled="@(!CanProceedToNextStep())"
                        @onclick="NextStep">
                    @CommonLocalizer["Next"]
                    <i class="ti ti-arrow-right ms-1"></i>
                </button>
            }
        </div>
    </div>
</div>

@if (m_processing)
{
    <div class="modal-backdrop show"></div>
    <div class="d-flex flex-column align-items-center justify-content-center position-fixed top-50 start-50 translate-middle" style="z-index: 1060;">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <h5 class="text-white">@Localizer["ProcessingMessage"]</h5>
    </div>
}

@code {
    private readonly string[] m_stepKeys = ["Renter", "Vehicle", "Configure", "Deposit", "Agreement"];
    private int m_activeStep;
    private bool m_processing;

    // Step 1: Renter selection
    private Renter? m_selectedRenter;

    // Step 2: Vehicle selection
    private Vehicle? m_selectedVehicle;

    // Step 3: Rental configuration (daily rentals)
    private RentalConfig m_rentalConfig = new();

    // Step 3: Interval configuration (jet skis)
    private IntervalRentalConfig m_intervalConfig = new();

    // Step 4: Deposit information
    private DepositInfo m_depositInfo = new();

    private bool IsIntervalRental => this.m_selectedVehicle?.UsesIntervalPricing == true;

    private decimal GetRentalTotalAmount() =>
        this.IsIntervalRental ? this.m_intervalConfig.TotalAmount : this.m_rentalConfig.TotalAmount;

    private bool CanProceedToNextStep()
    {
        return this.m_activeStep switch
        {
            0 => this.m_selectedRenter != null,
            1 => this.m_selectedVehicle != null,
            2 => this.IsIntervalRental ? this.m_intervalConfig.IsValid : this.m_rentalConfig.IsValid,
            3 => this.m_depositInfo.IsCollected,
            4 => true, // Completion validation is handled by AgreementSignatureStep
            _ => false
        };
    }

    private void NextStep()
    {
        if (this.m_activeStep < 4 && this.CanProceedToNextStep())
            this.m_activeStep++;
    }

    private void PreviousStep()
    {
        if (this.m_activeStep > 0)
            this.m_activeStep--;
    }

    private void GoToStep(int step)
    {
        // Only allow going back to previous steps
        if (step < this.m_activeStep)
            this.m_activeStep = step;
    }

    private async Task OpenCreateRenterDialog()
    {
        var renter = new Renter { ShopId = this.ShopId };

        var result = await this.DialogService
            .Create<RenterDialog>(this.CommonLocalizer["AddRenter"])
            .WithParameter(x => x.Entity, renter)
            .WithParameter(x => x.IsNew, true)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            this.m_selectedRenter = renter;
            this.ShowSuccess(this.Localizer["RenterCreatedSuccess"]);
        }
    }

    private async Task CompleteCheckIn()
    {
        if (this.m_selectedRenter == null || this.m_selectedVehicle == null)
        {
            this.ShowError(this.Localizer["ValidationError"]);
            return;
        }

        this.m_processing = true;
        try
        {
            var request = new CheckInRequest
            {
                ShopId = this.ShopId,
                RenterId = this.m_selectedRenter.RenterId,
                VehicleId = this.m_selectedVehicle.VehicleId,
                SignatureImagePath = null, // Physical signature collected on printed agreement
                SignedByIp = "127.0.0.1",
                // Payment info
                PaymentMethod = this.m_depositInfo.PaymentMethod,
                PaymentTransactionRef = this.m_depositInfo.PaymentTransactionRef,
                // Deposit info
                DepositType = this.m_depositInfo.DepositType,
                DepositAmount = this.m_depositInfo.Amount,
                CardLast4 = this.m_depositInfo.CardLast4,
                TransactionRef = this.m_depositInfo.TransactionRef
            };

            if (this.IsIntervalRental)
            {
                // Interval rental (jet ski)
                request.DurationType = RentalDurationType.FixedInterval;
                request.StartDate = this.m_intervalConfig.StartDateTime;
                request.ExpectedEndDate = this.m_intervalConfig.EndDateTime;
                request.IntervalMinutes = this.m_intervalConfig.IntervalMinutes;
                request.RentalRate = this.m_intervalConfig.RentalRate;
                request.TotalAmount = this.m_intervalConfig.TotalAmount;
            }
            else
            {
                // Daily rental
                request.DurationType = RentalDurationType.Daily;
                request.StartDate = this.m_rentalConfig.StartDate;
                request.ExpectedEndDate = this.m_rentalConfig.EndDate;
                request.MileageStart = this.m_selectedVehicle.Mileage ?? 0;
                request.RentalRate = this.m_selectedVehicle.DailyRate;
                request.TotalAmount = this.m_rentalConfig.TotalAmount;
                request.InsuranceId = this.m_rentalConfig.SelectedInsuranceId;
                request.IncludeDriver = this.m_rentalConfig.IncludeDriver;
                request.IncludeGuide = this.m_rentalConfig.IncludeGuide;
                request.DriverFee = this.m_rentalConfig.DriverTotal;
                request.GuideFee = this.m_rentalConfig.GuideTotal;
                request.Accessories = this.m_rentalConfig.SelectedAccessories
                    .Select(a => new AccessorySelection
                    {
                        AccessoryId = a.Accessory.AccessoryId,
                        Quantity = a.Quantity,
                        ChargedAmount = a.TotalAmount
                    }).ToList();
            }

            var result = await this.RentalService.CheckInAsync(request, this.UserName);

            if (result.Success)
            {
                this.ShowSuccess(this.GetLocalizedText("CheckInSuccess", result.RentalId));
                this.NavigationManager.NavigateTo("/rentals");
            }
            else
            {
                this.ShowError(this.GetLocalizedText("CheckInFailed", result.Message ?? "Unknown error"));
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoading", ex.Message]);
        }
        finally
        {
            this.m_processing = false;
        }
    }
}
