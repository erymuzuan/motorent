@page "/rentals/print-agreement"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits MotoRentComponentBase

@using MotoRent.Domain.Entities
@inject RenterService RenterService
@inject VehicleService VehicleService
@inject ShopService ShopService
@inject IJSRuntime JS

<style>
    @@media print {
        .no-print { display: none !important; }
        body { margin: 0; padding: 0; }
        .print-container { padding: 20px; }
    }

    .print-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        line-height: 1.4;
    }

    .agreement-header {
        text-align: center;
        border-bottom: 2px solid #000;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }

    .agreement-header h1 {
        margin: 0 0 5px 0;
        font-size: 20px;
        text-transform: uppercase;
    }

    .agreement-header p {
        margin: 0;
        color: #666;
    }

    .info-section {
        margin-bottom: 20px;
    }

    .info-section h3 {
        font-size: 14px;
        margin: 0 0 10px 0;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px dotted #ddd;
        padding: 3px 0;
    }

    .info-label {
        color: #666;
    }

    .info-value {
        font-weight: bold;
    }

    .terms-section {
        margin-bottom: 20px;
        page-break-inside: avoid;
    }

    .terms-section h3 {
        font-size: 14px;
        margin: 0 0 10px 0;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
    }

    .terms-text {
        font-size: 11px;
        line-height: 1.5;
        white-space: pre-line;
        background-color: #f9f9f9;
        padding: 15px;
        border: 1px solid #ddd;
    }

    .signature-section {
        margin-top: 30px;
        page-break-inside: avoid;
    }

    .signature-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-top: 20px;
    }

    .signature-box {
        border: 1px solid #000;
        padding: 20px;
        min-height: 100px;
    }

    .signature-line {
        border-bottom: 1px solid #000;
        margin-bottom: 10px;
        height: 60px;
    }

    .signature-label {
        text-align: center;
        font-size: 11px;
        color: #666;
    }

    .date-line {
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .date-line span {
        flex-shrink: 0;
    }

    .date-line .date-blank {
        flex-grow: 1;
        border-bottom: 1px solid #000;
    }

    .total-amount {
        font-size: 16px;
        text-align: right;
        padding: 10px;
        background-color: #f0f0f0;
        margin-top: 15px;
    }

    .print-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>

<div class="no-print print-button">
    <button class="btn btn-primary" @onclick="Print">
        <i class="ti ti-printer me-2"></i>
        Print Agreement
    </button>
    <a href="/rentals/checkin" class="btn btn-outline-secondary ms-2">
        <i class="ti ti-arrow-left me-2"></i>
        Back to Check-In
    </a>
</div>

@if (m_loading)
{
    <div class="d-flex justify-content-center p-5">
        <div class="spinner-border"></div>
    </div>
}
else
{
    <div class="print-container">
        <div class="agreement-header">
            <h1>Vehicle Rental Agreement</h1>
            <p>@(m_shop?.Name ?? "MotoRent")</p>
            <p>Date: @DateTime.Now.ToString("dd MMM yyyy")</p>
        </div>

        <div class="info-section">
            <h3>Renter Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Name:</span>
                    <span class="info-value">@(m_renter?.FullName ?? "-")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone:</span>
                    <span class="info-value">@(m_renter?.Phone ?? "-")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Passport/ID:</span>
                    <span class="info-value">@(m_renter?.PassportNo ?? m_renter?.NationalIdNo ?? "-")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nationality:</span>
                    <span class="info-value">@(m_renter?.Nationality ?? "-")</span>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3>Vehicle Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Vehicle Type:</span>
                    <span class="info-value">@GetVehicleTypeLabel()</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Brand/Model:</span>
                    <span class="info-value">@(m_vehicle?.Brand) @(m_vehicle?.Model)</span>
                </div>
                <div class="info-item">
                    <span class="info-label">License Plate:</span>
                    <span class="info-value">@(m_vehicle?.LicensePlate ?? "-")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Color:</span>
                    <span class="info-value">@(m_vehicle?.Color ?? "-")</span>
                </div>
                @if (m_vehicle?.Mileage.HasValue == true && m_vehicle.Mileage > 0)
                {
                    <div class="info-item">
                        <span class="info-label">Mileage at Start:</span>
                        <span class="info-value">@m_vehicle.Mileage.Value.ToString("N0") km</span>
                    </div>
                }
            </div>
        </div>

        <div class="info-section">
            <h3>Rental Details</h3>
            <div class="info-grid">
                @if (m_isIntervalRental)
                {
                    <div class="info-item">
                        <span class="info-label">Duration:</span>
                        <span class="info-value">@GetIntervalLabel()</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Start Time:</span>
                        <span class="info-value">@m_startTime?.ToString("dd MMM yyyy HH:mm")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rate:</span>
                        <span class="info-value">@FormatCurrency(m_rate)</span>
                    </div>
                }
                else
                {
                    <div class="info-item">
                        <span class="info-label">Start Date:</span>
                        <span class="info-value">@m_startDate?.ToString("dd MMM yyyy")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">End Date:</span>
                        <span class="info-value">@m_endDate?.ToString("dd MMM yyyy")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Duration:</span>
                        <span class="info-value">@m_days day(s)</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Daily Rate:</span>
                        <span class="info-value">@FormatCurrency(m_vehicle?.DailyRate ?? 0)</span>
                    </div>
                }
                <div class="info-item">
                    <span class="info-label">Deposit Type:</span>
                    <span class="info-value">@m_depositType</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Deposit Amount:</span>
                    <span class="info-value">@FormatCurrency(m_depositAmount)</span>
                </div>
            </div>
            <div class="total-amount">
                <strong>Total Amount: @FormatCurrency(m_totalAmount)</strong>
            </div>
        </div>

        <div class="terms-section">
            <h3>Terms & Conditions</h3>
            <div class="terms-text">@m_agreementText</div>
        </div>

        <div class="signature-section">
            <h3>Signatures</h3>
            <p style="font-size: 11px; color: #666; margin-bottom: 15px;">
                By signing below, both parties acknowledge that they have read, understood, and agree to all terms and conditions stated in this agreement.
            </p>
            <div class="signature-grid">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-label">Renter's Signature</div>
                    <div class="date-line">
                        <span>Date:</span>
                        <div class="date-blank"></div>
                    </div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-label">Shop Representative's Signature</div>
                    <div class="date-line">
                        <span>Date:</span>
                        <div class="date-blank"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px; font-size: 10px; color: #999; text-align: center; border-top: 1px solid #ddd; padding-top: 10px;">
            @if (m_shop != null)
            {
                <p>@m_shop.Name | @m_shop.Address | @m_shop.Phone</p>
            }
            <p>Agreement generated on @DateTime.Now.ToString("dd MMM yyyy HH:mm")</p>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public int? RenterId { get; set; }
    [SupplyParameterFromQuery] public int? VehicleId { get; set; }
    [SupplyParameterFromQuery] public int? Interval { get; set; }
    [SupplyParameterFromQuery] public string? StartTime { get; set; }
    [SupplyParameterFromQuery] public decimal? Rate { get; set; }
    [SupplyParameterFromQuery] public decimal? Total { get; set; }
    [SupplyParameterFromQuery] public string? StartDate { get; set; }
    [SupplyParameterFromQuery] public string? EndDate { get; set; }
    [SupplyParameterFromQuery] public int? Days { get; set; }
    [SupplyParameterFromQuery] public string? DepositType { get; set; }
    [SupplyParameterFromQuery] public decimal? DepositAmount { get; set; }

    private bool m_loading = true;
    private Renter? m_renter;
    private Vehicle? m_vehicle;
    private Shop? m_shop;

    private bool m_isIntervalRental;
    private DateTimeOffset? m_startTime;
    private DateTime? m_startDate;
    private DateTime? m_endDate;
    private int m_days;
    private decimal m_rate;
    private decimal m_totalAmount;
    private string m_depositType = "-";
    private decimal m_depositAmount;

    private string m_agreementText = @"VEHICLE RENTAL AGREEMENT

I, the undersigned renter, agree to the following terms and conditions:

1. VEHICLE CONDITION: I acknowledge that I have received the vehicle in good working condition and agree to return it in the same condition.

2. LIABILITY: I am fully responsible for any damage, loss, or theft of the vehicle during the rental period, including but not limited to accidents, scratches, dents, and mechanical damage.

3. INSURANCE: Any insurance coverage is subject to the terms of the selected insurance package. I understand the deductible and coverage limits.

4. VALID LICENSE: I confirm that I hold a valid license appropriate for this vehicle type and will carry it at all times while operating the vehicle.

5. TRAFFIC LAWS: I agree to follow all applicable laws and regulations of Thailand. I am responsible for all violations and fines incurred during the rental period.

6. NO SUB-RENTAL: I will not lend, sub-rent, or allow any unauthorized person to operate the vehicle.

7. FUEL: I will return the vehicle with the same fuel level as at pick-up, or pay the refueling charge (if applicable).

8. LATE RETURN: If I fail to return the vehicle by the agreed date/time, I will pay additional rental charges plus any late fees.

9. DEPOSIT: I understand that my deposit may be used to cover any damages, additional charges, or unpaid fees.

10. EMERGENCY: In case of accident or breakdown, I will immediately contact the rental shop at the provided number.

11. SAFETY: I agree to wear appropriate safety equipment as required (helmets, life jackets, etc.) and follow all safety instructions provided.";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            m_loading = true;

            // Load renter
            if (this.RenterId.HasValue)
            {
                m_renter = await this.RenterService.GetRenterByIdAsync(this.RenterId.Value);
            }

            // Load vehicle
            if (this.VehicleId.HasValue)
            {
                m_vehicle = await this.VehicleService.GetVehicleByIdAsync(this.VehicleId.Value);
            }

            // Load shop
            m_shop = await this.ShopService.GetShopByIdAsync(this.ShopId);

            // Set rental parameters
            m_isIntervalRental = this.Interval.HasValue && this.Interval > 0;
            if (!string.IsNullOrEmpty(this.StartTime) && DateTimeOffset.TryParse(this.StartTime, out var startTime))
                m_startTime = startTime;
            if (!string.IsNullOrEmpty(this.StartDate) && DateTime.TryParse(this.StartDate, out var startDate))
                m_startDate = startDate;
            if (!string.IsNullOrEmpty(this.EndDate) && DateTime.TryParse(this.EndDate, out var endDate))
                m_endDate = endDate;
            m_days = this.Days ?? 1;
            m_rate = this.Rate ?? 0;
            m_totalAmount = this.Total ?? 0;
            m_depositType = this.DepositType ?? "-";
            m_depositAmount = this.DepositAmount ?? 0;
        }
        finally
        {
            m_loading = false;
        }
    }

    private string GetVehicleTypeLabel()
    {
        if (m_vehicle == null) return "-";
        return m_vehicle.VehicleType switch
        {
            VehicleType.Motorbike => "Motorbike",
            VehicleType.Car => "Car",
            VehicleType.JetSki => "Jet Ski",
            VehicleType.Boat => "Boat",
            VehicleType.Van => "Van",
            _ => "Vehicle"
        };
    }

    private string GetIntervalLabel()
    {
        if (!this.Interval.HasValue) return "-";
        return this.Interval.Value switch
        {
            15 => "15 minutes",
            30 => "30 minutes",
            60 => "1 hour",
            _ => $"{this.Interval.Value} minutes"
        };
    }

    private async Task Print()
    {
        await this.JS.InvokeVoidAsync("window.print");
    }
}
