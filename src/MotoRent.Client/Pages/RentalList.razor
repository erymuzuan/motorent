@page "/rentals"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Client.Pages.Rentals
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<RentalList>
@inject RentalService RentalService
@inject RenterService RenterService
@inject VehicleService VehicleService

<MotoRentPageTitle>Rentals</MotoRentPageTitle>

<TablerHeader Title="Rentals" PreTitle="Operations">
    <a href="/rentals/checkin" class="btn btn-primary">
        <i class="ti ti-plus me-1"></i>
        New Check-In
    </a>
</TablerHeader>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn @(m_activeTab == "Active" ? "btn-primary" : "btn-outline-primary")"
                            @onclick="@(() => SetActiveTab("Active"))">
                        Active @(m_statusCounts.GetValueOrDefault("Active", 0))
                    </button>
                    <button type="button" class="btn @(m_activeTab == "DueToday" ? "btn-warning" : (m_dueTodayCount > 0 ? "btn-outline-warning" : "btn-outline-secondary"))"
                            @onclick="@(() => SetActiveTab("DueToday"))">
                        Due Today @m_dueTodayCount
                    </button>
                    <button type="button" class="btn @(m_activeTab == "Overdue" ? "btn-danger" : (m_overdueCount > 0 ? "btn-outline-danger" : "btn-outline-secondary"))"
                            @onclick="@(() => SetActiveTab("Overdue"))">
                        Overdue @m_overdueCount
                    </button>
                    <button type="button" class="btn @(m_activeTab == "Completed" ? "btn-success" : "btn-outline-success")"
                            @onclick="@(() => SetActiveTab("Completed"))">
                        Completed @(m_statusCounts.GetValueOrDefault("Completed", 0))
                    </button>
                    <button type="button" class="btn @(m_activeTab == "All" ? "btn-dark" : "btn-outline-dark")"
                            @onclick="@(() => SetActiveTab("All"))">
                        All
                    </button>
                </div>
            </div>
            <div class="col-auto ms-auto">
                <div class="input-icon">
                    <span class="input-icon-addon">
                        <i class="ti ti-search"></i>
                    </span>
                    <input type="text" class="form-control" placeholder="Search renter, vehicle..."
                           @bind="m_searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
                </div>
            </div>
        </div>
    </div>
</div>

<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table" Rows="10" Columns="7">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Renter</th>
                        <th>Vehicle</th>
                        <th>Period</th>
                        <th>Days</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th class="w-1">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (m_filteredRentals.Count == 0)
                    {
                        <tr>
                            <td colspan="7" class="text-center text-secondary py-4">
                                <i class="ti ti-car mb-2" style="font-size: 2rem;"></i>
                                <div>No rentals found</div>
                                <a href="/rentals/checkin" class="btn btn-outline-primary btn-sm mt-2">
                                    Create New Check-In
                                </a>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var rental in m_filteredRentals)
                        {
                            <tr class="cursor-pointer" @onclick="@(() => ViewRentalDetails(rental))">
                                <td>
                                    <div class="fw-bold">@rental.RenterName</div>
                                    <small class="text-secondary">@rental.RenterPhone</small>
                                </td>
                                <td>
                                    <div>@rental.VehicleBrandModel</div>
                                    <small class="text-primary">@rental.VehicleLicensePlate</small>
                                </td>
                                <td>
                                    <div>@FormatDate(rental.Rental.StartDate)</div>
                                    <small class="text-secondary">to @FormatDate(rental.Rental.ExpectedEndDate)</small>
                                </td>
                                <td>@rental.Days</td>
                                <td class="text-primary fw-bold">@FormatCurrency(rental.Rental.TotalAmount)</td>
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge @GetStatusBadgeClass(rental.Rental.Status)">
                                            @rental.Rental.Status
                                        </span>
                                        @if (rental.IsOverdue)
                                        {
                                            <span class="badge bg-danger-lt">@rental.DaysOverdue day(s) overdue</span>
                                        }
                                        else if (rental.IsDueToday)
                                        {
                                            <span class="badge bg-warning-lt">Due Today</span>
                                        }
                                    </div>
                                </td>
                                <td @onclick:stopPropagation="true">
                                    <div class="btn-list flex-nowrap">
                                        @if (rental.Rental.Status == "Active")
                                        {
                                            <button type="button" class="btn btn-icon btn-ghost-success" title="Check Out"
                                                    @onclick="@(() => OpenCheckOutDialog(rental))">
                                                <i class="ti ti-logout"></i>
                                            </button>
                                            <button type="button" class="btn btn-icon btn-ghost-warning" title="Extend"
                                                    @onclick="@(() => ExtendRental(rental))">
                                                <i class="ti ti-calendar-plus"></i>
                                            </button>
                                        }
                                        @if (rental.Rental.Status == "Reserved")
                                        {
                                            <button type="button" class="btn btn-icon btn-ghost-primary" title="Start Rental"
                                                    @onclick="@(() => StartRental(rental))">
                                                <i class="ti ti-player-play"></i>
                                            </button>
                                        }
                                        @if (rental.Rental.Status is "Active" or "Reserved")
                                        {
                                            <button type="button" class="btn btn-icon btn-ghost-danger" title="Cancel"
                                                    @onclick="@(() => CancelRental(rental))">
                                                <i class="ti ti-x"></i>
                                            </button>
                                        }
                                        <button type="button" class="btn btn-icon btn-ghost-primary" title="View Invoice"
                                                @onclick="@(() => ViewInvoice(rental))">
                                            <i class="ti ti-receipt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        @if (m_filteredRentals.Count > 0)
        {
            <div class="card-footer d-flex align-items-center">
                <p class="m-0 text-secondary">
                    Showing <strong>@m_filteredRentals.Count</strong> rentals
                </p>
            </div>
        }
    </div>
</LoadingSkeleton>

@code {
    private List<RentalViewModel> m_rentals = [];
    private List<RentalViewModel> m_filteredRentals = [];
    private Dictionary<string, int> m_statusCounts = new();
    private int m_dueTodayCount;
    private int m_overdueCount;
    private bool m_loading = true;
    private string? m_searchTerm;
    private string m_activeTab = "Active";
    private System.Timers.Timer? m_debounceTimer;

    private Dictionary<int, Renter> m_renterCache = new();
    private Dictionary<int, Vehicle> m_vehicleCache = new();

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        this.m_loading = true;
        try
        {
            var result = await this.RentalService.GetRentalsAsync(this.ShopId, page: 1, pageSize: 1000);
            var rentals = result.ItemCollection;

            var renterIds = rentals.Select(r => r.RenterId).Distinct().ToList();
            foreach (var renterId in renterIds.Where(id => !this.m_renterCache.ContainsKey(id)))
            {
                var renter = await this.DataContext.LoadOneAsync<Renter>(r => r.RenterId == renterId);
                if (renter != null)
                    this.m_renterCache[renterId] = renter;
            }

            var vehicleIds = rentals.Select(r => r.VehicleId).Distinct().ToList();
            foreach (var vehicleId in vehicleIds.Where(id => !this.m_vehicleCache.ContainsKey(id)))
            {
                var vehicle = await this.DataContext.LoadOneAsync<Vehicle>(v => v.VehicleId == vehicleId);
                if (vehicle != null)
                    this.m_vehicleCache[vehicleId] = vehicle;
            }

            var today = DateTimeOffset.Now.Date;
            this.m_rentals = rentals.Select(r => new RentalViewModel
            {
                Rental = r,
                RenterName = this.m_renterCache.TryGetValue(r.RenterId, out var renter) ? renter.FullName ?? "" : "Unknown",
                RenterPhone = this.m_renterCache.TryGetValue(r.RenterId, out var renter2) ? renter2.Phone ?? "" : "",
                VehicleBrandModel = this.m_vehicleCache.TryGetValue(r.VehicleId, out var vehicle) ? $"{vehicle.Brand} {vehicle.Model}" : "Unknown",
                VehicleLicensePlate = this.m_vehicleCache.TryGetValue(r.VehicleId, out var vehicle2) ? vehicle2.LicensePlate ?? "" : "",
                Days = (int)(r.ExpectedEndDate.Date - r.StartDate.Date).TotalDays + 1,
                IsDueToday = r.Status == "Active" && r.ExpectedEndDate.Date == today,
                IsOverdue = r.Status == "Active" && r.ExpectedEndDate.Date < today,
                DaysOverdue = r.Status == "Active" && r.ExpectedEndDate.Date < today
                    ? (int)(today - r.ExpectedEndDate.Date).TotalDays
                    : 0
            }).ToList();

            this.m_statusCounts = this.m_rentals
                .GroupBy(r => r.Rental.Status ?? "Unknown")
                .ToDictionary(g => g.Key, g => g.Count());

            this.m_dueTodayCount = this.m_rentals.Count(r => r.IsDueToday);
            this.m_overdueCount = this.m_rentals.Count(r => r.IsOverdue);

            this.ApplyFilter();
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading data: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private void ApplyFilter()
    {
        var filtered = this.m_activeTab switch
        {
            "Active" => this.m_rentals.Where(r => r.Rental.Status == "Active"),
            "DueToday" => this.m_rentals.Where(r => r.IsDueToday),
            "Overdue" => this.m_rentals.Where(r => r.IsOverdue),
            "Completed" => this.m_rentals.Where(r => r.Rental.Status == "Completed"),
            "Reserved" => this.m_rentals.Where(r => r.Rental.Status == "Reserved"),
            "Cancelled" => this.m_rentals.Where(r => r.Rental.Status == "Cancelled"),
            _ => this.m_rentals
        };

        if (!string.IsNullOrWhiteSpace(this.m_searchTerm))
        {
            var term = this.m_searchTerm.ToLowerInvariant();
            filtered = filtered.Where(r =>
                r.RenterName.ToLowerInvariant().Contains(term) ||
                r.VehicleBrandModel.ToLowerInvariant().Contains(term) ||
                r.VehicleLicensePlate.ToLowerInvariant().Contains(term));
        }

        this.m_filteredRentals = filtered.OrderByDescending(r => r.Rental.RentalId).ToList();
    }

    private void SetActiveTab(string tab)
    {
        this.m_activeTab = tab;
        this.ApplyFilter();
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        this.m_debounceTimer?.Stop();
        this.m_debounceTimer?.Dispose();
        this.m_debounceTimer = new System.Timers.Timer(300);
        this.m_debounceTimer.Elapsed += async (_, _) =>
        {
            this.m_debounceTimer?.Stop();
            await this.InvokeAsync(() =>
            {
                this.ApplyFilter();
                this.StateHasChanged();
            });
        };
        this.m_debounceTimer.Start();
    }

    private void ViewRentalDetails(RentalViewModel rental)
    {
        this.NavigationManager.NavigateTo($"/rentals/view/{rental.Rental.RentalId}");
    }

    private async Task ViewInvoice(RentalViewModel rental)
    {
        await this.DialogService
            .Create<InvoiceDialog>("Invoice")
            .WithParameter(x => x.RentalId, rental.Rental.RentalId)
            .Large()
            .ShowDialogAsync();
    }

    private async Task OpenCheckOutDialog(RentalViewModel rental)
    {
        var result = await this.DialogService
            .Create<CheckOutDialog>($"Check Out - {rental.RenterName}")
            .WithParameter(x => x.Entity, rental.Rental)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadDataAsync();
        }
    }

    private async Task ExtendRental(RentalViewModel rental)
    {
        if (!await this.DialogService.ConfirmAsync(
            $"Extend rental for {rental.RenterName} by 1 day?"))
            return;

        var newEndDate = rental.Rental.ExpectedEndDate.AddDays(1);
        var result = await this.RentalService.ExtendRentalAsync(rental.Rental.RentalId, newEndDate, this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess("Rental extended successfully");
        }
        else
        {
            this.ShowError($"Extension failed: {result.Message}");
        }
    }

    private async Task StartRental(RentalViewModel rental)
    {
        if (!await this.DialogService.ConfirmAsync(
            $"Start rental for {rental.RenterName}?"))
            return;

        rental.Rental.Status = "Active";
        var result = await this.RentalService.UpdateRentalAsync(rental.Rental, this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess("Rental started");
        }
        else
        {
            this.ShowError($"Failed to start rental: {result.Message}");
        }
    }

    private async Task CancelRental(RentalViewModel rental)
    {
        if (!await this.DialogService.ConfirmYesNoAsync(
            $"Cancel rental for {rental.RenterName}? The deposit will be refunded.",
            "Cancel Rental"))
            return;

        var result = await this.RentalService.CancelRentalAsync(rental.Rental.RentalId, "Cancelled by user", this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess("Rental cancelled and deposit refunded");
        }
        else
        {
            this.ShowError($"Cancellation failed: {result.Message}");
        }
    }

    private static string GetStatusBadgeClass(string? status) => status switch
    {
        "Active" => "bg-primary",
        "Reserved" => "bg-info",
        "Completed" => "bg-success",
        "Cancelled" => "bg-danger",
        _ => "bg-secondary"
    };

    public void Dispose()
    {
        this.m_debounceTimer?.Dispose();
    }

    public class RentalViewModel
    {
        public Rental Rental { get; set; } = null!;
        public string RenterName { get; set; } = "";
        public string RenterPhone { get; set; } = "";
        public string VehicleBrandModel { get; set; } = "";
        public string VehicleLicensePlate { get; set; } = "";
        public int Days { get; set; }
        public bool IsDueToday { get; set; }
        public bool IsOverdue { get; set; }
        public int DaysOverdue { get; set; }
    }
}
