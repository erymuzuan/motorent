@page "/rentals"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Client.Pages.Rentals
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<RentalList>
@inject RentalService RentalService
@inject RenterService RenterService
@inject VehicleService VehicleService

<MotoRentPageTitle>@Localizer["PageTitle"]</MotoRentPageTitle>

<div class="rentals-page mr-theme-transition">
    @* Hero Header with Quick Stats *@
    <div class="rental-header mb-4">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1 class="page-title mb-1">@Localizer["Header"]</h1>
                <p class="mr-text-secondary mb-0">@Localizer["SubHeader"]</p>
            </div>
            <a href="/rentals/checkin" class="mr-btn-primary-action">
                <i class="ti ti-plus"></i>
                @Localizer["NewCheckIn"]
            </a>
        </div>
    </div>

    @* Quick Stats Cards *@
    <div class="mr-summary-cards mr-animate-in mr-animate-delay-1">
        <div class="mr-summary-card @(m_activeTab == "Active" ? "active" : "")" style="cursor:pointer" @onclick="@(() => SetActiveTab("Active"))">
            <div class="mr-summary-icon total">
                <i class="ti ti-motorbike"></i>
            </div>
            <div class="mr-summary-content">
                <h4>@Localizer["Active"]</h4>
                <div class="mr-value">@(m_statusCounts.GetValueOrDefault("Active", 0))</div>
            </div>
        </div>
        <div class="mr-summary-card @(m_activeTab == "DueToday" ? "active" : "")" style="cursor:pointer" @onclick="@(() => SetActiveTab("DueToday"))">
            <div class="mr-summary-icon pending">
                <i class="ti ti-clock-hour-4"></i>
            </div>
            <div class="mr-summary-content">
                <h4>@Localizer["DueToday"]</h4>
                <div class="mr-value">@m_dueTodayCount</div>
            </div>
        </div>
        <div class="mr-summary-card @(m_activeTab == "Overdue" ? "active" : "")" style="cursor:pointer" @onclick="@(() => SetActiveTab("Overdue"))">
            <div class="mr-summary-icon danger">
                <i class="ti ti-alert-triangle"></i>
            </div>
            <div class="mr-summary-content">
                <h4>@Localizer["Overdue"]</h4>
                <div class="mr-value">@m_overdueCount</div>
            </div>
        </div>
        <div class="mr-summary-card @(m_activeTab == "Completed" ? "active" : "")" style="cursor:pointer" @onclick="@(() => SetActiveTab("Completed"))">
            <div class="mr-summary-icon success">
                <i class="ti ti-circle-check"></i>
            </div>
            <div class="mr-summary-content">
                <h4>@Localizer["Completed"]</h4>
                <div class="mr-value">@(m_statusCounts.GetValueOrDefault("Completed", 0))</div>
            </div>
        </div>
    </div>

    @* Search Bar *@
    <div class="mr-search-box mb-4 mr-animate-in mr-animate-delay-2" style="max-width:100%">
        <i class="ti ti-search"></i>
        <input type="text"
               placeholder="@Localizer["SearchPlaceholder"]"
               @bind="m_searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp" />
    </div>

    @* Filter Tabs *@
    <div class="d-flex gap-3 mb-4 flex-wrap align-items-center mr-animate-in mr-animate-delay-2">
        <div class="mr-filter-tabs">
            <button type="button" class="mr-filter-tab @(m_activeTab == "All" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("All"))">
                @Localizer["All"]
            </button>
            <button type="button" class="mr-filter-tab @(m_activeTab == "Active" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("Active"))">
                <i class="ti ti-motorbike me-1"></i>
                @Localizer["Active"]
            </button>
            <button type="button" class="mr-filter-tab @(m_activeTab == "DueToday" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("DueToday"))">
                <i class="ti ti-clock me-1"></i>
                @Localizer["DueToday"]
            </button>
            <button type="button" class="mr-filter-tab @(m_activeTab == "Overdue" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("Overdue"))">
                <i class="ti ti-alert-triangle me-1"></i>
                @Localizer["Overdue"]
            </button>
            <button type="button" class="mr-filter-tab @(m_activeTab == "Completed" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("Completed"))">
                <i class="ti ti-check me-1"></i>
                @Localizer["Completed"]
            </button>
        </div>
    </div>

    @* Rental Cards *@
    <LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Card" Rows="4">
        @if (m_filteredRentals.Count == 0)
        {
            <div class="mr-empty-state mr-animate-in mr-animate-delay-3">
                <div class="mr-empty-state-icon">
                    <i class="ti ti-motorbike"></i>
                </div>
                <h3>@Localizer["NoRentalsFound"]</h3>
                <p>@GetEmptyStateMessage()</p>
                <a href="/rentals/checkin" class="mr-btn-primary-action">
                    <i class="ti ti-plus"></i>
                    @Localizer["CreateNewCheckIn"]
                </a>
            </div>
        }
        else
        {
            <div class="d-flex flex-column gap-3">
                @{ var delay = 2; }
                @foreach (var rental in m_filteredRentals)
                {
                    <div class="mr-card mr-animate-in mr-animate-delay-@(Math.Min(delay++, 4))" @onclick="@(() => ViewRentalDetails(rental))" style="cursor:pointer">
                        @* Card Header *@
                        <div class="mr-card-header">
                            <div class="d-flex align-items-center gap-3">
                                <span class="mr-card-id">R@rental.Rental.RentalId.ToString("D5")</span>
                                <span class="mr-card-date">
                                    <i class="ti ti-calendar"></i>
                                    @FormatDateShort(rental.Rental.StartDate)
                                </span>
                                @if (rental.IsOverdue)
                                {
                                    <span class="mr-status-badge danger">
                                        <i class="ti ti-alert-triangle"></i>
                                        @Localizer["OverdueLabel", rental.DaysOverdue]
                                    </span>
                                }
                                else if (rental.IsDueToday)
                                {
                                    <span class="mr-status-badge pending">
                                        <i class="ti ti-clock"></i>
                                        @Localizer["DueToday"]
                                    </span>
                                }
                                else
                                {
                                    <span class="mr-status-badge @GetStatusBadgeClass(rental)">
                                        <i class="ti @GetStatusIcon(rental)"></i>
                                        @Localizer[rental.Rental.Status ?? ""]
                                    </span>
                                }
                            </div>
                            <div class="mr-card-amount">@FormatCurrency(rental.Rental.TotalAmount)</div>
                        </div>

                        @* Card Body *@
                        <div class="mr-card-body">
                            <div class="mr-field-grid">
                                <div class="mr-field">
                                    <span class="mr-field-label">@Localizer["Renter"]</span>
                                    <span class="mr-field-value">@rental.RenterName</span>
                                </div>
                                <div class="mr-field">
                                    <span class="mr-field-label">@Localizer["Vehicle"]</span>
                                    <span class="mr-field-value">@rental.VehicleBrandModel</span>
                                </div>
                                <div class="mr-field">
                                    <span class="mr-field-label">@Localizer["LicensePlate"]</span>
                                    <span class="mr-field-value mr-mono mr-highlight">@rental.VehicleLicensePlate</span>
                                </div>
                                <div class="mr-field">
                                    <span class="mr-field-label">@Localizer["Duration"]</span>
                                    <span class="mr-field-value">@rental.Days @Localizer["Days"]</span>
                                </div>
                            </div>
                        </div>

                        @* Card Footer *@
                        <div class="mr-card-footer" @onclick:stopPropagation="true">
                            <div class="mr-note-preview">
                                <i class="ti ti-calendar-event"></i>
                                <span>@FormatDateShort(rental.Rental.StartDate) - @FormatDateShort(rental.Rental.ExpectedEndDate)</span>
                            </div>
                            <div class="d-flex gap-2">
                                @if (rental.Rental.Status == "Active")
                                {
                                    <button type="button" class="mr-btn-action success" @onclick="@(() => OpenCheckOutDialog(rental))">
                                        <i class="ti ti-logout"></i>
                                        @Localizer["CheckOut"]
                                    </button>
                                }
                                <a href="/rentals/view/@EncodeId(rental.Rental.RentalId)" class="mr-btn-action view">
                                    <i class="ti ti-eye"></i>
                                    @Localizer["View"]
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="text-center mr-text-muted py-3">
                @Localizer["ShowingRentals", m_filteredRentals.Count]
            </div>
        }
    </LoadingSkeleton>
</div>

<style>
    .rentals-page {
        padding: 1rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--mr-text-primary);
    }

    /* Active state for summary cards */
    .mr-summary-card.active {
        border-color: var(--mr-accent-primary);
        border-width: 2px;
    }
</style>

@code {
    private List<RentalViewModel> m_rentals = [];
    private List<RentalViewModel> m_filteredRentals = [];
    private Dictionary<string, int> m_statusCounts = new();
    private int m_dueTodayCount;
    private int m_overdueCount;
    private bool m_loading = true;
    private string? m_searchTerm;
    private string m_activeTab = "Active";
    private string? m_statusFilter = "Active";
    private int m_currentPage = 1;
    private int m_pageSize = 20;
    private int m_totalCount;
    private int m_totalPages;
    private System.Timers.Timer? m_debounceTimer;

    private Dictionary<int, Renter> m_renterCache = new();
    private Dictionary<int, Vehicle> m_vehicleCache = new();

    private async Task SetActiveTab(string tab)
    {
        m_activeTab = tab;
        m_statusFilter = tab == "All" ? null : tab;
        m_currentPage = 1;
        await LoadDataAsync();
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        m_debounceTimer?.Stop();
        m_debounceTimer?.Dispose();
        m_debounceTimer = new System.Timers.Timer(300);
        m_debounceTimer.Elapsed += async (_, _) =>
        {
            m_debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                m_currentPage = 1;
                await LoadDataAsync();
                StateHasChanged();
            });
        };
        m_debounceTimer.Start();
    }

    private async Task ClearSearch()
    {
        m_searchTerm = null;
        m_currentPage = 1;
        await LoadDataAsync();
    }

    private void ViewRentalDetails(RentalViewModel rental)
    {
        NavigationManager.NavigateTo($"/rentals/view/{EncodeId(rental.Rental.RentalId)}");
    }

    private static string GetStatusBadgeClass(RentalViewModel rental)
    {
        return rental.Rental.Status switch
        {
            "Active" => "info",
            "Reserved" => "pending",
            "Completed" => "success",
            "Cancelled" => "danger",
            _ => "pending"
        };
    }

    private static string GetStatusIcon(RentalViewModel rental)
    {
        return rental.Rental.Status switch
        {
            "Active" => "ti-motorbike",
            "Reserved" => "ti-clock",
            "Completed" => "ti-circle-check",
            "Cancelled" => "ti-x",
            _ => "ti-clock"
        };
    }


    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        this.m_loading = true;
        try
        {
            var result = await this.RentalService.GetRentalsAsync(
                this.ShopId,
                m_statusFilter,
                m_searchTerm,
                page: m_currentPage,
                pageSize: m_pageSize);

            m_rentals.Clear();
            foreach (var rental in result.ItemCollection)
            {
                m_rentals.Add(new RentalViewModel(rental));
            }
            m_filteredRentals = m_rentals.ToList();
            m_totalCount = result.TotalRows;
            m_totalPages = result.TotalPages;

            // Load status counts
            m_statusCounts = await this.RentalService.GetStatusCountsAsync(this.ShopId);
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoadingData", ex.Message]);
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task ViewInvoice(RentalViewModel rental)
    {
        await this.DialogService
            .Create<InvoiceDialog>(Localizer["Invoice"])
            .WithParameter(x => x.RentalId, rental.Rental.RentalId)
            .Large()
            .ShowDialogAsync();
    }

    private async Task OpenCheckOutDialog(RentalViewModel rental)
    {
        var result = await this.DialogService
            .Create<CheckOutDialog>($"{Localizer["CheckOut"]} - {rental.RenterName}")
            .WithParameter(x => x.Entity, rental.Rental)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadDataAsync();
        }
    }

    private async Task ExtendRental(RentalViewModel rental)
    {
        if (!await this.DialogService.ConfirmAsync(
            Localizer["ConfirmExtend", rental.RenterName]))
            return;

        var newEndDate = rental.Rental.ExpectedEndDate.AddDays(1);
        var result = await this.RentalService.ExtendRentalAsync(rental.Rental.RentalId, newEndDate, this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(Localizer["ExtendSuccess"]);
        }
        else
        {
            this.ShowError(Localizer["ExtendFailed", result.Message ?? ""]);
        }
    }

    private async Task StartRental(RentalViewModel rental)
    {
        if (!await this.DialogService.ConfirmAsync(
            Localizer["ConfirmStart", rental.RenterName]))
            return;

        rental.Rental.Status = "Active";
        var result = await this.RentalService.UpdateRentalAsync(rental.Rental, this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(Localizer["StartSuccess"]);
        }
        else
        {
            this.ShowError(Localizer["StartFailed", result.Message ?? ""]);
        }
    }

    private async Task CancelRental(RentalViewModel rental)
    {
        if (!await this.DialogService.ConfirmYesNoAsync(
            Localizer["ConfirmCancel", rental.RenterName],
            Localizer["CancelRentalTitle"]))
            return;

        var result = await this.RentalService.CancelRentalAsync(rental.Rental.RentalId, "Cancelled by user", this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(Localizer["CancelSuccess"]);
        }
        else
        {
            this.ShowError(Localizer["CancelFailed", result.Message ?? ""]);
        }
    }

    private string GetEmptyStateMessage()
    {
        return this.m_activeTab switch
        {
            "Active" => Localizer["EmptyStateActive"],
            "DueToday" => Localizer["EmptyStateDueToday"],
            "Overdue" => Localizer["EmptyStateOverdue"],
            "Completed" => Localizer["EmptyStateCompleted"],
            _ => Localizer["EmptyStateDefault"]
        };
    }

    private string FormatDateShort(DateTimeOffset date) => date.ToString("MMM d");

    public void Dispose()
    {
        this.m_debounceTimer?.Dispose();
    }

    public class RentalViewModel
    {
        public RentalViewModel() { }
        public RentalViewModel(Rental rental)
        {
            Rental = rental;
            RenterName = rental.RenterName ?? "Unknown";
            VehicleBrandModel = rental.VehicleName ?? "Unknown Vehicle";
            var today = DateTimeOffset.Now.Date;
            Days = Math.Max(1, (int)(rental.ExpectedEndDate.Date - rental.StartDate.Date).TotalDays + 1);
            IsDueToday = rental.ExpectedEndDate.Date == today && rental.Status == "Active";
            IsOverdue = rental.ExpectedEndDate.Date < today && rental.Status == "Active";
            DaysOverdue = IsOverdue ? (int)(today - rental.ExpectedEndDate.Date).TotalDays : 0;
        }

        public Rental Rental { get; set; } = null!;
        public string RenterName { get; set; } = "";
        public string RenterPhone { get; set; } = "";
        public string VehicleBrandModel { get; set; } = "";
        public string VehicleLicensePlate { get; set; } = "";
        public int Days { get; set; }
        public bool IsDueToday { get; set; }
        public bool IsOverdue { get; set; }
        public int DaysOverdue { get; set; }
    }
}
