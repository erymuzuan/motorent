@page "/manager"
@page "/manager/dashboard"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantManager")]
@inherits MotoRentComponentBase

<PageTitle>Dashboard - MotoRent Manager</PageTitle>

<div class="container-xl py-4">
    @* Page Header *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title mb-0">Dashboard</h2>
            <p class="text-secondary mb-0">Overview of your rental business performance</p>
        </div>
        <button type="button" class="btn btn-outline-primary">
            <i class="ti ti-download me-1"></i>
            Export Report
        </button>
    </div>

    @* KPI Metrics Row *@
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="Today's Revenue"
                Value="@m_todayRevenue.ToString("N0")"
                Prefix="฿"
                Icon="ti-cash"
                IconColor="success"
                ShowTrend="true"
                TrendPercent="12.5"
                TrendPeriod="yesterday" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="Active Rentals"
                Value="@m_activeRentals.ToString()"
                Icon="ti-motorbike"
                IconColor="primary"
                ShowTrend="true"
                TrendPercent="8.3"
                TrendPeriod="last week" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="Returns Today"
                Value="@m_returnsToday.ToString()"
                Icon="ti-logout"
                IconColor="warning"
                Subtitle="@($"{m_overdueCount} overdue")" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="Fleet Utilization"
                Value="@m_fleetUtilization.ToString("N0")"
                Suffix="%"
                Icon="ti-gauge"
                IconColor="info"
                ShowTrend="true"
                TrendPercent="-2.1"
                TrendPeriod="last week"
                TrendPositiveIsGood="true" />
        </div>
    </div>

    @* Charts Row *@
    <div class="row g-3 mb-4">
        @* Revenue Trend Chart *@
        <div class="col-12 col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Revenue Trend</h4>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn @(m_revenuePeriod == "7d" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetRevenuePeriod("7d"))">7 Days</button>
                            <button type="button" class="btn @(m_revenuePeriod == "30d" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetRevenuePeriod("30d"))">30 Days</button>
                            <button type="button" class="btn @(m_revenuePeriod == "90d" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetRevenuePeriod("90d"))">90 Days</button>
                        </div>
                    </div>
                    @* Chart placeholder - integrate with Chart.js or ApexCharts *@
                    <div class="chart-placeholder d-flex align-items-center justify-content-center" style="height: 300px; background: var(--tblr-bg-surface-secondary); border-radius: 8px;">
                        <div class="text-center text-secondary">
                            <i class="ti ti-chart-line mb-2" style="font-size: 2rem;"></i>
                            <div>Revenue Chart (@m_revenuePeriod)</div>
                            <small>Implement with Chart.js or ApexCharts</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Fleet Status Donut *@
        <div class="col-12 col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h4 class="card-title mb-3">Fleet Status</h4>
                    @* Simple status list instead of donut chart *@
                    <div class="d-flex flex-column gap-3">
                        @for (int i = 0; i < m_fleetStatusLabels.Length; i++)
                        {
                            var index = i;
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <div style="width: 12px; height: 12px; border-radius: 2px; background: @GetStatusColor(index);"></div>
                                        <span>@m_fleetStatusLabels[index]</span>
                                    </div>
                                    <span class="fw-semibold">@m_fleetStatusData[index]</span>
                                </div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar" style="width: @(m_fleetStatusData[index] / m_fleetStatusData.Sum() * 100)%; background-color: @GetStatusColor(index);"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Bottom Row - Top Bikes & Recent Activity *@
    <div class="row g-3 mb-4">
        @* Top Performing Bikes *@
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Top Performing Bikes</h4>
                        <a href="/manager/fleet" class="text-primary text-decoration-none">View All</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-vcenter table-sm">
                            <thead>
                                <tr>
                                    <th>Bike</th>
                                    <th class="text-end">Rentals</th>
                                    <th class="text-end">Revenue</th>
                                    <th class="text-end">Utilization</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var bike in m_topBikes)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-medium">@bike.Name</div>
                                            <small class="text-secondary">@bike.Plate</small>
                                        </td>
                                        <td class="text-end">@bike.RentalCount</td>
                                        <td class="text-end">@FormatCurrency(bike.Revenue)</td>
                                        <td class="text-end">
                                            <span class="badge @GetUtilizationBadgeClass(bike.Utilization)">
                                                @bike.Utilization%
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        @* Recent Activity *@
        <div class="col-12 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">Recent Activity</h4>
                        <button type="button" class="btn btn-icon btn-ghost-secondary" @onclick="RefreshActivity">
                            <i class="ti ti-refresh"></i>
                        </button>
                    </div>
                    <div class="timeline">
                        @foreach (var activity in m_recentActivities)
                        {
                            <div class="timeline-event">
                                <div class="timeline-event-icon @GetActivityBgClass(activity.ColorName)">
                                    <i class="ti ti-circle-check"></i>
                                </div>
                                <div class="card timeline-event-card">
                                    <div class="card-body p-2">
                                        <div class="small">@activity.Description</div>
                                        <small class="text-secondary">
                                            @FormatRelativeTime(activity.Time) by @activity.User
                                        </small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Alerts Section *@
    @if (m_alerts.Count > 0)
    {
        <div class="card">
            <div class="card-body">
                <h4 class="card-title mb-3">Alerts & Notifications</h4>
                <div class="d-flex flex-column gap-2">
                    @foreach (var alert in m_alerts)
                    {
                        <div class="alert @GetAlertClass(alert.Severity) mb-0">
                            @alert.Message
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 1.5rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--tblr-border-color);
    }

    .timeline-event {
        position: relative;
        margin-bottom: 1rem;
    }

    .timeline-event-icon {
        position: absolute;
        left: -1.5rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.5rem;
        color: white;
    }

    .timeline-event-card {
        margin-left: 0.5rem;
    }
</style>

@code {
    // KPI Data
    private decimal m_todayRevenue = 45600;
    private int m_activeRentals = 23;
    private int m_returnsToday = 8;
    private int m_overdueCount = 2;
    private decimal m_fleetUtilization = 72;

    // Chart Controls
    private string m_revenuePeriod = "7d";

    // Fleet Status Data
    private double[] m_fleetStatusData = [23, 12, 3, 2];
    private string[] m_fleetStatusLabels = ["Rented", "Available", "Maintenance", "Reserved"];

    // Top Bikes Data
    private List<TopBikeData> m_topBikes = [];

    // Recent Activity
    private List<ActivityItem> m_recentActivities = [];

    // Alerts
    private List<AlertItem> m_alerts = [];

    protected override void OnInitialized()
    {
        this.LoadDashboardData();
    }

    private void LoadDashboardData()
    {
        // Top bikes data (placeholder)
        this.m_topBikes =
        [
            new TopBikeData("Honda PCX 160", "กข 1234", 45, 67500, 92),
            new TopBikeData("Yamaha NMAX", "กค 5678", 38, 57000, 85),
            new TopBikeData("Honda Click 125", "กง 9012", 52, 46800, 78),
            new TopBikeData("Yamaha Aerox", "กจ 3456", 31, 43400, 72),
            new TopBikeData("Honda Wave 110", "กฉ 7890", 48, 38400, 68)
        ];

        // Recent activities (placeholder)
        var now = DateTime.Now;
        this.m_recentActivities =
        [
            new ActivityItem("Rental #1047 checked in - Honda PCX 160", now.AddMinutes(-5), "Somchai", "success"),
            new ActivityItem("Payment received ฿3,500 for Rental #1046", now.AddMinutes(-12), "System", "primary"),
            new ActivityItem("Rental #1042 returned - minor scratch reported", now.AddMinutes(-25), "Niran", "warning"),
            new ActivityItem("New reservation #1048 - Yamaha NMAX", now.AddMinutes(-45), "Online", "info"),
            new ActivityItem("Maintenance completed - Honda Click #12", now.AddHours(-2), "Chai", "secondary")
        ];

        // Alerts (placeholder)
        this.m_alerts =
        [
            new AlertItem("warning", "2 rentals are overdue for return today"),
            new AlertItem("info", "3 motorbikes scheduled for maintenance this week")
        ];
    }

    private void SetRevenuePeriod(string period)
    {
        this.m_revenuePeriod = period;
    }

    private string GetStatusColor(int index) => index switch
    {
        0 => "#00897B", // Rented - Primary teal
        1 => "#4DB6AC", // Available - Light teal
        2 => "#FF7043", // Maintenance - Orange
        3 => "#42A5F5", // Reserved - Blue
        _ => "#9E9E9E"
    };

    private static string GetUtilizationBadgeClass(int utilization) => utilization switch
    {
        > 80 => "bg-success",
        > 50 => "bg-warning",
        _ => "bg-secondary"
    };

    private static string GetActivityBgClass(string colorName) => colorName switch
    {
        "success" => "bg-success",
        "primary" => "bg-primary",
        "warning" => "bg-warning",
        "info" => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetAlertClass(string severity) => severity switch
    {
        "warning" => "alert-warning",
        "danger" => "alert-danger",
        "success" => "alert-success",
        _ => "alert-info"
    };

    private void RefreshActivity()
    {
        this.LoadDashboardData();
        this.StateHasChanged();
    }

    private static string FormatRelativeTime(DateTime time)
    {
        var diff = DateTime.Now - time;
        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} min ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hr ago";
        return $"{(int)diff.TotalDays} days ago";
    }

    // Helper classes
    private record TopBikeData(string Name, string Plate, int RentalCount, decimal Revenue, int Utilization);
    private record ActivityItem(string Description, DateTime Time, string User, string ColorName);
    private record AlertItem(string Severity, string Message);
}
