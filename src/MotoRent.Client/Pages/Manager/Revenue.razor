@page "/manager/revenue"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantManager")]
@inherits LocalizedComponentBase<Revenue>

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<div class="container-xl py-4">
    @* Page Header *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title mb-0">@Localizer["RevenueAnalytics"]</h2>
            <p class="text-secondary mb-0">@Localizer["RevenueAnalyticsSubtitle"]</p>
        </div>
        <div class="d-flex gap-2">
            <div class="d-flex gap-2 align-items-center">
                <input type="date" class="form-control form-control-sm" style="width: 140px;"
                       @bind="m_startDate" />
                <span class="text-secondary">@Localizer["To"]</span>
                <input type="date" class="form-control form-control-sm" style="width: 140px;"
                       @bind="m_endDate" />
            </div>
            <button type="button" class="btn btn-outline-primary">
                <i class="ti ti-download me-1"></i>
                @CommonLocalizer["Export"]
            </button>
        </div>
    </div>

    @* Summary Cards *@
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["TotalRevenue"]"
                Value="@m_totalRevenue.ToString("N0")"
                Prefix="฿"
                Icon="ti-building-bank"
                IconColor="success"
                ShowTrend="true"
                TrendPercent="15.2"
                TrendPeriod="@Localizer["LastPeriod"]" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["TotalRentals"]"
                Value="@m_totalRentals.ToString()"
                Icon="ti-receipt"
                IconColor="primary"
                ShowTrend="true"
                TrendPercent="8.7"
                TrendPeriod="@Localizer["LastPeriod"]" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["AvgDailyRate"]"
                Value="@m_avgDailyRate.ToString("N0")"
                Prefix="฿"
                Icon="ti-trending-up"
                IconColor="info"
                ShowTrend="true"
                TrendPercent="3.2"
                TrendPeriod="@Localizer["LastPeriod"]" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["AvgRentalDuration"]"
                Value="@m_avgDuration.ToString("N1")"
                Suffix="@Localizer["DaysSuffix"]"
                Icon="ti-clock"
                IconColor="warning" />
        </div>
    </div>

    @* Revenue Chart *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">@Localizer["RevenueOverTime"]</h4>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: 120px;" @bind="m_chartGrouping">
                        <option value="daily">@Localizer["GroupingDaily"]</option>
                        <option value="weekly">@Localizer["GroupingWeekly"]</option>
                        <option value="monthly">@Localizer["GroupingMonthly"]</option>
                    </select>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn @(m_chartType == "bar" ? "btn-primary" : "btn-outline-primary")"
                                @onclick="@(() => SetChartType("bar"))">
                            <i class="ti ti-chart-bar"></i>
                        </button>
                        <button type="button" class="btn @(m_chartType == "line" ? "btn-primary" : "btn-outline-primary")"
                                @onclick="@(() => SetChartType("line"))">
                            <i class="ti ti-chart-line"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="chart-placeholder d-flex align-items-center justify-content-center" style="height: 350px; background: var(--tblr-bg-surface-secondary); border-radius: 8px;">
                <div class="text-center text-secondary">
                    <i class="ti ti-@(m_chartType == "bar" ? "chart-bar" : "chart-line") mb-2" style="font-size: 2rem;"></i>
                    <div>@Localizer["RevenueChart", m_chartGrouping]</div>
                    <small>@Localizer["ChartPlaceholderHint"]</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        @* Revenue by Bike Type *@
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h4 class="card-title mb-3">@Localizer["RevenueByBikeType"]</h4>
                    <div class="d-flex flex-column gap-3 mb-3">
                        @for (int i = 0; i < m_bikeTypeLabels.Length; i++)
                        {
                            var index = i;
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <div style="width: 12px; height: 12px; border-radius: 2px; background: @m_bikeTypeColors[index];"></div>
                                        <span>@m_bikeTypeLabels[index]</span>
                                    </div>
                                    <span class="fw-medium">@FormatCurrency((decimal)m_bikeTypeRevenue[index])</span>
                                </div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar" style="width: @m_bikeTypeData[index]%; background-color: @m_bikeTypeColors[index];"></div>
                                </div>
                                <small class="text-secondary">@m_bikeTypeData[index].ToString("N1")%</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Revenue by Payment Method *@
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h4 class="card-title mb-3">@Localizer["RevenueByPaymentMethod"]</h4>
                    <div class="d-flex flex-column gap-3">
                        @for (int i = 0; i < m_paymentMethodLabels.Length; i++)
                        {
                            var index = i;
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="ti @GetPaymentIcon(m_paymentMethodLabels[index])"></i>
                                        <span>@m_paymentMethodLabels[index]</span>
                                    </div>
                                    <span class="fw-medium">@FormatCurrency((decimal)m_paymentMethodRevenue[index])</span>
                                </div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar" style="width: @m_paymentMethodData[index]%; background-color: @m_paymentMethodColors[index];"></div>
                                </div>
                                <small class="text-secondary">@m_paymentMethodData[index].ToString("N1")%</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Detailed Transactions Table *@
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">@Localizer["RecentTransactions"]</h4>
                <div class="input-icon">
                    <span class="input-icon-addon">
                        <i class="ti ti-search"></i>
                    </span>
                    <input type="text" class="form-control form-control-sm" placeholder="@CommonLocalizer["Search"]"
                           style="width: 200px;" @bind="m_searchText" @bind:event="oninput" />
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-vcenter table-striped table-hover">
                    <thead>
                        <tr>
                            <th>@Localizer["RentalNo"]</th>
                            <th>@Localizer["Date"]</th>
                            <th>@Localizer["Customer"]</th>
                            <th>@Localizer["Motorbike"]</th>
                            <th>@Localizer["Duration"]</th>
                            <th class="text-end">@Localizer["Amount"]</th>
                            <th>@Localizer["Payment"]</th>
                            <th>@Localizer["Status"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tx in m_transactions.Where(t => FilterTransaction(t)))
                        {
                            <tr>
                                <td>
                                    <a href="@($"/rentals/view/{EncodeId(tx.RentalId)}")" class="text-primary">
                                        @tx.RentalId
                                    </a>
                                </td>
                                <td>@tx.Date.ToString("dd MMM")</td>
                                <td>@tx.CustomerName</td>
                                <td>@tx.MotorbikeName</td>
                                <td>@Localizer["DurationDays", tx.Duration]</td>
                                <td class="text-end fw-medium">@FormatCurrency(tx.Amount)</td>
                                <td>
                                    <span class="badge bg-secondary-lt">@tx.PaymentMethod</span>
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(tx.Status)">@tx.Status</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-center mt-3">
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled"><a class="page-link" href="#">@Localizer["Previous"]</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">4</a></li>
                        <li class="page-item"><a class="page-link" href="#">5</a></li>
                        <li class="page-item"><a class="page-link" href="#">@Localizer["Next"]</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

@code {
    // Filters
    private DateTime m_startDate = DateTime.Now.AddDays(-30);
    private DateTime m_endDate = DateTime.Now;
    private string m_chartGrouping = "daily";
    private string m_chartType = "bar";
    private string m_searchText = "";

    // Summary Metrics
    private decimal m_totalRevenue = 1250000;
    private int m_totalRentals = 342;
    private decimal m_avgDailyRate = 485;
    private decimal m_avgDuration = 4.2m;

    // Bike Type Breakdown
    private double[] m_bikeTypeData = [42.5, 31.2, 18.8, 7.5];
    private double[] m_bikeTypeRevenue = [531250, 390000, 235000, 93750];
    private string[] m_bikeTypeLabels = ["Scooter (110-125cc)", "Sport Scooter (150cc+)", "Manual (125cc)", "Big Bike (300cc+)"];
    private string[] m_bikeTypeColors = ["#00897B", "#26A69A", "#4DB6AC", "#80CBC4"];

    // Payment Method Breakdown
    private double[] m_paymentMethodData = [55.3, 28.7, 12.5, 3.5];
    private double[] m_paymentMethodRevenue = [691250, 358750, 156250, 43750];
    private string[] m_paymentMethodLabels = ["Cash", "Credit Card", "Bank Transfer", "PromptPay"];
    private string[] m_paymentMethodColors = ["#4CAF50", "#2196F3", "#FF9800", "#9C27B0"];

    // Transactions
    private List<TransactionData> m_transactions = [];

    protected override void OnInitialized()
    {
        this.LoadRevenueData();
    }

    private void SetChartType(string type)
    {
        this.m_chartType = type;
    }

    private void LoadRevenueData()
    {
        // Transaction data (placeholder)
        this.m_transactions =
        [
            new TransactionData(1047, DateTime.Now.AddHours(-2), "John Smith", "Honda PCX 160", 5, 3500, "Credit Card", "Active"),
            new TransactionData(1046, DateTime.Now.AddHours(-5), "Maria Garcia", "Yamaha NMAX", 3, 2400, "Cash", "Active"),
            new TransactionData(1045, DateTime.Now.AddDays(-1), "Kim Soo", "Honda Click 125", 7, 3150, "Cash", "Completed"),
            new TransactionData(1044, DateTime.Now.AddDays(-1), "Alex Brown", "Yamaha Aerox", 4, 2800, "PromptPay", "Completed"),
            new TransactionData(1043, DateTime.Now.AddDays(-2), "Lisa Wong", "Honda Wave 110", 10, 4000, "Bank Transfer", "Completed"),
            new TransactionData(1042, DateTime.Now.AddDays(-2), "Tom Wilson", "Honda PCX 160", 3, 2100, "Credit Card", "Completed"),
            new TransactionData(1041, DateTime.Now.AddDays(-3), "Emma Davis", "Yamaha NMAX", 5, 4000, "Cash", "Completed"),
            new TransactionData(1040, DateTime.Now.AddDays(-3), "Chen Wei", "Honda Click 125", 2, 900, "Cash", "Completed")
        ];
    }

    private bool FilterTransaction(TransactionData tx)
    {
        if (string.IsNullOrWhiteSpace(this.m_searchText))
            return true;

        var search = this.m_searchText.ToLower();
        return tx.RentalId.ToString().Contains(search) ||
               tx.CustomerName.ToLower().Contains(search) ||
               tx.MotorbikeName.ToLower().Contains(search);
    }

    private static string GetPaymentIcon(string method) => method switch
    {
        "Cash" => "ti-cash",
        "Credit Card" => "ti-credit-card",
        "Bank Transfer" => "ti-building-bank",
        "PromptPay" => "ti-qrcode",
        _ => "ti-coin"
    };

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Active" => "bg-success",
        "Completed" => "bg-secondary",
        "Cancelled" => "bg-danger",
        _ => "bg-secondary"
    };

    private record TransactionData(int RentalId, DateTime Date, string CustomerName, string MotorbikeName, int Duration, decimal Amount, string PaymentMethod, string Status);
}
