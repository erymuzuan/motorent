@page "/manager/service-types"
@inherits MotoRent.Client.Controls.LocalizedComponentBase<ServiceTypes>
@inject MaintenanceService MaintenanceService
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = "RequireTenantManager")]

<MotoRentPageTitle>@base.Localizer["PageTitle"]</MotoRentPageTitle>

<TablerHeader Title="@base.Localizer["Header"]" PreTitle="@base.Localizer["PreTitle"]">
    <div class="btn-list">
        @if (this.m_serviceTypes.Count == 0 && !this.m_loading)
        {
            <button type="button" class="btn btn-outline-success" @onclick="this.CreateDefaultTypesAsync">
                <i class="ti ti-wand me-1"></i>
                @base.Localizer["CreateDefaults"]
            </button>
        }
        <button type="button" class="btn btn-primary" @onclick="this.OpenAddDialogAsync">
            <i class="ti ti-plus me-1"></i>
            @base.Localizer["AddServiceType"]
        </button>
    </div>
</TablerHeader>

<LoadingSkeleton Loading="@this.m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table" Rows="5" Columns="5">
    @if (this.m_serviceTypes.Count == 0)
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="ti ti-tool mb-3" style="font-size: 3rem; color: var(--tblr-secondary);"></i>
                <h3>@base.Localizer["NoServiceTypesDefined"]</h3>
                <p class="text-secondary">
                    @base.Localizer["NoServiceTypesDescription"]
                </p>
                <button type="button" class="btn btn-success" @onclick="this.CreateDefaultTypesAsync">
                    <i class="ti ti-wand me-1"></i>
                    @base.Localizer["CreateDefaultTypes"]
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="table-responsive">
                <table class="table table-vcenter card-table">
                    <thead>
                        <tr>
                            <th>@base.Localizer["Name"]</th>
                            <th>@base.Localizer["Description"]</th>
                            <th class="text-center">@base.Localizer["Days"]</th>
                            <th class="text-center">@base.Localizer["Kilometers"]</th>
                            <th class="text-center">@base.Localizer["Status"]</th>
                            <th class="w-1">@base.CommonLocalizer["Actions"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var st in this.m_serviceTypes)
                        {
                            <tr class="@(st.IsActive ? "" : "text-secondary")">
                                <td>
                                    <strong>@st.Name</strong>
                                    <small class="d-block text-secondary">@base.Localizer["Order"]: @st.SortOrder</small>
                                </td>
                                <td>@(st.Description ?? "-")</td>
                                <td class="text-center">@base.Localizer["DaysCount", st.DaysInterval]</td>
                                <td class="text-center">@base.Localizer["KmCount", st.KmInterval.ToString("N0")]</td>
                                <td class="text-center">
                                    <span class="badge @(st.IsActive ? "bg-success" : "bg-secondary")">
                                        @(st.IsActive ? base.Localizer["StatusActive"] : base.Localizer["StatusInactive"])
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <button type="button" class="btn btn-icon btn-ghost-primary"
                                                title="@base.CommonLocalizer["Edit"]" @onclick="@(() => this.OpenEditDialogAsync(st))">
                                            <i class="ti ti-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-icon btn-ghost-danger"
                                                title="@base.CommonLocalizer["Delete"]" @onclick="@(() => this.ConfirmDeleteAsync(st))">
                                            <i class="ti ti-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</LoadingSkeleton>

@code {
    private bool m_loading = true;
    private List<ServiceType> m_serviceTypes = [];

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        this.m_loading = true;
        try
        {
            var result = await this.MaintenanceService.GetServiceTypesAsync(activeOnly: false);
            this.m_serviceTypes = result.ItemCollection.ToList();
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task OpenAddDialogAsync()
    {
        var serviceType = new ServiceType
        {
            IsActive = true,
            DaysInterval = 30,
            KmInterval = 3000,
            SortOrder = this.m_serviceTypes.Count + 1
        };

        var result = await base.DialogService
            .Create<ServiceTypeDialog>(base.Localizer["AddServiceType"])
            .WithParameter(x => x.Entity, serviceType)
            .WithParameter(x => x.IsNew, true)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadDataAsync();
            base.ShowSuccess(base.Localizer["ServiceTypeAdded"]);
        }
    }

    private async Task OpenEditDialogAsync(ServiceType st)
    {
        var clone = st.Clone();

        var result = await base.DialogService
            .Create<ServiceTypeDialog>(base.Localizer["EditServiceType"])
            .WithParameter(x => x.Entity, clone)
            .WithParameter(x => x.IsNew, false)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadDataAsync();
            base.ShowSuccess(base.Localizer["ServiceTypeUpdated"]);
        }
    }

    private async Task ConfirmDeleteAsync(ServiceType st)
    {
        if (!await base.ConfirmAsync(base.Localizer["DeleteConfirmation", st.Name],
            base.Localizer["DeleteWarning"]))
            return;

        var result = await this.MaintenanceService.DeleteServiceTypeAsync(st, base.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            base.ShowSuccess(base.Localizer["ServiceTypeDeleted"]);
        }
        else
        {
            base.ShowError(base.Localizer["DeleteFailed", result.Message ?? ""]);
        }
    }

    private async Task CreateDefaultTypesAsync()
    {
        this.m_loading = true;
        try
        {
            var result = await this.MaintenanceService.CreateDefaultServiceTypesAsync(base.UserName);
            if (result.Success)
            {
                await this.LoadDataAsync();
                base.ShowSuccess(base.Localizer["DefaultServiceTypesCreated"]);
            }
            else
            {
                base.ShowError(base.Localizer["CreateDefaultsFailed", result.Message ?? ""]);
            }
        }
        finally
        {
            this.m_loading = false;
        }
    }
}
