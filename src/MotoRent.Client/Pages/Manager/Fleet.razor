@page "/manager/fleet"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantManager")]
@inherits LocalizedComponentBase<Fleet>

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<div class="container-xl py-4">
    @* Page Header *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title mb-0">@Localizer["FleetAnalytics"]</h2>
            <p class="text-secondary mb-0">@Localizer["FleetAnalyticsSubtitle"]</p>
        </div>
        <div class="btn-list">
            <a href="/motorbikes/create" class="btn btn-outline-primary">
                <i class="ti ti-plus me-1"></i>
                @Localizer["AddMotorbike"]
            </a>
            <button type="button" class="btn btn-outline-secondary">
                <i class="ti ti-download me-1"></i>
                @CommonLocalizer["Export"]
            </button>
        </div>
    </div>

    @* Summary Cards *@
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["TotalFleet"]"
                Value="@m_totalFleet.ToString()"
                Suffix="@Localizer["BikesSuffix"]"
                Icon="ti-motorbike"
                IconColor="primary" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["CurrentlyRented"]"
                Value="@m_rentedCount.ToString()"
                Icon="ti-bike"
                IconColor="success"
                Subtitle="@Localizer["UtilizationSubtitle", m_utilizationRate]" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["Available"]"
                Value="@m_availableCount.ToString()"
                Icon="ti-circle-check"
                IconColor="info" />
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <MotoRent.Client.Components.Manager.MetricCard
                Title="@Localizer["InMaintenance"]"
                Value="@m_maintenanceCount.ToString()"
                Icon="ti-tool"
                IconColor="warning"
                Subtitle="@Localizer["ScheduledMaintenanceSubtitle", m_scheduledMaintenance]" />
        </div>
    </div>

    <div class="row g-3 mb-4">
        @* Utilization Over Time Chart *@
        <div class="col-12 col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="card-title mb-0">@Localizer["FleetUtilizationTrend"]</h4>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn @(m_utilizationPeriod == "7d" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetUtilizationPeriod("7d"))">@Localizer["Days7"]</button>
                            <button type="button" class="btn @(m_utilizationPeriod == "30d" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetUtilizationPeriod("30d"))">@Localizer["Days30"]</button>
                            <button type="button" class="btn @(m_utilizationPeriod == "90d" ? "btn-primary" : "btn-outline-primary")"
                                    @onclick="@(() => SetUtilizationPeriod("90d"))">@Localizer["Days90"]</button>
                        </div>
                    </div>
                    <div class="chart-placeholder d-flex align-items-center justify-content-center" style="height: 300px; background: var(--tblr-bg-surface-secondary); border-radius: 8px;">
                        <div class="text-center text-secondary">
                            <i class="ti ti-chart-area mb-2" style="font-size: 2rem;"></i>
                            <div>@Localizer["UtilizationChart", m_utilizationPeriod]</div>
                            <small>@Localizer["ChartPlaceholderHint"]</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Fleet by Status *@
        <div class="col-12 col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <h4 class="card-title mb-3">@Localizer["FleetStatus"]</h4>
                    <div class="d-flex flex-column gap-3">
                        @for (int i = 0; i < m_statusLabels.Length; i++)
                        {
                            var index = i;
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center gap-2">
                                        <div style="width: 12px; height: 12px; border-radius: 2px; background: @m_statusColors[index];"></div>
                                        <span>@Localizer[m_statusLabels[index]]</span>
                                    </div>
                                    <span class="fw-semibold">@m_statusCounts[index]</span>
                                </div>
                                <div class="progress progress-sm">
                                    <div class="progress-bar" style="width: @(m_statusCounts[index] * 100.0 / m_statusCounts.Sum())%; background-color: @m_statusColors[index];"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Fleet Inventory Table *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">@Localizer["FleetInventory"]</h4>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: 150px;" @bind="m_statusFilter">
                        <option value="">@Localizer["AllStatus"]</option>
                        <option value="Available">@Localizer["Available"]</option>
                        <option value="Rented">@Localizer["Rented"]</option>
                        <option value="Maintenance">@Localizer["Maintenance"]</option>
                    </select>
                    <div class="input-icon">
                        <span class="input-icon-addon">
                            <i class="ti ti-search"></i>
                        </span>
                        <input type="text" class="form-control form-control-sm" placeholder="@CommonLocalizer["Search"]"
                               style="width: 200px;" @bind="m_searchText" @bind:event="oninput" />
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-vcenter table-striped table-hover">
                    <thead>
                        <tr>
                            <th>@Localizer["Motorbike"]</th>
                            <th>@Localizer["Plate"]</th>
                            <th>@Localizer["Type"]</th>
                            <th>@Localizer["Status"]</th>
                            <th class="text-center">@Localizer["Utilization"]</th>
                            <th class="text-end">@Localizer["RevenueMTD"]</th>
                            <th class="text-end">@Localizer["Rentals"]</th>
                            <th>@Localizer["LastService"]</th>
                            <th>@CommonLocalizer["Actions"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bike in GetFilteredBikes())
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="avatar avatar-sm bg-primary-lt">
                                            <i class="ti ti-motorbike"></i>
                                        </span>
                                        <div>
                                            <div class="fw-medium">@bike.Brand @bike.Model</div>
                                            <small class="text-secondary">@bike.Year • @bike.EngineCC cc</small>
                                        </div>
                                    </div>
                                </td>
                                <td><code>@bike.Plate</code></td>
                                <td>@bike.Type</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(bike.Status)">@Localizer[bike.Status]</span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="progress progress-sm flex-grow-1" style="width: 60px;">
                                            <div class="progress-bar @GetUtilizationProgressClass(bike.Utilization)"
                                                 style="width: @bike.Utilization%;"></div>
                                        </div>
                                        <small>@bike.Utilization%</small>
                                    </div>
                                </td>
                                <td class="text-end fw-medium">@FormatCurrency(bike.Revenue)</td>
                                <td class="text-end">@bike.RentalCount</td>
                                <td>
                                    <span class="@(bike.DaysSinceService > 30 ? "text-warning" : "")">
                                        @Localizer["DaysAgo", bike.DaysSinceService]
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <a href="@($"/vehicles/{EncodeId(bike.MotorbikeId)}")" class="btn btn-icon btn-ghost-secondary btn-sm">
                                            <i class="ti ti-eye"></i>
                                        </a>
                                        <a href="@($"/vehicles/{EncodeId(bike.MotorbikeId)}/edit")" class="btn btn-icon btn-ghost-secondary btn-sm">
                                            <i class="ti ti-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-icon btn-ghost-warning btn-sm"
                                                @onclick="@(() => ScheduleMaintenance(bike))">
                                            <i class="ti ti-tool"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="text-secondary small">
                    @Localizer["ShowingCount", GetFilteredBikes().Count, m_fleet.Count]
                </span>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled"><a class="page-link" href="#">@Localizer["Previous"]</a></li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">@Localizer["Next"]</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    @* Maintenance Schedule *@
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="card-title mb-0">@Localizer["UpcomingMaintenance"]</h4>
                <button type="button" class="btn btn-ghost-primary btn-sm">
                    @Localizer["ViewAll"]
                    <i class="ti ti-arrow-right ms-1"></i>
                </button>
            </div>

            <div class="row g-3">
                @foreach (var maintenance in m_upcomingMaintenance)
                {
                    <div class="col-12 col-md-4">
                        <div class="card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="mb-0">@maintenance.BikeName</h5>
                                        <small class="text-secondary">@maintenance.Plate</small>
                                    </div>
                                    <span class="badge @GetMaintenanceUrgencyClass(maintenance.DaysUntil)">
                                        @(maintenance.DaysUntil == 0 ? Localizer["Today"] : maintenance.DaysUntil == 1 ? Localizer["Tomorrow"] : Localizer["InDays", maintenance.DaysUntil])
                                    </span>
                                </div>
                                <div class="mb-2">@maintenance.Type</div>
                                <div class="btn-list">
                                    <button type="button" class="btn btn-ghost-primary btn-sm">@Localizer["Start"]</button>
                                    <button type="button" class="btn btn-ghost-secondary btn-sm">@Localizer["Reschedule"]</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // Summary metrics
    private int m_totalFleet = 40;
    private int m_rentedCount = 23;
    private int m_availableCount = 12;
    private int m_maintenanceCount = 3;
    private int m_scheduledMaintenance = 5;
    private decimal m_utilizationRate => this.m_totalFleet > 0 ? (decimal)this.m_rentedCount / this.m_totalFleet * 100 : 0;

    // Filters
    private string m_utilizationPeriod = "7d";
    private string m_statusFilter = "";
    private string m_searchText = "";

    // Status Data
    private int[] m_statusCounts = [23, 12, 3, 2];
    private string[] m_statusLabels = ["Rented", "Available", "Maintenance", "Reserved"];
    private string[] m_statusColors = ["#00897B", "#4DB6AC", "#FF7043", "#42A5F5"];

    // Fleet Data
    private List<FleetBikeData> m_fleet = [];

    // Maintenance Schedule
    private List<MaintenanceItem> m_upcomingMaintenance = [];

    protected override void OnInitialized()
    {
        this.LoadFleetData();
    }

    private void SetUtilizationPeriod(string period)
    {
        this.m_utilizationPeriod = period;
    }

    private void LoadFleetData()
    {
        // Fleet inventory (placeholder)
        this.m_fleet =
        [
            new FleetBikeData(1, "Honda", "PCX 160", 2023, 160, "กข 1234", "Scooter", "Rented", 92, 67500, 45, 8),
            new FleetBikeData(2, "Yamaha", "NMAX", 2023, 155, "กค 5678", "Sport Scooter", "Rented", 85, 57000, 38, 12),
            new FleetBikeData(3, "Honda", "Click 125", 2022, 125, "กง 9012", "Scooter", "Available", 78, 46800, 52, 5),
            new FleetBikeData(4, "Yamaha", "Aerox", 2023, 155, "กจ 3456", "Sport Scooter", "Rented", 72, 43400, 31, 15),
            new FleetBikeData(5, "Honda", "Wave 110", 2022, 110, "กฉ 7890", "Manual", "Available", 68, 38400, 48, 3),
            new FleetBikeData(6, "Kawasaki", "Ninja 300", 2023, 300, "กช 1111", "Big Bike", "Maintenance", 45, 52000, 18, 45),
            new FleetBikeData(7, "Honda", "Scoopy", 2023, 110, "กซ 2222", "Scooter", "Available", 55, 28500, 35, 10),
            new FleetBikeData(8, "Yamaha", "Fino", 2022, 125, "กฌ 3333", "Scooter", "Rented", 62, 31200, 42, 7)
        ];

        // Upcoming maintenance
        this.m_upcomingMaintenance =
        [
            new MaintenanceItem("Honda Click #12", "กต 4567", "Oil Change & Inspection", 0),
            new MaintenanceItem("Yamaha NMAX #5", "กถ 8901", "Brake Pad Replacement", 2),
            new MaintenanceItem("Honda PCX #8", "กท 2345", "Scheduled Service (5000km)", 5),
            new MaintenanceItem("Kawasaki Ninja #1", "กธ 6789", "Chain & Sprocket Check", 7),
            new MaintenanceItem("Honda Wave #15", "กน 0123", "Tire Replacement", 10)
        ];
    }

    private List<FleetBikeData> GetFilteredBikes()
    {
        var filtered = this.m_fleet.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(this.m_statusFilter))
            filtered = filtered.Where(b => b.Status == this.m_statusFilter);

        if (!string.IsNullOrWhiteSpace(this.m_searchText))
        {
            var search = this.m_searchText.ToLower();
            filtered = filtered.Where(b =>
                b.Brand.ToLower().Contains(search) ||
                b.Model.ToLower().Contains(search) ||
                b.Plate.ToLower().Contains(search));
        }

        return filtered.ToList();
    }

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Available" => "bg-success",
        "Rented" => "bg-primary",
        "Maintenance" => "bg-warning",
        "Reserved" => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetUtilizationProgressClass(int utilization) => utilization switch
    {
        > 80 => "bg-success",
        > 50 => "bg-warning",
        _ => "bg-danger"
    };

    private static string GetMaintenanceUrgencyClass(int daysUntil) => daysUntil switch
    {
        0 => "bg-danger",
        <= 2 => "bg-warning",
        _ => "bg-secondary"
    };

    private void ScheduleMaintenance(FleetBikeData bike)
    {
        this.ShowInfo(Localizer["ScheduleMaintenanceFeatureHint", bike.Brand, bike.Model]);
    }

    private record FleetBikeData(int MotorbikeId, string Brand, string Model, int Year, int EngineCC, string Plate, string Type, string Status, int Utilization, decimal Revenue, int RentalCount, int DaysSinceService);
    private record MaintenanceItem(string BikeName, string Plate, string Type, int DaysUntil);
}

@code {
    // Summary metrics
    private int m_totalFleet = 40;
    private int m_rentedCount = 23;
    private int m_availableCount = 12;
    private int m_maintenanceCount = 3;
    private int m_scheduledMaintenance = 5;
    private decimal m_utilizationRate => this.m_totalFleet > 0 ? (decimal)this.m_rentedCount / this.m_totalFleet * 100 : 0;

    // Filters
    private string m_utilizationPeriod = "7d";
    private string m_statusFilter = "";
    private string m_searchText = "";

    // Status Data
    private int[] m_statusCounts = [23, 12, 3, 2];
    private string[] m_statusLabels = ["Rented", "Available", "Maintenance", "Reserved"];
    private string[] m_statusColors = ["#00897B", "#4DB6AC", "#FF7043", "#42A5F5"];

    // Fleet Data
    private List<FleetBikeData> m_fleet = [];

    // Maintenance Schedule
    private List<MaintenanceItem> m_upcomingMaintenance = [];

    protected override void OnInitialized()
    {
        this.LoadFleetData();
    }

    private void SetUtilizationPeriod(string period)
    {
        this.m_utilizationPeriod = period;
    }

    private void LoadFleetData()
    {
        // Fleet inventory (placeholder)
        this.m_fleet =
        [
            new FleetBikeData(1, "Honda", "PCX 160", 2023, 160, "กข 1234", "Scooter", "Rented", 92, 67500, 45, 8),
            new FleetBikeData(2, "Yamaha", "NMAX", 2023, 155, "กค 5678", "Sport Scooter", "Rented", 85, 57000, 38, 12),
            new FleetBikeData(3, "Honda", "Click 125", 2022, 125, "กง 9012", "Scooter", "Available", 78, 46800, 52, 5),
            new FleetBikeData(4, "Yamaha", "Aerox", 2023, 155, "กจ 3456", "Sport Scooter", "Rented", 72, 43400, 31, 15),
            new FleetBikeData(5, "Honda", "Wave 110", 2022, 110, "กฉ 7890", "Manual", "Available", 68, 38400, 48, 3),
            new FleetBikeData(6, "Kawasaki", "Ninja 300", 2023, 300, "กช 1111", "Big Bike", "Maintenance", 45, 52000, 18, 45),
            new FleetBikeData(7, "Honda", "Scoopy", 2023, 110, "กซ 2222", "Scooter", "Available", 55, 28500, 35, 10),
            new FleetBikeData(8, "Yamaha", "Fino", 2022, 125, "กฌ 3333", "Scooter", "Rented", 62, 31200, 42, 7)
        ];

        // Upcoming maintenance
        this.m_upcomingMaintenance =
        [
            new MaintenanceItem("Honda Click #12", "กต 4567", "Oil Change & Inspection", 0),
            new MaintenanceItem("Yamaha NMAX #5", "กถ 8901", "Brake Pad Replacement", 2),
            new MaintenanceItem("Honda PCX #8", "กท 2345", "Scheduled Service (5000km)", 5),
            new MaintenanceItem("Kawasaki Ninja #1", "กธ 6789", "Chain & Sprocket Check", 7),
            new MaintenanceItem("Honda Wave #15", "กน 0123", "Tire Replacement", 10)
        ];
    }

    private List<FleetBikeData> GetFilteredBikes()
    {
        var filtered = this.m_fleet.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(this.m_statusFilter))
            filtered = filtered.Where(b => b.Status == this.m_statusFilter);

        if (!string.IsNullOrWhiteSpace(this.m_searchText))
        {
            var search = this.m_searchText.ToLower();
            filtered = filtered.Where(b =>
                b.Brand.ToLower().Contains(search) ||
                b.Model.ToLower().Contains(search) ||
                b.Plate.ToLower().Contains(search));
        }

        return filtered.ToList();
    }

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "Available" => "bg-success",
        "Rented" => "bg-primary",
        "Maintenance" => "bg-warning",
        "Reserved" => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetUtilizationProgressClass(int utilization) => utilization switch
    {
        > 80 => "bg-success",
        > 50 => "bg-warning",
        _ => "bg-danger"
    };

    private static string GetMaintenanceUrgencyClass(int daysUntil) => daysUntil switch
    {
        0 => "bg-danger",
        <= 2 => "bg-warning",
        _ => "bg-secondary"
    };

    private void ScheduleMaintenance(FleetBikeData bike)
    {
        this.ShowInfo($"Schedule maintenance for {bike.Brand} {bike.Model} - Feature coming soon!");
    }

    private record FleetBikeData(int MotorbikeId, string Brand, string Model, int Year, int EngineCC, string Plate, string Type, string Status, int Utilization, decimal Revenue, int RentalCount, int DaysSinceService);
    private record MaintenanceItem(string BikeName, string Plate, string Type, int DaysUntil);
}
