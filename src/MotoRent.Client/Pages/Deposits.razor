@page "/deposits"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<Deposits>
@inject DepositService DepositService

<MotoRentPageTitle>Deposits</MotoRentPageTitle>

<TablerHeader Title="Deposit Tracking" PreTitle="Finance">
    <span class="text-secondary">Manage security deposits for rentals</span>
</TablerHeader>

<div class="row row-deck row-cards mb-3">
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">Total Held</div>
                <div class="h2 text-primary">@FormatCurrency(m_totalHeld)</div>
                <div class="text-secondary small">@m_statusCounts.GetValueOrDefault("Held", 0) deposits</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">Held</div>
                <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-lock text-warning fs-2"></i>
                    <span class="h3">@m_statusCounts.GetValueOrDefault("Held", 0)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">Refunded</div>
                <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-circle-check text-success fs-2"></i>
                    <span class="h3">@m_statusCounts.GetValueOrDefault("Refunded", 0)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">Forfeited</div>
                <div class="d-flex align-items-center gap-2">
                    <i class="ti ti-ban text-danger fs-2"></i>
                    <span class="h3">@m_statusCounts.GetValueOrDefault("Forfeited", 0)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 0 ? "active" : "")" @onclick="@(() => SetActiveTab(0))">
                    <i class="ti ti-list me-1"></i> All
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 1 ? "active" : "")" @onclick="@(() => SetActiveTab(1))">
                    <i class="ti ti-lock me-1"></i> Held
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 2 ? "active" : "")" @onclick="@(() => SetActiveTab(2))">
                    <i class="ti ti-circle-check me-1"></i> Refunded
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(m_activeTab == 3 ? "active" : "")" @onclick="@(() => SetActiveTab(3))">
                    <i class="ti ti-ban me-1"></i> Forfeited
                </button>
            </li>
        </ul>
    </div>
</div>

<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table" Rows="10" Columns="8">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Renter</th>
                        <th>Motorbike</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Collected</th>
                        <th>Refunded</th>
                        <th class="w-1">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (m_deposits.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center text-secondary py-4">
                                <i class="ti ti-wallet mb-2" style="font-size: 2rem;"></i>
                                <div>No deposits found</div>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in m_deposits)
                        {
                            <tr>
                                <td>@item.Deposit.DepositId</td>
                                <td>@item.RenterName</td>
                                <td>@item.MotorbikeName</td>
                                <td>
                                    <span class="badge @GetDepositTypeBadgeClass(item.Deposit.DepositType)">
                                        @item.Deposit.DepositType
                                    </span>
                                </td>
                                <td class="fw-bold">@FormatCurrency(item.Deposit.Amount)</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(item.Deposit.Status)">
                                        @item.Deposit.Status
                                    </span>
                                </td>
                                <td>@FormatDate(item.Deposit.CollectedOn)</td>
                                <td>
                                    @if (item.Deposit.RefundedOn.HasValue)
                                    {
                                        @FormatDate(item.Deposit.RefundedOn.Value)
                                    }
                                    else
                                    {
                                        <span class="text-secondary">-</span>
                                    }
                                </td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        @if (item.Deposit.Status == "Held")
                                        {
                                            <button type="button" class="btn btn-icon btn-ghost-success" title="Refund"
                                                    @onclick="@(() => OpenRefundDialog(item))">
                                                <i class="ti ti-cash-off"></i>
                                            </button>
                                            <button type="button" class="btn btn-icon btn-ghost-danger" title="Forfeit"
                                                    @onclick="@(() => OpenForfeitDialog(item))">
                                                <i class="ti ti-x"></i>
                                            </button>
                                        }
                                        <a href="/rentals?id=@item.Deposit.RentalId" class="btn btn-icon btn-ghost-primary" title="View Rental">
                                            <i class="ti ti-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</LoadingSkeleton>

@code {
    private bool m_loading = true;
    private int m_activeTab;
    private List<DepositWithRentalInfo> m_deposits = [];
    private Dictionary<string, int> m_statusCounts = new();
    private decimal m_totalHeld;

    private string? CurrentStatusFilter => this.m_activeTab switch
    {
        1 => "Held",
        2 => "Refunded",
        3 => "Forfeited",
        _ => null
    };

    protected override async Task OnInitializedAsync()
    {
        await this.LoadData();
    }

    private async Task SetActiveTab(int tab)
    {
        this.m_activeTab = tab;
        await this.LoadDeposits();
    }

    private async Task LoadData()
    {
        this.m_loading = true;
        try
        {
            await Task.WhenAll(
                this.LoadDeposits(),
                this.LoadStatusCounts(),
                this.LoadTotalHeld()
            );
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading deposits: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task LoadDeposits()
    {
        this.m_deposits = await this.DepositService.GetDepositsWithRentalInfoAsync(
            this.ShopId,
            this.CurrentStatusFilter,
            page: 1,
            pageSize: 100);
    }

    private async Task LoadStatusCounts()
    {
        this.m_statusCounts = await this.DepositService.GetStatusCountsAsync(this.ShopId);
    }

    private async Task LoadTotalHeld()
    {
        this.m_totalHeld = await this.DepositService.GetTotalHeldDepositsAsync(this.ShopId);
    }

    private static string GetStatusBadgeClass(string? status) => status switch
    {
        "Held" => "bg-warning",
        "Refunded" => "bg-success",
        "Forfeited" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetDepositTypeBadgeClass(string? type) => type switch
    {
        "Cash" => "bg-success-lt",
        "CardPreAuth" => "bg-primary-lt",
        "Passport" => "bg-warning-lt",
        _ => "bg-secondary-lt"
    };

    private async Task OpenRefundDialog(DepositWithRentalInfo item)
    {
        var result = await this.DialogService
            .Create<RefundDepositDialog>("Refund Deposit")
            .WithParameter(x => x.Entity, item.Deposit)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadData();
            this.ShowSuccess("Deposit refunded successfully");
        }
    }

    private async Task OpenForfeitDialog(DepositWithRentalInfo item)
    {
        if (!await this.DialogService.ConfirmYesNoAsync(
            $"Are you sure you want to forfeit the deposit of {FormatCurrency(item.Deposit.Amount)} from {item.RenterName}? This action cannot be undone.",
            "Forfeit Deposit"))
            return;

        var result = await this.DepositService.ForfeitDepositAsync(item.Deposit.DepositId, "Manual forfeit", this.UserName);
        if (result.Success)
        {
            await this.LoadData();
            this.ShowSuccess("Deposit forfeited");
        }
        else
        {
            this.ShowError($"Failed to forfeit deposit: {result.Message}");
        }
    }
}
