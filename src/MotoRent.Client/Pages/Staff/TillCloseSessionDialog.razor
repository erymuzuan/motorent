@using MotoRent.Domain.Entities
@inherits MotoRentComponentBase
@inject TillService TillService
@inject IModalService ModalService

<form id="closeSessionForm" @onsubmit="SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        @* Session Summary *@
        <div class="card bg-muted-lt mb-4">
            <div class="card-body py-3">
                <div class="row text-center">
                    <div class="col-4 border-end">
                        <small class="text-secondary d-block">Opening</small>
                        <span class="fw-semibold">@FormatCurrency(Entity.OpeningFloat)</span>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-success d-block">Cash In</small>
                        <span class="fw-semibold text-success">+@FormatCurrency(Entity.TotalCashIn)</span>
                    </div>
                    <div class="col-4">
                        <small class="text-danger d-block">Cash Out</small>
                        <span class="fw-semibold text-danger">-@FormatCurrency(Entity.TotalCashOut + Entity.TotalDropped)</span>
                    </div>
                </div>
            </div>
        </div>

        @* Expected vs Actual *@
        <div class="row g-3 mb-4">
            <div class="col-6">
                <label class="form-label">Expected Cash</label>
                <div class="form-control-plaintext h3 mb-0">
                    @FormatCurrency(Entity.ExpectedCash)
                </div>
            </div>
            <div class="col-6">
                <label class="form-label required">Actual Cash Count</label>
                <div class="input-group input-group-lg">
                    <span class="input-group-text">à¸¿</span>
                    <input type="number" class="form-control text-end" @bind="m_actualCash"
                           @bind:event="oninput" required min="0" step="100" autofocus />
                </div>
            </div>
        </div>

        @* Variance Display *@
        @if (m_actualCash > 0 || HasEnteredAmount)
        {
            var variance = m_actualCash - Entity.ExpectedCash;
            var varianceClass = variance == 0 ? "bg-success-lt text-success" :
                               variance > 0 ? "bg-info-lt text-info" :
                               "bg-danger-lt text-danger";
            var varianceIcon = variance == 0 ? "ti-check" :
                              variance > 0 ? "ti-trending-up" :
                              "ti-trending-down";
            var varianceText = variance == 0 ? "Balanced" :
                              variance > 0 ? "Over" : "Short";

            <div class="alert @varianceClass mb-4">
                <div class="d-flex align-items-center">
                    <i class="ti @varianceIcon me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="fw-semibold">@varianceText: @FormatCurrency(Math.Abs(variance))</div>
                        @if (variance != 0)
                        {
                            <small>
                                @(variance > 0 ? "Your till has more cash than expected" : "Your till is short by this amount")
                            </small>
                        }
                    </div>
                </div>
            </div>
        }

        @* Variance Acknowledgment *@
        @if (HasVariance)
        {
            <div class="mb-3">
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" @bind="m_acknowledgeVariance" />
                    <span class="form-check-label">
                        I acknowledge this variance and confirm the cash count is correct
                    </span>
                </label>
            </div>
        }

        <div class="mb-0">
            <label class="form-label">Closing Notes</label>
            <textarea class="form-control" @bind="m_notes" rows="2"
                      placeholder="Any notes about closing the till..."></textarea>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        Cancel
    </button>
    <button type="submit" form="closeSessionForm" class="btn btn-primary"
            disabled="@(!CanClose)">
        @if (m_saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-logout me-1"></i>
        Close Session
    </button>
</div>

@code {
    [Parameter]
    public TillSession Entity { get; set; } = new();

    private decimal m_actualCash;
    private string? m_notes;
    private bool m_acknowledgeVariance;
    private bool m_saving;

    private bool HasEnteredAmount => m_actualCash > 0;
    private bool HasVariance => HasEnteredAmount && m_actualCash != Entity.ExpectedCash;
    private bool CanClose => !m_saving && HasEnteredAmount && (!HasVariance || m_acknowledgeVariance);

    protected override void OnParametersSet()
    {
        // Pre-fill with expected amount
        m_actualCash = Entity.ExpectedCash;
    }

    private void Cancel()
    {
        ModalService.Close(ModalResult.Cancel());
    }

    private async Task SaveAsync()
    {
        if (!CanClose) return;

        try
        {
            m_saving = true;

            var result = await TillService.CloseSessionAsync(
                Entity.TillSessionId,
                m_actualCash,
                m_notes,
                UserName);

            if (result.Success)
            {
                ModalService.Close(ModalResult.Ok(result));
            }
            else
            {
                ShowError(result.Message ?? "Failed to close session");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error closing till session");
            ShowError("Failed to close session");
        }
        finally
        {
            m_saving = false;
        }
    }
}
