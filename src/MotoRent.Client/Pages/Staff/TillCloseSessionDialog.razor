@using MotoRent.Domain.Entities
@using MotoRent.Client.Components.Till
@using MotoRent.Client.Components.Auth
@inherits LocalizedDialogBase<TillSession, TillCloseSessionDialog>
@inject TillService TillService
@inject ExchangeRateService ExchangeRateService

<div class="mr-till-close-fullscreen">
    @* Main Content Area *@
    <div class="mr-till-main-area">
        @* Header *@
        <div class="mr-till-header">
            <div class="mr-till-greeting">
                <h2 class="mb-1">
                    @this.GetTimeEmoji() @Localizer["CloseYourShift"]
                </h2>
                <p class="text-muted mb-0">@Localizer["CountCashAndCloseSession"]</p>
            </div>
            <div class="mr-session-info">
                <span class="badge bg-primary-lt text-primary">
                    <i class="ti ti-cash-register me-1"></i>
                    @Localizer["Till"] #@this.Entity.TillSessionId
                </span>
                <span class="badge bg-azure-lt text-azure ms-2">
                    <i class="ti ti-clock me-1"></i>
                    @Localizer["Started"] @this.Entity.OpenedAt.ToLocalTime().ToString("HH:mm")
                </span>
            </div>
        </div>

        @if (!this.m_showSummary)
        {
            @* Step 1: Denomination Entry *@

            @* Session Summary Bar *@
            <div class="mr-session-summary-bar mb-4">
                <div class="mr-summary-item">
                    <i class="ti ti-wallet text-muted"></i>
                    <div class="mr-summary-content">
                        <span class="mr-summary-label">@Localizer["Opening"]</span>
                        <span class="mr-summary-value">@this.FormatCurrency(this.Entity.OpeningFloat)</span>
                    </div>
                </div>
                <div class="mr-summary-item mr-summary-in">
                    <i class="ti ti-trending-up text-success"></i>
                    <div class="mr-summary-content">
                        <span class="mr-summary-label">@Localizer["CashIn"]</span>
                        <span class="mr-summary-value text-success">+@this.FormatCurrency(this.Entity.TotalCashIn)</span>
                    </div>
                </div>
                <div class="mr-summary-item mr-summary-out">
                    <i class="ti ti-trending-down text-danger"></i>
                    <div class="mr-summary-content">
                        <span class="mr-summary-label">@Localizer["CashOut"]</span>
                        <span class="mr-summary-value text-danger">-@this.FormatCurrency(this.Entity.TotalCashOut + this.Entity.TotalDropped)</span>
                    </div>
                </div>
            </div>

            @* Denomination Count Panel *@
            <ClosingCountPanel
                TillSessionId="@this.Entity.TillSessionId"
                ExpectedBalances="@this.GetExpectedBalances()"
                OnBreakdownsChanged="@this.OnBreakdownsChanged"
                Disabled="@this.Saving" />

            @* Closing Notes *@
            <div class="mt-4">
                <label class="form-label text-muted">
                    <i class="ti ti-notes me-1"></i>
                    @Localizer["ClosingNotesOptional"]
                </label>
                <textarea class="form-control" @bind="this.Notes" rows="2"
                          placeholder="@Localizer["ClosingNotesPlaceholder"]" disabled="@this.Saving"></textarea>
            </div>
        }
        else
        {
            @* Step 2: Summary Review *@
            <div class="mr-review-section">
                <h4 class="mb-3">
                    <i class="ti ti-list-check text-primary me-2"></i>
                    @Localizer["ReviewYourCount"]
                </h4>

                <div class="table-responsive">
                    <table class="table table-vcenter">
                        <thead>
                            <tr>
                                <th>@Localizer["Currency"]</th>
                                <th class="text-end">@Localizer["Expected"]</th>
                                <th class="text-end">@Localizer["Counted"]</th>
                                <th class="text-end">@Localizer["Variance"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var breakdown in this.m_currencyBreakdowns)
                            {
                                var variance = breakdown.Variance ?? 0;
                                <tr>
                                    <td>
                                        <span class="fw-medium">@breakdown.Currency</span>
                                    </td>
                                    <td class="text-end text-muted">@FormatCurrencyAmount(breakdown.ExpectedBalance ?? 0, breakdown.Currency)</td>
                                    <td class="text-end fw-medium">@FormatCurrencyAmount(breakdown.Total, breakdown.Currency)</td>
                                    <td class="text-end @GetVarianceClass(variance)">
                                        <strong>@FormatVariance(variance, breakdown.Currency)</strong>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* Variance Acknowledgment *@
                @if (this.HasVariance)
                {
                    <div class="alert alert-warning mt-4">
                        <label class="form-check mb-0">
                            <input type="checkbox" class="form-check-input" @bind="this.AcknowledgeVariance" />
                            <span class="form-check-label">
                                <i class="ti ti-alert-triangle me-1"></i>
                                @Localizer["AcknowledgeVariance"]
                            </span>
                        </label>
                    </div>
                }

                @* Show closing notes if entered *@
                @if (!string.IsNullOrWhiteSpace(this.Notes))
                {
                    <div class="card bg-muted-lt mt-4">
                        <div class="card-body py-2">
                            <small class="text-secondary d-block mb-1">
                                <i class="ti ti-notes me-1"></i>
                                @Localizer["ClosingNotes"]
                            </small>
                            <span>@this.Notes</span>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    @* Right Sidebar *@
    <div class="mr-till-sidebar">
        @* Total Card *@
        <div class="mr-total-card">
            <span class="mr-total-label">@Localizer["TotalCounted"]</span>
            <div class="mr-total-amount">
                <span class="mr-currency-symbol">à¸¿</span>
                <span class="mr-amount-value">@this.GetTotalCountedThb().ToString("N0")</span>
            </div>
        </div>

        @* Comparison Card *@
        <div class="mr-comparison-card mt-3">
            <div class="mr-comparison-row">
                <span class="text-muted">@Localizer["Expected"]</span>
                <span class="fw-medium">à¸¿@this.GetExpectedTotalThb().ToString("N0")</span>
            </div>
            <div class="mr-comparison-row mr-comparison-variance @this.GetOverallVarianceAlertClass()">
                <span>
                    <i class="ti @this.GetOverallVarianceIcon() me-1"></i>
                    @Localizer["Variance"]
                </span>
                <span class="fw-bold">@this.FormatVarianceAmount(this.GetOverallVarianceThb())</span>
            </div>
        </div>

        @* Per-Currency Summary *@
        @if (this.m_currencyBreakdowns.Count > 1)
        {
            <div class="mr-currency-summary mt-3">
                @foreach (var breakdown in this.m_currencyBreakdowns)
                {
                    var variance = breakdown.Variance ?? 0;
                    var symbol = GetCurrencySymbol(breakdown.Currency);
                    <div class="mr-currency-row @(variance != 0 ? GetVarianceClass(variance) : "")">
                        <span class="mr-currency-name">@breakdown.Currency</span>
                        <span class="mr-currency-amount">
                            @symbol@breakdown.Total.ToString("N0")
                            @if (variance != 0)
                            {
                                <small class="ms-1">(@(variance >= 0 ? "+" : "")@variance.ToString("N0"))</small>
                            }
                        </span>
                    </div>
                }
            </div>
        }

        @* Action Buttons *@
        <div class="mr-sidebar-actions">
            @if (!this.m_showSummary)
            {
                <button type="button" class="btn btn-primary btn-lg w-100 mb-2"
                        @onclick="this.ReviewSummary"
                        disabled="@(!this.CanReviewSummary)">
                    <i class="ti ti-list-check me-2"></i>
                    @Localizer["ReviewSummary"]
                </button>
                <button type="button" class="btn btn-ghost-secondary w-100 mb-2" @onclick="this.Cancel">
                    @Localizer["Cancel"]
                </button>
                <button type="button" class="btn btn-ghost-warning w-100" @onclick="this.ForceCloseAsync" disabled="@this.Saving">
                    <i class="ti ti-shield-lock me-1"></i>
                    @Localizer["ManagerForceClose"]
                </button>
            }
            else
            {
                <form id="closeSessionForm" @onsubmit="this.SaveAsync" @onsubmit:preventDefault>
                    <button type="submit" class="btn btn-primary btn-lg w-100 mb-2"
                            disabled="@(!this.CanClose)">
                        @if (this.Saving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        <i class="ti ti-logout me-2"></i>
                        @Localizer["CloseSession"]
                    </button>
                </form>
                <button type="button" class="btn btn-ghost-secondary w-100" @onclick="this.BackToCount">
                    <i class="ti ti-arrow-left me-1"></i>
                    @Localizer["BackToCount"]
                </button>
            }
        </div>
    </div>
</div>

@code {
    private decimal ActualCash { get; set; }
    private string? Notes { get; set; }
    private bool AcknowledgeVariance { get; set; }
    private bool Saving { get; set; }
    private List<CurrencyDenominationBreakdown> m_currencyBreakdowns = [];
    private bool m_showSummary;
    private Dictionary<string, decimal> m_exchangeRates = new();

    private bool HasEnteredAmount => this.ActualCash > 0 ||
        this.m_currencyBreakdowns.Any(b => b.Currency == SupportedCurrencies.THB && b.Total > 0);

    private bool HasVariance => this.m_currencyBreakdowns.Any(b => b.Variance.HasValue && b.Variance.Value != 0);

    private bool CanReviewSummary => !this.Saving && this.HasEnteredAmount;

    private bool CanClose => !this.Saving && this.m_showSummary && (!this.HasVariance || this.AcknowledgeVariance);

    /// <summary>
    /// Returns an emoji based on the current time of day.
    /// </summary>
    private string GetTimeEmoji()
    {
        var hour = DateTime.Now.Hour;
        return hour switch
        {
            >= 5 and < 12 => "â˜€ï¸",
            >= 12 and < 17 => "ðŸŒ¤ï¸",
            >= 17 and < 21 => "ðŸŒ…",
            _ => "ðŸŒ™"
        };
    }

    /// <summary>
    /// Gets the total counted amount converted to THB.
    /// </summary>
    private decimal GetTotalCountedThb()
    {
        decimal total = 0;
        foreach (var breakdown in this.m_currencyBreakdowns)
        {
            if (breakdown.Currency == SupportedCurrencies.THB)
            {
                total += breakdown.Total;
            }
            else if (this.m_exchangeRates.TryGetValue(breakdown.Currency, out var rate) && rate > 0)
            {
                total += breakdown.Total * rate;
            }
            else
            {
                total += breakdown.Total;
            }
        }
        return total;
    }

    /// <summary>
    /// Gets the expected total converted to THB.
    /// </summary>
    private decimal GetExpectedTotalThb()
    {
        decimal total = 0;
        foreach (var breakdown in this.m_currencyBreakdowns)
        {
            var expected = breakdown.ExpectedBalance ?? 0;
            if (breakdown.Currency == SupportedCurrencies.THB)
            {
                total += expected;
            }
            else if (this.m_exchangeRates.TryGetValue(breakdown.Currency, out var rate) && rate > 0)
            {
                total += expected * rate;
            }
            else
            {
                total += expected;
            }
        }
        return total;
    }

    /// <summary>
    /// Formats variance amount with +/- prefix.
    /// </summary>
    private string FormatVarianceAmount(decimal variance)
    {
        if (variance >= 0)
        {
            return $"+à¸¿{variance:N0}";
        }
        return $"-à¸¿{Math.Abs(variance):N0}";
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        // Initialize with expected balances (no pre-fill for closing count)
        this.ActualCash = 0;
        // Load exchange rates for variance calculation
        await LoadExchangeRatesAsync();
    }

    private async Task LoadExchangeRatesAsync()
    {
        var currencies = new[] { SupportedCurrencies.USD, SupportedCurrencies.EUR, SupportedCurrencies.CNY };
        foreach (var currency in currencies)
        {
            var rate = await ExchangeRateService.GetCurrentRateAsync(currency);
            if (rate != null)
            {
                m_exchangeRates[currency] = rate.BuyRate;
            }
        }
    }

    /// <summary>
    /// Gets expected balances from TillSession.CurrencyBalances.
    /// If CurrencyBalances is null, falls back to ExpectedCash for THB only.
    /// </summary>
    private Dictionary<string, decimal> GetExpectedBalances()
    {
        if (this.Entity.CurrencyBalances != null && this.Entity.CurrencyBalances.Count > 0)
        {
            return this.Entity.CurrencyBalances;
        }

        // Fallback for backward compatibility
        return new Dictionary<string, decimal>
        {
            [SupportedCurrencies.THB] = this.Entity.ExpectedCash
        };
    }

    /// <summary>
    /// Callback when denomination breakdowns change.
    /// Updates ActualCash for backward compatibility with CloseSessionAsync.
    /// </summary>
    private void OnBreakdownsChanged(List<CurrencyDenominationBreakdown> breakdowns)
    {
        m_currencyBreakdowns = breakdowns;

        // Update ActualCash from THB breakdown for backward compatibility
        var thbBreakdown = breakdowns.FirstOrDefault(b => b.Currency == SupportedCurrencies.THB);
        this.ActualCash = thbBreakdown?.Total ?? 0;

        StateHasChanged();
    }

    /// <summary>
    /// Navigate to summary review step.
    /// </summary>
    private void ReviewSummary()
    {
        if (!HasEnteredAmount) return;
        m_showSummary = true;
        StateHasChanged();
    }

    /// <summary>
    /// Navigate back to denomination entry step.
    /// </summary>
    private void BackToCount()
    {
        m_showSummary = false;
        StateHasChanged();
    }

    /// <summary>
    /// Gets the CSS class for variance display.
    /// </summary>
    private static string GetVarianceClass(decimal variance)
    {
        if (variance == 0) return "text-success";
        if (variance > 0) return "text-info";     // Over
        return "text-danger";                      // Short
    }

    /// <summary>
    /// Gets currency symbol for formatting.
    /// </summary>
    private static string GetCurrencySymbol(string currency) => currency switch
    {
        SupportedCurrencies.THB => "\u0E3F",
        SupportedCurrencies.USD => "$",
        SupportedCurrencies.EUR => "\u20AC",
        SupportedCurrencies.CNY => "\u00A5",
        _ => ""
    };

    /// <summary>
    /// Formats currency amount with symbol.
    /// </summary>
    private static string FormatCurrencyAmount(decimal amount, string currency)
    {
        var symbol = GetCurrencySymbol(currency);
        return $"{symbol}{amount:N0}";
    }

    /// <summary>
    /// Formats variance with +/- prefix and currency symbol.
    /// </summary>
    private static string FormatVariance(decimal variance, string currency)
    {
        var symbol = GetCurrencySymbol(currency);
        if (variance >= 0)
        {
            return $"+{symbol}{variance:N0}";
        }
        return $"-{symbol}{Math.Abs(variance):N0}";
    }

    /// <summary>
    /// Gets the alert class for overall variance display.
    /// </summary>
    private string GetOverallVarianceAlertClass()
    {
        var variance = GetOverallVarianceThb();
        if (variance == 0) return "alert-success";
        if (variance > 0) return "alert-info";
        return "alert-danger";
    }

    /// <summary>
    /// Gets the icon for overall variance display.
    /// </summary>
    private string GetOverallVarianceIcon()
    {
        var variance = GetOverallVarianceThb();
        if (variance == 0) return "ti-check";
        if (variance > 0) return "ti-trending-up";
        return "ti-trending-down";
    }

    /// <summary>
    /// Calculates overall variance in THB (sum of all currency variances converted to THB).
    /// </summary>
    private decimal GetOverallVarianceThb()
    {
        decimal totalVariance = 0;

        foreach (var breakdown in m_currencyBreakdowns)
        {
            var variance = breakdown.Variance ?? 0;

            if (breakdown.Currency == SupportedCurrencies.THB)
            {
                totalVariance += variance;
            }
            else if (m_exchangeRates.TryGetValue(breakdown.Currency, out var rate) && rate > 0)
            {
                totalVariance += variance * rate;
            }
            else
            {
                // Fallback: use raw amount if no rate
                totalVariance += variance;
            }
        }

        return totalVariance;
    }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }

    private async Task SaveAsync()
    {
        if (!this.CanClose) return;

        try
        {
            this.Saving = true;

            // Use the new CloseSessionAsync overload with full breakdowns
            var result = await this.TillService.CloseSessionAsync(
                this.Entity.TillSessionId,
                m_currencyBreakdowns,
                this.Notes,
                this.UserName);

            if (!result.Success)
            {
                this.ShowError(result.Message ?? "Failed to close session");
                return;
            }

            // Save denomination count with full breakdowns
            if (m_currencyBreakdowns.Count > 0)
            {
                var denominationResult = await this.TillService.SaveDenominationCountAsync(
                    this.Entity.TillSessionId,
                    DenominationCountType.Closing,
                    m_currencyBreakdowns,
                    this.UserName,
                    isFinal: true,
                    notes: this.Notes);

                if (!denominationResult.Success)
                {
                    // Log but don't fail the close - denomination count is supplementary
                    this.Logger.LogWarning("Failed to save closing denomination count: {Message}",
                        denominationResult.Message);
                }
            }

            this.ModalService.Close(ModalResult.Ok(result));
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error closing till session");
            this.ShowError("Failed to close session");
        }
        finally
        {
            this.Saving = false;
        }
    }

    /// <summary>
    /// Force closes the session with manager PIN approval.
    /// Sets ActualCash = ExpectedCash (zero variance) and closes immediately.
    /// </summary>
    private async Task ForceCloseAsync()
    {
        // Step 1: Show manager PIN dialog
        var pinResult = await this.DialogService.Create<ManagerPinDialog>(Localizer["ManagerApproval"])
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (pinResult is null or { Cancelled: true }) return;

        var managerUserName = pinResult.Data as string;
        if (string.IsNullOrEmpty(managerUserName)) return;

        // Step 2: Execute force close
        try
        {
            this.Saving = true;

            var result = await this.TillService.ForceCloseSessionAsync(
                this.Entity.TillSessionId,
                managerUserName,
                this.Notes,
                this.UserName);

            if (!result.Success)
            {
                this.ShowError(result.Message ?? "Failed to force close session");
                return;
            }

            this.ModalService.Close(ModalResult.Ok(result));
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error force closing till session");
            this.ShowError("Failed to force close session");
        }
        finally
        {
            this.Saving = false;
        }
    }
}
