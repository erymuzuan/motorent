@using MotoRent.Domain.Entities
@inherits LocalizedDialogBase<TillSession, TillCloseSessionDialog>
@inject TillService TillService

<form id="closeSessionForm" @onsubmit="this.SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        @* Session Summary *@
        <div class="card bg-muted-lt mb-4">
            <div class="card-body py-3">
                <div class="row text-center">
                    <div class="col-4 border-end">
                        <small class="text-secondary d-block">@Localizer["Opening"]</small>
                        <span class="fw-semibold">@this.FormatCurrency(this.Entity.OpeningFloat)</span>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-success d-block">@Localizer["CashIn"]</small>
                        <span class="fw-semibold text-success">+@this.FormatCurrency(this.Entity.TotalCashIn)</span>
                    </div>
                    <div class="col-4">
                        <small class="text-danger d-block">@Localizer["CashOut"]</small>
                        <span class="fw-semibold text-danger">-@this.FormatCurrency(this.Entity.TotalCashOut + this.Entity.TotalDropped)</span>
                    </div>
                </div>
            </div>
        </div>

        @* Expected vs Actual *@
        <div class="row g-3 mb-4">
            <div class="col-6">
                <label class="form-label">@Localizer["ExpectedCash"]</label>
                <div class="form-control-plaintext h3 mb-0">
                    @this.FormatCurrency(this.Entity.ExpectedCash)
                </div>
            </div>
            <div class="col-6">
                <label class="form-label required">@Localizer["ActualCashCount"]</label>
                <div class="input-group input-group-lg">
                    <span class="input-group-text">à¸¿</span>
                    <input type="number" class="form-control text-end" @bind="this.ActualCash"
                           @bind:event="oninput" required min="0" step="100" autofocus />
                </div>
            </div>
        </div>

        @* Variance Display *@
        @if (this.ActualCash > 0 || this.HasEnteredAmount)
        {
            var variance = this.ActualCash - this.Entity.ExpectedCash;
            var varianceClass = variance == 0 ? "bg-success-lt text-success" :
                               variance > 0 ? "bg-info-lt text-info" :
                               "bg-danger-lt text-danger";
            var varianceIcon = variance == 0 ? "ti-check" :
                              variance > 0 ? "ti-trending-up" :
                              "ti-trending-down";
            var varianceText = variance == 0 ? Localizer["Balanced"].Value :
                              variance > 0 ? Localizer["Over"].Value : Localizer["Short"].Value;

            <div class="alert @varianceClass mb-4">
                <div class="d-flex align-items-center">
                    <i class="ti @varianceIcon me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="fw-semibold">@varianceText: @this.FormatCurrency(Math.Abs(variance))</div>
                        @if (variance != 0)
                        {
                            <small>
                                @(variance > 0 ? Localizer["OverMessage"].Value : Localizer["ShortMessage"].Value)
                            </small>
                        }
                    </div>
                </div>
            </div>
        }

        @* Variance Acknowledgment *@
        @if (this.HasVariance)
        {
            <div class="mb-3">
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" @bind="this.AcknowledgeVariance" />
                    <span class="form-check-label">
                        @Localizer["AcknowledgeVariance"]
                    </span>
                </label>
            </div>
        }

        <div class="mb-0">
            <label class="form-label">@Localizer["ClosingNotes"]</label>
            <textarea class="form-control" @bind="this.Notes" rows="2"
                      placeholder="@Localizer["ClosingNotesPlaceholder"]"></textarea>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="closeSessionForm" class="btn btn-primary"
            disabled="@(!this.CanClose)">
        @if (this.Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-logout me-1"></i>
        @Localizer["CloseSession"]
    </button>
</div>

@code {
    [Parameter]
    public TillSession Entity { get; set; } = new();

    private decimal ActualCash { get; set; }
    private string? Notes { get; set; }
    private bool AcknowledgeVariance { get; set; }
    private bool Saving { get; set; }

    private bool HasEnteredAmount => this.ActualCash > 0;
    private bool HasVariance => this.HasEnteredAmount && this.ActualCash != this.Entity.ExpectedCash;
    private bool CanClose => !this.Saving && this.HasEnteredAmount && (!this.HasVariance || this.AcknowledgeVariance);

    protected override void OnParametersSet()
    {
        // Pre-fill with expected amount
        this.ActualCash = this.Entity.ExpectedCash;
    }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }

    private async Task SaveAsync()
    {
        if (!this.CanClose) return;

        try
        {
            this.Saving = true;

            var result = await this.TillService.CloseSessionAsync(
                this.Entity.TillSessionId,
                this.ActualCash,
                this.Notes,
                this.UserName);

            if (result.Success)
            {
                this.ModalService.Close(ModalResult.Ok(result));
            }
            else
            {
                this.ShowError(result.Message ?? "Failed to close session");
            }
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error closing till session");
            this.ShowError("Failed to close session");
        }
        finally
        {
            this.Saving = false;
        }
    }
}
