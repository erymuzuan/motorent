@using MotoRent.Domain.Entities
@using MotoRent.Client.Components.Till
@inherits LocalizedDialogBase<TillSession, TillCloseSessionDialog>
@inject TillService TillService

<form id="closeSessionForm" @onsubmit="this.SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
        @* Session Summary (compact) *@
        <div class="card bg-muted-lt mb-3">
            <div class="card-body py-2">
                <div class="row text-center small">
                    <div class="col-4 border-end">
                        <small class="text-secondary d-block">@Localizer["Opening"]</small>
                        <span class="fw-semibold">@this.FormatCurrency(this.Entity.OpeningFloat)</span>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-success d-block">@Localizer["CashIn"]</small>
                        <span class="fw-semibold text-success">+@this.FormatCurrency(this.Entity.TotalCashIn)</span>
                    </div>
                    <div class="col-4">
                        <small class="text-danger d-block">@Localizer["CashOut"]</small>
                        <span class="fw-semibold text-danger">-@this.FormatCurrency(this.Entity.TotalCashOut + this.Entity.TotalDropped)</span>
                    </div>
                </div>
            </div>
        </div>

        @* Denomination Count Panel *@
        <ClosingCountPanel
            ExpectedBalances="@GetExpectedBalances()"
            OnBreakdownsChanged="@OnBreakdownsChanged"
            Disabled="@Saving" />

        @* Variance Acknowledgment *@
        @if (this.HasVariance)
        {
            <div class="mb-3 mt-3">
                <label class="form-check">
                    <input type="checkbox" class="form-check-input" @bind="this.AcknowledgeVariance" />
                    <span class="form-check-label">
                        @Localizer["AcknowledgeVariance"]
                    </span>
                </label>
            </div>
        }

        <div class="mb-0 mt-3">
            <label class="form-label">@Localizer["ClosingNotes"]</label>
            <textarea class="form-control" @bind="this.Notes" rows="2"
                      placeholder="@Localizer["ClosingNotesPlaceholder"]"></textarea>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="closeSessionForm" class="btn btn-primary"
            disabled="@(!this.CanClose)">
        @if (this.Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-logout me-1"></i>
        @Localizer["CloseSession"]
    </button>
</div>

@code {
    private decimal ActualCash { get; set; }
    private string? Notes { get; set; }
    private bool AcknowledgeVariance { get; set; }
    private bool Saving { get; set; }
    private List<CurrencyDenominationBreakdown> m_currencyBreakdowns = [];

    private bool HasEnteredAmount => this.ActualCash > 0 ||
        m_currencyBreakdowns.Any(b => b.Currency == SupportedCurrencies.THB && b.Total > 0);

    private bool HasVariance => m_currencyBreakdowns.Any(b => b.Variance.HasValue && b.Variance.Value != 0);

    private bool CanClose => !this.Saving && this.HasEnteredAmount && (!this.HasVariance || this.AcknowledgeVariance);

    protected override void OnParametersSet()
    {
        // Initialize with expected balances (no pre-fill for closing count)
        this.ActualCash = 0;
    }

    /// <summary>
    /// Gets expected balances from TillSession.CurrencyBalances.
    /// If CurrencyBalances is null, falls back to ExpectedCash for THB only.
    /// </summary>
    private Dictionary<string, decimal> GetExpectedBalances()
    {
        if (this.Entity.CurrencyBalances != null && this.Entity.CurrencyBalances.Count > 0)
        {
            return this.Entity.CurrencyBalances;
        }

        // Fallback for backward compatibility
        return new Dictionary<string, decimal>
        {
            [SupportedCurrencies.THB] = this.Entity.ExpectedCash
        };
    }

    /// <summary>
    /// Callback when denomination breakdowns change.
    /// Updates ActualCash for backward compatibility with CloseSessionAsync.
    /// </summary>
    private void OnBreakdownsChanged(List<CurrencyDenominationBreakdown> breakdowns)
    {
        m_currencyBreakdowns = breakdowns;

        // Update ActualCash from THB breakdown for backward compatibility
        var thbBreakdown = breakdowns.FirstOrDefault(b => b.Currency == SupportedCurrencies.THB);
        this.ActualCash = thbBreakdown?.Total ?? 0;

        StateHasChanged();
    }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }

    private async Task SaveAsync()
    {
        if (!this.CanClose) return;

        try
        {
            this.Saving = true;

            // First, close the session with THB actual (for backward compatibility)
            var result = await this.TillService.CloseSessionAsync(
                this.Entity.TillSessionId,
                this.ActualCash,
                this.Notes,
                this.UserName);

            if (!result.Success)
            {
                this.ShowError(result.Message ?? "Failed to close session");
                return;
            }

            // Save denomination count with full breakdowns
            if (m_currencyBreakdowns.Count > 0)
            {
                var denominationResult = await this.TillService.SaveDenominationCountAsync(
                    this.Entity.TillSessionId,
                    DenominationCountType.Closing,
                    m_currencyBreakdowns,
                    this.UserName,
                    isFinal: true,
                    notes: this.Notes);

                if (!denominationResult.Success)
                {
                    // Log but don't fail the close - denomination count is supplementary
                    this.Logger.LogWarning("Failed to save closing denomination count: {Message}",
                        denominationResult.Message);
                }
            }

            this.ModalService.Close(ModalResult.Ok(result));
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error closing till session");
            this.ShowError("Failed to close session");
        }
        finally
        {
            this.Saving = false;
        }
    }
}
