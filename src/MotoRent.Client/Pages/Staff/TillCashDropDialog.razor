@using MotoRent.Domain.Entities
@inherits LocalizedDialogBase<TillTransaction, TillCashDropDialog>
@inject TillService TillService

<form id="cashDropForm" @onsubmit="this.SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        <div class="text-center mb-4">
            <span class="avatar avatar-xl @(this.IsDrop ? "bg-danger-lt" : "bg-success-lt") mb-3">
                <i class="@(this.IsDrop ? "ti ti-archive" : "ti ti-cash")" style="font-size: 2rem;"></i>
            </span>
            <p class="text-secondary">
                @if (this.IsDrop)
                {
                    @Localizer["CashDropDescription"]
                }
                else
                {
                    @Localizer["TopUpDescription"]
                }
            </p>
        </div>

        <div class="mb-3">
            <label class="form-label required">@Localizer["Amount"]</label>
            <div class="input-group input-group-lg">
                <span class="input-group-text">฿</span>
                <input type="number" class="form-control text-end" @bind="this.Amount"
                       required min="1" step="any" max="@(this.IsDrop ? this.AvailableCash : decimal.MaxValue)"
                       placeholder="0" autofocus />
            </div>
            @if (this.IsDrop && this.AvailableCash > 0)
            {
                <div class="form-hint mt-1">
                    @Localizer["AvailableCash"]: <strong>฿@this.AvailableCash.ToString("N0")</strong>
                </div>
            }
        </div>

        <div class="mb-0">
            <label class="form-label">@Localizer["Notes"]</label>
            <textarea class="form-control" @bind="this.Notes" rows="2"
                      placeholder="@Localizer["NotesPlaceholder"]"></textarea>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="cashDropForm" class="btn @(this.IsDrop ? "btn-danger" : "btn-success")"
            disabled="@this.Saving">
        @if (this.Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        @if (this.IsDrop)
        {
            <i class="ti ti-archive me-1"></i>
            @Localizer["DropCash"]
        }
        else
        {
            <i class="ti ti-cash me-1"></i>
            @Localizer["TopUp"]
        }
    </button>
</div>

@code {
    [Parameter]
    public int SessionId { get; set; }

    [Parameter]
    public bool IsDrop { get; set; } = true;

    [Parameter]
    public decimal AvailableCash { get; set; }

    private decimal Amount { get; set; }
    private string? Notes { get; set; }
    private bool Saving { get; set; }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }

    private async Task SaveAsync()
    {
        if (this.Saving || this.Amount <= 0) return;

        // Validate drop amount doesn't exceed available cash
        if (this.IsDrop && this.Amount > this.AvailableCash)
        {
            this.ShowError(Localizer["CannotDropMoreThanAvailable"]);
            return;
        }

        try
        {
            this.Saving = true;

            var result = this.IsDrop
                ? await this.TillService.RecordDropAsync(this.SessionId, this.Amount, this.UserName, this.Notes)
                : await this.TillService.RecordTopUpAsync(this.SessionId, this.Amount, this.UserName, this.Notes);

            if (result.Success)
            {
                this.ModalService.Close(ModalResult.Ok(result));
            }
            else
            {
                this.ShowError(result.Message ?? "Failed to record transaction");
            }
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error recording cash drop/top up");
            this.ShowError("Failed to record transaction");
        }
        finally
        {
            this.Saving = false;
        }
    }
}
