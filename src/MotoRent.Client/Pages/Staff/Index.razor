@page "/staff"
@using MotoRent.Client.Components.Staff
@using MotoRent.Domain
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<Index>

<PageTitle>@Localizer["PageTitle"]</PageTitle>

@* Main Action Cards *@
<div class="row g-3 mb-4">
    <div class="col-6">
        <StaffActionCard Icon="ti-login"
                         Title="@Localizer["NewCheckIn"]"
                         Subtitle="@Localizer["NewCheckInSubtitle"]"
                         IconColor="primary"
                         OnClick="@(() => NavigationManager.NavigateTo("/rentals/checkin"))" />
    </div>

    <div class="col-6">
        <StaffActionCard Icon="ti-logout"
                         Title="@Localizer["ReturnBike"]"
                         Subtitle="@Localizer["ReturnBikeSubtitle"]"
                         IconColor="secondary"
                         OnClick="@(() => NavigationManager.NavigateTo("/staff/return"))" />
    </div>

    <div class="col-6">
        <StaffActionCard Icon="ti-receipt"
                         Title="@Localizer["Active"]"
                         Subtitle="@Localizer["ActiveSubtitle"]"
                         IconColor="success"
                         BadgeCount="@m_activeCount"
                         BadgeColor="success"
                         OnClick="@(() => NavigationManager.NavigateTo("/staff/rentals"))" />
    </div>

    <div class="col-6">
        <StaffActionCard Icon="ti-alert-triangle"
                         Title="@Localizer["Overdue"]"
                         Subtitle="@Localizer["OverdueSubtitle"]"
                         IconColor="danger"
                         BadgeCount="@m_overdueCount"
                         BadgeColor="danger"
                         OnClick="@(() => NavigationManager.NavigateTo("/staff/rentals?filter=overdue"))" />
    </div>
</div>

@* Due Today Section *@
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="card-title mb-0">
                <i class="ti ti-clock me-2" style="vertical-align: middle;"></i>
                @Localizer["DueToday"]
            </h4>
            <span class="badge bg-warning">@m_dueTodayRentals.Count</span>
        </div>

        @if (m_loading)
        {
            <div class="progress progress-sm">
                <div class="progress-bar progress-bar-indeterminate"></div>
            </div>
        }
        else if (m_dueTodayRentals.Count == 0)
        {
            <div class="alert alert-info">
                @Localizer["NoBikesDueToday"]
            </div>
        }
        else
        {
            <div class="d-flex flex-column gap-2">
                @foreach (var rental in m_dueTodayRentals.Take(5))
                {
                    <div class="card bg-muted-lt">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-medium">@rental.RenterName</div>
                                    <small class="text-secondary">
                                        @rental.MotorbikeName (@rental.LicensePlate)
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="@(rental.IsOverdue ? "text-danger" : "text-warning") small">
                                        @(rental.IsOverdue ? Localizer["OverdueLabel"] : rental.DueTime?.ToString("HH:mm") ?? Localizer["Today"])
                                    </div>
                                    <button type="button" class="btn btn-sm btn-ghost-primary"
                                            @onclick="@(() => ProcessReturn(rental.RentalId))">
                                        @Localizer["Return"]
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (m_dueTodayRentals.Count > 5)
            {
                <button type="button" class="btn btn-ghost-primary w-100 mt-2"
                        @onclick="@(() => NavigationManager.NavigateTo("/staff/rentals?filter=duetoday"))">
                    @Localizer["ViewAllCount", m_dueTodayRentals.Count]
                </button>
            }
        }
    </div>
</div>

@* Quick Stats Footer *@
<div class="row g-2 mt-4">
    <div class="col-4 text-center">
        <div class="h3 text-primary mb-0">@m_availableBikes</div>
        <small class="text-secondary">@Localizer["Available"]</small>
    </div>
    <div class="col-4 text-center border-start border-end">
        <div class="h3 text-success mb-0">@m_activeCount</div>
        <small class="text-secondary">@Localizer["Rented"]</small>
    </div>
    <div class="col-4 text-center">
        <div class="h3 text-warning mb-0">@m_maintenanceCount</div>
        <small class="text-secondary">@Localizer["Maintenance"]</small>
    </div>
</div>

@code {
    private bool m_loading = true;
    private int m_activeCount;
    private int m_overdueCount;
    private int m_availableBikes;
    private int m_maintenanceCount;
    private List<DueTodayItem> m_dueTodayRentals = [];

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            this.m_loading = true;

            // TODO: Replace with actual service calls
            // var stats = await RentalService.GetDashboardStatsAsync();
            // m_activeCount = stats.ActiveRentals;
            // m_overdueCount = stats.OverdueRentals;
            // m_availableBikes = stats.AvailableBikes;
            // m_maintenanceCount = stats.MaintenanceBikes;

            // Placeholder data for now
            this.m_activeCount = 12;
            this.m_overdueCount = 2;
            this.m_availableBikes = 24;
            this.m_maintenanceCount = 3;

            // Placeholder due today items
            this.m_dueTodayRentals =
            [
                new("John Smith", "Honda Click 125", "A-1234", 1, TimeOnly.Parse("14:00"), false),
                new("Maria Garcia", "Yamaha Aerox 155", "B-5678", 2, TimeOnly.Parse("16:00"), false),
                new("James Wilson", "Honda PCX 160", "C-9012", 3, TimeOnly.Parse("18:00"), false),
                new("Sophie Chen", "Yamaha NMAX 155", "D-3456", 4, null, true),
                new("Alex Brown", "Honda Wave 110", "E-7890", 5, TimeOnly.Parse("12:00"), false),
            ];

            await Task.CompletedTask;
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private void ProcessReturn(int rentalId)
    {
        this.NavigationManager.NavigateTo($"/staff/return?rentalId={rentalId}");
    }

    private record DueTodayItem(
        string RenterName,
        string MotorbikeName,
        string LicensePlate,
        int RentalId,
        TimeOnly? DueTime,
        bool IsOverdue
    );
}