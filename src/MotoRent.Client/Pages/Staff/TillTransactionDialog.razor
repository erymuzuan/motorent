@using MotoRent.Domain.Models
@inherits LocalizedDialogBase<object, TillTransactionDialog>
@inject BookingService BookingService
@inject RentalService RentalService

<div class="modal-body" style="padding-bottom: 100px; min-height: 400px;">
    @* === Search Input === *@
    <div class="mb-3">
        <label class="form-label">@Localizer["SearchTransaction"]</label>
        <div class="input-group">
            <input type="text" class="form-control form-control-lg"
                   placeholder="@Localizer["SearchHint"]"
                   @bind="m_searchTerm" @bind:event="oninput"
                   @onkeydown="OnSearchKeyDown" />
            <button type="button" class="btn btn-primary" @onclick="SearchAsync"
                    disabled="@m_searching">
                @if (m_searching)
                {
                    <span class="spinner-border spinner-border-sm"></span>
                }
                else
                {
                    <i class="ti ti-search"></i>
                }
            </button>
        </div>
        <div class="form-hint">@Localizer["SearchHintDetail"]</div>
    </div>

    @* === Loading State === *@
    @if (m_loading)
    {
        <div class="d-flex justify-content-center py-4">
            <span class="spinner-border spinner-border-sm me-2"></span>
            @Localizer["Loading"]
        </div>
    }
    else
    {
        @* === Search Results === *@
        @if (m_searched && m_bookingResults.Count == 0 && m_rentalResults.Count == 0)
        {
            <div class="alert alert-warning">
                <i class="ti ti-alert-triangle me-2"></i>
                @Localizer["NoResultsFound"]
            </div>
        }
        else
        {
            @* === Bookings Section === *@
            @if (m_bookingResults.Count > 0)
            {
                <div class="mb-4">
                    <h5 class="mb-3 d-flex align-items-center gap-2">
                        <i class="ti ti-calendar-event text-primary"></i>
                        @Localizer["Bookings"]
                        <span class="badge bg-primary">@m_bookingResults.Count</span>
                    </h5>
                    <div class="list-group">
                        @foreach (var booking in m_bookingResults)
                        {
                            <button type="button" class="list-group-item list-group-item-action"
                                    @onclick="@(() => SelectBooking(booking))">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-semibold">
                                            <span class="badge bg-purple me-2">@booking.BookingRef</span>
                                            @booking.CustomerName
                                        </div>
                                        <div class="small text-muted mt-1">
                                            <i class="ti ti-calendar me-1"></i>
                                            @booking.StartDate.ToString("dd MMM") - @booking.EndDate.ToString("dd MMM yyyy")
                                        </div>
                                        @if (!string.IsNullOrEmpty(booking.CustomerPhone))
                                        {
                                            <div class="small text-muted">
                                                <i class="ti ti-phone me-1"></i>@booking.CustomerPhone
                                            </div>
                                        }
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@FormatAmount(booking.TotalAmount)</div>
                                        <div class="small">
                                            @if (booking.BalanceDue > 0)
                                            {
                                                <span class="text-warning">
                                                    @Localizer["Due"]: @FormatAmount(booking.BalanceDue)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-success">@Localizer["FullyPaid"]</span>
                                            }
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge @GetBookingStatusBadgeClass(booking)">
                                                @GetTransactionTypeLabel(booking)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        }
                    </div>
                </div>
            }

            @* === Active Rentals Section === *@
            @if (m_rentalResults.Count > 0)
            {
                <div class="mb-4">
                    <h5 class="mb-3 d-flex align-items-center gap-2">
                        <i class="ti ti-motorbike text-success"></i>
                        @Localizer["ActiveRentals"]
                        <span class="badge bg-success">@m_rentalResults.Count</span>
                    </h5>
                    <div class="list-group">
                        @foreach (var rental in m_rentalResults)
                        {
                            <button type="button" class="list-group-item list-group-item-action"
                                    @onclick="@(() => SelectRental(rental))">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-semibold">
                                            <span class="badge bg-success me-2">#@rental.RentalId</span>
                                            @rental.RenterName
                                        </div>
                                        <div class="small text-muted mt-1">
                                            <i class="ti ti-motorbike me-1"></i>@rental.VehicleName
                                        </div>
                                        <div class="small text-muted">
                                            <i class="ti ti-calendar me-1"></i>
                                            @rental.StartDate.ToString("dd MMM") - @rental.ExpectedEndDate.ToString("dd MMM yyyy")
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold">@FormatAmount(rental.TotalAmount)</div>
                                        <div class="small">
                                            <span class="badge bg-success-lt text-success">@Localizer["Active"]</span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge bg-info">@Localizer["CheckOut"]</span>
                                        </div>
                                    </div>
                                </div>
                            </button>
                        }
                    </div>
                </div>
            }

            @* === Recent Transactions (when no search) === *@
            @if (!m_searched && m_bookingResults.Count == 0 && m_rentalResults.Count == 0)
            {
                <div class="alert alert-info">
                    <i class="ti ti-info-circle me-2"></i>
                    @Localizer["SearchToStart"]
                </div>
            }
            else if (!m_searched && (m_bookingResults.Count > 0 || m_rentalResults.Count > 0))
            {
                <div class="small text-muted mb-3">
                    <i class="ti ti-history me-1"></i>
                    @Localizer["RecentTransactions"]
                </div>
            }
        }
    }
</div>

<div class="modal-footer sticky-bottom bg-white border-top" style="z-index: 10;">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @Localizer["Cancel"]
    </button>
</div>

@code {
    [Parameter] public int SessionId { get; set; }
    [Parameter] public int ShopId { get; set; }

    // Search state
    private string m_searchTerm = "";
    private List<Booking> m_bookingResults = [];
    private List<Rental> m_rentalResults = [];
    private bool m_loading;
    private bool m_searching;
    private bool m_searched;

    protected override async Task OnInitializedAsync()
    {
        await LoadRecentTransactionsAsync();
    }

    /// <summary>
    /// Loads recent bookings and active rentals on dialog open.
    /// Shows items from the last 7 days that are actionable.
    /// </summary>
    private async Task LoadRecentTransactionsAsync()
    {
        try
        {
            m_loading = true;
            m_bookingResults.Clear();
            m_rentalResults.Clear();

            // Load recent bookings (last 7 days) that are actionable
            var fromDate = DateTimeOffset.Now.AddDays(-7);
            var bookingsTask = BookingService.GetBookingsAsync(
                preferredShopId: null,
                status: null,
                fromDate: fromDate,
                toDate: null,
                searchTerm: null,
                page: 1,
                pageSize: 20);

            // Load active rentals
            var rentalsTask = RentalService.GetRentalsAsync(
                shopId: ShopId,
                status: "Active",
                searchTerm: null,
                fromDate: null,
                toDate: null,
                page: 1,
                pageSize: 20);

            await Task.WhenAll(bookingsTask, rentalsTask);

            // Filter bookings to only actionable ones (with balance due or pending check-in)
            var bookings = await bookingsTask;
            m_bookingResults.AddRange(bookings.ItemCollection
                .Where(b => b.CanReceivePayment || b.Status == BookingStatus.Confirmed));

            // Add active rentals
            var rentals = await rentalsTask;
            m_rentalResults.AddRange(rentals.ItemCollection.Where(r => r.Status == "Active"));
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Failed to load recent transactions");
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchAsync();
        }
    }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(m_searchTerm) || m_searching) return;

        try
        {
            m_searching = true;
            m_searched = true;
            m_bookingResults.Clear();
            m_rentalResults.Clear();

            var searchTerm = m_searchTerm.Trim();
            var searchTermUpper = searchTerm.ToUpperInvariant();

            // Try exact booking reference match first (4-8 characters)
            if (searchTerm.Length >= 4 && searchTerm.Length <= 8)
            {
                var booking = await BookingService.GetBookingByRefAsync(searchTermUpper);
                if (booking is not null)
                {
                    m_bookingResults.Add(booking);
                }
            }

            // Search by customer name if no exact ref match or search term is longer
            if (m_bookingResults.Count == 0 || searchTerm.Length > 8)
            {
                var bookings = await BookingService.GetBookingsAsync(
                    preferredShopId: null,
                    status: null,
                    fromDate: null,
                    toDate: null,
                    searchTerm: searchTerm,
                    page: 1,
                    pageSize: 20);

                // Filter to actionable bookings
                var actionableBookings = bookings.ItemCollection
                    .Where(b => b.CanReceivePayment || b.Status == BookingStatus.Confirmed || b.Status == BookingStatus.Pending)
                    .ToList();

                // Avoid duplicates if exact ref was already added
                foreach (var b in actionableBookings)
                {
                    if (!m_bookingResults.Any(existing => existing.BookingId == b.BookingId))
                    {
                        m_bookingResults.Add(b);
                    }
                }
            }

            // Search active rentals by renter name
            var rentals = await RentalService.SearchActiveRentalsAsync(searchTerm, ShopId);
            m_rentalResults.AddRange(rentals);
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Failed to search transactions for term: {SearchTerm}", m_searchTerm);
        }
        finally
        {
            m_searching = false;
        }
    }

    private void SelectBooking(Booking booking)
    {
        var transactionType = DetectTransactionType(booking);
        var result = new TransactionSearchResult
        {
            EntityType = TransactionEntityType.Booking,
            Booking = booking,
            TransactionType = transactionType
        };

        this.ModalService.Close(ModalResult.Ok(result));
    }

    private void SelectRental(Rental rental)
    {
        var result = new TransactionSearchResult
        {
            EntityType = TransactionEntityType.Rental,
            Rental = rental,
            TransactionType = TillTransactionType.RentalPayment // Check-out is a rental payment context
        };

        this.ModalService.Close(ModalResult.Ok(result));
    }

    /// <summary>
    /// Detects the appropriate transaction type based on booking status.
    /// </summary>
    private static TillTransactionType DetectTransactionType(Booking booking)
    {
        // If booking has balance due, it's a deposit payment
        if (booking.BalanceDue > 0)
        {
            return TillTransactionType.BookingDeposit;
        }

        // If booking is confirmed and fully paid, it's a check-in
        if (booking.Status == BookingStatus.Confirmed)
        {
            return TillTransactionType.CheckIn;
        }

        // Default to booking deposit for pending bookings
        return TillTransactionType.BookingDeposit;
    }

    private string GetTransactionTypeLabel(Booking booking)
    {
        var type = DetectTransactionType(booking);
        return type switch
        {
            TillTransactionType.BookingDeposit => Localizer["BookingDeposit"],
            TillTransactionType.CheckIn => Localizer["CheckIn"],
            _ => Localizer["BookingDeposit"]
        };
    }

    private static string GetBookingStatusBadgeClass(Booking booking)
    {
        var type = DetectTransactionType(booking);
        return type switch
        {
            TillTransactionType.BookingDeposit => "bg-warning",
            TillTransactionType.CheckIn => "bg-primary",
            _ => "bg-secondary"
        };
    }

    private static string FormatAmount(decimal amount)
    {
        return $"\u0e3f{amount:N0}"; // Thai Baht symbol
    }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }
}
