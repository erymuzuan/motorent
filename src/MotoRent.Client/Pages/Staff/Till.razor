@page "/staff/till"
@using MotoRent.Domain.Entities
@using MotoRent.Services
@using Microsoft.AspNetCore.Authorization
@inherits LocalizedComponentBase<Till>
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inject TillService TillService
@inject ShopService ShopService

<MotoRentPageTitle>@Localizer["CashierTill"]</MotoRentPageTitle>

@if (this.m_loading)
{
    <div class="container-xl py-4">
        <LoadingSkeleton Loading="true" Mode="LoadingSkeleton.PlaceholderMode.Card" />
    </div>
}
else if (this.m_session is null)
{
    @* No active session - show Open Session UI *@
    <div class="container-xl py-4">
        <div class="page-header mb-4">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        <i class="ti ti-cash-register me-2"></i>
                        @Localizer["CashierTill"]
                    </h2>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <span class="avatar avatar-xl bg-primary-lt">
                                <i class="ti ti-lock-open" style="font-size: 2rem;"></i>
                            </span>
                        </div>
                        <h3>@Localizer["StartYourShift"]</h3>
                        <p class="text-secondary mb-4">
                            @Localizer["OpenNewTillSessionDescription"]
                        </p>
                        <button type="button" class="btn btn-primary btn-lg" @onclick="this.OpenSessionDialog">
                            <i class="ti ti-plus me-2"></i>
                            @Localizer["OpenTillSession"]
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    @* Active session - show Till Dashboard *@
    <div class="container-xl py-3 mt-5">
        @* Session Header *@
        <div class="card bg-primary text-white mb-3">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-white text-primary">@Localizer["Open"]</span>
                            <span class="fw-semibold">@this.m_session!.StaffDisplayName</span>
                        </div>
                        <small class="text-white-50">
                            @Localizer["Started"] @this.FormatDateTime(this.m_session.OpenedAt)
                        </small>
                    </div>
                    <div class="text-end">
                        <small class="text-white-50">@Localizer["OpeningFloat"]</small>
                        <div class="h3 mb-0">@this.FormatCurrency(this.m_session.OpeningFloat)</div>
                    </div>
                </div>
            </div>
        </div>

        @* Cash Balance Cards *@
        <div class="row g-3 mb-3">
            <div class="col-6">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <span class="avatar bg-success-lt me-3">
                                <i class="ti ti-arrow-down-left text-success"></i>
                            </span>
                            <div>
                                <small class="text-secondary d-block">@Localizer["CashIn"]</small>
                                <span class="h3 mb-0 text-success">@this.FormatCurrency(this.m_session.TotalCashIn)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <span class="avatar bg-danger-lt me-3">
                                <i class="ti ti-arrow-up-right text-danger"></i>
                            </span>
                            <div>
                                <small class="text-secondary d-block">@Localizer["CashOut"]</small>
                                <span class="h3 mb-0 text-danger">@this.FormatCurrency(this.m_session.TotalCashOut)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Expected Balance *@
        <div class="card mb-3">
            <div class="card-body py-3 text-center">
                <small class="text-secondary">@Localizer["ExpectedCashInTill"]</small>
                <div class="h1 mb-0">@this.FormatCurrency(this.m_session.ExpectedCash)</div>
                @if (this.m_session.TotalDropped > 0)
                {
                    <small class="text-secondary">
                        <i class="ti ti-safe me-1"></i>
                        @Localizer["DroppedToSafe", $"{this.m_session.TotalDropped:N0}"]
                    </small>
                }
            </div>
        </div>

        @* Non-Cash Summary (if any) *@
        @if (this.m_session.TotalNonCashPayments > 0)
        {
            <div class="card mb-3">
                <div class="card-header py-2">
                    <h4 class="card-title mb-0">
                        <i class="ti ti-credit-card me-2"></i>
                        @Localizer["NonCashPayments"]
                    </h4>
                </div>
                <div class="card-body py-2">
                    <div class="row g-2 text-center">
                        @if (this.m_session.TotalCardPayments > 0)
                        {
                            <div class="col">
                                <small class="text-secondary d-block">@Localizer["Card"]</small>
                                <span class="fw-semibold">@this.FormatCurrency(this.m_session.TotalCardPayments)</span>
                            </div>
                        }
                        @if (this.m_session.TotalBankTransfers > 0)
                        {
                            <div class="col">
                                <small class="text-secondary d-block">@Localizer["BankTransfer"]</small>
                                <span class="fw-semibold">@this.FormatCurrency(this.m_session.TotalBankTransfers)</span>
                            </div>
                        }
                        @if (this.m_session.TotalPromptPay > 0)
                        {
                            <div class="col">
                                <small class="text-secondary d-block">@Localizer["PromptPay"]</small>
                                <span class="fw-semibold">@this.FormatCurrency(this.m_session.TotalPromptPay)</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @* Quick Actions *@
        <div class="card mb-3">
            <div class="card-header py-2">
                <h4 class="card-title mb-0">@Localizer["QuickPayouts"]</h4>
            </div>
            <div class="card-body py-2">
                <div class="row g-2">
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-warning w-100"
                                @onclick="@(() => this.RecordPayoutDialog(TillTransactionType.FuelReimbursement))">
                            <i class="ti ti-gas-station d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>@Localizer["Fuel"]</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-info w-100"
                                @onclick="@(() => this.RecordPayoutDialog(TillTransactionType.AgentCommission))">
                            <i class="ti ti-users d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>@Localizer["Agent"]</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-secondary w-100"
                                @onclick="@(() => this.RecordPayoutDialog(TillTransactionType.PettyCash))">
                            <i class="ti ti-wallet d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>@Localizer["PettyCash"]</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @* Till Operations *@
        <div class="card mb-3">
            <div class="card-header py-2">
                <h4 class="card-title mb-0">@Localizer["TillOperations"]</h4>
            </div>
            <div class="card-body py-2">
                <div class="row g-2">
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-danger w-100" @onclick="this.CashDropDialog">
                            <i class="ti ti-safe d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>@Localizer["CashDrop"]</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-success w-100" @onclick="this.TopUpDialog">
                            <i class="ti ti-cash d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>@Localizer["TopUp"]</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-primary w-100" @onclick="this.CloseSessionDialog">
                            <i class="ti ti-logout d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>@Localizer["CloseShift"]</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @* Recent Transactions *@
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">@Localizer["RecentTransactions"]</h4>
                <button type="button" class="btn btn-sm btn-ghost-secondary" @onclick="this.ViewHistoryDialog">
                    @Localizer["ViewAll"]
                </button>
            </div>
            <div class="list-group list-group-flush">
                @if (!this.m_recentTransactions.Any())
                {
                    <div class="list-group-item text-center text-secondary py-4">
                        <i class="ti ti-receipt-off" style="font-size: 2rem;"></i>
                        <div class="mt-2">@Localizer["NoTransactionsYet"]</div>
                    </div>
                }
                else
                {
                    @foreach (var txn in this.m_recentTransactions)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex gap-2">
                                    <span class="avatar avatar-sm @GetTransactionAvatarClass(txn)">
                                        <i class="@GetTransactionIcon(txn)"></i>
                                    </span>
                                    <div>
                                        <div class="fw-medium">@GetTransactionTypeName(txn.TransactionType)</div>
                                        <small class="text-secondary">@txn.Description</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="@GetAmountColorClass(txn) fw-semibold">
                                        @(txn.Direction == TillTransactionDirection.In ? "+" : "-")@this.FormatCurrency(txn.Amount)
                                    </div>
                                    <small class="text-secondary">@this.FormatTime(txn.TransactionTime)</small>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    private bool m_loading = true;
    private int m_shopId;
    private TillSession? m_session;
    private List<TillTransaction> m_recentTransactions = [];

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            this.m_loading = true;

            // Get current shop
            var shops = await this.ShopService.GetShopsAsync(page: 1, pageSize: 1);
            if (shops.ItemCollection.Any())
            {
                this.m_shopId = shops.ItemCollection.First().ShopId;

                // Get active session
                this.m_session = await this.TillService.GetActiveSessionAsync(this.m_shopId, this.UserName);

                // Load recent transactions if session exists
                if (this.m_session is not null)
                {
                    this.m_recentTransactions = await this.TillService.GetRecentTransactionsAsync(this.m_session.TillSessionId, 10);
                }
            }
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error loading till data");
            this.ShowError("Failed to load till data");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task OpenSessionDialog()
    {
        var result = await this.DialogService.Create<TillOpenSessionDialog>("Open Till Session")
            .WithParameter(x => x.ShopId, this.m_shopId)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Till session opened");
            await this.LoadDataAsync();
        }
    }

    private async Task CloseSessionDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillCloseSessionDialog>("Close Till Session")
            .WithParameter(x => x.Entity, this.m_session)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Till session closed");
            this.m_session = null;
            this.m_recentTransactions.Clear();
            this.StateHasChanged();
        }
    }

    private async Task RecordPayoutDialog(TillTransactionType type)
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillRecordPayoutDialog>(GetTransactionTypeName(type))
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.PayoutType, type)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Payout recorded");
            await this.LoadDataAsync();
        }
    }

    private async Task CashDropDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillCashDropDialog>("Cash Drop")
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.IsDrop, true)
            .WithSize(ModalSize.Small)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Cash drop recorded");
            await this.LoadDataAsync();
        }
    }

    private async Task TopUpDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillCashDropDialog>("Top Up")
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.IsDrop, false)
            .WithSize(ModalSize.Small)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Top up recorded");
            await this.LoadDataAsync();
        }
    }

    private async Task ViewHistoryDialog()
    {
        if (this.m_session is null) return;

        await this.DialogService.Create<TillHistoryDialog>("Transaction History")
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithSize(ModalSize.Large)
            .ShowDialogAsync();
    }

    private string GetTransactionTypeName(TillTransactionType type) => type switch
    {
        TillTransactionType.RentalPayment => Localizer["TxnRentalPayment"],
        TillTransactionType.BookingDeposit => Localizer["TxnBookingDeposit"],
        TillTransactionType.SecurityDeposit => Localizer["TxnSecurityDeposit"],
        TillTransactionType.DamageCharge => Localizer["TxnDamageCharge"],
        TillTransactionType.LateFee => Localizer["TxnLateFee"],
        TillTransactionType.Surcharge => Localizer["TxnSurcharge"],
        TillTransactionType.MiscellaneousIncome => Localizer["TxnMiscellaneous"],
        TillTransactionType.TopUp => Localizer["TxnTopUp"],
        TillTransactionType.CardPayment => Localizer["TxnCardPayment"],
        TillTransactionType.BankTransfer => Localizer["TxnBankTransfer"],
        TillTransactionType.PromptPay => Localizer["TxnPromptPay"],
        TillTransactionType.DepositRefund => Localizer["TxnDepositRefund"],
        TillTransactionType.FuelReimbursement => Localizer["TxnFuelReimbursement"],
        TillTransactionType.AgentCommission => Localizer["TxnAgentCommission"],
        TillTransactionType.PettyCash => Localizer["TxnPettyCash"],
        TillTransactionType.Drop => Localizer["TxnCashDrop"],
        TillTransactionType.CashShortage => Localizer["TxnCashShortage"],
        _ => type.ToString()
    };

    private static string GetTransactionIcon(TillTransaction txn) => txn.TransactionType switch
    {
        TillTransactionType.RentalPayment => "ti ti-motorbike",
        TillTransactionType.BookingDeposit => "ti ti-calendar-check",
        TillTransactionType.SecurityDeposit => "ti ti-shield-check",
        TillTransactionType.DamageCharge => "ti ti-alert-triangle",
        TillTransactionType.LateFee => "ti ti-clock-exclamation",
        TillTransactionType.TopUp => "ti ti-cash",
        TillTransactionType.CardPayment => "ti ti-credit-card",
        TillTransactionType.BankTransfer => "ti ti-building-bank",
        TillTransactionType.PromptPay => "ti ti-qrcode",
        TillTransactionType.DepositRefund => "ti ti-arrow-back",
        TillTransactionType.FuelReimbursement => "ti ti-gas-station",
        TillTransactionType.AgentCommission => "ti ti-users",
        TillTransactionType.PettyCash => "ti ti-wallet",
        TillTransactionType.Drop => "ti ti-safe",
        _ => "ti ti-receipt"
    };

    private static string GetTransactionAvatarClass(TillTransaction txn)
    {
        if (txn.Direction == TillTransactionDirection.In)
        {
            return txn.AffectsCash ? "bg-success-lt" : "bg-info-lt";
        }
        return "bg-danger-lt";
    }

    private static string GetAmountColorClass(TillTransaction txn)
    {
        return txn.Direction == TillTransactionDirection.In ? "text-success" : "text-danger";
    }
}
