@page "/staff/till"
@using MotoRent.Domain.Entities
@using MotoRent.Services
@using MotoRent.Client.Components.Receipts
@using MotoRent.Client.Components.Till
@using Microsoft.AspNetCore.Authorization
@inherits LocalizedComponentBase<Till>
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inject TillService TillService
@inject ShopService ShopService
@inject ReceiptService ReceiptService

<MotoRentPageTitle>@Localizer["CashierTill"]</MotoRentPageTitle>

@if (this.m_loading)
{
    <div class="container-xl py-4">
        <LoadingSkeleton Loading="true" Mode="LoadingSkeleton.PlaceholderMode.Card" />
    </div>
}
else if (this.m_session is null)
{
    @* ========== NO ACTIVE SESSION - OPEN SESSION UI ========== *@
    <div class="mr-page-header">
        <div class="container-xl">
            <nav class="mr-breadcrumb">
                <span class="mr-breadcrumb-item"><a href="/"><i class="ti ti-home"></i></a></span>
                <span class="mr-breadcrumb-separator"><i class="ti ti-chevron-right"></i></span>
                <span class="mr-breadcrumb-item active">@Localizer["CashierTill"]</span>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mr-page-title">
                        <i class="ti ti-cash-register"></i>
                        @Localizer["CashierTill"]
                    </h1>
                    <p class="mr-page-subtitle">@Localizer["ManageYourCashDrawer"]</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container-xl py-4">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="mr-card text-center p-5">
                    <div class="mb-4">
                        <div class="mr-till-open-icon">
                            <i class="ti ti-lock-open"></i>
                        </div>
                    </div>
                    <h2 class="mb-2">@Localizer["StartYourShift"]</h2>
                    <p class="text-secondary mb-4 px-4">
                        @Localizer["OpenNewTillSessionDescription"]
                    </p>
                    <button type="button" class="mr-btn-primary-action" @onclick="this.OpenSessionDialog">
                        <i class="ti ti-player-play"></i>
                        @Localizer["OpenTillSession"]
                    </button>
                </div>
            </div>
        </div>
    </div>
}
else
{
    @* ========== ACTIVE SESSION - TILL DASHBOARD ========== *@

    @* Session Status Bar *@
    <div class="mr-till-session-bar">
        <div class="container-xl">
            <div class="d-flex justify-content-between align-items-center py-2">
                <div class="d-flex align-items-center gap-3">
                    <span class="mr-status-badge mr-status-badge-success">
                        <span class="mr-status-dot"></span>
                        @Localizer["SessionActive"]
                    </span>
                    <span class="text-white-50 d-none d-sm-inline">
                        <i class="ti ti-user me-1"></i>@this.m_session!.StaffDisplayName
                    </span>
                </div>
                <div class="d-flex align-items-center gap-2 text-white-50">
                    <i class="ti ti-clock"></i>
                    <span>@Localizer["Started"] @this.FormatTime(this.m_session.OpenedAt)</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-xl py-3">
        @* ========== CASH BALANCE HERO ========== *@
        <div class="mr-till-hero mb-4">
            <div class="mr-till-hero-content">
                <div class="mr-till-hero-label">@Localizer["ExpectedCashInTill"]</div>
                <div class="mr-till-hero-amount">
                    <span class="mr-till-currency">฿</span>
                    <span class="mr-till-value">@this.m_session.ExpectedCash.ToString("N0")</span>
                </div>
                @if (this.m_session.TotalDropped > 0)
                {
                    <div class="mr-till-hero-subtitle">
                        <i class="ti ti-archive me-1"></i>
                        @Localizer["DroppedToSafe", $"{this.m_session.TotalDropped:N0}"]
                    </div>
                }
            </div>
            <div class="mr-till-hero-meta">
                <div class="mr-till-meta-item">
                    <span class="mr-till-meta-label">@Localizer["OpeningFloat"]</span>
                    <span class="mr-till-meta-value">฿@this.m_session.OpeningFloat.ToString("N0")</span>
                </div>
            </div>
        </div>

        @* ========== CASH FLOW CARDS ========== *@
        <div class="row g-3 mb-4">
            <div class="col-6">
                <div class="mr-till-stat-card mr-till-stat-in">
                    <div class="mr-till-stat-icon">
                        <i class="ti ti-trending-up"></i>
                    </div>
                    <div class="mr-till-stat-content">
                        <div class="mr-till-stat-label">@Localizer["CashIn"]</div>
                        <div class="mr-till-stat-value">฿@this.m_session.TotalCashIn.ToString("N0")</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="mr-till-stat-card mr-till-stat-out">
                    <div class="mr-till-stat-icon">
                        <i class="ti ti-trending-down"></i>
                    </div>
                    <div class="mr-till-stat-content">
                        <div class="mr-till-stat-label">@Localizer["CashOut"]</div>
                        <div class="mr-till-stat-value">฿@this.m_session.TotalCashOut.ToString("N0")</div>
                    </div>
                </div>
            </div>
        </div>

        @* ========== NON-CASH PAYMENTS SUMMARY ========== *@
        @if (this.m_session.TotalNonCashPayments > 0)
        {
            <div class="mr-card mb-4">
                <div class="mr-card-header">
                    <i class="ti ti-credit-card text-info me-2"></i>
                    <span class="mr-card-title">@Localizer["NonCashPayments"]</span>
                    <span class="ms-auto fw-semibold">฿@this.m_session.TotalNonCashPayments.ToString("N0")</span>
                </div>
                <div class="mr-card-body py-2">
                    <div class="d-flex gap-4 justify-content-center flex-wrap">
                        @if (this.m_session.TotalCardPayments > 0)
                        {
                            <div class="text-center">
                                <div class="mr-payment-icon bg-primary-lt text-primary">
                                    <i class="ti ti-credit-card"></i>
                                </div>
                                <div class="small text-secondary mt-1">@Localizer["Card"]</div>
                                <div class="fw-semibold">฿@this.m_session.TotalCardPayments.ToString("N0")</div>
                            </div>
                        }
                        @if (this.m_session.TotalBankTransfers > 0)
                        {
                            <div class="text-center">
                                <div class="mr-payment-icon bg-info-lt text-info">
                                    <i class="ti ti-building-bank"></i>
                                </div>
                                <div class="small text-secondary mt-1">@Localizer["BankTransfer"]</div>
                                <div class="fw-semibold">฿@this.m_session.TotalBankTransfers.ToString("N0")</div>
                            </div>
                        }
                        @if (this.m_session.TotalPromptPay > 0)
                        {
                            <div class="text-center">
                                <div class="mr-payment-icon bg-success-lt text-success">
                                    <i class="ti ti-qrcode"></i>
                                </div>
                                <div class="small text-secondary mt-1">@Localizer["PromptPay"]</div>
                                <div class="fw-semibold">฿@this.m_session.TotalPromptPay.ToString("N0")</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @* ========== SESSION RECEIPTS ========== *@
        @if (this.m_sessionReceipts.Any())
        {
            <div class="mr-card mb-4">
                <div class="mr-card-header">
                    <i class="ti ti-receipt text-primary me-2"></i>
                    <span class="mr-card-title">@Localizer["SessionReceipts"]</span>
                    <span class="badge bg-primary ms-2">@this.m_sessionReceipts.Count</span>
                    <button type="button" class="btn btn-sm btn-ghost-primary ms-auto" @onclick="this.ViewAllReceiptsDialog">
                        @Localizer["ViewAll"]
                        <i class="ti ti-chevron-right ms-1"></i>
                    </button>
                </div>
                <div class="mr-receipt-list">
                    @foreach (var receipt in this.m_sessionReceipts.Take(5))
                    {
                        <div class="mr-receipt-item" @onclick="@(() => this.ViewReceiptDialog(receipt))">
                            <div class="mr-receipt-icon @GetReceiptTypeClass(receipt)">
                                <i class="@GetReceiptTypeIcon(receipt)"></i>
                            </div>
                            <div class="mr-receipt-details">
                                <div class="mr-receipt-no">@receipt.ReceiptNo</div>
                                <div class="mr-receipt-customer">@receipt.CustomerName</div>
                            </div>
                            <div class="mr-receipt-amount">
                                ฿@receipt.GrandTotal.ToString("N0")
                            </div>
                            <div class="mr-receipt-time">
                                @this.FormatTime(receipt.IssuedOn)
                            </div>
                            <button type="button" class="btn btn-sm btn-icon btn-ghost-primary"
                                    @onclick:stopPropagation="true"
                                    @onclick="@(() => this.PrintReceiptDialog(receipt))">
                                <i class="ti ti-printer"></i>
                            </button>
                        </div>
                    }
                </div>
            </div>
        }

        @* ========== QUICK PAYMENTS (Cash In) ========== *@
        <div class="mb-4">
            <h4 class="mr-section-title mb-3">
                <i class="ti ti-coin"></i>
                @Localizer["QuickPayments"]
            </h4>
            <div class="row g-2">
                <div class="col-4">
                    <button type="button" class="mr-quick-action mr-quick-action-rental"
                            @onclick="this.ReceiveRentalPaymentDialog">
                        <div class="mr-quick-action-icon">
                            <i class="ti ti-motorbike"></i>
                        </div>
                        <span class="mr-quick-action-label">@Localizer["RentalPayment"]</span>
                    </button>
                </div>
                <div class="col-4">
                    <button type="button" class="mr-quick-action mr-quick-action-deposit"
                            @onclick="this.ReceiveDepositDialog">
                        <div class="mr-quick-action-icon">
                            <i class="ti ti-shield-check"></i>
                        </div>
                        <span class="mr-quick-action-label">@Localizer["Deposit"]</span>
                    </button>
                </div>
                <div class="col-4">
                    <button type="button" class="mr-quick-action mr-quick-action-booking"
                            @onclick="this.ReceiveBookingDepositDialog">
                        <div class="mr-quick-action-icon">
                            <i class="ti ti-calendar-check"></i>
                        </div>
                        <span class="mr-quick-action-label">@Localizer["BookingDeposit"]</span>
                    </button>
                </div>
            </div>
        </div>

        @* ========== QUICK PAYOUTS (Cash Out) ========== *@
        <div class="mb-4">
            <h4 class="mr-section-title mb-3">
                <i class="ti ti-bolt"></i>
                @Localizer["QuickPayouts"]
            </h4>
            <div class="row g-2">
                <div class="col-4">
                    <button type="button" class="mr-quick-action mr-quick-action-fuel"
                            @onclick="@(() => this.RecordPayoutDialog(TillTransactionType.FuelReimbursement))">
                        <div class="mr-quick-action-icon">
                            <i class="ti ti-gas-station"></i>
                        </div>
                        <span class="mr-quick-action-label">@Localizer["Fuel"]</span>
                    </button>
                </div>
                <div class="col-4">
                    <button type="button" class="mr-quick-action mr-quick-action-agent"
                            @onclick="@(() => this.RecordPayoutDialog(TillTransactionType.AgentCommission))">
                        <div class="mr-quick-action-icon">
                            <i class="ti ti-users"></i>
                        </div>
                        <span class="mr-quick-action-label">@Localizer["Agent"]</span>
                    </button>
                </div>
                <div class="col-4">
                    <button type="button" class="mr-quick-action mr-quick-action-petty"
                            @onclick="@(() => this.RecordPayoutDialog(TillTransactionType.PettyCash))">
                        <div class="mr-quick-action-icon">
                            <i class="ti ti-wallet"></i>
                        </div>
                        <span class="mr-quick-action-label">@Localizer["PettyCash"]</span>
                    </button>
                </div>
            </div>
        </div>

        @* ========== TILL OPERATIONS ========== *@
        <div class="mb-4">
            <h4 class="mr-section-title mb-3">
                <i class="ti ti-settings"></i>
                @Localizer["TillOperations"]
            </h4>
            <div class="row g-2">
                <div class="col-4">
                    <button type="button" class="mr-till-operation mr-till-operation-drop" @onclick="this.CashDropDialog">
                        <i class="ti ti-archive"></i>
                        <span>@Localizer["CashDrop"]</span>
                    </button>
                </div>
                <div class="col-4">
                    <button type="button" class="mr-till-operation mr-till-operation-topup" @onclick="this.TopUpDialog">
                        <i class="ti ti-cash"></i>
                        <span>@Localizer["TopUp"]</span>
                    </button>
                </div>
                <div class="col-4">
                    <button type="button" class="mr-till-operation mr-till-operation-close" @onclick="this.CloseSessionDialog">
                        <i class="ti ti-door-exit"></i>
                        <span>@Localizer["CloseShift"]</span>
                    </button>
                </div>
            </div>
        </div>

        @* ========== RECENT TRANSACTIONS ========== *@
        <div class="mr-card">
            <div class="mr-card-header">
                <i class="ti ti-list-details text-primary me-2"></i>
                <span class="mr-card-title">@Localizer["RecentTransactions"]</span>
                <button type="button" class="btn btn-sm btn-ghost-primary ms-auto" @onclick="this.ViewHistoryDialog">
                    @Localizer["ViewAll"]
                    <i class="ti ti-chevron-right ms-1"></i>
                </button>
            </div>
            <div class="mr-transaction-list">
                @if (!this.m_recentTransactions.Any())
                {
                    <div class="mr-empty-state py-5">
                        <div class="mr-empty-state-icon">
                            <i class="ti ti-receipt-off"></i>
                        </div>
                        <div class="mr-empty-state-title">@Localizer["NoTransactionsYet"]</div>
                        <div class="mr-empty-state-subtitle">@Localizer["TransactionsWillAppearHere"]</div>
                    </div>
                }
                else
                {
                    @foreach (var txn in this.m_recentTransactions)
                    {
                        <div class="mr-transaction-item">
                            <div class="mr-transaction-icon @GetTransactionIconClass(txn)">
                                <i class="@GetTransactionIcon(txn)"></i>
                            </div>
                            <div class="mr-transaction-details">
                                <div class="mr-transaction-type">@GetTransactionTypeName(txn.TransactionType)</div>
                                <div class="mr-transaction-desc">@txn.Description</div>
                            </div>
                            <div class="mr-transaction-amount @GetAmountColorClass(txn)">
                                @(txn.Direction == TillTransactionDirection.In ? "+" : "−")฿@txn.Amount.ToString("N0")
                            </div>
                            <div class="mr-transaction-time">
                                @this.FormatTime(txn.TransactionTime)
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @* ========== EXCHANGE RATE FAB ========== *@
    <ExchangeRatePanel />
}

@code {
    private bool m_loading = true;
    private int m_shopId;
    private TillSession? m_session;
    private List<TillTransaction> m_recentTransactions = [];
    private List<Receipt> m_sessionReceipts = [];

    protected override async Task OnInitializedAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            this.m_loading = true;

            // Get current shop
            var shops = await this.ShopService.GetShopsAsync(page: 1, pageSize: 1);
            if (shops.ItemCollection.Any())
            {
                this.m_shopId = shops.ItemCollection.First().ShopId;

                // Get active session
                this.m_session = await this.TillService.GetActiveSessionAsync(this.m_shopId, this.UserName);

                // Load recent transactions and receipts if session exists
                if (this.m_session is not null)
                {
                    this.m_recentTransactions = await this.TillService.GetRecentTransactionsAsync(this.m_session.TillSessionId, 10);
                    this.m_sessionReceipts = await this.ReceiptService.GetReceiptsByTillSessionAsync(this.m_session.TillSessionId);
                }
            }
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error loading till data");
            this.ShowError("Failed to load till data");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task OpenSessionDialog()
    {
        var result = await this.DialogService.Create<TillOpenSessionDialog>("Open Till Session")
            .WithParameter(x => x.ShopId, this.m_shopId)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Till session opened");
            await this.LoadDataAsync();
        }
    }

    private async Task CloseSessionDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillCloseSessionDialog>("Close Till Session")
            .WithParameter(x => x.Entity, this.m_session)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Till session closed");
            this.m_session = null;
            this.m_recentTransactions.Clear();
            this.m_sessionReceipts.Clear();
            this.StateHasChanged();
        }
    }

    private async Task RecordPayoutDialog(TillTransactionType type)
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillRecordPayoutDialog>(GetTransactionTypeName(type))
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.PayoutType, type)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Payout recorded");
            await this.LoadDataAsync();
        }
    }

    private async Task CashDropDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillCashDropDialog>("Cash Drop")
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.IsDrop, true)
            .WithParameter(x => x.AvailableCash, this.m_session.ExpectedCash)
            .WithSize(ModalSize.Small)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Cash drop recorded");
            await this.LoadDataAsync();
        }
    }

    private async Task TopUpDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillCashDropDialog>("Top Up")
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.IsDrop, false)
            .WithSize(ModalSize.Small)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess("Top up recorded");
            await this.LoadDataAsync();
        }
    }

    private async Task ViewHistoryDialog()
    {
        if (this.m_session is null) return;

        await this.DialogService.Create<TillHistoryDialog>("Transaction History")
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithSize(ModalSize.Large)
            .ShowDialogAsync();
    }

    private async Task ViewReceiptDialog(Receipt receipt)
    {
        await this.DialogService.Create<ReceiptPrintDialog>(Localizer["Receipt"])
            .WithParameter(x => x.Entity, receipt)
            .WithParameter(x => x.IsReprint, true)
            .WithSize(ModalSize.Large)
            .ShowDialogAsync();
    }

    private async Task PrintReceiptDialog(Receipt receipt)
    {
        await this.DialogService.Create<ReceiptPrintDialog>(Localizer["Receipt"])
            .WithParameter(x => x.Entity, receipt)
            .WithParameter(x => x.IsReprint, true)
            .WithSize(ModalSize.Large)
            .ShowDialogAsync();
    }

    private async Task ViewAllReceiptsDialog()
    {
        if (this.m_session is null) return;

        await this.DialogService.Create<TillReceiptsDialog>(Localizer["SessionReceipts"])
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithSize(ModalSize.Large)
            .ShowDialogAsync();
    }

    private static string GetReceiptTypeIcon(Receipt receipt) => receipt.ReceiptType switch
    {
        ReceiptTypes.CheckIn => "ti ti-login",
        ReceiptTypes.Settlement => "ti ti-logout",
        ReceiptTypes.BookingDeposit => "ti ti-calendar-check",
        _ => "ti ti-receipt"
    };

    private static string GetReceiptTypeClass(Receipt receipt) => receipt.ReceiptType switch
    {
        ReceiptTypes.CheckIn => "mr-receipt-icon-checkin",
        ReceiptTypes.Settlement => "mr-receipt-icon-settlement",
        ReceiptTypes.BookingDeposit => "mr-receipt-icon-booking",
        _ => "mr-receipt-icon-default"
    };

    private string GetTransactionTypeName(TillTransactionType type) => type switch
    {
        TillTransactionType.RentalPayment => Localizer["TxnRentalPayment"],
        TillTransactionType.BookingDeposit => Localizer["TxnBookingDeposit"],
        TillTransactionType.SecurityDeposit => Localizer["TxnSecurityDeposit"],
        TillTransactionType.DamageCharge => Localizer["TxnDamageCharge"],
        TillTransactionType.LateFee => Localizer["TxnLateFee"],
        TillTransactionType.Surcharge => Localizer["TxnSurcharge"],
        TillTransactionType.MiscellaneousIncome => Localizer["TxnMiscellaneous"],
        TillTransactionType.TopUp => Localizer["TxnTopUp"],
        TillTransactionType.CardPayment => Localizer["TxnCardPayment"],
        TillTransactionType.BankTransfer => Localizer["TxnBankTransfer"],
        TillTransactionType.PromptPay => Localizer["TxnPromptPay"],
        TillTransactionType.DepositRefund => Localizer["TxnDepositRefund"],
        TillTransactionType.FuelReimbursement => Localizer["TxnFuelReimbursement"],
        TillTransactionType.AgentCommission => Localizer["TxnAgentCommission"],
        TillTransactionType.PettyCash => Localizer["TxnPettyCash"],
        TillTransactionType.Drop => Localizer["TxnCashDrop"],
        TillTransactionType.CashShortage => Localizer["TxnCashShortage"],
        _ => type.ToString()
    };

    private static string GetTransactionIcon(TillTransaction txn) => txn.TransactionType switch
    {
        TillTransactionType.RentalPayment => "ti ti-motorbike",
        TillTransactionType.BookingDeposit => "ti ti-calendar-check",
        TillTransactionType.SecurityDeposit => "ti ti-shield-check",
        TillTransactionType.DamageCharge => "ti ti-alert-triangle",
        TillTransactionType.LateFee => "ti ti-clock-exclamation",
        TillTransactionType.TopUp => "ti ti-cash",
        TillTransactionType.CardPayment => "ti ti-credit-card",
        TillTransactionType.BankTransfer => "ti ti-building-bank",
        TillTransactionType.PromptPay => "ti ti-qrcode",
        TillTransactionType.DepositRefund => "ti ti-arrow-back",
        TillTransactionType.FuelReimbursement => "ti ti-gas-station",
        TillTransactionType.AgentCommission => "ti ti-users",
        TillTransactionType.PettyCash => "ti ti-wallet",
        TillTransactionType.Drop => "ti ti-archive",
        _ => "ti ti-receipt"
    };

    private static string GetTransactionIconClass(TillTransaction txn)
    {
        if (txn.Direction == TillTransactionDirection.In)
        {
            return txn.AffectsCash ? "mr-txn-icon-in" : "mr-txn-icon-non-cash";
        }
        return "mr-txn-icon-out";
    }

    private static string GetAmountColorClass(TillTransaction txn)
    {
        return txn.Direction == TillTransactionDirection.In ? "mr-amount-in" : "mr-amount-out";
    }

    private async Task ReceiveRentalPaymentDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillReceivePaymentDialog>(Localizer["RentalPayment"])
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.ShopId, this.m_shopId)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess(Localizer["PaymentRecorded"]);
            await this.LoadDataAsync();
        }
    }

    private async Task ReceiveDepositDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillReceiveDepositDialog>(Localizer["Deposit"])
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.ShopId, this.m_shopId)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess(Localizer["DepositRecorded"]);
            await this.LoadDataAsync();
        }
    }

    private async Task ReceiveBookingDepositDialog()
    {
        if (this.m_session is null) return;

        var result = await this.DialogService.Create<TillBookingDepositDialog>(Localizer["BookingDeposit"])
            .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
            .WithParameter(x => x.ShopId, this.m_shopId)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();

        if (result is { Cancelled: false })
        {
            this.ShowSuccess(Localizer["PaymentRecorded"]);
            await this.LoadDataAsync();
        }
    }
}
