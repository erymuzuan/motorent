@using MotoRent.Domain.Entities
@inherits LocalizedDialogBase<Booking, TillBookingDepositDialog>
@inject TillService TillService
@inject BookingService BookingService
@inject ReceiptService ReceiptService

<form id="bookingDepositForm" @onsubmit="this.SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        @* Step 1: Search for booking *@
        <div class="mb-3">
            <label class="form-label">@Localizer["SearchBooking"]</label>
            <div class="input-group">
                <input type="text" class="form-control"
                       placeholder="@Localizer["BookingRefOrCustomer"]"
                       @bind="m_searchTerm" @bind:event="oninput"
                       @onkeydown="OnSearchKeyDown" />
                <button type="button" class="btn btn-primary" @onclick="SearchBookingsAsync" disabled="@m_searching">
                    @if (m_searching)
                    {
                        <span class="spinner-border spinner-border-sm"></span>
                    }
                    else
                    {
                        <i class="ti ti-search"></i>
                    }
                </button>
            </div>
            <div class="form-hint">@Localizer["BookingSearchHint"]</div>
        </div>

        @* Search Results *@
        @if (m_searchResults.Count > 0 && m_selectedBooking is null)
        {
            <div class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                @foreach (var booking in m_searchResults)
                {
                    <button type="button" class="list-group-item list-group-item-action"
                            @onclick="@(() => SelectBooking(booking))">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">
                                    <span class="badge bg-purple me-2">@booking.BookingRef</span>
                                    @booking.CustomerName
                                </div>
                                <div class="small text-muted">
                                    @booking.StartDate.ToString("dd MMM") - @booking.EndDate.ToString("dd MMM yyyy")
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-semibold">฿@booking.TotalAmount.ToString("N0")</div>
                                <div class="small">
                                    @if (booking.BalanceDue > 0)
                                    {
                                        <span class="text-warning">@Localizer["Due"]: ฿@booking.BalanceDue.ToString("N0")</span>
                                    }
                                    else
                                    {
                                        <span class="text-success">@Localizer["Paid"]</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </button>
                }
            </div>
        }

        @* Selected Booking *@
        @if (m_selectedBooking is not null)
        {
            <div class="alert alert-primary mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-semibold mb-1">
                            <span class="badge bg-purple me-2">@m_selectedBooking.BookingRef</span>
                            @m_selectedBooking.CustomerName
                        </div>
                        <div class="small mb-1">
                            <i class="ti ti-calendar me-1"></i>
                            @m_selectedBooking.StartDate.ToString("dd MMM") - @m_selectedBooking.EndDate.ToString("dd MMM yyyy")
                        </div>
                        @if (m_selectedBooking.Items.Any())
                        {
                            <div class="small text-muted">
                                @string.Join(", ", m_selectedBooking.Items.Select(i => i.VehicleDisplayName))
                            </div>
                        }
                    </div>
                    <button type="button" class="btn btn-sm btn-ghost-secondary" @onclick="ClearSelection">
                        <i class="ti ti-x"></i>
                    </button>
                </div>
            </div>

            @* Payment Summary *@
            <div class="card card-body bg-light mb-3">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="small text-muted">@Localizer["TotalAmount"]</div>
                        <div class="fw-semibold">฿@m_selectedBooking.TotalAmount.ToString("N0")</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-muted">@Localizer["AmountPaid"]</div>
                        <div class="fw-semibold text-success">฿@m_selectedBooking.AmountPaid.ToString("N0")</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-muted">@Localizer["BalanceDue"]</div>
                        <div class="fw-semibold @(m_selectedBooking.BalanceDue > 0 ? "text-warning" : "text-success")">
                            ฿@m_selectedBooking.BalanceDue.ToString("N0")
                        </div>
                    </div>
                </div>
            </div>

            @if (m_selectedBooking.BalanceDue <= 0)
            {
                <div class="alert alert-success">
                    <i class="ti ti-check me-2"></i>
                    @Localizer["BookingFullyPaid"]
                </div>
            }
            else
            {
                @* Payment Details *@
                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label required">@Localizer["Amount"]</label>
                        <div class="input-group">
                            <span class="input-group-text">฿</span>
                            <input type="number" class="form-control text-end" @bind="m_amount"
                                   required min="1" max="@m_selectedBooking.BalanceDue" step="any" placeholder="0" />
                        </div>
                        <div class="form-hint">@Localizer["MaxAmount"]: ฿@m_selectedBooking.BalanceDue.ToString("N0")</div>
                    </div>
                    <div class="col-6">
                        <label class="form-label required">@Localizer["PaymentMethod"]</label>
                        <select class="form-select" @bind="m_paymentMethod">
                            <option value="Cash">@Localizer["Cash"]</option>
                            <option value="Card">@Localizer["Card"]</option>
                            <option value="PromptPay">@Localizer["PromptPay"]</option>
                            <option value="BankTransfer">@Localizer["BankTransfer"]</option>
                        </select>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label">@Localizer["Notes"]</label>
                    <textarea class="form-control" @bind="m_notes" rows="2"
                              placeholder="@Localizer["NotesPlaceholder"]"></textarea>
                </div>
            }
        }

        @* No Results Message *@
        @if (m_searched && m_searchResults.Count == 0 && m_selectedBooking is null)
        {
            <div class="alert alert-warning">
                <i class="ti ti-alert-triangle me-2"></i>
                @Localizer["NoBookingsFound"]
            </div>
        }
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="this.Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="bookingDepositForm" class="btn btn-purple"
            disabled="@(m_selectedBooking is null || m_amount <= 0 || m_selectedBooking?.BalanceDue <= 0 || m_saving)">
        @if (m_saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-check me-1"></i>
        @Localizer["RecordPayment"]
    </button>
</div>

@code {
    [Parameter]
    public int SessionId { get; set; }

    [Parameter]
    public int ShopId { get; set; }

    private string m_searchTerm = "";
    private List<Booking> m_searchResults = [];
    private Booking? m_selectedBooking;
    private decimal m_amount;
    private string m_paymentMethod = "Cash";
    private string? m_notes;
    private bool m_searching;
    private bool m_searched;
    private bool m_saving;

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchBookingsAsync();
        }
    }

    private async Task SearchBookingsAsync()
    {
        if (string.IsNullOrWhiteSpace(m_searchTerm) || m_searching) return;

        try
        {
            m_searching = true;
            m_searched = true;
            m_searchResults.Clear();

            var searchTerm = m_searchTerm.Trim().ToUpperInvariant();

            // Try to find by booking reference first (6 characters)
            if (searchTerm.Length >= 4 && searchTerm.Length <= 8)
            {
                var booking = await BookingService.GetBookingByRefAsync(searchTerm);
                if (booking is not null && booking.CanReceivePayment)
                {
                    m_searchResults.Add(booking);
                }
            }

            // If no exact match, search by customer name
            if (m_searchResults.Count == 0)
            {
                var result = await BookingService.GetBookingsAsync(
                    preferredShopId: null,
                    status: null,
                    searchTerm: m_searchTerm,
                    page: 1,
                    pageSize: 10);

                // Filter to only bookings that can receive payments
                m_searchResults.AddRange(
                    result.ItemCollection.Where(b => b.CanReceivePayment));
            }
        }
        finally
        {
            m_searching = false;
        }
    }

    private void SelectBooking(Booking booking)
    {
        m_selectedBooking = booking;
        m_searchResults.Clear();

        // Default amount to balance due
        m_amount = booking.BalanceDue;
    }

    private void ClearSelection()
    {
        m_selectedBooking = null;
        m_searchTerm = "";
        m_searched = false;
        m_amount = 0;
    }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }

    private async Task SaveAsync()
    {
        if (m_saving || m_selectedBooking is null || m_amount <= 0) return;

        // Validate amount doesn't exceed balance due
        if (m_amount > m_selectedBooking.BalanceDue)
        {
            this.ShowError(Localizer["AmountExceedsBalance"]);
            return;
        }

        try
        {
            m_saving = true;

            // 1. Record payment on booking
            var payment = new BookingPayment
            {
                Amount = m_amount,
                PaymentType = BookingPaymentType.Deposit,
                PaymentMethod = m_paymentMethod,
                Notes = m_notes
            };

            var paymentResult = await BookingService.RecordPaymentAsync(
                m_selectedBooking.BookingId,
                payment,
                this.UserName);

            if (!paymentResult.Success)
            {
                this.ShowError(paymentResult.Message ?? Localizer["FailedToRecordPayment"]);
                return;
            }

            // 2. Record to till
            var type = m_paymentMethod switch
            {
                "Cash" => TillTransactionType.BookingDeposit,
                "Card" => TillTransactionType.CardPayment,
                "PromptPay" => TillTransactionType.PromptPay,
                "BankTransfer" => TillTransactionType.BankTransfer,
                _ => TillTransactionType.BookingDeposit
            };

            var description = $"Booking deposit {m_selectedBooking.BookingRef} - {m_selectedBooking.CustomerName}";

            var tillResult = await TillService.RecordCashInAsync(
                SessionId,
                type,
                m_amount,
                description,
                this.UserName,
                notes: m_notes);

            if (!tillResult.Success)
            {
                this.ShowError(tillResult.Message ?? Localizer["FailedToRecordPayment"]);
                return;
            }

            // 3. Generate receipt (optional - could be done later)
            try
            {
                await ReceiptService.GenerateBookingDepositReceiptAsync(
                    m_selectedBooking.BookingId,
                    m_amount,
                    m_paymentMethod,
                    SessionId,
                    this.UserName);
            }
            catch (Exception ex)
            {
                // Log but don't fail the operation
                this.Logger.LogWarning(ex, "Failed to generate booking deposit receipt");
            }

            this.ModalService.Close(ModalResult.Ok(tillResult));
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error recording booking deposit");
            this.ShowError(Localizer["FailedToRecordPayment"]);
        }
        finally
        {
            m_saving = false;
        }
    }
}
