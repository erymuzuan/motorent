@using MotoRent.Domain.Entities
@inherits LocalizedDialogBase<TillTransaction, TillHistoryDialog>
@inject TillService TillService

<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
    @if (this.Loading)
    {
        <div class="progress progress-sm mb-3">
            <div class="progress-bar progress-bar-indeterminate"></div>
        </div>
    }
    else if (!this.Transactions.Any())
    {
        <div class="text-center py-5 text-secondary">
            <i class="ti ti-receipt-off" style="font-size: 3rem;"></i>
            <div class="mt-2">@Localizer["NoTransactionsRecorded"]</div>
        </div>
    }
    else
    {
        <div class="list-group list-group-flush">
            @foreach (var txn in this.Transactions)
            {
                <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex gap-3">
                            <span class="avatar @GetTransactionAvatarClass(txn)">
                                <i class="@GetTransactionIcon(txn)"></i>
                            </span>
                            <div>
                                <div class="fw-medium">@GetTransactionTypeName(txn.TransactionType)</div>
                                <div class="text-secondary small">@txn.Description</div>
                                @if (!string.IsNullOrEmpty(txn.RecipientName))
                                {
                                    <small class="text-secondary">
                                        <i class="ti ti-user me-1"></i>@txn.RecipientName
                                    </small>
                                }
                                @if (!string.IsNullOrEmpty(txn.ReceiptNumber))
                                {
                                    <small class="text-secondary ms-2">
                                        <i class="ti ti-receipt me-1"></i>@txn.ReceiptNumber
                                    </small>
                                }
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="@GetAmountColorClass(txn) fw-bold">
                                @(txn.Direction == TillTransactionDirection.In ? "+" : "-")@this.FormatCurrency(txn.Amount)
                            </div>
                            <small class="text-secondary">
                                @this.FormatDateTime(txn.TransactionTime)
                            </small>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(txn.Notes))
                    {
                        <div class="mt-2 small text-secondary">
                            <i class="ti ti-note me-1"></i>@txn.Notes
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" @onclick="this.Cancel">
        @Localizer["Close"]
    </button>
</div>

@code {
    [Parameter]
    public int SessionId { get; set; }

    private bool Loading { get; set; } = true;
    private List<TillTransaction> Transactions { get; set; } = [];

    protected override async Task OnParametersSetAsync()
    {
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            this.Loading = true;
            this.Transactions = await this.TillService.GetTransactionsAsync(this.SessionId);
        }
        catch (Exception ex)
        {
            this.Logger.LogError(ex, "Error loading transactions");
            this.ShowError("Failed to load transactions");
        }
        finally
        {
            this.Loading = false;
        }
    }

    private void Cancel()
    {
        this.ModalService.Close(ModalResult.Cancel());
    }

    private static string GetTransactionTypeName(TillTransactionType type) => type switch
    {
        TillTransactionType.RentalPayment => "Rental Payment",
        TillTransactionType.BookingDeposit => "Booking Deposit",
        TillTransactionType.SecurityDeposit => "Security Deposit",
        TillTransactionType.DamageCharge => "Damage Charge",
        TillTransactionType.LateFee => "Late Fee",
        TillTransactionType.Surcharge => "Surcharge",
        TillTransactionType.MiscellaneousIncome => "Miscellaneous",
        TillTransactionType.TopUp => "Top Up",
        TillTransactionType.CardPayment => "Card Payment",
        TillTransactionType.BankTransfer => "Bank Transfer",
        TillTransactionType.PromptPay => "PromptPay",
        TillTransactionType.DepositRefund => "Deposit Refund",
        TillTransactionType.FuelReimbursement => "Fuel Reimbursement",
        TillTransactionType.AgentCommission => "Agent Commission",
        TillTransactionType.PettyCash => "Petty Cash",
        TillTransactionType.Drop => "Cash Drop",
        TillTransactionType.CashShortage => "Cash Shortage",
        _ => type.ToString()
    };

    private static string GetTransactionIcon(TillTransaction txn) => txn.TransactionType switch
    {
        TillTransactionType.RentalPayment => "ti ti-motorbike",
        TillTransactionType.BookingDeposit => "ti ti-calendar-check",
        TillTransactionType.SecurityDeposit => "ti ti-shield-check",
        TillTransactionType.DamageCharge => "ti ti-alert-triangle",
        TillTransactionType.LateFee => "ti ti-clock-exclamation",
        TillTransactionType.TopUp => "ti ti-cash",
        TillTransactionType.CardPayment => "ti ti-credit-card",
        TillTransactionType.BankTransfer => "ti ti-building-bank",
        TillTransactionType.PromptPay => "ti ti-qrcode",
        TillTransactionType.DepositRefund => "ti ti-arrow-back",
        TillTransactionType.FuelReimbursement => "ti ti-gas-station",
        TillTransactionType.AgentCommission => "ti ti-users",
        TillTransactionType.PettyCash => "ti ti-wallet",
        TillTransactionType.Drop => "ti ti-safe",
        _ => "ti ti-receipt"
    };

    private static string GetTransactionAvatarClass(TillTransaction txn)
    {
        if (txn.Direction == TillTransactionDirection.In)
        {
            return txn.AffectsCash ? "bg-success-lt" : "bg-info-lt";
        }
        return "bg-danger-lt";
    }

    private static string GetAmountColorClass(TillTransaction txn)
    {
        return txn.Direction == TillTransactionDirection.In ? "text-success" : "text-danger";
    }
}
