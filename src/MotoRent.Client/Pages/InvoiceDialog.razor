@inherits LocalizedDialogBase<InvoiceData, InvoiceDialog>
@inject InvoiceService InvoiceService
@inject IJSRuntime JSRuntime

<div class="modal-body">
    @if (m_loading)
    {
        <div class="d-flex flex-column align-items-center py-5">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <span class="text-secondary">@Localizer["LoadingInvoice"]</span>
        </div>
    }
    else if (m_invoice == null)
    {
        <div class="alert alert-danger">
            <i class="ti ti-alert-circle me-2"></i>
            @Localizer["InvoiceNotFound"]
        </div>
    }
    else
    {
        <div id="invoice-content" class="invoice-container">
            @* Invoice Header *@
            <div class="row mb-4">
                <div class="col-6">
                    <h2 class="text-primary mb-0">@Localizer["INVOICE"]</h2>
                    <div class="fw-bold">@m_invoice.InvoiceNumber</div>
                    <small class="text-secondary">@Localizer["DateLabel", FormatDate(m_invoice.InvoiceDate)]</small>
                </div>
                <div class="col-6 text-end">
                    <h5 class="mb-1">@m_invoice.ShopName</h5>
                    @if (!string.IsNullOrEmpty(m_invoice.ShopAddress))
                    {
                        <div class="small text-secondary">@m_invoice.ShopAddress</div>
                    }
                    @if (!string.IsNullOrEmpty(m_invoice.ShopPhone))
                    {
                        <div class="small text-secondary">@Localizer["TelLabel", m_invoice.ShopPhone]</div>
                    }
                    @if (!string.IsNullOrEmpty(m_invoice.ShopEmail))
                    {
                        <div class="small text-secondary">@m_invoice.ShopEmail</div>
                    }
                </div>
            </div>

            <hr class="my-3" />

            @* Customer & Rental Info *@
            <div class="row mb-4">
                <div class="col-6">
                    <div class="subheader text-secondary">@Localizer["BILLTO"]</div>
                    <div class="fw-bold">@m_invoice.CustomerName</div>
                    @if (!string.IsNullOrEmpty(m_invoice.CustomerPassport))
                    {
                        <div class="small">@Localizer["PassportIdLabel", m_invoice.CustomerPassport]</div>
                    }
                    @if (!string.IsNullOrEmpty(m_invoice.CustomerPhone))
                    {
                        <div class="small">@Localizer["TelLabel", m_invoice.CustomerPhone]</div>
                    }
                    @if (!string.IsNullOrEmpty(m_invoice.CustomerEmail))
                    {
                        <div class="small">@m_invoice.CustomerEmail</div>
                    }
                </div>
                <div class="col-6">
                    <div class="subheader text-secondary">@Localizer["RENTALDETAILS"]</div>
                    <div class="small"><strong>@Localizer["Vehicle"]:</strong> @m_invoice.MotorbikeBrand @m_invoice.MotorbikeModel</div>
                    <div class="small"><strong>@Localizer["LicensePlate"]:</strong> @m_invoice.MotorbikeLicensePlate</div>
                    <div class="small"><strong>@Localizer["Period"]:</strong> @FormatDate(m_invoice.StartDate) - @FormatDate(m_invoice.EndDate)</div>
                    <div class="small"><strong>@Localizer["Duration"]:</strong> @Localizer["DaysCount", m_invoice.RentalDays]</div>
                </div>
            </div>

            @* Line Items Table *@
            <div class="table-responsive mb-4">
                <table class="table table-vcenter">
                    <thead>
                        <tr>
                            <th>@Localizer["Description"]</th>
                            <th class="text-center">@Localizer["Qty"]</th>
                            <th class="text-end">@Localizer["UnitPrice"]</th>
                            <th class="text-end">@Localizer["Amount"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in m_invoice.LineItems)
                        {
                            <tr>
                                <td>@item.Description</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">@FormatCurrency(item.UnitPrice)</td>
                                <td class="text-end">@FormatCurrency(item.Total)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @* Totals Section *@
            <div class="row mb-4">
                <div class="col-6">
                    @* Deposit Info *@
                    @if (m_invoice.DepositAmount > 0)
                    {
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="subheader text-secondary">@Localizer["DEPOSIT"]</div>
                                <div class="small"><strong>@Localizer["Amount"]:</strong> @FormatCurrency(m_invoice.DepositAmount)</div>
                                <div class="small"><strong>@Localizer["Type"]:</strong> @m_invoice.DepositType</div>
                                <div class="small d-flex align-items-center gap-1">
                                    <strong>@Localizer["Status"]:</strong>
                                    <span class="badge @GetDepositStatusBadgeClass(m_invoice.DepositStatus)">
                                        @Localizer[m_invoice.DepositStatus ?? ""]
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="col-6">
                    <div class="text-end">
                        <div class="d-flex justify-content-end align-items-center mb-1">
                            <span class="small me-3">@Localizer["Subtotal"]:</span>
                            <span class="small" style="min-width: 100px;">@FormatCurrency(m_invoice.Subtotal)</span>
                        </div>
                        @if (m_invoice.Tax > 0)
                        {
                            <div class="d-flex justify-content-end align-items-center mb-1">
                                <span class="small me-3">@Localizer["Tax"]:</span>
                                <span class="small" style="min-width: 100px;">@FormatCurrency(m_invoice.Tax)</span>
                            </div>
                        }
                        <hr class="my-2" />
                        <div class="d-flex justify-content-end align-items-center">
                            <span class="h5 me-3 mb-0">@Localizer["Total"]:</span>
                            <span class="h4 text-primary mb-0" style="min-width: 100px;">@FormatCurrency(m_invoice.Total)</span>
                        </div>
                    </div>
                </div>
            </div>

            @* Payment Records *@
            @if (m_invoice.Payments.Count > 0)
            {
                <hr class="my-3" />
                <div class="subheader text-secondary mb-2">@Localizer["PAYMENTHISTORY"]</div>
                <div class="table-responsive">
                    <table class="table table-vcenter table-sm">
                        <thead>
                            <tr>
                                <th>@Localizer["Type"]</th>
                                <th>@Localizer["Method"]</th>
                                <th>@Localizer["Date"]</th>
                                <th>@Localizer["Reference"]</th>
                                <th class="text-end">@Localizer["Amount"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var payment in m_invoice.Payments)
                            {
                                <tr>
                                    <td>
                                        <span class="badge @GetPaymentTypeBadgeClass(payment.PaymentType)">
                                            @Localizer[payment.PaymentType ?? ""]
                                        </span>
                                    </td>
                                    <td>@Localizer[payment.PaymentMethod ?? ""]</td>
                                    <td>@(payment.PaidOn.HasValue ? FormatDate(payment.PaidOn.Value) : "-")</td>
                                    <td>@(payment.TransactionRef ?? "-")</td>
                                    <td class="text-end">
                                        @if (payment.PaymentType == "Refund")
                                        {
                                            <span class="text-danger">-@FormatCurrency(payment.Amount)</span>
                                        }
                                        else
                                        {
                                            @FormatCurrency(payment.Amount)
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end align-items-center mt-2">
                    <span class="small me-3"><strong>@Localizer["TotalPaid"]:</strong></span>
                    <span class="small text-success" style="min-width: 100px;">@FormatCurrency(m_invoice.TotalPaid)</span>
                </div>
                @if (m_invoice.TotalRefunded > 0)
                {
                    <div class="d-flex justify-content-end align-items-center">
                        <span class="small me-3"><strong>@Localizer["TotalRefunded"]:</strong></span>
                        <span class="small text-danger" style="min-width: 100px;">@FormatCurrency(m_invoice.TotalRefunded)</span>
                    </div>
                }
            }

            @* Footer *@
            <hr class="my-3" />
            <p class="text-center text-secondary small mb-0">
                @Localizer["InvoiceFooter", m_invoice.ShopName]
            </p>
        </div>
    }
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        @Localizer["Close"]
    </button>
    <button type="button" class="btn btn-primary" disabled="@(m_invoice == null)" @onclick="PrintInvoice">
        <i class="ti ti-printer me-1"></i>
        @Localizer["Print"]
    </button>
</div>

<style>
    .invoice-container {
        padding: 8px;
    }

    @@media print {
        .modal-footer,
        .modal-header {
            display: none !important;
        }
        .invoice-container {
            padding: 0;
        }
    }
</style>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }
    [Parameter] public int RentalId { get; set; }

    private InvoiceData? m_invoice;
    private bool m_loading = true;

    protected override async Task OnInitializedAsync()
    {
        this.m_loading = true;
        try
        {
            this.m_invoice = await this.InvoiceService.GenerateInvoiceAsync(this.RentalId);
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoadingInvoice", ex.Message]);
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private void Cancel() => this.ModalInstance?.Cancel();

    private async Task PrintInvoice()
    {
        await this.JSRuntime.InvokeVoidAsync("print");
    }

    private static string GetDepositStatusBadgeClass(string status) => status switch
    {
        "Held" => "bg-warning",
        "Refunded" => "bg-success",
        "Forfeited" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetPaymentTypeBadgeClass(string type) => type switch
    {
        "Rental" => "bg-primary",
        "Deposit" => "bg-warning",
        "Insurance" => "bg-info",
        "Accessory" => "bg-secondary",
        "Refund" => "bg-danger",
        "Additional" => "bg-danger",
        _ => "bg-secondary"
    };
}
