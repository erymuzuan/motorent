@inherits MotoRentComponentBase
@using MotoRent.Services
@inject InvoiceService InvoiceService
@inject IJSRuntime JSRuntime

<MudDialog>
    <TitleContent>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Receipt" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Invoice @m_invoice?.InvoiceNumber</MudText>
        </MudStack>
    </TitleContent>

    <DialogContent>
        @if (m_loading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading invoice...</MudText>
            </MudStack>
        }
        else if (m_invoice == null)
        {
            <MudAlert Severity="Severity.Error">Invoice not found</MudAlert>
        }
        else
        {
            <div id="invoice-content" class="invoice-container">
                @* Invoice Header *@
                <div class="invoice-header">
                    <MudGrid>
                        <MudItem xs="6">
                            <MudText Typo="Typo.h4" Color="Color.Primary">INVOICE</MudText>
                            <MudText Typo="Typo.body1"><strong>@m_invoice.InvoiceNumber</strong></MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Date: @FormatDate(m_invoice.InvoiceDate)
                            </MudText>
                        </MudItem>
                        <MudItem xs="6" Style="text-align: right;">
                            <MudText Typo="Typo.h6">@m_invoice.ShopName</MudText>
                            @if (!string.IsNullOrEmpty(m_invoice.ShopAddress))
                            {
                                <MudText Typo="Typo.body2">@m_invoice.ShopAddress</MudText>
                            }
                            @if (!string.IsNullOrEmpty(m_invoice.ShopPhone))
                            {
                                <MudText Typo="Typo.body2">Tel: @m_invoice.ShopPhone</MudText>
                            }
                            @if (!string.IsNullOrEmpty(m_invoice.ShopEmail))
                            {
                                <MudText Typo="Typo.body2">@m_invoice.ShopEmail</MudText>
                            }
                        </MudItem>
                    </MudGrid>
                </div>

                <MudDivider Class="my-4" />

                @* Customer & Rental Info *@
                <MudGrid Class="mb-4">
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">BILL TO</MudText>
                        <MudText Typo="Typo.body1"><strong>@m_invoice.CustomerName</strong></MudText>
                        @if (!string.IsNullOrEmpty(m_invoice.CustomerPassport))
                        {
                            <MudText Typo="Typo.body2">Passport/ID: @m_invoice.CustomerPassport</MudText>
                        }
                        @if (!string.IsNullOrEmpty(m_invoice.CustomerPhone))
                        {
                            <MudText Typo="Typo.body2">Tel: @m_invoice.CustomerPhone</MudText>
                        }
                        @if (!string.IsNullOrEmpty(m_invoice.CustomerEmail))
                        {
                            <MudText Typo="Typo.body2">@m_invoice.CustomerEmail</MudText>
                        }
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">RENTAL DETAILS</MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Vehicle:</strong> @m_invoice.MotorbikeBrand @m_invoice.MotorbikeModel
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>License Plate:</strong> @m_invoice.MotorbikeLicensePlate
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Period:</strong> @FormatDate(m_invoice.StartDate) - @FormatDate(m_invoice.EndDate)
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Duration:</strong> @m_invoice.RentalDays day(s)
                        </MudText>
                    </MudItem>
                </MudGrid>

                @* Line Items Table *@
                <MudTable Items="m_invoice.LineItems" Dense="true" Elevation="0" Style="border: 1px solid var(--mud-palette-divider);">
                    <HeaderContent>
                        <MudTh>Description</MudTh>
                        <MudTh Style="text-align: center;">Qty</MudTh>
                        <MudTh Style="text-align: right;">Unit Price</MudTh>
                        <MudTh Style="text-align: right;">Amount</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Description</MudTd>
                        <MudTd Style="text-align: center;">@context.Quantity</MudTd>
                        <MudTd Style="text-align: right;">@FormatCurrency(context.UnitPrice)</MudTd>
                        <MudTd Style="text-align: right;">@FormatCurrency(context.Total)</MudTd>
                    </RowTemplate>
                </MudTable>

                @* Totals Section *@
                <MudGrid Class="mt-4">
                    <MudItem xs="6">
                        @* Deposit Info *@
                        @if (m_invoice.DepositAmount > 0)
                        {
                            <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">DEPOSIT</MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Amount:</strong> @FormatCurrency(m_invoice.DepositAmount)
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Type:</strong> @m_invoice.DepositType
                                </MudText>
                                <MudText Typo="Typo.body2">
                                    <strong>Status:</strong>
                                    <MudChip T="string" Size="Size.Small" Color="@GetDepositStatusColor(m_invoice.DepositStatus)">
                                        @m_invoice.DepositStatus
                                    </MudChip>
                                </MudText>
                            </MudPaper>
                        }
                    </MudItem>
                    <MudItem xs="6">
                        <MudStack Spacing="1" Style="text-align: right;">
                            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                                <MudText Typo="Typo.body2">Subtotal:</MudText>
                                <MudText Typo="Typo.body2" Style="min-width: 100px;">@FormatCurrency(m_invoice.Subtotal)</MudText>
                            </MudStack>
                            @if (m_invoice.Tax > 0)
                            {
                                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                                    <MudText Typo="Typo.body2">Tax:</MudText>
                                    <MudText Typo="Typo.body2" Style="min-width: 100px;">@FormatCurrency(m_invoice.Tax)</MudText>
                                </MudStack>
                            }
                            <MudDivider Class="my-1" />
                            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                                <MudText Typo="Typo.h6">Total:</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary" Style="min-width: 100px;">@FormatCurrency(m_invoice.Total)</MudText>
                            </MudStack>
                        </MudStack>
                    </MudItem>
                </MudGrid>

                @* Payment Records *@
                @if (m_invoice.Payments.Count > 0)
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">PAYMENT HISTORY</MudText>
                    <MudTable Items="m_invoice.Payments" Dense="true" Elevation="0" Style="border: 1px solid var(--mud-palette-divider);">
                        <HeaderContent>
                            <MudTh>Type</MudTh>
                            <MudTh>Method</MudTh>
                            <MudTh>Date</MudTh>
                            <MudTh>Reference</MudTh>
                            <MudTh Style="text-align: right;">Amount</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small" Color="@GetPaymentTypeColor(context.PaymentType)">
                                    @context.PaymentType
                                </MudChip>
                            </MudTd>
                            <MudTd>@context.PaymentMethod</MudTd>
                            <MudTd>@(context.PaidOn.HasValue ? FormatDate(context.PaidOn.Value) : "-")</MudTd>
                            <MudTd>@(context.TransactionRef ?? "-")</MudTd>
                            <MudTd Style="text-align: right;">
                                @if (context.PaymentType == "Refund")
                                {
                                    <MudText Color="Color.Error">-@FormatCurrency(context.Amount)</MudText>
                                }
                                else
                                {
                                    @FormatCurrency(context.Amount)
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2" Spacing="4">
                        <MudText Typo="Typo.body2"><strong>Total Paid:</strong></MudText>
                        <MudText Typo="Typo.body2" Color="Color.Success" Style="min-width: 100px;">@FormatCurrency(m_invoice.TotalPaid)</MudText>
                    </MudStack>
                    @if (m_invoice.TotalRefunded > 0)
                    {
                        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="4">
                            <MudText Typo="Typo.body2"><strong>Total Refunded:</strong></MudText>
                            <MudText Typo="Typo.body2" Color="Color.Error" Style="min-width: 100px;">@FormatCurrency(m_invoice.TotalRefunded)</MudText>
                        </MudStack>
                    }
                }

                @* Footer *@
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-align: center;">
                    Thank you for choosing @m_invoice.ShopName! Have a safe ride!
                </MudText>
            </div>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Close</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Print"
                   Disabled="@(m_invoice == null)"
                   OnClick="PrintInvoice">
            Print
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
    .invoice-container {
        padding: 16px;
    }

    @@media print {
        .mud-dialog-actions,
        .mud-dialog-title {
            display: none !important;
        }
        .invoice-container {
            padding: 0;
        }
    }
</style>

@code {
    [CascadingParameter] private MudDialogInstance? MudDialog { get; set; }
    [Parameter] public int RentalId { get; set; }

    private InvoiceData? m_invoice;
    private bool m_loading = true;

    protected override async Task OnInitializedAsync()
    {
        m_loading = true;
        try
        {
            m_invoice = await InvoiceService.GenerateInvoiceAsync(RentalId);
        }
        catch (Exception ex)
        {
            ShowError($"Error loading invoice: {ex.Message}");
        }
        finally
        {
            m_loading = false;
        }
    }

    private void Cancel() => MudDialog?.Cancel();

    private async Task PrintInvoice()
    {
        await JSRuntime.InvokeVoidAsync("print");
    }

    private Color GetDepositStatusColor(string status) => status switch
    {
        "Held" => Color.Warning,
        "Refunded" => Color.Success,
        "Forfeited" => Color.Error,
        _ => Color.Default
    };

    private Color GetPaymentTypeColor(string type) => type switch
    {
        "Rental" => Color.Primary,
        "Deposit" => Color.Warning,
        "Insurance" => Color.Info,
        "Accessory" => Color.Secondary,
        "Refund" => Color.Error,
        "Additional" => Color.Error,
        _ => Color.Default
    };
}
