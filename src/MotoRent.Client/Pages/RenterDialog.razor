@inherits LocalizedDialogBase<Renter, RenterDialog>
@inject RenterService RenterService

<form id="@FormId" @onsubmit="SaveAsync" @onsubmit:preventDefault>
    <div class="modal-body">
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "scan" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "scan")">
                    <i class="ti ti-scan me-1"></i>
                    @Localizer["ScanDocuments"]
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button type="button" class="nav-link @(m_activeTab == "manual" ? "active" : "")"
                        @onclick="@(() => m_activeTab = "manual")">
                    <i class="ti ti-edit me-1"></i>
                    @Localizer["ManualEntry"]
                </button>
            </li>
        </ul>

        <div class="tab-content">
            @* Document Scan Tab *@
            <div class="tab-pane fade @(m_activeTab == "scan" ? "show active" : "")">
                <p class="text-secondary mb-3">
                    @Localizer["ScanHint"]
                </p>

                <div class="row g-3">
                    <div class="col-md-6">
                        <DocumentUpload DocumentType="Passport" RenterId="@(IsNew ? null : Entity.RenterId)"
                                        OnDataExtracted="OnPassportDataExtracted"
                                        OnDocumentUploaded="OnDocumentUploaded" />
                    </div>
                    <div class="col-md-6">
                        <DocumentUpload DocumentType="DrivingLicense" RenterId="@(IsNew ? null : Entity.RenterId)"
                                        OnDataExtracted="OnLicenseDataExtracted"
                                        OnDocumentUploaded="OnDocumentUploaded" />
                    </div>
                </div>

                @if (m_uploadedDocuments.Count > 0)
                {
                    <hr class="my-4" />
                    <h6 class="mb-2">@Localizer["UploadedDocuments", m_uploadedDocuments.Count]</h6>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var doc in m_uploadedDocuments)
                        {
                            <span class="badge bg-primary d-flex align-items-center">
                                <i class="@GetDocumentIcon(doc.DocumentType) me-1"></i>
                                @Localizer[doc.DocumentType]
                                <button type="button" class="btn-close btn-close-white ms-2"
                                        style="font-size: 0.5rem;"
                                        @onclick="@(() => RemoveUploadedDocument(doc))">
                                </button>
                            </span>
                        }
                    </div>
                }
            </div>

            @* Manual Entry Tab *@
            <div class="tab-pane fade @(m_activeTab == "manual" ? "show active" : "")">
                <h6 class="mb-3">@Localizer["PersonalInformation"]</h6>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label required">@Localizer["FullName"]</label>
                        <input type="text" class="form-control" @bind="Entity.FullName" required
                               placeholder="@Localizer["FullNamePlaceholder"]" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">@Localizer["Nationality"]</label>
                        <input type="text" class="form-control" @bind="Entity.Nationality"
                               placeholder="@Localizer["NationalityPlaceholder"]" />
                    </div>
                </div>

                <h6 class="mb-3 mt-4">@Localizer["Identification"]</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">@Localizer["PassportNumber"]</label>
                        <input type="text" class="form-control" @bind="Entity.PassportNo" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["NationalIdNumber"]</label>
                        <input type="text" class="form-control" @bind="Entity.NationalIdNo" />
                        <small class="form-hint">@Localizer["ThaiNationalHint"]</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["DrivingLicenseNumber"]</label>
                        <input type="text" class="form-control" @bind="Entity.DrivingLicenseNo" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["LicenseCountry"]</label>
                        <input type="text" class="form-control" @bind="Entity.DrivingLicenseCountry" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["LicenseExpiryDate"]</label>
                        <input type="date" class="form-control" @bind="m_licenseExpiry" />
                    </div>
                </div>

                <h6 class="mb-3 mt-4">@Localizer["ContactInformation"]</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label required">@Localizer["PhoneNumber"]</label>
                        <input type="tel" class="form-control" @bind="Entity.Phone" required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["Email"]</label>
                        <input type="email" class="form-control" @bind="Entity.Email" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["HotelName"]</label>
                        <input type="text" class="form-control" @bind="Entity.HotelName"
                               placeholder="@Localizer["HotelPlaceholder"]" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">@Localizer["HotelAddress"]</label>
                        <input type="text" class="form-control" @bind="Entity.HotelAddress" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">@Localizer["EmergencyContact"]</label>
                        <input type="text" class="form-control" @bind="Entity.EmergencyContact"
                               placeholder="@Localizer["EmergencyContactPlaceholder"]" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
        @Localizer["Cancel"]
    </button>
    <button type="submit" form="@FormId" class="btn btn-primary" disabled="@Saving">
        @if (Saving)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        <i class="ti ti-device-floppy me-1"></i>
        @SaveButtonText
    </button>
</div>

@code {
    private DateTime? m_licenseExpiry;
    private string m_activeTab = "manual";
    private List<UploadedDocumentInfo> m_uploadedDocuments = [];

    protected override void OnInitialized()
    {
        this.m_licenseExpiry = this.Entity.DrivingLicenseExpiry?.DateTime;
        this.FormValid = true;
    }

    private async Task SaveAsync()
    {
        this.Saving = true;

        try
        {
            this.Entity.DrivingLicenseExpiry = this.m_licenseExpiry.HasValue
                ? new DateTimeOffset(this.m_licenseExpiry.Value)
                : null;

            var result = this.IsNew
                ? await this.RenterService.CreateRenterAsync(this.Entity, this.UserName)
                : await this.RenterService.UpdateRenterAsync(this.Entity, this.UserName);

            if (result.Success)
            {
                this.Close();
            }
            else
            {
                this.ShowError(Localizer["SaveFailed", result.Message ?? ""]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["Error", ex.Message]);
        }
        finally
        {
            this.Saving = false;
        }
    }

    private void OnPassportDataExtracted(ExtractedDocumentData data)
    {
        if (!string.IsNullOrEmpty(data.FullName))
            this.Entity.FullName = data.FullName;

        if (!string.IsNullOrEmpty(data.DocumentNumber))
            this.Entity.PassportNo = data.DocumentNumber;

        if (!string.IsNullOrEmpty(data.Nationality))
            this.Entity.Nationality = data.Nationality;

        this.StateHasChanged();
        this.ShowSuccess(Localizer["PassportDataApplied"]);
    }

    private void OnLicenseDataExtracted(ExtractedDocumentData data)
    {
        if (!string.IsNullOrEmpty(data.DocumentNumber))
            this.Entity.DrivingLicenseNo = data.DocumentNumber;

        if (!string.IsNullOrEmpty(data.IssuingCountry))
            this.Entity.DrivingLicenseCountry = data.IssuingCountry;

        if (data.DateOfExpiry.HasValue)
        {
            this.Entity.DrivingLicenseExpiry = data.DateOfExpiry;
            this.m_licenseExpiry = data.DateOfExpiry.Value.DateTime;
        }

        if (string.IsNullOrEmpty(this.Entity.FullName) && !string.IsNullOrEmpty(data.FullName))
            this.Entity.FullName = data.FullName;

        this.StateHasChanged();
        this.ShowSuccess(Localizer["LicenseDataApplied"]);
    }

    private void OnDocumentUploaded(DocumentUploadResult result)
    {
        if (result.ExtractedData != null)
        {
            this.m_uploadedDocuments.Add(new UploadedDocumentInfo
            {
                DocumentId = result.DocumentId,
                DocumentType = result.ExtractedData.DocumentType,
                FilePath = result.FilePath
            });
            this.StateHasChanged();
        }
    }

    private void RemoveUploadedDocument(UploadedDocumentInfo doc)
    {
        this.m_uploadedDocuments.Remove(doc);
    }

    private static string GetDocumentIcon(string documentType) => documentType switch
    {
        "Passport" => "ti ti-id-badge",
        "NationalId" => "ti ti-credit-card",
        "DrivingLicense" => "ti ti-car",
        _ => "ti ti-file"
    };

    private class UploadedDocumentInfo
    {
        public int? DocumentId { get; set; }
        public string DocumentType { get; set; } = string.Empty;
        public string FilePath { get; set; } = string.Empty;
    }
}
