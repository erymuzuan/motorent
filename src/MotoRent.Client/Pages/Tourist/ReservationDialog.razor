@inherits MotoRentComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Models
@using MotoRent.Services
@inject RentalService RentalService
@inject InsuranceService InsuranceService

<div class="modal-body">
    @* Step Indicator *@
    <div class="steps steps-counter steps-primary mb-4">
        <a href="#" class="step-item @(m_activeStep == 0 ? "active" : "") @(m_activeStep > 0 ? "step-item-completed" : "")"
           @onclick="@(() => GoToStep(0))" @onclick:preventDefault>
            Rental Details
        </a>
        <a href="#" class="step-item @(m_activeStep == 1 ? "active" : "") @(m_activeStep > 1 ? "step-item-completed" : "")"
           @onclick="@(() => GoToStep(1))" @onclick:preventDefault>
            Your Information
        </a>
        <a href="#" class="step-item @(m_activeStep == 2 ? "active" : "")"
           @onclick="@(() => GoToStep(2))" @onclick:preventDefault>
            Confirm
        </a>
    </div>

    @* Step 1: Dates & Insurance *@
    @if (m_activeStep == 0)
    {
        <div class="d-flex flex-column gap-4">
            <h4>Select Your Rental Period</h4>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">Start Date</label>
                    <input type="date" class="form-control" @bind="m_startDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-6">
                    <label class="form-label required">End Date</label>
                    <input type="date" class="form-control" @bind="m_endDate" min="@(m_startDate?.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" />
                </div>
            </div>

            @if (m_startDate.HasValue && m_endDate.HasValue)
            {
                <div class="alert alert-info">
                    <i class="ti ti-calendar me-2"></i>
                    @m_days day(s) - @FormatDate(m_startDate.Value) to @FormatDate(m_endDate.Value)
                </div>
            }

            <hr />

            <h4>Insurance Options</h4>

            @if (m_loadingInsurance)
            {
                <div class="progress progress-sm">
                    <div class="progress-bar progress-bar-indeterminate"></div>
                </div>
            }
            else
            {
                <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column gap-2">
                    <label class="form-selectgroup-item flex-fill">
                        <input type="radio" name="insurance" value="" class="form-selectgroup-input"
                               checked="@(!m_selectedInsuranceId.HasValue)"
                               @onchange="@(() => m_selectedInsuranceId = null)" />
                        <div class="form-selectgroup-label d-flex align-items-center p-3">
                            <div class="me-3"><span class="form-selectgroup-check"></span></div>
                            <div class="flex-fill">
                                <strong>No Insurance</strong>
                                <div class="text-secondary small">You are responsible for all damages</div>
                            </div>
                        </div>
                    </label>

                    @foreach (var insurance in m_insuranceOptions)
                    {
                        <label class="form-selectgroup-item flex-fill">
                            <input type="radio" name="insurance" value="@insurance.InsuranceId" class="form-selectgroup-input"
                                   checked="@(m_selectedInsuranceId == insurance.InsuranceId)"
                                   @onchange="@(() => m_selectedInsuranceId = insurance.InsuranceId)" />
                            <div class="form-selectgroup-label d-flex align-items-center p-3">
                                <div class="me-3"><span class="form-selectgroup-check"></span></div>
                                <div class="flex-fill">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>@insurance.Name</strong>
                                            <div class="text-secondary small">@insurance.Description</div>
                                            <small class="text-muted">
                                                Deductible: @FormatCurrency(insurance.Deductible) | Max: @FormatCurrency(insurance.MaxCoverage)
                                            </small>
                                        </div>
                                        <span class="text-primary">+@FormatCurrency(insurance.DailyRate)/day</span>
                                    </div>
                                </div>
                            </div>
                        </label>
                    }
                </div>
            }

            @* Color Preference (only if group has available colors) *@
            @if (VehicleGroup != null && VehicleGroup.AvailableColors.Count > 0)
            {
                <hr />
                <h4>Color Preference</h4>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Preferred Color (optional)</label>
                        <select class="form-select" @bind="m_preferredColor">
                            <option value="">No preference</option>
                            @foreach (var color in VehicleGroup.AvailableColors)
                            {
                                <option value="@color">@color</option>
                            }
                        </select>
                        <small class="form-hint">
                            <i class="ti ti-info-circle me-1"></i>
                            Color preference is not guaranteed
                        </small>
                    </div>
                </div>
            }
        </div>
    }

    @* Step 2: Contact Information *@
    @if (m_activeStep == 1)
    {
        <div class="d-flex flex-column gap-3">
            <div>
                <h4>Contact Details</h4>
                <p class="text-secondary">We'll use this information to confirm your reservation</p>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label required">Full Name</label>
                    <input type="text" class="form-control" @bind="m_contactInfo.FullName" required />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Nationality</label>
                    <input type="text" class="form-control" @bind="m_contactInfo.Nationality" />
                </div>
                <div class="col-md-6">
                    <label class="form-label required">Phone/WhatsApp</label>
                    <input type="tel" class="form-control" @bind="m_contactInfo.Phone" required />
                </div>
                <div class="col-md-6">
                    <label class="form-label required">Email</label>
                    <input type="email" class="form-control" @bind="m_contactInfo.Email" required />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Passport Number</label>
                    <input type="text" class="form-control" @bind="m_contactInfo.PassportNo" />
                    <small class="form-hint">Required for pickup</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Hotel/Accommodation</label>
                    <input type="text" class="form-control" @bind="m_contactInfo.HotelName" />
                    <small class="form-hint">Where are you staying?</small>
                </div>
                <div class="col-12">
                    <label class="form-label">Special Requests</label>
                    <textarea class="form-control" rows="2" @bind="m_contactInfo.Notes"
                              placeholder="Any special requests or notes..."></textarea>
                </div>
            </div>
        </div>
    }

    @* Step 3: Confirmation *@
    @if (m_activeStep == 2)
    {
        <div class="d-flex flex-column gap-4">
            <h4>Reservation Summary</h4>

            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <small class="text-secondary">Vehicle</small>
                                <div class="fw-bold">@DisplayName</div>
                                @if (!string.IsNullOrEmpty(m_preferredColor))
                                {
                                    <small class="text-secondary">Preferred color: @m_preferredColor (not guaranteed)</small>
                                }
                            </div>
                            <div class="mb-3">
                                <small class="text-secondary">Rental Period</small>
                                <div>
                                    @FormatDate(m_startDate ?? DateTime.Today) - @FormatDate(m_endDate ?? DateTime.Today)
                                    (@m_days days)
                                </div>
                            </div>
                            @if (m_selectedInsurance != null)
                            {
                                <div>
                                    <small class="text-secondary">Insurance</small>
                                    <div>@m_selectedInsurance.Name</div>
                                </div>
                            }
                        </div>
                        <div class="col-md-6">
                            <div>
                                <small class="text-secondary">Contact</small>
                                <div class="fw-bold">@m_contactInfo.FullName</div>
                                <div>@m_contactInfo.Phone</div>
                                <div>@m_contactInfo.Email</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h4 class="card-title mb-3">Pricing Breakdown</h4>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between">
                            <span>Vehicle (@m_days days x @FormatCurrency(DailyRate))</span>
                            <span>@FormatCurrency(m_vehicleTotal)</span>
                        </div>
                        @if (m_selectedInsurance != null)
                        {
                            <div class="d-flex justify-content-between">
                                <span>Insurance (@m_days days x @FormatCurrency(m_selectedInsurance.DailyRate))</span>
                                <span>@FormatCurrency(m_insuranceTotal)</span>
                            </div>
                        }
                        <hr class="my-1" />
                        <div class="d-flex justify-content-between">
                            <span class="h4 mb-0">Total</span>
                            <span class="h3 text-primary mb-0">@FormatCurrency(m_totalAmount)</span>
                        </div>
                        <div class="d-flex justify-content-between text-secondary">
                            <span>Security Deposit (refundable)</span>
                            <span>@FormatCurrency(DepositAmount)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <i class="ti ti-info-circle me-2"></i>
                <strong>Next Steps:</strong> After submitting, you'll receive a confirmation email.
                Please bring your passport and payment to our shop at least 30 minutes before your rental starts.
            </div>

            <label class="form-check">
                <input type="checkbox" class="form-check-input" @bind="m_agreedToTerms" />
                <span class="form-check-label">
                    I agree to the <a href="/terms" target="_blank">Terms and Conditions</a>
                    and <a href="/rental-policy" target="_blank">Rental Policy</a>
                </span>
            </label>
        </div>
    }
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">Cancel</button>
    @if (m_activeStep > 0)
    {
        <button type="button" class="btn btn-outline-primary" @onclick="PreviousStep">
            <i class="ti ti-arrow-left me-1"></i>
            Back
        </button>
    }
    @if (m_activeStep < 2)
    {
        <button type="button" class="btn btn-primary" disabled="@(!CanProceed)" @onclick="NextStep">
            Next
            <i class="ti ti-arrow-right ms-1"></i>
        </button>
    }
    else
    {
        <button type="button" class="btn btn-primary" disabled="@(!CanSubmit || m_submitting)" @onclick="SubmitReservation">
            @if (m_submitting)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            }
            Submit Reservation
        </button>
    }
</div>

@code {
    [CascadingParameter] private ModalInstance? ModalInstance { get; set; }
    [Parameter] public Motorbike? Motorbike { get; set; }
    [Parameter] public VehicleGroup? VehicleGroup { get; set; }
    [Parameter] public DateRangeSelection? DateRange { get; set; }

    private int m_activeStep;
    private bool m_submitting;
    private bool m_loadingInsurance = true;

    // Step 1: Dates & Insurance
    private DateTime? m_startDate;
    private DateTime? m_endDate;
    private List<Insurance> m_insuranceOptions = [];
    private int? m_selectedInsuranceId;
    private Insurance? m_selectedInsurance => this.m_insuranceOptions.FirstOrDefault(i => i.InsuranceId == this.m_selectedInsuranceId);
    private string? m_preferredColor;

    // Step 2: Contact Info
    private ContactInfo m_contactInfo = new();

    // Step 3: Confirmation
    private bool m_agreedToTerms;

    // Display helpers that work with both Motorbike and VehicleGroup
    private string DisplayName => this.VehicleGroup?.DisplayName
        ?? (this.Motorbike != null ? $"{this.Motorbike.Brand} {this.Motorbike.Model} {this.Motorbike.Year}" : "");
    private decimal DailyRate => this.VehicleGroup?.MinDailyRate ?? this.Motorbike?.DailyRate ?? 0;
    private decimal DepositAmount => this.VehicleGroup?.MinDepositAmount ?? this.Motorbike?.DepositAmount ?? 0;
    private bool IsGroupReservation => this.VehicleGroup != null;

    // Calculations
    private int m_days => this.m_startDate.HasValue && this.m_endDate.HasValue
        ? Math.Max(1, (this.m_endDate.Value - this.m_startDate.Value).Days + 1)
        : 0;
    private decimal m_vehicleTotal => this.DailyRate * this.m_days;
    private decimal m_insuranceTotal => (this.m_selectedInsurance?.DailyRate ?? 0) * this.m_days;
    private decimal m_totalAmount => this.m_vehicleTotal + this.m_insuranceTotal;

    private bool CanProceed => this.m_activeStep switch
    {
        0 => this.m_startDate.HasValue && this.m_endDate.HasValue,
        1 => !string.IsNullOrWhiteSpace(this.m_contactInfo.FullName) &&
             !string.IsNullOrWhiteSpace(this.m_contactInfo.Phone) &&
             !string.IsNullOrWhiteSpace(this.m_contactInfo.Email),
        _ => true
    };

    private bool CanSubmit => this.m_agreedToTerms && this.CanProceed;

    protected override async Task OnInitializedAsync()
    {
        this.m_startDate = this.DateRange?.Start ?? DateTime.Today;
        this.m_endDate = this.DateRange?.End ?? DateTime.Today.AddDays(3);
        await this.LoadInsuranceOptions();
    }

    private async Task LoadInsuranceOptions()
    {
        this.m_loadingInsurance = true;
        try
        {
            var result = await this.InsuranceService.GetActiveInsurancesAsync(0);
            this.m_insuranceOptions = result;
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading insurance options: {ex.Message}");
        }
        finally
        {
            this.m_loadingInsurance = false;
        }
    }

    private void Cancel() => this.ModalInstance?.Cancel();

    private void GoToStep(int step)
    {
        if (step <= this.m_activeStep)
            this.m_activeStep = step;
    }

    private void NextStep()
    {
        if (this.CanProceed && this.m_activeStep < 2)
            this.m_activeStep++;
    }

    private void PreviousStep()
    {
        if (this.m_activeStep > 0)
            this.m_activeStep--;
    }

    private async Task SubmitReservation()
    {
        if (!this.CanSubmit) return;

        this.m_submitting = true;
        try
        {
            var request = new ReservationRequest
            {
                ShopId = this.RequestContext.GetShopId(),
                // For group reservations, VehicleId may be 0; for individual, use the Motorbike's ID
                VehicleId = this.IsGroupReservation ? 0 : (this.Motorbike?.MotorbikeId ?? 0),
                VehicleGroupKey = this.VehicleGroup?.GroupKey,
                PreferredColor = this.m_preferredColor,
                StartDate = new DateTimeOffset(DateTime.SpecifyKind(this.m_startDate!.Value.Date, DateTimeKind.Unspecified), TimeSpan.Zero),
                EndDate = new DateTimeOffset(DateTime.SpecifyKind(this.m_endDate!.Value.Date, DateTimeKind.Unspecified), TimeSpan.Zero),
                InsuranceId = this.m_selectedInsuranceId,
                DailyRate = this.DailyRate,
                TotalAmount = this.m_totalAmount,
                // Contact info
                RenterName = this.m_contactInfo.FullName,
                RenterPhone = this.m_contactInfo.Phone,
                RenterEmail = this.m_contactInfo.Email,
                RenterNationality = this.m_contactInfo.Nationality,
                RenterPassport = this.m_contactInfo.PassportNo,
                HotelName = this.m_contactInfo.HotelName,
                Notes = this.m_contactInfo.Notes
            };

            var result = await this.RentalService.CreateReservationAsync(request);

            if (result.Success)
            {
                this.ModalInstance?.Close(result.RentalId);
            }
            else
            {
                this.ShowError($"Reservation failed: {result.Message}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
        finally
        {
            this.m_submitting = false;
        }
    }

    private class ContactInfo
    {
        public string FullName { get; set; } = "";
        public string Phone { get; set; } = "";
        public string Email { get; set; } = "";
        public string? Nationality { get; set; }
        public string? PassportNo { get; set; }
        public string? HotelName { get; set; }
        public string? Notes { get; set; }
    }

    public class DateRangeSelection
    {
        public DateTime? Start { get; set; }
        public DateTime? End { get; set; }

        public DateRangeSelection() { }
        public DateRangeSelection(DateTime? start, DateTime? end)
        {
            this.Start = start;
            this.End = end;
        }
    }
}
