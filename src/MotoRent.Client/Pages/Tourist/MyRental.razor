@page "/tourist/{AccountNo}/my-rental/{RentalWebId}"
@page "/r/{RentalWebId}"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inherits TouristComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Tourist
@using MotoRent.Services
@using MotoRent.Client.Components.Tourist
@using MotoRent.Client.Services.Offline
@inject RentalService RentalService
@inject ShopService ShopService
@inject IndexedDbService OfflineDb
@inject NetworkStateService NetworkState
@inject IJSRuntime JS

<PageTitle>My Rental - @this.TenantName</PageTitle>

@if (this.Loading)
{
    <div class="mr-loading-screen">
        <div class="mr-loading-content">
            <div class="mr-loading-spinner"></div>
            <p class="mr-loading-text">Loading your rental...</p>
        </div>
    </div>
}
else if (this.Rental is null)
{
    <div class="mr-error-container">
        <div class="mr-error-card">
            <div class="mr-error-icon">
                <i class="ti ti-file-x"></i>
            </div>
            <h2>Rental Not Found</h2>
            <p>We couldn't find a rental with this reference. Please check your QR code or contact the shop.</p>
            @if (!string.IsNullOrEmpty(this.TenantAccountNo))
            {
                <a href="@this.BrowseUrl" class="mr-btn mr-btn-primary">
                    <i class="ti ti-motorbike"></i>
                    Browse Vehicles
                </a>
            }
        </div>
    </div>
}
else
{
    <div class="mr-rental-page">
        @* Mobile-first: Offline/Sync status bar at top *@
        <div class="mr-sync-bar @(this.IsDownloaded ? "synced" : "")">
            <div class="mr-sync-content">
                @if (this.IsDownloaded)
                {
                    <div class="mr-sync-status">
                        <i class="ti ti-cloud-check"></i>
                        <span>Saved Offline</span>
                        <small>@this.FormatLastSync()</small>
                    </div>
                    <button type="button" class="mr-sync-btn" @onclick="this.RefreshOfflineData" disabled="@this.Downloading">
                        @if (this.Downloading)
                        {
                            <span class="mr-spinner-sm"></span>
                        }
                        else
                        {
                            <i class="ti ti-refresh"></i>
                        }
                        Sync
                    </button>
                }
                else
                {
                    <div class="mr-sync-status">
                        <i class="ti ti-cloud-off"></i>
                        <span>Not saved offline</span>
                    </div>
                    <button type="button" class="mr-sync-btn primary" @onclick="this.DownloadForOffline" disabled="@this.Downloading">
                        @if (this.Downloading)
                        {
                            <span class="mr-spinner-sm"></span>
                        }
                        else
                        {
                            <i class="ti ti-download"></i>
                        }
                        Save
                    </button>
                }
            </div>
        </div>

        @* Status Hero Section *@
        <div class="mr-status-hero @this.GetStatusHeroClass()">
            <div class="mr-status-icon">
                <i class="ti @this.GetStatusIcon()"></i>
            </div>
            <div class="mr-status-info">
                <div class="mr-status-badge-row">
                    <span class="mr-status-badge @this.GetStatusBadgeClass()">@this.Rental.Status</span>
                </div>
                <h1 class="mr-status-title">@this.GetStatusTitle()</h1>
                <p class="mr-status-desc">@this.GetStatusDescription()</p>
            </div>
            @if (this.Rental.Status == "Active")
            {
                <div class="mr-countdown">
                    <div class="mr-countdown-label">Return in</div>
                    <div class="mr-countdown-value">@this.GetDaysRemaining()</div>
                    <div class="mr-countdown-unit">@this.GetDaysRemainingUnit()</div>
                </div>
            }
        </div>

        @* QR Code Section - Important for staff pickup/return *@
        @if (this.Rental.Status is "Active" or "Reserved")
        {
            <div class="mr-qr-section">
                <div class="mr-qr-card">
                    <div class="mr-qr-header">
                        <i class="ti ti-qrcode"></i>
                        <span>Show to Staff</span>
                    </div>
                    <div class="mr-qr-code">
                        <img src="@this.GetQRCodeUrl()" alt="QR Code" />
                    </div>
                    <div class="mr-qr-ref">Rental #@this.Rental.RentalId</div>
                </div>
            </div>
        }

        @* Vehicle Card *@
        <div class="mr-section">
            <div class="mr-card mr-vehicle-card">
                <div class="mr-vehicle-image">
                    <img src="@this.GetVehicleImageUrl()" alt="@this.Rental.VehicleName" />
                    <div class="mr-vehicle-overlay">
                        <span class="mr-vehicle-name">@this.Rental.VehicleName</span>
                    </div>
                </div>
                <div class="mr-vehicle-details">
                    @if (!string.IsNullOrEmpty(this.VehicleLicensePlate))
                    {
                        <div class="mr-license-plate">
                            <span class="mr-plate-text">@this.VehicleLicensePlate</span>
                        </div>
                    }
                    <div class="mr-vehicle-info-grid">
                        <div class="mr-info-item">
                            <i class="ti ti-calendar-event"></i>
                            <div class="mr-info-content">
                                <span class="mr-info-label">Pickup</span>
                                <span class="mr-info-value">@this.FormatDateTimeMobile(this.Rental.StartDate)</span>
                            </div>
                        </div>
                        <div class="mr-info-item">
                            <i class="ti ti-calendar-due"></i>
                            <div class="mr-info-content">
                                <span class="mr-info-label">Return</span>
                                <span class="mr-info-value">@this.FormatDateTimeMobile(this.Rental.ExpectedEndDate)</span>
                            </div>
                        </div>
                        @if (this.Rental.MileageStart > 0)
                        {
                            <div class="mr-info-item full-width">
                                <i class="ti ti-gauge"></i>
                                <div class="mr-info-content">
                                    <span class="mr-info-label">Start Mileage</span>
                                    <span class="mr-info-value">@this.Rental.MileageStart.ToString("N0") km</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @* Quick Actions - Large touch targets for mobile *@
        @if (this.Rental.Status is "Active" or "Reserved")
        {
            <div class="mr-section">
                <h2 class="mr-section-title">
                    <i class="ti ti-bolt"></i>
                    Quick Actions
                </h2>
                <div class="mr-actions-grid">
                    <button type="button" class="mr-action-btn" @onclick="this.ExtendRental">
                        <div class="mr-action-icon extend">
                            <i class="ti ti-calendar-plus"></i>
                        </div>
                        <span class="mr-action-label">Extend Rental</span>
                    </button>
                    <button type="button" class="mr-action-btn" @onclick="this.ViewContract">
                        <div class="mr-action-icon contract">
                            <i class="ti ti-file-text"></i>
                        </div>
                        <span class="mr-action-label">View Contract</span>
                    </button>
                    <button type="button" class="mr-action-btn" @onclick="this.ReportAccident">
                        <div class="mr-action-icon report">
                            <i class="ti ti-alert-triangle"></i>
                        </div>
                        <span class="mr-action-label">Report Issue</span>
                    </button>
                    <button type="button" class="mr-action-btn emergency" @onclick="this.ShowEmergencyCard">
                        <div class="mr-action-icon emergency">
                            <i class="ti ti-first-aid-kit"></i>
                        </div>
                        <span class="mr-action-label">Emergency</span>
                    </button>
                </div>
            </div>
        }

        @* Rental Details Card *@
        <div class="mr-section">
            <h2 class="mr-section-title">
                <i class="ti ti-receipt"></i>
                Rental Details
            </h2>
            <div class="mr-card mr-details-card">
                <div class="mr-detail-row">
                    <span class="mr-detail-label">Reference</span>
                    <span class="mr-detail-value">#@this.Rental.RentalId</span>
                </div>
                <div class="mr-detail-row">
                    <span class="mr-detail-label">Duration</span>
                    <span class="mr-detail-value">@this.GetDurationText()</span>
                </div>
                <div class="mr-detail-row">
                    <span class="mr-detail-label">@this.GetRateLabel()</span>
                    <span class="mr-detail-value">@this.FormatCurrency(this.Rental.RentalRate)</span>
                </div>
                @if (this.Rental.IncludeDriver)
                {
                    <div class="mr-detail-row">
                        <span class="mr-detail-label">Driver Fee</span>
                        <span class="mr-detail-value">@this.FormatCurrency(this.Rental.DriverFee)</span>
                    </div>
                }
                @if (this.Rental.IncludeGuide)
                {
                    <div class="mr-detail-row">
                        <span class="mr-detail-label">Guide Fee</span>
                        <span class="mr-detail-value">@this.FormatCurrency(this.Rental.GuideFee)</span>
                    </div>
                }
                <div class="mr-detail-divider"></div>
                <div class="mr-detail-row total">
                    <span class="mr-detail-label">Total Amount</span>
                    <span class="mr-detail-value">@this.FormatCurrency(this.Rental.TotalAmount)</span>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(this.Rental.Notes))
            {
                <div class="mr-notes">
                    <i class="ti ti-note"></i>
                    <span>@this.Rental.Notes</span>
                </div>
            }
        </div>

        @* Important Reminders *@
        <div class="mr-section">
            <div class="mr-reminder-card">
                <div class="mr-reminder-header">
                    <i class="ti ti-alert-circle"></i>
                    <span>Important Reminders</span>
                </div>
                <ul class="mr-reminder-list">
                    <li>
                        <i class="ti ti-helmet"></i>
                        Always wear a helmet while riding
                    </li>
                    <li>
                        <i class="ti ti-gas-station"></i>
                        Return with the same fuel level
                    </li>
                    <li>
                        <i class="ti ti-camera"></i>
                        Report any damage immediately
                    </li>
                    <li>
                        <i class="ti ti-bookmark"></i>
                        Bookmark this page for quick access
                    </li>
                    @if (this.Rental.Status == "Active")
                    {
                        <li class="highlight">
                            <i class="ti ti-clock"></i>
                            <strong>Return by @this.FormatDateTimeMobile(this.Rental.ExpectedEndDate)</strong>
                        </li>
                    }
                </ul>
            </div>
        </div>

        @* Shop Contact Section *@
        @if (this.ShopContactInfo is not null)
        {
            <div class="mr-section">
                <h2 class="mr-section-title">
                    <i class="ti ti-building-store"></i>
                    Shop Contact
                </h2>
                <ShopContactCard ContactInfo="@this.ShopContactInfo" Class="mr-shop-card" />
            </div>
        }
    </div>

    @* Floating Contact Button *@
    @if (this.ShopContactInfo is not null)
    {
        <ShopContactFAB ContactInfo="@this.ShopContactInfo" />
    }
}

@code {
    [Parameter] public new string AccountNo { get; set; } = "";
    [Parameter] public string RentalWebId { get; set; } = "";

    private bool Loading { get; set; } = true;
    private bool Initialized { get; set; }
    private bool Downloading { get; set; }
    private bool IsDownloaded { get; set; }
    private DateTimeOffset? LastSyncAt { get; set; }
    private Rental? Rental { get; set; }
    private Shop? Shop { get; set; }
    private ShopContactInfo? ShopContactInfo { get; set; }
    private string? VehicleLicensePlate { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await this.LoadRentalAsync();
            await this.CheckOfflineStatusAsync();
        }
    }

    private async Task CheckOfflineStatusAsync()
    {
        try
        {
            await this.OfflineDb.InitializeAsync();
            var offlineRental = await this.OfflineDb.GetRentalByWebIdAsync(this.RentalWebId);
            if (offlineRental != null)
            {
                this.IsDownloaded = true;
                if (DateTimeOffset.TryParse(offlineRental.LastSyncAt, out var lastSync))
                {
                    this.LastSyncAt = lastSync;
                }
                this.StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MyRental] Error checking offline status: {ex.Message}");
        }
    }

    private async Task LoadRentalAsync()
    {
        if (this.Initialized) return;
        this.Initialized = true;
        this.Loading = true;

        try
        {
            var accountNo = this.AccountNo;
            if (!string.IsNullOrEmpty(accountNo))
            {
                this.Rental = await this.RentalService.GetRentalByWebIdAsync(this.RentalWebId, accountNo);
            }

            if (this.Rental == null)
            {
                this.Rental = await this.RentalService.GetRentalByWebIdAsync(this.RentalWebId);
            }

            if (this.Rental == null && int.TryParse(this.RentalWebId, out var rentalId))
            {
                this.Rental = await this.RentalService.GetRentalAsync(rentalId);
            }

            if (this.Rental != null)
            {
                this.Shop = !string.IsNullOrEmpty(accountNo)
                    ? await this.ShopService.GetShopByIdAsync(this.Rental.RentedFromShopId, accountNo)
                    : await this.ShopService.GetShopByIdAsync(this.Rental.RentedFromShopId);

                if (this.Shop != null)
                {
                    this.ShopContactInfo = Domain.Tourist.ShopContactInfo.FromShop(
                        this.Shop,
                        renterName: this.Rental.RenterName,
                        rentalReference: this.Rental.RentalId.ToString(),
                        vehicleInfo: $"{this.Rental.VehicleName} ({this.VehicleLicensePlate})"
                    );
                }

                var vehicle = !string.IsNullOrEmpty(accountNo)
                    ? await this.RentalService.GetVehicleForRentalAsync(this.Rental.VehicleId, accountNo)
                    : await this.RentalService.GetVehicleForRentalAsync(this.Rental.VehicleId);

                if (vehicle != null)
                {
                    this.VehicleLicensePlate = vehicle.LicensePlate;
                }
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading rental: {ex.Message}");
        }
        finally
        {
            this.Loading = false;
            this.StateHasChanged();
        }
    }

    private string GetStatusHeroClass() => this.Rental?.Status switch
    {
        "Active" => "status-active",
        "Reserved" => "status-reserved",
        "Completed" => "status-completed",
        "Cancelled" => "status-cancelled",
        _ => ""
    };

    private string GetStatusIcon() => this.Rental?.Status switch
    {
        "Active" => "ti-steering-wheel",
        "Reserved" => "ti-calendar-check",
        "Completed" => "ti-circle-check",
        "Cancelled" => "ti-x",
        _ => "ti-info-circle"
    };

    private string GetStatusTitle() => this.Rental?.Status switch
    {
        "Active" => "Enjoy Your Ride!",
        "Reserved" => "Reservation Confirmed",
        "Completed" => "Thanks for Riding!",
        "Cancelled" => "Rental Cancelled",
        _ => "Unknown Status"
    };

    private string GetStatusDescription() => this.Rental?.Status switch
    {
        "Active" => $"Return by {this.FormatDateTimeMobile(this.Rental!.ExpectedEndDate)}",
        "Reserved" => $"Pick up on {this.FormatDateTimeMobile(this.Rental!.StartDate)}",
        "Completed" => "We hope to see you again!",
        "Cancelled" => "This rental has been cancelled.",
        _ => ""
    };

    private string GetStatusBadgeClass() => this.Rental?.Status switch
    {
        "Active" => "badge-active",
        "Reserved" => "badge-reserved",
        "Completed" => "badge-completed",
        "Cancelled" => "badge-cancelled",
        _ => ""
    };

    private string GetDaysRemaining()
    {
        if (this.Rental is null) return "0";
        var remaining = this.Rental.ExpectedEndDate - DateTimeOffset.Now;
        if (remaining.TotalDays >= 1) return ((int)remaining.TotalDays).ToString();
        if (remaining.TotalHours >= 1) return ((int)remaining.TotalHours).ToString();
        return remaining.TotalMinutes > 0 ? ((int)remaining.TotalMinutes).ToString() : "0";
    }

    private string GetDaysRemainingUnit()
    {
        if (this.Rental is null) return "days";
        var remaining = this.Rental.ExpectedEndDate - DateTimeOffset.Now;
        if (remaining.TotalDays >= 1) return remaining.TotalDays >= 2 ? "days" : "day";
        if (remaining.TotalHours >= 1) return remaining.TotalHours >= 2 ? "hours" : "hour";
        return "mins";
    }

    private string GetVehicleImageUrl()
    {
        return "https://placehold.co/600x400/00897B/white?text=Your+Vehicle";
    }

    private string FormatDateTimeMobile(DateTimeOffset date)
    {
        return date.ToString("MMM d, h:mm tt");
    }

    private string GetDurationText()
    {
        if (this.Rental is null) return "";
        var days = (this.Rental.ExpectedEndDate - this.Rental.StartDate).Days;
        if (days == 0) days = 1;
        return this.Rental.DurationType == RentalDurationType.Daily
            ? $"{days} day{(days > 1 ? "s" : "")}"
            : $"{this.Rental.IntervalMinutes} minutes";
    }

    private string GetRateLabel()
    {
        return this.Rental?.DurationType == RentalDurationType.Daily
            ? "Daily Rate"
            : $"{this.Rental?.IntervalMinutes}-min Rate";
    }

    private string GetQRCodeUrl()
    {
        var qrData = $"MOTORENT-{this.Rental?.RentalId}-{this.Rental?.WebId}";
        return $"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={Uri.EscapeDataString(qrData)}";
    }

    private async Task ExtendRental()
    {
        if (this.ShopContactInfo is { WhatsAppUrl: { Length: > 0 } whatsAppUrl })
        {
            await this.JS.InvokeVoidAsync("open", whatsAppUrl, "_blank");
        }
        else if (this.ShopContactInfo is { PhoneUrl: { Length: > 0 } phoneUrl })
        {
            await this.JS.InvokeVoidAsync("open", phoneUrl, "_self");
        }
        else
        {
            this.ShowInfo("Please contact the shop to extend your rental.");
        }
    }

    private void ViewContract()
    {
        if (this.Rental is not null)
        {
            this.NavigateToTenant($"my-rental/{this.RentalWebId}/contract");
        }
    }

    private void ReportAccident()
    {
        if (this.Rental is not null)
        {
            this.NavigateToTenant($"my-rental/{this.RentalWebId}/accident-report");
        }
    }

    private async Task ShowEmergencyCard()
    {
        var message = "Emergency Contacts:\n\n" +
                      "Tourist Police: 1155\n" +
                      "Ambulance: 1669\n" +
                      "Police: 191\n\n";

        if (this.Shop is not null)
        {
            message += $"Shop: {this.Shop.Phone}";
        }

        await this.DialogService.ShowMessageAsync(message, "Emergency Contacts");
    }

    private async Task DownloadForOffline()
    {
        if (this.Rental is null) return;

        this.Downloading = true;
        this.StateHasChanged();

        try
        {
            await this.OfflineDb.InitializeAsync();

            var offlinePackage = new OfflineRentalPackage
            {
                RentalId = this.Rental.RentalId,
                WebId = this.Rental.WebId.ToString(),
                AccountNo = this.TenantAccountNo ?? "",
                Status = this.Rental.Status,
                StartDate = this.Rental.StartDate,
                ExpectedEndDate = this.Rental.ExpectedEndDate,
                RentalRate = this.Rental.RentalRate,
                TotalAmount = this.Rental.TotalAmount,
                Vehicle = new OfflineVehicleInfo
                {
                    VehicleId = this.Rental.VehicleId,
                    Brand = this.Rental.VehicleName?.Split(' ').FirstOrDefault() ?? "",
                    Model = this.Rental.VehicleName ?? "",
                    LicensePlate = this.VehicleLicensePlate ?? "",
                    ImageUrl = this.GetVehicleImageUrl()
                },
                Renter = new OfflineRenterInfo
                {
                    RenterId = this.Rental.RenterId,
                    FullName = this.Rental.RenterName ?? ""
                }
            };

            if (this.Shop is not null && this.ShopContactInfo is not null)
            {
                offlinePackage.Shop = new OfflineShopInfo
                {
                    ShopId = this.Shop.ShopId,
                    Name = this.Shop.Name,
                    Phone = this.Shop.Phone,
                    Address = this.Shop.Address,
                    Latitude = this.Shop.GpsLocation?.Lat ?? 0,
                    Longitude = this.Shop.GpsLocation?.Lng ?? 0,
                    WhatsAppUrl = this.ShopContactInfo.WhatsAppUrl,
                    LineUrl = this.ShopContactInfo.LineUrl,
                    GoogleMapsUrl = this.ShopContactInfo.GoogleMapsUrl,
                    Hours = this.ShopContactInfo.Hours,
                    IsCurrentlyOpen = this.ShopContactInfo.IsCurrentlyOpen
                };
            }

            offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "tourist-police", Type = "police", Name = "Tourist Police", Phone = "1155", Priority = 1 });
            offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "ambulance", Type = "medical", Name = "Ambulance", Phone = "1669", Priority = 2 });
            offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "police", Type = "police", Name = "Police", Phone = "191", Priority = 3 });

            if (this.Shop is { Phone: { Length: > 0 } shopPhone })
            {
                offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "shop", Type = "shop", Name = this.Shop.Name, Phone = shopPhone, Priority = 4 });
            }

            await this.OfflineDb.SaveRentalPackageAsync(offlinePackage);

            this.IsDownloaded = true;
            this.LastSyncAt = DateTimeOffset.Now;
            this.ShowSuccess("Rental saved for offline use!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MyRental] Error downloading for offline: {ex.Message}");
            this.ShowError("Failed to save for offline. Please try again.");
        }
        finally
        {
            this.Downloading = false;
            this.StateHasChanged();
        }
    }

    private async Task RefreshOfflineData()
    {
        await this.DownloadForOffline();
    }

    private string FormatLastSync()
    {
        if (!this.LastSyncAt.HasValue) return "Unknown";
        var diff = DateTimeOffset.Now - this.LastSyncAt.Value;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        return this.LastSyncAt.Value.ToString("MMM d");
    }
}
