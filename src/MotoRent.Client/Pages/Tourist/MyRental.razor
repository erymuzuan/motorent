@page "/tourist/{AccountNo}/my-rental/{RentalWebId}"
@page "/r/{RentalWebId}"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inherits TouristComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Tourist
@using MotoRent.Services
@using MotoRent.Client.Components.Tourist
@using MotoRent.Client.Services
@using MotoRent.Client.Services.Offline
@inject RentalService RentalService
@inject ShopService ShopService
@inject IndexedDbService OfflineDb
@inject NetworkStateService NetworkState
@inject IJSRuntime JS

<PageTitle>My Rental - @this.TenantName</PageTitle>

@if (this.Loading)
{
    <div class="mr-loading-screen">
        <div class="mr-loading-content">
            <div class="mr-loading-spinner"></div>
            <p class="mr-loading-text">Loading your rental...</p>
        </div>
    </div>
}
else if (this.Rental is null)
{
    <div class="mr-error-container">
        <div class="mr-error-card">
            <div class="mr-error-icon">
                <i class="ti ti-file-x"></i>
            </div>
            <h2>Rental Not Found</h2>
            <p>We couldn't find a rental with this reference. Please check your QR code or contact the shop.</p>
            @if (!string.IsNullOrEmpty(this.TenantAccountNo))
            {
                <a href="@this.BrowseUrl" class="mr-btn mr-btn-primary">
                    <i class="ti ti-motorbike"></i>
                    Browse Vehicles
                </a>
            }
        </div>
    </div>
}
else
{
    <div class="mr-rental-page">
        @* ===== App Header ===== *@
        <header class="mr-app-header">
            <div class="mr-header-left">
                <div class="mr-header-logo">
                    <i class="ti ti-motorbike"></i>
                </div>
                <div class="mr-header-info">
                    <div class="mr-header-title">@(this.TenantName ?? "MotoRent")</div>
                    <div class="mr-connection-status">
                        <div class="mr-status-dot @(this.IsOnline ? "" : "offline")"></div>
                        <span class="mr-connection-text">
                            @if (this.IsOnline)
                            {
                                @:Connected
                            }
                            else if (this.IsDownloaded)
                            {
                                @:Offline (@this.FormatLastSync())
                            }
                            else
                            {
                                @:Offline
                            }
                        </span>
                    </div>
                </div>
            </div>
            <div class="mr-header-actions">
                <button type="button" class="mr-header-btn @(this.Downloading ? "syncing" : "")" @onclick="this.ToggleSync" title="Sync for offline">
                    @if (this.Downloading)
                    {
                        <i class="ti ti-refresh"></i>
                    }
                    else if (this.IsDownloaded)
                    {
                        <i class="ti ti-cloud-check"></i>
                    }
                    else
                    {
                        <i class="ti ti-cloud-download"></i>
                    }
                </button>
                <button type="button" class="mr-header-btn" @onclick="this.ShowQRCode" title="Show QR Code">
                    <i class="ti ti-qrcode"></i>
                </button>
            </div>
        </header>

        @* ===== RIDE Tab Content (Dashboard) ===== *@
        @if (m_activeTab == "ride")
        {
            @* Greeting Section *@
            <div class="mr-greeting-section">
                <div class="mr-greeting-row">
                    <div class="mr-greeting-text">
                        <h2>@this.GetGreeting()</h2>
                        <p>@this.GetGreetingSubtext()</p>
                    </div>
                    <div class="mr-weather-widget">
                        <i class="ti ti-sun mr-weather-icon"></i>
                        <div class="mr-weather-info">
                            <span class="mr-weather-temp">31¬∞C</span>
                            <span class="mr-weather-rain">Rain: 10%</span>
                        </div>
                    </div>
                </div>
            </div>

            @* Active Rental Card (Dark Theme) *@
            @if (this.Rental.Status is "Active" or "Reserved")
            {
                <div class="mr-rental-card">
                    <div class="mr-rental-glow"></div>
                    <div class="mr-rental-content">
                        <div class="mr-rental-header">
                            <div class="mr-rental-vehicle">
                                <div class="mr-vehicle-icon">
                                    <i class="ti ti-motorbike"></i>
                                </div>
                                <div class="mr-vehicle-info">
                                    <h3>@this.Rental.VehicleName</h3>
                                    <div class="mr-vehicle-plate">@this.VehicleLicensePlate</div>
                                </div>
                            </div>
                            <div class="mr-rental-timer">
                                <div class="mr-timer-label">@this.GetTimerLabel()</div>
                                <div class="mr-timer-value">@this.GetTimeRemaining()</div>
                            </div>
                        </div>
                        <div class="mr-rental-footer">
                            <div class="mr-fuel-gauge">
                                <div class="mr-fuel-header">
                                    <i class="ti ti-droplet"></i>
                                    <span>Fuel</span>
                                </div>
                                <div class="mr-fuel-content">
                                    <span class="mr-fuel-percent">85%</span>
                                    <div class="mr-fuel-bar">
                                        <div class="mr-fuel-fill" style="width: 85%"></div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="mr-extend-btn" @onclick="this.ExtendRental">
                                Extend
                            </button>
                        </div>
                    </div>
                </div>
            }

            @* Quick Actions Grid *@
            <div class="mr-quick-actions">
                <div class="mr-actions-grid">
                    <div class="mr-action-item" @onclick="this.ShowEmergencyCard">
                        <button type="button" class="mr-action-btn sos">
                            <i class="ti ti-first-aid-kit"></i>
                        </button>
                        <span class="mr-action-label">SOS</span>
                    </div>
                    <div class="mr-action-item" @onclick="this.NavigateToShop">
                        <button type="button" class="mr-action-btn map">
                            <i class="ti ti-navigation"></i>
                        </button>
                        <span class="mr-action-label">Map</span>
                    </div>
                    <div class="mr-action-item" @onclick="this.ContactSupport">
                        <button type="button" class="mr-action-btn support">
                            <i class="ti ti-phone"></i>
                        </button>
                        <span class="mr-action-label">Support</span>
                    </div>
                    <div class="mr-action-item" @onclick="this.ShowTips">
                        <button type="button" class="mr-action-btn tips">
                            <i class="ti ti-bulb"></i>
                        </button>
                        <span class="mr-action-label">Tips</span>
                    </div>
                </div>
            </div>

            @* Pro Tip Card *@
            <div class="mr-pro-tip">
                <div class="mr-pro-tip-content">
                    <div class="mr-pro-tip-icon">
                        <i class="ti ti-bolt"></i>
                    </div>
                    <div class="mr-pro-tip-text">
                        <h4>Pro Biker Hack</h4>
                        <p>@this.GetCurrentTip()</p>
                    </div>
                </div>
            </div>

            @* Adventure Feed *@
            <div class="mr-adventure-feed">
                <div class="mr-feed-header">
                    <h3>Adventure Feed</h3>
                    <button type="button" class="mr-feed-filter">Nearby Only</button>
                </div>
                <div class="mr-spots-list">
                    @foreach (var spot in m_nearbySpots)
                    {
                        <div class="mr-spot-card" @onclick="() => NavigateToSpot(spot)">
                            <div class="mr-spot-icon @spot.ColorClass">
                                @spot.Emoji
                            </div>
                            <div class="mr-spot-info">
                                <div class="mr-spot-meta">
                                    <span class="mr-spot-type @spot.ColorClass">@spot.Type</span>
                                    <span class="mr-spot-distance">‚Ä¢ @spot.Distance</span>
                                </div>
                                <p class="mr-spot-name">@spot.Name</p>
                            </div>
                            <div class="mr-spot-nav">
                                <i class="ti ti-navigation"></i>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        @* ===== ROUTES Tab Content ===== *@
        @if (m_activeTab == "routes")
        {
            <div class="mr-routes-content">
                <div class="mr-map-placeholder">
                    <div class="mr-map-icon">
                        <i class="ti ti-map-pin"></i>
                    </div>
                    <h3>Live Navigator</h3>
                    <p>Optimizing routes for the best island views...</p>
                </div>
                <div class="mr-map-actions">
                    <button type="button" class="mr-map-action gas" @onclick="this.FindGasStations">
                        <i class="ti ti-gas-station"></i>
                        <div class="mr-map-action-text">
                            <strong>Gas Stations</strong>
                            <span>Find nearby</span>
                        </div>
                    </button>
                    <button type="button" class="mr-map-action photo" @onclick="this.FindPhotoSpots">
                        <i class="ti ti-camera"></i>
                        <div class="mr-map-action-text">
                            <strong>Photo Spots</strong>
                            <span>Insta-worthy</span>
                        </div>
                    </button>
                </div>
            </div>
        }

        @* ===== SAFETY Tab Content ===== *@
        @if (m_activeTab == "safety")
        {
            <div class="mr-safety-content">
                <div class="mr-safety-header">
                    <h2>Safety & Rules</h2>
                    <p>Essential info for a smooth ride.</p>
                </div>

                <div class="mr-safety-rules">
                    <div class="mr-safety-rule">
                        <span class="mr-rule-icon">‚¨ÖÔ∏è</span>
                        <div class="mr-rule-text">
                            <h4>Left Side Traffic</h4>
                            <p>Always stay on the left. Thai traffic can be unpredictable.</p>
                        </div>
                    </div>
                    <div class="mr-safety-rule">
                        <span class="mr-rule-icon">ü™ñ</span>
                        <div class="mr-rule-text">
                            <h4>Helmet Policy</h4>
                            <p>Mandatory for driver & pillion. Police check often.</p>
                        </div>
                    </div>
                    <div class="mr-safety-rule">
                        <span class="mr-rule-icon">‚õΩ</span>
                        <div class="mr-rule-text">
                            <h4>Fuel Logic</h4>
                            <p>Look for '91' or '95' gas. Red bottles are roadside spares.</p>
                        </div>
                    </div>
                </div>

                <div class="mr-docs-section">
                    <h3>Digital Documents</h3>
                    <div class="mr-docs-list">
                        <div class="mr-doc-item" @onclick="this.ViewContract">
                            <div class="mr-doc-info">
                                <div class="mr-doc-icon">
                                    <i class="ti ti-file-text"></i>
                                </div>
                                <span class="mr-doc-name">Rental Contract</span>
                            </div>
                            <i class="ti ti-external-link mr-doc-arrow"></i>
                        </div>
                        <div class="mr-doc-item" @onclick="this.ShowRentalDetails">
                            <div class="mr-doc-info">
                                <div class="mr-doc-icon">
                                    <i class="ti ti-receipt"></i>
                                </div>
                                <span class="mr-doc-name">Rental Details</span>
                            </div>
                            <i class="ti ti-external-link mr-doc-arrow"></i>
                        </div>
                        <div class="mr-doc-item" @onclick="this.ReportAccident">
                            <div class="mr-doc-info">
                                <div class="mr-doc-icon">
                                    <i class="ti ti-alert-triangle"></i>
                                </div>
                                <span class="mr-doc-name">Report an Issue</span>
                            </div>
                            <i class="ti ti-external-link mr-doc-arrow"></i>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @* ===== Bottom Navigation ===== *@
    <nav class="mr-bottom-nav">
        <button type="button" class="mr-nav-item @(m_activeTab == "ride" ? "active" : "")" @onclick="@(() => SetActiveTab("ride"))">
            <i class="ti ti-motorbike"></i>
            <span>Ride</span>
        </button>
        <button type="button" class="mr-nav-item @(m_activeTab == "routes" ? "active" : "")" @onclick="@(() => SetActiveTab("routes"))">
            <i class="ti ti-navigation"></i>
            <span>Routes</span>
        </button>
        <div class="mr-talk-btn">
            <button type="button" class="mr-talk-btn-inner" @onclick="this.OpenChatAssistant">
                <i class="ti ti-message-dots"></i>
            </button>
            <span class="mr-talk-label">Talk</span>
        </div>
        <button type="button" class="mr-nav-item @(m_activeTab == "safety" ? "active" : "")" @onclick="@(() => SetActiveTab("safety"))">
            <i class="ti ti-shield-check"></i>
            <span>Safety</span>
        </button>
    </nav>
}

@code {
    [Parameter] public new string AccountNo { get; set; } = "";
    [Parameter] public string RentalWebId { get; set; } = "";

    private bool Loading { get; set; } = true;
    private bool Initialized { get; set; }
    private bool Downloading { get; set; }
    private bool IsDownloaded { get; set; }
    private bool IsOnline { get; set; } = true;
    private DateTimeOffset? LastSyncAt { get; set; }
    private Rental? Rental { get; set; }
    private Shop? Shop { get; set; }
    private ShopContactInfo? ShopContactInfo { get; set; }
    private string? VehicleLicensePlate { get; set; }

    private string m_activeTab = "ride";
    private int m_tipIndex = 0;

    private static readonly string[] s_proTips =
    [
        "Avoid the main highway to Rawai between 4 PM - 6 PM. Take the coastal backroad for zero traffic and better views! üåä",
        "Gas stations close early in rural areas. Fill up before 8 PM if you're heading to the hills! ‚õΩ",
        "Carry small bills for parking. Most beach spots charge 20-50 THB. üíµ",
        "Download offline maps before heading to remote beaches - signal can be spotty! üì±"
    ];

    private record NearbySpot(string Name, string Type, string Distance, string Emoji, string ColorClass, double Lat, double Lng);

    private readonly List<NearbySpot> m_nearbySpots =
    [
        new("Big Buddha", "Must Visit", "4.2km", "üïâÔ∏è", "purple", 7.8277, 98.3127),
        new("Promthep Cape", "Best Sunset", "12km", "üåÖ", "orange", 7.7598, 98.3031),
        new("Old Phuket Town", "Food & Photo", "8.5km", "üèòÔ∏è", "blue", 7.8852, 98.3894),
        new("Yanui Beach", "Hidden Gem", "13.2km", "üèñÔ∏è", "teal", 7.7656, 98.3044)
    ];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await this.NetworkState.InitializeAsync();
            this.IsOnline = this.NetworkState.IsOnline;
            await this.LoadRentalAsync();
            await this.CheckOfflineStatusAsync();
        }
    }

    private async Task CheckOfflineStatusAsync()
    {
        try
        {
            await this.OfflineDb.InitializeAsync();
            var offlineRental = await this.OfflineDb.GetRentalByWebIdAsync(this.RentalWebId);
            if (offlineRental != null)
            {
                this.IsDownloaded = true;
                if (DateTimeOffset.TryParse(offlineRental.LastSyncAt, out var lastSync))
                {
                    this.LastSyncAt = lastSync;
                }
                this.StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MyRental] Error checking offline status: {ex.Message}");
        }
    }

    private async Task LoadRentalAsync()
    {
        if (this.Initialized) return;
        this.Initialized = true;
        this.Loading = true;

        try
        {
            var accountNo = this.AccountNo;
            if (!string.IsNullOrEmpty(accountNo))
            {
                this.Rental = await this.RentalService.GetRentalByWebIdAsync(this.RentalWebId, accountNo);
            }

            if (this.Rental == null)
            {
                this.Rental = await this.RentalService.GetRentalByWebIdAsync(this.RentalWebId);
            }

            if (this.Rental == null && int.TryParse(this.RentalWebId, out var rentalId))
            {
                this.Rental = await this.RentalService.GetRentalAsync(rentalId);
            }

            if (this.Rental != null)
            {
                this.Shop = !string.IsNullOrEmpty(accountNo)
                    ? await this.ShopService.GetShopByIdAsync(this.Rental.RentedFromShopId, accountNo)
                    : await this.ShopService.GetShopByIdAsync(this.Rental.RentedFromShopId);

                if (this.Shop != null)
                {
                    this.ShopContactInfo = Domain.Tourist.ShopContactInfo.FromShop(
                        this.Shop,
                        renterName: this.Rental.RenterName,
                        rentalReference: this.Rental.RentalId.ToString(),
                        vehicleInfo: $"{this.Rental.VehicleName} ({this.VehicleLicensePlate})"
                    );
                }

                var vehicle = !string.IsNullOrEmpty(accountNo)
                    ? await this.RentalService.GetVehicleForRentalAsync(this.Rental.VehicleId, accountNo)
                    : await this.RentalService.GetVehicleForRentalAsync(this.Rental.VehicleId);

                if (vehicle != null)
                {
                    this.VehicleLicensePlate = vehicle.LicensePlate;
                }
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading rental: {ex.Message}");
        }
        finally
        {
            this.Loading = false;
            this.StateHasChanged();
        }
    }

    private void SetActiveTab(string tab)
    {
        m_activeTab = tab;
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12) return "Good Morning, Rider!";
        if (hour < 17) return "Hello, Rider!";
        return "Good Evening, Rider!";
    }

    private string GetGreetingSubtext()
    {
        if (this.Rental?.Status == "Reserved")
        {
            return $"Pickup on {this.FormatDateTimeMobile(this.Rental.StartDate)} üìÖ";
        }
        return "Perfect day for a ride üå¥";
    }

    private string GetTimerLabel()
    {
        return this.Rental?.Status == "Reserved" ? "Pickup In" : "Return In";
    }

    private string GetTimeRemaining()
    {
        if (this.Rental is null) return "0d";

        var targetDate = this.Rental.Status == "Reserved"
            ? this.Rental.StartDate
            : this.Rental.ExpectedEndDate;

        var remaining = targetDate - DateTimeOffset.Now;

        if (remaining.TotalDays >= 1)
        {
            var days = (int)remaining.TotalDays;
            var hours = remaining.Hours;
            return hours > 0 ? $"{days}d {hours:D2}h" : $"{days}d";
        }
        if (remaining.TotalHours >= 1)
        {
            return $"{(int)remaining.TotalHours}h {remaining.Minutes:D2}m";
        }
        if (remaining.TotalMinutes > 0)
        {
            return $"{(int)remaining.TotalMinutes}m";
        }
        return "0m";
    }

    private string GetCurrentTip()
    {
        return s_proTips[m_tipIndex % s_proTips.Length];
    }

    private string FormatDateTimeMobile(DateTimeOffset date)
    {
        return date.ToString("MMM d, h:mm tt");
    }

    private string GetQRCodeUrl()
    {
        var qrData = $"MOTORENT-{this.Rental?.RentalId}-{this.Rental?.WebId}";
        return $"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={Uri.EscapeDataString(qrData)}";
    }

    private async Task ShowQRCode()
    {
        if (this.Rental is null) return;

        await this.DialogService.Create<QRCodeDialog>("Show to Staff")
            .WithParameter(x => x.QRCodeUrl, this.GetQRCodeUrl())
            .WithParameter(x => x.RentalId, this.Rental.RentalId)
            .WithParameter(x => x.Status, this.Rental.Status)
            .WithSize(ModalSize.Small)
            .ShowDialogAsync();
    }

    private async Task ShowRentalDetails()
    {
        if (this.Rental is null) return;

        await this.DialogService.Create<RentalDetailsDialog>("Rental Details")
            .WithParameter(x => x.Rental, this.Rental)
            .WithSize(ModalSize.Medium)
            .ShowDialogAsync();
    }

    private async Task ToggleSync()
    {
        if (this.Downloading) return;
        await this.DownloadForOffline();
    }

    private async Task ExtendRental()
    {
        if (this.ShopContactInfo is { WhatsAppUrl: { Length: > 0 } whatsAppUrl })
        {
            await this.JS.InvokeVoidAsync("open", whatsAppUrl, "_blank");
        }
        else if (this.ShopContactInfo is { PhoneUrl: { Length: > 0 } phoneUrl })
        {
            await this.JS.InvokeVoidAsync("open", phoneUrl, "_self");
        }
        else
        {
            this.ShowInfo("Please contact the shop to extend your rental.");
        }
    }

    private void ViewContract()
    {
        if (this.Rental is not null)
        {
            this.NavigateToTenant($"my-rental/{this.RentalWebId}/contract");
        }
    }

    private void ReportAccident()
    {
        if (this.Rental is not null)
        {
            this.NavigateToTenant($"my-rental/{this.RentalWebId}/accident-report");
        }
    }

    private async Task ShowEmergencyCard()
    {
        var message = "Emergency Contacts:\n\n" +
                      "Tourist Police: 1155\n" +
                      "Ambulance: 1669\n" +
                      "Police: 191\n\n";

        if (this.Shop is not null)
        {
            message += $"Shop: {this.Shop.Phone}";
        }

        await this.DialogService.ShowMessageAsync(message, "Emergency Contacts");
    }

    private async Task NavigateToShop()
    {
        if (this.ShopContactInfo?.GoogleMapsUrl is { Length: > 0 } url)
        {
            await this.JS.InvokeVoidAsync("open", url, "_blank");
        }
        else
        {
            this.ShowInfo("Shop location not available.");
        }
    }

    private async Task ContactSupport()
    {
        if (this.ShopContactInfo is { PhoneUrl: { Length: > 0 } phoneUrl })
        {
            await this.JS.InvokeVoidAsync("open", phoneUrl, "_self");
        }
        else if (this.ShopContactInfo is { WhatsAppUrl: { Length: > 0 } whatsAppUrl })
        {
            await this.JS.InvokeVoidAsync("open", whatsAppUrl, "_blank");
        }
        else
        {
            this.ShowInfo("Contact information not available.");
        }
    }

    private void ShowTips()
    {
        m_tipIndex = (m_tipIndex + 1) % s_proTips.Length;
        this.StateHasChanged();
    }

    private async Task NavigateToSpot(NearbySpot spot)
    {
        var url = $"https://www.google.com/maps/dir/?api=1&destination={spot.Lat},{spot.Lng}";
        await this.JS.InvokeVoidAsync("open", url, "_blank");
    }

    private async Task FindGasStations()
    {
        var url = "https://www.google.com/maps/search/gas+station/";
        await this.JS.InvokeVoidAsync("open", url, "_blank");
    }

    private async Task FindPhotoSpots()
    {
        var url = "https://www.google.com/maps/search/viewpoint+phuket/";
        await this.JS.InvokeVoidAsync("open", url, "_blank");
    }

    private async Task OpenChatAssistant()
    {
        if (this.ShopContactInfo is { WhatsAppUrl: { Length: > 0 } whatsAppUrl })
        {
            await this.JS.InvokeVoidAsync("open", whatsAppUrl, "_blank");
        }
        else if (this.ShopContactInfo is { LineUrl: { Length: > 0 } lineUrl })
        {
            await this.JS.InvokeVoidAsync("open", lineUrl, "_blank");
        }
        else if (this.ShopContactInfo is { PhoneUrl: { Length: > 0 } phoneUrl })
        {
            await this.JS.InvokeVoidAsync("open", phoneUrl, "_self");
        }
        else
        {
            this.ShowInfo("Chat is not available. Please call the shop directly.");
        }
    }

    private async Task DownloadForOffline()
    {
        if (this.Rental is null) return;

        this.Downloading = true;
        this.StateHasChanged();

        try
        {
            await this.OfflineDb.InitializeAsync();

            var offlinePackage = new OfflineRentalPackage
            {
                RentalId = this.Rental.RentalId,
                WebId = this.Rental.WebId.ToString(),
                AccountNo = this.TenantAccountNo ?? "",
                Status = this.Rental.Status,
                StartDate = this.Rental.StartDate,
                ExpectedEndDate = this.Rental.ExpectedEndDate,
                RentalRate = this.Rental.RentalRate,
                TotalAmount = this.Rental.TotalAmount,
                Vehicle = new OfflineVehicleInfo
                {
                    VehicleId = this.Rental.VehicleId,
                    Brand = this.Rental.VehicleName?.Split(' ').FirstOrDefault() ?? "",
                    Model = this.Rental.VehicleName ?? "",
                    LicensePlate = this.VehicleLicensePlate ?? "",
                    ImageUrl = ""
                },
                Renter = new OfflineRenterInfo
                {
                    RenterId = this.Rental.RenterId,
                    FullName = this.Rental.RenterName ?? ""
                }
            };

            if (this.Shop is not null && this.ShopContactInfo is not null)
            {
                offlinePackage.Shop = new OfflineShopInfo
                {
                    ShopId = this.Shop.ShopId,
                    Name = this.Shop.Name,
                    Phone = this.Shop.Phone,
                    Address = this.Shop.Address,
                    Latitude = this.Shop.GpsLocation?.Lat ?? 0,
                    Longitude = this.Shop.GpsLocation?.Lng ?? 0,
                    WhatsAppUrl = this.ShopContactInfo.WhatsAppUrl,
                    LineUrl = this.ShopContactInfo.LineUrl,
                    GoogleMapsUrl = this.ShopContactInfo.GoogleMapsUrl,
                    Hours = this.ShopContactInfo.Hours,
                    IsCurrentlyOpen = this.ShopContactInfo.IsCurrentlyOpen
                };
            }

            offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "tourist-police", Type = "police", Name = "Tourist Police", Phone = "1155", Priority = 1 });
            offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "ambulance", Type = "medical", Name = "Ambulance", Phone = "1669", Priority = 2 });
            offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "police", Type = "police", Name = "Police", Phone = "191", Priority = 3 });

            if (this.Shop is { Phone: { Length: > 0 } shopPhone })
            {
                offlinePackage.EmergencyContacts.Add(new OfflineEmergencyContact { Id = "shop", Type = "shop", Name = this.Shop.Name, Phone = shopPhone, Priority = 4 });
            }

            await this.OfflineDb.SaveRentalPackageAsync(offlinePackage);

            this.IsDownloaded = true;
            this.LastSyncAt = DateTimeOffset.Now;
            this.ShowSuccess("Rental saved for offline use!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MyRental] Error downloading for offline: {ex.Message}");
            this.ShowError("Failed to save for offline. Please try again.");
        }
        finally
        {
            this.Downloading = false;
            this.StateHasChanged();
        }
    }

    private string FormatLastSync()
    {
        if (!this.LastSyncAt.HasValue) return "Unknown";
        var diff = DateTimeOffset.Now - this.LastSyncAt.Value;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        return this.LastSyncAt.Value.ToString("MMM d");
    }
}
