@page "/tourist/{AccountNo}/browse"
@page "/tourist/{AccountNo}/browse/{SelectedShopId}"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inherits TouristComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Domain.Models
@using MotoRent.Services
@using MotoRent.Client.Components.Tourist
@using MotoRent.Client.Controls
@inject VehicleService VehicleService
@inject ShopService ShopService
@inject IJSRuntime JS

<PageTitle>Browse Motorbikes - @TenantName</PageTitle>

@* Hero Section - Uses tenant branding colors *@
<div class="tourist-hero py-5 mb-4">
    <div class="container-xl">
        <div class="d-flex flex-column align-items-center gap-2 text-center">
            @if (!string.IsNullOrEmpty(TenantLogo))
            {
                <img src="@TenantLogo" alt="@TenantName" style="max-height: 60px; margin-bottom: 0.5rem;" />
            }
            else
            {
                <i class="ti ti-motorbike fs-1"></i>
            }
            <h1 class="mb-0">Rent a Motorbike</h1>
            <p class="fs-5 mb-0" style="opacity: 0.9;">
                @if (!string.IsNullOrEmpty(TenantBranding.Tagline))
                {
                    @TenantBranding.Tagline
                }
                else
                {
                    <span>Explore Thailand on two wheels - Easy booking, great prices</span>
                }
            </p>
        </div>
    </div>
</div>

<div class="container-xl">
    @* Search and Filter Bar *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label">Rental Period</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="date" class="form-control" @bind="m_startDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" @bind="m_endDate" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Engine Size</label>
                    <select class="form-select" @bind="m_engineFilter">
                        <option value="">All Sizes</option>
                        <option value="110">110cc (Scooter)</option>
                        <option value="125">125cc (City)</option>
                        <option value="150">150cc+ (Sport)</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" @bind="m_sortBy">
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <button type="button" class="btn btn-primary w-100" @onclick="ApplyFilters">
                        <i class="ti ti-search me-1"></i>
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* Filter Chips *@
    <div class="d-flex flex-wrap gap-2 mb-3">
        <button type="button" class="btn @(string.IsNullOrEmpty(m_engineFilter) ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = ""; ApplyFilters(); })">
            All Bikes
        </button>
        <button type="button" class="btn @(m_engineFilter == "110" ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = "110"; ApplyFilters(); })">
            Scooter (110cc)
        </button>
        <button type="button" class="btn @(m_engineFilter == "125" ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = "125"; ApplyFilters(); })">
            City (125cc)
        </button>
        <button type="button" class="btn @(m_engineFilter == "150" ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = "150"; ApplyFilters(); })">
            Sport (150cc+)
        </button>
    </div>

    @* Results Summary *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            @if (m_loading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                <span>Loading...</span>
            }
            else
            {
                <span>@m_filteredGroups.Count vehicle models (@m_filteredGroups.Sum(g => g.AvailableUnits) available)</span>
            }
        </h4>
        <div class="d-flex align-items-center gap-2">
            @if (m_favorites.Count > 0)
            {
                <button type="button" class="btn btn-icon btn-ghost-danger position-relative" @onclick="ShowFavorites">
                    <i class="ti ti-heart-filled"></i>
                    <span class="badge bg-danger position-absolute" style="top: -4px; right: -4px;">@m_favorites.Count</span>
                </button>
            }
            <button type="button" class="btn btn-icon @(m_gridView ? "" : "btn-primary")"
                    @onclick="@(() => m_gridView = false)" title="List View">
                <i class="ti ti-list"></i>
            </button>
            <button type="button" class="btn btn-icon @(m_gridView ? "btn-primary" : "")"
                    @onclick="@(() => m_gridView = true)" title="Grid View">
                <i class="ti ti-grid-dots"></i>
            </button>
        </div>
    </div>

    @* Vehicle Groups Grid *@
    @if (m_loading)
    {
        <div class="row g-4">
            @for (int i = 0; i < 6; i++)
            {
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="card">
                        <div class="placeholder-glow">
                            <div class="placeholder w-100" style="height: 200px;"></div>
                        </div>
                        <div class="card-body">
                            <div class="placeholder-glow">
                                <span class="placeholder col-8"></span>
                                <span class="placeholder col-5 mt-2"></span>
                                <span class="placeholder col-10 mt-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (m_filteredGroups.Count == 0)
    {
        <div class="card bg-light">
            <div class="card-body py-5 text-center">
                <i class="ti ti-search-off fs-1 text-secondary mb-3"></i>
                <h4 class="text-secondary">No vehicles found</h4>
                <p class="text-secondary">Try adjusting your filters or dates</p>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var group in m_filteredGroups)
            {
                <div class="@(m_gridView ? "col-12 col-sm-6 col-md-4" : "col-12")">
                    <div class="card h-100 cursor-pointer tourist-bike-card" @onclick="@(() => ViewGroupDetails(group))">
                        <div class="card-img-top img-responsive img-responsive-16by9 position-relative"
                             style="background-image: url('@GetGroupImage(group)'); background-color: #f8fafc;">
                            @if (string.IsNullOrEmpty(group.ImagePath))
                            {
                                <div class="d-flex align-items-center justify-content-center h-100">
                                    <i class="ti @GetVehicleTypeIcon(group.VehicleType) text-secondary" style="font-size: 4rem; opacity: 0.3;"></i>
                                </div>
                            }
                            @* Availability Badge *@
                            <div class="position-absolute top-0 end-0 m-2">
                                @if (group.AvailableUnits == 0)
                                {
                                    <span class="badge bg-secondary">Sold Out</span>
                                }
                                else if (group.AvailableUnits == 1)
                                {
                                    <span class="badge bg-warning">Last one!</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">@group.AvailableUnits available</span>
                                }
                            </div>
                            @* Vehicle Type Badge *@
                            <div class="position-absolute top-0 start-0 m-2">
                                <span class="badge @GetVehicleTypeBadgeClass(group.VehicleType)">
                                    <i class="ti @GetVehicleTypeIcon(group.VehicleType) me-1"></i>
                                    @group.VehicleType
                                </span>
                            </div>
                            @* Favorite Button *@
                            <button type="button" class="btn btn-icon position-absolute bottom-0 end-0 m-2 @(m_favorites.Contains(group.GroupKey) ? "btn-danger" : "btn-ghost-light")"
                                    @onclick="@(() => ToggleFavorite(group.GroupKey))" @onclick:stopPropagation="true">
                                <i class="ti @(m_favorites.Contains(group.GroupKey) ? "ti-heart-filled" : "ti-heart")"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h3 class="card-title mb-1">@group.DisplayName</h3>
                            <div class="text-secondary mb-2">
                                @if (!string.IsNullOrEmpty(group.EngineDisplay))
                                {
                                    <span class="me-2">@group.EngineDisplay</span>
                                }
                                @if (group.Segment.HasValue)
                                {
                                    <span>@group.Segment</span>
                                }
                            </div>
                            @if (group.AvailableColors.Count > 0)
                            {
                                <div class="mb-2">
                                    <small class="text-secondary">Colors: @string.Join(", ", group.AvailableColors)</small>
                                </div>
                            }
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    @if (group.HasPriceRange)
                                    {
                                        <span class="h3 text-primary mb-0">@FormatCurrency(group.MinDailyRate)-@FormatCurrency(group.MaxDailyRate)</span>
                                    }
                                    else
                                    {
                                        <span class="h3 text-primary mb-0">@FormatCurrency(group.MinDailyRate)</span>
                                    }
                                    <span class="text-secondary">/day</span>
                                </div>
                                @if (group.AvailableUnits > 0)
                                {
                                    <button type="button" class="btn btn-primary" @onclick="@(() => StartReservation(group))" @onclick:stopPropagation="true">
                                        Reserve
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    @* Rental Info Section *@
    <div class="card bg-light mt-5">
        <div class="card-body p-4">
            <h4 class="mb-4">How It Works</h4>
            <div class="row g-4">
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column align-items-center gap-2 text-center">
                        <div class="avatar avatar-lg bg-primary">
                            <i class="ti ti-search text-white"></i>
                        </div>
                        <h5>1. Browse & Select</h5>
                        <p class="text-secondary mb-0">
                            Choose from our wide selection of well-maintained motorbikes
                        </p>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column align-items-center gap-2 text-center">
                        <div class="avatar avatar-lg bg-primary">
                            <i class="ti ti-calendar-event text-white"></i>
                        </div>
                        <h5>2. Reserve Online</h5>
                        <p class="text-secondary mb-0">
                            Pick your dates and complete the reservation in minutes
                        </p>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column align-items-center gap-2 text-center">
                        <div class="avatar avatar-lg bg-primary">
                            <i class="ti ti-motorbike text-white"></i>
                        </div>
                        <h5>3. Pick Up & Ride</h5>
                        <p class="text-secondary mb-0">
                            Visit our shop, show your ID, and start your adventure!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public new string AccountNo { get; set; } = "";
    [Parameter] public string? SelectedShopId { get; set; }

    private int? m_selectedShopId;
    private List<VehicleGroup> m_vehicleGroups = [];
    private List<VehicleGroup> m_filteredGroups = [];
    private bool m_loading = true;
    private bool m_gridView = true;
    private HashSet<string> m_favorites = [];  // Now stores group keys instead of IDs

    // Filters
    private DateTime? m_startDate = DateTime.Today;
    private DateTime? m_endDate = DateTime.Today.AddDays(3);
    private string? m_engineFilter;
    private string m_sortBy = "price-asc";

    protected override async Task OnInitializedAsync()
    {
        m_selectedShopId = string.IsNullOrEmpty(SelectedShopId) ? null : DecodeId(SelectedShopId);
        await this.LoadFavoritesAsync();
        await this.LoadVehicleGroups();
    }

    private async Task LoadFavoritesAsync()
    {
        try
        {
            // Use tenant-specific localStorage key
            var storageKey = $"motorent-favorites-{TenantAccountNo}";
            var favJson = await this.JS.InvokeAsync<string?>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(favJson))
            {
                var keys = System.Text.Json.JsonSerializer.Deserialize<string[]>(favJson);
                if (keys != null)
                    this.m_favorites = [.. keys];
            }
        }
        catch { /* Ignore localStorage errors */ }
    }

    private async Task SaveFavoritesAsync()
    {
        try
        {
            var storageKey = $"motorent-favorites-{TenantAccountNo}";
            var json = System.Text.Json.JsonSerializer.Serialize(this.m_favorites.ToArray());
            await this.JS.InvokeVoidAsync("localStorage.setItem", storageKey, json);
        }
        catch { /* Ignore localStorage errors */ }
    }

    private async Task ToggleFavorite(string groupKey)
    {
        if (this.m_favorites.Contains(groupKey))
            this.m_favorites.Remove(groupKey);
        else
            this.m_favorites.Add(groupKey);

        await this.SaveFavoritesAsync();
        this.StateHasChanged();
    }

    private void ShowFavorites()
    {
        // Filter to show only favorites
        if (this.m_favorites.Count > 0)
        {
            this.m_filteredGroups = this.m_vehicleGroups
                .Where(g => this.m_favorites.Contains(g.GroupKey))
                .ToList();
        }
    }

    private async Task LoadVehicleGroups()
    {
        this.m_loading = true;
        try
        {
            // Use SelectedShopId from URL if provided, otherwise use default ShopId
            var shopId = this.m_selectedShopId ?? this.ShopId;
            this.m_vehicleGroups = await this.VehicleService.GetAvailableVehicleGroupsForTouristAsync(shopId);
            this.ApplyFilters();
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading vehicles: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private void ApplyFilters()
    {
        var filtered = this.m_vehicleGroups.Where(g => g.AvailableUnits > 0).AsEnumerable();

        // Engine filter
        if (!string.IsNullOrEmpty(this.m_engineFilter))
        {
            filtered = this.m_engineFilter switch
            {
                "110" => filtered.Where(g => g.EngineCC.HasValue && g.EngineCC <= 110),
                "125" => filtered.Where(g => g.EngineCC.HasValue && g.EngineCC > 110 && g.EngineCC <= 125),
                "150" => filtered.Where(g => g.EngineCC.HasValue && g.EngineCC > 125),
                _ => filtered
            };
        }

        // Sorting
        filtered = this.m_sortBy switch
        {
            "price-asc" => filtered.OrderBy(g => g.MinDailyRate),
            "price-desc" => filtered.OrderByDescending(g => g.MinDailyRate),
            "popular" => filtered.OrderByDescending(g => g.TotalUnits), // Popular = more units
            _ => filtered
        };

        this.m_filteredGroups = filtered.ToList();
    }

    private void ViewGroupDetails(VehicleGroup group)
    {
        // Navigate to the vehicle group details page using URL-encoded group key
        var encodedKey = Uri.EscapeDataString(group.GroupKey);
        NavigationManager.NavigateTo(TenantUrl($"vehicle-model/{encodedKey}"));
    }

    private async Task StartReservation(VehicleGroup group)
    {
        var result = await this.DialogService
            .Create<ReservationDialog>("Make a Reservation")
            .WithParameter(x => x.VehicleGroup, group)
            .WithParameter(x => x.DateRange, new ReservationDialog.DateRangeSelection(this.m_startDate, this.m_endDate))
            .Medium()
            .ShowAndGetDataAsync<int?>();

        if (result.HasValue)
        {
            this.ShowSuccess("Reservation submitted successfully! We'll contact you shortly.");
            await this.LoadVehicleGroups(); // Refresh availability
        }
    }

    private static string GetVehicleTypeIcon(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "ti-motorbike",
        VehicleType.Car => "ti-car",
        VehicleType.JetSki => "ti-sailboat",
        VehicleType.Boat => "ti-ship",
        VehicleType.Van => "ti-bus",
        _ => "ti-car"
    };

    private static string GetVehicleTypeBadgeClass(VehicleType type) => type switch
    {
        VehicleType.Motorbike => "bg-indigo-lt text-indigo",
        VehicleType.Car => "bg-blue-lt text-blue",
        VehicleType.JetSki => "bg-cyan-lt text-cyan",
        VehicleType.Boat => "bg-azure-lt text-azure",
        VehicleType.Van => "bg-purple-lt text-purple",
        _ => "bg-secondary-lt text-secondary"
    };

    private static string GetGroupImage(VehicleGroup group)
    {
        if (!string.IsNullOrEmpty(group.ImagePath))
            return group.ImagePath;

        return group.VehicleType switch
        {
            VehicleType.Motorbike => "/images/vehicles/motorbike-placeholder.png",
            VehicleType.Car => "/images/vehicles/car-placeholder.png",
            VehicleType.JetSki => "/images/vehicles/jetski-placeholder.png",
            VehicleType.Boat => "/images/vehicles/boat-placeholder.png",
            VehicleType.Van => "/images/vehicles/van-placeholder.png",
            _ => "/images/vehicles/default-placeholder.png"
        };
    }
}
