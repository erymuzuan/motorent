@page "/tourist/{AccountNo}/browse"
@page "/tourist/{AccountNo}/browse/{SelectedShopId:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inherits TouristComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Services
@using MotoRent.Client.Components.Tourist
@using MotoRent.Client.Controls
@inject MotorbikeService MotorbikeService
@inject ShopService ShopService
@inject IJSRuntime JS

<PageTitle>Browse Motorbikes - @TenantName</PageTitle>

@* Hero Section - Uses tenant branding colors *@
<div class="tourist-hero py-5 mb-4">
    <div class="container-xl">
        <div class="d-flex flex-column align-items-center gap-2 text-center">
            @if (!string.IsNullOrEmpty(TenantLogo))
            {
                <img src="@TenantLogo" alt="@TenantName" style="max-height: 60px; margin-bottom: 0.5rem;" />
            }
            else
            {
                <i class="ti ti-motorbike fs-1"></i>
            }
            <h1 class="mb-0">Rent a Motorbike</h1>
            <p class="fs-5 mb-0" style="opacity: 0.9;">
                @if (!string.IsNullOrEmpty(TenantBranding.Tagline))
                {
                    @TenantBranding.Tagline
                }
                else
                {
                    <span>Explore Thailand on two wheels - Easy booking, great prices</span>
                }
            </p>
        </div>
    </div>
</div>

<div class="container-xl">
    @* Search and Filter Bar *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label">Rental Period</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="date" class="form-control" @bind="m_startDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" @bind="m_endDate" />
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Engine Size</label>
                    <select class="form-select" @bind="m_engineFilter">
                        <option value="">All Sizes</option>
                        <option value="110">110cc (Scooter)</option>
                        <option value="125">125cc (City)</option>
                        <option value="150">150cc+ (Sport)</option>
                    </select>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" @bind="m_sortBy">
                        <option value="price-asc">Price: Low to High</option>
                        <option value="price-desc">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <button type="button" class="btn btn-primary w-100" @onclick="ApplyFilters">
                        <i class="ti ti-search me-1"></i>
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* Filter Chips *@
    <div class="d-flex flex-wrap gap-2 mb-3">
        <button type="button" class="btn @(string.IsNullOrEmpty(m_engineFilter) ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = ""; ApplyFilters(); })">
            All Bikes
        </button>
        <button type="button" class="btn @(m_engineFilter == "110" ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = "110"; ApplyFilters(); })">
            Scooter (110cc)
        </button>
        <button type="button" class="btn @(m_engineFilter == "125" ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = "125"; ApplyFilters(); })">
            City (125cc)
        </button>
        <button type="button" class="btn @(m_engineFilter == "150" ? "btn-primary" : "btn-outline-primary") btn-sm"
                @onclick="@(() => { m_engineFilter = "150"; ApplyFilters(); })">
            Sport (150cc+)
        </button>
    </div>

    @* Results Summary *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">
            @if (m_loading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                <span>Loading...</span>
            }
            else
            {
                <span>@m_filteredMotorbikes.Count available motorbikes</span>
            }
        </h4>
        <div class="d-flex align-items-center gap-2">
            @if (m_favorites.Count > 0)
            {
                <button type="button" class="btn btn-icon btn-ghost-danger position-relative" @onclick="ShowFavorites">
                    <i class="ti ti-heart-filled"></i>
                    <span class="badge bg-danger position-absolute" style="top: -4px; right: -4px;">@m_favorites.Count</span>
                </button>
            }
            <button type="button" class="btn btn-icon @(m_gridView ? "" : "btn-primary")"
                    @onclick="@(() => m_gridView = false)" title="List View">
                <i class="ti ti-list"></i>
            </button>
            <button type="button" class="btn btn-icon @(m_gridView ? "btn-primary" : "")"
                    @onclick="@(() => m_gridView = true)" title="Grid View">
                <i class="ti ti-grid-dots"></i>
            </button>
        </div>
    </div>

    @* Motorbike Cards Grid *@
    @if (m_loading)
    {
        <div class="row g-4">
            @for (int i = 0; i < 6; i++)
            {
                <div class="col-12 col-sm-6 col-md-4">
                    <div class="card">
                        <div class="placeholder-glow">
                            <div class="placeholder w-100" style="height: 200px;"></div>
                        </div>
                        <div class="card-body">
                            <div class="placeholder-glow">
                                <span class="placeholder col-8"></span>
                                <span class="placeholder col-5 mt-2"></span>
                                <span class="placeholder col-10 mt-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else if (m_filteredMotorbikes.Count == 0)
    {
        <div class="card bg-light">
            <div class="card-body py-5 text-center">
                <i class="ti ti-search-off fs-1 text-secondary mb-3"></i>
                <h4 class="text-secondary">No motorbikes found</h4>
                <p class="text-secondary">Try adjusting your filters or dates</p>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var bike in m_filteredMotorbikes)
            {
                <div class="@(m_gridView ? "col-12 col-sm-6 col-md-4" : "col-12")">
                    <BikeCard Motorbike="@bike"
                              IsFavorite="@m_favorites.Contains(bike.MotorbikeId)"
                              Compact="@(!m_gridView)"
                              OnDetailsClick="@(() => ViewDetails(bike))"
                              OnReserveClick="@(() => StartReservation(bike))"
                              OnFavoriteChanged="@(isFav => ToggleFavorite(bike.MotorbikeId, isFav))" />
                </div>
            }
        </div>
    }

    @* Rental Info Section *@
    <div class="card bg-light mt-5">
        <div class="card-body p-4">
            <h4 class="mb-4">How It Works</h4>
            <div class="row g-4">
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column align-items-center gap-2 text-center">
                        <div class="avatar avatar-lg bg-primary">
                            <i class="ti ti-search text-white"></i>
                        </div>
                        <h5>1. Browse & Select</h5>
                        <p class="text-secondary mb-0">
                            Choose from our wide selection of well-maintained motorbikes
                        </p>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column align-items-center gap-2 text-center">
                        <div class="avatar avatar-lg bg-primary">
                            <i class="ti ti-calendar-event text-white"></i>
                        </div>
                        <h5>2. Reserve Online</h5>
                        <p class="text-secondary mb-0">
                            Pick your dates and complete the reservation in minutes
                        </p>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column align-items-center gap-2 text-center">
                        <div class="avatar avatar-lg bg-primary">
                            <i class="ti ti-motorbike text-white"></i>
                        </div>
                        <h5>3. Pick Up & Ride</h5>
                        <p class="text-secondary mb-0">
                            Visit our shop, show your ID, and start your adventure!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public new string AccountNo { get; set; } = "";
    [Parameter] public int? SelectedShopId { get; set; }

    private List<Motorbike> m_motorbikes = [];
    private List<Motorbike> m_filteredMotorbikes = [];
    private bool m_loading = true;
    private bool m_gridView = true;
    private HashSet<int> m_favorites = [];

    // Filters
    private DateTime? m_startDate = DateTime.Today;
    private DateTime? m_endDate = DateTime.Today.AddDays(3);
    private string? m_engineFilter;
    private string m_sortBy = "price-asc";

    protected override async Task OnInitializedAsync()
    {
        await this.LoadFavoritesAsync();
        await this.LoadMotorbikes();
    }

    private async Task LoadFavoritesAsync()
    {
        try
        {
            // Use tenant-specific localStorage key
            var storageKey = $"motorent-favorites-{TenantAccountNo}";
            var favJson = await this.JS.InvokeAsync<string?>("localStorage.getItem", storageKey);
            if (!string.IsNullOrEmpty(favJson))
            {
                var ids = System.Text.Json.JsonSerializer.Deserialize<int[]>(favJson);
                if (ids != null)
                    this.m_favorites = [.. ids];
            }
        }
        catch { /* Ignore localStorage errors */ }
    }

    private async Task SaveFavoritesAsync()
    {
        try
        {
            var storageKey = $"motorent-favorites-{TenantAccountNo}";
            var json = System.Text.Json.JsonSerializer.Serialize(this.m_favorites.ToArray());
            await this.JS.InvokeVoidAsync("localStorage.setItem", storageKey, json);
        }
        catch { /* Ignore localStorage errors */ }
    }

    private async Task ToggleFavorite(int motorbikeId, bool isFavorite)
    {
        if (isFavorite)
            this.m_favorites.Add(motorbikeId);
        else
            this.m_favorites.Remove(motorbikeId);

        await this.SaveFavoritesAsync();
        this.StateHasChanged();
    }

    private void ShowFavorites()
    {
        // Filter to show only favorites
        if (this.m_favorites.Count > 0)
        {
            this.m_filteredMotorbikes = this.m_motorbikes
                .Where(m => this.m_favorites.Contains(m.MotorbikeId))
                .ToList();
        }
    }

    private async Task LoadMotorbikes()
    {
        this.m_loading = true;
        try
        {
            // Use SelectedShopId from URL if provided, otherwise use default ShopId
            var shopId = this.SelectedShopId ?? this.ShopId;
            var result = await this.MotorbikeService.GetAvailableMotorbikesAsync(shopId);
            this.m_motorbikes = result.ToList();
            this.ApplyFilters();
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading motorbikes: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private void ApplyFilters()
    {
        var filtered = this.m_motorbikes.Where(m => m.Status == "Available").AsEnumerable();

        // Engine filter
        if (!string.IsNullOrEmpty(this.m_engineFilter))
        {
            filtered = this.m_engineFilter switch
            {
                "110" => filtered.Where(m => m.EngineCC <= 110),
                "125" => filtered.Where(m => m.EngineCC > 110 && m.EngineCC <= 125),
                "150" => filtered.Where(m => m.EngineCC > 125),
                _ => filtered
            };
        }

        // Sorting
        filtered = this.m_sortBy switch
        {
            "price-asc" => filtered.OrderBy(m => m.DailyRate),
            "price-desc" => filtered.OrderByDescending(m => m.DailyRate),
            "popular" => filtered.OrderByDescending(m => m.EngineCC), // Placeholder
            _ => filtered
        };

        this.m_filteredMotorbikes = filtered.ToList();
    }

    private void ViewDetails(Motorbike bike)
    {
        // Navigate to the vehicle details page
        NavigationManager.NavigateTo(TenantUrl($"vehicle/{bike.MotorbikeId}"));
    }

    private async Task StartReservation(Motorbike bike)
    {
        var result = await this.DialogService
            .Create<ReservationDialog>("Make a Reservation")
            .WithParameter(x => x.Motorbike, bike)
            .WithParameter(x => x.DateRange, new ReservationDialog.DateRangeSelection(this.m_startDate, this.m_endDate))
            .Medium()
            .ShowAndGetDataAsync<int?>();

        if (result.HasValue)
        {
            this.ShowSuccess("Reservation submitted successfully! We'll contact you shortly.");
            await this.LoadMotorbikes(); // Refresh availability
        }
    }
}
