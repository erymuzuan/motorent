@page "/my-rentals"
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]
@inherits MotoRentComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Services
@inject RentalService RentalService
@inject IJSRuntime JS

<PageTitle>My Rentals - MotoRent</PageTitle>

<div class="container-xl py-4">
    <div class="d-flex flex-column gap-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h2 class="mb-1">My Rentals</h2>
                <p class="text-secondary mb-0">View your rental history and current reservations</p>
            </div>
            <a href="/browse" class="btn btn-outline-primary">
                <i class="ti ti-motorbike me-1"></i>
                Browse Motorbikes
            </a>
        </div>

        @if (!m_isVerified)
        {
            @* Verification Form *@
            <div class="card">
                <div class="card-body p-4">
                    <div class="d-flex flex-column align-items-center gap-4">
                        <i class="ti ti-shield-check text-primary fs-1"></i>
                        <h4>Verify Your Identity</h4>
                        <p class="text-secondary text-center">
                            Enter your email or phone number to view your rental history
                        </p>

                        <div class="w-100" style="max-width: 400px;">
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" @bind="m_email"
                                       placeholder="your.email@example.com" />
                            </div>

                            <div class="d-flex align-items-center gap-2 my-3">
                                <hr class="flex-fill" />
                                <span class="text-secondary px-2">OR</span>
                                <hr class="flex-fill" />
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" @bind="m_phone"
                                       placeholder="+66 XX XXX XXXX" />
                            </div>

                            <button type="button" class="btn btn-primary w-100"
                                    @onclick="SearchRentals"
                                    disabled="@(string.IsNullOrWhiteSpace(m_email) && string.IsNullOrWhiteSpace(m_phone))">
                                @if (m_searching)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                View My Rentals
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            @* Rental History *@
            <div class="d-flex justify-content-between align-items-center">
                <span>Showing rentals for: <strong>@(m_email ?? m_phone)</strong></span>
                <button type="button" class="btn btn-ghost-secondary" @onclick="ResetSearch">
                    <i class="ti ti-logout me-1"></i>
                    Search Different Account
                </button>
            </div>

            @if (m_rentals.Count == 0)
            {
                <div class="card bg-light">
                    <div class="card-body py-5 text-center">
                        <i class="ti ti-history fs-1 text-secondary mb-3"></i>
                        <h4 class="text-secondary">No rentals found</h4>
                        <p class="text-secondary mb-4">
                            You haven't made any rentals yet. Start exploring our motorbikes!
                        </p>
                        <a href="/browse" class="btn btn-primary">Browse Motorbikes</a>
                    </div>
                </div>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var rental in m_rentals)
                    {
                        <div class="col-12 col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-start w-100">
                                        <div>
                                            <h4 class="card-title mb-0">Rental #@rental.RentalId</h4>
                                            <small class="text-secondary">
                                                @FormatDate(rental.StartDate.DateTime) - @FormatDate(rental.ExpectedEndDate.DateTime)
                                            </small>
                                        </div>
                                        <span class="badge @GetStatusBadgeClass(rental.Status)">@rental.Status</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-secondary">Daily Rate</span>
                                            <span>@FormatCurrency(rental.DailyRate)</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-secondary">Total Amount</span>
                                            <strong class="text-primary">@FormatCurrency(rental.TotalAmount)</strong>
                                        </div>
                                        @if (!string.IsNullOrEmpty(rental.Notes))
                                        {
                                            <hr class="my-1" />
                                            <small class="text-secondary">@rental.Notes</small>
                                        }

                                        @* QR Code for Active Rentals *@
                                        @if (rental.Status is "Active" or "Reserved")
                                        {
                                            <hr class="my-1" />
                                            <div class="d-flex flex-column align-items-center gap-1">
                                                <button type="button" class="btn btn-outline-primary btn-sm"
                                                        @onclick="@(() => ShowQRCode(rental))">
                                                    <i class="ti ti-qrcode me-1"></i>
                                                    Show QR Code
                                                </button>
                                                <small class="text-secondary">Show this to staff at pickup/return</small>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="card-footer">
                                    @if (rental.Status == "Active")
                                    {
                                        <button type="button" class="btn btn-ghost-primary btn-sm"
                                                @onclick="@(() => ExtendRental(rental))">
                                            <i class="ti ti-plus me-1"></i>
                                            Extend Rental
                                        </button>
                                        <button type="button" class="btn btn-ghost-warning btn-sm"
                                                @onclick="@(() => ReportIssue(rental))">
                                            <i class="ti ti-alert-triangle me-1"></i>
                                            Report Issue
                                        </button>
                                    }
                                    else if (rental.Status == "Reserved")
                                    {
                                        <div class="d-flex justify-content-end w-100">
                                            <button type="button" class="btn btn-ghost-danger btn-sm"
                                                    @onclick="@(() => CancelReservation(rental))">
                                                Cancel Reservation
                                            </button>
                                        </div>
                                    }
                                    else if (rental.Status == "Completed")
                                    {
                                        <button type="button" class="btn btn-ghost-primary btn-sm"
                                                @onclick="@(() => DownloadReceipt(rental))">
                                            <i class="ti ti-download me-1"></i>
                                            Download Receipt
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }

        @* FAQ Section *@
        <div class="card bg-light mt-4">
            <div class="card-body p-4">
                <h4 class="mb-4">Frequently Asked Questions</h4>
                <div class="accordion" id="faq-accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#faq-1">
                                How do I pick up my motorbike?
                            </button>
                        </h2>
                        <div id="faq-1" class="accordion-collapse collapse" data-bs-parent="#faq-accordion">
                            <div class="accordion-body text-secondary">
                                Visit our shop at least 30 minutes before your rental start time with your passport and payment.
                                Our staff will verify your documents and complete the check-in process.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#faq-2">
                                Can I extend my rental?
                            </button>
                        </h2>
                        <div id="faq-2" class="accordion-collapse collapse" data-bs-parent="#faq-accordion">
                            <div class="accordion-body text-secondary">
                                Yes! Contact us via phone or WhatsApp, or visit the shop to extend your rental period.
                                Extensions are subject to availability.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#faq-3">
                                What happens if I return late?
                            </button>
                        </h2>
                        <div id="faq-3" class="accordion-collapse collapse" data-bs-parent="#faq-accordion">
                            <div class="accordion-body text-secondary">
                                Late returns are charged at the daily rate for each additional day.
                                Please notify us if you'll be late to avoid any issues.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#faq-4">
                                How do I get my deposit back?
                            </button>
                        </h2>
                        <div id="faq-4" class="accordion-collapse collapse" data-bs-parent="#faq-accordion">
                            <div class="accordion-body text-secondary">
                                Your security deposit will be refunded upon successful return of the motorbike in good condition.
                                Cash deposits are refunded immediately; card refunds may take 3-5 business days.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool m_isVerified;
    private bool m_searching;
    private string? m_email;
    private string? m_phone;
    private List<Rental> m_rentals = [];

    private async Task SearchRentals()
    {
        if (string.IsNullOrWhiteSpace(this.m_email) && string.IsNullOrWhiteSpace(this.m_phone))
            return;

        this.m_searching = true;
        try
        {
            this.m_rentals = await this.RentalService.GetRentalHistoryForTouristAsync(this.ShopId, this.m_email, this.m_phone);
            this.m_isVerified = true;
        }
        catch (Exception ex)
        {
            this.ShowError($"Error searching rentals: {ex.Message}");
        }
        finally
        {
            this.m_searching = false;
        }
    }

    private void ResetSearch()
    {
        this.m_isVerified = false;
        this.m_email = null;
        this.m_phone = null;
        this.m_rentals.Clear();
    }

    private async Task CancelReservation(Rental rental)
    {
        if (!await this.DialogService.ConfirmYesNoAsync(
            "Are you sure you want to cancel this reservation?",
            "Cancel Reservation"))
            return;

        try
        {
            var result = await this.RentalService.CancelRentalAsync(rental.RentalId, "Cancelled by customer", "tourist");
            if (result.Success)
            {
                this.ShowSuccess("Reservation cancelled successfully");
                await this.SearchRentals(); // Refresh
            }
            else
            {
                this.ShowError(result.Message ?? "Failed to cancel reservation");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error: {ex.Message}");
        }
    }

    private static string GetStatusBadgeClass(string? status) => status switch
    {
        "Reserved" => "bg-info",
        "Active" => "bg-success",
        "Completed" => "bg-secondary",
        "Cancelled" => "bg-danger",
        _ => "bg-secondary"
    };

    private async Task ShowQRCode(Rental rental)
    {
        // Generate QR code URL (using a free QR code API)
        var qrData = $"MOTORENT-{rental.RentalId}-{rental.WebId}";
        var qrUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=300x300&data={Uri.EscapeDataString(qrData)}";

        await this.DialogService
            .Create<QRCodeDialog>($"Rental #{rental.RentalId}")
            .WithParameter(x => x.QRCodeUrl, qrUrl)
            .WithParameter(x => x.RentalId, rental.RentalId)
            .WithParameter(x => x.Status, rental.Status ?? "Unknown")
            .Small()
            .ShowDialogAsync();
    }

    private async Task ExtendRental(Rental rental)
    {
        var result = await this.DialogService.ConfirmYesNoAsync(
            $"To extend your rental, please contact us:\n\n" +
            $"Phone: +66 76 123 4567\n" +
            $"Line: @motorent\n\n" +
            $"Have your rental number ready: #{rental.RentalId}\n\n" +
            $"Click Yes to call now.",
            "Extend Rental");

        if (result)
        {
            await this.JS.InvokeVoidAsync("open", "tel:+6676123456", "_self");
        }
    }

    private async Task ReportIssue(Rental rental)
    {
        var result = await this.DialogService.ConfirmYesNoAsync(
            $"For emergencies or issues, please contact us immediately:\n\n" +
            $"Emergency: +66 76 123 4567\n" +
            $"Line: @motorent\n\n" +
            $"Reference: Rental #{rental.RentalId}\n\n" +
            $"Click Yes to call now.",
            "Report an Issue");

        if (result)
        {
            await this.JS.InvokeVoidAsync("open", "tel:+6676123456", "_self");
        }
    }

    private async Task DownloadReceipt(Rental rental)
    {
        this.ShowInfo($"Receipt download for Rental #{rental.RentalId} - Feature coming soon!");
        await Task.CompletedTask;
    }
}
