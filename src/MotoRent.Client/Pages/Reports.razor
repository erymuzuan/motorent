@page "/reports"
@rendermode InteractiveServer
@inherits MotoRentComponentBase
@using MotoRent.Domain.Entities
@using MotoRent.Services
@inject PaymentService PaymentService
@inject RentalService RentalService

<PageTitle>Reports - MotoRent</PageTitle>

<h4 class="mb-4">Reports</h4>

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-12 col-md-4">
                <label class="form-label">Report Type</label>
                <select class="form-select" @bind="m_reportType" @bind:after="LoadReportAsync">
                    <option value="daily">Daily Summary</option>
                    <option value="weekly">Weekly Summary</option>
                    <option value="monthly">Monthly Summary</option>
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Report Date</label>
                <input type="date" class="form-control"
                       @bind="m_reportDate" @bind:after="LoadReportAsync" />
            </div>
            <div class="col-12 col-md-4">
                <button type="button" class="btn btn-primary" @onclick="LoadReportAsync">
                    <i class="ti ti-refresh me-2"></i>
                    Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

@if (m_loading)
{
    <div class="progress progress-sm mb-4">
        <div class="progress-bar progress-bar-indeterminate"></div>
    </div>
}

@* Summary Cards *@
<div class="row mb-4 g-3">
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-column">
                    <small class="text-secondary">Total Revenue</small>
                    <span class="h4 text-success mb-0">@FormatCurrency(m_totalRevenue)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-column">
                    <small class="text-secondary">Total Rentals</small>
                    <span class="h4 text-primary mb-0">@m_totalRentals</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-column">
                    <small class="text-secondary">Active Rentals</small>
                    <span class="h4 text-info mb-0">@m_activeRentals</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-column">
                    <small class="text-secondary">Completed</small>
                    <span class="h4 mb-0">@m_completedRentals</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    @* Revenue by Payment Method *@
    <div class="col-12 col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Revenue by Payment Method</h6>
            </div>
            <div class="card-body">
                @if (m_revenueByMethod.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-vcenter table-striped">
                            <thead>
                                <tr>
                                    <th>Method</th>
                                    <th class="text-end">Amount</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in m_revenueByMethod)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="@GetPaymentMethodIcon(item.Key)"></i>
                                                @item.Key
                                            </div>
                                        </td>
                                        <td class="text-end">@FormatCurrency(item.Value)</td>
                                        <td class="text-end">@(m_totalRevenue > 0 ? (item.Value / m_totalRevenue * 100).ToString("F1") : "0")%</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-secondary mb-0">No payment data for this period</p>
                }
            </div>
        </div>
    </div>

    @* Rental Status Summary *@
    <div class="col-12 col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Rental Status</h6>
            </div>
            <div class="card-body">
                @if (m_rentalsByStatus.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-vcenter table-striped">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th class="text-end">Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in m_rentalsByStatus)
                                {
                                    <tr>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(item.Key)">
                                                @item.Key
                                            </span>
                                        </td>
                                        <td class="text-end">@item.Value</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-secondary mb-0">No rental data for this period</p>
                }
            </div>
        </div>
    </div>

    @* Daily Revenue Breakdown *@
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">@GetPeriodTitle() Revenue</h6>
            </div>
            <div class="card-body">
                @if (m_dailyRevenue.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-vcenter table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th class="text-end">Revenue</th>
                                    <th style="width: 40%;">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var maxRevenue = m_dailyRevenue.Values.DefaultIfEmpty(1).Max();
                                }
                                @foreach (var item in m_dailyRevenue.OrderByDescending(x => x.Key))
                                {
                                    <tr>
                                        <td>@item.Key</td>
                                        <td class="text-end">@FormatCurrency(item.Value)</td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar bg-primary"
                                                     style="width: @(maxRevenue > 0 ? (item.Value / maxRevenue * 100).ToString("F0") : "0")%">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-secondary mb-0">No revenue data for this period</p>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private bool m_loading = true;
    private string m_reportType = "daily";
    private DateTime m_reportDate = DateTime.Today;

    // Summary metrics
    private decimal m_totalRevenue;
    private int m_totalRentals;
    private int m_activeRentals;
    private int m_completedRentals;

    // Breakdown data
    private Dictionary<string, decimal> m_revenueByMethod = new();
    private Dictionary<string, int> m_rentalsByStatus = new();
    private Dictionary<string, decimal> m_dailyRevenue = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadReportAsync();
    }

    private async Task LoadReportAsync()
    {
        this.m_loading = true;
        try
        {
            var (fromDate, toDate) = GetDateRange();

            // Load payment summary
            var paymentSummary = await this.PaymentService.GetPaymentSummaryAsync(this.ShopId, fromDate, toDate);
            this.m_totalRevenue = paymentSummary.TotalAmount;
            this.m_revenueByMethod = paymentSummary.ByPaymentMethod;

            // Load daily revenue
            this.m_dailyRevenue = await this.PaymentService.GetDailyRevenueAsync(this.ShopId, fromDate, toDate);

            // Load rental stats
            this.m_rentalsByStatus = await this.RentalService.GetStatusCountsAsync(this.ShopId);
            this.m_totalRentals = this.m_rentalsByStatus.Values.Sum();
            this.m_activeRentals = this.m_rentalsByStatus.GetValueOrDefault("Active", 0);
            this.m_completedRentals = this.m_rentalsByStatus.GetValueOrDefault("Completed", 0);
        }
        catch (Exception ex)
        {
            this.ShowError($"Error loading report: {ex.Message}");
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private (DateTimeOffset fromDate, DateTimeOffset toDate) GetDateRange()
    {
        var baseDate = this.m_reportDate;

        return this.m_reportType switch
        {
            "daily" => (
                new DateTimeOffset(baseDate.Date),
                new DateTimeOffset(baseDate.Date.AddDays(1).AddSeconds(-1))
            ),
            "weekly" => (
                new DateTimeOffset(baseDate.Date.AddDays(-(int)baseDate.DayOfWeek)),
                new DateTimeOffset(baseDate.Date.AddDays(7 - (int)baseDate.DayOfWeek).AddSeconds(-1))
            ),
            "monthly" => (
                new DateTimeOffset(new DateTime(baseDate.Year, baseDate.Month, 1)),
                new DateTimeOffset(new DateTime(baseDate.Year, baseDate.Month, 1).AddMonths(1).AddSeconds(-1))
            ),
            _ => (
                new DateTimeOffset(baseDate.Date),
                new DateTimeOffset(baseDate.Date.AddDays(1).AddSeconds(-1))
            )
        };
    }

    private string GetPeriodTitle() => this.m_reportType switch
    {
        "daily" => "Hourly",
        "weekly" => "Daily",
        "monthly" => "Daily",
        _ => "Daily"
    };

    private static string GetStatusBadgeClass(string? status) => status switch
    {
        "Active" => "bg-primary",
        "Completed" => "bg-success",
        "Cancelled" => "bg-danger",
        "Reserved" => "bg-info",
        _ => "bg-secondary"
    };

    private static string GetPaymentMethodIcon(string? method) => method switch
    {
        "Cash" => "ti ti-cash",
        "Card" => "ti ti-credit-card",
        "PromptPay" => "ti ti-qrcode",
        "BankTransfer" => "ti ti-building-bank",
        _ => "ti ti-wallet"
    };
}
