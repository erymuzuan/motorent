@page "/payments"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<Payments>
@inject PaymentService PaymentService
@inject RentalService RentalService

<MotoRentPageTitle>@Localizer["Payments"]</MotoRentPageTitle>

<TablerHeader Title="@Localizer["Payments"]" PreTitle="@Localizer["Finance"]">
    <button type="button" class="btn btn-primary" @onclick="OpenAddPaymentDialog">
        <i class="ti ti-plus me-1"></i>
        @Localizer["RecordPayment"]
    </button>
</TablerHeader>

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <select class="form-select" @bind="m_statusFilter" @bind:after="FilterChanged">
                    <option value="">@Localizer["AllStatus"]</option>
                    <option value="Completed">@Localizer["Completed"]</option>
                    <option value="Pending">@Localizer["Pending"]</option>
                    <option value="Refunded">@Localizer["Refunded"]</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="m_paymentMethodFilter" @bind:after="FilterChanged">
                    <option value="">@Localizer["AllMethods"]</option>
                    <option value="Cash">@Localizer["Cash"]</option>
                    <option value="Card">@Localizer["Card"]</option>
                    <option value="PromptPay">@Localizer["PromptPay"]</option>
                    <option value="BankTransfer">@Localizer["BankTransfer"]</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" @bind="m_fromDate" @bind:after="FilterChanged" />
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" @bind="m_toDate" @bind:after="FilterChanged" />
            </div>
        </div>
    </div>
</div>

<div class="row row-deck row-cards mb-3">
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["TotalPayments"]</div>
                <div class="h2 text-primary">@FormatCurrency(m_totalAmount)</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["Cash"]</div>
                <div class="h4">@FormatCurrency(m_cashAmount)</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["Card"]</div>
                <div class="h4">@FormatCurrency(m_cardAmount)</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="subheader">@Localizer["PromptPayTransfer"]</div>
                <div class="h4">@FormatCurrency(m_otherAmount)</div>
            </div>
        </div>
    </div>
</div>

<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table" Rows="10" Columns="8">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table table-striped">
                <thead>
                    <tr>
                        <th>@Localizer["ID"]</th>
                        <th>@Localizer["Rental"]</th>
                        <th>@Localizer["Type"]</th>
                        <th>@Localizer["Method"]</th>
                        <th>@Localizer["Amount"]</th>
                        <th>@Localizer["Status"]</th>
                        <th>@Localizer["Date"]</th>
                        <th>@Localizer["Reference"]</th>
                        <th class="w-1">@Localizer["Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @if (m_payments.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center text-secondary py-4">
                                <i class="ti ti-credit-card mb-2" style="font-size: 2rem;"></i>
                                <div>@Localizer["NoPaymentsFound"]</div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" @onclick="OpenAddPaymentDialog">
                                    @Localizer["RecordPayment"]
                                </button>
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in m_payments)
                        {
                            <tr>
                                <td>@item.Payment.PaymentId</td>
                                <td>
                                    <a href="/rentals/view/@EncodeId(item.Payment.RentalId)">#@item.Payment.RentalId</a>
                                </td>
                                <td>
                                    <span class="badge @GetPaymentTypeBadgeClass(item.Payment.PaymentType)">
                                        @Localizer[item.Payment.PaymentType ?? ""]
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <i class="@GetPaymentMethodIcon(item.Payment.PaymentMethod)"></i>
                                        @Localizer[item.Payment.PaymentMethod ?? ""]
                                    </div>
                                </td>
                                <td class="@(item.Payment.PaymentType == "Refund" ? "text-danger" : "text-primary") fw-bold">
                                    @(item.Payment.PaymentType == "Refund" ? "-" : "")@FormatCurrency(item.Payment.Amount)
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(item.Payment.Status)">
                                        @Localizer[item.Payment.Status ?? ""]
                                    </span>
                                </td>
                                <td>
                                    <div>@FormatDate(item.Payment.PaidOn)</div>
                                    <small class="text-secondary">@item.Payment.PaidOn.ToString("HH:mm")</small>
                                </td>
                                <td>@item.Payment.TransactionRef</td>
                                <td>
                                    <div class="btn-list flex-nowrap">
                                        <button type="button" class="btn btn-icon btn-ghost-primary" title="@Localizer["View"]"
                                                @onclick="@(() => ViewPayment(item.Payment))">
                                            <i class="ti ti-eye"></i>
                                        </button>
                                        @if (item.Payment.Status == "Completed" && item.Payment.PaymentType != "Refund")
                                        {
                                            <button type="button" class="btn btn-icon btn-ghost-warning" title="@Localizer["Refund"]"
                                                    @onclick="@(() => RefundPayment(item.Payment))">
                                                <i class="ti ti-arrow-back-up"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</LoadingSkeleton>

@code {
    private List<PaymentViewModel> m_payments = [];
    private bool m_loading = true;
    private string? m_statusFilter;
    private string? m_paymentMethodFilter;
    private DateTime? m_fromDate;
    private DateTime? m_toDate;

    private decimal m_totalAmount;
    private decimal m_cashAmount;
    private decimal m_cardAmount;
    private decimal m_otherAmount;

    protected override async Task OnInitializedAsync()
    {
        this.m_fromDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        this.m_toDate = DateTime.Today;
        await this.LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        this.m_loading = true;
        try
        {
            var fromDateOffset = this.m_fromDate.HasValue ? new DateTimeOffset(this.m_fromDate.Value) : (DateTimeOffset?)null;
            var toDateOffset = this.m_toDate.HasValue ? new DateTimeOffset(this.m_toDate.Value.AddDays(1).AddSeconds(-1)) : (DateTimeOffset?)null;

            var result = await this.PaymentService.GetPaymentsAsync(
                0,
                status: this.m_statusFilter,
                paymentMethod: this.m_paymentMethodFilter,
                fromDate: fromDateOffset,
                toDate: toDateOffset,
                pageSize: 500);

            this.m_payments = result.ItemCollection
                .Select(p => new PaymentViewModel { Payment = p })
                .ToList();

            var completedPayments = result.ItemCollection.Where(p => p.Status == "Completed").ToList();
            this.m_totalAmount = completedPayments.Sum(p => p.PaymentType == "Refund" ? -p.Amount : p.Amount);
            this.m_cashAmount = completedPayments.Where(p => p.PaymentMethod == "Cash").Sum(p => p.Amount);
            this.m_cardAmount = completedPayments.Where(p => p.PaymentMethod == "Card").Sum(p => p.Amount);
            this.m_otherAmount = completedPayments.Where(p => p.PaymentMethod is "PromptPay" or "BankTransfer").Sum(p => p.Amount);
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoadingPayments", ex.Message]);
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task FilterChanged()
    {
        await this.LoadDataAsync();
    }

    private async Task OpenAddPaymentDialog()
    {
        var payment = new Payment
        {
            PaymentType = "Rental",
            PaymentMethod = "Cash",
            Status = "Completed",
            PaidOn = DateTimeOffset.Now
        };

        var result = await this.DialogService
            .Create<PaymentDialog>(Localizer["RecordPayment"])
            .WithParameter(x => x.Entity, payment)
            .WithParameter(x => x.IsNew, true)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(Localizer["PaymentRecorded"]);
        }
    }

    private async Task ViewPayment(Payment payment)
    {
        await this.DialogService
            .Create<PaymentDialog>(Localizer["PaymentDetails"])
            .WithParameter(x => x.Entity, payment.Clone())
            .WithParameter(x => x.IsNew, false)
            .ShowDialogAsync();

        await this.LoadDataAsync();
    }

    private async Task RefundPayment(Payment payment)
    {
        if (!await this.DialogService.ConfirmYesNoAsync(
            Localizer["ConfirmRefundMessage", FormatCurrency(payment.Amount)],
            Localizer["ConfirmRefund"]))
            return;

        var result = await this.PaymentService.RefundPaymentAsync(payment.PaymentId, "Manual refund", this.UserName);
        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(Localizer["PaymentRefunded"]);
        }
        else
        {
            this.ShowError(Localizer["RefundFailed", result.Message ?? ""]);
        }
    }

    private static string GetStatusBadgeClass(string? status) => status switch
    {
        "Completed" => "bg-success",
        "Pending" => "bg-warning",
        "Refunded" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetPaymentTypeBadgeClass(string? type) => type switch
    {
        "Rental" => "bg-primary",
        "Insurance" => "bg-info",
        "Accessory" => "bg-secondary",
        "Deposit" => "bg-purple",
        "Damage" => "bg-danger",
        "Additional" => "bg-warning",
        "Refund" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetPaymentMethodIcon(string? method) => method switch
    {
        "Cash" => "ti ti-cash",
        "Card" => "ti ti-credit-card",
        "PromptPay" => "ti ti-qrcode",
        "BankTransfer" => "ti ti-building-bank",
        _ => "ti ti-cash"
    };

    public class PaymentViewModel
    {
        public Payment Payment { get; set; } = new();
    }
}
