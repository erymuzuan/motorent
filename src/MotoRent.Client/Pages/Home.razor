@page "/"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Entities
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<Home>
@inject VehicleService VehicleService
@inject RentalService RentalService
@inject PaymentService PaymentService

<MotoRentPageTitle>@Localizer["Dashboard"]</MotoRentPageTitle>

<TablerHeader Title="@Localizer["Dashboard"]" PreTitle="@Localizer["Overview"]" />

@* Stats Cards *@
<div class="mr-summary-cards">
    <div class="mr-stat-card mr-stat-card-primary">
        <div class="mr-stat-icon">
            <i class="ti ti-receipt"></i>
        </div>
        <div class="mr-stat-content">
            <div class="mr-stat-label">@Localizer["ActiveRentals"]</div>
            <div class="mr-stat-value">@m_activeRentals</div>
            <div class="mr-stat-description">@Localizer["CurrentlyRentedOut"]</div>
        </div>
    </div>

    <div class="mr-stat-card mr-stat-card-success">
        <div class="mr-stat-icon">
            <i class="ti ti-car"></i>
        </div>
        <div class="mr-stat-content">
            <div class="mr-stat-label">@Localizer["AvailableVehicles"]</div>
            <div class="mr-stat-value">@m_availableVehicles</div>
            <div class="mr-stat-description">@Localizer["OutOfTotal", m_totalVehicles]</div>
        </div>
    </div>

    <div class="mr-stat-card mr-stat-card-warning">
        <div class="mr-stat-icon">
            <i class="ti ti-clock"></i>
        </div>
        <div class="mr-stat-content">
            <div class="mr-stat-label">@Localizer["DueToday"]</div>
            <div class="mr-stat-value">@m_dueToday</div>
            <div class="mr-stat-description">@Localizer["ReturnsScheduled"]</div>
        </div>
    </div>

    <div class="mr-stat-card mr-stat-card-teal">
        <div class="mr-stat-icon">
            <i class="ti ti-currency-baht"></i>
        </div>
        <div class="mr-stat-content">
            <div class="mr-stat-label">@Localizer["TodaysRevenue"]</div>
            <div class="mr-stat-value">@m_todayRevenue.ToString("N0")</div>
            <div class="mr-stat-description">@Localizer["ThbCollectedToday"]</div>
        </div>
    </div>
</div>

@* Recent Rentals & Quick Actions *@
<div class="row row-deck row-cards">
    <div class="col-lg-8">
        <MaintenanceAlertWidget />

        <div class="mr-card mt-3">
            <div class="mr-card-header">
                <div class="mr-card-title">
                    <i class="ti ti-receipt me-2"></i>@Localizer["RecentRentals"]
                </div>
                <a href="/rentals" class="btn btn-sm btn-outline-primary">
                    @Localizer["ViewAll"] <i class="ti ti-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="mr-card-body p-0">
                <div class="table-responsive">
                    <table class="table table-vcenter card-table mb-0">
                        <thead>
                            <tr>
                                <th>@Localizer["Renter"]</th>
                                <th>@Localizer["Vehicle"]</th>
                                <th>@Localizer["StartDate"]</th>
                                <th class="text-center">@Localizer["Status"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (m_recentRentals.Count == 0)
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-secondary py-4">
                                        <i class="ti ti-receipt-off fs-1 d-block mb-2 opacity-50"></i>
                                        @Localizer["NoRecentRentals"]
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var rental in m_recentRentals)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="avatar avatar-sm bg-primary-lt me-2">
                                                    <i class="ti ti-user"></i>
                                                </span>
                                                @rental.RenterName
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-secondary">@rental.VehicleName</span>
                                        </td>
                                        <td>@rental.StartDate.ToString("dd MMM yyyy")</td>
                                        <td class="text-center">
                                            <span class="mr-badge @(rental.Status == "Active" ? "mr-badge-success" : "mr-badge-secondary")">
                                                @Localizer[rental.Status]
                                            </span>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="mr-card">
            <div class="mr-card-header">
                <div class="mr-card-title">
                    <i class="ti ti-bolt me-2"></i>@Localizer["QuickActions"]
                </div>
            </div>
            <div class="mr-card-body">
                <div class="d-grid gap-3">
                    <a href="/rentals/checkin" class="mr-action-button mr-action-button-primary">
                        <div class="mr-action-icon">
                            <i class="ti ti-login"></i>
                        </div>
                        <div class="mr-action-content">
                            <div class="mr-action-title">@Localizer["NewCheckIn"]</div>
                            <div class="mr-action-description">@Localizer["StartNewRental"]</div>
                        </div>
                        <i class="ti ti-chevron-right ms-auto"></i>
                    </a>
                    <a href="/rentals/checkout" class="mr-action-button mr-action-button-warning">
                        <div class="mr-action-icon">
                            <i class="ti ti-logout"></i>
                        </div>
                        <div class="mr-action-content">
                            <div class="mr-action-title">@Localizer["ProcessCheckOut"]</div>
                            <div class="mr-action-description">@Localizer["ReturnVehicle"]</div>
                        </div>
                        <i class="ti ti-chevron-right ms-auto"></i>
                    </a>
                    <a href="/renters" class="mr-action-button mr-action-button-info">
                        <div class="mr-action-icon">
                            <i class="ti ti-user-plus"></i>
                        </div>
                        <div class="mr-action-content">
                            <div class="mr-action-title">@Localizer["RegisterRenter"]</div>
                            <div class="mr-action-description">@Localizer["AddNewCustomer"]</div>
                        </div>
                        <i class="ti ti-chevron-right ms-auto"></i>
                    </a>
                    <a href="/vehicles" class="mr-action-button">
                        <div class="mr-action-icon">
                            <i class="ti ti-car"></i>
                        </div>
                        <div class="mr-action-content">
                            <div class="mr-action-title">@Localizer["ManageFleet"]</div>
                            <div class="mr-action-description">@Localizer["ViewAllVehicles"]</div>
                        </div>
                        <i class="ti ti-chevron-right ms-auto"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Dashboard stats
    private int m_activeRentals;
    private int m_availableVehicles;
    private int m_totalVehicles;
    private int m_dueToday;
    private decimal m_todayRevenue;
    private bool m_loading = true;

    // Recent rentals data
    private List<RecentRentalItem> m_recentRentals = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataAsync();
    }

    private async Task LoadDashboardDataAsync()
    {
        m_loading = true;
        try
        {
            // Get vehicle stats
            var vehicleStats = await VehicleService.GetStatusCountsAsync(ShopId);
            m_availableVehicles = vehicleStats.GetValueOrDefault(VehicleStatus.Available, 0);
            m_totalVehicles = vehicleStats.Values.Sum();

            // Get rental stats
            var rentalStats = await RentalService.GetStatusCountsAsync(ShopId);
            m_activeRentals = rentalStats.GetValueOrDefault("Active", 0);

            // Get due today count
            var todaysDueRentals = await RentalService.GetTodaysDueReturnsAsync(ShopId, DateTimeOffset.Now);
            m_dueToday = todaysDueRentals.Count;

            // Get today's revenue
            var todayStart = DateTimeOffset.Now.Date;
            var todayEnd = todayStart.AddDays(1);
            var paymentSummary = await PaymentService.GetPaymentSummaryAsync(ShopId, todayStart, todayEnd);
            m_todayRevenue = paymentSummary.TotalAmount;

            // Load recent rentals
            await LoadRecentRentalsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
            ShowError("Failed to load dashboard data");
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task LoadRecentRentalsAsync()
    {
        m_recentRentals.Clear();

        // Get recent rentals
        var rentalsResult = await RentalService.GetRentalsAsync(ShopId, pageSize: 5);

        foreach (var rental in rentalsResult.ItemCollection)
        {
            // Get renter name
            var renter = await DataContext.LoadOneAsync<Renter>(r => r.RenterId == rental.RenterId);
            var renterName = renter?.FullName ?? "Unknown";

            // Get vehicle name
            var vehicle = await DataContext.LoadOneAsync<Vehicle>(v => v.VehicleId == rental.VehicleId);
            var vehicleName = vehicle != null ? $"{vehicle.Brand} {vehicle.Model}" : "Unknown";

            m_recentRentals.Add(new RecentRentalItem(
                renterName,
                vehicleName,
                rental.StartDate.DateTime,
                rental.Status ?? "Unknown"
            ));
        }
    }

    private record RecentRentalItem(string RenterName, string VehicleName, DateTime StartDate, string Status);
}