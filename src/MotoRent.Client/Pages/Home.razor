@page "/"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Entities
@attribute [Authorize(Policy = "RequireTenantStaff")]
@inherits LocalizedComponentBase<Home>
@inject VehicleService VehicleService
@inject RentalService RentalService
@inject PaymentService PaymentService

<MotoRentPageTitle>@Localizer["Dashboard"]</MotoRentPageTitle>

<TablerHeader Title="@Localizer["Dashboard"]" PreTitle="@Localizer["Overview"]" />

<div class="row row-deck row-cards mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">@Localizer["ActiveRentals"]</div>
                    <div class="ms-auto lh-1">
                        <span class="text-primary">
                            <i class="ti ti-receipt fs-2"></i>
                        </span>
                    </div>
                </div>
                <div class="h1 mb-3">@m_activeRentals</div>
                <div class="d-flex mb-2">
                    <div>
                        <span class="text-secondary">@Localizer["CurrentlyRentedOut"]</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">@Localizer["AvailableVehicles"]</div>
                    <div class="ms-auto lh-1">
                        <span class="text-success">
                            <i class="ti ti-car fs-2"></i>
                        </span>
                    </div>
                </div>
                <div class="h1 mb-3">@m_availableVehicles</div>
                <div class="d-flex mb-2">
                    <div>
                        <span class="text-secondary">@Localizer["OutOfTotal", m_totalVehicles]</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">@Localizer["DueToday"]</div>
                    <div class="ms-auto lh-1">
                        <span class="text-warning">
                            <i class="ti ti-clock fs-2"></i>
                        </span>
                    </div>
                </div>
                <div class="h1 mb-3">@m_dueToday</div>
                <div class="d-flex mb-2">
                    <div>
                        <span class="text-secondary">@Localizer["ReturnsScheduled"]</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="subheader">@Localizer["TodaysRevenue"]</div>
                    <div class="ms-auto lh-1">
                        <span class="text-secondary">
                            <i class="ti ti-currency-baht fs-2"></i>
                        </span>
                    </div>
                </div>
                <div class="h1 mb-3">@m_todayRevenue.ToString("N0")</div>
                <div class="d-flex mb-2">
                    <div>
                        <span class="text-secondary">@Localizer["ThbCollectedToday"]</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row row-deck row-cards">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">@Localizer["RecentRentals"]</h3>
            </div>
            <div class="table-responsive">
                <table class="table table-vcenter card-table table-striped">
                    <thead>
                        <tr>
                            <th>@Localizer["Renter"]</th>
                            <th>@Localizer["Vehicle"]</th>
                            <th>@Localizer["StartDate"]</th>
                            <th>@Localizer["Status"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var rental in m_recentRentals)
                        {
                            <tr>
                                <td>@rental.RenterName</td>
                                <td>@rental.VehicleName</td>
                                <td>@rental.StartDate.ToString("dd MMM yyyy")</td>
                                <td>
                                    <span class="badge @(rental.Status == "Active" ? "bg-success" : "bg-secondary")">
                                        @Localizer[rental.Status]
                                    </span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">@Localizer["QuickActions"]</h3>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/rentals/checkin" class="btn btn-primary">
                        <i class="ti ti-login me-2"></i>
                        @Localizer["NewCheckIn"]
                    </a>
                    <a href="/rentals/checkout" class="btn btn-outline-primary">
                        <i class="ti ti-logout me-2"></i>
                        @Localizer["ProcessCheckOut"]
                    </a>
                    <a href="/renters" class="btn btn-outline-secondary">
                        <i class="ti ti-user-plus me-2"></i>
                        @Localizer["RegisterRenter"]
                    </a>
                    <a href="/vehicles" class="btn btn-ghost-secondary">
                        <i class="ti ti-car me-2"></i>
                        @Localizer["ManageFleet"]
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Dashboard stats
    private int m_activeRentals;
    private int m_availableVehicles;
    private int m_totalVehicles;
    private int m_dueToday;
    private decimal m_todayRevenue;
    private bool m_loading = true;

    // Recent rentals data
    private List<RecentRentalItem> m_recentRentals = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardDataAsync();
    }

    private async Task LoadDashboardDataAsync()
    {
        m_loading = true;
        try
        {
            // Get vehicle stats
            var vehicleStats = await VehicleService.GetStatusCountsAsync(ShopId);
            m_availableVehicles = vehicleStats.GetValueOrDefault(VehicleStatus.Available, 0);
            m_totalVehicles = vehicleStats.Values.Sum();

            // Get rental stats
            var rentalStats = await RentalService.GetStatusCountsAsync(ShopId);
            m_activeRentals = rentalStats.GetValueOrDefault("Active", 0);

            // Get due today count
            var todaysDueRentals = await RentalService.GetTodaysDueReturnsAsync(ShopId, DateTimeOffset.Now);
            m_dueToday = todaysDueRentals.Count;

            // Get today's revenue
            var todayStart = DateTimeOffset.Now.Date;
            var todayEnd = todayStart.AddDays(1);
            var paymentSummary = await PaymentService.GetPaymentSummaryAsync(ShopId, todayStart, todayEnd);
            m_todayRevenue = paymentSummary.TotalAmount;

            // Load recent rentals
            await LoadRecentRentalsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
            ShowError("Failed to load dashboard data");
        }
        finally
        {
            m_loading = false;
        }
    }

    private async Task LoadRecentRentalsAsync()
    {
        m_recentRentals.Clear();

        // Get recent rentals
        var rentalsResult = await RentalService.GetRentalsAsync(ShopId, pageSize: 5);

        foreach (var rental in rentalsResult.ItemCollection)
        {
            // Get renter name
            var renter = await DataContext.LoadOneAsync<Renter>(r => r.RenterId == rental.RenterId);
            var renterName = renter?.FullName ?? "Unknown";

            // Get vehicle name
            var vehicle = await DataContext.LoadOneAsync<Vehicle>(v => v.VehicleId == rental.VehicleId);
            var vehicleName = vehicle != null ? $"{vehicle.Brand} {vehicle.Model}" : "Unknown";

            m_recentRentals.Add(new RecentRentalItem(
                renterName,
                vehicleName,
                rental.StartDate.DateTime,
                rental.Status ?? "Unknown"
            ));
        }
    }

    private record RecentRentalItem(string RenterName, string VehicleName, DateTime StartDate, string Status);
}