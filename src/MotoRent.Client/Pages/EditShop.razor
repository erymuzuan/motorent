@page "/shops/{ShopId}"
@inherits LocalizedComponentBase<EditShop>
@inject ShopService ShopService

<MotoRentPageTitle>@Localizer["EditShop"] - @m_shop.Name</MotoRentPageTitle>

<div class="container-xl">
    @* Page Header *@
    <div class="page-header d-print-none mb-4">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="/shops" class="btn btn-ghost-secondary btn-icon">
                    <i class="ti ti-arrow-left"></i>
                </a>
            </div>
            <div class="col">
                <h2 class="page-title">@Localizer["EditShop"]</h2>
                <p class="text-secondary mb-0">
                    <i class="ti ti-building-store me-1"></i>
                    @m_shop.Name - @m_shop.Location
                </p>
            </div>
            <div class="col-auto">
                <span class="badge @(m_shop.IsActive ? "bg-success-lt text-success" : "bg-secondary-lt text-secondary") fs-6">
                    <i class="ti @(m_shop.IsActive ? "ti-circle-check" : "ti-circle-x") me-1"></i>
                    @(m_shop.IsActive ? Localizer["Active"] : Localizer["Inactive"])
                </span>
            </div>
        </div>
    </div>

    @if (m_loading)
    {
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p class="text-center text-secondary">@Localizer["LoadingShop"]...</p>
            </div>
        </div>
    }
    else if (m_shop.ShopId == 0)
    {
        <div class="card">
            <div class="card-body">
                <div class="empty py-5">
                    <div class="empty-icon">
                        <i class="ti ti-alert-circle" style="font-size: 3rem;"></i>
                    </div>
                    <p class="empty-title">@Localizer["ShopNotFound"]</p>
                    <p class="empty-subtitle text-secondary">
                        @Localizer["ShopNotFoundDescription"]
                    </p>
                    <div class="empty-action">
                        <a href="/shops" class="btn btn-primary">
                            <i class="ti ti-arrow-left me-1"></i>@Localizer["BackToShops"]
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <form id="edit-shop-form" @onsubmit="SaveAsync" @onsubmit:preventDefault>
            <ShopForm Entity="@m_shop" IsNew="false" />

            @* Action Buttons *@
            <div class="card mt-4">
                <div class="card-footer d-flex justify-content-between">
                    <a href="/shops" class="btn btn-ghost-secondary">
                        <i class="ti ti-arrow-left me-1"></i>@Localizer["Cancel"]
                    </a>
                    <button type="submit" class="btn btn-primary" disabled="@m_saving">
                        @if (m_saving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>@Localizer["Saving"]...</span>
                        }
                        else
                        {
                            <i class="ti ti-device-floppy me-1"></i>
                            <span>@Localizer["SaveChanges"]</span>
                        }
                    </button>
                </div>
            </div>
        </form>
    }
</div>

@code {
    [Parameter]
    public string ShopId { get; set; } = "";

    private int m_shopId;
    private Shop m_shop = new();
    private bool m_loading = true;
    private bool m_saving;

    protected override async Task OnParametersSetAsync()
    {
        m_shopId = DecodeId(ShopId);
        await LoadShopAsync();
    }

    private async Task LoadShopAsync()
    {
        this.m_loading = true;
        try
        {
            var shop = await this.ShopService.GetShopByIdAsync(m_shopId);
            if (shop != null)
            {
                this.m_shop = shop.Clone();
            }
            else
            {
                this.m_shop = new Shop();
            }
        }
        catch (Exception ex)
        {
            this.ShowError(Localizer["ErrorLoadingShop", ex.Message]);
            this.m_shop = new Shop();
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task SaveAsync()
    {
        this.m_saving = true;
        try
        {
            var result = await this.ShopService.UpdateShopAsync(this.m_shop, this.UserName);

            if (result.Success)
            {
                this.ShowSuccess(Localizer["ShopUpdatedSuccess"]);
            }
            else
            {
                this.ShowError(result.Message ?? Localizer["SaveFailed"]);
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"{Localizer["Error"]}: {ex.Message}");
        }
        finally
        {
            this.m_saving = false;
        }
    }
}
