@page "/finance/owner-payments"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "RequireTenantManager")]
@inherits LocalizedComponentBase<OwnerPayments>
@inject OwnerPaymentService OwnerPaymentService
@inject VehicleOwnerService VehicleOwnerService

<MotoRentPageTitle>@this.Localizer["OwnerPayments"]</MotoRentPageTitle>

<TablerHeader Title="@this.Localizer["OwnerPayments"]" PreTitle="@this.Localizer["ThirdPartyFleet"]">
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary" @onclick="ExportAsync" disabled="@m_loading">
            <i class="ti ti-download me-1"></i>
            @this.Localizer["Export"]
        </button>
    </div>
</TablerHeader>

@* Summary Cards *@
<div class="row row-deck mb-3">
    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-warning text-white avatar">
                            <i class="ti ti-clock"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium">@this.Localizer["PendingPayments"]</div>
                        <div class="text-secondary">
                            @this.Localizer["PaymentsCount", m_pendingCount]
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="h2 mb-0">@m_pendingTotal.ToString("N0") @this.Localizer["CurrencyTHB"]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card card-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <span class="bg-success text-white avatar">
                            <i class="ti ti-check"></i>
                        </span>
                    </div>
                    <div class="col">
                        <div class="font-weight-medium">@this.Localizer["PaidThisMonth"]</div>
                        <div class="text-secondary">
                            @this.Localizer["PaymentsCount", m_paidCount]
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="h2 mb-0">@m_paidTotal.ToString("N0") @this.Localizer["CurrencyTHB"]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Filters *@
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">@this.Localizer["Owner"]</label>
                <select class="form-select" @bind="m_ownerFilter" @bind:after="LoadDataAsync">
                    <option value="">@this.Localizer["AllOwners"]</option>
                    @foreach (var owner in m_owners)
                    {
                        <option value="@owner.VehicleOwnerId">@owner.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">@this.CommonLocalizer["Status"]</label>
                <select class="form-select" @bind="m_statusFilter" @bind:after="LoadDataAsync">
                    <option value="">@this.Localizer["AllStatus"]</option>
                    <option value="@OwnerPaymentStatus.Pending">@this.CommonLocalizer["Pending"]</option>
                    <option value="@OwnerPaymentStatus.Paid">@this.CommonLocalizer["Paid"]</option>
                    <option value="@OwnerPaymentStatus.Cancelled">@this.CommonLocalizer["Cancelled"]</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">@this.Localizer["FromDate"]</label>
                <input type="date" class="form-control" @bind="m_fromDate" @bind:after="LoadDataAsync" />
            </div>
            <div class="col-md-2">
                <label class="form-label">@this.Localizer["ToDate"]</label>
                <input type="date" class="form-control" @bind="m_toDate" @bind:after="LoadDataAsync" />
            </div>
            <div class="col-md-3 text-end">
                <button type="button" class="btn btn-ghost-secondary" @onclick="ClearFilters">
                    <i class="ti ti-x me-1"></i>
                    @this.Localizer["ClearFilters"]
                </button>
            </div>
        </div>
    </div>
</div>

@* Payments Table *@
<LoadingSkeleton Loading="@m_loading" Mode="LoadingSkeleton.PlaceholderMode.Table">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table">
                <thead>
                    <tr>
                        <th>@this.Localizer["Owner"]</th>
                        <th>@this.Localizer["Vehicle"]</th>
                        <th>@this.Localizer["RentalPeriod"]</th>
                        <th>@this.Localizer["PaymentModel"]</th>
                        <th class="text-end">@this.Localizer["Amount"]</th>
                        <th>@this.Localizer["Status"]</th>
                        <th class="w-1"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var payment in m_payments)
                    {
                        <tr class="@(payment.Status == OwnerPaymentStatus.Cancelled ? "text-secondary" : "")">
                            <td>
                                <div class="font-weight-medium">@payment.VehicleOwnerName</div>
                            </td>
                            <td>
                                <div>@payment.VehicleName</div>
                            </td>
                            <td>
                                <div>@payment.RentalStartDate.ToString("dd MMM") - @payment.RentalEndDate.ToString("dd MMM yyyy")</div>
                                <div class="text-secondary small">@this.Localizer["DaysCount", payment.RentalDays]</div>
                            </td>
                            <td>
                                @if (payment.PaymentModel is OwnerPaymentModel.DailyRate)
                                {
                                    <span>@this.Localizer["DailyRateLabel", payment.CalculationRate.ToString("N0")]</span>
                                }
                                else
                                {
                                    <span>@this.Localizer["PercentageOfLabel", (payment.CalculationRate * 100).ToString("N0"), payment.GrossRentalAmount.ToString("N0")]</span>
                                }
                            </td>
                            <td class="text-end">
                                <span class="h4 mb-0">@payment.Amount.ToString("N0")</span>
                                <span class="text-secondary">@this.Localizer["CurrencyTHB"]</span>
                            </td>
                            <td>
                                @switch (payment.Status)
                                {
                                    case OwnerPaymentStatus.Pending:
                                        <span class="badge bg-warning">@this.CommonLocalizer["Pending"]</span>
                                        break;
                                    case OwnerPaymentStatus.Paid:
                                        <span class="badge bg-success">@this.CommonLocalizer["Paid"]</span>
                                        if (payment.PaidOn is { } paidOn)
                                        {
                                            <div class="text-secondary small">@paidOn.ToString("dd MMM")</div>
                                        }
                                        break;
                                    case OwnerPaymentStatus.Cancelled:
                                        <span class="badge bg-secondary">@this.CommonLocalizer["Cancelled"]</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (payment.Status == OwnerPaymentStatus.Pending)
                                {
                                    <div class="btn-list flex-nowrap">
                                        <button type="button" class="btn btn-sm btn-success"
                                                @onclick="@(() => OpenMarkAsPaidDialog(payment))">
                                            <i class="ti ti-check me-1"></i>
                                            @this.Localizer["MarkPaid"]
                                        </button>
                                        <button type="button" class="btn btn-sm btn-ghost-danger"
                                                @onclick="@(() => CancelPayment(payment))">
                                            <i class="ti ti-x"></i>
                                        </button>
                                    </div>
                                }
                                else if (payment.Status == OwnerPaymentStatus.Paid)
                                {
                                    <button type="button" class="btn btn-sm btn-ghost-secondary"
                                            @onclick="@(() => ViewPaymentDetails(payment))">
                                        <i class="ti ti-eye"></i>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</LoadingSkeleton>

@if (!m_loading && m_payments.Count == 0)
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="ti ti-receipt-off mb-3" style="font-size: 3rem; color: var(--tblr-secondary);"></i>
            <h3 class="text-secondary">@this.Localizer["NoOwnerPaymentsFound"]</h3>
            <p class="text-secondary">
                @if (string.IsNullOrEmpty(m_ownerFilter) && m_statusFilter is null && m_fromDate is null && m_toDate is null)
                {
                    <span>@this.Localizer["NoOwnerPaymentsHelp"]</span>
                }
                else
                {
                    <span>@this.Localizer["TryAdjustingFilters"]</span>
                }
            </p>
        </div>
    </div>
}

@code {
    private List<OwnerPayment> m_payments = [];
    private List<VehicleOwner> m_owners = [];
    private bool m_loading = true;
    private string? m_ownerFilter;
    private OwnerPaymentStatus? m_statusFilter;
    private DateTime? m_fromDate;
    private DateTime? m_toDate;

    // Summary stats
    private decimal m_pendingTotal;
    private int m_pendingCount;
    private decimal m_paidTotal;
    private int m_paidCount;

    protected override async Task OnInitializedAsync()
    {
        // Default to current month
        var now = DateTime.Now;
        this.m_fromDate = new DateTime(now.Year, now.Month, 1);
        this.m_toDate = this.m_fromDate.Value.AddMonths(1).AddDays(-1);

        await this.LoadOwnersAsync();
        await this.LoadDataAsync();
    }

    private async Task LoadOwnersAsync()
    {
        try
        {
            var result = await this.VehicleOwnerService.GetOwnersAsync(null, null, 1, 100);
            this.m_owners = result.ItemCollection;
        }
        catch
        {
            this.m_owners = [];
        }
    }

    private async Task LoadDataAsync()
    {
        this.m_loading = true;
        try
        {
            int? ownerId = string.IsNullOrEmpty(this.m_ownerFilter) ? null : int.Parse(this.m_ownerFilter);
            DateTimeOffset? fromDate = this.m_fromDate.HasValue ? new DateTimeOffset(this.m_fromDate.Value) : null;
            DateTimeOffset? toDate = this.m_toDate.HasValue ? new DateTimeOffset(this.m_toDate.Value.AddDays(1)) : null;

            var result = await this.OwnerPaymentService.GetPaymentsAsync(
                ownerId,
                this.m_statusFilter,
                fromDate,
                toDate,
                page: 1,
                pageSize: 100);

            this.m_payments = result.ItemCollection;

            // Calculate summaries
            this.m_pendingTotal = this.m_payments.Where(p => p.Status == OwnerPaymentStatus.Pending).Sum(p => p.Amount);
            this.m_pendingCount = this.m_payments.Count(p => p.Status == OwnerPaymentStatus.Pending);
            this.m_paidTotal = this.m_payments.Where(p => p.Status == OwnerPaymentStatus.Paid).Sum(p => p.Amount);
            this.m_paidCount = this.m_payments.Count(p => p.Status == OwnerPaymentStatus.Paid);
        }
        catch (Exception ex)
        {
            this.ShowError(this.Localizer["ErrorLoadingPayments", ex.Message]);
        }
        finally
        {
            this.m_loading = false;
        }
    }

    private async Task ClearFilters()
    {
        this.m_ownerFilter = null;
        this.m_statusFilter = null;
        this.m_fromDate = null;
        this.m_toDate = null;
        await this.LoadDataAsync();
    }

    private async Task OpenMarkAsPaidDialog(OwnerPayment payment)
    {
        var result = await this.DialogService
            .Create<MarkAsPaidDialog>(this.Localizer["MarkPaymentAsPaid"])
            .WithParameter(x => x.Payment, payment)
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(this.Localizer["PaymentMarkedAsPaid", payment.Amount.ToString("N0")]);
        }
    }

    private async Task CancelPayment(OwnerPayment payment)
    {
        if (!await this.DialogService.ConfirmYesNoAsync(
            this.Localizer["ConfirmCancelPayment", payment.Amount.ToString("N0"), payment.VehicleOwnerName],
            this.Localizer["CancelPayment"]))
            return;

        var result = await this.OwnerPaymentService.CancelPaymentAsync(
            payment.OwnerPaymentId,
            this.Localizer["CancelledByUser"],
            this.UserName);

        if (result.Success)
        {
            await this.LoadDataAsync();
            this.ShowSuccess(this.Localizer["PaymentCancelled"]);
        }
        else
        {
            this.ShowError(this.Localizer["CancelPaymentFailed", result.Message ?? ""]);
        }
    }

    private async Task ViewPaymentDetails(OwnerPayment payment)
    {
        var message = $"{this.Localizer["PaymentDetails"]}:\n" +
                      $"- {this.Localizer["Amount"]}: {payment.Amount.ToString("N0")} {this.Localizer["CurrencyTHB"]}\n" +
                      $"- {this.Localizer["Method"]}: {payment.PaymentMethod ?? this.Localizer["NotSpecified"]}\n" +
                      $"- {this.Localizer["Reference"]}: {payment.PaymentRef ?? this.Localizer["None"]}\n" +
                      $"- {this.Localizer["PaidOn"]}: {payment.PaidOn?.ToString("dd MMM yyyy HH:mm") ?? this.Localizer["NotAvailable"]}\n" +
                      $"- {this.Localizer["Notes"]}: {payment.Notes ?? this.Localizer["None"]}";

        await this.DialogService.ShowMessageAsync(message, this.Localizer["PaymentDetails"]);
    }

    private async Task ExportAsync()
    {
        // TODO: Implement export functionality
        this.ShowInfo(this.Localizer["ExportComingSoon"]);
        await Task.CompletedTask;
    }
}
