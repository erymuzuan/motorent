@page "/finance/assets/{AssetId:int}/details"
@using Microsoft.AspNetCore.Authorization
@using MotoRent.Domain.Entities
@attribute [Authorize(Policy = "RequireTenantManager")]
@inherits LocalizedComponentBase<AssetDetails>
@inject AssetService AssetService

<MotoRentPageTitle>@(m_asset?.VehicleName ?? this.Localizer["AssetDetails"])</MotoRentPageTitle>

<!-- Page Header -->
<div class="mr-page-header">
    <div class="container-xl">
        <nav class="mr-breadcrumb">
            <span class="mr-breadcrumb-item"><a href="/">@this.CommonLocalizer["Home"]</a></span>
            <i class="ti ti-chevron-right mr-breadcrumb-separator"></i>
            <span class="mr-breadcrumb-item"><a href="/finance">@this.Localizer["Finance"]</a></span>
            <i class="ti ti-chevron-right mr-breadcrumb-separator"></i>
            <span class="mr-breadcrumb-item"><a href="/finance/asset-dashboard">@this.Localizer["AssetDashboard"]</a></span>
            <i class="ti ti-chevron-right mr-breadcrumb-separator"></i>
            <span class="mr-breadcrumb-item active">@(m_asset?.VehicleName ?? this.Localizer["Details"])</span>
        </nav>
        <div class="d-flex justify-content-between align-items-center pb-3">
            <div class="d-flex align-items-center gap-3">
                <div class="mr-header-icon mr-header-icon-finance">
                    <i class="ti ti-chart-line"></i>
                </div>
                <div>
                    <h1 class="mr-page-title">@(m_asset?.VehicleName ?? this.Localizer["AssetDetails"])</h1>
                    <p class="mr-page-subtitle mb-0">@m_asset?.LicensePlate - @this.Localizer["DepreciationPerformance"]</p>
                </div>
            </div>
            <div class="btn-list">
                <a href="/finance/assets/@AssetId" class="btn btn-outline-primary">
                    <i class="ti ti-edit me-1"></i>
                    @this.Localizer["EditAsset"]
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-xl py-4">
    @if (m_loading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@this.CommonLocalizer["Loading"]</span>
            </div>
        </div>
    }
    else if (m_asset == null)
    {
        <div class="alert alert-warning">
            <i class="ti ti-alert-triangle me-2"></i>
            @this.Localizer["AssetNotFound"]
        </div>
    }
    else
    {
        <!-- Asset Summary Cards -->
        <div class="row row-deck row-cards">
            <div class="col-sm-6 col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">@this.Localizer["AcquisitionCost"]</div>
                        </div>
                        <div class="h1 mb-0">@m_asset.AcquisitionCost.ToString("N0") <small class="text-muted">@this.Localizer["CurrencyTHB"]</small></div>
                        <div class="text-muted">@m_asset.AcquisitionDate.ToString("dd MMM yyyy")</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">@this.Localizer["CurrentBookValue"]</div>
                        </div>
                        <div class="h1 mb-0 text-primary">@m_asset.CurrentBookValue.ToString("N0") <small class="text-muted">@this.Localizer["CurrencyTHB"]</small></div>
                        <div class="text-muted">@this.Localizer["PercentOfOriginal", (m_asset.CurrentBookValue / m_asset.AcquisitionCost * 100).ToString("N1")]</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">@this.Localizer["AccumulatedDepreciation"]</div>
                        </div>
                        <div class="h1 mb-0 text-warning">@m_asset.AccumulatedDepreciation.ToString("N0") <small class="text-muted">@this.Localizer["CurrencyTHB"]</small></div>
                        <div class="text-muted">@this.Localizer["MonthsRemaining", m_asset.RemainingUsefulLifeMonths]</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="subheader">@this.Localizer["ROI"]</div>
                        </div>
                        <div class="h1 mb-0 @(m_asset.ROIPercent >= 0 ? "text-success" : "text-danger")">
                            @(m_asset.ROIPercent >= 0 ? "+" : "")@m_asset.ROIPercent.ToString("N1")%
                        </div>
                        <div class="text-muted">@this.Localizer["NetPLLabel", m_asset.NetProfitLoss.ToString("N0")]</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row row-deck row-cards mt-4">
            <!-- Depreciation Chart -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-chart-area me-2"></i>
                            @this.Localizer["AssetValueOverTime"]
                        </h3>
                        <div class="card-actions">
                            <div class="btn-group">
                                <button class="btn btn-sm @(m_chartView == "history" ? "btn-primary" : "btn-outline-secondary")"
                                        @onclick="@(() => SetChartView("history"))">
                                    @this.Localizer["History"]
                                </button>
                                <button class="btn btn-sm @(m_chartView == "projection" ? "btn-primary" : "btn-outline-secondary")"
                                        @onclick="@(() => SetChartView("projection"))">
                                    @this.Localizer["Projection"]
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (m_chartView == "history" && m_depreciationEntries.Any())
                        {
                            <div class="depreciation-chart">
                                @* Simple SVG Line Chart *@
                                <svg viewBox="0 0 800 300" class="w-100" style="max-height: 300px;">
                                    @* Grid lines *@
                                    <g stroke="#e5e7eb" stroke-width="1">
                                        @for (int i = 0; i <= 4; i++)
                                        {
                                            <line x1="50" y1="@(50 + i * 50)" x2="750" y2="@(50 + i * 50)" />
                                        }
                                    </g>

                                    @* Area fill *@
                                    <path d="@GetChartAreaPath()" fill="url(#gradient)" opacity="0.3" />

                                    @* Line *@
                                    <path d="@GetChartLinePath()" fill="none" stroke="#0ea5e9" stroke-width="3" />

                                    @* Data points *@
                                    @foreach (var point in GetChartPoints())
                                    {
                                        <circle cx="@point.X" cy="@point.Y" r="5" fill="#0ea5e9" stroke="white" stroke-width="2" />
                                    }

                                    @* Gradient definition *@
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" stop-color="#0ea5e9" />
                                            <stop offset="100%" stop-color="#0ea5e9" stop-opacity="0" />
                                        </linearGradient>
                                    </defs>

                                    @* Y-axis labels *@
                                    @((MarkupString)$"<text x=\"45\" y=\"55\" text-anchor=\"end\" font-size=\"10\" fill=\"#6b7280\">{m_asset.AcquisitionCost.ToString("N0")}</text>")
                                    @((MarkupString)$"<text x=\"45\" y=\"255\" text-anchor=\"end\" font-size=\"10\" fill=\"#6b7280\">{m_asset.ResidualValue.ToString("N0")}</text>")
                                </svg>
                            </div>
                        }
                        else if (m_chartView == "projection" && m_projections.Any())
                        {
                            <div class="depreciation-chart">
                                <svg viewBox="0 0 800 300" class="w-100" style="max-height: 300px;">
                                    @* Grid lines *@
                                    <g stroke="#e5e7eb" stroke-width="1">
                                        @for (int i = 0; i <= 4; i++)
                                        {
                                            <line x1="50" y1="@(50 + i * 50)" x2="750" y2="@(50 + i * 50)" />
                                        }
                                    </g>

                                    @* Projection area *@
                                    <path d="@GetProjectionAreaPath()" fill="url(#projGradient)" opacity="0.3" />

                                    @* Projection line *@
                                    <path d="@GetProjectionLinePath()" fill="none" stroke="#8b5cf6" stroke-width="3" stroke-dasharray="5,5" />

                                    @* Current value marker *@
                                    <line x1="50" y1="50" x2="50" y2="250" stroke="#ef4444" stroke-width="2" stroke-dasharray="3,3" />
                                    @((MarkupString)$"<text x=\"55\" y=\"45\" font-size=\"10\" fill=\"#ef4444\">{this.Localizer["Today"]}</text>")

                                    <defs>
                                        <linearGradient id="projGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" stop-color="#8b5cf6" />
                                            <stop offset="100%" stop-color="#8b5cf6" stop-opacity="0" />
                                        </linearGradient>
                                    </defs>

                                    @* Y-axis labels *@
                                    @((MarkupString)$"<text x=\"45\" y=\"55\" text-anchor=\"end\" font-size=\"10\" fill=\"#6b7280\">{m_asset.CurrentBookValue.ToString("N0")}</text>")
                                    @((MarkupString)$"<text x=\"45\" y=\"255\" text-anchor=\"end\" font-size=\"10\" fill=\"#6b7280\">{m_asset.ResidualValue.ToString("N0")}</text>")
                                </svg>
                            </div>
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="ti ti-chart-line" style="font-size: 3rem;"></i>
                                <p class="mt-2">@this.Localizer["NoDepreciationData"]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Asset Info -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-info-circle me-2"></i>
                            @this.Localizer["DepreciationSettings"]
                        </h3>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-5">@this.Localizer["MethodLabel"]:</dt>
                            <dd class="col-7">
                                <span class="badge bg-blue-lt">@m_asset.DepreciationMethod.ToString()</span>
                            </dd>
                            <dt class="col-5">@this.Localizer["UsefulLifeLabel"]:</dt>
                            <dd class="col-7">@this.Localizer["UsefulLifeMonthsValue", m_asset.UsefulLifeMonths, (m_asset.UsefulLifeMonths / 12.0).ToString("N1")]</dd>
                            <dt class="col-5">@this.Localizer["ResidualValueLabel"]:</dt>
                            <dd class="col-7">@m_asset.ResidualValue.ToString("N0") @this.Localizer["CurrencyTHB"]</dd>
                            <dt class="col-5">@this.Localizer["MonthlyDeprLabel"]:</dt>
                            <dd class="col-7">@m_asset.MonthlyDepreciationStraightLine.ToString("N0") @this.Localizer["CurrencyTHB"]</dd>
                            @if (m_asset.DayOutOfDoorPercent.HasValue)
                            {
                                <dt class="col-5">@this.Localizer["DayOutPercentLabel"]:</dt>
                                <dd class="col-7">@((m_asset.DayOutOfDoorPercent.Value * 100).ToString("N0"))%</dd>
                            }
                            @if (m_asset.FirstRentalDate.HasValue)
                            {
                                <dt class="col-5">@this.Localizer["FirstRentalLabel"]:</dt>
                                <dd class="col-7">@m_asset.FirstRentalDate.Value.ToString("dd MMM yyyy")</dd>
                            }
                            <dt class="col-5">@this.Localizer["LastDeprLabel"]:</dt>
                            <dd class="col-7">@(m_asset.LastDepreciationDate?.ToString("dd MMM yyyy") ?? this.Localizer["Never"])</dd>
                            <dt class="col-5">@this.Localizer["StatusLabel"]:</dt>
                            <dd class="col-7">
                                <span class="badge @GetStatusBadgeClass(m_asset.Status)">@m_asset.Status</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Depreciation History Table -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-history me-2"></i>
                    @this.Localizer["DepreciationHistory"]
                </h3>
                <div class="card-actions">
                    <span class="badge bg-blue">@this.Localizer["EntriesCount", m_depreciationEntries.Count]</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-vcenter card-table">
                    <thead>
                        <tr>
                            <th>@this.Localizer["Period"]</th>
                            <th>@this.Localizer["Method"]</th>
                            <th class="text-end">@this.Localizer["BookValueStart"]</th>
                            <th class="text-end">@this.Localizer["Depreciation"]</th>
                            <th class="text-end">@this.Localizer["BookValueEnd"]</th>
                            <th>@this.Localizer["Type"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (m_depreciationEntries.Any())
                        {
                            @foreach (var entry in m_depreciationEntries)
                            {
                                <tr>
                                    <td>
                                        <div>@entry.PeriodStart.ToString("MMM yyyy")</div>
                                        <small class="text-muted">@entry.PeriodStart.ToString("dd") - @entry.PeriodEnd.ToString("dd MMM")</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-azure-lt">@entry.Method</span>
                                    </td>
                                    <td class="text-end">@entry.BookValueStart.ToString("N0")</td>
                                    <td class="text-end text-danger">-@entry.Amount.ToString("N0")</td>
                                    <td class="text-end fw-bold">@entry.BookValueEnd.ToString("N0")</td>
                                    <td>
                                        @if (entry.IsManualOverride)
                                        {
                                            <span class="badge bg-yellow-lt" title="@entry.OverrideReason">
                                                <i class="ti ti-edit me-1"></i>@this.Localizer["Manual"]
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-green-lt">
                                                <i class="ti ti-robot me-1"></i>@this.Localizer["System"]
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    <i class="ti ti-calendar-off" style="font-size: 2rem;"></i>
                                    <p class="mb-0 mt-2">@this.Localizer["NoDepreciationEntries"]</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int AssetId { get; set; }

    private Asset? m_asset;
    private List<DepreciationEntry> m_depreciationEntries = [];
    private List<DepreciationProjection> m_projections = [];
    private bool m_loading = true;
    private string m_chartView = "history";

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            m_loading = true;
            m_asset = await AssetService.GetAssetByIdAsync(AssetId);

            if (m_asset != null)
            {
                m_depreciationEntries = await AssetService.GetDepreciationEntriesAsync(AssetId);
                m_projections = AssetService.GetDepreciationProjections(m_asset, 24);
            }
        }
        finally
        {
            m_loading = false;
        }
    }

    private void SetChartView(string view)
    {
        m_chartView = view;
    }

    private string GetStatusBadgeClass(AssetStatus status) => status switch
    {
        AssetStatus.Active => "bg-success-lt",
        AssetStatus.Disposed => "bg-warning-lt",
        AssetStatus.WriteOff => "bg-danger-lt",
        _ => "bg-secondary-lt"
    };

    private record ChartPoint(double X, double Y);

    private List<ChartPoint> GetChartPoints()
    {
        if (!m_depreciationEntries.Any() || m_asset == null) return [];

        var entries = m_depreciationEntries.OrderBy(e => e.PeriodEnd).ToList();
        var maxValue = m_asset.AcquisitionCost;
        var minValue = m_asset.ResidualValue;
        var valueRange = maxValue - minValue;

        var points = new List<ChartPoint>();
        var xStep = 700.0 / Math.Max(1, entries.Count - 1);

        for (int i = 0; i < entries.Count; i++)
        {
            var x = 50 + i * xStep;
            var y = 50 + (1 - (double)((entries[i].BookValueEnd - minValue) / valueRange)) * 200;
            points.Add(new ChartPoint(x, Math.Max(50, Math.Min(250, y))));
        }

        return points;
    }

    private string GetChartLinePath()
    {
        var points = GetChartPoints();
        if (!points.Any()) return "";

        var path = $"M {points[0].X} {points[0].Y}";
        for (int i = 1; i < points.Count; i++)
        {
            path += $" L {points[i].X} {points[i].Y}";
        }
        return path;
    }

    private string GetChartAreaPath()
    {
        var points = GetChartPoints();
        if (!points.Any()) return "";

        var path = $"M {points[0].X} 250 L {points[0].X} {points[0].Y}";
        for (int i = 1; i < points.Count; i++)
        {
            path += $" L {points[i].X} {points[i].Y}";
        }
        path += $" L {points.Last().X} 250 Z";
        return path;
    }

    private string GetProjectionLinePath()
    {
        if (!m_projections.Any() || m_asset == null) return "";

        var maxValue = m_asset.CurrentBookValue;
        var minValue = m_asset.ResidualValue;
        var valueRange = maxValue - minValue;
        if (valueRange == 0) return "";

        var xStep = 700.0 / Math.Max(1, m_projections.Count - 1);

        var path = $"M 50 50";
        for (int i = 0; i < m_projections.Count; i++)
        {
            var x = 50 + i * xStep;
            var y = 50 + (1 - (double)((m_projections[i].BookValueEnd - minValue) / valueRange)) * 200;
            path += $" L {x} {Math.Max(50, Math.Min(250, y))}";
        }
        return path;
    }

    private string GetProjectionAreaPath()
    {
        if (!m_projections.Any() || m_asset == null) return "";

        var maxValue = m_asset.CurrentBookValue;
        var minValue = m_asset.ResidualValue;
        var valueRange = maxValue - minValue;
        if (valueRange == 0) return "";

        var xStep = 700.0 / Math.Max(1, m_projections.Count - 1);

        var path = "M 50 250 L 50 50";
        for (int i = 0; i < m_projections.Count; i++)
        {
            var x = 50 + i * xStep;
            var y = 50 + (1 - (double)((m_projections[i].BookValueEnd - minValue) / valueRange)) * 200;
            path += $" L {x} {Math.Max(50, Math.Min(250, y))}";
        }
        path += $" L {50 + (m_projections.Count - 1) * xStep} 250 Z";
        return path;
    }
}
