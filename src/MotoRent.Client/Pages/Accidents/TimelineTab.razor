@using MotoRent.Domain.Entities
@inherits LocalizedComponentBase<TimelineTab>
@inject AccidentService AccidentService

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">@Localizer["TimelineActivity"]</h4>
    <button type="button" class="btn btn-primary btn-sm" @onclick="AddNote">
        <i class="ti ti-plus me-1"></i>
        @Localizer["AddNote"]
    </button>
</div>

@if (Notes.Count == 0)
{
    <div class="text-center text-secondary py-4">
        <i class="ti ti-timeline mb-2" style="font-size: 2rem;"></i>
        <div>@Localizer["NoActivityRecorded"]</div>
    </div>
}
else
{
    <ul class="timeline">
        @foreach (var note in Notes.OrderByDescending(n => n.CreatedTimestamp))
        {
            <li class="timeline-event">
                <div class="timeline-event-icon @GetNoteTypeClass(note.NoteType)">
                    <i class="ti @GetNoteTypeIcon(note.NoteType)"></i>
                </div>
                <div class="card timeline-event-card">
                    <div class="card-body d-flex flex-column flex-sm-row">
                        <div class="flex-fill">
                            @if (note.NoteType == "StatusChange")
                            {
                                <div class="text-secondary small mb-1">@Localizer["StatusChange"]</div>
                                <span class="badge bg-secondary-lt me-1">@note.PreviousStatus</span>
                                <i class="ti ti-arrow-right"></i>
                                <span class="badge bg-primary-lt ms-1">@note.NewStatus</span>
                            }
                            else
                            {
                                <div class="text-secondary small mb-1">@note.NoteType</div>
                            }
                            <p class="mb-0 mt-2">@note.Content</p>
                        </div>
                        <div class="ms-auto text-end">
                            <small class="text-secondary">
                                @FormatDateTime(note.CreatedTimestamp)
                            </small>
                            <div class="small text-secondary">@Localizer["ByUser", note.CreatedBy ?? ""]</div>
                            @if (note.NoteType != "StatusChange")
                            {
                                <button type="button" class="btn btn-icon btn-ghost-danger btn-sm mt-1" @onclick="@(() => DeleteNote(note))">
                                    <i class="ti ti-trash"></i>
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </li>
        }
    </ul>
}

@code {
    [Parameter]
    public int AccidentId { get; set; }

    [Parameter]
    public List<AccidentNote> Notes { get; set; } = [];

    [Parameter]
    public EventCallback OnChanged { get; set; }

    private async Task AddNote()
    {
        var content = await DialogService.PromptAsync(Localizer["AddNote"], Localizer["EnterNote"]);
        if (string.IsNullOrWhiteSpace(content)) return;

        var note = new AccidentNote
        {
            AccidentId = AccidentId,
            Content = content,
            NoteType = "General",
            IsInternal = true
        };

        var result = await AccidentService.SaveNoteAsync(note, UserName);
        if (result.Success)
        {
            await OnChanged.InvokeAsync();
        }
    }

    private async Task DeleteNote(AccidentNote note)
    {
        if (!await ConfirmDeleteAsync(Localizer["DefaultNoteName"]))
            return;

        var deleteResult = await AccidentService.DeleteNoteAsync(note, UserName);
        if (deleteResult.Success)
        {
            await OnChanged.InvokeAsync();
        }
    }

    private static string GetNoteTypeIcon(string type) => type switch
    {
        "StatusChange" => "ti-exchange",
        "PhoneCall" => "ti-phone",
        "Email" => "ti-mail",
        "DocumentAdded" => "ti-file-plus",
        "CostAdded" => "ti-cash",
        _ => "ti-note"
    };

    private static string GetNoteTypeClass(string type) => type switch
    {
        "StatusChange" => "bg-primary",
        "PhoneCall" => "bg-info",
        "Email" => "bg-warning",
        "DocumentAdded" => "bg-success",
        "CostAdded" => "bg-danger",
        _ => "bg-secondary"
    };
}
