@using MotoRent.Domain.Entities
@inherits MotoRentComponentBase
@inject AccidentService AccidentService

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Costs</h4>
    <button type="button" class="btn btn-primary btn-sm" @onclick="AddCost">
        <i class="ti ti-plus me-1"></i>
        Add Cost
    </button>
</div>

@if (Costs.Count == 0)
{
    <div class="text-center text-secondary py-4">
        <i class="ti ti-currency-dollar mb-2" style="font-size: 2rem;"></i>
        <div>No costs recorded yet</div>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-vcenter">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Description</th>
                    <th class="text-end">Estimated</th>
                    <th class="text-end">Actual</th>
                    <th>Status</th>
                    <th class="w-1"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cost in Costs)
                {
                    <tr class="@(cost.IsCredit ? "bg-success-lt" : "")">
                        <td>
                            <span class="badge @(cost.IsCredit ? "bg-success-lt text-success" : "bg-secondary-lt")">
                                @cost.CostType
                            </span>
                        </td>
                        <td>
                            <div>@cost.Description</div>
                            @if (!string.IsNullOrEmpty(cost.VendorName))
                            {
                                <small class="text-secondary">@cost.VendorName</small>
                            }
                        </td>
                        <td class="text-end">@FormatCurrency(cost.EstimatedAmount)</td>
                        <td class="text-end">
                            @if (cost.ActualAmount.HasValue)
                            {
                                <strong>@FormatCurrency(cost.ActualAmount.Value)</strong>
                            }
                            else
                            {
                                <span class="text-secondary">-</span>
                            }
                        </td>
                        <td>
                            @if (cost.IsApproved)
                            {
                                <span class="badge bg-success-lt">Approved</span>
                            }
                            else
                            {
                                <span class="badge bg-warning-lt">Pending</span>
                            }
                        </td>
                        <td>
                            <div class="btn-list flex-nowrap">
                                <button type="button" class="btn btn-icon btn-ghost-primary btn-sm" @onclick="@(() => EditCost(cost))">
                                    <i class="ti ti-edit"></i>
                                </button>
                                <button type="button" class="btn btn-icon btn-ghost-danger btn-sm" @onclick="@(() => DeleteCost(cost))">
                                    <i class="ti ti-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr class="fw-bold">
                    <td colspan="2">Total</td>
                    <td class="text-end">@FormatCurrency(Costs.Where(c => !c.IsCredit).Sum(c => c.EstimatedAmount))</td>
                    <td class="text-end">@FormatCurrency(Costs.Where(c => !c.IsCredit && c.ActualAmount.HasValue).Sum(c => c.ActualAmount!.Value))</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
    </div>
}

@code {
    [Parameter]
    public int AccidentId { get; set; }

    [Parameter]
    public List<AccidentCost> Costs { get; set; } = [];

    [Parameter]
    public EventCallback OnChanged { get; set; }

    private async Task AddCost()
    {
        var cost = new AccidentCost { AccidentId = AccidentId };
        var result = await DialogService
            .Create<AddCostDialog>("Add Cost")
            .WithParameter(x => x.Entity, cost)
            .WithParameter(x => x.IsNew, true)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await OnChanged.InvokeAsync();
        }
    }

    private async Task EditCost(AccidentCost cost)
    {
        var result = await DialogService
            .Create<AddCostDialog>("Edit Cost")
            .WithParameter(x => x.Entity, cost.Clone())
            .WithParameter(x => x.IsNew, false)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await OnChanged.InvokeAsync();
        }
    }

    private async Task DeleteCost(AccidentCost cost)
    {
        if (!await ConfirmDeleteAsync("this cost entry"))
            return;

        var deleteResult = await AccidentService.DeleteCostAsync(cost, UserName);
        if (deleteResult.Success)
        {
            await OnChanged.InvokeAsync();
        }
    }
}
