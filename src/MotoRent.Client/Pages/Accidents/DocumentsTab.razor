@using MotoRent.Domain.Entities
@inherits LocalizedComponentBase<DocumentsTab>
@inject AccidentService AccidentService

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">@Localizer["Documents"]</h4>
    <button type="button" class="btn btn-primary btn-sm" @onclick="AddDocument">
        <i class="ti ti-upload me-1"></i>
        @Localizer["UploadDocument"]
    </button>
</div>

@if (Documents.Count == 0)
{
    <div class="text-center text-secondary py-4">
        <i class="ti ti-files mb-2" style="font-size: 2rem;"></i>
        <div>@Localizer["NoDocumentsUploaded"]</div>
    </div>
}
else
{
    <div class="row g-3">
        @foreach (var doc in Documents)
        {
            <div class="col-md-6 col-lg-4">
                <div class="card card-sm">
                    <div class="card-body d-flex align-items-center">
                        <span class="bg-primary text-white avatar me-3">
                            <i class="ti @GetDocumentIcon(doc.DocumentType)"></i>
                        </span>
                        <div class="flex-fill">
                            <div class="fw-bold text-truncate" title="@doc.FileName">@(doc.Title ?? doc.FileName)</div>
                            <small class="text-secondary">
                                @doc.DocumentType - @FormatFileSize(doc.FileSize)
                            </small>
                        </div>
                        <div class="btn-list flex-nowrap">
                            <button type="button" class="btn btn-icon btn-ghost-danger btn-sm" @onclick="@(() => DeleteDocument(doc))">
                                <i class="ti ti-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int AccidentId { get; set; }

    [Parameter]
    public List<AccidentDocument> Documents { get; set; } = [];

    [Parameter]
    public EventCallback OnChanged { get; set; }

    private async Task AddDocument()
    {
        var doc = new AccidentDocument { AccidentId = AccidentId };
        var result = await DialogService
            .Create<AddDocumentDialog>(Localizer["UploadDocument"])
            .WithParameter(x => x.Entity, doc)
            .Large()
            .ShowDialogAsync();

        if (!result.Cancelled)
        {
            await OnChanged.InvokeAsync();
        }
    }

    private async Task DeleteDocument(AccidentDocument doc)
    {
        if (!await ConfirmDeleteAsync($"{doc.FileName}"))
            return;

        var deleteResult = await AccidentService.DeleteDocumentAsync(doc, UserName);
        if (deleteResult.Success)
        {
            await OnChanged.InvokeAsync();
        }
    }

    private static string GetDocumentIcon(AccidentDocumentType type) => type switch
    {
        AccidentDocumentType.Photo => "ti-photo",
        AccidentDocumentType.Video => "ti-video",
        AccidentDocumentType.PoliceReport => "ti-shield",
        AccidentDocumentType.MedicalRecord => "ti-heart",
        AccidentDocumentType.InsuranceClaim => "ti-file-dollar",
        AccidentDocumentType.RepairQuote => "ti-tool",
        AccidentDocumentType.Invoice => "ti-file-invoice",
        AccidentDocumentType.Receipt => "ti-receipt",
        AccidentDocumentType.LegalDocument => "ti-gavel",
        AccidentDocumentType.SettlementAgreement => "ti-signature",
        AccidentDocumentType.WitnessStatement => "ti-message",
        AccidentDocumentType.DiagramSketch => "ti-pencil",
        _ => "ti-file"
    };

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024:N0} KB";
        return $"{bytes / (1024 * 1024):N1} MB";
    }
}
