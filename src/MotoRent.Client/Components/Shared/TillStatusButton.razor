@*
    TillStatusButton - Shows till status in the header and allows opening new sessions.
    When staff has an open till: Shows "Till #{Number}" with link to till page
    When no open till: Shows prominent "Open Till" button
*@
@using MotoRent.Domain.Core
@using MotoRent.Domain.DataContext
@using MotoRent.Domain.Entities
@using MotoRent.Services
@using Microsoft.Extensions.Localization
@inject IRequestContext RequestContext
@inject RentalDataContext RentalContext
@inject TillService TillService
@inject NavigationManager Navigation
@inject IStringLocalizer<TillStatusButton> Localizer

<div class="nav-item d-none d-md-flex me-3">
    @if (m_loading)
    {
        <span class="mr-till-btn mr-till-btn-loading">
            <i class="ti ti-loader-2 ti-spin"></i>
        </span>
    }
    else if (m_activeSession != null)
    {
        @* Has open till - show status with link *@
        <a href="/staff/till" class="mr-till-btn mr-till-btn-active">
            <span class="mr-till-btn-indicator"></span>
            <i class="ti ti-cash-register"></i>
            <span class="mr-till-btn-label">
                @Localizer["Till"] #@m_activeSession.TillSessionId
            </span>
        </a>
    }
    else
    {
        @* No open till - show prominent button to open *@
        <button type="button" class="mr-till-btn mr-till-btn-open" @onclick="OpenTillDialog">
            <i class="ti ti-cash-register"></i>
            <span class="mr-till-btn-label">@Localizer["OpenTill"]</span>
        </button>
    }
</div>

@code {
    private bool m_loading = true;
    private TillSession? m_activeSession;

    /// <summary>
    /// Event callback when a till session is opened.
    /// Used to refresh the page context.
    /// </summary>
    [Parameter]
    public EventCallback OnTillOpened { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadTillStatusAsync();
    }

    private async Task LoadTillStatusAsync()
    {
        m_loading = true;
        try
        {
            var userName = RequestContext.GetUserName();
            if (string.IsNullOrEmpty(userName)) return;

            // Get active till session for this user
            m_activeSession = await TillService.GetActiveSessionForUserAsync(userName);
        }
        catch
        {
            // Silently fail - will show no till status
        }
        finally
        {
            m_loading = false;
        }
    }

    private void OpenTillDialog()
    {
        // Navigate to till page which has the open dialog
        Navigation.NavigateTo("/staff/till");
    }
}
