@*
    TillStatusButton - Shows till status in the header and allows opening new sessions.
    When staff has an open till: Shows "Till: {ShopName}" with link to till page
    When no open till: Shows "Open Till" button that opens the shop picker dialog
*@
@using MotoRent.Domain.Core
@using MotoRent.Domain.DataContext
@using MotoRent.Domain.Entities
@using MotoRent.Services
@using Microsoft.Extensions.Localization
@inject IRequestContext RequestContext
@inject RentalDataContext RentalContext
@inject TillService TillService
@inject NavigationManager Navigation
@inject IStringLocalizer<TillStatusButton> Localizer

<div class="nav-item d-none d-md-flex me-3">
    @if (m_loading)
    {
        <span class="nav-link px-0 text-secondary">
            <i class="ti ti-loader-2 ti-spin me-1"></i>
        </span>
    }
    else if (m_activeSession != null)
    {
        @* Has open till - show status with link *@
        <a href="/staff/till" class="nav-link px-2 d-flex align-items-center btn btn-sm btn-ghost-success">
            <i class="ti ti-cash-register me-1 text-success"></i>
            <span class="d-none d-lg-inline text-success fw-medium">@m_shopName</span>
        </a>
    }
    else
    {
        @* No open till - show button to open *@
        <button type="button" class="nav-link px-2 d-flex align-items-center btn btn-sm btn-ghost-secondary"
                @onclick="OpenTillDialog">
            <i class="ti ti-cash-register me-1"></i>
            <span class="d-none d-lg-inline">@Localizer["OpenTill"]</span>
        </button>
    }
</div>

@code {
    private bool m_loading = true;
    private TillSession? m_activeSession;
    private string? m_shopName;

    /// <summary>
    /// Event callback when a till session is opened.
    /// Used to refresh the page context.
    /// </summary>
    [Parameter]
    public EventCallback OnTillOpened { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadTillStatusAsync();
    }

    private async Task LoadTillStatusAsync()
    {
        m_loading = true;
        try
        {
            var userName = RequestContext.GetUserName();
            if (string.IsNullOrEmpty(userName)) return;

            // Get active till session for this user
            m_activeSession = await TillService.GetActiveSessionForUserAsync(userName);

            // Load shop name if session exists
            if (m_activeSession != null)
            {
                var shop = await RentalContext.LoadOneAsync<Shop>(s => s.ShopId == m_activeSession.ShopId);
                m_shopName = shop?.Name ?? $"Shop {m_activeSession.ShopId}";
            }
        }
        catch
        {
            // Silently fail - will show no till status
        }
        finally
        {
            m_loading = false;
        }
    }

    private void OpenTillDialog()
    {
        // Navigate to till page which has the open dialog
        Navigation.NavigateTo("/staff/till");
    }
}
