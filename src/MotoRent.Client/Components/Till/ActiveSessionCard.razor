@using MotoRent.Domain.Entities
@inherits LocalizedComponentBase<ActiveSessionCard>

<div class="card h-100 @(HasVarianceAlert ? "border-warning" : "")">
    <div class="card-body">
        <div class="d-flex align-items-start mb-3">
            <span class="avatar avatar-lg bg-primary-lt me-3">
                <i class="ti ti-user"></i>
            </span>
            <div class="flex-fill">
                <h4 class="mb-0">@Session.StaffDisplayName</h4>
                <small class="text-secondary">
                    <i class="ti ti-clock me-1"></i>
                    @FormatDuration(Session.OpenedAt)
                </small>
            </div>
            @if (HasVarianceAlert)
            {
                <span class="badge bg-warning" title="@Localizer["VarianceAlert"]">
                    <i class="ti ti-alert-triangle"></i>
                </span>
            }
        </div>

        @* Currency balances *@
        <div class="row g-2">
            @foreach (var balance in Session.CurrencyBalances.Where(b => b.Value != 0 || b.Key == SupportedCurrencies.THB))
            {
                <div class="col-6">
                    <small class="text-secondary d-block">@balance.Key</small>
                    <span class="fw-semibold">@FormatAmount(balance.Value, balance.Key)</span>
                </div>
            }
        </div>

        @* Last activity *@
        <div class="mt-3 pt-3 border-top">
            <small class="text-secondary">
                <i class="ti ti-activity me-1"></i>
                @Localizer["LastActivity"]: @GetLastActivityText()
            </small>
        </div>
    </div>
    <div class="card-footer">
        <button type="button" class="btn btn-sm btn-ghost-primary w-100" @onclick="OnViewClick">
            <i class="ti ti-eye me-1"></i>
            @Localizer["ViewDetails"]
        </button>
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public TillSession Session { get; set; } = null!;

    [Parameter]
    public bool HasVarianceAlert { get; set; }

    [Parameter]
    public EventCallback OnView { get; set; }

    private async Task OnViewClick() => await OnView.InvokeAsync();

    private string FormatDuration(DateTimeOffset startTime)
    {
        var duration = DateTimeOffset.Now - startTime;
        if (duration.TotalHours >= 1)
            return string.Format(Localizer["DurationHoursMinutes"], (int)duration.TotalHours, duration.Minutes);
        return string.Format(Localizer["DurationMinutes"], (int)duration.TotalMinutes);
    }

    private string FormatAmount(decimal amount, string currency)
    {
        return currency == SupportedCurrencies.THB
            ? amount.ToString("N0")
            : amount.ToString("N2");
    }

    private string GetLastActivityText()
    {
        // For now, just show "Active" - can enhance with transaction tracking later
        return Localizer["Active"];
    }
}
