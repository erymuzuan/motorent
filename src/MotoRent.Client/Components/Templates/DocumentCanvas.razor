@using MotoRent.Domain.Models
@using MotoRent.Client.Services
@inherits LocalizedComponentBase<DocumentCanvas>
@inject DesignerState DesignerState

<div class="designer-scroll-area">
    <div class="a4-canvas" 
         @ondragover="this.HandleCanvasDragOver" 
         @ondragover:preventDefault="true"
         @ondrop="this.HandleCanvasDrop">
        
        @foreach (var layoutSection in this.Layout.Sections)
        {
            <div class="canvas-section mb-4">
                <div class="section-label small text-muted mb-1 px-3 d-flex justify-content-between align-items-center">
                    <span>@layoutSection.Name</span>
                    @if (this.Layout.Sections.Count > 1)
                    {
                        <button class="btn btn-ghost-danger btn-xs" @onclick="() => this.Layout.Sections.Remove(layoutSection)">
                            <i class="ti ti-trash"></i>
                        </button>
                    }
                </div>

                @foreach (var block in layoutSection.Blocks)
                {
                    <CanvasBlock Block="block" 
                                IsSelected="@(this.SelectedBlock == block)"
                                OnSelect="() => this.OnBlockSelected.InvokeAsync(block)"
                                OnDelete="() => layoutSection.Blocks.Remove(block)"
                                OnMoveUp="() => this.MoveBlockUp(layoutSection, block)"
                                OnMoveDown="() => this.MoveBlockDown(layoutSection, block)" />
                }

                @if (!layoutSection.Blocks.Any())
                {
                    <div class="text-center py-4 border-dashed rounded m-2 text-muted small">
                        @this.Localizer["DropBlocksHere"]
                    </div>
                }
            </div>
        }

        <div class="p-4 text-center">
            <button class="btn btn-ghost-primary btn-sm" @onclick="this.AddSection">
                <i class="ti ti-plus me-1"></i> @this.Localizer["AddSection"]
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public DocumentLayout Layout { get; set; } = default!;
    [Parameter] public LayoutBlock? SelectedBlock { get; set; }
    [Parameter] public EventCallback<LayoutBlock?> OnBlockSelected { get; set; }
    [Parameter] public EventCallback<string> OnBlockAdded { get; set; }

    private void AddSection()
    {
        this.Layout.Sections.Add(new LayoutSection { Name = this.Localizer["SectionName", this.Layout.Sections.Count + 1] });
    }

    private void MoveBlockUp(LayoutSection section, LayoutBlock block)
    {
        var index = section.Blocks.IndexOf(block);
        if (index > 0)
        {
            section.Blocks.RemoveAt(index);
            section.Blocks.Insert(index - 1, block);
        }
    }

    private void MoveBlockDown(LayoutSection section, LayoutBlock block)
    {
        var index = section.Blocks.IndexOf(block);
        if (index < section.Blocks.Count - 1)
        {
            section.Blocks.RemoveAt(index);
            section.Blocks.Insert(index + 1, block);
        }
    }

    private void HandleCanvasDragOver(DragEventArgs e)
    {
        // Required for drop to work
    }

    private async Task HandleCanvasDrop(DragEventArgs e)
    {
        if (!string.IsNullOrEmpty(this.DesignerState.DraggingBlockType))
        {
            await this.OnBlockAdded.InvokeAsync(this.DesignerState.DraggingBlockType);
            this.DesignerState.DraggingBlockType = null;
        }
    }
}
