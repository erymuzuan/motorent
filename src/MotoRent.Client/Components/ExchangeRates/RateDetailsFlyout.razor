@inherits LocalizedComponentBase<RateDetailsFlyout>
@inject ExchangeRateService ExchangeRateService

@* Offcanvas panel showing rate details, breakdown, and calculator *@

@if (IsOpen)
{
    <div class="offcanvas-backdrop fade show" @onclick="Close"></div>

    <div class="offcanvas offcanvas-end show" tabindex="-1" style="visibility: visible;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title d-flex align-items-center gap-2">
                @if (Rate != null)
                {
                    <span style="font-size: 1.5rem;">@GetCurrencyFlag(Rate.Currency)</span>
                    <span>@Rate.Currency - @Rate.GroupName</span>
                }
                else
                {
                    <span>@Localizer["RateDetails"]</span>
                }
            </h5>
            <button type="button" class="btn-close" @onclick="Close"></button>
        </div>

        <div class="offcanvas-body">
            @if (Rate != null)
            {
                @* Provider Info *@
                <div class="mb-4">
                    <h6 class="text-muted mb-2">@Localizer["Provider"]</h6>
                    <div class="d-flex align-items-center gap-2">
                        <i class="@GetProviderIcon(Rate.ProviderCode)"></i>
                        <span class="fw-medium">@GetProviderName(Rate.ProviderCode)</span>
                        @if (Rate.ProviderUpdatedOn.HasValue)
                        {
                            <span class="text-muted small ms-2">
                                @Rate.ProviderUpdatedOn.Value.ToString("g")
                            </span>
                        }
                    </div>
                </div>

                @* Denominations *@
                <div class="mb-4">
                    <h6 class="text-muted mb-2">@Localizer["Denominations"]</h6>
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var denom in Rate.DenominationsDisplay.Split(',').Select(d => d.Trim()))
                        {
                            <span class="badge bg-azure-lt">@denom</span>
                        }
                    </div>
                </div>

                @* Rate Breakdown Table *@
                <div class="mb-4">
                    <h6 class="text-muted mb-2">@Localizer["RateBreakdown"]</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th></th>
                                    <th class="text-end">@Localizer["Buy"]</th>
                                    <th class="text-end">@Localizer["Sell"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>@Localizer["ProviderRate"]</td>
                                    <td class="text-end font-monospace">@Rate.ProviderBuyRate.ToString("N4")</td>
                                    <td class="text-end font-monospace">@Rate.ProviderSellRate.ToString("N4")</td>
                                </tr>
                                <tr>
                                    <td>@Localizer["Delta"]</td>
                                    <td class="text-end">
                                        <span class="@GetDeltaClass(Rate.BuyDelta)">
                                            @FormatDelta(Rate.BuyDelta)
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span class="@GetDeltaClass(Rate.SellDelta)">
                                            @FormatDelta(Rate.SellDelta)
                                        </span>
                                    </td>
                                </tr>
                                <tr class="table-primary fw-bold">
                                    <td>@Localizer["FinalRate"]</td>
                                    <td class="text-end font-monospace">@Rate.BuyRate.ToString("N4")</td>
                                    <td class="text-end font-monospace">@Rate.SellRate.ToString("N4")</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                @* Shop Override Indicator *@
                @if (IsShopOverride)
                {
                    <div class="alert alert-info mb-4">
                        <div class="d-flex">
                            <i class="ti ti-building-store me-2"></i>
                            <div>@Localizer["ShopOverrideNote"]</div>
                        </div>
                    </div>
                }

                @* Quick Calculator *@
                <div class="mb-4">
                    <h6 class="text-muted mb-2">@Localizer["QuickCalculator"]</h6>
                    <div class="input-group mb-2">
                        <input type="number"
                               class="form-control"
                               @bind="m_calcAmount"
                               @bind:event="oninput"
                               @bind:after="Calculate"
                               placeholder="@Localizer["EnterAmount"]"
                               min="0"
                               step="any" />
                        <span class="input-group-text">@Rate.Currency</span>
                    </div>

                    @if (m_calcAmount > 0)
                    {
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="row g-2 text-center">
                                    <div class="col-6">
                                        <div class="text-muted small">@Localizer["WeBuy"]</div>
                                        <div class="h4 mb-0 text-green">@m_buyResult.ToString("N2")</div>
                                        <div class="text-muted small">THB</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted small">@Localizer["WeSell"]</div>
                                        <div class="h4 mb-0 text-blue">@m_sellResult.ToString("N2")</div>
                                        <div class="text-muted small">THB</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @* Effective Period *@
                <div class="text-muted small">
                    <i class="ti ti-clock me-1"></i>
                    <span>@Localizer["EffectiveSince"]:</span> @Rate.EffectiveDate.ToString("g")
                    @if (Rate.ExpiresOn.HasValue)
                    {
                        <br />
                        <i class="ti ti-clock-x me-1"></i>
                        <span>@Localizer["ExpiresOn"]:</span> @Rate.ExpiresOn.Value.ToString("g")
                    }
                </div>
            }
            else
            {
                <div class="text-center text-muted py-4">
                    @Localizer["SelectRateToView"]
                </div>
            }
        </div>
    </div>
}

@code {
    /// <summary>
    /// The denomination rate to display
    /// </summary>
    [Parameter] public DenominationRate? Rate { get; set; }

    /// <summary>
    /// Whether this is a shop-specific override
    /// </summary>
    [Parameter] public bool IsShopOverride { get; set; }

    /// <summary>
    /// Whether the flyout is open
    /// </summary>
    [Parameter] public bool IsOpen { get; set; }

    /// <summary>
    /// Callback when flyout closes
    /// </summary>
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }

    private decimal m_calcAmount;
    private decimal m_buyResult;
    private decimal m_sellResult;

    private void Close()
    {
        this.IsOpen = false;
        _ = this.IsOpenChanged.InvokeAsync(false);
    }

    private void Calculate()
    {
        if (this.Rate == null || this.m_calcAmount <= 0)
        {
            this.m_buyResult = 0;
            this.m_sellResult = 0;
            return;
        }

        this.m_buyResult = this.m_calcAmount * this.Rate.BuyRate;
        this.m_sellResult = this.m_calcAmount * this.Rate.SellRate;
    }

    private static string GetCurrencyFlag(string currency) => currency switch
    {
        "THB" => "\U0001F1F9\U0001F1ED",
        "USD" => "\U0001F1FA\U0001F1F8",
        "EUR" => "\U0001F1EA\U0001F1FA",
        "GBP" => "\U0001F1EC\U0001F1E7",
        "CNY" => "\U0001F1E8\U0001F1F3",
        "JPY" => "\U0001F1EF\U0001F1F5",
        "AUD" => "\U0001F1E6\U0001F1FA",
        "RUB" => "\U0001F1F7\U0001F1FA",
        _ => "\U0001F4B0"
    };

    private static string GetProviderIcon(string providerCode) => providerCode switch
    {
        RateProviderCodes.MamyExchange => "ti ti-currency-baht text-primary",
        RateProviderCodes.SuperRich => "ti ti-crown text-warning",
        _ => "ti ti-edit text-muted"
    };

    private static string GetProviderName(string providerCode) =>
        RateProviderCodes.GetDisplayName(providerCode);

    private static string GetDeltaClass(decimal delta)
    {
        if (delta == 0) return "text-muted";
        return delta > 0 ? "text-success" : "text-danger";
    }

    private static string FormatDelta(decimal delta)
    {
        if (delta == 0) return "0.00";
        var sign = delta > 0 ? "+" : "";
        return $"{sign}{delta:N4}";
    }
}
