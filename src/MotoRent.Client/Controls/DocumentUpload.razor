@using System.Net.Http.Headers
@using System.Text.Json
@using MotoRent.Services
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudPaper Outlined="true" Class="pa-4">
    <MudStack Spacing="3">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">@GetDocumentTypeLabel()</MudText>
            @if (m_extractedData != null && !string.IsNullOrEmpty(m_extractedData.FullName))
            {
                <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.Check">
                    Data Extracted
                </MudChip>
            }
        </MudStack>

        @if (string.IsNullOrEmpty(m_previewUrl))
        {
            <!-- Upload Area -->
            <MudFileUpload T="IBrowserFile" Accept="image/*,.pdf" MaximumFileCount="1"
                           FilesChanged="OnFileSelected" Class="flex-1">
                <ActivatorContent>
                    <MudPaper Height="200px" Outlined="true" Class="d-flex flex-column align-center justify-center cursor-pointer hover-highlight"
                              Style="border-style: dashed;">
                        @if (m_uploading)
                        {
                            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
                            <MudText Class="mt-2">Processing document...</MudText>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Large" Color="Color.Primary" />
                            <MudText Class="mt-2">Click to upload or take a photo</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Supported: JPG, PNG, PDF (max 10MB)
                            </MudText>
                        }
                    </MudPaper>
                </ActivatorContent>
            </MudFileUpload>

            <!-- Camera Button (Mobile) -->
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                       StartIcon="@Icons.Material.Filled.PhotoCamera"
                       OnClick="OpenCamera" Disabled="m_uploading">
                Take Photo with Camera
            </MudButton>
            <input type="file" @ref="m_cameraInput" accept="image/*" capture="environment"
                   @onchange="OnCameraCapture" style="display: none;" />
        }
        else
        {
            <!-- Preview Area -->
            <MudStack>
                <MudImage Src="@m_previewUrl" Alt="Document preview" ObjectFit="ObjectFit.Contain"
                          Height="200" Class="rounded-lg" Style="max-width: 100%;" />

                <MudStack Row="true" Spacing="2" Justify="Justify.Center">
                    <MudButton Variant="Variant.Text" Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.Delete"
                               OnClick="ClearDocument" Disabled="m_uploading">
                        Remove
                    </MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="RetryOcr" Disabled="m_uploading">
                        Retry OCR
                    </MudButton>
                </MudStack>
            </MudStack>
        }

        @if (m_extractedData != null)
        {
            <!-- Extracted Data Preview -->
            <MudExpansionPanels>
                <MudExpansionPanel Text="Extracted Information" IsInitiallyExpanded="true">
                    <MudSimpleTable Dense="true" Hover="true">
                        <tbody>
                            @if (!string.IsNullOrEmpty(m_extractedData.FullName))
                            {
                                <tr>
                                    <td><strong>Full Name</strong></td>
                                    <td>@m_extractedData.FullName</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.DocumentNumber))
                            {
                                <tr>
                                    <td><strong>@GetDocumentNumberLabel()</strong></td>
                                    <td>@m_extractedData.DocumentNumber</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Nationality))
                            {
                                <tr>
                                    <td><strong>Nationality</strong></td>
                                    <td>@m_extractedData.Nationality</td>
                                </tr>
                            }
                            @if (m_extractedData.DateOfBirth.HasValue)
                            {
                                <tr>
                                    <td><strong>Date of Birth</strong></td>
                                    <td>@m_extractedData.DateOfBirth.Value.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                            @if (m_extractedData.DateOfExpiry.HasValue)
                            {
                                <tr>
                                    <td><strong>Expiry Date</strong></td>
                                    <td>@m_extractedData.DateOfExpiry.Value.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.IssuingCountry))
                            {
                                <tr>
                                    <td><strong>Issuing Country</strong></td>
                                    <td>@m_extractedData.IssuingCountry</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(m_extractedData.Gender))
                            {
                                <tr>
                                    <td><strong>Gender</strong></td>
                                    <td>@m_extractedData.Gender</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>

                    @if (!string.IsNullOrEmpty(m_extractedData.Error))
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            OCR Error: @m_extractedData.Error
                        </MudAlert>
                    }

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-3"
                               FullWidth="true" OnClick="ApplyExtractedData"
                               Disabled="@(m_extractedData.FullName == null)">
                        Apply to Form
                    </MudButton>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public string DocumentType { get; set; } = "Passport";

    [Parameter]
    public int? RenterId { get; set; }

    [Parameter]
    public EventCallback<ExtractedDocumentData> OnDataExtracted { get; set; }

    [Parameter]
    public EventCallback<DocumentUploadResult> OnDocumentUploaded { get; set; }

    private ElementReference m_cameraInput;
    private string? m_previewUrl;
    private string? m_uploadedFilePath;
    private ExtractedDocumentData? m_extractedData;
    private bool m_uploading;

    private string GetDocumentTypeLabel() => DocumentType switch
    {
        "Passport" => "Passport",
        "NationalId" => "National ID Card",
        "DrivingLicense" => "Driving License",
        _ => "Document"
    };

    private string GetDocumentNumberLabel() => DocumentType switch
    {
        "Passport" => "Passport Number",
        "NationalId" => "ID Number",
        "DrivingLicense" => "License Number",
        _ => "Document Number"
    };

    private async Task OnFileSelected(IBrowserFile file)
    {
        if (file == null) return;
        await ProcessFile(file);
    }

    private async Task OnCameraCapture(ChangeEventArgs e)
    {
        // Camera capture handled via JS interop
        // This is a fallback for HTML5 camera input
    }

    private async Task OpenCamera()
    {
        // Trigger the hidden camera input
        // await JS.InvokeVoidAsync("document.getElementById('camera-input').click");
    }

    private async Task ProcessFile(IBrowserFile file)
    {
        if (file.Size > 10 * 1024 * 1024)
        {
            Snackbar.Add("File size exceeds 10MB limit", Severity.Error);
            return;
        }

        m_uploading = true;
        StateHasChanged();

        try
        {
            // Create form data
            var content = new MultipartFormDataContent();

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            var fileContent = new StreamContent(ms);
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);
            content.Add(new StringContent(DocumentType), "documentType");

            if (RenterId.HasValue)
            {
                content.Add(new StringContent(RenterId.Value.ToString()), "renterId");
            }

            // Upload to API
            var response = await Http.PostAsync("/api/documents/upload", content);

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<DocumentUploadResponse>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (result != null)
                {
                    m_extractedData = result.ExtractedData;
                    m_uploadedFilePath = result.FilePath;

                    // Create preview URL
                    var buffer = new byte[ms.Length];
                    ms.Position = 0;
                    await ms.ReadAsync(buffer);
                    m_previewUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";

                    // Notify parent
                    await OnDocumentUploaded.InvokeAsync(new DocumentUploadResult
                    {
                        DocumentId = result.DocumentId,
                        FilePath = result.FilePath,
                        ExtractedData = result.ExtractedData
                    });

                    if (m_extractedData != null && !string.IsNullOrEmpty(m_extractedData.FullName))
                    {
                        Snackbar.Add("Document processed successfully", Severity.Success);
                    }
                    else
                    {
                        Snackbar.Add("Document uploaded. OCR extraction may need manual verification.", Severity.Info);
                    }
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Upload failed: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error processing document: {ex.Message}", Severity.Error);
        }
        finally
        {
            m_uploading = false;
            StateHasChanged();
        }
    }

    private void ClearDocument()
    {
        m_previewUrl = null;
        m_extractedData = null;
        m_uploadedFilePath = null;
    }

    private async Task RetryOcr()
    {
        if (string.IsNullOrEmpty(m_uploadedFilePath)) return;

        // TODO: Call reprocess endpoint
        Snackbar.Add("Retrying OCR...", Severity.Info);
    }

    private async Task ApplyExtractedData()
    {
        if (m_extractedData != null)
        {
            await OnDataExtracted.InvokeAsync(m_extractedData);
            Snackbar.Add("Data applied to form", Severity.Success);
        }
    }

    private class DocumentUploadResponse
    {
        public int? DocumentId { get; set; }
        public string FilePath { get; set; } = string.Empty;
        public ExtractedDocumentData? ExtractedData { get; set; }
    }
}
