@using System.Net.Http.Headers
@using System.Text.Json
@using MotoRent.Services
@inherits MotoRentComponentBase
@inject HttpClient Http

<div class="card">
    <div class="card-body">
        <div class="d-flex flex-column gap-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">@GetDocumentTypeLabel()</h5>
                @if (m_extractedData != null && !string.IsNullOrEmpty(m_extractedData.FullName))
                {
                    <span class="badge bg-success">
                        <i class="ti ti-check me-1"></i>
                        Data Extracted
                    </span>
                }
            </div>

            @if (string.IsNullOrEmpty(m_previewUrl))
            {
                <!-- Upload Area -->
                <div class="upload-dropzone d-flex flex-column align-items-center justify-content-center"
                     style="height: 200px; border: 2px dashed var(--tblr-border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                     @onclick="TriggerFileSelect">
                    @if (m_uploading)
                    {
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <span class="mt-2">Processing document...</span>
                    }
                    else
                    {
                        <i class="ti ti-cloud-upload text-primary" style="font-size: 3rem;"></i>
                        <span class="mt-2">Click to upload or take a photo</span>
                        <small class="text-secondary">
                            Supported: JPG, PNG, PDF (max 10MB)
                        </small>
                    }
                </div>

                <InputFile @ref="m_fileInput" OnChange="OnFileSelected" accept="image/*,.pdf"
                           style="display: none;" />

                <!-- Camera Button (Mobile) -->
                <button type="button" class="btn btn-outline-primary w-100" @onclick="OpenCamera"
                        disabled="@m_uploading">
                    <i class="ti ti-camera me-2"></i>
                    Take Photo with Camera
                </button>
                <input type="file" @ref="m_cameraInput" accept="image/*" capture="environment"
                       @onchange="OnCameraCapture" style="display: none;" />
            }
            else
            {
                <!-- Preview Area -->
                <div class="d-flex flex-column gap-2">
                    <div class="text-center">
                        <img src="@m_previewUrl" alt="Document preview"
                             style="max-height: 200px; max-width: 100%; border-radius: 8px; object-fit: contain;" />
                    </div>

                    <div class="d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-ghost-danger" @onclick="ClearDocument"
                                disabled="@m_uploading">
                            <i class="ti ti-trash me-1"></i>
                            Remove
                        </button>
                        <button type="button" class="btn btn-ghost-primary" @onclick="RetryOcr"
                                disabled="@m_uploading">
                            <i class="ti ti-refresh me-1"></i>
                            Retry OCR
                        </button>
                    </div>
                </div>
            }

            @if (m_extractedData != null)
            {
                <!-- Extracted Data Preview -->
                <div class="accordion" id="extractedDataAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#extractedDataPanel" aria-expanded="true">
                                Extracted Information
                            </button>
                        </h2>
                        <div id="extractedDataPanel" class="accordion-collapse collapse show">
                            <div class="accordion-body p-0">
                                <table class="table table-vcenter table-sm mb-0">
                                    <tbody>
                                        @if (!string.IsNullOrEmpty(m_extractedData.FullName))
                                        {
                                            <tr>
                                                <td class="fw-semibold" style="width: 40%;">Full Name</td>
                                                <td>@m_extractedData.FullName</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(m_extractedData.DocumentNumber))
                                        {
                                            <tr>
                                                <td class="fw-semibold">@GetDocumentNumberLabel()</td>
                                                <td>@m_extractedData.DocumentNumber</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(m_extractedData.Nationality))
                                        {
                                            <tr>
                                                <td class="fw-semibold">Nationality</td>
                                                <td>@m_extractedData.Nationality</td>
                                            </tr>
                                        }
                                        @if (m_extractedData.DateOfBirth.HasValue)
                                        {
                                            <tr>
                                                <td class="fw-semibold">Date of Birth</td>
                                                <td>@m_extractedData.DateOfBirth.Value.ToString("yyyy-MM-dd")</td>
                                            </tr>
                                        }
                                        @if (m_extractedData.DateOfExpiry.HasValue)
                                        {
                                            <tr>
                                                <td class="fw-semibold">Expiry Date</td>
                                                <td>@m_extractedData.DateOfExpiry.Value.ToString("yyyy-MM-dd")</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(m_extractedData.IssuingCountry))
                                        {
                                            <tr>
                                                <td class="fw-semibold">Issuing Country</td>
                                                <td>@m_extractedData.IssuingCountry</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(m_extractedData.Gender))
                                        {
                                            <tr>
                                                <td class="fw-semibold">Gender</td>
                                                <td>@m_extractedData.Gender</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                                @if (!string.IsNullOrEmpty(m_extractedData.Error))
                                {
                                    <div class="alert alert-warning m-3">
                                        <i class="ti ti-alert-triangle me-2"></i>
                                        OCR Error: @m_extractedData.Error
                                    </div>
                                }

                                <div class="p-3">
                                    <button type="button" class="btn btn-primary w-100" @onclick="ApplyExtractedData"
                                            disabled="@(m_extractedData.FullName == null)">
                                        Apply to Form
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .upload-dropzone:hover {
        border-color: var(--tblr-primary) !important;
        background: var(--tblr-bg-surface-secondary);
    }
</style>

@code {
    [Parameter]
    public string DocumentType { get; set; } = "Passport";

    [Parameter]
    public int? RenterId { get; set; }

    [Parameter]
    public EventCallback<ExtractedDocumentData> OnDataExtracted { get; set; }

    [Parameter]
    public EventCallback<DocumentUploadResult> OnDocumentUploaded { get; set; }

    private InputFile? m_fileInput;
    private ElementReference m_cameraInput;
    private string? m_previewUrl;
    private string? m_uploadedFilePath;
    private ExtractedDocumentData? m_extractedData;
    private bool m_uploading;

    private string GetDocumentTypeLabel() => this.DocumentType switch
    {
        "Passport" => "Passport",
        "NationalId" => "National ID Card",
        "DrivingLicense" => "Driving License",
        _ => "Document"
    };

    private string GetDocumentNumberLabel() => this.DocumentType switch
    {
        "Passport" => "Passport Number",
        "NationalId" => "ID Number",
        "DrivingLicense" => "License Number",
        _ => "Document Number"
    };

    private async Task TriggerFileSelect()
    {
        // Trigger file input click via JS
        // This would need JS interop to work
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        await this.ProcessFile(file);
    }

    private async Task OnCameraCapture(ChangeEventArgs e)
    {
        // Camera capture handled via JS interop
        // This is a fallback for HTML5 camera input
    }

    private async Task OpenCamera()
    {
        // Trigger the hidden camera input
        // await JS.InvokeVoidAsync("document.getElementById('camera-input').click");
    }

    private async Task ProcessFile(IBrowserFile file)
    {
        if (file.Size > 10 * 1024 * 1024)
        {
            this.ShowError("File size exceeds 10MB limit");
            return;
        }

        this.m_uploading = true;
        this.StateHasChanged();

        try
        {
            // Create form data
            var content = new MultipartFormDataContent();

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            ms.Position = 0;

            var fileContent = new StreamContent(ms);
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);
            content.Add(new StringContent(this.DocumentType), "documentType");

            if (this.RenterId.HasValue)
            {
                content.Add(new StringContent(this.RenterId.Value.ToString()), "renterId");
            }

            // Upload to API
            var response = await this.Http.PostAsync("/api/documents/upload", content);

            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<DocumentUploadResponse>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (result != null)
                {
                    this.m_extractedData = result.ExtractedData;
                    this.m_uploadedFilePath = result.FilePath;

                    // Create preview URL
                    var buffer = new byte[ms.Length];
                    ms.Position = 0;
                    await ms.ReadAsync(buffer);
                    this.m_previewUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";

                    // Notify parent
                    await this.OnDocumentUploaded.InvokeAsync(new DocumentUploadResult
                    {
                        DocumentId = result.DocumentId,
                        FilePath = result.FilePath,
                        ExtractedData = result.ExtractedData
                    });

                    if (this.m_extractedData != null && !string.IsNullOrEmpty(this.m_extractedData.FullName))
                    {
                        this.ShowSuccess("Document processed successfully");
                    }
                    else
                    {
                        this.ShowInfo("Document uploaded. OCR extraction may need manual verification.");
                    }
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                this.ShowError($"Upload failed: {error}");
            }
        }
        catch (Exception ex)
        {
            this.ShowError($"Error processing document: {ex.Message}");
        }
        finally
        {
            this.m_uploading = false;
            this.StateHasChanged();
        }
    }

    private void ClearDocument()
    {
        this.m_previewUrl = null;
        this.m_extractedData = null;
        this.m_uploadedFilePath = null;
    }

    private async Task RetryOcr()
    {
        if (string.IsNullOrEmpty(this.m_uploadedFilePath)) return;

        // TODO: Call reprocess endpoint
        this.ShowInfo("Retrying OCR...");
    }

    private async Task ApplyExtractedData()
    {
        if (this.m_extractedData != null)
        {
            await this.OnDataExtracted.InvokeAsync(this.m_extractedData);
            this.ShowSuccess("Data applied to form");
        }
    }

    private class DocumentUploadResponse
    {
        public int? DocumentId { get; set; }
        public string FilePath { get; set; } = string.Empty;
        public ExtractedDocumentData? ExtractedData { get; set; }
    }
}
