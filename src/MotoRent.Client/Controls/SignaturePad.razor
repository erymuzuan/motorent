@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<MudPaper Outlined="true" Class="signature-pad-container" Style="@GetContainerStyle()">
    <canvas @ref="m_canvasRef" id="@m_canvasId"
            style="width: 100%; height: @(Height)px; cursor: crosshair; touch-action: none;"
            @onmousedown="OnMouseDown"
            @onmousemove="OnMouseMove"
            @onmouseup="OnMouseUp"
            @onmouseleave="OnMouseUp"
            @ontouchstart="OnTouchStart"
            @ontouchmove="OnTouchMove"
            @ontouchend="OnTouchEnd"
            @ontouchstart:preventDefault="true"
            @ontouchmove:preventDefault="true">
    </canvas>
</MudPaper>

@code {
    [Parameter] public string Width { get; set; } = "100%";
    [Parameter] public int Height { get; set; } = 200;
    [Parameter] public string StrokeColor { get; set; } = "#000000";
    [Parameter] public int StrokeWidth { get; set; } = 2;
    [Parameter] public EventCallback<string> OnSignatureChanged { get; set; }

    private ElementReference m_canvasRef;
    private string m_canvasId = $"signature-canvas-{Guid.NewGuid():N}";
    private IJSObjectReference? m_jsModule;
    private bool m_isDrawing;
    private double m_lastX;
    private double m_lastY;
    private bool m_hasSignature;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            m_jsModule = await JS.InvokeAsync<IJSObjectReference>("import",
                "./_content/MotoRent.Client/js/signature-pad.js");

            await m_jsModule.InvokeVoidAsync("initCanvas", m_canvasRef, StrokeColor, StrokeWidth);
        }
    }

    private string GetContainerStyle()
    {
        return $"width: {Width}; background-color: white; border-radius: 4px;";
    }

    private async Task OnMouseDown(MouseEventArgs e)
    {
        m_isDrawing = true;
        var pos = await GetCanvasPosition(e.ClientX, e.ClientY);
        m_lastX = pos.x;
        m_lastY = pos.y;
    }

    private async Task OnMouseMove(MouseEventArgs e)
    {
        if (!m_isDrawing) return;

        var pos = await GetCanvasPosition(e.ClientX, e.ClientY);
        await DrawLine(m_lastX, m_lastY, pos.x, pos.y);
        m_lastX = pos.x;
        m_lastY = pos.y;
        m_hasSignature = true;
    }

    private async Task OnMouseUp(MouseEventArgs e)
    {
        if (m_isDrawing && m_hasSignature)
        {
            m_isDrawing = false;
            await NotifySignatureChanged();
        }
        m_isDrawing = false;
    }

    private async Task OnTouchStart(TouchEventArgs e)
    {
        if (e.Touches.Length > 0)
        {
            m_isDrawing = true;
            var touch = e.Touches[0];
            var pos = await GetCanvasPosition(touch.ClientX, touch.ClientY);
            m_lastX = pos.x;
            m_lastY = pos.y;
        }
    }

    private async Task OnTouchMove(TouchEventArgs e)
    {
        if (!m_isDrawing || e.Touches.Length == 0) return;

        var touch = e.Touches[0];
        var pos = await GetCanvasPosition(touch.ClientX, touch.ClientY);
        await DrawLine(m_lastX, m_lastY, pos.x, pos.y);
        m_lastX = pos.x;
        m_lastY = pos.y;
        m_hasSignature = true;
    }

    private async Task OnTouchEnd(TouchEventArgs e)
    {
        if (m_isDrawing && m_hasSignature)
        {
            m_isDrawing = false;
            await NotifySignatureChanged();
        }
        m_isDrawing = false;
    }

    private async Task<(double x, double y)> GetCanvasPosition(double clientX, double clientY)
    {
        if (m_jsModule == null) return (0, 0);

        var result = await m_jsModule.InvokeAsync<double[]>("getCanvasPosition", m_canvasRef, clientX, clientY);
        return (result[0], result[1]);
    }

    private async Task DrawLine(double x1, double y1, double x2, double y2)
    {
        if (m_jsModule == null) return;
        await m_jsModule.InvokeVoidAsync("drawLine", m_canvasRef, x1, y1, x2, y2);
    }

    private async Task NotifySignatureChanged()
    {
        if (m_jsModule == null) return;

        var dataUrl = await m_jsModule.InvokeAsync<string>("getSignatureData", m_canvasRef);
        await OnSignatureChanged.InvokeAsync(dataUrl);
    }

    public async Task Clear()
    {
        if (m_jsModule == null) return;
        await m_jsModule.InvokeVoidAsync("clearCanvas", m_canvasRef);
        m_hasSignature = false;
        await OnSignatureChanged.InvokeAsync(null);
    }

    public async Task<string?> GetSignatureData()
    {
        if (m_jsModule == null || !m_hasSignature) return null;
        return await m_jsModule.InvokeAsync<string>("getSignatureData", m_canvasRef);
    }

    public async ValueTask DisposeAsync()
    {
        if (m_jsModule != null)
        {
            await m_jsModule.DisposeAsync();
        }
    }
}
