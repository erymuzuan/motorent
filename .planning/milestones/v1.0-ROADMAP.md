# Milestone v1.0: Cashier Till & End of Day Reconciliation

**Status:** SHIPPED 2026-01-21
**Phases:** 1-9
**Total Plans:** 29

## Overview

Transform MotoRent's existing single-currency till system into a full multi-currency cash management solution for Thailand's tourist rental market. The roadmap progresses from foundational exchange rate infrastructure through operational workflows, manager oversight, and end-of-day reconciliation. Each phase delivers a complete, verifiable capability.

**Till Workflow Vision:** Staff use a unified transaction flow where they search for a booking/rental, review and edit items in a fullscreen confirmation screen, then process multi-currency split payments through a dedicated payment terminal.

## Phases

### Phase 1: Exchange Rate Foundation

**Goal:** Operators can configure and manage exchange rates for foreign currency acceptance.
**Depends on:** None (foundation phase)
**Plans:** 4 plans

Plans:
- [x] 01-01-PLAN.md — Entity, service, SQL table foundation
- [x] 01-02-PLAN.md — Manager settings page for rate management
- [x] 01-03-PLAN.md — Staff exchange rate panel with calculator
- [x] 01-04-PLAN.md — Gap closure: Wire panel to Till, add nav link

**Requirements:**
- RATE-01: System fetches exchange rates from Forex POS API as default
- RATE-02: Manager can override exchange rate per currency (custom rate takes precedence)
- RATE-03: Exchange rate source (API vs manual) is tracked for audit
- RATE-04: Exchange rate is stored on each transaction for audit trail
- RATE-05: Staff can view current exchange rates during payment acceptance

---

### Phase 2: Multi-Currency Till Operations

**Goal:** Staff can operate a till with per-currency balance tracking throughout their shift.
**Depends on:** Phase 1 (exchange rates must exist)
**Plans:** 3 plans

Plans:
- [x] 02-01-PLAN.md — Entity extensions and TillService multi-currency methods
- [x] 02-02-PLAN.md — Payment dialog with currency selection and denomination entry
- [x] 02-03-PLAN.md — Currency balance panel and multi-currency cash drop

**Requirements:**
- TILL-01: Staff can open till with starting float per currency (THB, USD, EUR, CNY)
- TILL-02: Staff can receive payment in any supported currency with exchange rate applied
- TILL-03: System displays THB change amount when customer pays with foreign currency
- TILL-04: Staff can view current till balance per currency during shift
- TILL-05: Staff can perform cash drop per currency with amount recorded

---

### Phase 3: Transaction Search & Item Confirmation

**Goal:** Staff can start a transaction by searching for a booking/rental and reviewing/editing items before payment.
**Depends on:** Phase 2 (till session must be open for transaction entry)
**Plans:** 2 plans

Plans:
- [x] 03-01-PLAN.md — Transaction search dialog with booking/rental search and auto-detect
- [x] 03-02-PLAN.md — Fullscreen item confirmation with accessory/insurance/discount editing

**Requirements:**
- TXSEARCH-01: Staff can search for bookings or rentals by reference, customer name, or phone
- TXSEARCH-02: System auto-detects transaction type from entity status (booking deposit, check-in, check-out)
- ITEMS-01: Staff sees full summary (customer, vehicle, dates, line items) in fullscreen dialog
- ITEMS-02: Staff can add/remove accessories from the transaction
- ITEMS-03: Staff can change insurance package
- ITEMS-04: Staff can apply percentage or fixed discounts with reason
- ITEMS-05: Item confirmation uses responsive layout (two columns tablet/PC, stacked mobile)

---

### Phase 4: Payment Terminal Redesign

**Goal:** Staff can receive multi-currency split payments through a unified payment terminal.
**Depends on:** Phase 3 (item confirmation must provide total amount due)
**Plans:** 3 plans

Plans:
- [x] 04-01-PLAN.md — Payment terminal panel UI foundation with layout and tabs
- [x] 04-02-PLAN.md — THB keypad and foreign currency denomination input
- [x] 04-03-PLAN.md — Payment completion flow with till recording

**Requirements:**
- PAY-01: Payment terminal shows amount due in THB prominently
- PAY-02: THB input uses numeric keypad with quick amounts
- PAY-03: Foreign currency input (USD, EUR, CNY) uses denomination counting
- PAY-04: Staff can mix cash payments across multiple currencies in same transaction
- PAY-05: Staff can mix cash + non-cash (card, PromptPay, bank transfer) in same transaction
- PAY-06: Running total shows all payment entries with THB equivalents
- PAY-07: Change calculation always in THB
- PAY-08: Green indicators show which currencies/methods have entries

---

### Phase 5: Refunds & Corrections

**Goal:** Staff can process refunds and void transactions with manager PIN approval.
**Depends on:** Phase 4 (payment terminal must support receiving payments first)
**Plans:** 5 plans

Plans:
- [x] 05-01-PLAN.md — Domain entity extensions (TillTransaction void fields, User PIN fields)
- [x] 05-02-PLAN.md — ManagerPinService and TillService void/refund methods
- [x] 05-03-PLAN.md — ManagerPinDialog component for PIN entry
- [x] 05-04-PLAN.md — VoidTransactionDialog for void initiation
- [x] 05-05-PLAN.md — Till.razor void workflow integration

**Requirements:**
- REFUND-01: Security deposit refunds at check-out
- REFUND-02: Overpayment refunds when customer pays too much
- VOID-01: Transaction reversals require manager approval
- VOID-02: Manager can approve void via PIN entry or session authentication
- VOID-03: Voided transactions are marked but preserved for audit trail

---

### Phase 6: Denomination Counting

**Goal:** Staff can count cash by denomination for accurate float verification and closing counts.
**Depends on:** Phase 4 (payment terminal already uses denomination counting)
**Plans:** 3 plans

Plans:
- [x] 06-01-PLAN.md — Domain entity and TillService extension for denomination counts
- [x] 06-02-PLAN.md — Opening float denomination panel and dialog integration
- [x] 06-03-PLAN.md — Closing count denomination panel with variance display

**Requirements:**
- DENOM-01: Staff enters opening float by denomination (bills and coins per currency)
- DENOM-02: Staff enters closing count by denomination (bills and coins per currency)
- DENOM-03: System auto-calculates total from denomination breakdown

---

### Phase 7: Till Closing and Reconciliation

**Goal:** Staff can close their till with per-currency variance tracking for accountability.
**Depends on:** Phase 6 (denomination counting for accurate close)
**Plans:** 2 plans

Plans:
- [x] 07-01-PLAN.md — Domain layer: TillSession close metadata, TillService close methods
- [x] 07-02-PLAN.md — UI layer: Summary review step, localization

**Requirements:**
- TILL-06: Staff can close till with counted amount per currency
- TILL-07: System calculates variance (expected vs actual) per currency at close

---

### Phase 8: Manager Oversight

**Goal:** Managers have visibility into all till sessions and can verify reconciliation.
**Depends on:** Phase 7 (till sessions must be closable with variance)
**Plans:** 3 plans

Plans:
- [x] 08-01-PLAN.md — TillService manager extensions (variance threshold, query methods)
- [x] 08-02-PLAN.md — Manager dashboard UI (active sessions, closed sessions table)
- [x] 08-03-PLAN.md — Shift handover report (sales clearing journal format)

**Requirements:**
- MGR-01: Manager can view dashboard of all open and closed till sessions
- MGR-02: Manager can verify closed till sessions (sign-off workflow)
- MGR-03: Manager receives alert when till variance exceeds threshold
- MGR-04: Manager can generate shift handover report

---

### Phase 9: End of Day Operations

**Goal:** Managers can perform daily close with full audit trail and cash verification.
**Depends on:** Phase 8 (manager oversight tools must exist)
**Plans:** 4 plans

Plans:
- [x] 09-01-PLAN.md — Domain entities (DailyClose, ShortageLog) and EOD service methods
- [x] 09-02-PLAN.md — Cash drop verification dialog and EOD page integration
- [x] 09-03-PLAN.md — Daily close page with shortage logging and summary report
- [x] 09-04-PLAN.md — Staff receipt search and reprint page

**Requirements:**
- EOD-01: Manager can verify cash drops from all tills against safe contents
- EOD-02: Manager can perform daily sales close (lock the day)
- EOD-03: Daily close generates summary of all sales, deposits, payouts, and variances
- EOD-04: Closed days cannot have new transactions added
- RCPT-01: System generates receipt for till transactions
- RCPT-02: Staff can search and view past till transactions
- RCPT-03: Staff can reprint receipts

---

## Milestone Summary

**Key Decisions:**

- Base currency THB (Thailand market, rental rates always in THB)
- Change always in THB (simplifies till reconciliation)
- Per-currency till tracking (matches forex expertise)
- Scoped cart (1 booking/rental per receipt)
- Manager PIN for void approval (quick authorization)
- Denomination counting at open/close (accurate verification)
- Daily close locking (prevents backdating)

**Issues Resolved:**

- Multi-currency balance tracking implemented
- Variance calculation per currency at close
- Manager PIN service with lockout protection
- Daily close preventing new sessions on closed days

**Technical Debt Incurred:**

- RATE-01: Forex POS API fetch stub (external API docs not available, manual rates work)

---

*For current project status, see .planning/PROJECT.md*

---
*Archived: 2026-01-21 as part of v1.0 milestone completion*
