---
phase: 07-till-closing-reconciliation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor
  - src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.th.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.ms.resx
autonomous: true

must_haves:
  truths:
    - "Staff sees summary step with per-currency variance before confirming close"
    - "Summary shows Expected, Counted, Variance columns per currency"
    - "Variance displays with color coding (green=exact, red=short, blue=over)"
    - "Staff can go back from summary to edit denomination count"
    - "Dialog uses new CloseSessionAsync overload with breakdowns"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor"
      provides: "Close dialog with summary step"
      contains: "m_showSummary"
    - path: "src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.resx"
      provides: "Base localization"
      contains: "ClosingSummary"
    - path: "src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.th.resx"
      provides: "Thai localization"
      contains: "ClosingSummary"
  key_links:
    - from: "TillCloseSessionDialog.razor"
      to: "TillService.CloseSessionAsync"
      via: "Method call with m_currencyBreakdowns"
      pattern: "CloseSessionAsync.*m_currencyBreakdowns"
---

<objective>
Add a summary review step to TillCloseSessionDialog showing per-currency variance before close confirmation.

Purpose: Give staff a clear final review of all currency variances before committing the close, as per CONTEXT.md decision "Summary review then confirm".

Output:
- Two-step close workflow: Count -> Summary -> Confirm
- Per-currency variance table with color coding
- Overall variance in THB at bottom
- Updated SaveAsync using new CloseSessionAsync overload
- Localization for English, Thai, and Malay
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-till-closing-reconciliation/07-CONTEXT.md
@.planning/phases/07-till-closing-reconciliation/07-RESEARCH.md

@src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor
@src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.resx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add summary step to TillCloseSessionDialog</name>
  <files>src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor</files>
  <action>
Modify TillCloseSessionDialog to add a summary step between denomination entry and confirm. The workflow becomes:
1. Step 1: Denomination entry (ClosingCountPanel - existing)
2. Step 2: Summary review (new) - shows all currencies with Expected/Counted/Variance
3. Confirm button on summary step closes session

Changes to make:

1. Add state field in @code section:
```csharp
private bool m_showSummary;
```

2. Replace the modal-body content with conditional rendering:

When NOT showing summary (m_showSummary == false):
- Show existing session summary card
- Show ClosingCountPanel
- Show variance acknowledgment checkbox (existing)
- Show closing notes textarea (existing)

When showing summary (m_showSummary == true):
- Show summary card with header "Closing Summary"
- Show table with columns: Currency | Expected | Counted | Variance
- Each row shows one currency from m_currencyBreakdowns
- Variance uses color classes: text-success (0), text-danger (negative), text-info (positive)
- Below table: Overall variance in THB (sum of all variances converted to THB)
- Back button to return to counting step

3. Update footer buttons:
- When NOT showing summary: "Review Summary" button (replaces "Close Session")
- When showing summary: "Back to Count" button + "Close Session" button

4. Add ReviewSummary method:
```csharp
private void ReviewSummary()
{
    if (!HasEnteredAmount) return;
    m_showSummary = true;
    StateHasChanged();
}

private void BackToCount()
{
    m_showSummary = false;
    StateHasChanged();
}
```

5. Add variance styling helpers:
```csharp
private static string GetVarianceClass(decimal variance)
{
    if (variance == 0) return "text-success";
    if (variance > 0) return "text-info";     // Over
    return "text-danger";                      // Short
}

private string FormatVariance(decimal variance, string currency)
{
    var prefix = variance >= 0 ? "+" : "";
    return $"{prefix}{FormatCurrencyAmount(variance, currency)}";
}
```

6. Update SaveAsync to use new method signature:
```csharp
var result = await this.TillService.CloseSessionAsync(
    this.Entity.TillSessionId,
    m_currencyBreakdowns,      // Pass full breakdowns instead of just THB actual
    this.Notes,
    this.UserName);
```

7. Update CanClose logic for summary step:
```csharp
private bool CanReviewSummary => !this.Saving && this.HasEnteredAmount;
private bool CanClose => !this.Saving && m_showSummary && (!this.HasVariance || this.AcknowledgeVariance);
```

Summary table markup pattern:
```razor
<div class="card border-primary mb-3">
    <div class="card-header bg-primary text-white">
        <i class="ti ti-list-check me-2"></i>
        @Localizer["ClosingSummary"]
    </div>
    <div class="card-body">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>@Localizer["Currency"]</th>
                    <th class="text-end">@Localizer["Expected"]</th>
                    <th class="text-end">@Localizer["Counted"]</th>
                    <th class="text-end">@Localizer["Variance"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var breakdown in m_currencyBreakdowns)
                {
                    var variance = breakdown.Variance ?? 0;
                    <tr>
                        <td>@breakdown.Currency</td>
                        <td class="text-end">@FormatCurrencyAmount(breakdown.ExpectedBalance ?? 0, breakdown.Currency)</td>
                        <td class="text-end">@FormatCurrencyAmount(breakdown.Total, breakdown.Currency)</td>
                        <td class="text-end @GetVarianceClass(variance)">
                            @FormatVariance(variance, breakdown.Currency)
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
```
  </action>
  <verify>Build compiles: `dotnet build src/MotoRent.Client`</verify>
  <done>Dialog shows summary step with per-currency variance table before close confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Add localization resources</name>
  <files>
    src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.th.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillCloseSessionDialog.ms.resx
  </files>
  <action>
Add the following localization keys to all four resx files:

Base (.resx) and English (.en.resx):
```xml
<data name="ClosingSummary" xml:space="preserve">
    <value>Closing Summary</value>
</data>
<data name="Currency" xml:space="preserve">
    <value>Currency</value>
</data>
<data name="Expected" xml:space="preserve">
    <value>Expected</value>
</data>
<data name="Counted" xml:space="preserve">
    <value>Counted</value>
</data>
<data name="Variance" xml:space="preserve">
    <value>Variance</value>
</data>
<data name="OverallVarianceThb" xml:space="preserve">
    <value>Overall Variance (THB)</value>
</data>
<data name="ReviewSummary" xml:space="preserve">
    <value>Review Summary</value>
</data>
<data name="BackToCount" xml:space="preserve">
    <value>Back to Count</value>
</data>
```

Thai (.th.resx):
```xml
<data name="ClosingSummary" xml:space="preserve">
    <value>สรุปการปิดรอบ</value>
</data>
<data name="Currency" xml:space="preserve">
    <value>สกุลเงิน</value>
</data>
<data name="Expected" xml:space="preserve">
    <value>คาดหวัง</value>
</data>
<data name="Counted" xml:space="preserve">
    <value>นับได้</value>
</data>
<data name="Variance" xml:space="preserve">
    <value>ส่วนต่าง</value>
</data>
<data name="OverallVarianceThb" xml:space="preserve">
    <value>ส่วนต่างรวม (บาท)</value>
</data>
<data name="ReviewSummary" xml:space="preserve">
    <value>ตรวจสอบสรุป</value>
</data>
<data name="BackToCount" xml:space="preserve">
    <value>กลับไปนับ</value>
</data>
```

Malay (.ms.resx):
```xml
<data name="ClosingSummary" xml:space="preserve">
    <value>Ringkasan Penutupan</value>
</data>
<data name="Currency" xml:space="preserve">
    <value>Mata Wang</value>
</data>
<data name="Expected" xml:space="preserve">
    <value>Dijangka</value>
</data>
<data name="Counted" xml:space="preserve">
    <value>Dikira</value>
</data>
<data name="Variance" xml:space="preserve">
    <value>Perbezaan</value>
</data>
<data name="OverallVarianceThb" xml:space="preserve">
    <value>Perbezaan Keseluruhan (THB)</value>
</data>
<data name="ReviewSummary" xml:space="preserve">
    <value>Semak Ringkasan</value>
</data>
<data name="BackToCount" xml:space="preserve">
    <value>Kembali ke Kiraan</value>
</data>
```

Note: If .ms.resx file doesn't exist, create it with full resx structure copying from .resx and adding the Malay translations.
  </action>
  <verify>Build compiles: `dotnet build src/MotoRent.Client`</verify>
  <done>All localization keys added in English, Thai, and Malay</done>
</task>

</tasks>

<verification>
1. Build the Client project: `dotnet build src/MotoRent.Client`
2. Run the application and test:
   - Open a till session
   - Add some transactions (or have existing transactions)
   - Click Close Session
   - Enter denomination counts
   - Click "Review Summary" - should show summary table
   - Verify color coding: green for exact match, red for short, blue for over
   - Click "Back to Count" - should return to denomination entry
   - Click "Review Summary" again, then "Close Session"
   - Verify session closes with per-currency variances stored
3. Test localization by switching languages
</verification>

<success_criteria>
- Close dialog has two-step flow: Count -> Summary
- Summary shows Currency/Expected/Counted/Variance table
- Variance colors: green (0), red (negative), blue (positive)
- Staff can navigate back from summary to edit counts
- SaveAsync uses new CloseSessionAsync(sessionId, breakdowns, notes, username) overload
- Localization complete for English, Thai, Malay
</success_criteria>

<output>
After completion, create `.planning/phases/07-till-closing-reconciliation/07-02-SUMMARY.md`
</output>
