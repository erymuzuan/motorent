---
phase: 07-till-closing-reconciliation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Entities/TillSession.cs
  - database/tables/MotoRent.TillSession.sql
  - src/MotoRent.Services/TillService.cs
autonomous: true

must_haves:
  truths:
    - "TillSession stores who closed the session (ClosedByUserName)"
    - "TillSession stores per-currency variances at close"
    - "TillSession tracks if session was force-closed"
    - "CloseSessionAsync accepts multi-currency breakdowns"
    - "ForceCloseSessionAsync works with manager approval"
  artifacts:
    - path: "src/MotoRent.Domain/Entities/TillSession.cs"
      provides: "Extended TillSession entity with close metadata"
      contains: "ClosedByUserName"
    - path: "database/tables/MotoRent.TillSession.sql"
      provides: "SQL table with computed columns for new fields"
      contains: "ClosedByUserName"
    - path: "src/MotoRent.Services/TillService.cs"
      provides: "Updated close methods with multi-currency support"
      exports: ["CloseSessionAsync", "ForceCloseSessionAsync"]
  key_links:
    - from: "TillCloseSessionDialog.razor"
      to: "TillService.CloseSessionAsync"
      via: "Method call with breakdowns parameter"
      pattern: "CloseSessionAsync.*breakdowns"
    - from: "TillCloseSessionDialog.razor"
      to: "TillService.ForceCloseSessionAsync"
      via: "Method call with manager approval"
      pattern: "ForceCloseSessionAsync"
---

<objective>
Extend the TillSession entity and TillService to support per-currency variance tracking and manager force-close.

Purpose: Enable accurate variance tracking per currency at close and provide manager override capability for emergency situations.

Output:
- TillSession entity with close metadata fields (ClosedByUserName, IsForceClose, ActualBalances, ClosingVariances)
- Updated SQL table with computed columns for indexing
- CloseSessionAsync overload accepting multi-currency breakdowns
- ForceCloseSessionAsync implementation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-till-closing-reconciliation/07-CONTEXT.md
@.planning/phases/07-till-closing-reconciliation/07-RESEARCH.md

@src/MotoRent.Domain/Entities/TillSession.cs
@src/MotoRent.Services/TillService.cs
@database/tables/MotoRent.TillSession.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TillSession entity with close metadata</name>
  <files>src/MotoRent.Domain/Entities/TillSession.cs</files>
  <action>
Add the following fields to TillSession entity after the existing Closing section:

```csharp
// Close metadata (Phase 7)
public string? ClosedByUserName { get; set; }
public bool IsForceClose { get; set; }
public string? ForceCloseApprovedBy { get; set; }

/// <summary>
/// Actual counted balances per currency at close.
/// Key: currency code (THB, USD, EUR, CNY)
/// Value: actual counted amount in that currency
/// </summary>
public Dictionary<string, decimal> ActualBalances { get; set; } = new();

/// <summary>
/// Variance per currency at close (Actual - Expected).
/// Positive = over, Negative = short, Zero = balanced.
/// Key: currency code (THB, USD, EUR, CNY)
/// Value: variance in that currency
/// </summary>
public Dictionary<string, decimal> ClosingVariances { get; set; } = new();
```

These fields track:
- Who closed the session (for accountability)
- Whether it was a force close (manager bypass)
- Who approved the force close (if applicable)
- Per-currency actual amounts counted
- Per-currency variance (calculated at close)
  </action>
  <verify>Build compiles: `dotnet build src/MotoRent.Domain`</verify>
  <done>TillSession entity has ClosedByUserName, IsForceClose, ForceCloseApprovedBy, ActualBalances, ClosingVariances fields</done>
</task>

<task type="auto">
  <name>Task 2: Update SQL table with computed columns</name>
  <files>database/tables/MotoRent.TillSession.sql</files>
  <action>
Add computed columns for the new fields to enable indexing if needed. Add after existing computed columns:

```sql
[ClosedByUserName] AS CAST(JSON_VALUE([Json], '$.ClosedByUserName') AS NVARCHAR(100)),
[IsForceClose] AS CAST(JSON_VALUE([Json], '$.IsForceClose') AS BIT),
```

Note: ActualBalances and ClosingVariances are dictionaries stored in JSON - no need for computed columns as they're not query targets.

The existing indexes are sufficient - no new indexes needed.
  </action>
  <verify>SQL script has valid syntax (review manually)</verify>
  <done>SQL table has ClosedByUserName and IsForceClose computed columns</done>
</task>

<task type="auto">
  <name>Task 3: Add CloseSessionAsync overload with multi-currency support</name>
  <files>src/MotoRent.Services/TillService.cs</files>
  <action>
Add a new overload of CloseSessionAsync that accepts the full currency breakdowns. Keep the existing method for backward compatibility.

Add this new method after the existing CloseSessionAsync:

```csharp
/// <summary>
/// Closes a till session with per-currency reconciliation.
/// </summary>
/// <param name="sessionId">Session to close</param>
/// <param name="breakdowns">Currency denomination breakdowns with actuals</param>
/// <param name="notes">Optional closing notes</param>
/// <param name="closedByUserName">Staff closing the session</param>
/// <returns>Submit operation result</returns>
public async Task<SubmitOperation> CloseSessionAsync(
    int sessionId,
    List<CurrencyDenominationBreakdown> breakdowns,
    string? notes,
    string closedByUserName)
{
    var session = await this.GetSessionByIdAsync(sessionId);
    if (session is null)
        return SubmitOperation.CreateFailure("Session not found");

    if (session.Status != TillSessionStatus.Open)
        return SubmitOperation.CreateFailure("Session is not open");

    if (session.StaffUserName != closedByUserName)
        return SubmitOperation.CreateFailure("You can only close your own session");

    // Calculate per-currency actuals and variances
    var actualBalances = new Dictionary<string, decimal>();
    var closingVariances = new Dictionary<string, decimal>();

    foreach (var breakdown in breakdowns)
    {
        actualBalances[breakdown.Currency] = breakdown.Total;
        closingVariances[breakdown.Currency] = breakdown.Variance ?? 0;
    }

    // Get THB values for backward compatibility with existing fields
    var thbActual = actualBalances.GetValueOrDefault(SupportedCurrencies.THB, 0);
    var thbExpected = session.GetCurrencyBalance(SupportedCurrencies.THB);

    session.ActualCash = thbActual;
    session.Variance = thbActual - thbExpected;
    session.ActualBalances = actualBalances;
    session.ClosingVariances = closingVariances;
    session.ClosedAt = DateTimeOffset.Now;
    session.ClosedByUserName = closedByUserName;
    session.ClosingNotes = notes;
    session.IsForceClose = false;

    // Determine status based on ANY variance
    var hasAnyVariance = closingVariances.Values.Any(v => v != 0);
    session.Status = hasAnyVariance
        ? TillSessionStatus.ClosedWithVariance
        : TillSessionStatus.Closed;

    using var persistenceSession = this.Context.OpenSession(closedByUserName);
    persistenceSession.Attach(session);
    return await persistenceSession.SubmitChanges("CloseTillSession");
}
```

Note: The existing CloseSessionAsync(sessionId, actualCash, notes, username) remains for backward compatibility. The dialog will use the new overload.
  </action>
  <verify>Build compiles: `dotnet build src/MotoRent.Services`</verify>
  <done>New CloseSessionAsync overload accepts List&lt;CurrencyDenominationBreakdown&gt; and stores per-currency variances</done>
</task>

<task type="auto">
  <name>Task 4: Implement ForceCloseSessionAsync</name>
  <files>src/MotoRent.Services/TillService.cs</files>
  <action>
Implement ForceCloseSessionAsync method. This is called when manager approves force close without full denomination count.

Add this method after the new CloseSessionAsync overload:

```csharp
/// <summary>
/// Force closes a till session with manager approval.
/// Sets actual = expected (zero variance) and closes immediately.
/// </summary>
/// <param name="sessionId">Session to close</param>
/// <param name="approvedByUserName">Manager who approved the force close</param>
/// <param name="notes">Optional notes</param>
/// <param name="closedByUserName">Staff requesting the close</param>
/// <returns>Submit operation result</returns>
public async Task<SubmitOperation> ForceCloseSessionAsync(
    int sessionId,
    string approvedByUserName,
    string? notes,
    string closedByUserName)
{
    var session = await this.GetSessionByIdAsync(sessionId);
    if (session is null)
        return SubmitOperation.CreateFailure("Session not found");

    if (session.Status != TillSessionStatus.Open)
        return SubmitOperation.CreateFailure("Session is not open");

    // Force close sets actual = expected (zero variance)
    session.ActualCash = session.ExpectedCash;
    session.Variance = 0;
    session.ClosedAt = DateTimeOffset.Now;
    session.ClosedByUserName = closedByUserName;
    session.ClosingNotes = notes;
    session.IsForceClose = true;
    session.ForceCloseApprovedBy = approvedByUserName;
    session.Status = TillSessionStatus.Closed;

    // Set per-currency actuals = expected (no variance)
    session.ActualBalances = new Dictionary<string, decimal>(session.CurrencyBalances);
    session.ClosingVariances = session.CurrencyBalances.ToDictionary(
        kvp => kvp.Key,
        kvp => 0m
    );

    using var persistenceSession = this.Context.OpenSession(closedByUserName);
    persistenceSession.Attach(session);
    return await persistenceSession.SubmitChanges("ForceCloseTillSession");
}
```

This method:
- Validates session is open
- Sets all actuals equal to expected (zero variance by definition)
- Marks session as force close with manager attribution
- Stores per-currency zero variances for consistency
  </action>
  <verify>Build compiles: `dotnet build src/MotoRent.Services`</verify>
  <done>ForceCloseSessionAsync method implemented and no longer throws NotImplementedException</done>
</task>

</tasks>

<verification>
1. Build the Domain project: `dotnet build src/MotoRent.Domain`
2. Build the Services project: `dotnet build src/MotoRent.Services`
3. Verify new fields in TillSession.cs: ClosedByUserName, IsForceClose, ForceCloseApprovedBy, ActualBalances, ClosingVariances
4. Verify new methods in TillService.cs: CloseSessionAsync(int, List, string, string), ForceCloseSessionAsync
</verification>

<success_criteria>
- TillSession entity has 5 new fields for close metadata
- SQL table has 2 new computed columns (ClosedByUserName, IsForceClose)
- TillService has new CloseSessionAsync overload accepting breakdowns list
- TillService has ForceCloseSessionAsync implementation
- All projects build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/07-till-closing-reconciliation/07-01-SUMMARY.md`
</output>
