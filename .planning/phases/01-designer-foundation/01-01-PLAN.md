---
phase: 01-designer-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Templates/TemplateElement.cs
  - src/MotoRent.Domain/Templates/Elements/TextElement.cs
  - src/MotoRent.Domain/Templates/Elements/ImageElement.cs
  - src/MotoRent.Domain/Templates/Elements/ContainerElement.cs
  - src/MotoRent.Domain/Templates/Elements/DividerElement.cs
  - src/MotoRent.Domain/Templates/Elements/DateElement.cs
  - src/MotoRent.Domain/Templates/Elements/SignatureElement.cs
  - src/MotoRent.Domain/Templates/DocumentTemplate.cs
  - src/MotoRent.Domain/Templates/PageSettings.cs
  - src/MotoRent.Domain/Entities/Entity.cs
  - database/tables/MotoRent.DocumentTemplate.sql
autonomous: true

must_haves:
  truths:
    - "DocumentTemplate entity can be serialized to JSON with polymorphic elements"
    - "TemplateElement subtypes round-trip through JSON correctly"
    - "Each element type has configurable properties matching its purpose"
  artifacts:
    - path: "src/MotoRent.Domain/Templates/TemplateElement.cs"
      provides: "Polymorphic base class for template elements"
      contains: "JsonPolymorphic"
    - path: "src/MotoRent.Domain/Templates/DocumentTemplate.cs"
      provides: "Main template entity with element collection"
      contains: "List<TemplateElement>"
    - path: "database/tables/MotoRent.DocumentTemplate.sql"
      provides: "SQL schema for template storage"
      contains: "CREATE TABLE"
  key_links:
    - from: "DocumentTemplate.cs"
      to: "TemplateElement.cs"
      via: "Elements property"
      pattern: "List<TemplateElement>"
    - from: "Entity.cs"
      to: "DocumentTemplate.cs"
      via: "JsonDerivedType registration"
      pattern: "JsonDerivedType.*DocumentTemplate"
---

<objective>
Create the domain model for document templates with polymorphic element types.

Purpose: Establish the data foundation for template storage and manipulation. All UI components depend on this model.
Output: TemplateElement hierarchy, DocumentTemplate entity, SQL schema
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-designer-foundation/01-RESEARCH.md

# Existing patterns to follow
@src/MotoRent.Domain/Entities/Entity.cs
@src/MotoRent.Domain/Core/JsonSerializerService.cs
@database/tables/MotoRent.Rental.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplateElement Base Class and Element Types</name>
  <files>
    src/MotoRent.Domain/Templates/TemplateElement.cs
    src/MotoRent.Domain/Templates/Elements/TextElement.cs
    src/MotoRent.Domain/Templates/Elements/ImageElement.cs
    src/MotoRent.Domain/Templates/Elements/ContainerElement.cs
    src/MotoRent.Domain/Templates/Elements/DividerElement.cs
    src/MotoRent.Domain/Templates/Elements/DateElement.cs
    src/MotoRent.Domain/Templates/Elements/SignatureElement.cs
  </files>
  <action>
Create a new folder `src/MotoRent.Domain/Templates/` and subfolder `Elements/`.

Create `TemplateElement.cs` as the polymorphic base class with:
- `[JsonPolymorphic(TypeDiscriminatorPropertyName = "$type")]` attribute
- `[JsonDerivedType]` attributes for each concrete element type
- Common properties: `Id` (string, default `Guid.NewGuid().ToString("N")[..8]`), `Label` (string?)
- Layout properties: `Width` (int?, null=100%), `Height` (int?, null=auto), `Alignment` (string? - left/center/right), `MarginTop` (int), `MarginBottom` (int)

Create concrete element classes:

**TextElement.cs:**
- `Content` (string) - static text or binding placeholder
- `FontSize` (int, default 14)
- `FontWeight` (string?, "normal"/"bold")
- `FontStyle` (string?, "normal"/"italic")
- `TextAlign` (string?, "left"/"center"/"right")
- `Color` (string?, CSS color)
- `BindingPath` (string?) - null for static, path like "Rental.RenterName" for bound

**ImageElement.cs:**
- `Source` (string?) - URL or binding path
- `AltText` (string?)
- `MaxWidth` (int?, pixels)
- `MaxHeight` (int?, pixels)
- `ObjectFit` (string?, "contain"/"cover"/"fill")

**ContainerElement.cs:**
- `Children` (List<TemplateElement>) - nested elements (max 1 level nesting for v1)
- `Layout` (string?, "vertical"/"horizontal"/"two-column")
- `Gap` (int, default 8) - spacing between children
- `Padding` (int, default 0)
- `Border` (string?) - CSS border shorthand
- `Background` (string?) - CSS background

**DividerElement.cs:**
- `Style` (string?, "solid"/"dashed"/"dotted", default "solid")
- `Thickness` (int, default 1)
- `Color` (string?, default "#ccc")

**DateElement.cs:**
- `BindingPath` (string?) - null for DateTime.Now, path for bound date
- `Format` (string, default "dd/MM/yyyy")

**SignatureElement.cs:**
- `Label` (string?, default "Signature")
- `ShowLine` (bool, default true)
- `LineWidth` (int, default 200)
  </action>
  <verify>
Run `dotnet build src/MotoRent.Domain/` - should compile without errors.
  </verify>
  <done>
All 6 element types exist with appropriate properties. TemplateElement has polymorphic JSON attributes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DocumentTemplate Entity and PageSettings</name>
  <files>
    src/MotoRent.Domain/Templates/DocumentTemplate.cs
    src/MotoRent.Domain/Templates/PageSettings.cs
    src/MotoRent.Domain/Entities/Entity.cs
  </files>
  <action>
Create `PageSettings.cs` with:
- `Size` (string, default "A4") - paper size
- `Orientation` (string, default "Portrait") - Portrait/Landscape
- `MarginTop` (int, default 20) - mm
- `MarginRight` (int, default 20)
- `MarginBottom` (int, default 20)
- `MarginLeft` (int, default 20)

Create `DocumentTemplate.cs` inheriting from `Entity`:
- `DocumentTemplateId` (int) - primary key
- `Name` (string) - template name
- `DocumentType` (string) - "Agreement"/"Receipt"/"BookingConfirmation"
- `Status` (string, default "Draft") - "Draft"/"Approved"/"Archived"
- `IsDefault` (bool) - is this the default for its document type
- `Description` (string?) - optional description
- `Page` (PageSettings) - page configuration with `= new()`
- `Elements` (List<TemplateElement>) - element collection with `= []`
- Override `GetId()` and `SetId()` for DocumentTemplateId

Register `DocumentTemplate` in `Entity.cs` by adding `[JsonDerivedType(typeof(DocumentTemplate), nameof(DocumentTemplate))]` attribute (add with other MotoRent entities, alphabetically).

Add namespace using statement at top of Entity.cs: `using MotoRent.Domain.Templates;`
  </action>
  <verify>
Run `dotnet build src/MotoRent.Domain/` - should compile without errors.
  </verify>
  <done>
DocumentTemplate entity exists with Page and Elements properties. Entity.cs has JsonDerivedType registration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Database Schema</name>
  <files>
    database/tables/MotoRent.DocumentTemplate.sql
  </files>
  <action>
Create SQL table definition following existing patterns (see MotoRent.Rental.sql).

Use `[MotoRent]` as schema placeholder (will be replaced with tenant AccountNo).

Structure:
- `DocumentTemplateId` INT PRIMARY KEY IDENTITY
- Computed columns for indexed properties: `Name`, `DocumentType`, `Status`, `IsDefault`
- `Json` NVARCHAR(MAX) for full serialization
- Standard audit columns: `CreatedBy`, `ChangedBy`, `CreatedTimestamp`, `ChangedTimestamp` with defaults

Create indexes:
- `IX_DocumentTemplate_Type_Default` on `(DocumentType, IsDefault)` - for finding default template per type
- `IX_DocumentTemplate_Status` on `(Status)` - for listing approved templates

SQL pattern:
```sql
CREATE TABLE [MotoRent].[DocumentTemplate]
(
    [DocumentTemplateId] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [Name] AS CAST(JSON_VALUE([Json], '$.Name') AS NVARCHAR(100)),
    [DocumentType] AS CAST(JSON_VALUE([Json], '$.DocumentType') AS NVARCHAR(50)),
    [Status] AS CAST(JSON_VALUE([Json], '$.Status') AS NVARCHAR(20)),
    [IsDefault] AS CAST(JSON_VALUE([Json], '$.IsDefault') AS BIT),
    [Json] NVARCHAR(MAX) NOT NULL,
    [CreatedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [ChangedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [CreatedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    [ChangedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET()
)
```
  </action>
  <verify>
File exists at `database/tables/MotoRent.DocumentTemplate.sql` and contains valid SQL syntax with CREATE TABLE and CREATE INDEX statements.
  </verify>
  <done>
SQL schema file exists with table definition, computed columns, and indexes.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build src/MotoRent.Domain/` compiles successfully
2. All files exist in specified locations
3. TemplateElement has `[JsonPolymorphic]` attribute
4. DocumentTemplate is registered in Entity.cs with `[JsonDerivedType]`
5. SQL schema follows existing table patterns
</verification>

<success_criteria>
- Domain model compiles without errors
- 6 element types with configurable properties
- DocumentTemplate entity with polymorphic Elements collection
- SQL schema ready for tenant deployment
- JSON serialization attributes configured for polymorphism
</success_criteria>

<output>
After completion, create `.planning/phases/01-designer-foundation/01-01-SUMMARY.md`
</output>
