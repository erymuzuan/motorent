---
phase: 01-designer-foundation
plan: 05
type: execute
wave: 3
depends_on: [01-02, 01-03, 01-04]
files_modified:
  - src/MotoRent.Client/Components/Designer/DesignerCanvas.razor
  - src/MotoRent.Client/Components/Designer/DesignerCanvas.razor.cs
  - src/MotoRent.Client/Components/Designer/DesignerCanvas.razor.css
  - src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor
  - src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor.cs
  - src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor.css
autonomous: false

must_haves:
  truths:
    - "User can drag elements from palette to canvas"
    - "User can reorder elements on canvas by dragging"
    - "User can select element and see properties panel"
    - "User can edit properties and see immediate update on canvas"
    - "User can delete elements"
  artifacts:
    - path: "src/MotoRent.Client/Components/Designer/DesignerCanvas.razor"
      provides: "Main canvas component with drag-drop"
      contains: "OnElementReordered"
    - path: "src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor"
      provides: "Full designer page"
      contains: "@page"
  key_links:
    - from: "DesignerCanvas.razor"
      to: "DesignerJsInterop.cs"
      via: "InitDesignerAsync"
      pattern: "m_jsInterop\\.InitDesignerAsync"
    - from: "DesignerCanvas.razor"
      to: "ElementsPalette.razor"
      via: "PaletteRef parameter"
      pattern: "ElementsPalette.*PaletteRef"
    - from: "TemplateDesigner.razor"
      to: "DesignerCanvas.razor"
      via: "Component usage"
      pattern: "<DesignerCanvas"
---

<objective>
Create the designer canvas component and integrate all pieces into a working designer page.

Purpose: Assemble the complete designer experience where users can drag, drop, select, and configure template elements.
Output: DesignerCanvas component, TemplateDesigner page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-designer-foundation/01-RESEARCH.md

# Prior plan outputs
@.planning/phases/01-designer-foundation/01-01-SUMMARY.md
@.planning/phases/01-designer-foundation/01-02-SUMMARY.md
@.planning/phases/01-designer-foundation/01-03-SUMMARY.md
@.planning/phases/01-designer-foundation/01-04-SUMMARY.md

# Interop from Plan 02
@src/MotoRent.Client/Interops/DesignerJsInterop.cs

# Components from Plans 03 and 04
@src/MotoRent.Client/Components/Designer/ElementsPalette.razor
@src/MotoRent.Client/Components/Designer/PropertiesPanel.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DesignerCanvas Component</name>
  <files>
    src/MotoRent.Client/Components/Designer/DesignerCanvas.razor
    src/MotoRent.Client/Components/Designer/DesignerCanvas.razor.cs
    src/MotoRent.Client/Components/Designer/DesignerCanvas.razor.css
  </files>
  <action>
Create `DesignerCanvas.razor` - the main canvas component that orchestrates the designer.

**Razor markup:**
```razor
@inherits LocalizedComponentBase<DesignerCanvas>
@implements IAsyncDisposable
@inject IJSRuntime JsRuntime
@using MotoRent.Domain.Templates
@using MotoRent.Domain.Templates.Elements

<div class="designer-layout">
    <ElementsPalette @ref="m_palette" />

    <div class="designer-canvas" @ref="m_canvasRef">
        @if (Template.Elements.Count == 0)
        {
            <div class="canvas-empty">
                <i class="ti ti-drag-drop"></i>
                <p>@Localizer["DragElementsHere"]</p>
            </div>
        }
        else
        {
            @foreach (var element in Template.Elements)
            {
                <div class="canvas-element @(element.Id == SelectedElementId ? "selected" : "")"
                     data-element-id="@element.Id"
                     @onclick="() => SelectElement(element.Id)"
                     @onclick:stopPropagation="true">
                    <div class="element-actions">
                        <button class="btn btn-sm" @onclick="() => DeleteElement(element.Id)" @onclick:stopPropagation="true">
                            <i class="ti ti-trash"></i>
                        </button>
                    </div>
                    @RenderElement(element)
                </div>
            }
        }
    </div>

    <PropertiesPanel Element="@SelectedElement"
                     OnPropertyChanged="OnPropertyChanged"
                     OnDeleteRequested="DeleteSelectedElement" />
</div>
```

**Code-behind (DesignerCanvas.razor.cs):**
```csharp
public partial class DesignerCanvas : IAsyncDisposable
{
    private ElementReference m_canvasRef;
    private ElementsPalette? m_palette;
    private DesignerJsInterop? m_jsInterop;
    private DotNetObjectReference<DesignerCanvas>? m_dotNetRef;

    [Parameter] public DocumentTemplate Template { get; set; } = new();
    [Parameter] public EventCallback<DocumentTemplate> TemplateChanged { get; set; }

    private string? SelectedElementId { get; set; }
    private TemplateElement? SelectedElement =>
        Template.Elements.FirstOrDefault(e => e.Id == SelectedElementId);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            m_jsInterop = new DesignerJsInterop(JsRuntime);
            m_dotNetRef = DotNetObjectReference.Create(this);
            if (m_palette is not null)
            {
                await m_jsInterop.InitDesignerAsync(m_canvasRef, m_palette.PaletteRef, m_dotNetRef);
            }
        }
    }

    [JSInvokable]
    public async Task OnElementReordered(ElementReorderArgs args)
    {
        var element = Template.Elements.FirstOrDefault(e => e.Id == args.ElementId);
        if (element is null) return;

        Template.Elements.Remove(element);
        var newIndex = Math.Min(args.NewIndex, Template.Elements.Count);
        Template.Elements.Insert(newIndex, element);

        await TemplateChanged.InvokeAsync(Template);
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnElementAdded(ElementAddArgs args)
    {
        var element = CreateElement(args.ElementType);
        var index = Math.Min(args.Index, Template.Elements.Count);
        Template.Elements.Insert(index, element);
        SelectedElementId = element.Id;

        await TemplateChanged.InvokeAsync(Template);
        StateHasChanged();
    }

    private TemplateElement CreateElement(string typeName) => typeName switch
    {
        "TextElement" => new TextElement { Content = "New text" },
        "ImageElement" => new ImageElement(),
        "ContainerElement" => new ContainerElement(),
        "DividerElement" => new DividerElement(),
        "DateElement" => new DateElement(),
        "SignatureElement" => new SignatureElement(),
        _ => new TextElement { Content = "Unknown element" }
    };

    private void SelectElement(string elementId) => SelectedElementId = elementId;

    private async Task OnPropertyChanged()
    {
        await TemplateChanged.InvokeAsync(Template);
        StateHasChanged();
    }

    private async Task DeleteElement(string elementId)
    {
        var element = Template.Elements.FirstOrDefault(e => e.Id == elementId);
        if (element is not null)
        {
            Template.Elements.Remove(element);
            if (SelectedElementId == elementId)
                SelectedElementId = null;
            await TemplateChanged.InvokeAsync(Template);
            StateHasChanged();
        }
    }

    private async Task DeleteSelectedElement()
    {
        if (SelectedElementId is not null)
            await DeleteElement(SelectedElementId);
    }

    private RenderFragment RenderElement(TemplateElement element) => builder =>
    {
        var index = 0;
        switch (element)
        {
            case TextElement text:
                builder.OpenComponent<TextElementView>(index++);
                builder.AddAttribute(index++, "Element", text);
                builder.CloseComponent();
                break;
            // Add cases for other element types
        }
    };

    public async ValueTask DisposeAsync()
    {
        m_dotNetRef?.Dispose();
        if (m_jsInterop is not null)
            await m_jsInterop.DisposeAsync();
    }
}
```

**CSS (DesignerCanvas.razor.css):**
```css
.designer-layout {
    display: grid;
    grid-template-columns: 200px 1fr 280px;
    height: calc(100vh - 160px);
    gap: 0;
}

.designer-canvas {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    overflow-y: auto;
    padding: 20px;
    position: relative;
}

.canvas-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #adb5bd;
}

.canvas-empty i {
    font-size: 48px;
    margin-bottom: 16px;
}

.canvas-element {
    position: relative;
    border: 1px dashed transparent;
    padding: 8px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: all 0.15s ease;
}

.canvas-element:hover {
    border-color: #adb5bd;
    background: rgba(0, 137, 123, 0.05);
}

.canvas-element.selected {
    border-color: #00897b;
    border-style: solid;
    background: rgba(0, 137, 123, 0.1);
}

.element-actions {
    position: absolute;
    top: 4px;
    right: 4px;
    opacity: 0;
    transition: opacity 0.15s;
}

.canvas-element:hover .element-actions,
.canvas-element.selected .element-actions {
    opacity: 1;
}

/* SortableJS classes */
::deep .element-ghost {
    opacity: 0.4;
    background: #e3f2fd;
}

::deep .element-chosen {
    background: rgba(0, 137, 123, 0.1);
}
```
  </action>
  <verify>
Run `dotnet build src/MotoRent.Client/` - should compile without errors.
  </verify>
  <done>
DesignerCanvas component exists with drag-drop integration, selection, and property editing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TemplateDesigner Page</name>
  <files>
    src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor
    src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor.cs
    src/MotoRent.Client/Pages/Settings/TemplateDesigner.razor.css
  </files>
  <action>
Create the full designer page at `/settings/template-designer`.

**TemplateDesigner.razor:**
```razor
@page "/settings/template-designer"
@page "/settings/template-designer/{TemplateId:int}"
@inherits LocalizedComponentBase<TemplateDesigner>
@using MotoRent.Domain.Templates

<MotoRentPageTitle>@Localizer["TemplateDesigner"]</MotoRentPageTitle>

<TablerHeader Title="@Localizer["TemplateDesigner"]" PreTitle="@Localizer["DesignDocumentTemplates"]">
    <div class="d-flex gap-2">
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                @Localizer["DocumentType"]: @m_template.DocumentType
            </button>
            <div class="dropdown-menu">
                <a class="dropdown-item" @onclick="() => SetDocumentType(\"Agreement\")">@Localizer["Agreement"]</a>
                <a class="dropdown-item" @onclick="() => SetDocumentType(\"Receipt\")">@Localizer["Receipt"]</a>
                <a class="dropdown-item" @onclick="() => SetDocumentType(\"BookingConfirmation\")">@Localizer["BookingConfirmation"]</a>
            </div>
        </div>
        <button class="btn btn-primary" @onclick="SaveTemplate" disabled="@m_saving">
            @if (m_saving)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="ti ti-device-floppy me-1"></i>
            @Localizer["Save"]
        </button>
    </div>
</TablerHeader>

<div class="card">
    <div class="card-body p-0">
        <DesignerCanvas @bind-Template="m_template" />
    </div>
</div>
```

**TemplateDesigner.razor.cs:**
```csharp
public partial class TemplateDesigner
{
    [Parameter] public int? TemplateId { get; set; }

    private DocumentTemplate m_template = new()
    {
        Name = "New Template",
        DocumentType = "Agreement"
    };
    private bool m_saving;

    protected override async Task OnParametersSetAsync()
    {
        if (TemplateId.HasValue && TemplateId.Value > 0)
        {
            // TODO: Load template from database in Phase 4
            // For now, create new template
        }
    }

    private void SetDocumentType(string type)
    {
        m_template.DocumentType = type;
        StateHasChanged();
    }

    private async Task SaveTemplate()
    {
        m_saving = true;
        try
        {
            // TODO: Save to database in Phase 4
            await Task.Delay(500); // Simulate save
        }
        finally
        {
            m_saving = false;
        }
    }
}
```

**TemplateDesigner.razor.css:**
```css
/* Page-specific overrides if needed */
```

Note: Template persistence (save/load) will be implemented in Phase 4. This page provides the visual designer experience for Phase 1.
  </action>
  <verify>
Run `dotnet build src/MotoRent.Client/` - should compile without errors.
  </verify>
  <done>
TemplateDesigner page exists at /settings/template-designer route.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete document template designer with:
- Draggable element palette (7 element types)
- Canvas with drag-and-drop reordering
- Properties panel with type-specific editors
- Element selection with visual feedback
- Element deletion
  </what-built>
  <how-to-verify>
1. Run the application: `dotnet run --project src/MotoRent.Server`
2. Navigate to `/settings/template-designer`
3. Verify palette shows 7 element types with icons
4. Drag a Text element from palette to canvas - should appear
5. Drag an Image element - should appear below Text
6. Drag to reorder elements - should move
7. Click element to select - should show blue border
8. Properties panel should show element properties
9. Change font size in properties - should update canvas preview
10. Click delete button on element - should remove from canvas
11. Test on touch device if available (tablet) - drag should work with delay
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Application compiles: `dotnet build src/MotoRent.Client/`
2. Designer page accessible at `/settings/template-designer`
3. Drag from palette to canvas works
4. Reorder on canvas works
5. Selection shows visual feedback
6. Properties panel updates element
7. Delete removes element
</verification>

<success_criteria>
- REQ-001 met: Designer canvas with drag-and-drop for 7 element types
- REQ-002 met: Properties panel shows and edits element properties
- Elements can be added, reordered, selected, configured, and deleted
- Visual feedback for selection and drag states
- Canvas shows element boundaries
</success_criteria>

<output>
After completion, create `.planning/phases/01-designer-foundation/01-05-SUMMARY.md`
</output>
