---
phase: 09-end-of-day-operations
plan: 04
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor
  - src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor.cs
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.th.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.ms.resx
  - src/MotoRent.Client/Layout/StaffLayout.razor
autonomous: true

must_haves:
  truths:
    - "Staff can search till transactions by date, type, customer, amount range, receipt number"
    - "Staff can view any past till transaction details"
    - "Staff can reprint any receipt"
    - "Search results show receipt details with customer and amount"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor"
      provides: "Staff receipt search and reprint page"
      min_lines: 200
    - path: "src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.resx"
      provides: "Default localization"
      contains: "<data name="
  key_links:
    - from: "src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor"
      to: "ReceiptService.GetReceiptsAsync"
      via: "search on filter change"
      pattern: "ReceiptService\\.GetReceiptsAsync"
    - from: "src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor"
      to: "ReceiptPrintDialog"
      via: "dialog show on reprint click"
      pattern: "ReceiptPrintDialog"
    - from: "src/MotoRent.Client/Layout/StaffLayout.razor"
      to: "/staff/till-transactions"
      via: "navigation menu link"
      pattern: "till-transactions"
---

<objective>
Create the staff receipt search page for viewing and reprinting till transactions.

Purpose: Enable RCPT-02 (staff can search and view past till transactions) and RCPT-03 (staff can reprint receipts). Provides a simplified search interface for staff compared to the manager receipt page.

Output:
- TillTransactionSearch.razor page at /staff/till-transactions
- Full search: date range, type, customer name/phone, amount range, receipt number
- Receipt reprint via existing ReceiptPrintDialog
- Navigation link in StaffLayout
- Localization resources (English, Thai, Malay)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-end-of-day-operations/09-CONTEXT.md
@.planning/phases/09-end-of-day-operations/09-01-SUMMARY.md
@src/MotoRent.Client/Pages/Finance/Receipts.razor
@src/MotoRent.Client/Components/Receipts/ReceiptPrintDialog.razor
@src/MotoRent.Services/ReceiptService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TillTransactionSearch page</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor
    src/MotoRent.Client/Pages/Staff/TillTransactionSearch.razor.cs
  </files>
  <action>
Create TillTransactionSearch.razor at @page "/staff/till-transactions":
- Authorization: Staff, ShopManager, OrgAdmin (no special policy - default tenant access)
- Inherit from LocalizedComponentBase<TillTransactionSearch>
- Inject ReceiptService, ShopService, IModalService

Reference Receipts.razor for patterns but simplify for staff use.

Page layout:

1. Header:
   - Title: "Transaction Search" with ti-search icon
   - Pre-title: "Till Operations"

2. Search Filters Card:
   - Row 1: Date range (From/To date inputs), Quick buttons (Today, Last 7 Days, This Month)
   - Row 2: Receipt Type dropdown (All, Check-In, Settlement, Booking Deposit)
   - Row 3: Search text input (customer name, phone, or receipt number)
   - Row 4: Amount range (Min/Max numeric inputs) - optional
   - Apply Search button (or auto-search on change with debounce)

3. Results Summary (above table):
   - "Found {count} receipts"
   - Quick stats: Total amount for displayed results

4. Results Table:
   - Columns: Receipt #, Type, Customer, Vehicle, Amount, Date/Time, Actions
   - Receipt # is clickable (opens detail view or print)
   - Type badge (Check-In = blue, Settlement = green, Booking Deposit = cyan)
   - Amount formatted with currency
   - Date/Time in local format
   - Actions: View/Print button (ti-printer icon)

5. Pagination:
   - Page size: 20 results per page
   - Prev/Next buttons
   - "Showing page X of Y (total Z results)"

6. Empty State:
   - When no results: Icon + "No receipts found" message
   - Suggest adjusting filters

Code-behind (.razor.cs):
- private List<Receipt> m_receipts
- private bool m_loading
- Filter fields: m_fromDate, m_toDate, m_receiptType, m_searchTerm, m_minAmount, m_maxAmount
- private int m_currentPage, m_pageSize = 20, m_totalCount, m_totalPages

Methods:
- LoadDataAsync(): Call ReceiptService.GetReceiptsAsync with filters
- ApplyQuickDate(string range): Set date range for Today/7Days/Month
- ViewPrintReceiptAsync(Receipt receipt): Open ReceiptPrintDialog with IsReprint=true, reload on close
- FilterChanged(): Reset to page 1 and reload
- GoToPageAsync(int page): Navigate pagination

Staff can ONLY view and print - no void action (unlike manager Receipts.razor).
  </action>
  <verify>
Page compiles without errors:
```bash
dotnet build src/MotoRent.Client/MotoRent.Client.csproj
```
  </verify>
  <done>
TillTransactionSearch.razor provides full search with date, type, customer, amount filters.
Results table shows receipts with View/Print action.
Pagination works for large result sets.
No void capability (staff only).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation and localization</name>
  <files>
    src/MotoRent.Client/Layout/StaffLayout.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.th.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch.ms.resx
  </files>
  <action>
Update StaffLayout.razor:
- Add navigation link to /staff/till-transactions
- Place in Finance section or create Till section
- Label: "Transaction Search" or "Receipt Search"
- Icon: ti-receipt-2 or ti-search
- Visible to all staff roles (Staff, ShopManager, OrgAdmin)

If Finance section exists, add there. If not, create appropriate menu grouping.

Create localization resources:

Keys needed (approximately 25):
- PageTitle - "Transaction Search"
- TillOperations - "Till Operations"
- SearchFilters - "Search Filters"
- DateRange - "Date Range"
- FromDate - "From"
- ToDate - "To"
- Today - "Today"
- Last7Days - "Last 7 Days"
- ThisMonth - "This Month"
- ReceiptType - "Receipt Type"
- AllTypes - "All Types"
- CheckIn - "Check-In"
- Settlement - "Settlement"
- BookingDeposit - "Booking Deposit"
- SearchPlaceholder - "Customer name, phone, or receipt number"
- AmountRange - "Amount Range"
- MinAmount - "Min"
- MaxAmount - "Max"
- ApplySearch - "Apply Search"
- FoundReceipts - "Found {0} receipts"
- ReceiptNo - "Receipt #"
- Customer - "Customer"
- Vehicle - "Vehicle"
- Amount - "Amount"
- DateTime - "Date/Time"
- Actions - "Actions"
- ViewPrint - "View / Print"
- NoReceiptsFound - "No receipts found"
- AdjustFilters - "Try adjusting your search filters"
- ShowingPage - "Showing page {0} of {1} ({2} total)"

Thai (.th.resx): Provide Thai translations
Malay (.ms.resx): Provide Malay translations
  </action>
  <verify>
Navigation appears and resource files exist:
```bash
dotnet build src/MotoRent.Client/MotoRent.Client.csproj
ls src/MotoRent.Client/Resources/Pages/Staff/TillTransactionSearch*.resx
```
  </verify>
  <done>
StaffLayout.razor has navigation link to /staff/till-transactions.
All four resx files created with translations.
Staff can navigate to transaction search from menu.
  </done>
</task>

</tasks>

<verification>
1. TillTransactionSearch.razor accessible at /staff/till-transactions
2. Navigation link appears in StaffLayout menu
3. Search filters work: date range, type, customer text, amount range
4. Quick date buttons (Today, Last 7 Days, This Month) update date range
5. Results table shows receipts with proper type badges
6. View/Print opens ReceiptPrintDialog with IsReprint=true
7. Pagination works correctly
8. No void action available (staff-safe)
9. All localization keys have Thai and Malay translations
</verification>

<success_criteria>
- Staff can search receipts by date, type, customer, amount (RCPT-02)
- Staff can view and reprint any receipt (RCPT-03)
- Navigation is accessible from staff menu
- Page is mobile-friendly for tablet use
- RCPT-01 already satisfied by existing ReceiptService
</success_criteria>

<output>
After completion, create `.planning/phases/09-end-of-day-operations/09-04-SUMMARY.md`
</output>
