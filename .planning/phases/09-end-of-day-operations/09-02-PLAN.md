---
phase: 09-end-of-day-operations
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/MotoRent.Client/Pages/Manager/CashDropVerificationDialog.razor
  - src/MotoRent.Client/Pages/Manager/CashDropVerificationDialog.razor.cs
  - src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.resx
  - src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.th.resx
  - src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.ms.resx
  - src/MotoRent.Client/Pages/Manager/EndOfDay.razor
autonomous: true

must_haves:
  truths:
    - "Manager can view cash drops per session grouped by currency"
    - "Manager can confirm drops match safe contents or enter actual count"
    - "Manager can provide reason when actual differs from dropped"
    - "Drop verification shows individual drop transactions with times"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Manager/CashDropVerificationDialog.razor"
      provides: "Per-session drop verification dialog"
      min_lines: 150
    - path: "src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.resx"
      provides: "Default localization"
      contains: "<data name="
  key_links:
    - from: "src/MotoRent.Client/Pages/Manager/CashDropVerificationDialog.razor"
      to: "TillService.GetDropTotalsByCurrencyAsync"
      via: "load drops on dialog open"
      pattern: "TillService\\.GetDropTotalsByCurrencyAsync"
    - from: "src/MotoRent.Client/Pages/Manager/EndOfDay.razor"
      to: "CashDropVerificationDialog"
      via: "dialog show on verify drops button"
      pattern: "CashDropVerificationDialog"
---

<objective>
Create the cash drop verification dialog and integrate it into the EOD page.

Purpose: Enable EOD-01 (manager can verify cash drops from all tills against safe contents). The dialog shows per-session drops by currency and allows manager to confirm or enter actual safe count with reason.

Output:
- CashDropVerificationDialog with per-currency drop display
- Verification workflow (confirm match or enter actual + reason)
- Integration with EndOfDay.razor page
- Localization resources (English, Thai, Malay)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-end-of-day-operations/09-CONTEXT.md
@.planning/phases/09-end-of-day-operations/09-01-SUMMARY.md
@src/MotoRent.Client/Pages/Manager/EndOfDay.razor
@src/MotoRent.Client/Pages/Manager/EodSessionDetailDialog.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CashDropVerificationDialog component</name>
  <files>
    src/MotoRent.Client/Pages/Manager/CashDropVerificationDialog.razor
    src/MotoRent.Client/Pages/Manager/CashDropVerificationDialog.razor.cs
  </files>
  <action>
Create CashDropVerificationDialog.razor with:

Parameters:
- int SessionId
- string StaffName
- decimal TotalDropped (THB equivalent for display)

Component structure:
1. Header section showing staff name and session summary

2. Drops table showing:
   - Individual drop transactions from session
   - Time, Currency, Amount for each drop
   - Running total per currency

3. Per-currency verification section:
   - For each currency with drops > 0
   - Row showing: Currency | Dropped Amount | Actual Count input | Status
   - Radio buttons or toggle: "Matches" vs "Different"
   - If Different: show numeric input for actual and text input for reason
   - Variance calculated and displayed (Actual - Dropped)

4. Summary footer:
   - Total dropped (all currencies in THB equivalent)
   - Total variance (if any)
   - Action buttons: Cancel, Confirm Verification

5. On confirm:
   - If all match: Mark session drops as verified
   - If any variance: Log variance with reason, mark as verified with notes

Code-behind (.razor.cs):
- private bool m_loading
- private List<TillTransaction> m_drops
- private Dictionary<string, decimal> m_dropTotals (currency -> total)
- private Dictionary<string, DropVerification> m_verifications (currency -> input state)

DropVerification class (internal):
- bool Matches (default true)
- decimal? ActualAmount
- string? Reason
- decimal Variance (computed)

Load data on OnParametersSetAsync:
- Call TillService.GetDropTotalsByCurrencyAsync(SessionId)
- Also load individual drops for timeline view

Follow EodSessionDetailDialog.razor patterns for dialog structure.
Use MotoRentComponentBase and inject TillService.
  </action>
  <verify>
File compiles without errors:
```bash
dotnet build src/MotoRent.Client/MotoRent.Client.csproj
```
  </verify>
  <done>
CashDropVerificationDialog.razor renders drop list by currency with verification inputs.
Dialog allows confirm match or enter actual count with reason.
Code-behind handles state and data loading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create localization resources</name>
  <files>
    src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.resx
    src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.th.resx
    src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog.ms.resx
  </files>
  <action>
Create localization resources for CashDropVerificationDialog.

Keys needed (approximately 20):
- VerifyCashDrops - "Verify Cash Drops"
- SessionDrops - "Session Drops"
- StaffMember - "Staff Member"
- TotalDropped - "Total Dropped"
- NoDropsRecorded - "No cash drops recorded for this session"
- Currency - "Currency"
- DroppedAmount - "Dropped Amount"
- ActualCount - "Actual Count"
- Status - "Status"
- Matches - "Matches"
- Different - "Different"
- EnterActualAmount - "Enter actual safe count"
- ReasonRequired - "Reason is required when amounts differ"
- EnterReason - "Enter reason for difference"
- Variance - "Variance"
- Over - "Over"
- Short - "Short"
- Balanced - "Balanced"
- ConfirmVerification - "Confirm Verification"
- VerificationComplete - "Drop verification complete"
- DropTime - "Time"
- DropAmount - "Amount"

English (.resx and .en.resx): Use English values above
Thai (.th.resx): Provide Thai translations
Malay (.ms.resx): Provide Malay translations

Follow existing resx format from EodSessionDetailDialog resources.
  </action>
  <verify>
Resource files exist and are valid XML:
```bash
ls src/MotoRent.Client/Resources/Pages/Manager/CashDropVerificationDialog*.resx
```
  </verify>
  <done>
All four resx files created with proper localization keys.
Thai and Malay translations provided.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate verification dialog into EndOfDay page</name>
  <files>
    src/MotoRent.Client/Pages/Manager/EndOfDay.razor
  </files>
  <action>
Update EndOfDay.razor to add drop verification capability:

1. Add "Verify Drops" button to each closed session row (where status is Closed/ClosedWithVariance/Verified)
   - Place next to existing "View" and "Verify" buttons
   - Use ti-archive icon
   - Only show if session has drops (TotalDropped > 0)

2. Add method ViewDropVerification(TillSessionSummary session):
   - Open CashDropVerificationDialog using DialogService
   - Pass SessionId, StaffDisplayName, TotalDropped
   - On success: show success toast, reload data

3. Add drop summary section to the page:
   - New card showing aggregate drops for the day by currency
   - Display: THB total, USD total, EUR total, CNY total (only if > 0)
   - Header: "Daily Cash Drops"
   - Shows sum of all drops across all sessions for selected date

4. Style: Follow existing button patterns in the session table.

Do NOT modify the existing session verification workflow (that's separate from drop verification).
Drop verification is about confirming physical safe contents match recorded drops.
  </action>
  <verify>
Page builds and displays properly:
```bash
dotnet build src/MotoRent.Client/MotoRent.Client.csproj
```
  </verify>
  <done>
EndOfDay.razor has "Verify Drops" button per session with drops.
Daily drop summary card shows aggregate by currency.
Dialog integrates properly with existing page flow.
  </done>
</task>

</tasks>

<verification>
1. CashDropVerificationDialog compiles: `dotnet build src/MotoRent.Client`
2. Dialog shows individual drops with times and currency breakdown
3. Verification allows "Matches" or "Different" selection per currency
4. Reason field appears when "Different" is selected
5. EndOfDay.razor shows "Verify Drops" button for sessions with TotalDropped > 0
6. All localization keys have Thai and Malay translations
</verification>

<success_criteria>
- Manager can click "Verify Drops" on any session with cash drops
- Dialog shows per-currency drop totals with individual transaction list
- Manager can confirm drops match or enter actual count with reason
- Daily drop summary shows aggregate drops by currency for the day
- EOD-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/09-end-of-day-operations/09-02-SUMMARY.md`
</output>
