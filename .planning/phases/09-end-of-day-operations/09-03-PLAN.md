---
phase: 09-end-of-day-operations
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/MotoRent.Client/Pages/Manager/DailyClose.razor
  - src/MotoRent.Client/Pages/Manager/DailyClose.razor.cs
  - src/MotoRent.Client/Pages/Manager/ShortageLogDialog.razor
  - src/MotoRent.Client/Pages/Manager/DailySummaryReportDialog.razor
  - src/MotoRent.Client/Resources/Pages/Manager/DailyClose.resx
  - src/MotoRent.Client/Resources/Pages/Manager/DailyClose.en.resx
  - src/MotoRent.Client/Resources/Pages/Manager/DailyClose.th.resx
  - src/MotoRent.Client/Resources/Pages/Manager/DailyClose.ms.resx
  - src/MotoRent.Services/TillService.session.cs
autonomous: true

must_haves:
  truths:
    - "Manager can perform daily close to lock a day"
    - "Manager can reopen a closed day with reason"
    - "Daily close captures summary of all sales, deposits, payouts, variances"
    - "Unresolved variances can be posted to shortage log with reason"
    - "Staff variance history is viewable"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Manager/DailyClose.razor"
      provides: "Daily close management page"
      min_lines: 200
    - path: "src/MotoRent.Client/Pages/Manager/ShortageLogDialog.razor"
      provides: "Shortage entry dialog for variance logging"
      min_lines: 80
    - path: "src/MotoRent.Client/Pages/Manager/DailySummaryReportDialog.razor"
      provides: "Printable daily summary report"
      min_lines: 150
    - path: "src/MotoRent.Services/TillService.session.cs"
      provides: "Day close check in session open"
      contains: "IsDayClosedAsync"
  key_links:
    - from: "src/MotoRent.Client/Pages/Manager/DailyClose.razor"
      to: "TillService.PerformDailyCloseAsync"
      via: "close day button click"
      pattern: "TillService\\.PerformDailyCloseAsync"
    - from: "src/MotoRent.Client/Pages/Manager/DailyClose.razor"
      to: "TillService.ReopenDayAsync"
      via: "reopen day button click"
      pattern: "TillService\\.ReopenDayAsync"
    - from: "src/MotoRent.Services/TillService.session.cs"
      to: "TillService.IsDayClosedAsync"
      via: "check before opening session"
      pattern: "IsDayClosedAsync"
---

<objective>
Create the daily close page with shortage logging and summary report generation.

Purpose: Enable EOD-02 (daily sales close), EOD-03 (summary generation), and EOD-04 (closed day blocking). Managers can close a day, post variances to shortage log, reopen if needed, and generate printable daily summary.

Output:
- DailyClose.razor page at /manager/daily-close
- ShortageLogDialog for posting variance entries
- DailySummaryReportDialog with browser print (follows HandoverReportDialog pattern)
- TillService.session.cs updated to check day closed before session open
- Localization resources (English, Thai, Malay)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-end-of-day-operations/09-CONTEXT.md
@.planning/phases/09-end-of-day-operations/09-01-SUMMARY.md
@src/MotoRent.Client/Pages/Manager/EndOfDay.razor
@src/MotoRent.Client/Pages/Manager/HandoverReportDialog.razor
@src/MotoRent.Services/TillService.session.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DailyClose page and ShortageLogDialog</name>
  <files>
    src/MotoRent.Client/Pages/Manager/DailyClose.razor
    src/MotoRent.Client/Pages/Manager/DailyClose.razor.cs
    src/MotoRent.Client/Pages/Manager/ShortageLogDialog.razor
  </files>
  <action>
Create DailyClose.razor at @page "/manager/daily-close":
- Authorization: [Authorize(Policy = "RequireTenantManager")]
- Inherit from LocalizedComponentBase<DailyClose>

Page layout:
1. Header with date selector (same pattern as EndOfDay.razor)

2. Day Status Card:
   - Current status badge (Open/Closed/Reconciled)
   - If Closed: Show closed by, closed at, and "Reopen" button
   - If WasReopened: Show reopen indicator with reason
   - If Open: Show "Close Day" button

3. Summary Statistics (same cards as EndOfDay but for selected date):
   - Total Cash In, Total Cash Out, Electronic Payments, Dropped to Safe
   - Total Sessions, Verified Sessions, Sessions with Variance
   - Total Variance (with color coding)

4. Sessions with Unresolved Variance section:
   - Table of sessions where Status == ClosedWithVariance and not verified
   - For each: Staff name, variance amount, action buttons
   - Actions: "Post to Shortage" (opens ShortageLogDialog), "View Details"

5. Staff Shortages Table (if any shortages logged):
   - Query ShortageLog for selected date
   - Show: Staff, Currency, Amount, Reason, Logged By, Time
   - Expandable or in-page

6. Action Buttons (footer):
   - "Generate Summary Report" (opens DailySummaryReportDialog)
   - "Close Day" (if Open) or "Reopen Day" (if Closed)

Close Day workflow:
- Confirm dialog: "Are you sure you want to close [date]? This will prevent new transactions."
- Check for unverified sessions with variance - warn but allow proceed
- Call TillService.PerformDailyCloseAsync
- Refresh page

Reopen Day workflow:
- Prompt for reason (required, min 10 chars)
- Call TillService.ReopenDayAsync
- Refresh page

Create ShortageLogDialog.razor:
- Parameters: int SessionId, string StaffUserName, string StaffDisplayName, decimal Variance, int? DailyCloseId
- Shows: Session details, variance amount, manager-provided reason input
- On confirm: Call TillService.LogShortageAsync
- Multi-currency support: If session has per-currency variances, show dropdown to select currency
  </action>
  <verify>
Files compile without errors:
```bash
dotnet build src/MotoRent.Client/MotoRent.Client.csproj
```
  </verify>
  <done>
DailyClose.razor displays day status, summary stats, and unresolved variances.
ShortageLogDialog allows posting variance with reason.
Close Day and Reopen Day workflows implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DailySummaryReportDialog</name>
  <files>
    src/MotoRent.Client/Pages/Manager/DailySummaryReportDialog.razor
  </files>
  <action>
Create DailySummaryReportDialog.razor following HandoverReportDialog.razor pattern:
- Parameters: int ShopId, DateTime Date, DailyTillSummary Summary
- Inherit from LocalizedComponentBase<DailySummaryReportDialog>
- Inject IJSRuntime for browser print

Dialog structure (two sections: screen preview + print-only):

1. Header Section:
   - Shop name (from ShopService)
   - Report title: "Daily Summary Report"
   - Date in bold
   - Generated by, generated at

2. Summary Section (matching EndOfDay summary cards):
   - Total Cash In | Total Cash Out
   - Card Payments | Bank Transfers | PromptPay
   - Total Dropped | Total Variance
   - Session Count | Verified Count

3. Session Breakdown Section:
   - Table with one row per session
   - Columns: Staff, Open Time, Close Time, Cash In, Cash Out, Dropped, Variance, Status
   - Footer row with totals

4. Payment Method Breakdown Section:
   - Table: Method | Amount
   - Rows: Cash (THB), Cash (USD), Cash (EUR), Cash (CNY), Card, PromptPay, Bank Transfer
   - Only show rows with values > 0

5. Shortages Section (if any logged):
   - Table: Staff | Currency | Amount | Reason
   - Only if GetShortageLogsAsync returns any for this date

6. Footer:
   - Print timestamp
   - Signature lines (Manager: ___________)

Print button calls JSRuntime.InvokeVoidAsync("print")

CSS: Use @media print rules to hide non-print elements. Follow HandoverReportDialog.razor.css pattern.
  </action>
  <verify>
Dialog compiles and can be opened:
```bash
dotnet build src/MotoRent.Client/MotoRent.Client.csproj
```
  </verify>
  <done>
DailySummaryReportDialog renders complete daily summary with all sections.
Browser print produces clean printable report.
Session breakdown and payment method tables included.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add day close check and localization</name>
  <files>
    src/MotoRent.Services/TillService.session.cs
    src/MotoRent.Client/Resources/Pages/Manager/DailyClose.resx
    src/MotoRent.Client/Resources/Pages/Manager/DailyClose.en.resx
    src/MotoRent.Client/Resources/Pages/Manager/DailyClose.th.resx
    src/MotoRent.Client/Resources/Pages/Manager/DailyClose.ms.resx
  </files>
  <action>
Update TillService.session.cs OpenSessionAsync method:
- At the start, before creating session, call IsDayClosedAsync(shopId, DateTime.Today)
- If day is closed, return SubmitOperation.CreateFailure("Cannot open session - this day has been closed")
- This enforces EOD-04 (closed days cannot have new transactions)

Create localization resources for DailyClose.razor:

Keys needed (approximately 35):
- PageTitle - "Daily Close"
- DailyCloseManagement - "Daily Close Management"
- DayStatus - "Day Status"
- StatusOpen - "Open"
- StatusClosed - "Closed"
- StatusReconciled - "Reconciled"
- ClosedBy - "Closed by {0}"
- ClosedAt - "Closed at {0}"
- ReopenedIndicator - "This day was reopened"
- ReopenReason - "Reason: {0}"
- CloseDay - "Close Day"
- ReopenDay - "Reopen Day"
- CloseDayConfirm - "Are you sure you want to close {0}? This will prevent new transactions."
- ReopenDayPrompt - "Enter reason for reopening (min 10 characters)"
- UnverifiedVariancesWarning - "There are {0} sessions with unresolved variances"
- SessionsWithVariance - "Sessions with Unresolved Variance"
- NoUnresolvedVariances - "All sessions resolved"
- PostToShortage - "Post to Shortage"
- ViewDetails - "View Details"
- StaffShortages - "Staff Shortages"
- NoShortagesLogged - "No shortages logged for this date"
- GenerateSummaryReport - "Generate Summary Report"
- DayClosed - "Day closed successfully"
- DayReopened - "Day reopened successfully"
- ShortageLogged - "Shortage logged successfully"
- DailySummaryReport - "Daily Summary Report"
- GeneratedBy - "Generated by"
- SessionBreakdown - "Session Breakdown"
- PaymentMethodBreakdown - "Payment Method Breakdown"
- ShortagesSection - "Logged Shortages"
- Signature - "Manager Signature"
- EnterShortageReason - "Enter reason for this shortage"
- AmountInThb - "Amount in THB"
- Method - "Method"
- Amount - "Amount"

Translations for Thai and Malay.
  </action>
  <verify>
Service builds and resource files exist:
```bash
dotnet build src/MotoRent.Services/MotoRent.Services.csproj
ls src/MotoRent.Client/Resources/Pages/Manager/DailyClose*.resx
```
  </verify>
  <done>
TillService.OpenSessionAsync checks IsDayClosedAsync before creating session.
All localization files created with Thai and Malay translations.
EOD-04 (closed day blocking) enforced at service level.
  </done>
</task>

</tasks>

<verification>
1. DailyClose.razor accessible at /manager/daily-close with manager authorization
2. Day status card shows current close state with appropriate actions
3. "Close Day" sets status to Closed and prevents new sessions
4. "Reopen Day" requires reason and resets to Open
5. ShortageLogDialog logs variance entries to ShortageLog entity
6. DailySummaryReportDialog generates printable report via browser print
7. OpenSessionAsync returns error when day is closed
8. All localization keys have Thai and Malay translations
</verification>

<success_criteria>
- Manager can close a day (EOD-02)
- Closed day prevents new till sessions (EOD-04)
- Daily summary report shows all sales, deposits, payouts, variances (EOD-03)
- Variances can be posted to shortage log with manager's reason
- Manager can reopen a closed day with documented reason
</success_criteria>

<output>
After completion, create `.planning/phases/09-end-of-day-operations/09-03-SUMMARY.md`
</output>
