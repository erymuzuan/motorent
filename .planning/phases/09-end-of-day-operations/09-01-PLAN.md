---
phase: 09-end-of-day-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Entities/DailyClose.cs
  - src/MotoRent.Domain/Entities/ShortageLog.cs
  - database/tables/MotoRent.DailyClose.sql
  - database/tables/MotoRent.ShortageLog.sql
  - src/MotoRent.Services/TillService.eod.cs
  - src/MotoRent.Server/Program.cs
autonomous: true

must_haves:
  truths:
    - "Manager can query if a day is closed"
    - "Manager can perform daily close with totals captured"
    - "Manager can reopen a closed day with reason"
    - "Shortage entries are recorded with staff attribution"
    - "Cash drops can be queried per session by currency"
  artifacts:
    - path: "src/MotoRent.Domain/Entities/DailyClose.cs"
      provides: "Day-level close state tracking"
      exports: ["DailyClose", "DailyCloseStatus"]
    - path: "src/MotoRent.Domain/Entities/ShortageLog.cs"
      provides: "Variance accountability records"
      exports: ["ShortageLog"]
    - path: "database/tables/MotoRent.DailyClose.sql"
      provides: "SQL table for daily close"
      contains: "CREATE TABLE"
    - path: "database/tables/MotoRent.ShortageLog.sql"
      provides: "SQL table for shortage log"
      contains: "CREATE TABLE"
    - path: "src/MotoRent.Services/TillService.eod.cs"
      provides: "EOD service methods"
      exports: ["GetOrCreateDailyCloseAsync", "PerformDailyCloseAsync", "IsDayClosedAsync", "ReopenDayAsync", "LogShortageAsync", "GetDropTotalsByCurrencyAsync", "GetShortageLogsAsync"]
  key_links:
    - from: "src/MotoRent.Services/TillService.eod.cs"
      to: "src/MotoRent.Domain/Entities/DailyClose.cs"
      via: "CRUD operations"
      pattern: "Context\\.LoadOneAsync<DailyClose>"
    - from: "src/MotoRent.Services/TillService.eod.cs"
      to: "src/MotoRent.Domain/Entities/ShortageLog.cs"
      via: "shortage logging"
      pattern: "new ShortageLog"
---

<objective>
Create domain entities and service methods for end-of-day operations.

Purpose: Establish the data layer for daily close tracking, shortage logging, and cash drop verification. This enables EOD-02 (daily close), EOD-04 (closed day blocking), and accountability tracking.

Output:
- DailyClose entity with status enum (Open, Closed, Reconciled)
- ShortageLog entity for variance accountability
- SQL table scripts for both entities
- TillService.eod.cs partial file with EOD methods
- Repository registrations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-end-of-day-operations/09-CONTEXT.md
@.planning/phases/09-end-of-day-operations/09-RESEARCH.md
@src/MotoRent.Domain/Entities/TillSession.cs
@src/MotoRent.Services/TillService.cs
@src/MotoRent.Services/TillService.manager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DailyClose and ShortageLog entities</name>
  <files>
    src/MotoRent.Domain/Entities/DailyClose.cs
    src/MotoRent.Domain/Entities/ShortageLog.cs
  </files>
  <action>
Create DailyClose.cs:
- Inherit from Entity base class
- DailyCloseId (int, primary key)
- ShopId (int)
- Date (DateTime, date only - no time component)
- Status (DailyCloseStatus enum: Open, Closed, Reconciled)
- ClosedAt (DateTimeOffset?)
- ClosedByUserName (string?)
- Denormalized summary totals: TotalCashIn, TotalCashOut, TotalDropped, TotalVariance, TotalElectronicPayments (all decimal)
- SessionCount (int)
- SessionsWithVariance (int)
- Reopen tracking: WasReopened (bool), ReopenReason (string?), ReopenedAt (DateTimeOffset?), ReopenedByUserName (string?)
- Override GetId/SetId for DailyCloseId

Create DailyCloseStatus enum in same file:
- Open (day is open, transactions allowed)
- Closed (day is closed, soft block)
- Reconciled (day fully verified)

Create ShortageLog.cs:
- Inherit from Entity base class
- ShortageLogId (int, primary key)
- ShopId (int)
- TillSessionId (int)
- DailyCloseId (int?) - links to daily close operation
- StaffUserName, StaffDisplayName (string)
- Currency (string, default THB)
- Amount (decimal)
- AmountInThb (decimal) - converted at time of logging
- Reason (string)
- LoggedByUserName (string)
- LoggedAt (DateTimeOffset)
- Override GetId/SetId for ShortageLogId

Follow existing entity patterns from TillSession.cs. Use m_ prefix for private fields if needed. Add XML documentation.
  </action>
  <verify>
Files compile without errors:
```bash
dotnet build src/MotoRent.Domain/MotoRent.Domain.csproj
```
  </verify>
  <done>
DailyClose.cs contains entity with all fields and DailyCloseStatus enum.
ShortageLog.cs contains entity with all fields.
Both inherit from Entity and have GetId/SetId overrides.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SQL table scripts</name>
  <files>
    database/tables/MotoRent.DailyClose.sql
    database/tables/MotoRent.ShortageLog.sql
  </files>
  <action>
Create MotoRent.DailyClose.sql:
```sql
CREATE TABLE [MotoRent].[DailyClose]
(
    [DailyCloseId] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ShopId] AS CAST(JSON_VALUE([Json], '$.ShopId') AS INT),
    [Date] AS CAST(JSON_VALUE([Json], '$.Date') AS DATE),
    [Status] AS CAST(JSON_VALUE([Json], '$.Status') AS NVARCHAR(20)),
    [ClosedByUserName] AS CAST(JSON_VALUE([Json], '$.ClosedByUserName') AS NVARCHAR(100)),
    [TotalVariance] AS CAST(JSON_VALUE([Json], '$.TotalVariance') AS DECIMAL(18,2)),
    [WasReopened] AS CAST(JSON_VALUE([Json], '$.WasReopened') AS BIT),
    [Json] NVARCHAR(MAX) NOT NULL,
    [CreatedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [ChangedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [CreatedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    [ChangedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET()
)

CREATE INDEX IDX_MotoRent_DailyClose ON [MotoRent].[DailyClose]([ShopId], [Date])
```

Create MotoRent.ShortageLog.sql:
```sql
CREATE TABLE [MotoRent].[ShortageLog]
(
    [ShortageLogId] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ShopId] AS CAST(JSON_VALUE([Json], '$.ShopId') AS INT),
    [TillSessionId] AS CAST(JSON_VALUE([Json], '$.TillSessionId') AS INT),
    [DailyCloseId] AS CAST(JSON_VALUE([Json], '$.DailyCloseId') AS INT),
    [StaffUserName] AS CAST(JSON_VALUE([Json], '$.StaffUserName') AS NVARCHAR(100)),
    [Currency] AS CAST(JSON_VALUE([Json], '$.Currency') AS CHAR(3)),
    [Amount] AS CAST(JSON_VALUE([Json], '$.Amount') AS DECIMAL(18,2)),
    [LoggedAt] AS CAST(JSON_VALUE([Json], '$.LoggedAt') AS DATETIMEOFFSET),
    [Json] NVARCHAR(MAX) NOT NULL,
    [CreatedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [ChangedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [CreatedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    [ChangedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET()
)

CREATE INDEX IDX_MotoRent_ShortageLog ON [MotoRent].[ShortageLog]([ShopId], [TillSessionId], [StaffUserName])
```

Follow existing SQL patterns from database/tables/ folder. Use JSON computed columns for searchable fields.
  </action>
  <verify>
SQL files exist and contain valid CREATE TABLE statements:
```bash
ls database/tables/MotoRent.DailyClose.sql database/tables/MotoRent.ShortageLog.sql
```
  </verify>
  <done>
Both SQL files exist with proper table definitions, computed columns, and indexes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TillService.eod.cs with EOD methods</name>
  <files>
    src/MotoRent.Services/TillService.eod.cs
    src/MotoRent.Server/Program.cs
  </files>
  <action>
Create TillService.eod.cs as a partial class file with these methods:

1. GetOrCreateDailyCloseAsync(int shopId, DateTime date)
   - Load existing DailyClose by ShopId and Date
   - If not found, create new with Status = Open
   - Return the DailyClose entity

2. PerformDailyCloseAsync(int shopId, DateTime date, string managerUserName)
   - Get or create DailyClose
   - If already Closed, return failure
   - Call GetDailySummaryAsync to get totals
   - Populate denormalized fields (TotalCashIn, TotalCashOut, etc.)
   - Set Status = Closed, ClosedAt = now, ClosedByUserName = manager
   - Save and return SubmitOperation

3. IsDayClosedAsync(int shopId, DateTime date)
   - Load DailyClose
   - Return true if Status == Closed or Reconciled

4. ReopenDayAsync(int shopId, DateTime date, string reason, string managerUserName)
   - Load DailyClose
   - If not Closed, return failure
   - Set Status = Open, WasReopened = true, ReopenReason, ReopenedAt, ReopenedByUserName
   - Save and return SubmitOperation

5. LogShortageAsync(int shopId, int tillSessionId, int? dailyCloseId, string staffUserName, string staffDisplayName, string currency, decimal amount, string reason, string managerUserName)
   - Convert to THB if foreign currency using ExchangeRateService
   - Create ShortageLog with all fields
   - Amount stored as positive (use Math.Abs)
   - Save and return SubmitOperation

6. GetDropTotalsByCurrencyAsync(int sessionId)
   - Load TillTransactions where TransactionType == Drop and !IsVoided
   - Group by Currency and sum amounts
   - Return Dictionary<string, decimal>

7. GetShortageLogsAsync(int shopId, DateTime? fromDate = null, DateTime? toDate = null)
   - Query ShortageLog by ShopId with optional date range
   - Order by LoggedAt descending
   - Return List<ShortageLog>

8. GetDailyCloseAsync(int shopId, DateTime date)
   - Load DailyClose by ShopId and Date
   - Return null if not found

Register repositories in Program.cs:
- services.AddSingleton<IRepository<DailyClose>, SqlJsonRepository<DailyClose>>();
- services.AddSingleton<IRepository<ShortageLog>, SqlJsonRepository<ShortageLog>>();

Follow existing TillService.manager.cs patterns. Add XML documentation.
  </action>
  <verify>
Solution builds without errors:
```bash
dotnet build
```
  </verify>
  <done>
TillService.eod.cs contains all 8 methods with proper implementation.
Program.cs includes repository registrations for DailyClose and ShortageLog.
  </done>
</task>

</tasks>

<verification>
1. All files compile without errors: `dotnet build`
2. Entities follow existing patterns (check TillSession.cs for reference)
3. SQL files use JSON computed columns pattern (check existing table scripts)
4. TillService.eod.cs is a proper partial class extending TillService
5. Repository registrations added to Program.cs
</verification>

<success_criteria>
- DailyClose entity tracks day-level close state with reopen capability
- ShortageLog entity records variance entries with staff attribution
- SQL tables created with proper indexes for ShopId + Date queries
- TillService has EOD methods for close workflow, shortage logging, and drop verification
- All code compiles and follows project conventions
</success_criteria>

<output>
After completion, create `.planning/phases/09-end-of-day-operations/09-01-SUMMARY.md`
</output>
