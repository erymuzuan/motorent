---
phase: "09"
plan: "03"
subsystem: till-eod
tags: [blazor, daily-close, shortage-tracking, reports, localization]
depends_on: [09-01, 09-02]
provides:
  - Daily close management page
  - Shortage logging dialog
  - Daily summary report dialog
  - Navigation menu updates
affects:
  - Phase 09 end of day workflow completion
tech-stack:
  patterns: [LocalizedDialogBase, print-friendly-reports]
key-files:
  created:
    - src/MotoRent.Client/Pages/Manager/DailySummaryReportDialog.razor
    - src/MotoRent.Client/Resources/Pages/Manager/DailyClose.resx (4 files)
    - src/MotoRent.Client/Resources/Pages/Manager/ShortageLogDialog.resx (4 files)
    - src/MotoRent.Client/Resources/Pages/Manager/DailySummaryReportDialog.resx (4 files)
  modified:
    - src/MotoRent.Client/Pages/Manager/DailyClose.razor
    - src/MotoRent.Client/Pages/Manager/DailyClose.razor.cs
    - src/MotoRent.Client/Pages/Manager/ShortageLogDialog.razor
    - src/MotoRent.Services/TillService.session.cs
    - src/MotoRent.Client/Layout/NavMenu.razor
    - src/MotoRent.Client/Resources/Layout/NavMenu.resx (2 files)
decisions:
  - key: closed-day-check
    description: Added IsDayClosedAsync check to OpenSessionAsync
    rationale: Prevents opening new sessions on days that have been administratively closed
metrics:
  duration: ~25 minutes
  completed: 2026-01-21
---

# Phase 09 Plan 03: Daily Close & Manager UI Summary

## One-Liner
Daily close page with status tracking, shortage logging dialog, printable summary report, and navigation integration.

## What Was Built

### 1. DailySummaryReportDialog (320 lines)
Printable daily summary report dialog:
- **Header section**: Shop name, date, generated by/at info
- **Summary statistics**: Cash in/out, electronic payments, dropped to safe
- **Session breakdown table**: Staff, open/close times, amounts, variance, status
- **Payment method breakdown**: Cash, card, PromptPay, bank transfer totals
- **Logged shortages section**: Currency, amount, reason for each shortage
- **Print footer**: Manager signature line, print timestamp
- **Print functionality**: Browser print via JSRuntime.InvokeVoidAsync("print")

### 2. DailyClose Page Updates
Enhanced existing DailyClose.razor and DailyClose.razor.cs:
- Fixed SubmitOperation property names (Success/Message)
- Added UnresolvedSessions computed property
- Implemented OpenSummaryReportAsync to show DailySummaryReportDialog
- Proper integration with existing service methods

### 3. Day Close Check in TillService.session.cs
Added business rule enforcement:
```csharp
// Check if day is closed (EOD-04: closed days cannot have new transactions)
if (await this.IsDayClosedAsync(shopId, DateTime.Today))
    return SubmitOperation.CreateFailure("Cannot open session - this day has been closed");
```

### 4. Localization Resources
Created 12 new .resx files (3 dialogs x 4 languages):

**DailyClose.resx** (48 keys):
- Page title, status labels, action buttons
- Summary card labels, variance display
- Thai: ปิดบัญชีประจำวัน, ส่วนต่าง, กะ

**ShortageLogDialog.resx** (13 keys):
- Posting explanation, form labels, validation messages
- Thai: บันทึกขาดเงิน, เหตุผล

**DailySummaryReportDialog.resx** (42 keys):
- Report sections, table headers, status labels
- Thai: รายงานสรุปประจำวัน, พนักงาน, รวม

### 5. Navigation Menu Updates
Added links under Finance dropdown:
- Daily Close (/manager/daily-close)
- Till Dashboard (/manager/till-dashboard)
- Updated NavMenu.resx for en and th translations

## Files Changed

| File | Action | Lines |
|------|--------|-------|
| DailySummaryReportDialog.razor | Created | 320 |
| DailyClose.razor.cs | Modified | +15/-10 |
| ShortageLogDialog.razor | Modified | +5 |
| TillService.session.cs | Modified | +4 |
| NavMenu.razor | Modified | +6 |
| DailyClose.resx (4 files) | Created | 244 |
| ShortageLogDialog.resx (4 files) | Created | 104 |
| DailySummaryReportDialog.resx (4 files) | Created | 168 |
| NavMenu.resx (2 files) | Modified | +36 |

## Commits

| Hash | Description |
|------|-------------|
| 514e209 | feat(09-03): create DailySummaryReportDialog and update DailyClose page |
| 747e1d5 | feat(09-03): add day close check and localization resources |
| 98aadae | feat(09-03): add Daily Close and Till Dashboard to navigation |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

- [x] Build succeeds with no errors
- [x] DailyClose page renders with correct status display
- [x] DailySummaryReportDialog shows comprehensive daily report
- [x] ShortageLogDialog validates and submits correctly
- [x] OpenSessionAsync checks day closed status
- [x] Navigation shows new menu items for managers
- [x] All localization keys exist in 4 languages

## Next Phase Readiness

Dependencies for 09-04 (if any):
- Daily close infrastructure is now complete
- Manager UI is navigable and functional
- Report generation is available for daily summaries

No blockers identified for continuation.
