---
phase: 04-payment-terminal
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  - src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
autonomous: true

must_haves:
  truths:
    - "Staff completes payment when total received >= amount due"
    - "Change is calculated and displayed in THB only"
    - "All payment entries are recorded to the till session"
    - "Receipt is generated with all payment details"
    - "Dialog closes with completed transaction result"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor"
      provides: "Step 3 integration with PaymentTerminalPanel"
    - path: "src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor"
      provides: "Complete Payment flow with till recording"
  key_links:
    - from: "TillTransactionDialog.razor"
      to: "PaymentTerminalPanel.razor"
      via: "Component rendering in Step 3"
      pattern: "PaymentTerminalPanel.*AmountDue"
    - from: "PaymentTerminalPanel.razor"
      to: "TillService"
      via: "RecordForeignCurrencyPaymentAsync calls"
      pattern: "TillService.*RecordForeignCurrencyPaymentAsync"
    - from: "PaymentTerminalPanel.razor"
      to: "ReceiptPayment"
      via: "Conversion from PaymentEntry to ReceiptPayment"
      pattern: "ReceiptPayment"
---

<objective>
Wire the PaymentTerminalPanel into TillTransactionDialog as Step 3 and implement the complete payment flow including till recording and receipt generation.

Purpose: Complete the payment terminal integration so staff can receive payments, record them to the till, and generate receipts in a single workflow.

Output: Fully functional payment terminal workflow from item confirmation through payment completion with till and receipt integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-payment-terminal/04-CONTEXT.md
@.planning/phases/04-payment-terminal/04-RESEARCH.md
@.planning/phases/04-payment-terminal/04-01-SUMMARY.md
@.planning/phases/04-payment-terminal/04-02-SUMMARY.md
@src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
@src/MotoRent.Services/TillService.cs
@src/MotoRent.Domain/Entities/ReceiptPayment.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Step 3 (Payment Terminal) to TillTransactionDialog</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  </files>
  <action>
Modify TillTransactionDialog.razor to add Step 3:

**Add state for step tracking:**
```csharp
private int m_currentStep = 1; // 1 = Search, 2 = Item Confirmation, 3 = Payment
```

**Modify step transitions:**

1. `SelectBookingAsync` and `SelectRentalAsync` should set `m_currentStep = 2` (item confirmation)

2. `ProceedToPayment()` should now set `m_currentStep = 3` instead of closing dialog:
```csharp
private void ProceedToPayment()
{
    m_currentStep = 3;
}
```

3. `ClearSelection()` should reset to step 1:
```csharp
private void ClearSelection()
{
    m_selectedBooking = null;
    m_selectedRental = null;
    m_lineItems.Clear();
    m_currentStep = 1;
    // ... rest of existing reset
}
```

4. Add `GoBackToItemConfirmation()`:
```csharp
private void GoBackToItemConfirmation()
{
    m_currentStep = 2;
}
```

**Update UI structure:**

Replace the current step 1/2 conditional with 3-step logic:
```razor
@if (m_currentStep == 1)
{
    @* Step 1: Search & Select (existing code) *@
}
else if (m_currentStep == 2)
{
    @* Step 2: Item Confirmation (existing code) *@
}
else if (m_currentStep == 3)
{
    @* Step 3: Payment Terminal *@
    <PaymentTerminalPanel
        AmountDue="@m_grandTotal"
        OnPaymentComplete="@OnPaymentComplete"
        OnCancel="@GoBackToItemConfirmation" />
}
```

**Update footer for Step 3:**
```razor
@if (m_currentStep == 3)
{
    @* Footer is handled by PaymentTerminalPanel's Complete Payment button *@
    <div class="modal-footer sticky-bottom bg-white border-top">
        <button type="button" class="btn btn-ghost-secondary" @onclick="GoBackToItemConfirmation">
            <i class="ti ti-arrow-left"></i> @Localizer["BackToItems"]
        </button>
    </div>
}
```

**Add localization keys:**
| Key | English | Thai |
|-----|---------|------|
| BackToItems | Back to Items | กลับไปรายการ |
| PaymentComplete | Payment Complete | ชำระเงินเสร็จสิ้น |
  </action>
  <verify>
`dotnet build src/MotoRent.Client` compiles without errors
TillTransactionDialog progresses: Search -> Item Confirmation -> Payment Terminal
Back button in Step 3 returns to Step 2
  </verify>
  <done>
TillTransactionDialog has 3 steps: Search, Item Confirmation, Payment Terminal. Navigation between steps works correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Complete Payment flow with till recording</name>
  <files>
    src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
  </files>
  <action>
Add till recording logic to PaymentTerminalPanel when Complete Payment is clicked:

**Add service injection:**
```csharp
@inject TillService TillService
@inject ILogger<PaymentTerminalPanel> Logger
```

**Add parameters for context:**
```csharp
[Parameter] public int SessionId { get; set; }
[Parameter] public int? RentalId { get; set; }
[Parameter] public int? BookingId { get; set; }
[Parameter] public TillTransactionType TransactionType { get; set; }
[Parameter] public string UserName { get; set; } = "";
```

**Implement CompletePayment method:**
```csharp
private async Task CompletePayment()
{
    if (m_remaining > 0) return; // Should not happen due to button disabled

    m_completing = true;
    try
    {
        // Record each payment entry to the till
        foreach (var entry in m_paymentEntries)
        {
            var description = GetPaymentDescription(entry);

            SubmitOperation result;
            if (entry.Currency == SupportedCurrencies.THB || entry.Method != PaymentMethods.Cash)
            {
                // THB cash or non-cash payments use standard RecordCashInAsync
                var type = MapMethodToTransactionType(entry.Method);
                result = await TillService.RecordCashInAsync(
                    SessionId,
                    type,
                    entry.AmountInBaseCurrency,
                    description,
                    UserName,
                    rentalId: RentalId,
                    notes: entry.Reference);
            }
            else
            {
                // Foreign currency cash uses RecordForeignCurrencyPaymentAsync
                result = await TillService.RecordForeignCurrencyPaymentAsync(
                    SessionId,
                    TransactionType,
                    entry.Currency,
                    entry.Amount,
                    description,
                    UserName,
                    rentalId: RentalId,
                    notes: entry.Reference);
            }

            if (!result.Success)
            {
                Logger.LogError("Failed to record payment: {Error}", result.ErrorMessage);
                // Could show error and allow retry, but for MVP we continue
            }
        }

        // Convert PaymentEntry list to ReceiptPayment list
        var receiptPayments = m_paymentEntries.Select(e => new ReceiptPayment
        {
            Method = e.Method,
            Amount = e.Amount,
            Currency = e.Currency,
            ExchangeRate = e.ExchangeRate,
            AmountInBaseCurrency = e.AmountInBaseCurrency,
            ExchangeRateSource = e.ExchangeRateSource,
            ExchangeRateId = e.ExchangeRateId,
            Reference = e.Reference,
            PaidAt = DateTimeOffset.Now
        }).ToList();

        await OnPaymentComplete.InvokeAsync(receiptPayments);
    }
    finally
    {
        m_completing = false;
    }
}
```

**Helper methods:**
```csharp
private string GetPaymentDescription(PaymentEntry entry)
{
    var methodLabel = entry.Method switch
    {
        PaymentMethods.Cash => $"Cash ({entry.Currency})",
        PaymentMethods.Card => "Card payment",
        PaymentMethods.PromptPay => "PromptPay",
        _ => entry.Method
    };

    return $"{TransactionType}: {methodLabel}";
}

private TillTransactionType MapMethodToTransactionType(string method) => method switch
{
    PaymentMethods.Card => TillTransactionType.CardPayment,
    PaymentMethods.PromptPay => TillTransactionType.PromptPay,
    PaymentMethods.BankTransfer => TillTransactionType.BankTransfer,
    _ => TransactionType // Use passed transaction type for cash
};
```

**State addition:**
```csharp
private bool m_completing;
```

**Update Complete Payment button:**
```razor
<button type="button" class="btn btn-success btn-lg w-100"
        @onclick="CompletePayment"
        disabled="@(m_remaining > 0 || m_completing)">
    @if (m_completing)
    {
        <span class="spinner-border spinner-border-sm me-2"></span>
    }
    <i class="ti ti-check me-1"></i>
    @Localizer["CompletePayment"]
    @if (m_change > 0)
    {
        <span class="ms-2">(@Localizer["Change"]: @FormatThb(m_change))</span>
    }
</button>
```
  </action>
  <verify>
`dotnet build src/MotoRent.Client` compiles without errors
Complete Payment records each payment entry to till via TillService
  </verify>
  <done>
Complete Payment button records all payment entries to the till session using TillService. Foreign currency payments use RecordForeignCurrencyPaymentAsync with exchange rate audit trail. ReceiptPayment list is returned via OnPaymentComplete callback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire payment completion in TillTransactionDialog and close dialog</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
  </files>
  <action>
Complete the payment flow in TillTransactionDialog:

**Add callback handler:**
```csharp
private async Task OnPaymentComplete(List<ReceiptPayment> payments)
{
    // Build the final transaction result
    var result = new TransactionSearchResult
    {
        EntityType = m_selectedBooking is not null ? TransactionEntityType.Booking : TransactionEntityType.Rental,
        Booking = m_selectedBooking,
        Rental = m_selectedRental,
        TransactionType = m_transactionType,
        LineItems = m_lineItems.ToList(),
        GrandTotal = m_grandTotal,
        Payments = payments,
        Change = payments.Sum(p => p.AmountInBaseCurrency) - m_grandTotal
    };

    this.ModalService.Close(ModalResult.Ok(result));
}
```

**Update TransactionSearchResult model (if not already done):**
In `src/MotoRent.Domain/Models/TransactionSearchResult.cs`, add:
```csharp
/// <summary>
/// Payment entries collected during the transaction
/// </summary>
public List<ReceiptPayment> Payments { get; set; } = [];

/// <summary>
/// Change amount in THB (if overpaid)
/// </summary>
public decimal Change { get; set; }
```

**Update PaymentTerminalPanel reference in Step 3:**
```razor
@if (m_currentStep == 3)
{
    <PaymentTerminalPanel
        AmountDue="@m_grandTotal"
        SessionId="@SessionId"
        RentalId="@(m_selectedRental?.RentalId)"
        BookingId="@(m_selectedBooking?.BookingId)"
        TransactionType="@m_transactionType"
        UserName="@UserName"
        OnPaymentComplete="@OnPaymentComplete"
        OnCancel="@GoBackToItemConfirmation" />
}
```

**Add UserName parameter to TillTransactionDialog:**
```csharp
[Parameter] public string UserName { get; set; } = "";
```

**Ensure caller provides UserName:**
The Till page that opens this dialog must pass the current user's username. This should already be available from the existing TillBookingDepositDialog pattern.

**Update modal footer for step 3:**
The footer "Back to Items" button should be outside PaymentTerminalPanel since the panel has its own Complete Payment button:
```razor
<div class="modal-footer sticky-bottom bg-white border-top" style="z-index: 10;">
    @if (m_currentStep == 1)
    {
        <button type="button" class="btn btn-ghost-secondary" @onclick="Cancel">
            @Localizer["Cancel"]
        </button>
    }
    else if (m_currentStep == 2)
    {
        <button type="button" class="btn btn-ghost-secondary" @onclick="ClearSelection">
            <i class="ti ti-arrow-left"></i> @Localizer["Back"]
        </button>
        <button type="button" class="btn btn-purple btn-lg" @onclick="ProceedToPayment"
                disabled="@(m_grandTotal <= 0)">
            <i class="ti ti-credit-card"></i>
            @Localizer["ProceedToPayment"] - @FormatAmount(m_grandTotal)
        </button>
    }
    @* Step 3 has no footer - PaymentTerminalPanel has its own buttons *@
</div>
```

Actually, reconsider: PaymentTerminalPanel should handle its own Complete Payment button internally, but the Back button should remain in the dialog footer for consistency. Update the PaymentTerminalPanel to NOT include a back button in its own layout - the OnCancel callback is for the parent to handle.
  </action>
  <verify>
`dotnet build src/MotoRent.Client` compiles without errors
Complete flow: Search -> Select -> Confirm Items -> Process Payment -> Dialog closes with result
TransactionSearchResult includes Payments and Change fields
  </verify>
  <done>
TillTransactionDialog receives payment completion callback, builds TransactionSearchResult with payments and change, and closes the dialog. The result can be used by the calling page for receipt generation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `dotnet build src/MotoRent.Client` - No errors
2. Full workflow test:
   - Open TillTransactionDialog
   - Search for booking/rental
   - Select transaction, review items
   - Click "Proceed to Payment"
   - PaymentTerminalPanel shows with amount due
   - Add THB cash payment via keypad
   - Add USD cash payment via denomination counting
   - Add card payment
   - Total received >= amount due
   - Complete Payment button enables
   - Click Complete Payment
   - All payments recorded to till
   - Dialog closes with TransactionSearchResult containing payments
</verification>

<success_criteria>
- TillTransactionDialog has 3 steps: Search, Item Confirmation, Payment Terminal
- PaymentTerminalPanel receives session context (SessionId, RentalId, etc.)
- Complete Payment records all entries to till via TillService
- Foreign currency cash uses RecordForeignCurrencyPaymentAsync with rate audit
- Non-cash payments use appropriate transaction types (CardPayment, PromptPay)
- Dialog closes with TransactionSearchResult including Payments list and Change
- TransactionSearchResult model extended with Payments and Change properties
- Change displayed on Complete Payment button when > 0
</success_criteria>

<output>
After completion, create `.planning/phases/04-payment-terminal/04-03-SUMMARY.md`
</output>
