---
phase: 04-payment-terminal
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor
  - src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor.css
  - src/MotoRent.Client/Resources/Components/Till/ThbKeypadPanel.resx
  - src/MotoRent.Client/Resources/Components/Till/ThbKeypadPanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/ThbKeypadPanel.th.resx
  - src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
autonomous: true

must_haves:
  truths:
    - "Staff can enter THB amount using numeric keypad"
    - "Staff can use quick amount buttons (100, 500, 1000, Remaining)"
    - "Staff can enter foreign currency using denomination counting"
    - "Staff sees THB equivalent when entering foreign currency"
    - "Payment entries are added to the running list"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor"
      provides: "THB numeric keypad with quick amounts"
      min_lines: 80
    - path: "src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor"
      provides: "Updated with THB keypad and denomination panel integration"
  key_links:
    - from: "PaymentTerminalPanel.razor"
      to: "ThbKeypadPanel.razor"
      via: "Component reference"
      pattern: "ThbKeypadPanel"
    - from: "PaymentTerminalPanel.razor"
      to: "DenominationEntryPanel.razor"
      via: "Component reference"
      pattern: "DenominationEntryPanel"
    - from: "PaymentTerminalPanel.razor"
      to: "ExchangeRateService"
      via: "Inject and ConvertToThbAsync"
      pattern: "ExchangeRateService"
---

<objective>
Create the THB keypad component and integrate both THB and foreign currency input into the PaymentTerminalPanel.

Purpose: Enable staff to quickly enter THB amounts with a numeric keypad and foreign currency amounts using denomination counting, with real-time exchange rate conversion.

Output: Functional cash payment input for all supported currencies (THB, USD, EUR, CNY) with proper exchange rate handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-payment-terminal/04-CONTEXT.md
@.planning/phases/04-payment-terminal/04-RESEARCH.md
@.planning/phases/04-payment-terminal/04-01-SUMMARY.md
@src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor
@src/MotoRent.Services/ExchangeRateService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThbKeypadPanel component</name>
  <files>
    src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor
    src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor.css
    src/MotoRent.Client/Resources/Components/Till/ThbKeypadPanel.resx
    src/MotoRent.Client/Resources/Components/Till/ThbKeypadPanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/ThbKeypadPanel.th.resx
  </files>
  <action>
Create ThbKeypadPanel.razor in Components/Till/ with:

**Component signature:**
- Inherit from `LocalizedComponentBase<ThbKeypadPanel>`
- Parameters:
  - `decimal RemainingAmount` - Amount still due (for quick fill)
  - `EventCallback<decimal> OnAmountSubmit` - Called when amount is submitted

**Display area:**
- Large display showing current entered amount (e.g., "฿2,500")
- Right-aligned, large font (fs-1)
- Show "฿0" when empty

**Numeric keypad (3x4 grid):**
```
[ 1 ] [ 2 ] [ 3 ]
[ 4 ] [ 5 ] [ 6 ]
[ 7 ] [ 8 ] [ 9 ]
[ C ] [ 0 ] [ < ]
```
- C = Clear all (clears input to empty)
- < = Backspace (removes last digit)
- Each button is a large touch-friendly button (btn-lg)

**Quick amount buttons (horizontal row):**
- ฿100, ฿500, ฿1,000, [Remaining: ฿X,XXX]
- Clicking adds that amount directly and submits
- Remaining button shows actual remaining amount, disabled if remaining <= 0

**Add button:**
- Large green button at bottom: "Add ฿X,XXX"
- Disabled when current amount is 0
- On click: calls OnAmountSubmit with current amount, then clears input

**State:**
- `m_input` string - The entered digits (e.g., "2500")
- `EnteredAmount` computed property - Parse m_input to decimal

**Methods:**
- `OnKeyPress(char key)` - Handles digit entry
- `OnClear()` - Clears m_input
- `OnBackspace()` - Removes last character
- `OnQuickAmount(decimal amount)` - Sets amount and auto-submits
- `OnAddPayment()` - Submits current amount

**CSS styling:**
- `.thb-keypad-panel` container
- `.keypad-display` for amount display
- `.keypad-grid` for 3x4 grid layout
- `.keypad-btn` for individual keys (large, touch-friendly)
- `.quick-amounts` row
- `.add-btn` for submit button

**Localization keys:**
| Key | English | Thai |
|-----|---------|------|
| EnterThbAmount | Enter THB Amount | ใส่จำนวนเงินบาท |
| Clear | Clear | ล้าง |
| AddPayment | Add Payment | เพิ่มการชำระ |
| Remaining | Remaining | ยอดคงเหลือ |
  </action>
  <verify>
`dotnet build src/MotoRent.Client` compiles without errors
ThbKeypadPanel.razor exists with keypad grid and quick amounts
  </verify>
  <done>
ThbKeypadPanel renders numeric keypad with 1-9, 0, C, backspace buttons, quick amount buttons (100, 500, 1000, Remaining), and Add button that calls OnAmountSubmit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate THB keypad and DenominationEntryPanel into PaymentTerminalPanel</name>
  <files>
    src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
  </files>
  <action>
Update PaymentTerminalPanel.razor to wire up cash input components:

**Add service injection:**
```csharp
@inject ExchangeRateService ExchangeRateService
```

**THB input (when m_selectedMethod == "Cash" && m_selectedCurrency == "THB"):**
```razor
<ThbKeypadPanel
    RemainingAmount="@m_remaining"
    OnAmountSubmit="@OnThbAmountSubmit" />
```

**Foreign currency input (when m_selectedMethod == "Cash" && m_selectedCurrency != "THB"):**
Show:
1. Header: "Count [Currency] Notes" (e.g., "Count USD Notes")
2. Current exchange rate display: "Rate: $1 = ฿35.50"
3. DenominationEntryPanel component:
```razor
<DenominationEntryPanel
    Currency="@m_selectedCurrency"
    DenominationCounts="@m_currentDenominations"
    DenominationCountsChanged="@OnDenominationCountsChanged"
    ShowTotal="true" />
```
4. THB equivalent display: "= ฿X,XXX" (calculated from total * rate)
5. "Add [Currency] Payment" button (disabled if total is 0)

**State additions:**
- `m_currentDenominations` - `Dictionary<decimal, int>` for denomination counts
- `m_currentExchangeRate` - Cached rate for selected currency
- `m_conversionResult` - Cached conversion result

**Methods:**

`OnThbAmountSubmit(decimal amount)`:
```csharp
private void OnThbAmountSubmit(decimal amount)
{
    if (amount <= 0) return;

    m_paymentEntries.Add(new PaymentEntry
    {
        Method = PaymentMethods.Cash,
        Currency = SupportedCurrencies.THB,
        Amount = amount,
        AmountInBaseCurrency = amount,
        ExchangeRate = 1.0m,
        ExchangeRateSource = "Base"
    });

    RecalculateTotals();
}
```

`OnDenominationCountsChanged(Dictionary<decimal, int> counts)`:
```csharp
private async Task OnDenominationCountsChanged(Dictionary<decimal, int> counts)
{
    m_currentDenominations = counts;
    var total = counts.Sum(kvp => kvp.Key * kvp.Value);

    if (total > 0 && m_selectedCurrency != SupportedCurrencies.THB)
    {
        m_conversionResult = await ExchangeRateService.ConvertToThbAsync(m_selectedCurrency, total);
    }
}
```

`AddForeignCurrencyPayment()`:
```csharp
private void AddForeignCurrencyPayment()
{
    if (m_conversionResult == null) return;

    var total = m_currentDenominations.Sum(kvp => kvp.Key * kvp.Value);
    if (total <= 0) return;

    m_paymentEntries.Add(new PaymentEntry
    {
        Method = PaymentMethods.Cash,
        Currency = m_selectedCurrency,
        Amount = total,
        AmountInBaseCurrency = m_conversionResult.ThbAmount,
        ExchangeRate = m_conversionResult.RateUsed,
        ExchangeRateSource = m_conversionResult.RateSource,
        ExchangeRateId = m_conversionResult.ExchangeRateId
    });

    // Clear denomination counts after adding
    m_currentDenominations.Clear();
    m_conversionResult = null;
    RecalculateTotals();
}
```

`OnCurrencyChanged(string currency)`:
```csharp
private async Task OnCurrencyChanged(string currency)
{
    m_selectedCurrency = currency;
    m_currentDenominations.Clear();
    m_conversionResult = null;

    // Pre-load exchange rate for display
    if (currency != SupportedCurrencies.THB)
    {
        m_currentExchangeRate = await ExchangeRateService.GetCurrentRateAsync(currency);
    }
}
```

**No rate error handling:**
If no exchange rate configured for currency, show warning alert and disable the "Add Payment" button.
  </action>
  <verify>
`dotnet build src/MotoRent.Client` compiles without errors
Navigate to payment terminal with THB selected - keypad shows
Switch to USD - denomination panel shows with exchange rate
  </verify>
  <done>
THB keypad integrated for THB cash entry. DenominationEntryPanel integrated for USD/EUR/CNY with exchange rate display and THB equivalent calculation. Payments add to entry list correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add non-cash payment method panels (Card, PromptPay, AliPay)</name>
  <files>
    src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
    src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.resx
    src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.th.resx
  </files>
  <action>
Add input panels for non-cash payment methods in PaymentTerminalPanel:

**Credit Card panel (when m_selectedMethod == "Card"):**
- Amount input field (pre-filled with remaining balance)
- "Pay Remaining: ฿X,XXX" quick-fill link
- Optional reference field (card authorization code)
- "Add Card Payment" button (green, disabled if amount <= 0)

**PromptPay panel (when m_selectedMethod == "PromptPay"):**
- QR icon centered (ti-qrcode, large)
- Instruction text: "Enter amount for PromptPay payment"
- Amount input field (pre-filled with remaining)
- "Pay Remaining: ฿X,XXX" quick-fill link
- Reference field (PromptPay transaction reference)
- "Add PromptPay Payment" button

**AliPay panel (when m_selectedMethod == "AliPay"):**
- AliPay icon centered (ti-brand-alipay or ti-phone)
- Instruction text: "Customer pays via AliPay app"
- Amount input field
- Reference field (required - customer's confirmation number)
- "Add AliPay Payment" button (disabled if reference empty)

**State additions:**
- `m_nonCashAmount` - decimal for card/promptpay/alipay amount input
- `m_nonCashReference` - string for reference field

**Methods:**

`AddCardPayment()`:
```csharp
private void AddCardPayment()
{
    if (m_nonCashAmount <= 0) return;

    m_paymentEntries.Add(new PaymentEntry
    {
        Method = PaymentMethods.Card,
        Currency = SupportedCurrencies.THB,
        Amount = m_nonCashAmount,
        AmountInBaseCurrency = m_nonCashAmount,
        ExchangeRate = 1.0m,
        ExchangeRateSource = "Base",
        Reference = m_nonCashReference
    });

    ResetNonCashInput();
    RecalculateTotals();
}
```

Similar methods for `AddPromptPayPayment()` and `AddAliPayPayment()`.

`FillRemaining()`:
```csharp
private void FillRemaining()
{
    m_nonCashAmount = m_remaining > 0 ? m_remaining : 0;
}
```

`ResetNonCashInput()`:
```csharp
private void ResetNonCashInput()
{
    m_nonCashAmount = 0;
    m_nonCashReference = "";
}
```

`OnMethodChanged(string method)`:
```csharp
private void OnMethodChanged(string method)
{
    m_selectedMethod = method;
    ResetNonCashInput();

    // Pre-fill remaining for non-cash methods
    if (method != PaymentMethods.Cash && m_remaining > 0)
    {
        m_nonCashAmount = m_remaining;
    }
}
```

**Add localization keys:**
| Key | English | Thai |
|-----|---------|------|
| EnterCardAmount | Enter Card Payment Amount | ใส่จำนวนเงินบัตร |
| CardReference | Authorization Code (optional) | รหัสอนุมัติ (ไม่บังคับ) |
| AddCardPayment | Add Card Payment | เพิ่มการชำระด้วยบัตร |
| PromptPayInstruction | Enter amount for PromptPay payment | ใส่จำนวนเงินสำหรับพร้อมเพย์ |
| PromptPayReference | Transaction Reference | เลขอ้างอิงรายการ |
| AddPromptPayPayment | Add PromptPay Payment | เพิ่มการชำระพร้อมเพย์ |
| AliPayInstruction | Customer pays via AliPay app | ลูกค้าชำระผ่านแอป AliPay |
| AliPayReference | Customer Confirmation Number | หมายเลขยืนยันของลูกค้า |
| AddAliPayPayment | Add AliPay Payment | เพิ่มการชำระ AliPay |
| PayRemaining | Pay Remaining | ชำระยอดคงเหลือ |
  </action>
  <verify>
`dotnet build src/MotoRent.Client` compiles without errors
Switch to Card tab - amount input and reference field show
Switch to PromptPay tab - QR icon and amount input show
Switch to AliPay tab - amount and required reference show
  </verify>
  <done>
Credit Card, PromptPay, and AliPay payment panels implemented with amount input, reference fields, and add buttons. All payment methods add entries to the running list correctly.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `dotnet build src/MotoRent.Client` - No errors
2. THB cash entry:
   - Keypad shows digits 0-9, C, backspace
   - Quick amounts: ฿100, ฿500, ฿1,000, Remaining
   - Add button creates payment entry
3. Foreign currency entry:
   - DenominationEntryPanel shows for USD/EUR/CNY
   - Exchange rate displayed
   - THB equivalent updates on count change
   - Add button creates entry with rate metadata
4. Card payment:
   - Amount input pre-filled with remaining
   - Optional reference field
   - Add button creates entry
5. PromptPay/AliPay:
   - Amount input and reference fields
   - Add buttons work correctly
</verification>

<success_criteria>
- ThbKeypadPanel component created with numeric keypad and quick amounts
- THB payments add to entry list via keypad
- Foreign currency payments use DenominationEntryPanel with real-time conversion
- Exchange rate captured from ExchangeRateService with audit trail (source, ID)
- Card, PromptPay, AliPay panels have amount + reference inputs
- All payment methods create entries in the running list
- Green dot indicators update when currencies/methods have entries
- Entry list shows all payments with correct THB equivalents
</success_criteria>

<output>
After completion, create `.planning/phases/04-payment-terminal/04-02-SUMMARY.md`
</output>
