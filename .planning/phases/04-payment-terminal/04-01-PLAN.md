---
phase: 04-payment-terminal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
  - src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor.css
  - src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.resx
  - src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.th.resx
autonomous: true

must_haves:
  truths:
    - "Staff sees amount due prominently at top of payment terminal"
    - "Staff can switch between payment methods (Cash, Card, PromptPay, AliPay)"
    - "Staff can switch between cash currencies (THB, USD, EUR, CNY)"
    - "GBP tab is visible but disabled"
    - "Payment method tabs have appropriate icons"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor"
      provides: "Payment terminal UI component with two-column layout"
      min_lines: 150
    - path: "src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor.css"
      provides: "Scoped styles for payment terminal"
    - path: "src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.resx"
      provides: "Localization keys for payment terminal"
  key_links:
    - from: "PaymentTerminalPanel.razor"
      to: "TillTransactionDialog.razor"
      via: "Component reference (wired in Plan 04-03)"
      pattern: "PaymentTerminalPanel"
---

<objective>
Create the PaymentTerminalPanel component with two-column layout, payment method tabs, and cash currency tabs.

Purpose: Establish the visual foundation for the payment terminal that staff will use to collect multi-currency split payments.

Output: A standalone PaymentTerminalPanel component with layout, tabs, and placeholder content areas ready for input components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-payment-terminal/04-CONTEXT.md
@.planning/phases/04-payment-terminal/04-RESEARCH.md
@src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor
@src/MotoRent.Domain/Entities/CurrencyDenominations.cs
@src/MotoRent.Domain/Entities/ReceiptPayment.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PaymentTerminalPanel component with two-column layout</name>
  <files>
    src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
    src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor.css
  </files>
  <action>
Create PaymentTerminalPanel.razor in Components/Till/ with:

**Component signature:**
- Inherit from `LocalizedComponentBase<PaymentTerminalPanel>`
- Parameters:
  - `decimal AmountDue` - Total amount due in THB
  - `EventCallback<List<ReceiptPayment>> OnPaymentComplete` - Called when payment completes
  - `EventCallback OnCancel` - Called when user cancels

**Two-column layout (Bootstrap grid):**
- Left column (col-md-4): Payment summary panel
- Right column (col-md-8): Payment input area

**Left panel content:**
- Large amount due display (bg-primary-lt card)
- Progress indicator (styled horizontal line with dot)
- Payment details list (empty initially, placeholder text)
- Summary section: Total Received, Change, Remaining
- "Complete Payment" button (disabled by default)

**Right panel content:**
- Payment method tabs row (Cash, Credit Card, PromptPay, AliPay)
- Content placeholder area that changes based on selected method
- For Cash method: secondary currency tabs row (THB, USD, GBP disabled, EUR, CNY)
- Content placeholder for currency-specific input

**State variables:**
- `m_selectedMethod` - Currently selected payment method (Cash/Card/PromptPay/AliPay)
- `m_selectedCurrency` - Currently selected cash currency (THB/USD/EUR/CNY)
- `m_paymentEntries` - List of PaymentEntry (internal working model)
- Computed: `m_totalReceived`, `m_change`, `m_remaining`

**PaymentEntry internal class:**
```csharp
private class PaymentEntry
{
    public string EntryId { get; set; } = Guid.NewGuid().ToString("N")[..8];
    public string Method { get; set; } = PaymentMethods.Cash;
    public string Currency { get; set; } = SupportedCurrencies.THB;
    public decimal Amount { get; set; }
    public decimal AmountInBaseCurrency { get; set; }
    public decimal ExchangeRate { get; set; } = 1.0m;
    public string ExchangeRateSource { get; set; } = "Base";
    public int? ExchangeRateId { get; set; }
    public string? Reference { get; set; }
}
```

**Tab icons (Tabler icons):**
- Cash: ti-cash
- Credit Card: ti-credit-card
- PromptPay: ti-qrcode
- AliPay: ti-brand-alipay (or ti-phone if not available)

**Currency tab display:**
- Show flag placeholder + currency code
- Green dot indicator class for currencies with entries (wire later)
- GBP tab: add `disabled` class and `disabled` attribute

**CSS (PaymentTerminalPanel.razor.css):**
- `.payment-terminal-panel` container
- `.payment-method-tabs` and `.currency-tabs` for tab styling
- `.tab-active` for selected state (blue border/bg)
- `.tab-disabled` for GBP (greyed out, no pointer)
- `.entry-indicator` for green dot (small green circle positioned top-right of tab)
- `.amount-due-display` for large amount styling
- `.progress-indicator` for the blue line with dot
- `.payment-summary` for the list area
  </action>
  <verify>
Build compiles: `dotnet build src/MotoRent.Client`
Component file exists and has two-column structure
  </verify>
  <done>
PaymentTerminalPanel renders with two-column layout, payment method tabs, and currency tabs. GBP tab is visible but disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add localization resources for PaymentTerminalPanel</name>
  <files>
    src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.resx
    src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/PaymentTerminalPanel.th.resx
  </files>
  <action>
Create localization files with the following keys:

| Key | English | Thai |
|-----|---------|------|
| AmountDue | Amount Due | ยอดที่ต้องชำระ |
| PaymentMethod | Payment Method | วิธีการชำระเงิน |
| Cash | Cash | เงินสด |
| CreditCard | Credit Card | บัตรเครดิต |
| PromptPay | PromptPay | พร้อมเพย์ |
| AliPay | AliPay | อาลีเพย์ |
| SelectCurrency | Select Currency | เลือกสกุลเงิน |
| PaymentDetails | Payment Details | รายละเอียดการชำระ |
| NoPaymentsYet | No payments added yet | ยังไม่มีการชำระเงิน |
| TotalReceived | Total Received | รับเงินรวม |
| Change | Change | เงินทอน |
| Remaining | Remaining | ยอดคงเหลือ |
| CompletePayment | Complete Payment | ดำเนินการชำระเงิน |
| Cancel | Cancel | ยกเลิก |
| ComingSoon | Coming Soon | เร็วๆ นี้ |
| EnterAmount | Enter Amount | ใส่จำนวนเงิน |
| Reference | Reference | เลขอ้างอิง |
| Remove | Remove | ลบ |

Use standard resx XML format with resheader elements.
  </action>
  <verify>
All three .resx files exist in Resources/Components/Till/
Build compiles without localization errors
  </verify>
  <done>
Localization files created with all required keys in English and Thai.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement payment entry list display and remove functionality</name>
  <files>
    src/MotoRent.Client/Components/Till/PaymentTerminalPanel.razor
  </files>
  <action>
Enhance the left panel with payment entry list display:

**Payment Details section:**
- Show "No payments added yet" when `m_paymentEntries.Count == 0`
- When entries exist, show a list-group with each entry as a list-group-item
- Each entry shows:
  - Method icon (ti-cash/ti-credit-card/ti-qrcode/ti-brand-alipay)
  - Method name + currency (e.g., "Cash (USD)")
  - Amount in payment currency (e.g., "$100")
  - THB equivalent below in small text (e.g., "฿3,550")
  - Remove button (X icon, btn-ghost-danger btn-sm)

**Entry display format:**
```razor
<div class="list-group-item d-flex justify-content-between align-items-center">
    <div>
        <div class="d-flex align-items-center gap-2">
            <i class="ti @GetMethodIcon(entry.Method)"></i>
            <span class="fw-semibold">@GetMethodLabel(entry.Method) (@entry.Currency)</span>
        </div>
        <div class="small text-muted">
            @FormatCurrencyAmount(entry.Amount, entry.Currency)
            @if (entry.Currency != SupportedCurrencies.THB)
            {
                <span> = @FormatThb(entry.AmountInBaseCurrency)</span>
            }
        </div>
    </div>
    <button type="button" class="btn btn-ghost-danger btn-sm" @onclick="() => RemoveEntry(entry)">
        <i class="ti ti-x"></i>
    </button>
</div>
```

**Summary calculations:**
- `m_totalReceived` = sum of all `AmountInBaseCurrency`
- `m_remaining` = `AmountDue - m_totalReceived` (show in red text if > 0)
- `m_change` = `m_totalReceived - AmountDue` if `m_totalReceived > AmountDue`, else 0
- Display Change in green when > 0

**Complete Payment button:**
- Disabled when `m_remaining > 0`
- Enabled when `m_remaining <= 0`
- Green/success color when enabled

**Helper methods:**
- `GetMethodIcon(string method)` - returns Tabler icon class
- `GetMethodLabel(string method)` - returns localized method name
- `FormatCurrencyAmount(decimal amount, string currency)` - formats with currency symbol
- `FormatThb(decimal amount)` - formats as ฿X,XXX
- `RemoveEntry(PaymentEntry entry)` - removes from list, triggers recalculation

**Green dot indicator logic:**
Add method `HasEntriesFor(string method, string? currency = null)` that checks if any payment entries exist for that method/currency combination. Use this to conditionally render the `.entry-indicator` span in the tabs.
  </action>
  <verify>
Build compiles
Payment entry list area renders correctly with placeholder
Summary section shows Total Received, Change, Remaining
  </verify>
  <done>
Payment details list displays entries with amount, THB equivalent, and remove button. Summary section shows running totals. Complete Payment button enables when fully paid.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `dotnet build src/MotoRent.Client` - No errors
2. PaymentTerminalPanel.razor exists with:
   - Two-column Bootstrap layout
   - Payment method tabs (Cash, Card, PromptPay, AliPay)
   - Cash currency tabs (THB, USD, GBP disabled, EUR, CNY)
   - Payment details list with remove capability
   - Summary section with totals
   - Complete Payment button with disabled logic
3. Localization files exist for EN/TH
</verification>

<success_criteria>
- PaymentTerminalPanel component created with full layout structure
- Payment method tabs switch correctly
- Currency tabs show under Cash method only
- GBP tab is visible but disabled (greyed out, not clickable)
- Payment entry list shows entries with amounts and remove button
- Summary section calculates Total Received, Change, Remaining correctly
- Complete Payment button disabled until remaining = 0
- All UI text uses Localizer with EN/TH translations
</success_criteria>

<output>
After completion, create `.planning/phases/04-payment-terminal/04-01-SUMMARY.md`
</output>
