---
phase: 08-manager-oversight
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Settings/SettingKeys.cs
  - src/MotoRent.Services/TillService.manager.cs
autonomous: true

must_haves:
  truths:
    - "Manager can query all active till sessions for a shop"
    - "Manager can query recent closed sessions filtered by date range"
    - "System can calculate THB-equivalent variance for any session"
    - "System prevents staff from verifying their own sessions"
    - "Variance threshold is configurable per organization"
  artifacts:
    - path: "src/MotoRent.Domain/Settings/SettingKeys.cs"
      provides: "Till_VarianceAlertThreshold setting key"
      contains: "Till_VarianceAlertThreshold"
    - path: "src/MotoRent.Services/TillService.manager.cs"
      provides: "Manager dashboard query methods"
      exports: ["GetAllActiveSessionsAsync", "GetRecentClosedSessionsAsync", "GetTotalVarianceInThbAsync", "GetVarianceAlertCountAsync"]
  key_links:
    - from: "src/MotoRent.Services/TillService.manager.cs"
      to: "TillSession.ClosingVariances"
      via: "THB conversion calculation"
      pattern: "ClosingVariances"
    - from: "src/MotoRent.Services/TillService.manager.cs"
      to: "ExchangeRateService"
      via: "Currency conversion for variance"
      pattern: "ExchangeRateService"
---

<objective>
Extend TillService with manager dashboard query methods and add variance threshold configuration.

Purpose: Provide the data layer for manager oversight dashboard - querying sessions, calculating variance alerts, and self-verification prevention.
Output: Extended TillService.manager.cs with 4 new methods and SettingKeys with variance threshold.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-manager-oversight/08-CONTEXT.md
@.planning/phases/08-manager-oversight/08-RESEARCH.md

@src/MotoRent.Services/TillService.manager.cs
@src/MotoRent.Domain/Settings/SettingKeys.cs
@src/MotoRent.Domain/Entities/TillSession.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Till settings keys to SettingKeys.cs</name>
  <files>src/MotoRent.Domain/Settings/SettingKeys.cs</files>
  <action>
Add a new region `#region Till Settings` at the end of SettingKeys.cs with:

```csharp
#region Till Settings

/// <summary>
/// Variance threshold in THB for manager alerts (decimal).
/// Sessions with variance exceeding this absolute amount trigger alerts.
/// Default: 100 THB if not configured.
/// </summary>
public const string Till_VarianceAlertThreshold = "Till.VarianceAlertThreshold";

/// <summary>
/// Default opening float amount in THB (decimal).
/// Used as suggestion when opening new till session.
/// </summary>
public const string Till_DefaultOpeningFloat = "Till.DefaultOpeningFloat";

#endregion
```

Place before the closing brace of the class.
  </action>
  <verify>
Build succeeds: `dotnet build src/MotoRent.Domain`
Grep confirms: `grep -n "Till_VarianceAlertThreshold" src/MotoRent.Domain/Settings/SettingKeys.cs`
  </verify>
  <done>
SettingKeys.cs contains Till_VarianceAlertThreshold and Till_DefaultOpeningFloat constants with XML documentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add manager dashboard query methods to TillService</name>
  <files>src/MotoRent.Services/TillService.manager.cs</files>
  <action>
Add the following methods to TillService.manager.cs:

1. **GetAllActiveSessionsAsync(int shopId)** - Returns all open sessions for a shop:
```csharp
/// <summary>
/// Gets all currently active (open) till sessions for a shop.
/// Used by manager dashboard to show real-time session status.
/// </summary>
public async Task<List<TillSession>> GetAllActiveSessionsAsync(int shopId)
{
    var result = await this.Context.LoadAsync(
        this.Context.CreateQuery<TillSession>()
            .Where(s => s.ShopId == shopId)
            .Where(s => s.Status == TillSessionStatus.Open)
            .OrderBy(s => s.OpenedAt),
        page: 1, size: 100, includeTotalRows: false);
    return result.ItemCollection.ToList();
}
```

2. **GetRecentClosedSessionsAsync(int shopId, int days = 7)** - Returns closed sessions within date range:
```csharp
/// <summary>
/// Gets recently closed till sessions for verification review.
/// Excludes Open and Reconciling statuses.
/// </summary>
public async Task<List<TillSession>> GetRecentClosedSessionsAsync(int shopId, int days = 7)
{
    var cutoffDate = DateTimeOffset.Now.AddDays(-days);

    var result = await this.Context.LoadAsync(
        this.Context.CreateQuery<TillSession>()
            .Where(s => s.ShopId == shopId)
            .Where(s => s.Status != TillSessionStatus.Open)
            .Where(s => s.Status != TillSessionStatus.Reconciling)
            .Where(s => s.ClosedAt >= cutoffDate)
            .OrderByDescending(s => s.ClosedAt),
        page: 1, size: 100, includeTotalRows: false);
    return result.ItemCollection.ToList();
}
```

3. **GetTotalVarianceInThbAsync(TillSession session)** - Calculates THB-equivalent total variance:
```csharp
/// <summary>
/// Calculates total variance in THB across all currencies.
/// Uses current exchange rates to convert foreign currency variances.
/// </summary>
public async Task<decimal> GetTotalVarianceInThbAsync(TillSession session)
{
    if (session.ClosingVariances.Count == 0)
        return session.Variance; // Fall back to single-currency variance

    decimal totalThb = 0;
    foreach (var (currency, variance) in session.ClosingVariances)
    {
        if (currency == SupportedCurrencies.THB)
        {
            totalThb += variance;
        }
        else
        {
            var rate = await m_exchangeRateService.GetCurrentRateAsync(currency);
            var buyRate = rate?.BuyRate ?? 1m;
            totalThb += variance * buyRate;
        }
    }
    return totalThb;
}
```

4. **GetVarianceAlertCountAsync(int shopId, decimal thresholdThb)** - Counts sessions exceeding threshold:
```csharp
/// <summary>
/// Counts sessions with variance exceeding the threshold.
/// Checks both unverified closed sessions from today.
/// </summary>
public async Task<int> GetVarianceAlertCountAsync(int shopId, decimal thresholdThb)
{
    var recentClosed = await GetRecentClosedSessionsAsync(shopId, days: 1);

    var unverified = recentClosed
        .Where(s => s.Status is TillSessionStatus.Closed or TillSessionStatus.ClosedWithVariance);

    int count = 0;
    foreach (var session in unverified.Where(s => s.ClosingVariances.Any() || s.Variance != 0))
    {
        var totalVariance = await GetTotalVarianceInThbAsync(session);
        if (Math.Abs(totalVariance) > thresholdThb)
            count++;
    }
    return count;
}
```

5. **Update VerifySessionAsync** - Add self-verification check:
Modify existing method to prevent self-verification:
```csharp
// Add after the status check, before setting status to Verified:
// Prevent self-verification
if (string.Equals(session.StaffUserName, managerUserName, StringComparison.OrdinalIgnoreCase))
    return SubmitOperation.CreateFailure("You cannot verify your own session");
```

Make sure to add `using MotoRent.Domain.Entities;` if not present.
  </action>
  <verify>
Build succeeds: `dotnet build src/MotoRent.Services`
Methods exist: grep for method names in file
  </verify>
  <done>
TillService.manager.cs has 4 new methods (GetAllActiveSessionsAsync, GetRecentClosedSessionsAsync, GetTotalVarianceInThbAsync, GetVarianceAlertCountAsync) and VerifySessionAsync prevents self-verification.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` succeeds for entire solution
2. SettingKeys.Till_VarianceAlertThreshold constant exists
3. TillService has GetAllActiveSessionsAsync method
4. TillService has GetRecentClosedSessionsAsync method
5. TillService has GetTotalVarianceInThbAsync method
6. TillService has GetVarianceAlertCountAsync method
7. VerifySessionAsync includes self-verification check
</verification>

<success_criteria>
- Build passes with no errors
- All 4 new query methods exist with async signatures
- Self-verification prevention returns failure with descriptive message
- Settings key follows existing naming convention (Category.SettingName)
</success_criteria>

<output>
After completion, create `.planning/phases/08-manager-oversight/08-01-SUMMARY.md` using summary template.
</output>
