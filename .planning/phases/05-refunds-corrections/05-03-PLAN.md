---
phase: 05-refunds-corrections
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/MotoRent.Client/Components/Auth/ManagerPinDialog.razor
  - src/MotoRent.Client/Components/Auth/ManagerPinDialog.razor.css
  - src/MotoRent.Client/Resources/Components/Auth/ManagerPinDialog.resx
  - src/MotoRent.Client/Resources/Components/Auth/ManagerPinDialog.en.resx
  - src/MotoRent.Client/Resources/Components/Auth/ManagerPinDialog.th.resx
autonomous: true

must_haves:
  truths:
    - "User sees touch-friendly PIN keypad dialog"
    - "4 dots show PIN entry progress"
    - "Wrong PIN shows error with remaining attempts"
    - "Lockout displays countdown timer"
    - "Dialog returns manager username on successful verification"
    - "Available managers are loaded from CoreDataContext"
  artifacts:
    - path: "src/MotoRent.Client/Components/Auth/ManagerPinDialog.razor"
      provides: "Touch-friendly PIN entry dialog with lockout"
      min_lines: 100
    - path: "src/MotoRent.Client/Components/Auth/ManagerPinDialog.razor.css"
      provides: "Keypad styling consistent with ThbKeypadPanel"
      contains: "keypad-grid"
  key_links:
    - from: "ManagerPinDialog"
      to: "ManagerPinService.VerifyPin"
      via: "Callback verification"
      pattern: "VerifyPin"
    - from: "ManagerPinDialog"
      to: "IModalService"
      via: "Modal result"
      pattern: "ModalResult.Ok"
    - from: "ManagerPinDialog"
      to: "CoreDataContext"
      via: "Load managers with CanApproveVoids"
      pattern: "CoreDataContext.*LoadAsync.*User"
---

<objective>
Create a touch-friendly PIN entry dialog component for manager void approval.

Purpose: UI for manager authorization workflow. Managers enter 4-digit PIN via touch-friendly keypad to approve voids. Follows existing ThbKeypadPanel visual pattern for consistency.

Output: ManagerPinDialog component with keypad, PIN dots display, error feedback, and lockout handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-refunds-corrections/05-CONTEXT.md
@.planning/phases/05-refunds-corrections/05-RESEARCH.md
@.planning/phases/05-refunds-corrections/05-02-SUMMARY.md

# Pattern to follow
@src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor
@src/MotoRent.Client/Components/Till/ThbKeypadPanel.razor.css

# User roles for manager filtering
@src/MotoRent.Domain/Core/UserAccount.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManagerPinDialog component</name>
  <files>src/MotoRent.Client/Components/Auth/ManagerPinDialog.razor</files>
  <action>
Create the Auth folder if it doesn't exist, then create the ManagerPinDialog component:

```razor
@inherits LocalizedModalBase<string, ManagerPinDialog>
@inject ManagerPinService PinService
@inject CoreDataContext CoreDataContext
@inject IRequestContext RequestContext

<div class="manager-pin-dialog">
    <div class="pin-header text-center mb-4">
        <div class="avatar avatar-lg bg-warning-lt mb-2">
            <i class="ti ti-lock fs-2"></i>
        </div>
        <h4>@Localizer["ManagerApprovalRequired"]</h4>
        <p class="text-muted">@Localizer["EnterPinToApprove"]</p>
    </div>

    @if (m_isLockedOut)
    {
        <div class="lockout-message text-center mb-4">
            <div class="alert alert-danger">
                <i class="ti ti-lock me-2"></i>
                @Localizer["TooManyAttempts"]
                <div class="lockout-countdown mt-2">
                    <span class="badge bg-danger fs-5">@m_lockoutSecondsRemaining</span>
                    <span class="text-muted ms-2">@Localizer["SecondsRemaining"]</span>
                </div>
            </div>
        </div>
    }
    else
    {
        @* PIN Dots Display *@
        <div class="pin-display d-flex justify-content-center gap-3 mb-3">
            @for (int i = 0; i < 4; i++)
            {
                var index = i;
                <div class="pin-dot @(m_pin.Length > index ? "filled" : "")"></div>
            }
        </div>

        @* Error Message *@
        @if (!string.IsNullOrEmpty(m_error))
        {
            <div class="text-danger text-center mb-3">
                <i class="ti ti-alert-circle me-1"></i>
                @m_error
            </div>
        }

        @* Numeric Keypad *@
        <div class="keypad-grid">
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('1'))" disabled="@m_verifying">1</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('2'))" disabled="@m_verifying">2</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('3'))" disabled="@m_verifying">3</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('4'))" disabled="@m_verifying">4</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('5'))" disabled="@m_verifying">5</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('6'))" disabled="@m_verifying">6</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('7'))" disabled="@m_verifying">7</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('8'))" disabled="@m_verifying">8</button>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('9'))" disabled="@m_verifying">9</button>
            <div class="keypad-spacer"></div>
            <button type="button" class="keypad-btn" @onclick="@(() => OnDigit('0'))" disabled="@m_verifying">0</button>
            <button type="button" class="keypad-btn keypad-btn-action" @onclick="OnClear" disabled="@m_verifying">
                <i class="ti ti-backspace"></i>
            </button>
        </div>

        @* Manager Selection (if multiple managers available) *@
        @if (m_availableManagers.Count > 1)
        {
            <div class="manager-select mt-3">
                <label class="form-label">@Localizer["SelectManager"]</label>
                <select class="form-select" @bind="m_selectedManagerUserName" @bind:after="OnManagerChanged" disabled="@m_verifying">
                    @foreach (var manager in m_availableManagers)
                    {
                        <option value="@manager.UserName">@manager.FullName</option>
                    }
                </select>
            </div>
        }
        else if (m_availableManagers.Count == 1)
        {
            <div class="text-center text-muted mt-3">
                <small>@Localizer["ApprovingAs"]: <strong>@m_availableManagers[0].FullName</strong></small>
            </div>
        }
        else if (m_loadingManagers)
        {
            <div class="text-center text-muted mt-3">
                <span class="spinner-border spinner-border-sm me-2"></span>
                @Localizer["LoadingManagers"]
            </div>
        }
        else
        {
            <div class="alert alert-warning mt-3">
                <i class="ti ti-alert-triangle me-2"></i>
                @Localizer["NoManagersWithPin"]
            </div>
        }
    }

    @* Action Buttons *@
    <div class="d-flex justify-content-center gap-2 mt-4">
        <button type="button" class="btn btn-ghost-secondary" @onclick="OnCancel" disabled="@m_verifying">
            @Localizer["Cancel"]
        </button>
    </div>
</div>

@code {
    // State
    private string m_pin = "";
    private string? m_error;
    private bool m_verifying;
    private bool m_isLockedOut;
    private int m_lockoutSecondsRemaining;
    private System.Timers.Timer? m_lockoutTimer;
    private List<User> m_availableManagers = [];
    private string? m_selectedManagerUserName;
    private User? m_selectedManager;
    private bool m_loadingManagers = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableManagersAsync();
        CheckLockout();
    }

    private async Task LoadAvailableManagersAsync()
    {
        m_loadingManagers = true;
        StateHasChanged();

        try
        {
            // Get current organization's AccountNo
            var accountNo = RequestContext.AccountNo;

            // Load all users, then filter for managers with PIN configured
            // Query users who:
            // 1. Have an account in this organization
            // 2. Have ManagementRoles (OrgAdmin or ShopManager)
            // 3. Have ManagerPinHash set (CanApproveVoids = true)
            var usersResult = await CoreDataContext.LoadAsync(
                CoreDataContext.CreateQuery<User>()
                    .Where(u => u.ManagerPinHash != null && u.ManagerPinHash != ""),
                page: 1,
                size: 50,
                includeTotalRows: false);

            // Filter to users who have ManagementRoles in current organization
            m_availableManagers = usersResult.ItemCollection
                .Where(u => u.AccountCollection.Any(a =>
                    a.AccountNo == accountNo &&
                    a.Roles.Any(r => UserAccount.ManagementRoles.Contains(r))))
                .ToList();

            if (m_availableManagers.Count > 0)
            {
                m_selectedManagerUserName = m_availableManagers[0].UserName;
                m_selectedManager = m_availableManagers[0];
            }
        }
        catch (Exception ex)
        {
            m_error = $"Failed to load managers: {ex.Message}";
        }
        finally
        {
            m_loadingManagers = false;
            StateHasChanged();
        }
    }

    private void OnManagerChanged()
    {
        m_selectedManager = m_availableManagers.FirstOrDefault(m => m.UserName == m_selectedManagerUserName);
        m_pin = "";
        m_error = null;
        CheckLockout();
    }

    private void CheckLockout()
    {
        if (string.IsNullOrEmpty(m_selectedManagerUserName)) return;

        m_lockoutSecondsRemaining = PinService.GetLockoutSecondsRemaining(m_selectedManagerUserName);
        m_isLockedOut = m_lockoutSecondsRemaining > 0;

        if (m_isLockedOut)
        {
            StartLockoutTimer();
        }
    }

    private void StartLockoutTimer()
    {
        m_lockoutTimer?.Dispose();
        m_lockoutTimer = new System.Timers.Timer(1000);
        m_lockoutTimer.Elapsed += async (_, _) =>
        {
            m_lockoutSecondsRemaining--;
            if (m_lockoutSecondsRemaining <= 0)
            {
                m_isLockedOut = false;
                m_lockoutTimer?.Stop();
            }
            await InvokeAsync(StateHasChanged);
        };
        m_lockoutTimer.Start();
    }

    private void OnDigit(char digit)
    {
        if (m_pin.Length >= 4) return;
        if (m_selectedManager == null) return;

        m_pin += digit;
        m_error = null;

        if (m_pin.Length == 4)
        {
            _ = VerifyPinAsync();
        }
    }

    private void OnClear()
    {
        if (m_pin.Length > 0)
        {
            m_pin = m_pin[..^1];
        }
        m_error = null;
    }

    private async Task VerifyPinAsync()
    {
        if (m_selectedManager == null)
        {
            m_error = Localizer["NoManagerSelected"];
            m_pin = "";
            return;
        }

        m_verifying = true;
        StateHasChanged();

        try
        {
            // Use callback if provided (for testing/mocking), otherwise use service directly
            if (OnVerify != null)
            {
                var result = await OnVerify.Invoke(m_selectedManagerUserName!, m_pin);
                if (result.IsValid)
                {
                    ModalService.Close(ModalResult.Ok(m_selectedManagerUserName));
                    return;
                }

                m_error = result.Error;
                if (result.RemainingAttempts == 0)
                {
                    CheckLockout();
                }
            }
            else
            {
                // Direct verification using the loaded manager
                var result = PinService.VerifyPin(m_selectedManager, m_pin);
                if (result.IsValid)
                {
                    ModalService.Close(ModalResult.Ok(m_selectedManagerUserName));
                    return;
                }

                m_error = result.Error;
                if (result.RemainingAttempts == 0)
                {
                    CheckLockout();
                }
            }
        }
        finally
        {
            m_verifying = false;
            m_pin = "";
            StateHasChanged();
        }
    }

    private void OnCancel()
    {
        ModalService.Close(ModalResult.Cancel());
    }

    /// <summary>
    /// Optional callback to verify PIN. If not provided, uses ManagerPinService directly.
    /// Returns (IsValid, Error, RemainingAttempts).
    /// </summary>
    [Parameter]
    public Func<string, string, Task<(bool IsValid, string? Error, int RemainingAttempts)>>? OnVerify { get; set; }

    public void Dispose()
    {
        m_lockoutTimer?.Dispose();
    }
}
```

Key implementation notes:
- Uses LocalizedModalBase pattern from existing codebase
- Injects CoreDataContext and IRequestContext to load managers
- Loads managers who have ManagerPinHash set (CanApproveVoids) and ManagementRoles in current org
- 4 PIN dots show entry progress
- Lockout timer counts down remaining seconds
- OnVerify callback is optional - if not provided, uses ManagerPinService.VerifyPin directly
- Returns manager username on success via ModalResult.Ok
  </action>
  <verify>`dotnet build src/MotoRent.Client` compiles without errors</verify>
  <done>ManagerPinDialog.razor exists with PIN keypad, dots display, lockout handling, and proper manager loading</done>
</task>

<task type="auto">
  <name>Task 2: Create ManagerPinDialog CSS</name>
  <files>src/MotoRent.Client/Components/Auth/ManagerPinDialog.razor.css</files>
  <action>
Create scoped CSS for the PIN dialog, following ThbKeypadPanel styling pattern:

```css
/* Manager PIN Dialog - Touch-friendly keypad styling */

.manager-pin-dialog {
    max-width: 320px;
    margin: 0 auto;
    padding: 1rem;
}

/* PIN Dots */
.pin-display {
    padding: 1rem 0;
}

.pin-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid var(--tblr-border-color);
    background-color: transparent;
    transition: all 0.15s ease;
}

.pin-dot.filled {
    background-color: var(--tblr-primary);
    border-color: var(--tblr-primary);
}

/* Keypad Grid - 3x4 layout */
.keypad-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.keypad-btn {
    aspect-ratio: 1;
    font-size: 1.5rem;
    font-weight: 500;
    border: 1px solid var(--tblr-border-color);
    border-radius: 50%;
    background-color: var(--tblr-bg-surface);
    color: var(--tblr-body-color);
    cursor: pointer;
    transition: all 0.15s ease;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.keypad-btn:hover:not(:disabled) {
    background-color: var(--tblr-bg-surface-secondary);
    border-color: var(--tblr-primary);
}

.keypad-btn:active:not(:disabled) {
    background-color: var(--tblr-primary);
    color: white;
    transform: scale(0.95);
}

.keypad-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.keypad-btn-action {
    background-color: var(--tblr-bg-surface-secondary);
    color: var(--tblr-secondary);
}

.keypad-btn-action:hover:not(:disabled) {
    background-color: var(--tblr-danger-lt);
    border-color: var(--tblr-danger);
    color: var(--tblr-danger);
}

.keypad-spacer {
    /* Empty space in bottom-left of keypad */
}

/* Lockout styling */
.lockout-message {
    animation: pulse 2s infinite;
}

.lockout-countdown {
    font-size: 1.25rem;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Manager select */
.manager-select .form-select {
    text-align: center;
}
```

Styling follows ThbKeypadPanel pattern:
- 3-column grid for digits
- Circular buttons with touch-friendly sizing
- Hover/active states for feedback
- Lockout state animation
  </action>
  <verify>CSS file exists and has expected selectors</verify>
  <done>ManagerPinDialog.razor.css exists with keypad styling</done>
</task>

<task type="auto">
  <name>Task 3: Create localization resources</name>
  <files>
    src/MotoRent.Client/Resources/Components/Auth/ManagerPinDialog.resx
    src/MotoRent.Client/Resources/Components/Auth/ManagerPinDialog.en.resx
    src/MotoRent.Client/Resources/Components/Auth/ManagerPinDialog.th.resx
  </files>
  <action>
Create the Auth folder in Resources/Components if needed, then create the resx files:

**ManagerPinDialog.resx** (default/fallback):
```xml
<?xml version="1.0" encoding="utf-8"?>
<root>
  <resheader name="resmimetype">
    <value>text/microsoft-resx</value>
  </resheader>
  <resheader name="version">
    <value>1.3</value>
  </resheader>
  <resheader name="reader">
    <value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <resheader name="writer">
    <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <data name="ManagerApprovalRequired" xml:space="preserve">
    <value>Manager Approval Required</value>
  </data>
  <data name="EnterPinToApprove" xml:space="preserve">
    <value>Enter your 4-digit PIN to approve this action</value>
  </data>
  <data name="TooManyAttempts" xml:space="preserve">
    <value>Too many incorrect attempts</value>
  </data>
  <data name="SecondsRemaining" xml:space="preserve">
    <value>seconds remaining</value>
  </data>
  <data name="SelectManager" xml:space="preserve">
    <value>Select Manager</value>
  </data>
  <data name="NoManagerSelected" xml:space="preserve">
    <value>Please select a manager</value>
  </data>
  <data name="Cancel" xml:space="preserve">
    <value>Cancel</value>
  </data>
  <data name="ApprovingAs" xml:space="preserve">
    <value>Approving as</value>
  </data>
  <data name="LoadingManagers" xml:space="preserve">
    <value>Loading managers...</value>
  </data>
  <data name="NoManagersWithPin" xml:space="preserve">
    <value>No managers with PIN configured. Please contact an administrator.</value>
  </data>
</root>
```

**ManagerPinDialog.en.resx** (English - same as default):
Same content as above.

**ManagerPinDialog.th.resx** (Thai):
```xml
<?xml version="1.0" encoding="utf-8"?>
<root>
  <resheader name="resmimetype">
    <value>text/microsoft-resx</value>
  </resheader>
  <resheader name="version">
    <value>1.3</value>
  </resheader>
  <resheader name="reader">
    <value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <resheader name="writer">
    <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <data name="ManagerApprovalRequired" xml:space="preserve">
    <value>ต้องการการอนุมัติจากผู้จัดการ</value>
  </data>
  <data name="EnterPinToApprove" xml:space="preserve">
    <value>ใส่รหัส PIN 4 หลักเพื่ออนุมัติ</value>
  </data>
  <data name="TooManyAttempts" xml:space="preserve">
    <value>ใส่รหัสผิดเกินจำนวนครั้งที่กำหนด</value>
  </data>
  <data name="SecondsRemaining" xml:space="preserve">
    <value>วินาทีที่เหลือ</value>
  </data>
  <data name="SelectManager" xml:space="preserve">
    <value>เลือกผู้จัดการ</value>
  </data>
  <data name="NoManagerSelected" xml:space="preserve">
    <value>กรุณาเลือกผู้จัดการ</value>
  </data>
  <data name="Cancel" xml:space="preserve">
    <value>ยกเลิก</value>
  </data>
  <data name="ApprovingAs" xml:space="preserve">
    <value>อนุมัติในนาม</value>
  </data>
  <data name="LoadingManagers" xml:space="preserve">
    <value>กำลังโหลดรายชื่อผู้จัดการ...</value>
  </data>
  <data name="NoManagersWithPin" xml:space="preserve">
    <value>ไม่มีผู้จัดการที่ตั้งค่า PIN กรุณาติดต่อผู้ดูแลระบบ</value>
  </data>
</root>
```
  </action>
  <verify>All three resx files exist in Resources/Components/Auth/</verify>
  <done>Localization resources created for default, en, and th</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MotoRent.Client` - compiles without errors
2. ManagerPinDialog.razor exists with keypad and PIN dots
3. ManagerPinDialog.razor.css has consistent styling
4. All localization files (default, en, th) exist
5. Component handles lockout display and countdown
6. Available managers are loaded from CoreDataContext with proper filtering
</verification>

<success_criteria>
- Touch-friendly PIN keypad dialog created
- 4 PIN dots show entry progress
- Error messages display on wrong PIN
- Lockout state shows countdown timer
- Managers with CanApproveVoids in current org are loaded and selectable
- Localization for English and Thai
- Styling consistent with ThbKeypadPanel
</success_criteria>

<output>
After completion, create `.planning/phases/05-refunds-corrections/05-03-SUMMARY.md`
</output>
