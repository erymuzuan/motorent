---
phase: 05-refunds-corrections
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Entities/TillTransaction.cs
  - src/MotoRent.Domain/Entities/TillEnums.cs
  - src/MotoRent.Domain/Core/User.cs
  - database/tables/MotoRent.TillTransaction.sql
autonomous: true

must_haves:
  truths:
    - "TillTransaction can be marked as voided with reason and approver"
    - "Void creates compensating entry linking to original"
    - "User entity can store hashed manager PIN"
    - "New transaction types support refunds and voids"
  artifacts:
    - path: "src/MotoRent.Domain/Entities/TillTransaction.cs"
      provides: "Void metadata fields (IsVoided, VoidedAt, VoidReason, etc.)"
      contains: "IsVoided"
    - path: "src/MotoRent.Domain/Entities/TillEnums.cs"
      provides: "OverpaymentRefund and VoidReversal transaction types"
      contains: "OverpaymentRefund"
    - path: "src/MotoRent.Domain/Core/User.cs"
      provides: "ManagerPinHash and ManagerPinSalt fields"
      contains: "ManagerPinHash"
  key_links:
    - from: "TillTransaction"
      to: "TillTransaction"
      via: "OriginalTransactionId reference"
      pattern: "OriginalTransactionId"
---

<objective>
Extend domain entities to support void metadata, manager PIN authentication, and new transaction types for refunds.

Purpose: Foundation for all refund and void operations. Without these entity extensions, we cannot track voids, link compensating entries, or authenticate managers.

Output: Updated TillTransaction with void fields, User with PIN hash fields, TillEnums with new types, updated SQL schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-refunds-corrections/05-CONTEXT.md
@.planning/phases/05-refunds-corrections/05-RESEARCH.md

# Existing entities to extend
@src/MotoRent.Domain/Entities/TillTransaction.cs
@src/MotoRent.Domain/Entities/TillEnums.cs
@src/MotoRent.Domain/Core/User.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TillTransaction with void metadata</name>
  <files>src/MotoRent.Domain/Entities/TillTransaction.cs</files>
  <action>
Add the following fields to TillTransaction class after the existing verification fields:

```csharp
// Void tracking
/// <summary>
/// Whether this transaction has been voided.
/// Voided transactions are preserved for audit trail but don't affect balances.
/// </summary>
public bool IsVoided { get; set; }

/// <summary>
/// When the transaction was voided.
/// </summary>
public DateTimeOffset? VoidedAt { get; set; }

/// <summary>
/// Username of staff who initiated the void.
/// </summary>
public string? VoidedByUserName { get; set; }

/// <summary>
/// Reason for voiding the transaction.
/// </summary>
public string? VoidReason { get; set; }

/// <summary>
/// Username of manager who approved the void.
/// Must be different from VoidedByUserName (no self-approval).
/// </summary>
public string? VoidApprovedByUserName { get; set; }

/// <summary>
/// ID of the original transaction this void/reversal relates to.
/// Used for compensating entries to link back to what was voided.
/// </summary>
public int? OriginalTransactionId { get; set; }

/// <summary>
/// ID of the compensating transaction created when this was voided.
/// Links original to its reversal for bidirectional navigation.
/// </summary>
public int? RelatedTransactionId { get; set; }
```

These fields enable:
- Marking transactions as voided without deletion
- Tracking who initiated and who approved voids
- Linking original transactions to their compensating reversals
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Domain`</verify>
  <done>TillTransaction has IsVoided, VoidedAt, VoidedByUserName, VoidReason, VoidApprovedByUserName, OriginalTransactionId, RelatedTransactionId fields</done>
</task>

<task type="auto">
  <name>Task 2: Add refund and void transaction types</name>
  <files>src/MotoRent.Domain/Entities/TillEnums.cs</files>
  <action>
Add the following new values to the TillTransactionType enum, after CashShortage:

```csharp
/// <summary>
/// Refund for customer overpayment.
/// </summary>
OverpaymentRefund,

/// <summary>
/// Compensating entry created when a transaction is voided.
/// Reverses the original transaction's effect on till balance.
/// </summary>
VoidReversal
```

OverpaymentRefund is distinct from DepositRefund:
- DepositRefund: Security deposit returned at check-out
- OverpaymentRefund: Customer paid too much, excess returned

VoidReversal is the compensating entry created when voiding:
- Original: RentalPayment IN +1000
- Reversal: VoidReversal OUT -1000
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Domain`</verify>
  <done>TillTransactionType includes OverpaymentRefund and VoidReversal values</done>
</task>

<task type="auto">
  <name>Task 3: Extend User with manager PIN fields</name>
  <files>src/MotoRent.Domain/Core/User.cs</files>
  <action>
Add the following fields to User class after the existing HashedPassword and Salt fields:

```csharp
/// <summary>
/// Hashed manager PIN for void approvals (4-6 digits).
/// Null if user doesn't have void approval privilege.
/// Uses PBKDF2 with salt for secure storage.
/// </summary>
public string? ManagerPinHash { get; set; }

/// <summary>
/// Salt for manager PIN hash.
/// Generated when PIN is set, used with PBKDF2.
/// </summary>
public string? ManagerPinSalt { get; set; }

/// <summary>
/// Whether this user can approve voids (has ManagementRoles and PIN set).
/// </summary>
public bool CanApproveVoids => !string.IsNullOrEmpty(ManagerPinHash);
```

Note: The existing Salt/HashedPassword are for custom credential login.
ManagerPinSalt/ManagerPinHash are separate for void approval workflow.
This allows managers who login via Google/Microsoft to still have a void approval PIN.
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Domain`</verify>
  <done>User has ManagerPinHash, ManagerPinSalt, and CanApproveVoids property</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MotoRent.Domain` - compiles without errors
2. TillTransaction class contains all 7 void-related fields
3. TillTransactionType enum has OverpaymentRefund and VoidReversal
4. User class has ManagerPinHash, ManagerPinSalt, CanApproveVoids
</verification>

<success_criteria>
- Domain entities extended with all void/refund fields
- No breaking changes to existing entity contracts
- Build succeeds for Domain project
</success_criteria>

<output>
After completion, create `.planning/phases/05-refunds-corrections/05-01-SUMMARY.md`
</output>
