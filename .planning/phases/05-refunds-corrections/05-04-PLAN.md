---
phase: 05-refunds-corrections
plan: 04
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/MotoRent.Client/Components/Till/VoidTransactionDialog.razor
  - src/MotoRent.Client/Components/Till/VoidTransactionDialog.razor.css
  - src/MotoRent.Client/Resources/Components/Till/VoidTransactionDialog.resx
  - src/MotoRent.Client/Resources/Components/Till/VoidTransactionDialog.en.resx
  - src/MotoRent.Client/Resources/Components/Till/VoidTransactionDialog.th.resx
autonomous: true

must_haves:
  truths:
    - "Staff can view original transaction details before voiding"
    - "Staff must enter reason for void"
    - "Dialog shows void will require manager approval"
    - "On confirm, dialog invokes void operation"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/VoidTransactionDialog.razor"
      provides: "Void confirmation dialog with reason entry"
      min_lines: 80
    - path: "src/MotoRent.Client/Components/Till/VoidTransactionDialog.razor.css"
      provides: "Dialog styling"
  key_links:
    - from: "VoidTransactionDialog"
      to: "TillService.VoidTransactionAsync"
      via: "OnConfirm callback"
      pattern: "VoidTransactionAsync"
---

<objective>
Create a dialog for staff to initiate void of a transaction with reason entry and original transaction display.

Purpose: Void initiation workflow. Staff see what they're voiding, enter a reason, and confirm. This triggers manager PIN approval in the parent component.

Output: VoidTransactionDialog showing original transaction details and collecting void reason.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-refunds-corrections/05-CONTEXT.md
@.planning/phases/05-refunds-corrections/05-02-SUMMARY.md

# Related components
@src/MotoRent.Domain/Entities/TillTransaction.cs
@src/MotoRent.Domain/Entities/TillEnums.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VoidTransactionDialog component</name>
  <files>src/MotoRent.Client/Components/Till/VoidTransactionDialog.razor</files>
  <action>
Create VoidTransactionDialog component in Components/Till/:

```razor
@inherits LocalizedModalBase<VoidTransactionResult, VoidTransactionDialog>
@using MotoRent.Domain.Entities

<div class="void-transaction-dialog">
    <div class="dialog-header text-center mb-4">
        <div class="avatar avatar-lg bg-danger-lt mb-2">
            <i class="ti ti-x fs-2"></i>
        </div>
        <h4>@Localizer["VoidTransaction"]</h4>
        <p class="text-muted">@Localizer["VoidTransactionDescription"]</p>
    </div>

    @* Original Transaction Summary *@
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">@Localizer["OriginalTransaction"]</h5>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-6">
                    <div class="text-muted small">@Localizer["Type"]</div>
                    <div class="fw-medium">@GetTransactionTypeDisplay(Transaction.TransactionType)</div>
                </div>
                <div class="col-6">
                    <div class="text-muted small">@Localizer["Direction"]</div>
                    <div class="fw-medium">
                        @if (Transaction.Direction == TillTransactionDirection.In)
                        {
                            <span class="badge bg-success-lt">
                                <i class="ti ti-arrow-down-left me-1"></i>@Localizer["CashIn"]
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-danger-lt">
                                <i class="ti ti-arrow-up-right me-1"></i>@Localizer["CashOut"]
                            </span>
                        }
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-muted small">@Localizer["Amount"]</div>
                    <div class="fw-bold fs-4">
                        @if (Transaction.Currency == SupportedCurrencies.THB)
                        {
                            @FormatThb(Transaction.Amount)
                        }
                        else
                        {
                            <span>@Transaction.Currency @Transaction.Amount.ToString("N2")</span>
                            <span class="text-muted fs-6"> (= @FormatThb(Transaction.AmountInBaseCurrency))</span>
                        }
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-muted small">@Localizer["Time"]</div>
                    <div class="fw-medium">@Transaction.TransactionTime.ToString("HH:mm")</div>
                </div>
                @if (!string.IsNullOrEmpty(Transaction.Description))
                {
                    <div class="col-12">
                        <div class="text-muted small">@Localizer["Description"]</div>
                        <div>@Transaction.Description</div>
                    </div>
                }
            </div>
        </div>
    </div>

    @* Warning *@
    <div class="alert alert-warning mb-4">
        <div class="d-flex">
            <i class="ti ti-alert-triangle me-2"></i>
            <div>
                <h5 class="alert-title">@Localizer["ManagerApprovalRequired"]</h5>
                <p class="mb-0">@Localizer["VoidRequiresManagerPin"]</p>
            </div>
        </div>
    </div>

    @* Reason Entry *@
    <div class="mb-4">
        <label class="form-label required">@Localizer["VoidReason"]</label>
        <textarea class="form-control @(m_reasonError != null ? "is-invalid" : "")"
                  rows="2"
                  placeholder="@Localizer["EnterVoidReason"]"
                  @bind="m_reason"
                  @bind:event="oninput"></textarea>
        @if (m_reasonError != null)
        {
            <div class="invalid-feedback">@m_reasonError</div>
        }
    </div>

    @* Effect Summary *@
    <div class="effect-summary p-3 bg-light rounded mb-4">
        <div class="text-muted small mb-2">@Localizer["VoidEffect"]</div>
        @if (Transaction.Direction == TillTransactionDirection.In)
        {
            <div class="d-flex align-items-center">
                <i class="ti ti-arrow-down text-danger me-2"></i>
                <span>@Localizer["TillBalanceWillDecrease"]</span>
                <span class="ms-auto fw-bold text-danger">-@FormatCurrency(Transaction.Amount, Transaction.Currency)</span>
            </div>
        }
        else
        {
            <div class="d-flex align-items-center">
                <i class="ti ti-arrow-up text-success me-2"></i>
                <span>@Localizer["TillBalanceWillIncrease"]</span>
                <span class="ms-auto fw-bold text-success">+@FormatCurrency(Transaction.Amount, Transaction.Currency)</span>
            </div>
        }
    </div>

    @* Action Buttons *@
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-ghost-secondary flex-fill" @onclick="OnCancel">
            @Localizer["Cancel"]
        </button>
        <button type="button" class="btn btn-danger flex-fill" @onclick="OnConfirmVoid">
            <i class="ti ti-x me-1"></i>
            @Localizer["VoidTransaction"]
        </button>
    </div>
</div>

@code {
    [Parameter]
    public TillTransaction Transaction { get; set; } = null!;

    private string m_reason = "";
    private string? m_reasonError;

    private void OnConfirmVoid()
    {
        // Validate reason
        if (string.IsNullOrWhiteSpace(m_reason))
        {
            m_reasonError = Localizer["ReasonRequired"];
            return;
        }

        if (m_reason.Length < 5)
        {
            m_reasonError = Localizer["ReasonTooShort"];
            return;
        }

        m_reasonError = null;

        // Return result with reason - parent handles manager approval
        var result = new VoidTransactionResult
        {
            TransactionId = Transaction.TillTransactionId,
            Reason = m_reason.Trim()
        };

        ModalService.Close(ModalResult.Ok(result));
    }

    private void OnCancel()
    {
        ModalService.Close(ModalResult.Cancel());
    }

    private string GetTransactionTypeDisplay(TillTransactionType type)
    {
        return type switch
        {
            TillTransactionType.RentalPayment => Localizer["RentalPayment"],
            TillTransactionType.BookingDeposit => Localizer["BookingDeposit"],
            TillTransactionType.CheckIn => Localizer["CheckIn"],
            TillTransactionType.SecurityDeposit => Localizer["SecurityDeposit"],
            TillTransactionType.DamageCharge => Localizer["DamageCharge"],
            TillTransactionType.LateFee => Localizer["LateFee"],
            TillTransactionType.Surcharge => Localizer["Surcharge"],
            TillTransactionType.MiscellaneousIncome => Localizer["MiscellaneousIncome"],
            TillTransactionType.TopUp => Localizer["TopUp"],
            TillTransactionType.CardPayment => Localizer["CardPayment"],
            TillTransactionType.BankTransfer => Localizer["BankTransfer"],
            TillTransactionType.PromptPay => Localizer["PromptPay"],
            TillTransactionType.DepositRefund => Localizer["DepositRefund"],
            TillTransactionType.FuelReimbursement => Localizer["FuelReimbursement"],
            TillTransactionType.AgentCommission => Localizer["AgentCommission"],
            TillTransactionType.PettyCash => Localizer["PettyCash"],
            TillTransactionType.Drop => Localizer["CashDrop"],
            TillTransactionType.OverpaymentRefund => Localizer["OverpaymentRefund"],
            _ => type.ToString()
        };
    }

    private static string FormatThb(decimal amount)
    {
        return $"\u0e3f{amount:N0}";
    }

    private static string FormatCurrency(decimal amount, string currency)
    {
        return currency switch
        {
            SupportedCurrencies.THB => $"\u0e3f{amount:N0}",
            SupportedCurrencies.USD => $"${amount:N2}",
            SupportedCurrencies.EUR => $"\u20ac{amount:N2}",
            SupportedCurrencies.CNY => $"\u00a5{amount:N2}",
            _ => $"{currency} {amount:N2}"
        };
    }
}

/// <summary>
/// Result from void transaction dialog.
/// </summary>
public class VoidTransactionResult
{
    public int TransactionId { get; set; }
    public string Reason { get; set; } = "";
}
```

Key implementation notes:
- Shows original transaction details (type, direction, amount, currency, time)
- Foreign currency shows both original and THB equivalent
- Warning about manager approval requirement
- Reason is required with minimum 5 characters
- Effect summary shows how till balance will change
- Returns VoidTransactionResult for parent to process
  </action>
  <verify>`dotnet build src/MotoRent.Client` compiles without errors</verify>
  <done>VoidTransactionDialog.razor exists with transaction display and reason entry</done>
</task>

<task type="auto">
  <name>Task 2: Create VoidTransactionDialog CSS</name>
  <files>src/MotoRent.Client/Components/Till/VoidTransactionDialog.razor.css</files>
  <action>
Create scoped CSS for the void dialog:

```css
/* Void Transaction Dialog */

.void-transaction-dialog {
    max-width: 400px;
    margin: 0 auto;
}

.dialog-header .avatar {
    margin: 0 auto;
}

/* Effect summary styling */
.effect-summary {
    border: 1px solid var(--tblr-border-color);
}

/* Voided transaction indicator - for use in transaction lists */
::deep .voided-transaction {
    opacity: 0.6;
}

::deep .voided-transaction .amount {
    text-decoration: line-through;
}

/* Badge for void status */
::deep .void-badge {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
```
  </action>
  <verify>CSS file exists</verify>
  <done>VoidTransactionDialog.razor.css exists</done>
</task>

<task type="auto">
  <name>Task 3: Create localization resources</name>
  <files>
    src/MotoRent.Client/Resources/Components/Till/VoidTransactionDialog.resx
    src/MotoRent.Client/Resources/Components/Till/VoidTransactionDialog.en.resx
    src/MotoRent.Client/Resources/Components/Till/VoidTransactionDialog.th.resx
  </files>
  <action>
Create the resx files in Resources/Components/Till/:

**VoidTransactionDialog.resx** (default):
```xml
<?xml version="1.0" encoding="utf-8"?>
<root>
  <resheader name="resmimetype">
    <value>text/microsoft-resx</value>
  </resheader>
  <resheader name="version">
    <value>1.3</value>
  </resheader>
  <resheader name="reader">
    <value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <resheader name="writer">
    <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <data name="VoidTransaction" xml:space="preserve">
    <value>Void Transaction</value>
  </data>
  <data name="VoidTransactionDescription" xml:space="preserve">
    <value>This will reverse the transaction and update the till balance</value>
  </data>
  <data name="OriginalTransaction" xml:space="preserve">
    <value>Original Transaction</value>
  </data>
  <data name="Type" xml:space="preserve">
    <value>Type</value>
  </data>
  <data name="Direction" xml:space="preserve">
    <value>Direction</value>
  </data>
  <data name="Amount" xml:space="preserve">
    <value>Amount</value>
  </data>
  <data name="Time" xml:space="preserve">
    <value>Time</value>
  </data>
  <data name="Description" xml:space="preserve">
    <value>Description</value>
  </data>
  <data name="CashIn" xml:space="preserve">
    <value>Cash In</value>
  </data>
  <data name="CashOut" xml:space="preserve">
    <value>Cash Out</value>
  </data>
  <data name="ManagerApprovalRequired" xml:space="preserve">
    <value>Manager Approval Required</value>
  </data>
  <data name="VoidRequiresManagerPin" xml:space="preserve">
    <value>Voiding a transaction requires manager PIN approval</value>
  </data>
  <data name="VoidReason" xml:space="preserve">
    <value>Reason for Void</value>
  </data>
  <data name="EnterVoidReason" xml:space="preserve">
    <value>Enter reason for voiding this transaction...</value>
  </data>
  <data name="ReasonRequired" xml:space="preserve">
    <value>Please enter a reason</value>
  </data>
  <data name="ReasonTooShort" xml:space="preserve">
    <value>Reason must be at least 5 characters</value>
  </data>
  <data name="VoidEffect" xml:space="preserve">
    <value>Effect on Till Balance</value>
  </data>
  <data name="TillBalanceWillDecrease" xml:space="preserve">
    <value>Till balance will decrease by</value>
  </data>
  <data name="TillBalanceWillIncrease" xml:space="preserve">
    <value>Till balance will increase by</value>
  </data>
  <data name="Cancel" xml:space="preserve">
    <value>Cancel</value>
  </data>
  <data name="RentalPayment" xml:space="preserve">
    <value>Rental Payment</value>
  </data>
  <data name="BookingDeposit" xml:space="preserve">
    <value>Booking Deposit</value>
  </data>
  <data name="CheckIn" xml:space="preserve">
    <value>Check-In</value>
  </data>
  <data name="SecurityDeposit" xml:space="preserve">
    <value>Security Deposit</value>
  </data>
  <data name="DamageCharge" xml:space="preserve">
    <value>Damage Charge</value>
  </data>
  <data name="LateFee" xml:space="preserve">
    <value>Late Fee</value>
  </data>
  <data name="Surcharge" xml:space="preserve">
    <value>Surcharge</value>
  </data>
  <data name="MiscellaneousIncome" xml:space="preserve">
    <value>Miscellaneous</value>
  </data>
  <data name="TopUp" xml:space="preserve">
    <value>Top Up</value>
  </data>
  <data name="CardPayment" xml:space="preserve">
    <value>Card Payment</value>
  </data>
  <data name="BankTransfer" xml:space="preserve">
    <value>Bank Transfer</value>
  </data>
  <data name="PromptPay" xml:space="preserve">
    <value>PromptPay</value>
  </data>
  <data name="DepositRefund" xml:space="preserve">
    <value>Deposit Refund</value>
  </data>
  <data name="FuelReimbursement" xml:space="preserve">
    <value>Fuel Reimbursement</value>
  </data>
  <data name="AgentCommission" xml:space="preserve">
    <value>Agent Commission</value>
  </data>
  <data name="PettyCash" xml:space="preserve">
    <value>Petty Cash</value>
  </data>
  <data name="CashDrop" xml:space="preserve">
    <value>Cash Drop</value>
  </data>
  <data name="OverpaymentRefund" xml:space="preserve">
    <value>Overpayment Refund</value>
  </data>
</root>
```

**VoidTransactionDialog.en.resx** (English - same as default).

**VoidTransactionDialog.th.resx** (Thai):
```xml
<?xml version="1.0" encoding="utf-8"?>
<root>
  <resheader name="resmimetype">
    <value>text/microsoft-resx</value>
  </resheader>
  <resheader name="version">
    <value>1.3</value>
  </resheader>
  <resheader name="reader">
    <value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <resheader name="writer">
    <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>
  </resheader>
  <data name="VoidTransaction" xml:space="preserve">
    <value>ยกเลิกรายการ</value>
  </data>
  <data name="VoidTransactionDescription" xml:space="preserve">
    <value>การดำเนินการนี้จะย้อนรายการและปรับยอดเงินสดในลิ้นชัก</value>
  </data>
  <data name="OriginalTransaction" xml:space="preserve">
    <value>รายการเดิม</value>
  </data>
  <data name="Type" xml:space="preserve">
    <value>ประเภท</value>
  </data>
  <data name="Direction" xml:space="preserve">
    <value>ทิศทาง</value>
  </data>
  <data name="Amount" xml:space="preserve">
    <value>จำนวนเงิน</value>
  </data>
  <data name="Time" xml:space="preserve">
    <value>เวลา</value>
  </data>
  <data name="Description" xml:space="preserve">
    <value>รายละเอียด</value>
  </data>
  <data name="CashIn" xml:space="preserve">
    <value>เงินเข้า</value>
  </data>
  <data name="CashOut" xml:space="preserve">
    <value>เงินออก</value>
  </data>
  <data name="ManagerApprovalRequired" xml:space="preserve">
    <value>ต้องการการอนุมัติจากผู้จัดการ</value>
  </data>
  <data name="VoidRequiresManagerPin" xml:space="preserve">
    <value>การยกเลิกรายการต้องได้รับการอนุมัติด้วยรหัส PIN ของผู้จัดการ</value>
  </data>
  <data name="VoidReason" xml:space="preserve">
    <value>เหตุผลในการยกเลิก</value>
  </data>
  <data name="EnterVoidReason" xml:space="preserve">
    <value>ใส่เหตุผลในการยกเลิกรายการนี้...</value>
  </data>
  <data name="ReasonRequired" xml:space="preserve">
    <value>กรุณาใส่เหตุผล</value>
  </data>
  <data name="ReasonTooShort" xml:space="preserve">
    <value>เหตุผลต้องมีอย่างน้อย 5 ตัวอักษร</value>
  </data>
  <data name="VoidEffect" xml:space="preserve">
    <value>ผลกระทบต่อยอดเงินสด</value>
  </data>
  <data name="TillBalanceWillDecrease" xml:space="preserve">
    <value>ยอดเงินจะลดลง</value>
  </data>
  <data name="TillBalanceWillIncrease" xml:space="preserve">
    <value>ยอดเงินจะเพิ่มขึ้น</value>
  </data>
  <data name="Cancel" xml:space="preserve">
    <value>ยกเลิก</value>
  </data>
  <data name="RentalPayment" xml:space="preserve">
    <value>ค่าเช่า</value>
  </data>
  <data name="BookingDeposit" xml:space="preserve">
    <value>มัดจำการจอง</value>
  </data>
  <data name="CheckIn" xml:space="preserve">
    <value>เช็คอิน</value>
  </data>
  <data name="SecurityDeposit" xml:space="preserve">
    <value>เงินประกัน</value>
  </data>
  <data name="DamageCharge" xml:space="preserve">
    <value>ค่าเสียหาย</value>
  </data>
  <data name="LateFee" xml:space="preserve">
    <value>ค่าปรับล่าช้า</value>
  </data>
  <data name="Surcharge" xml:space="preserve">
    <value>ค่าธรรมเนียมเพิ่มเติม</value>
  </data>
  <data name="MiscellaneousIncome" xml:space="preserve">
    <value>รายได้อื่นๆ</value>
  </data>
  <data name="TopUp" xml:space="preserve">
    <value>เติมเงิน</value>
  </data>
  <data name="CardPayment" xml:space="preserve">
    <value>บัตรเครดิต</value>
  </data>
  <data name="BankTransfer" xml:space="preserve">
    <value>โอนเงิน</value>
  </data>
  <data name="PromptPay" xml:space="preserve">
    <value>พร้อมเพย์</value>
  </data>
  <data name="DepositRefund" xml:space="preserve">
    <value>คืนเงินประกัน</value>
  </data>
  <data name="FuelReimbursement" xml:space="preserve">
    <value>คืนค่าน้ำมัน</value>
  </data>
  <data name="AgentCommission" xml:space="preserve">
    <value>ค่าคอมมิชชั่น</value>
  </data>
  <data name="PettyCash" xml:space="preserve">
    <value>เงินสดย่อย</value>
  </data>
  <data name="CashDrop" xml:space="preserve">
    <value>นำเงินออก</value>
  </data>
  <data name="OverpaymentRefund" xml:space="preserve">
    <value>คืนเงินจ่ายเกิน</value>
  </data>
</root>
```
  </action>
  <verify>All three resx files exist in Resources/Components/Till/</verify>
  <done>Localization resources created for VoidTransactionDialog</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MotoRent.Client` - compiles without errors
2. VoidTransactionDialog.razor exists with transaction display
3. VoidTransactionDialog.razor.css has styling
4. All localization files (default, en, th) exist
5. Dialog shows original transaction details
6. Reason is required before confirm
</verification>

<success_criteria>
- VoidTransactionDialog created showing original transaction
- Reason entry with validation (required, min 5 chars)
- Warning about manager approval shown
- Effect summary shows balance change
- Localization for English and Thai
</success_criteria>

<output>
After completion, create `.planning/phases/05-refunds-corrections/05-04-SUMMARY.md`
</output>
