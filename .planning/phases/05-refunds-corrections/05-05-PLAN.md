---
phase: 05-refunds-corrections
plan: 05
type: execute
wave: 4
depends_on: ["05-03", "05-04"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/Till.razor
  - src/MotoRent.Client/Resources/Pages/Staff/Till.resx
  - src/MotoRent.Client/Resources/Pages/Staff/Till.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/Till.th.resx
autonomous: true

must_haves:
  truths:
    - "Staff can click Void button on non-voided transactions"
    - "Voided transactions show strikethrough text and VOID badge"
    - "Void workflow triggers PIN dialog then executes void"
    - "Transaction list refreshes after void"
    - "Only open session allows voiding"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/Till.razor"
      provides: "Void button and voided transaction display"
      contains: "VoidTransactionDialog"
  key_links:
    - from: "Till.razor"
      to: "VoidTransactionDialog"
      via: "IModalService.Show"
      pattern: "ModalService.Show.*VoidTransactionDialog"
    - from: "Till.razor"
      to: "ManagerPinDialog"
      via: "IModalService.Show"
      pattern: "ModalService.Show.*ManagerPinDialog"
    - from: "Till.razor"
      to: "TillService.VoidTransactionAsync"
      via: "Service call"
      pattern: "VoidTransactionAsync"
---

<objective>
Integrate void workflow into Till.razor page with void button on transactions, voided display styling, and full void flow (initiation -> manager PIN -> execution).

Purpose: Complete void user experience. Staff see void buttons, can initiate voids, get manager approval via PIN, and see voided transactions marked appropriately.

Output: Till.razor updated with void button, voided styling, and complete void workflow integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-refunds-corrections/05-CONTEXT.md
@.planning/phases/05-refunds-corrections/05-03-SUMMARY.md
@.planning/phases/05-refunds-corrections/05-04-SUMMARY.md

# Page to update
@src/MotoRent.Client/Pages/Staff/Till.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add void button and voided styling to transaction list</name>
  <files>src/MotoRent.Client/Pages/Staff/Till.razor</files>
  <action>
Update the transaction list section in Till.razor to include void button and voided transaction styling.

Find the transaction list table (likely using MudDataGrid or table) and modify the row display:

1. Add VOID badge and strikethrough for voided transactions
2. Add void button for non-voided transactions (when session is open)
3. Add ManagerPinService injection

**Injections to add at top:**
```razor
@inject ManagerPinService ManagerPinService
```

**For each transaction row in the table, wrap the display with voided styling:**

Replace the transaction row rendering with something like:
```razor
<tr class="@(txn.IsVoided ? "voided-row" : "")">
    <td>
        @if (txn.IsVoided)
        {
            <span class="badge bg-danger me-2 void-badge">VOID</span>
        }
        <span class="@(txn.IsVoided ? "text-decoration-line-through text-muted" : "")">
            @GetTransactionTypeDisplay(txn.TransactionType)
        </span>
    </td>
    <td class="@(txn.IsVoided ? "text-decoration-line-through text-muted" : "")">
        @if (txn.Direction == TillTransactionDirection.In)
        {
            <span class="text-success">+@FormatCurrency(txn.Amount, txn.Currency)</span>
        }
        else
        {
            <span class="text-danger">-@FormatCurrency(txn.Amount, txn.Currency)</span>
        }
    </td>
    <td>
        @txn.TransactionTime.ToString("HH:mm")
    </td>
    <td>
        @if (!txn.IsVoided && CanVoidTransaction(txn) && IsSessionOpen)
        {
            <button type="button"
                    class="btn btn-sm btn-ghost-danger"
                    @onclick="() => InitiateVoidAsync(txn)"
                    title="@Localizer["VoidTransaction"]">
                <i class="ti ti-x"></i>
            </button>
        }
        @if (txn.IsVoided)
        {
            <button type="button"
                    class="btn btn-sm btn-ghost-secondary"
                    @onclick="() => ShowVoidDetailsAsync(txn)"
                    title="@Localizer["ViewVoidDetails"]">
                <i class="ti ti-info-circle"></i>
            </button>
        }
    </td>
</tr>
```

**Add CSS class for voided rows (inline or in .razor.css if exists):**
```css
.voided-row {
    background-color: rgba(var(--tblr-danger-rgb), 0.05);
}
.void-badge {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
```

**Note:** Adapt to actual table structure used in Till.razor (MudDataGrid, table, or other component). The key elements are:
- IsVoided check for conditional styling
- VOID badge display
- Strikethrough on voided amount/description
- Void button with disabled check
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Client`</verify>
  <done>Transaction list shows void button and voided styling</done>
</task>

<task type="auto">
  <name>Task 2: Implement void workflow methods</name>
  <files>src/MotoRent.Client/Pages/Staff/Till.razor</files>
  <action>
Add the void workflow methods to the @code section:

```csharp
/// <summary>
/// Checks if a transaction can be voided.
/// </summary>
private bool CanVoidTransaction(TillTransaction txn)
{
    if (txn.IsVoided) return false;
    if (txn.TransactionType == TillTransactionType.VoidReversal) return false;
    // Don't allow voiding transactions from previous days (optional strictness)
    // if (txn.TransactionTime.Date != DateTimeOffset.Now.Date) return false;
    return true;
}

/// <summary>
/// Initiates the void workflow - shows void dialog then manager PIN.
/// </summary>
private async Task InitiateVoidAsync(TillTransaction txn)
{
    // Step 1: Show void confirmation dialog with reason entry
    var voidParams = new DialogParameters
    {
        { nameof(VoidTransactionDialog.Transaction), txn }
    };
    var voidOptions = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
    var voidResult = await ModalService.Show<VoidTransactionDialog>(
        Localizer["VoidTransaction"],
        voidParams,
        voidOptions).Result;

    if (voidResult.Canceled) return;

    var voidData = voidResult.Data as VoidTransactionResult;
    if (voidData == null) return;

    // Step 2: Show manager PIN dialog
    var pinResult = await ShowManagerPinDialogAsync();
    if (pinResult == null) return; // Canceled or failed

    // Step 3: Execute the void
    await ExecuteVoidAsync(txn.TillTransactionId, voidData.Reason, pinResult);
}

/// <summary>
/// Shows manager PIN dialog and handles verification.
/// Returns manager username on success, null on cancel/failure.
/// </summary>
private async Task<string?> ShowManagerPinDialogAsync()
{
    var pinParams = new DialogParameters
    {
        { nameof(ManagerPinDialog.OnVerify), new Func<string, string, Task<(bool IsValid, string? Error, int RemainingAttempts)>>(VerifyManagerPinAsync) }
    };
    var pinOptions = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
    var pinResult = await ModalService.Show<ManagerPinDialog>(
        Localizer["ManagerApproval"],
        pinParams,
        pinOptions).Result;

    if (pinResult.Canceled) return null;
    return pinResult.Data as string;
}

/// <summary>
/// Verifies manager PIN - called by ManagerPinDialog.
/// </summary>
private async Task<(bool IsValid, string? Error, int RemainingAttempts)> VerifyManagerPinAsync(string managerUserName, string pin)
{
    // Load manager user
    // Note: In a real implementation, you'd load the user from CoreDataContext
    // For now, we use the service's in-memory verification
    // This requires the manager to be loaded - adapt based on actual implementation

    // TODO: Load manager user and verify
    // var manager = await LoadManagerUserAsync(managerUserName);
    // if (manager == null) return (false, "Manager not found", 0);
    // return ManagerPinService.VerifyPin(manager, pin);

    // Placeholder - in integration, wire up proper user loading
    return (false, "Manager PIN verification not yet implemented", 0);
}

/// <summary>
/// Executes the void operation after confirmation and PIN approval.
/// </summary>
private async Task ExecuteVoidAsync(int transactionId, string reason, string managerUserName)
{
    m_loading = true;
    StateHasChanged();

    try
    {
        var result = await TillService.VoidTransactionAsync(
            transactionId,
            m_currentUser, // Staff initiating
            managerUserName, // Manager approving
            reason);

        if (result.Succeeded)
        {
            await ShowSuccessAsync(Localizer["TransactionVoided"]);
            await RefreshTransactionsAsync();
        }
        else
        {
            await ShowErrorAsync(result.Errors.FirstOrDefault()?.Message ?? Localizer["VoidFailed"]);
        }
    }
    finally
    {
        m_loading = false;
        StateHasChanged();
    }
}

/// <summary>
/// Shows void details for a voided transaction.
/// </summary>
private async Task ShowVoidDetailsAsync(TillTransaction txn)
{
    var message = $"{Localizer["VoidedBy"]}: {txn.VoidedByUserName}\n" +
                  $"{Localizer["ApprovedBy"]}: {txn.VoidApprovedByUserName}\n" +
                  $"{Localizer["Reason"]}: {txn.VoidReason}\n" +
                  $"{Localizer["VoidedAt"]}: {txn.VoidedAt?.ToString("yyyy-MM-dd HH:mm")}";

    // Use snackbar or dialog to show details
    // Adapt based on existing patterns in the codebase
    await ShowInfoAsync(message);
}

/// <summary>
/// Refreshes the transaction list.
/// </summary>
private async Task RefreshTransactionsAsync()
{
    if (m_session != null)
    {
        m_transactions = await TillService.GetTransactionsAsync(m_session.TillSessionId);
        StateHasChanged();
    }
}

// Helper for checking if session is open
private bool IsSessionOpen => m_session?.Status == TillSessionStatus.Open;
```

**Important notes:**
- Adapt variable names (m_session, m_transactions, m_currentUser, m_loading) to match existing code
- Adapt dialog/snackbar methods (ShowSuccessAsync, ShowErrorAsync, ShowInfoAsync) to match existing patterns
- The VerifyManagerPinAsync needs proper user loading - mark as TODO for now
- Import required namespaces at top of file
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Client`</verify>
  <done>Void workflow methods added to Till.razor</done>
</task>

<task type="auto">
  <name>Task 3: Add localization keys for void workflow</name>
  <files>
    src/MotoRent.Client/Resources/Pages/Staff/Till.resx
    src/MotoRent.Client/Resources/Pages/Staff/Till.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/Till.th.resx
  </files>
  <action>
Add the following localization keys to the Till.resx files:

**Keys to add (English values):**
```
VoidTransaction = Void Transaction
ViewVoidDetails = View Void Details
ManagerApproval = Manager Approval
TransactionVoided = Transaction voided successfully
VoidFailed = Failed to void transaction
VoidedBy = Voided by
ApprovedBy = Approved by
Reason = Reason
VoidedAt = Voided at
```

**Thai translations:**
```
VoidTransaction = ยกเลิกรายการ
ViewVoidDetails = ดูรายละเอียดการยกเลิก
ManagerApproval = การอนุมัติจากผู้จัดการ
TransactionVoided = ยกเลิกรายการสำเร็จ
VoidFailed = ไม่สามารถยกเลิกรายการได้
VoidedBy = ยกเลิกโดย
ApprovedBy = อนุมัติโดย
Reason = เหตุผล
VoidedAt = ยกเลิกเมื่อ
```

Read the existing Till.resx files first, then append these new keys while preserving existing content.
  </action>
  <verify>All new localization keys exist in Till resx files</verify>
  <done>Void-related localization keys added to Till.resx files</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MotoRent.Client` - compiles without errors
2. Transaction list shows void button on eligible transactions
3. Voided transactions show strikethrough and VOID badge
4. Clicking void opens VoidTransactionDialog
5. After reason entry, ManagerPinDialog opens
6. Successful void refreshes transaction list
7. Void details viewable for voided transactions
</verification>

<success_criteria>
- Void button visible on non-voided transactions
- Voided transactions display with strikethrough and badge
- Full void workflow works: initiate -> reason -> PIN -> execute
- Transaction list refreshes after void
- Localization for English and Thai
</success_criteria>

<output>
After completion, create `.planning/phases/05-refunds-corrections/05-05-SUMMARY.md`
</output>
