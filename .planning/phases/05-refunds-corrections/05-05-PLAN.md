---
phase: 05-refunds-corrections
plan: 05
type: execute
wave: 4
depends_on: ["05-03", "05-04"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/Till.razor
  - src/MotoRent.Client/Components/Till/OverpaymentRefundDialog.razor
  - src/MotoRent.Client/Components/Till/OverpaymentRefundDialog.razor.css
  - src/MotoRent.Client/Resources/Pages/Staff/Till.resx
  - src/MotoRent.Client/Resources/Pages/Staff/Till.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/Till.th.resx
  - src/MotoRent.Client/Resources/Components/Till/OverpaymentRefundDialog.resx
  - src/MotoRent.Client/Resources/Components/Till/OverpaymentRefundDialog.en.resx
  - src/MotoRent.Client/Resources/Components/Till/OverpaymentRefundDialog.th.resx
autonomous: true

must_haves:
  truths:
    - "Staff can click Void button on non-voided transactions"
    - "Voided transactions show strikethrough text and VOID badge"
    - "Void workflow triggers PIN dialog then executes void"
    - "Transaction list refreshes after void"
    - "Only open session allows voiding"
    - "Staff can initiate overpayment refund from transaction with overpayment"
    - "Overpayment refund shows original payment breakdown and refund amount"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/Till.razor"
      provides: "Void button, voided transaction display, and overpayment refund trigger"
      contains: "VoidTransactionDialog"
    - path: "src/MotoRent.Client/Components/Till/OverpaymentRefundDialog.razor"
      provides: "Dialog to initiate overpayment refund with payment breakdown"
      min_lines: 80
  key_links:
    - from: "Till.razor"
      to: "VoidTransactionDialog"
      via: "DialogService.Create"
      pattern: "DialogService.Create.*VoidTransactionDialog"
    - from: "Till.razor"
      to: "ManagerPinDialog"
      via: "DialogService.Create"
      pattern: "DialogService.Create.*ManagerPinDialog"
    - from: "Till.razor"
      to: "TillService.VoidTransactionAsync"
      via: "Service call"
      pattern: "VoidTransactionAsync"
    - from: "Till.razor"
      to: "OverpaymentRefundDialog"
      via: "DialogService.Create"
      pattern: "DialogService.Create.*OverpaymentRefundDialog"
    - from: "Till.razor"
      to: "TillService.RecordOverpaymentRefundAsync"
      via: "Service call"
      pattern: "RecordOverpaymentRefundAsync"
---

<objective>
Integrate void workflow and overpayment refund into Till.razor page with void button on transactions, voided display styling, overpayment refund dialog, and full void flow (initiation -> manager PIN -> execution).

Purpose: Complete void and overpayment refund user experience. Staff see void buttons, can initiate voids with manager approval, and can process overpayment refunds from transactions that show excess payment.

Output: Till.razor updated with void button, voided styling, overpayment refund action, and complete void workflow integration. OverpaymentRefundDialog for REFUND-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-refunds-corrections/05-CONTEXT.md
@.planning/phases/05-refunds-corrections/05-03-SUMMARY.md
@.planning/phases/05-refunds-corrections/05-04-SUMMARY.md

# Page to update
@src/MotoRent.Client/Pages/Staff/Till.razor

# Services for verification
@src/MotoRent.Services/TillService.cs
@src/MotoRent.Services/ManagerPinService.cs

# Dialog pattern reference (use DialogService.Create<T>().WithParameter().ShowDialogAsync())
@src/MotoRent.Client/Pages/Finance/AssetEdit.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add void button and voided styling to transaction list</name>
  <files>src/MotoRent.Client/Pages/Staff/Till.razor</files>
  <action>
Update the transaction list section in Till.razor to include void button and voided transaction styling.

Find the transaction list table (likely using MudDataGrid or table) and modify the row display:

1. Add VOID badge and strikethrough for voided transactions
2. Add void button for non-voided transactions (when session is open)
3. Add ManagerPinService and CoreDataContext injections

**Injections to add at top:**
```razor
@inject ManagerPinService ManagerPinService
@inject CoreDataContext CoreDataContext
```

**For each transaction row in the table, wrap the display with voided styling:**

Replace the transaction row rendering with something like:
```razor
<tr class="@(txn.IsVoided ? "voided-row" : "")">
    <td>
        @if (txn.IsVoided)
        {
            <span class="badge bg-danger me-2 void-badge">VOID</span>
        }
        <span class="@(txn.IsVoided ? "text-decoration-line-through text-muted" : "")">
            @GetTransactionTypeDisplay(txn.TransactionType)
        </span>
    </td>
    <td class="@(txn.IsVoided ? "text-decoration-line-through text-muted" : "")">
        @if (txn.Direction == TillTransactionDirection.In)
        {
            <span class="text-success">+@FormatCurrency(txn.Amount, txn.Currency)</span>
        }
        else
        {
            <span class="text-danger">-@FormatCurrency(txn.Amount, txn.Currency)</span>
        }
    </td>
    <td>
        @txn.TransactionTime.ToString("HH:mm")
    </td>
    <td>
        @if (!txn.IsVoided && CanVoidTransaction(txn) && IsSessionOpen)
        {
            <button type="button"
                    class="btn btn-sm btn-ghost-danger"
                    @onclick="() => InitiateVoidAsync(txn)"
                    title="@Localizer["VoidTransaction"]">
                <i class="ti ti-x"></i>
            </button>
        }
        @if (txn.IsVoided)
        {
            <button type="button"
                    class="btn btn-sm btn-ghost-secondary"
                    @onclick="() => ShowVoidDetailsAsync(txn)"
                    title="@Localizer["ViewVoidDetails"]">
                <i class="ti ti-info-circle"></i>
            </button>
        }
    </td>
</tr>
```

**Add CSS class for voided rows (inline or in .razor.css if exists):**
```css
.voided-row {
    background-color: rgba(var(--tblr-danger-rgb), 0.05);
}
.void-badge {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}
```

**Note:** Adapt to actual table structure used in Till.razor (MudDataGrid, table, or other component). The key elements are:
- IsVoided check for conditional styling
- VOID badge display
- Strikethrough on voided amount/description
- Void button with disabled check
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Client`</verify>
  <done>Transaction list shows void button and voided styling</done>
</task>

<task type="auto">
  <name>Task 2: Implement void workflow methods with proper dialog pattern</name>
  <files>src/MotoRent.Client/Pages/Staff/Till.razor</files>
  <action>
Add the void workflow methods to the @code section.

**IMPORTANT:** Use `DialogService.Create<T>().WithParameter().ShowDialogAsync()` pattern (not `ModalService.Show<T>`). This is the pattern used throughout the codebase (see Till.razor existing dialogs, AssetEdit.razor).

```csharp
/// <summary>
/// Checks if a transaction can be voided.
/// </summary>
private bool CanVoidTransaction(TillTransaction txn)
{
    if (txn.IsVoided) return false;
    if (txn.TransactionType == TillTransactionType.VoidReversal) return false;
    // Don't allow voiding transactions from previous days (optional strictness)
    // if (txn.TransactionTime.Date != DateTimeOffset.Now.Date) return false;
    return true;
}

/// <summary>
/// Initiates the void workflow - shows void dialog then manager PIN.
/// Uses DialogService.Create pattern matching existing codebase conventions.
/// </summary>
private async Task InitiateVoidAsync(TillTransaction txn)
{
    // Step 1: Show void confirmation dialog with reason entry
    var voidResult = await this.DialogService.Create<VoidTransactionDialog>(Localizer["VoidTransaction"])
        .WithParameter(x => x.Transaction, txn)
        .ShowDialogAsync();

    if (voidResult == null) return; // Canceled

    var voidData = voidResult as VoidTransactionResult;
    if (voidData == null) return;

    // Step 2: Show manager PIN dialog
    // ManagerPinDialog now handles verification internally - no callback needed
    var pinResult = await ShowManagerPinDialogAsync();
    if (pinResult == null) return; // Canceled or failed

    // Step 3: Execute the void
    await ExecuteVoidAsync(txn.TillTransactionId, voidData.Reason, pinResult);
}

/// <summary>
/// Shows manager PIN dialog using DialogService.Create pattern.
/// ManagerPinDialog handles manager loading and PIN verification internally.
/// Returns manager username on success, null on cancel/failure.
/// </summary>
private async Task<string?> ShowManagerPinDialogAsync()
{
    var result = await this.DialogService.Create<ManagerPinDialog>(Localizer["ManagerApproval"])
        .ShowDialogAsync();

    return result as string;
}

/// <summary>
/// Executes the void operation after confirmation and PIN approval.
/// </summary>
private async Task ExecuteVoidAsync(int transactionId, string reason, string managerUserName)
{
    m_loading = true;
    StateHasChanged();

    try
    {
        var result = await TillService.VoidTransactionAsync(
            transactionId,
            UserName, // Staff initiating (use existing UserName property)
            managerUserName, // Manager approving
            reason);

        if (result.Success)
        {
            ShowSuccess(Localizer["TransactionVoided"]);
            await LoadDataAsync(); // Use existing data refresh method
        }
        else
        {
            ShowError(result.Errors.FirstOrDefault()?.Message ?? Localizer["VoidFailed"]);
        }
    }
    finally
    {
        m_loading = false;
        StateHasChanged();
    }
}

/// <summary>
/// Shows void details for a voided transaction.
/// </summary>
private async Task ShowVoidDetailsAsync(TillTransaction txn)
{
    var message = $"{Localizer["VoidedBy"]}: {txn.VoidedByUserName}\n" +
                  $"{Localizer["ApprovedBy"]}: {txn.VoidApprovedByUserName}\n" +
                  $"{Localizer["Reason"]}: {txn.VoidReason}\n" +
                  $"{Localizer["VoidedAt"]}: {txn.VoidedAt?.ToString("yyyy-MM-dd HH:mm")}";

    // Use existing snackbar/notification pattern in the codebase
    ShowInfo(message);
}

// Helper for checking if session is open
private bool IsSessionOpen => m_session?.Status == TillSessionStatus.Open;
```

**Important notes:**
- Uses `DialogService.Create<T>().WithParameter().ShowDialogAsync()` pattern per codebase convention
- ManagerPinDialog verifies PIN internally (per 05-03)
- Uses `result.Success` (not `result.Succeeded`) per SubmitOperation API
- Adapt variable names (m_session, m_loading) to match existing code
- Adapt ShowSuccess, ShowError, ShowInfo, LoadDataAsync to match existing patterns
- Import required namespaces at top of file
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Client`</verify>
  <done>Void workflow methods added to Till.razor with proper integration</done>
</task>

<task type="auto">
  <name>Task 3: Create OverpaymentRefundDialog for REFUND-02</name>
  <files>
    src/MotoRent.Client/Components/Till/OverpaymentRefundDialog.razor
    src/MotoRent.Client/Components/Till/OverpaymentRefundDialog.razor.css
  </files>
  <action>
Create OverpaymentRefundDialog component to initiate overpayment refunds (REFUND-02).

Per CONTEXT.md: "Refunds initiated from original transaction" and "Overpayment refund amount is auto-calculated (not editable by staff)".

**IMPORTANT:** `ReceiptPayment.PaymentId` is `string` (not `int`), so `OriginalPaymentIds` must be `List<string>?`.

**OverpaymentRefundDialog.razor:**
```razor
@inherits LocalizedDialogBase<OverpaymentRefundResult, OverpaymentRefundDialog>
@using MotoRent.Domain.Entities

<div class="overpayment-refund-dialog">
    <div class="dialog-header text-center mb-4">
        <div class="avatar avatar-lg bg-success-lt mb-2">
            <i class="ti ti-cash-off fs-2"></i>
        </div>
        <h4>@Localizer["OverpaymentRefund"]</h4>
        <p class="text-muted">@Localizer["RefundExcessPayment"]</p>
    </div>

    @* Original Payment Summary *@
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">@Localizer["OriginalPayment"]</h5>
        </div>
        <div class="card-body">
            @if (OriginalPayments != null && OriginalPayments.Count > 0)
            {
                @foreach (var payment in OriginalPayments)
                {
                    <div class="d-flex justify-content-between mb-2">
                        <span>
                            <i class="ti @GetPaymentMethodIcon(payment.Method) me-1"></i>
                            @payment.Method (@payment.Currency)
                        </span>
                        <span>
                            @FormatCurrency(payment.Amount, payment.Currency)
                            @if (payment.Currency != SupportedCurrencies.THB)
                            {
                                <span class="text-muted"> = @FormatThb(payment.AmountInBaseCurrency)</span>
                            }
                        </span>
                    </div>
                }
                <hr />
                <div class="d-flex justify-content-between fw-bold">
                    <span>@Localizer["TotalPaid"]</span>
                    <span>@FormatThb(TotalPaidThb)</span>
                </div>
                <div class="d-flex justify-content-between text-muted">
                    <span>@Localizer["AmountDue"]</span>
                    <span>@FormatThb(AmountDueThb)</span>
                </div>
            }
            else
            {
                <p class="text-muted">@Localizer["NoPaymentData"]</p>
            }
        </div>
    </div>

    @* Overpayment Amount *@
    <div class="refund-amount-card mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="text-muted small">@Localizer["OverpaymentAmount"]</div>
                <div class="fs-3 fw-bold text-success">@FormatThb(OverpaymentAmount)</div>
            </div>
            <div class="refund-icon">
                <i class="ti ti-arrow-right"></i>
            </div>
            <div class="text-end">
                <div class="text-muted small">@Localizer["RefundInCash"]</div>
                <div class="fs-3 fw-bold">@FormatThb(OverpaymentAmount) THB</div>
            </div>
        </div>
    </div>

    @* Reason Entry *@
    <div class="mb-4">
        <label class="form-label required">@Localizer["RefundReason"]</label>
        <textarea class="form-control @(m_reasonError != null ? "is-invalid" : "")"
                  rows="2"
                  placeholder="@Localizer["EnterRefundReason"]"
                  @bind="m_reason"
                  @bind:event="oninput"></textarea>
        @if (m_reasonError != null)
        {
            <div class="invalid-feedback">@m_reasonError</div>
        }
    </div>

    @* Warning if till balance is low *@
    @if (TillThbBalance < OverpaymentAmount)
    {
        <div class="alert alert-warning mb-4">
            <i class="ti ti-alert-triangle me-2"></i>
            @Localizer["TillBalanceWarning", FormatThb(TillThbBalance)]
        </div>
    }

    @* Action Buttons *@
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-ghost-secondary flex-fill" @onclick="OnCancel">
            @Localizer["Cancel"]
        </button>
        <button type="button" class="btn btn-success flex-fill" @onclick="OnConfirmRefund" disabled="@(OverpaymentAmount <= 0)">
            <i class="ti ti-cash me-1"></i>
            @Localizer["IssueRefund"]
        </button>
    </div>
</div>

@code {
    [Parameter] public List<ReceiptPayment>? OriginalPayments { get; set; }
    [Parameter] public decimal TotalPaidThb { get; set; }
    [Parameter] public decimal AmountDueThb { get; set; }
    [Parameter] public int? RentalId { get; set; }
    [Parameter] public decimal TillThbBalance { get; set; }

    private string m_reason = "";
    private string? m_reasonError;

    private decimal OverpaymentAmount => Math.Max(0, TotalPaidThb - AmountDueThb);

    private void OnConfirmRefund()
    {
        // Validate reason
        if (string.IsNullOrWhiteSpace(m_reason))
        {
            m_reasonError = Localizer["ReasonRequired"];
            return;
        }

        if (m_reason.Length < 5)
        {
            m_reasonError = Localizer["ReasonTooShort"];
            return;
        }

        m_reasonError = null;

        var result = new OverpaymentRefundResult
        {
            RefundAmountThb = OverpaymentAmount,
            Reason = m_reason.Trim(),
            RentalId = RentalId,
            // ReceiptPayment.PaymentId is string, so collect as strings
            OriginalPaymentIds = OriginalPayments?
                .Select(p => p.PaymentId)
                .Where(id => !string.IsNullOrEmpty(id))
                .ToList()
        };

        DialogService.Close(result);
    }

    private void OnCancel()
    {
        DialogService.Close(null);
    }

    private static string GetPaymentMethodIcon(string method) => method switch
    {
        "Cash" => "ti-cash",
        "Card" => "ti-credit-card",
        "PromptPay" => "ti-qrcode",
        "BankTransfer" => "ti-building-bank",
        _ => "ti-currency-baht"
    };

    private static string FormatThb(decimal amount) => $"\u0e3f{amount:N0}";

    private static string FormatCurrency(decimal amount, string currency) => currency switch
    {
        SupportedCurrencies.THB => $"\u0e3f{amount:N0}",
        SupportedCurrencies.USD => $"${amount:N2}",
        SupportedCurrencies.EUR => $"\u20ac{amount:N2}",
        SupportedCurrencies.CNY => $"\u00a5{amount:N2}",
        _ => $"{currency} {amount:N2}"
    };
}

/// <summary>
/// Result from overpayment refund dialog.
/// </summary>
public class OverpaymentRefundResult
{
    public decimal RefundAmountThb { get; set; }
    public string Reason { get; set; } = "";
    public int? RentalId { get; set; }
    /// <summary>
    /// Original payment IDs (string type to match ReceiptPayment.PaymentId)
    /// </summary>
    public List<string>? OriginalPaymentIds { get; set; }
}
```

**OverpaymentRefundDialog.razor.css:**
```css
/* Overpayment Refund Dialog */

.overpayment-refund-dialog {
    max-width: 400px;
    margin: 0 auto;
}

.dialog-header .avatar {
    margin: 0 auto;
}

.refund-amount-card {
    background: rgba(var(--tblr-success-rgb), 0.1);
    border: 1px solid rgba(var(--tblr-success-rgb), 0.3);
    border-radius: 12px;
    padding: 1.25rem;
}

.refund-icon {
    font-size: 1.5rem;
    color: var(--tblr-secondary);
}
```
  </action>
  <verify>`dotnet build src/MotoRent.Client` compiles without errors</verify>
  <done>OverpaymentRefundDialog created with payment breakdown and refund amount display</done>
</task>

<task type="auto">
  <name>Task 4: Wire overpayment refund to Till.razor</name>
  <files>src/MotoRent.Client/Pages/Staff/Till.razor</files>
  <action>
Add overpayment refund action to Till.razor. Per CONTEXT.md: "Refunds initiated from original transaction".

**IMPORTANT:**
- Use `DialogService.Create<T>().WithParameter().ShowDialogAsync()` pattern
- Use `m_session.GetCurrencyBalance(SupportedCurrencies.THB)` for THB balance (method exists on TillSession)
- Use `result.Success` (not `result.Succeeded`)
- `OriginalPaymentIds` is `List<string>?` to match ReceiptPayment.PaymentId type

**Add method to Till.razor @code section:**
```csharp
/// <summary>
/// Initiates overpayment refund workflow.
/// Called when staff identifies an overpayment on a transaction.
/// </summary>
private async Task InitiateOverpaymentRefundAsync(TillTransaction txn)
{
    if (m_session == null || m_session.Status != TillSessionStatus.Open)
    {
        ShowError(Localizer["SessionNotOpen"]);
        return;
    }

    // Get payment details for the transaction
    // This would typically load from Payment or Receipt records
    var totalPaid = txn.AmountInBaseCurrency;
    var amountDue = 0m; // Would come from rental/receipt

    // For demonstration, show dialog with transaction info
    // In real implementation, load actual payment breakdown from Receipt/Payment records
    var payments = new List<ReceiptPayment>
    {
        new ReceiptPayment
        {
            Method = GetPaymentMethodFromType(txn.TransactionType),
            Amount = txn.Amount,
            Currency = txn.Currency,
            ExchangeRate = txn.ExchangeRate,
            AmountInBaseCurrency = txn.AmountInBaseCurrency
        }
    };

    // Use GetCurrencyBalance method which exists on TillSession
    var thbBalance = m_session.GetCurrencyBalance(SupportedCurrencies.THB);

    var refundResult = await this.DialogService.Create<OverpaymentRefundDialog>(Localizer["OverpaymentRefund"])
        .WithParameter(x => x.OriginalPayments, payments)
        .WithParameter(x => x.TotalPaidThb, totalPaid)
        .WithParameter(x => x.AmountDueThb, amountDue)
        .WithParameter(x => x.RentalId, txn.RentalId)
        .WithParameter(x => x.TillThbBalance, thbBalance)
        .ShowDialogAsync();

    if (refundResult == null) return; // Canceled

    var refundData = refundResult as OverpaymentRefundResult;
    if (refundData == null || refundData.RefundAmountThb <= 0) return;

    // Execute the refund
    await ExecuteOverpaymentRefundAsync(refundData);
}

/// <summary>
/// Executes the overpayment refund.
/// </summary>
private async Task ExecuteOverpaymentRefundAsync(OverpaymentRefundResult refundData)
{
    m_loading = true;
    StateHasChanged();

    try
    {
        var result = await TillService.RecordOverpaymentRefundAsync(
            m_session!.TillSessionId,
            refundData.RefundAmountThb,
            refundData.Reason,
            refundData.OriginalPaymentIds, // List<string>? matches TillService signature
            refundData.RentalId,
            UserName);

        if (result.Success)
        {
            ShowSuccess(Localizer["RefundRecorded", FormatThb(refundData.RefundAmountThb)]);
            await LoadDataAsync();
        }
        else
        {
            ShowError(result.Errors.FirstOrDefault()?.Message ?? Localizer["RefundFailed"]);
        }
    }
    finally
    {
        m_loading = false;
        StateHasChanged();
    }
}

private static string GetPaymentMethodFromType(TillTransactionType type) => type switch
{
    TillTransactionType.RentalPayment => "Cash",
    TillTransactionType.CardPayment => "Card",
    TillTransactionType.PromptPay => "PromptPay",
    TillTransactionType.BankTransfer => "BankTransfer",
    _ => "Cash"
};

private static string FormatThb(decimal amount) => $"\u0e3f{amount:N0}";
```

**Add refund button to transaction list (in same row as void button):**
```razor
@* In transaction row actions column *@
@if (CanInitiateRefund(txn) && IsSessionOpen)
{
    <button type="button"
            class="btn btn-sm btn-ghost-success"
            @onclick="() => InitiateOverpaymentRefundAsync(txn)"
            title="@Localizer["OverpaymentRefund"]">
        <i class="ti ti-cash-off"></i>
    </button>
}
```

**Add helper method:**
```csharp
/// <summary>
/// Checks if a refund can be initiated for this transaction.
/// Typically RentalPayment or similar IN transactions.
/// </summary>
private bool CanInitiateRefund(TillTransaction txn)
{
    if (txn.IsVoided) return false;
    if (txn.Direction != TillTransactionDirection.In) return false;
    // Only allow refund on payment-type transactions
    return txn.TransactionType is TillTransactionType.RentalPayment
                               or TillTransactionType.BookingDeposit
                               or TillTransactionType.SecurityDeposit;
}
```
  </action>
  <verify>Build succeeds: `dotnet build src/MotoRent.Client`</verify>
  <done>Overpayment refund wired to Till.razor with dialog and service call</done>
</task>

<task type="auto">
  <name>Task 5: Add localization keys for void and refund workflows</name>
  <files>
    src/MotoRent.Client/Resources/Pages/Staff/Till.resx
    src/MotoRent.Client/Resources/Pages/Staff/Till.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/Till.th.resx
    src/MotoRent.Client/Resources/Components/Till/OverpaymentRefundDialog.resx
    src/MotoRent.Client/Resources/Components/Till/OverpaymentRefundDialog.en.resx
    src/MotoRent.Client/Resources/Components/Till/OverpaymentRefundDialog.th.resx
  </files>
  <action>
**Add to Till.resx files (English):**
```
VoidTransaction = Void Transaction
ViewVoidDetails = View Void Details
ManagerApproval = Manager Approval
TransactionVoided = Transaction voided successfully
VoidFailed = Failed to void transaction
VoidedBy = Voided by
ApprovedBy = Approved by
Reason = Reason
VoidedAt = Voided at
OverpaymentRefund = Overpayment Refund
RefundRecorded = Refund of {0} recorded successfully
RefundFailed = Failed to record refund
SessionNotOpen = Session is not open
```

**Thai translations for Till.th.resx:**
```
VoidTransaction = ยกเลิกรายการ
ViewVoidDetails = ดูรายละเอียดการยกเลิก
ManagerApproval = การอนุมัติจากผู้จัดการ
TransactionVoided = ยกเลิกรายการสำเร็จ
VoidFailed = ไม่สามารถยกเลิกรายการได้
VoidedBy = ยกเลิกโดย
ApprovedBy = อนุมัติโดย
Reason = เหตุผล
VoidedAt = ยกเลิกเมื่อ
OverpaymentRefund = คืนเงินจ่ายเกิน
RefundRecorded = บันทึกการคืนเงิน {0} สำเร็จ
RefundFailed = ไม่สามารถบันทึกการคืนเงินได้
SessionNotOpen = เซสชันยังไม่เปิด
```

**Create OverpaymentRefundDialog.resx (English):**
```xml
<?xml version="1.0" encoding="utf-8"?>
<root>
  <resheader name="resmimetype"><value>text/microsoft-resx</value></resheader>
  <resheader name="version"><value>1.3</value></resheader>
  <resheader name="reader"><value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value></resheader>
  <resheader name="writer"><value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value></resheader>
  <data name="OverpaymentRefund" xml:space="preserve"><value>Overpayment Refund</value></data>
  <data name="RefundExcessPayment" xml:space="preserve"><value>Refund the excess payment to the customer</value></data>
  <data name="OriginalPayment" xml:space="preserve"><value>Original Payment</value></data>
  <data name="TotalPaid" xml:space="preserve"><value>Total Paid</value></data>
  <data name="AmountDue" xml:space="preserve"><value>Amount Due</value></data>
  <data name="NoPaymentData" xml:space="preserve"><value>No payment data available</value></data>
  <data name="OverpaymentAmount" xml:space="preserve"><value>Overpayment</value></data>
  <data name="RefundInCash" xml:space="preserve"><value>Refund in Cash</value></data>
  <data name="RefundReason" xml:space="preserve"><value>Reason for Refund</value></data>
  <data name="EnterRefundReason" xml:space="preserve"><value>Enter reason for refund...</value></data>
  <data name="ReasonRequired" xml:space="preserve"><value>Please enter a reason</value></data>
  <data name="ReasonTooShort" xml:space="preserve"><value>Reason must be at least 5 characters</value></data>
  <data name="TillBalanceWarning" xml:space="preserve"><value>Warning: Till THB balance ({0}) may not cover this refund</value></data>
  <data name="Cancel" xml:space="preserve"><value>Cancel</value></data>
  <data name="IssueRefund" xml:space="preserve"><value>Issue Refund</value></data>
</root>
```

**Create OverpaymentRefundDialog.th.resx (Thai):**
```xml
<?xml version="1.0" encoding="utf-8"?>
<root>
  <resheader name="resmimetype"><value>text/microsoft-resx</value></resheader>
  <resheader name="version"><value>1.3</value></resheader>
  <resheader name="reader"><value>System.Resources.ResXResourceReader, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value></resheader>
  <resheader name="writer"><value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value></resheader>
  <data name="OverpaymentRefund" xml:space="preserve"><value>คืนเงินจ่ายเกิน</value></data>
  <data name="RefundExcessPayment" xml:space="preserve"><value>คืนเงินส่วนเกินให้ลูกค้า</value></data>
  <data name="OriginalPayment" xml:space="preserve"><value>การชำระเงินเดิม</value></data>
  <data name="TotalPaid" xml:space="preserve"><value>ยอดชำระทั้งหมด</value></data>
  <data name="AmountDue" xml:space="preserve"><value>ยอดที่ต้องชำระ</value></data>
  <data name="NoPaymentData" xml:space="preserve"><value>ไม่มีข้อมูลการชำระเงิน</value></data>
  <data name="OverpaymentAmount" xml:space="preserve"><value>ยอดจ่ายเกิน</value></data>
  <data name="RefundInCash" xml:space="preserve"><value>คืนเป็นเงินสด</value></data>
  <data name="RefundReason" xml:space="preserve"><value>เหตุผลในการคืนเงิน</value></data>
  <data name="EnterRefundReason" xml:space="preserve"><value>ใส่เหตุผลในการคืนเงิน...</value></data>
  <data name="ReasonRequired" xml:space="preserve"><value>กรุณาใส่เหตุผล</value></data>
  <data name="ReasonTooShort" xml:space="preserve"><value>เหตุผลต้องมีอย่างน้อย 5 ตัวอักษร</value></data>
  <data name="TillBalanceWarning" xml:space="preserve"><value>คำเตือน: ยอดเงินบาทในลิ้นชัก ({0}) อาจไม่เพียงพอสำหรับการคืนเงินนี้</value></data>
  <data name="Cancel" xml:space="preserve"><value>ยกเลิก</value></data>
  <data name="IssueRefund" xml:space="preserve"><value>คืนเงิน</value></data>
</root>
```

Read the existing Till.resx files first, then append new keys while preserving existing content.
  </action>
  <verify>All localization keys exist in resx files</verify>
  <done>Void and refund localization keys added</done>
</task>

</tasks>

<verification>
1. `dotnet build src/MotoRent.Client` - compiles without errors
2. Transaction list shows void button on eligible transactions
3. Voided transactions show strikethrough and VOID badge
4. Clicking void opens VoidTransactionDialog
5. After reason entry, ManagerPinDialog opens (and handles verification internally)
6. Successful void refreshes transaction list
7. Void details viewable for voided transactions
8. Overpayment refund button visible on payment transactions
9. OverpaymentRefundDialog shows payment breakdown and refund amount
10. Successful refund calls TillService.RecordOverpaymentRefundAsync
</verification>

<success_criteria>
- Void button visible on non-voided transactions
- Voided transactions display with strikethrough and badge
- Full void workflow works: initiate -> reason -> PIN -> execute
- ManagerPinDialog verifies PIN internally (no callback needed in Till.razor)
- Transaction list refreshes after void
- Overpayment refund dialog shows original payment breakdown
- Staff can initiate refund from payment transactions (REFUND-02)
- Localization for English and Thai
</success_criteria>

<output>
After completion, create `.planning/phases/05-refunds-corrections/05-05-SUMMARY.md`
</output>
