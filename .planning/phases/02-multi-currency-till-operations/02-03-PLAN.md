---
phase: 02-multi-currency-till-operations
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/MotoRent.Client/Components/Till/CurrencyBalancePanel.razor
  - src/MotoRent.Client/Pages/Staff/Till.razor
  - src/MotoRent.Client/Pages/Staff/TillCashDropDialog.razor
  - src/MotoRent.Client/Resources/Components/Till/CurrencyBalancePanel.resx
  - src/MotoRent.Client/Resources/Components/Till/CurrencyBalancePanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/CurrencyBalancePanel.th.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillCashDropDialog.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillCashDropDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillCashDropDialog.th.resx
autonomous: true

must_haves:
  truths:
    - "Staff can view current till balance per currency during shift"
    - "Balance panel is collapsible (collapsed shows THB total equivalent)"
    - "Expanded balance shows per-currency breakdown with THB equivalent"
    - "Staff can perform cash drop per currency"
    - "Drop validates against per-currency balance (cannot drop more than available)"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/CurrencyBalancePanel.razor"
      provides: "Collapsible currency balance display"
      contains: "CurrencyBalances"
    - path: "src/MotoRent.Client/Pages/Staff/Till.razor"
      provides: "Till page with balance panel integration"
      contains: "CurrencyBalancePanel"
    - path: "src/MotoRent.Client/Pages/Staff/TillCashDropDialog.razor"
      provides: "Multi-currency cash drop dialog"
      contains: "RecordMultiCurrencyDropAsync"
  key_links:
    - from: "src/MotoRent.Client/Pages/Staff/Till.razor"
      to: "src/MotoRent.Client/Components/Till/CurrencyBalancePanel.razor"
      via: "Component inclusion"
      pattern: "<CurrencyBalancePanel"
    - from: "src/MotoRent.Client/Pages/Staff/TillCashDropDialog.razor"
      to: "src/MotoRent.Services/TillService.cs"
      via: "RecordMultiCurrencyDropAsync call"
      pattern: "RecordMultiCurrencyDropAsync"
---

<objective>
Create currency balance display panel and update cash drop dialog for multi-currency operations.

Purpose: Enables TILL-04 (view balance per currency) and TILL-05 (cash drop per currency). Staff can see their drawer contents by currency and perform targeted drops.

Output: New CurrencyBalancePanel component integrated into Till.razor, updated TillCashDropDialog supporting multi-currency drops with denomination entry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-currency-till-operations/02-CONTEXT.md
@.planning/phases/02-multi-currency-till-operations/02-RESEARCH.md
@.planning/phases/02-multi-currency-till-operations/02-01-SUMMARY.md

Key existing files:
@src/MotoRent.Client/Pages/Staff/Till.razor
@src/MotoRent.Client/Pages/Staff/TillCashDropDialog.razor
@src/MotoRent.Domain/Entities/TillSession.cs (with CurrencyBalances from 02-01)
@src/MotoRent.Services/TillService.cs (RecordMultiCurrencyDropAsync from 02-01)
@src/MotoRent.Services/ExchangeRateService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CurrencyBalancePanel component</name>
  <files>
    src/MotoRent.Client/Components/Till/CurrencyBalancePanel.razor
    src/MotoRent.Client/Resources/Components/Till/CurrencyBalancePanel.resx
    src/MotoRent.Client/Resources/Components/Till/CurrencyBalancePanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/CurrencyBalancePanel.th.resx
  </files>
  <action>
    **Create CurrencyBalancePanel.razor:**
    A collapsible panel showing per-currency balances in the till.

    **Parameters:**
    - `CurrencyBalances` (Dictionary<string, decimal>) - balance per currency from TillSession
    - `OnRefresh` (EventCallback) - optional callback to refresh data

    **Inject:**
    - ExchangeRateService - for converting foreign currencies to THB equivalent

    **State:**
    - m_expanded (bool, default false) - collapsed by default per CONTEXT.md
    - m_thbEquivalents (Dictionary<string, decimal>) - cached THB equivalents

    **UI Structure - Collapsed:**
    ```
    ┌─────────────────────────────────────────────────┐
    │ Till Balance          ฿12,500  [THB total]   ▼ │
    └─────────────────────────────────────────────────┘
    ```

    **UI Structure - Expanded:**
    ```
    ┌─────────────────────────────────────────────────┐
    │ Till Balance                                 ▲ │
    ├─────────────────────────────────────────────────┤
    │ THB     ฿10,000                                │
    │ USD     $40.00        (~฿1,400)                │
    │ EUR     €25.00        (~฿970)                  │
    │ CNY     ¥100.00       (~฿500)                  │
    ├─────────────────────────────────────────────────┤
    │ Total THB Equivalent: ฿12,870                  │
    └─────────────────────────────────────────────────┘
    ```

    **Implementation:**
    1. OnInitializedAsync: Calculate THB equivalents for all non-THB currencies
    2. ToggleExpanded(): Toggle m_expanded, lazy-load equivalents if needed
    3. Only show currencies with balance > 0 (per CONTEXT.md)
    4. Calculate total THB equivalent: THB balance + sum of foreign equivalents
    5. Use CurrencyDenominations.GetCurrencySymbol for display

    **CSS classes:**
    - .mr-balance-panel - container
    - .mr-balance-header - clickable header with toggle
    - .mr-balance-details - expanded content
    - .mr-balance-row - individual currency row
    - .mr-balance-total - total row

    **Localization:**
    - TillBalance: "Till Balance" / "Till Balance" / "ยอดเงินในลิ้นชัก"
    - TotalThbEquivalent: "Total THB Equivalent" / "Total THB Equivalent" / "รวมเทียบเท่า THB"
    - Approximately: "~" (no translation needed)
  </action>
  <verify>
    - Component compiles
    - Renders collapsed with THB total
    - Click expands to show per-currency breakdown
    - Only non-zero balances shown
    - Foreign currencies show THB equivalent in parentheses
  </verify>
  <done>
    CurrencyBalancePanel component created with collapsible display, THB equivalents, and proper localization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate balance panel into Till.razor</name>
  <files>
    src/MotoRent.Client/Pages/Staff/Till.razor
  </files>
  <action>
    **Replace "CASH BALANCE HERO" section with CurrencyBalancePanel:**

    Current hero section shows only ExpectedCash (THB total). Replace with CurrencyBalancePanel:

    ```razor
    @* ========== CURRENCY BALANCE PANEL ========== *@
    <div class="mb-4">
        <CurrencyBalancePanel
            CurrencyBalances="@this.m_session.CurrencyBalances"
            OnRefresh="@this.LoadDataAsync" />
    </div>
    ```

    **Keep the quick stats cards below:**
    - Cash In / Cash Out cards remain (these show THB totals for reconciliation)
    - Non-cash payments summary remains

    **Update loading to refresh balance:**
    After any transaction (payment, drop), LoadDataAsync already reloads the session.
    Verify CurrencyBalances is populated after reload.

    **Pass CurrencyBalances to CashDropDialog:**
    Update CashDropDialog invocation to pass available balances per currency:
    ```razor
    var result = await this.DialogService.Create<TillCashDropDialog>("Cash Drop")
        .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
        .WithParameter(x => x.IsDrop, true)
        .WithParameter(x => x.CurrencyBalances, this.m_session.CurrencyBalances)
        .WithSize(ModalSize.Medium)  // Changed from Small to Medium for multi-currency
        .ShowDialogAsync();
    ```

    **Ensure m_session.CurrencyBalances exists:**
    For backward compatibility with existing sessions that don't have CurrencyBalances:
    - If CurrencyBalances is null or empty, initialize with { "THB": ExpectedCash }
  </action>
  <verify>
    - Till.razor compiles
    - CurrencyBalancePanel renders when session is active
    - Panel shows correct balances from session
    - Clicking expands/collapses panel
    - Balance updates after transactions
  </verify>
  <done>
    CurrencyBalancePanel integrated into Till.razor, replacing simple hero display with expandable per-currency view.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update TillCashDropDialog for multi-currency</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillCashDropDialog.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillCashDropDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillCashDropDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillCashDropDialog.th.resx
  </files>
  <action>
    **Update parameters:**
    - Remove: `AvailableCash` (decimal)
    - Add: `CurrencyBalances` (Dictionary<string, decimal>)

    **Add state for multi-currency drops:**
    - `m_dropAmounts` - Dictionary<string, Dictionary<decimal, int>> (currency -> denomination counts)
    - `m_currentCurrency` - which currency tab is active
    - Initialize m_dropAmounts for each currency with balance > 0

    **UI Structure:**
    ```
    ┌───────────────────────────────────────────────────┐
    │ Cash Drop to Safe                                 │
    ├───────────────────────────────────────────────────┤
    │ [THB] [USD] [EUR] [CNY]  ← Currency tabs          │
    │                          (only show if balance>0) │
    │                                                   │
    │ THB Available: ฿10,000                            │
    │ ┌───────────────────────────────────────────────┐ │
    │ │ ฿1000  [  2  ] = ฿2,000                       │ │
    │ │ ฿500   [  4  ] = ฿2,000                       │ │
    │ │ ฿100   [  0  ] = ฿0                           │ │
    │ │ ...                                           │ │
    │ │ Total to drop: ฿4,000                         │ │
    │ └───────────────────────────────────────────────┘ │
    │                                                   │
    │ Optional notes: [________________]                │
    │                                                   │
    │ Summary (all currencies):                         │
    │ THB: ฿4,000 | USD: $0 | EUR: €0 | CNY: ¥0        │
    ├───────────────────────────────────────────────────┤
    │ [Cancel]                       [Drop Cash]        │
    └───────────────────────────────────────────────────┘
    ```

    **Implementation:**
    1. Show currency tabs only for currencies with balance > 0
    2. Use DenominationEntryPanel for each currency (reuse from 02-02)
    3. Calculate total per currency from denomination counts
    4. Validate: drop amount <= available balance for each currency
    5. On save: Build List<CurrencyDropAmount> from all non-zero drops
    6. Call TillService.RecordMultiCurrencyDropAsync

    **Validation:**
    - For each currency: total drop cannot exceed CurrencyBalances[currency]
    - Show error message if exceeded: "Cannot drop more {currency} than available"
    - At least one currency must have drop amount > 0

    **SaveAsync update:**
    ```csharp
    var drops = new List<CurrencyDropAmount>();
    foreach (var (currency, denomCounts) in m_dropAmounts)
    {
        var total = denomCounts.Sum(kv => kv.Key * kv.Value);
        if (total > 0)
        {
            drops.Add(new CurrencyDropAmount { Currency = currency, Amount = total });
        }
    }

    if (drops.Count == 0)
    {
        ShowError(Localizer["EnterDropAmount"]);
        return;
    }

    var result = await TillService.RecordMultiCurrencyDropAsync(SessionId, drops, UserName, Notes);
    ```

    **Localization additions:**
    - Available: "Available" / "Available" / "คงเหลือ"
    - TotalToDrop: "Total to Drop" / "Total to Drop" / "รวมที่จะนำส่ง"
    - EnterDropAmount: "Enter amount to drop" / "Enter amount to drop" / "กรุณาระบุจำนวนเงินที่จะนำส่ง"
    - DropSummary: "Drop Summary" / "Drop Summary" / "สรุปการนำส่ง"
  </action>
  <verify>
    - Dialog compiles and opens
    - Currency tabs show for currencies with balance > 0
    - Denomination entry works for each currency
    - Validation prevents dropping more than available
    - Save creates correct CurrencyDropAmount list
    - RecordMultiCurrencyDropAsync called with correct data
    - Session CurrencyBalances updated after drop
  </verify>
  <done>
    TillCashDropDialog supports multi-currency drops with denomination entry, validation, and summary display.
  </done>
</task>

</tasks>

<verification>
1. CurrencyBalancePanel component renders correctly (collapsed/expanded states)
2. Till.razor displays CurrencyBalancePanel in place of simple hero
3. Balance panel shows correct per-currency amounts from session
4. TillCashDropDialog shows currency tabs for non-zero balances
5. Denomination entry works for each currency in drop dialog
6. Drop validation prevents exceeding available balance
7. Multi-currency drop saves correctly via RecordMultiCurrencyDropAsync
8. Session balances update after drop operation
9. Localization complete for en, th
</verification>

<success_criteria>
- Staff can see current till balance per currency (collapsible, defaults collapsed)
- Expanded view shows THB + foreign currencies with THB equivalents
- Only currencies with balance > 0 are shown
- Staff can drop any currency to safe
- Drop uses denomination entry (consistent with payment flow)
- Drop validates against per-currency balance
- TILL-04 and TILL-05 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-currency-till-operations/02-03-SUMMARY.md`
</output>
