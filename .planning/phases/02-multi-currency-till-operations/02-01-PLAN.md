---
phase: 02-multi-currency-till-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Entities/TillSession.cs
  - src/MotoRent.Domain/Entities/TillTransaction.cs
  - src/MotoRent.Domain/Entities/CurrencyDenominations.cs
  - src/MotoRent.Services/TillService.cs
autonomous: true

must_haves:
  truths:
    - "TillSession tracks balances per currency (THB, USD, EUR, CNY)"
    - "TillTransaction records currency, exchange rate, and THB equivalent"
    - "Foreign currency payments update both per-currency and THB totals"
    - "Multi-currency drops deduct from correct currency balances"
    - "Existing THB-only sessions continue to work"
  artifacts:
    - path: "src/MotoRent.Domain/Entities/TillSession.cs"
      provides: "Per-currency balance tracking"
      contains: "CurrencyBalances"
    - path: "src/MotoRent.Domain/Entities/TillTransaction.cs"
      provides: "Currency and exchange rate fields"
      contains: "AmountInBaseCurrency"
    - path: "src/MotoRent.Domain/Entities/CurrencyDenominations.cs"
      provides: "Denomination definitions per currency"
      contains: "GetDenominations"
    - path: "src/MotoRent.Services/TillService.cs"
      provides: "Multi-currency recording methods"
      contains: "RecordForeignCurrencyPaymentAsync"
  key_links:
    - from: "src/MotoRent.Services/TillService.cs"
      to: "src/MotoRent.Services/ExchangeRateService.cs"
      via: "ConvertToThbAsync call"
      pattern: "ConvertToThbAsync"
    - from: "src/MotoRent.Services/TillService.cs"
      to: "src/MotoRent.Domain/Entities/TillSession.cs"
      via: "CurrencyBalances update"
      pattern: "CurrencyBalances\\["
---

<objective>
Extend domain entities and TillService to support multi-currency tracking.

Purpose: Foundation layer that enables per-currency balance tracking and foreign currency transaction recording. All subsequent UI work depends on these extensions.

Output: Extended TillSession with CurrencyBalances, extended TillTransaction with currency fields, CurrencyDenominations helper class, and TillService methods for multi-currency operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-currency-till-operations/02-CONTEXT.md
@.planning/phases/02-multi-currency-till-operations/02-RESEARCH.md

Key existing files:
@src/MotoRent.Domain/Entities/TillSession.cs
@src/MotoRent.Domain/Entities/TillTransaction.cs
@src/MotoRent.Domain/Entities/ReceiptPayment.cs (contains SupportedCurrencies)
@src/MotoRent.Services/TillService.cs
@src/MotoRent.Services/ExchangeRateService.cs (provides ConvertToThbAsync)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend TillSession and TillTransaction entities</name>
  <files>
    src/MotoRent.Domain/Entities/TillSession.cs
    src/MotoRent.Domain/Entities/TillTransaction.cs
    src/MotoRent.Domain/Entities/CurrencyDenominations.cs
  </files>
  <action>
    **TillSession.cs - Add per-currency balance tracking:**
    1. Add `CurrencyBalances` property: `Dictionary<string, decimal>` initialized with THB = 0
    2. Add helper method `GetCurrencyBalance(string currency)` that returns balance or 0 if not tracked
    3. Keep existing ExpectedCash calculation unchanged (backward compatibility)
    4. Add XML documentation explaining CurrencyBalances tracks actual foreign currency amounts in drawer

    **TillTransaction.cs - Add currency and exchange rate fields:**
    1. Add `Currency` property (string, default = SupportedCurrencies.THB)
    2. Add `ExchangeRate` property (decimal, default = 1.0m)
    3. Add `AmountInBaseCurrency` property (decimal) - THB equivalent
    4. Add `ExchangeRateSource` property (string?, nullable)
    5. Add `ExchangeRateId` property (int?, nullable) - reference to ExchangeRate entity
    6. Add XML documentation noting defaults ensure backward compatibility

    **CurrencyDenominations.cs - Create new file:**
    1. Create static class `CurrencyDenominations` in MotoRent.Domain.Entities namespace
    2. Add `decimal[]` arrays for THB, USD, EUR, CNY denominations:
       - THB: [1000, 500, 100, 50, 20, 10, 5, 2, 1]
       - USD: [100, 50, 20, 10, 5, 1]
       - EUR: [500, 200, 100, 50, 20, 10, 5]
       - CNY: [100, 50, 20, 10, 5, 1]
    3. Add `GetDenominations(string currency)` method with switch expression
    4. Add `GetCurrencySymbol(string currency)` method returning appropriate symbols

    Use SupportedCurrencies constants from ReceiptPayment.cs.
  </action>
  <verify>
    - `dotnet build src/MotoRent.Domain` compiles without errors
    - TillSession has CurrencyBalances property
    - TillTransaction has Currency, ExchangeRate, AmountInBaseCurrency properties
    - CurrencyDenominations.GetDenominations("THB") returns 9 denominations
  </verify>
  <done>
    Entity classes extended with all multi-currency tracking fields. CurrencyDenominations helper created. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend TillService with multi-currency methods</name>
  <files>
    src/MotoRent.Services/TillService.cs
  </files>
  <action>
    **Add ExchangeRateService dependency:**
    1. Add ExchangeRateService as constructor parameter
    2. Store in private field `m_exchangeRateService`

    **Add RecordForeignCurrencyPaymentAsync method:**
    ```csharp
    public async Task<SubmitOperation> RecordForeignCurrencyPaymentAsync(
        int sessionId,
        TillTransactionType type,
        string currency,
        decimal foreignAmount,
        string description,
        string username,
        int? paymentId = null,
        int? depositId = null,
        int? rentalId = null,
        string? notes = null)
    ```
    Implementation:
    1. Load session, validate open status
    2. For THB: delegate to existing RecordCashInAsync
    3. For foreign: call `m_exchangeRateService.ConvertToThbAsync(currency, foreignAmount)`
    4. If conversion null, return failure "No exchange rate configured for {currency}"
    5. Create TillTransaction with:
       - Amount = foreignAmount
       - Currency = currency
       - ExchangeRate = conversion.RateUsed
       - AmountInBaseCurrency = conversion.ThbAmount
       - ExchangeRateSource = conversion.RateSource
       - ExchangeRateId = conversion.ExchangeRateId
    6. Update session totals:
       - TotalCashIn += conversion.ThbAmount (always THB for reconciliation)
       - CurrencyBalances[currency] += foreignAmount (track actual foreign currency)
       - Initialize currency key if not exists
    7. Attach both transaction and session, submit changes

    **Add CurrencyDropAmount class (DTO):**
    ```csharp
    public class CurrencyDropAmount
    {
        public string Currency { get; set; } = SupportedCurrencies.THB;
        public decimal Amount { get; set; }
    }
    ```

    **Add RecordMultiCurrencyDropAsync method:**
    ```csharp
    public async Task<SubmitOperation> RecordMultiCurrencyDropAsync(
        int sessionId,
        List<CurrencyDropAmount> drops,
        string username,
        string? notes = null)
    ```
    Implementation:
    1. Load session, validate open status
    2. For each drop with Amount > 0:
       a. Validate drop.Amount <= session.GetCurrencyBalance(drop.Currency)
       b. If insufficient, return failure "Insufficient {currency} balance"
       c. For non-THB: get conversion for THB equivalent
       d. Create TillTransaction with currency details
       e. Update session.CurrencyBalances[currency] -= drop.Amount
       f. Accumulate total THB dropped
    3. Update session.TotalDropped += totalThbDropped
    4. Attach all transactions and session, single SubmitChanges

    **Update OpenSessionAsync:**
    1. Initialize CurrencyBalances with THB = OpeningFloat
    2. Foreign currencies (USD, EUR, CNY) start at 0

    **Update existing RecordCashInAsync:**
    1. When recording cash transaction, update CurrencyBalances["THB"] += amount
    2. This ensures THB cash-in also tracks in CurrencyBalances for consistency
  </action>
  <verify>
    - `dotnet build src/MotoRent.Services` compiles without errors
    - TillService constructor accepts ExchangeRateService
    - RecordForeignCurrencyPaymentAsync method exists
    - RecordMultiCurrencyDropAsync method exists
  </verify>
  <done>
    TillService extended with multi-currency payment and drop methods. ExchangeRateService injected. All builds pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update DI registration and verify integration</name>
  <files>
    src/MotoRent.Server/Program.cs (or ServicesExtensions if exists)
  </files>
  <action>
    **Verify ExchangeRateService is registered:**
    Check that ExchangeRateService is registered in DI container (should be from Phase 1).

    **Verify TillService registration:**
    TillService needs ExchangeRateService injected. Confirm registration order allows this.

    **Create integration test scenario (manual verification):**
    Document a test scenario to verify end-to-end:
    1. Open till session with 5000 THB float
    2. Expected: CurrencyBalances = { "THB": 5000, ... }
    3. Record foreign currency payment (simulate)
    4. Expected: CurrencyBalances updated, TotalCashIn updated with THB equivalent

    **Build full solution:**
    Run `dotnet build` on the entire solution to ensure all projects compile together.
  </action>
  <verify>
    - `dotnet build` at solution root compiles without errors
    - No circular dependency issues
    - TillService can be resolved from DI container
  </verify>
  <done>
    Full solution builds. DI registration verified. Foundation layer ready for UI integration.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build` passes for entire solution
2. TillSession.CurrencyBalances exists and is Dictionary<string, decimal>
3. TillTransaction has Currency, ExchangeRate, AmountInBaseCurrency fields
4. CurrencyDenominations.GetDenominations returns correct arrays
5. TillService has RecordForeignCurrencyPaymentAsync and RecordMultiCurrencyDropAsync methods
6. Existing RecordCashInAsync still works (backward compatibility)
</verification>

<success_criteria>
- All entity extensions compile without errors
- TillService injects ExchangeRateService correctly
- New methods exist with proper signatures
- Existing functionality not broken (THB-only path still works)
- CurrencyDenominations provides denomination arrays for all 4 currencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-currency-till-operations/02-01-SUMMARY.md`
</output>
