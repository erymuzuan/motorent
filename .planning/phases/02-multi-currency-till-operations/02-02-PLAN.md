---
phase: 02-multi-currency-till-operations
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor
  - src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor
  - src/MotoRent.Client/Resources/Pages/Staff/TillReceivePaymentDialog.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillReceivePaymentDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillReceivePaymentDialog.th.resx
  - src/MotoRent.Client/Resources/Components/Till/DenominationEntryPanel.resx
  - src/MotoRent.Client/Resources/Components/Till/DenominationEntryPanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/DenominationEntryPanel.th.resx
autonomous: true

must_haves:
  truths:
    - "Staff can select currency before entering payment amount (THB, USD, EUR, CNY)"
    - "Staff enters payment by denomination count (not raw amount)"
    - "System shows full change breakdown for foreign currency payments"
    - "Exchange rate is displayed in change calculation"
    - "Payment is recorded with currency and rate information"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor"
      provides: "Multi-currency payment acceptance flow"
      contains: "CurrencyButtons"
    - path: "src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor"
      provides: "Reusable denomination input component"
      contains: "DenominationCounts"
  key_links:
    - from: "src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor"
      to: "src/MotoRent.Services/TillService.cs"
      via: "RecordForeignCurrencyPaymentAsync call"
      pattern: "RecordForeignCurrencyPaymentAsync"
    - from: "src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor"
      to: "src/MotoRent.Services/ExchangeRateService.cs"
      via: "ConvertToThbAsync for preview"
      pattern: "ConvertToThbAsync"
    - from: "src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor"
      to: "src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor"
      via: "Component usage"
      pattern: "<DenominationEntryPanel"
---

<objective>
Update payment dialog with currency selection, denomination entry, and change calculation display.

Purpose: Enables TILL-02 (receive payment in any currency) and TILL-03 (display THB change amount). Staff can accept foreign currency payments with a clear breakdown showing rate used and change to give.

Output: Updated TillReceivePaymentDialog with currency buttons and denomination entry, new reusable DenominationEntryPanel component, change calculation breakdown for foreign payments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-currency-till-operations/02-CONTEXT.md
@.planning/phases/02-multi-currency-till-operations/02-RESEARCH.md
@.planning/phases/02-multi-currency-till-operations/02-01-SUMMARY.md

Key existing files:
@src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor
@src/MotoRent.Domain/Entities/CurrencyDenominations.cs (from 02-01)
@src/MotoRent.Services/TillService.cs (RecordForeignCurrencyPaymentAsync from 02-01)
@src/MotoRent.Services/ExchangeRateService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable DenominationEntryPanel component</name>
  <files>
    src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor
    src/MotoRent.Client/Resources/Components/Till/DenominationEntryPanel.resx
    src/MotoRent.Client/Resources/Components/Till/DenominationEntryPanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/DenominationEntryPanel.th.resx
  </files>
  <action>
    **Create DenominationEntryPanel.razor:**
    A reusable component for entering amounts by denomination count.

    **Parameters:**
    - `Currency` (string) - which currency's denominations to show
    - `DenominationCounts` (Dictionary<decimal, int>) - two-way bound counts per denomination
    - `DenominationCountsChanged` (EventCallback) - for two-way binding
    - `Total` (decimal, out) - calculated total (read-only, computed from counts)
    - `Disabled` (bool) - disable all inputs
    - `ShowTotal` (bool, default true) - whether to show total row

    **UI Structure:**
    ```
    THB denominations (example):
    ┌─────────────────────────────────────┐
    │ ฿1000  [  2  ] = ฿2,000             │
    │ ฿500   [  3  ] = ฿1,500             │
    │ ฿100   [  5  ] = ฿500               │
    │ ...                                  │
    ├─────────────────────────────────────┤
    │ Total: ฿4,000                       │
    └─────────────────────────────────────┘
    ```

    **Implementation:**
    1. Use CurrencyDenominations.GetDenominations(Currency) for denomination values
    2. For each denomination:
       - Display denomination value with currency symbol
       - Number input for count (min 0, step 1)
       - Display subtotal (denomination * count)
    3. Calculate total on every input change (oninput event)
    4. Invoke DenominationCountsChanged when any count changes
    5. Get currency symbol from CurrencyDenominations.GetCurrencySymbol

    **Styling:**
    - Use .mr-denomination-panel class
    - Compact layout for mobile (denomination, input, subtotal inline)
    - Large touch targets for inputs (mobile-first)
    - Highlight non-zero rows slightly

    **Localization (resx files):**
    - Total: "Total" / "Total" / "รวม"
    - Count: "Count" / "Count" / "จำนวน"
  </action>
  <verify>
    - Component compiles
    - Renders denomination list for THB when Currency="THB"
    - Total updates when counts change
    - DenominationCountsChanged fires on input
  </verify>
  <done>
    DenominationEntryPanel component created with denomination inputs, auto-calculated total, and proper localization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TillReceivePaymentDialog for multi-currency</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillReceivePaymentDialog.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillReceivePaymentDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillReceivePaymentDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillReceivePaymentDialog.th.resx
  </files>
  <action>
    **Add service injection:**
    - Inject ExchangeRateService for conversion preview

    **Add currency selection UI (after rental selection, before amount):**
    ```razor
    @* Currency Selection - row of buttons *@
    <div class="mb-3">
        <label class="form-label">@Localizer["PaymentCurrency"]</label>
        <div class="d-flex gap-2 flex-wrap">
            @foreach (var currency in new[] { "THB", "USD", "EUR", "CNY" })
            {
                <button type="button"
                        class="btn @(m_selectedCurrency == currency ? "btn-primary" : "btn-outline-secondary")"
                        style="min-width: 70px;"
                        @onclick="@(() => SelectCurrency(currency))">
                    @currency
                </button>
            }
        </div>
    </div>
    ```

    **Replace simple amount input with DenominationEntryPanel:**
    - Only show when payment method is Cash
    - For non-cash payments (Card, PromptPay, BankTransfer), keep simple amount input but always THB
    - Add `m_denominationCounts` Dictionary<decimal, int> field
    - Add `m_receivedAmount` computed from denomination counts

    **Add change calculation display (for foreign currency cash payments):**
    When m_selectedCurrency != "THB" and amount > 0:
    1. Fetch conversion preview: `await ExchangeRateService.ConvertToThbAsync(currency, amount)`
    2. Calculate change: THB equivalent - amount due (from rental)
    3. Display breakdown:
    ```razor
    <div class="mr-change-breakdown mt-3 p-3 bg-light rounded">
        <div class="d-flex justify-content-between mb-2">
            <span>@Localizer["AmountReceived"]</span>
            <span>@m_receivedAmount.ToString("N2") @m_selectedCurrency</span>
        </div>
        <div class="d-flex justify-content-between mb-2 text-muted small">
            <span>@Localizer["ExchangeRate"]</span>
            <span>1 @m_selectedCurrency = @m_conversionRate.ToString("N2") THB</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <span>@Localizer["ThbEquivalent"]</span>
            <span>@m_thbEquivalent.ToString("N0") THB</span>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between fw-bold fs-5">
            <span>@Localizer["ChangeToGive"]</span>
            <span class="text-success">@m_changeAmount.ToString("N0") THB</span>
        </div>
    </div>
    ```

    **Update SaveAsync to use RecordForeignCurrencyPaymentAsync:**
    - For cash payments: call RecordForeignCurrencyPaymentAsync with currency and amount
    - For non-cash: continue using existing RecordCashInAsync (always THB)

    **Add fields:**
    - m_selectedCurrency (default "THB")
    - m_denominationCounts (Dictionary<decimal, int>)
    - m_conversionRate (decimal)
    - m_thbEquivalent (decimal)
    - m_changeAmount (decimal)

    **Add methods:**
    - SelectCurrency(string currency) - updates selected, clears denomination counts, recalculates
    - UpdateConversionPreview() - calls ExchangeRateService, updates preview fields
    - OnDenominationCountsChanged() - recalculates total and conversion preview

    **Localization additions:**
    - PaymentCurrency: "Payment Currency" / "Payment Currency" / "สกุลเงินที่รับ"
    - AmountReceived: "Amount Received" / "Amount Received" / "จำนวนเงินที่รับ"
    - ExchangeRate: "Exchange Rate" / "Exchange Rate" / "อัตราแลกเปลี่ยน"
    - ThbEquivalent: "THB Equivalent" / "THB Equivalent" / "เทียบเท่า THB"
    - ChangeToGive: "Change to Give" / "Change to Give" / "เงินทอน"
    - NoRateConfigured: "No exchange rate configured for {0}" / same / "ไม่มีอัตราแลกเปลี่ยนสำหรับ {0}"
  </action>
  <verify>
    - Dialog compiles and opens
    - Currency buttons render (THB selected by default)
    - Selecting USD shows USD denominations in entry panel
    - Entering denomination counts shows total
    - Change breakdown appears for foreign currency payments
    - Save calls RecordForeignCurrencyPaymentAsync for foreign currency
  </verify>
  <done>
    TillReceivePaymentDialog supports multi-currency cash payments with denomination entry and change calculation display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSS styles and verify flow</name>
  <files>
    src/MotoRent.Client/wwwroot/css/till.css (or equivalent)
  </files>
  <action>
    **Add CSS for denomination panel:**
    ```css
    .mr-denomination-panel {
        /* Container */
    }

    .mr-denomination-row {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--tblr-border-color);
    }

    .mr-denomination-row:last-child {
        border-bottom: none;
    }

    .mr-denomination-value {
        width: 80px;
        font-weight: 500;
    }

    .mr-denomination-input {
        width: 60px;
        text-align: center;
    }

    .mr-denomination-subtotal {
        margin-left: auto;
        color: var(--tblr-muted);
    }

    .mr-denomination-row.has-value .mr-denomination-subtotal {
        color: var(--tblr-body-color);
        font-weight: 500;
    }

    .mr-denomination-total {
        display: flex;
        justify-content: space-between;
        padding-top: 0.75rem;
        margin-top: 0.5rem;
        border-top: 2px solid var(--tblr-primary);
        font-weight: 600;
        font-size: 1.1rem;
    }

    .mr-change-breakdown {
        background: var(--tblr-bg-surface);
        border: 1px solid var(--tblr-border-color);
    }
    ```

    **Verify complete flow:**
    1. Open TillReceivePaymentDialog
    2. Search and select a rental
    3. Verify currency buttons appear (THB selected)
    4. Click USD button
    5. Verify denomination panel shows USD denominations
    6. Enter counts (e.g., 2x $20 = $40)
    7. Verify total shows 40.00 USD
    8. Verify change breakdown appears with rate and THB equivalent
    9. Save payment
    10. Verify transaction recorded with currency info
  </action>
  <verify>
    - CSS renders correctly
    - Full payment flow works end-to-end
    - Foreign currency payment shows change breakdown
    - Transaction saved with Currency, ExchangeRate, AmountInBaseCurrency populated
  </verify>
  <done>
    Payment dialog fully styled, integrated, and verified for multi-currency acceptance with denomination entry.
  </done>
</task>

</tasks>

<verification>
1. DenominationEntryPanel component exists and renders denominations for each currency
2. TillReceivePaymentDialog has currency selection buttons
3. Foreign currency selection shows correct denominations
4. Change calculation breakdown displays rate, equivalent, and change amount
5. Saving foreign currency payment calls RecordForeignCurrencyPaymentAsync
6. Transaction record includes Currency, ExchangeRate, AmountInBaseCurrency
7. Localization complete for en, th
</verification>

<success_criteria>
- Staff can select THB/USD/EUR/CNY before entering payment
- Denomination entry panel shows correct bills for selected currency
- Total auto-calculates from denomination counts
- Foreign currency payments show full change breakdown with exchange rate
- Payment saves with all currency audit fields populated
- TILL-02 and TILL-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-currency-till-operations/02-02-SUMMARY.md`
</output>
