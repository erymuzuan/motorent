---
phase: 01-exchange-rate-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/MotoRent.Client/Pages/Settings/ExchangeRateSettings.razor
  - src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.resx
  - src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.en.resx
  - src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.th.resx
  - src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.ms.resx
autonomous: true

must_haves:
  truths:
    - "Manager can view current exchange rates for THB, USD, EUR, CNY on settings page"
    - "Manager can override an API-fetched rate with a custom rate"
    - "Rate source indicator shows Manual vs API"
    - "Changes are saved and reflected immediately"
    - "Manager can attempt to refresh rates from API (shows appropriate message if not configured)"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Settings/ExchangeRateSettings.razor"
      provides: "Manager exchange rate management page with API refresh button"
      min_lines: 150
    - path: "src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.resx"
      provides: "Localization strings"
      contains: "ExchangeRates"
  key_links:
    - from: "src/MotoRent.Client/Pages/Settings/ExchangeRateSettings.razor"
      to: "ExchangeRateService"
      via: "@inject"
      pattern: "inject ExchangeRateService"
    - from: "ExchangeRateSettings.razor"
      to: "/api (SetRateAsync)"
      via: "method call"
      pattern: "SetRateAsync"
    - from: "ExchangeRateSettings.razor"
      to: "FetchRatesFromApiAsync"
      via: "method call"
      pattern: "FetchRatesFromApiAsync"
---

<objective>
Create the manager settings page for exchange rate configuration.

Purpose: RATE-01 (API refresh button - shows stub message), RATE-02 (manager override), RATE-03 (source tracking visible), RATE-05 (partial - manager can see rates). Manager needs a dedicated settings page to view current rates, see their source (Manual/API), and override rates when needed.

Output: ExchangeRateSettings.razor page with rate table, edit functionality, source indicators, and API refresh button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-exchange-rate-foundation/01-CONTEXT.md
@.planning/phases/01-exchange-rate-foundation/01-RESEARCH.md

# Prior plan summary for service API
@.planning/phases/01-exchange-rate-foundation/01-01-SUMMARY.md

# Existing patterns to follow
@src/MotoRent.Client/Pages/Settings/OrganizationSettings.razor
@src/MotoRent.Client/Controls/LocalizedComponentBase.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExchangeRateSettings page</name>
  <files>
    src/MotoRent.Client/Pages/Settings/ExchangeRateSettings.razor
  </files>
  <action>
    Create the manager settings page following OrganizationSettings.razor pattern:

    1. Page setup:
       - Route: `@page "/settings/exchange-rates"`
       - Authorization: `@attribute [Authorize(Roles = "OrgAdmin,ShopManager")]`
       - Inherit: `@inherits LocalizedComponentBase<ExchangeRateSettings>`
       - Inject: ExchangeRateService, IRequestContext (for username)

    2. Page structure:
       - MotoRentPageTitle with localized "ExchangeRates"
       - TablerHeader with title and action buttons area
       - LoadingSkeleton wrapping content

    3. Header action buttons (right side):
       - "Refresh from API" button (primary outline)
         - Calls FetchRatesFromApiAsync
         - Shows loading spinner while processing
         - Displays toast with result message (success or "not configured" stub message)
       - "Save" button if any rates have been modified

    4. Content layout (single card, no left panel navigation):
       - Card with header showing exchange rate icon and title
       - Table displaying rates for configured currencies (USD, EUR, CNY, GBP, JPY, AUD, RUB)
       - For THB, show "Base Currency" indicator (not editable)

    5. Rate table columns:
       - Currency (flag icon + code + name)
       - Buy Rate (editable input, decimal with 4 places)
       - Source (badge: Manual=blue, API=green, Adjusted=yellow)
       - Last Updated (formatted date)
       - Actions (Edit button)

    6. Edit functionality:
       - Inline editing OR edit dialog (simpler: inline)
       - When editing: input field for new rate
       - Save calls ExchangeRateService.SetRateAsync with source="Manual"
       - After save, reload rates and show success toast

    7. Code section fields:
       - `m_loading` (bool)
       - `m_saving` (bool)
       - `m_refreshingApi` (bool) - for API refresh button loading state
       - `m_rates` (List<ExchangeRate>)
       - `m_editingCurrency` (string?) - which currency is being edited
       - `m_editRate` (decimal) - the rate being edited

    8. Methods:
       - OnInitializedAsync: LoadRatesAsync()
       - LoadRatesAsync: Get all current rates, build display list
       - StartEdit(currency): Set m_editingCurrency, m_editRate
       - CancelEdit(): Clear m_editingCurrency
       - SaveRateAsync(): Call SetRateAsync, reload, show toast
       - RefreshFromApiAsync(): Call FetchRatesFromApiAsync, show result toast
         - The stub will return "Forex POS API integration not yet configured" message
         - Display this message in an info toast, not as an error
         - This satisfies RATE-01 coverage by providing the UI path for API refresh

    9. Currency display helper:
       - GetCurrencyName(code) -> "US Dollar", "Euro", "Chinese Yuan", etc.
       - GetCurrencyFlag(code) -> flag emoji or icon class

    Important: Show all supported currencies even if no rate is set (display "Not configured" with Add button).
  </action>
  <verify>
    - `dotnet build src/MotoRent.Client` compiles without errors
    - Page can be navigated to at /settings/exchange-rates
    - Table displays currency rows
    - Edit button enables inline editing
    - Save persists the rate
    - "Refresh from API" button calls service and shows toast message
  </verify>
  <done>
    ExchangeRateSettings.razor page exists with rate table, inline editing, source badges, save functionality, and API refresh button that shows appropriate message when API is not configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create localization resource files</name>
  <files>
    src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.resx
    src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.en.resx
    src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.th.resx
    src/MotoRent.Client/Resources/Pages/Settings/ExchangeRateSettings.ms.resx
  </files>
  <action>
    Create localization files following the project pattern:

    1. Create `ExchangeRateSettings.resx` (default/fallback):
       ```xml
       <!-- Standard resx header -->
       <data name="ExchangeRates" xml:space="preserve">
         <value>Exchange Rates</value>
       </data>
       <data name="ManageExchangeRates" xml:space="preserve">
         <value>Manage exchange rates for foreign currency payments</value>
       </data>
       <data name="Currency" xml:space="preserve">
         <value>Currency</value>
       </data>
       <data name="BuyRate" xml:space="preserve">
         <value>Buy Rate (THB)</value>
       </data>
       <data name="Source" xml:space="preserve">
         <value>Source</value>
       </data>
       <data name="LastUpdated" xml:space="preserve">
         <value>Last Updated</value>
       </data>
       <data name="Actions" xml:space="preserve">
         <value>Actions</value>
       </data>
       <data name="Edit" xml:space="preserve">
         <value>Edit</value>
       </data>
       <data name="Save" xml:space="preserve">
         <value>Save</value>
       </data>
       <data name="Cancel" xml:space="preserve">
         <value>Cancel</value>
       </data>
       <data name="NotConfigured" xml:space="preserve">
         <value>Not configured</value>
       </data>
       <data name="BaseCurrency" xml:space="preserve">
         <value>Base Currency</value>
       </data>
       <data name="Manual" xml:space="preserve">
         <value>Manual</value>
       </data>
       <data name="API" xml:space="preserve">
         <value>API</value>
       </data>
       <data name="Adjusted" xml:space="preserve">
         <value>Adjusted</value>
       </data>
       <data name="RateSaved" xml:space="preserve">
         <value>Exchange rate saved successfully</value>
       </data>
       <data name="RateHelpText" xml:space="preserve">
         <value>How many THB for 1 unit of this currency</value>
       </data>
       <data name="RefreshFromApi" xml:space="preserve">
         <value>Refresh from API</value>
       </data>
       <data name="RefreshingRates" xml:space="preserve">
         <value>Refreshing rates...</value>
       </data>
       <data name="ApiRefreshResult" xml:space="preserve">
         <value>API Refresh</value>
       </data>
       <data name="USDollar" xml:space="preserve">
         <value>US Dollar</value>
       </data>
       <data name="Euro" xml:space="preserve">
         <value>Euro</value>
       </data>
       <data name="BritishPound" xml:space="preserve">
         <value>British Pound</value>
       </data>
       <data name="ChineseYuan" xml:space="preserve">
         <value>Chinese Yuan</value>
       </data>
       <data name="JapaneseYen" xml:space="preserve">
         <value>Japanese Yen</value>
       </data>
       <data name="AustralianDollar" xml:space="preserve">
         <value>Australian Dollar</value>
       </data>
       <data name="RussianRuble" xml:space="preserve">
         <value>Russian Ruble</value>
       </data>
       <data name="ThailandBaseCurrency" xml:space="preserve">
         <value>Base currency - all rates are relative to THB</value>
       </data>
       ```

    2. Create `ExchangeRateSettings.en.resx` - copy from default (English is the source)

    3. Create `ExchangeRateSettings.th.resx` - Thai translations:
       - ExchangeRates: อัตราแลกเปลี่ยน
       - ManageExchangeRates: จัดการอัตราแลกเปลี่ยนสำหรับการชำระเงินสกุลต่างประเทศ
       - Currency: สกุลเงิน
       - BuyRate: อัตราซื้อ (บาท)
       - Source: แหล่งที่มา
       - LastUpdated: อัปเดตล่าสุด
       - NotConfigured: ยังไม่ได้กำหนด
       - BaseCurrency: สกุลเงินหลัก
       - Manual: กำหนดเอง
       - RateSaved: บันทึกอัตราแลกเปลี่ยนเรียบร้อยแล้ว
       - RateHelpText: จำนวนบาทต่อ 1 หน่วยสกุลเงินนี้
       - RefreshFromApi: รีเฟรชจาก API
       - RefreshingRates: กำลังรีเฟรชอัตรา...
       - ApiRefreshResult: ผลการรีเฟรช API
       - USDollar: ดอลลาร์สหรัฐ
       - Euro: ยูโร
       - BritishPound: ปอนด์อังกฤษ
       - ChineseYuan: หยวนจีน
       - JapaneseYen: เยนญี่ปุ่น
       - AustralianDollar: ดอลลาร์ออสเตรเลีย
       - RussianRuble: รูเบิลรัสเซีย
       - ThailandBaseCurrency: สกุลเงินหลัก - อัตราทั้งหมดเทียบกับบาท

    4. Create `ExchangeRateSettings.ms.resx` - Malay translations:
       - ExchangeRates: Kadar Pertukaran
       - ManageExchangeRates: Urus kadar pertukaran untuk pembayaran mata wang asing
       - Currency: Mata Wang
       - BuyRate: Kadar Beli (THB)
       - Source: Sumber
       - LastUpdated: Dikemas Kini
       - NotConfigured: Tidak dikonfigurasi
       - BaseCurrency: Mata Wang Asas
       - Manual: Manual
       - RateSaved: Kadar pertukaran berjaya disimpan
       - RateHelpText: Berapa THB untuk 1 unit mata wang ini
       - RefreshFromApi: Muat Semula dari API
       - RefreshingRates: Memuat semula kadar...
       - ApiRefreshResult: Keputusan Muat Semula API
       - USDollar: Dolar AS
       - Euro: Euro
       - BritishPound: Pound British
       - ChineseYuan: Yuan China
       - JapaneseYen: Yen Jepun
       - AustralianDollar: Dolar Australia
       - RussianRuble: Ruble Rusia
       - ThailandBaseCurrency: Mata wang asas - semua kadar adalah relatif kepada THB

    Use the standard resx XML format with proper headers (see existing resx files in the project).
  </action>
  <verify>
    - All four .resx files exist
    - Files have valid XML structure
    - `dotnet build src/MotoRent.Client` compiles without errors
    - Localizer keys match what's used in the razor file
    - RefreshFromApi and related API keys are present
  </verify>
  <done>
    Localization files created for default, English, Thai, and Malay with all required strings for ExchangeRateSettings page including API refresh functionality.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Navigate to /settings/exchange-rates as OrgAdmin or ShopManager
2. Page displays all supported currencies with rate table
3. THB shows as "Base Currency" (not editable)
4. Foreign currencies show current rate OR "Not configured"
5. Click Edit on a currency, change rate, click Save
6. Rate persists (reload page to verify)
7. Source badge shows "Manual" for manually set rates
8. Click "Refresh from API" button, see toast message about API not configured
9. All text is localized (switch language to verify)
</verification>

<success_criteria>
- [ ] `dotnet build` succeeds
- [ ] Page accessible at /settings/exchange-rates
- [ ] Table shows all 7 foreign currencies (USD, EUR, GBP, CNY, JPY, AUD, RUB)
- [ ] THB displayed as base currency (non-editable)
- [ ] Edit button enables inline rate editing
- [ ] Save persists rate via ExchangeRateService.SetRateAsync
- [ ] Source badge displays Manual/API/Adjusted
- [ ] Last Updated shows formatted date
- [ ] "Refresh from API" button calls FetchRatesFromApiAsync and shows result toast
- [ ] Localization files exist for en, th, ms with API refresh strings
</success_criteria>

<output>
After completion, create `.planning/phases/01-exchange-rate-foundation/01-02-SUMMARY.md`
</output>
