---
phase: 01-exchange-rate-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/MotoRent.Client/Components/Till/ExchangeRatePanel.razor
  - src/MotoRent.Client/Components/Till/ExchangeRatePanel.razor.css
  - src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.resx
  - src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.th.resx
  - src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.ms.resx
autonomous: true

must_haves:
  truths:
    - "Staff can see current exchange rates during payment acceptance"
    - "Panel shows buy rate for all configured currencies"
    - "Staff can use quick calculator to convert foreign amount to THB"
    - "Panel is accessible via floating button on till screen"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/ExchangeRatePanel.razor"
      provides: "Staff-facing exchange rate panel with calculator"
      min_lines: 100
    - path: "src/MotoRent.Client/Components/Till/ExchangeRatePanel.razor.css"
      provides: "Isolated styles for floating button and panel"
      contains: ".mr-rate-fab"
  key_links:
    - from: "ExchangeRatePanel.razor"
      to: "ExchangeRateService"
      via: "@inject"
      pattern: "inject ExchangeRateService"
---

<objective>
Create the staff-facing exchange rate panel component with quick calculator.

Purpose: RATE-05 (staff can view current rates during payment acceptance). Staff need quick access to current buy rates when tourists pay with foreign currency. The panel includes a calculator so staff can instantly see how much THB a foreign amount converts to.

Output: ExchangeRatePanel.razor component with floating button, slide-out panel, rate list, and quick calculator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-exchange-rate-foundation/01-CONTEXT.md
@.planning/phases/01-exchange-rate-foundation/01-RESEARCH.md

# Prior plan summary for service API
@.planning/phases/01-exchange-rate-foundation/01-01-SUMMARY.md

# Design decisions
# - Floating button always visible on till screen opens rate panel
# - Panel shows on-demand AND automatically during payment acceptance
# - Display buy rate only (shop buys foreign currency from tourists)
# - Include quick calculator — staff enters amount, sees THB conversion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExchangeRatePanel component</name>
  <files>
    src/MotoRent.Client/Components/Till/ExchangeRatePanel.razor
  </files>
  <action>
    Create the staff-facing exchange rate panel component:

    1. Component setup:
       - Namespace: MotoRent.Client.Components.Till (create directory if needed)
       - Inherit: `@inherits LocalizedComponentBase<ExchangeRatePanel>`
       - Inject: ExchangeRateService

    2. Parameters:
       - `[Parameter] public bool ShowButton { get; set; } = true` - whether to show floating button
       - `[Parameter] public bool IsOpen { get; set; }` - external control of panel state
       - `[Parameter] public EventCallback<bool> IsOpenChanged { get; set; }` - two-way binding
       - `[Parameter] public EventCallback<(string Currency, decimal Amount, decimal ThbAmount)> OnConversion { get; set; }` - callback when conversion calculated

    3. Floating Action Button (FAB):
       - Fixed position bottom-right (configurable via CSS)
       - Currency exchange icon (ti-arrows-exchange or similar)
       - On click: toggle panel visibility
       - Badge showing number of configured rates (optional)

    4. Slide-out Panel:
       - Slides in from right side
       - Semi-transparent backdrop (optional, can be dismissed by clicking outside)
       - Header with title "Exchange Rates" and close button
       - Body with rate list and calculator

    5. Rate List section:
       - Load rates on panel open (or on component init)
       - Display each configured currency:
         - Currency code and name (e.g., "USD - US Dollar")
         - Buy rate (e.g., "35.50 THB")
         - Source indicator (small badge or icon)
       - If no rates configured, show helpful message

    6. Quick Calculator section:
       - Currency dropdown (only currencies with configured rates)
       - Amount input (numeric, foreign currency amount)
       - Calculate button OR auto-calculate on input change
       - Result display: "100 USD = 3,550 THB" (large, prominent)
       - Use the button callback: can optionally notify parent of conversion

    7. Code section:
       ```csharp
       private bool m_panelOpen;
       private List<ExchangeRate> m_rates = [];
       private bool m_loading;

       // Calculator state
       private string m_calcCurrency = SupportedCurrencies.USD;
       private decimal m_calcAmount;
       private decimal m_calcResult;

       private bool PanelOpen
       {
           get => IsOpen || m_panelOpen;
           set
           {
               m_panelOpen = value;
               IsOpenChanged.InvokeAsync(value);
           }
       }

       protected override async Task OnInitializedAsync()
       {
           await LoadRatesAsync();
       }

       private async Task LoadRatesAsync()
       {
           m_loading = true;
           m_rates = await ExchangeRateService.GetAllCurrentRatesAsync();
           m_loading = false;
       }

       private void TogglePanel() => PanelOpen = !PanelOpen;

       private async Task CalculateAsync()
       {
           var result = await ExchangeRateService.ConvertToThbAsync(m_calcCurrency, m_calcAmount);
           if (result.HasValue)
           {
               m_calcResult = result.Value.ThbAmount;
               await OnConversion.InvokeAsync((m_calcCurrency, m_calcAmount, m_calcResult));
           }
       }

       private decimal GetRate(string currency)
       {
           return m_rates.FirstOrDefault(r => r.Currency == currency)?.BuyRate ?? 0;
       }
       ```

    8. Accessibility:
       - FAB has aria-label
       - Panel has proper role and aria attributes
       - Close button is keyboard accessible
  </action>
  <verify>
    - `dotnet build src/MotoRent.Client` compiles without errors
    - Component renders without runtime errors
    - FAB appears when ShowButton=true
    - Panel opens/closes on button click
    - Rate list displays configured rates
    - Calculator computes THB amount correctly
  </verify>
  <done>
    ExchangeRatePanel.razor component exists with floating button, slide-out panel, rate list, and quick calculator functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create component CSS and localization files</name>
  <files>
    src/MotoRent.Client/Components/Till/ExchangeRatePanel.razor.css
    src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.resx
    src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.th.resx
    src/MotoRent.Client/Resources/Components/Till/ExchangeRatePanel.ms.resx
  </files>
  <action>
    1. Create `ExchangeRatePanel.razor.css` (CSS isolation):
       ```css
       /* Floating Action Button */
       .mr-rate-fab {
           position: fixed;
           bottom: 24px;
           right: 24px;
           width: 56px;
           height: 56px;
           border-radius: 50%;
           background-color: var(--tblr-primary);
           color: white;
           border: none;
           box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
           cursor: pointer;
           display: flex;
           align-items: center;
           justify-content: center;
           font-size: 24px;
           z-index: 1000;
           transition: transform 0.2s, box-shadow 0.2s;
       }

       .mr-rate-fab:hover {
           transform: scale(1.1);
           box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
       }

       .mr-rate-fab:active {
           transform: scale(0.95);
       }

       /* Panel Backdrop */
       .mr-rate-backdrop {
           position: fixed;
           inset: 0;
           background-color: rgba(0, 0, 0, 0.3);
           z-index: 1001;
       }

       /* Slide-out Panel */
       .mr-rate-panel {
           position: fixed;
           top: 0;
           right: 0;
           width: 360px;
           max-width: 90vw;
           height: 100vh;
           background-color: var(--tblr-card-bg, #fff);
           box-shadow: -4px 0 16px rgba(0, 0, 0, 0.15);
           z-index: 1002;
           display: flex;
           flex-direction: column;
           animation: slideIn 0.2s ease-out;
       }

       @keyframes slideIn {
           from {
               transform: translateX(100%);
           }
           to {
               transform: translateX(0);
           }
       }

       .mr-rate-panel-header {
           display: flex;
           align-items: center;
           justify-content: space-between;
           padding: 16px 20px;
           border-bottom: 1px solid var(--tblr-border-color);
       }

       .mr-rate-panel-header h4 {
           margin: 0;
           font-weight: 600;
       }

       .mr-rate-panel-body {
           flex: 1;
           overflow-y: auto;
           padding: 16px 20px;
       }

       /* Rate List */
       .mr-rate-list {
           list-style: none;
           padding: 0;
           margin: 0 0 24px 0;
       }

       .mr-rate-item {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 12px 0;
           border-bottom: 1px solid var(--tblr-border-color-translucent);
       }

       .mr-rate-item:last-child {
           border-bottom: none;
       }

       .mr-rate-currency {
           font-weight: 500;
       }

       .mr-rate-currency-name {
           font-size: 0.85em;
           color: var(--tblr-muted);
       }

       .mr-rate-value {
           font-size: 1.1em;
           font-weight: 600;
           font-variant-numeric: tabular-nums;
       }

       /* Calculator Section */
       .mr-calc-section {
           background-color: var(--tblr-bg-surface);
           border-radius: 8px;
           padding: 16px;
       }

       .mr-calc-section h5 {
           margin: 0 0 12px 0;
           font-size: 0.9em;
           text-transform: uppercase;
           letter-spacing: 0.5px;
           color: var(--tblr-muted);
       }

       .mr-calc-result {
           margin-top: 16px;
           padding: 16px;
           background-color: var(--tblr-success-lt);
           border-radius: 8px;
           text-align: center;
       }

       .mr-calc-result-amount {
           font-size: 1.5em;
           font-weight: 700;
           color: var(--tblr-success);
       }

       .mr-calc-result-label {
           font-size: 0.85em;
           color: var(--tblr-muted);
       }

       /* Mobile adjustments */
       @media (max-width: 576px) {
           .mr-rate-fab {
               bottom: 16px;
               right: 16px;
               width: 48px;
               height: 48px;
               font-size: 20px;
           }

           .mr-rate-panel {
               width: 100%;
           }
       }
       ```

    2. Create localization files:

       `ExchangeRatePanel.resx` (default):
       - ExchangeRates: Exchange Rates
       - QuickCalculator: Quick Calculator
       - Amount: Amount
       - Calculate: Calculate
       - ResultLabel: THB equivalent
       - NoRatesConfigured: No exchange rates configured
       - ContactManager: Contact your manager to set up rates
       - SelectCurrency: Select currency
       - EnterAmount: Enter amount
       - Close: Close

       `ExchangeRatePanel.en.resx` - same as default

       `ExchangeRatePanel.th.resx` - Thai:
       - ExchangeRates: อัตราแลกเปลี่ยน
       - QuickCalculator: เครื่องคิดเลข
       - Amount: จำนวนเงิน
       - Calculate: คำนวณ
       - ResultLabel: เทียบเท่าเป็นบาท
       - NoRatesConfigured: ยังไม่ได้กำหนดอัตราแลกเปลี่ยน
       - ContactManager: ติดต่อผู้จัดการเพื่อตั้งค่าอัตรา
       - SelectCurrency: เลือกสกุลเงิน
       - EnterAmount: ระบุจำนวนเงิน
       - Close: ปิด

       `ExchangeRatePanel.ms.resx` - Malay:
       - ExchangeRates: Kadar Pertukaran
       - QuickCalculator: Kalkulator Pantas
       - Amount: Jumlah
       - Calculate: Kira
       - ResultLabel: Setara THB
       - NoRatesConfigured: Tiada kadar pertukaran dikonfigurasi
       - ContactManager: Hubungi pengurus anda untuk menetapkan kadar
       - SelectCurrency: Pilih mata wang
       - EnterAmount: Masukkan jumlah
       - Close: Tutup

    Ensure Resources/Components/Till/ directory structure exists.
  </action>
  <verify>
    - CSS file exists with proper selectors
    - All four .resx files exist
    - Files have valid XML structure
    - `dotnet build src/MotoRent.Client` compiles without errors
  </verify>
  <done>
    Component CSS provides floating button and panel styling. Localization files support English, Thai, and Malay.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Add ExchangeRatePanel to a test page or existing till page
2. Floating button appears in bottom-right corner
3. Click button opens slide-out panel
4. Panel shows list of configured exchange rates
5. Calculator allows selecting currency, entering amount
6. Calculate shows THB equivalent
7. Panel closes when clicking backdrop or close button
8. Localization switches correctly when changing language
</verification>

<success_criteria>
- [ ] `dotnet build` succeeds
- [ ] ExchangeRatePanel.razor component exists
- [ ] Floating button displays with currency icon
- [ ] Panel slides in from right on button click
- [ ] Rate list shows all configured currencies with buy rates
- [ ] Quick calculator converts foreign amount to THB
- [ ] CSS provides proper styling for FAB, panel, animations
- [ ] Localization files exist for en, th, ms
- [ ] Component is reusable (can be dropped into any page)
</success_criteria>

<output>
After completion, create `.planning/phases/01-exchange-rate-foundation/01-03-SUMMARY.md`
</output>
