---
phase: 06-denomination-counting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Domain/Entities/TillDenominationCount.cs
  - database/Tables/MotoRent.TillDenominationCount.sql
  - src/MotoRent.Domain/Entities/TillSession.cs
  - src/MotoRent.Services/TillService.cs
  - src/MotoRent.Domain/DataContext/RentalDataContext.cs
autonomous: true

must_haves:
  truths:
    - "Denomination counts can be stored and retrieved for a till session"
    - "Opening and closing counts are differentiated by type"
    - "Each currency has its own denomination breakdown"
    - "Total is auto-calculated from denomination counts"
  artifacts:
    - path: "src/MotoRent.Domain/Entities/TillDenominationCount.cs"
      provides: "Entity for storing denomination breakdowns"
      exports: ["TillDenominationCount", "DenominationCountType", "CurrencyDenominationBreakdown"]
    - path: "database/Tables/MotoRent.TillDenominationCount.sql"
      provides: "SQL table for denomination counts"
      contains: "CREATE TABLE"
    - path: "src/MotoRent.Services/TillService.cs"
      provides: "Methods for saving/loading denomination counts"
      exports: ["SaveDenominationCountAsync", "GetDenominationCountAsync"]
  key_links:
    - from: "TillDenominationCount.TillSessionId"
      to: "TillSession.TillSessionId"
      via: "foreign key relationship"
    - from: "TillService.SaveDenominationCountAsync"
      to: "RentalDataContext"
      via: "repository pattern"
---

<objective>
Create the domain entity and data layer for storing denomination counts, extending the TillSession entity to support denomination-level granularity for opening float and closing count workflows.

Purpose: Enable per-denomination tracking for accurate cash reconciliation
Output: TillDenominationCount entity, SQL table, TillService extensions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-denomination-counting/06-CONTEXT.md
@src/MotoRent.Domain/Entities/TillSession.cs
@src/MotoRent.Domain/Entities/CurrencyDenominations.cs
@src/MotoRent.Services/TillService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TillDenominationCount Entity</name>
  <files>
    src/MotoRent.Domain/Entities/TillDenominationCount.cs
  </files>
  <action>
Create the TillDenominationCount entity with the following structure:

1. **DenominationCountType enum:**
   - `Opening` - For opening float denomination breakdown
   - `Closing` - For closing count denomination breakdown

2. **CurrencyDenominationBreakdown class:**
   - `Currency` (string) - Currency code (THB, USD, EUR, CNY)
   - `Denominations` (Dictionary&lt;decimal, int&gt;) - Key is denomination value, value is count
   - `Total` (decimal) - Computed from denominations (sum of key * value)
   - `ExpectedBalance` (decimal?) - Only for closing counts, the expected balance for comparison
   - `Variance` (decimal?) - Only for closing counts, calculated as Total - ExpectedBalance

3. **TillDenominationCount entity (inherits Entity):**
   - `TillDenominationCountId` (int) - Primary key
   - `TillSessionId` (int) - Foreign key to TillSession
   - `CountType` (DenominationCountType) - Opening or Closing
   - `CountedAt` (DateTimeOffset) - When the count was recorded
   - `CountedByUserName` (string) - Who performed the count
   - `Notes` (string?) - Optional notes
   - `CurrencyBreakdowns` (List&lt;CurrencyDenominationBreakdown&gt;) - One entry per currency counted
   - `TotalInThb` (decimal) - Grand total in THB (THB total + foreign converted at time of count)
   - `IsFinal` (bool) - Draft vs final status (drafts can be overwritten)

Implement GetId/SetId for repository pattern.
Follow existing Entity pattern from TillSession.cs.
  </action>
  <verify>
    Build succeeds: `dotnet build src/MotoRent.Domain`
  </verify>
  <done>
    TillDenominationCount entity with DenominationCountType enum and CurrencyDenominationBreakdown class exists and compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SQL Table Script</name>
  <files>
    database/Tables/MotoRent.TillDenominationCount.sql
  </files>
  <action>
Create SQL table script following existing patterns from database/Tables/:

```sql
CREATE TABLE [MotoRent].[TillDenominationCount]
(
    [TillDenominationCountId] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [TillSessionId] INT NOT NULL,
    [CountType] AS CAST(JSON_VALUE([Json], '$.CountType') AS NVARCHAR(20)),
    [CountedAt] AS CAST(JSON_VALUE([Json], '$.CountedAt') AS DATETIMEOFFSET),
    [CountedByUserName] AS CAST(JSON_VALUE([Json], '$.CountedByUserName') AS NVARCHAR(100)),
    [TotalInThb] AS CAST(JSON_VALUE([Json], '$.TotalInThb') AS MONEY),
    [IsFinal] AS CAST(JSON_VALUE([Json], '$.IsFinal') AS BIT),
    [Json] NVARCHAR(MAX) NOT NULL,
    [CreatedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [ChangedBy] VARCHAR(50) NOT NULL DEFAULT 'system',
    [CreatedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    [ChangedTimestamp] DATETIMEOFFSET NOT NULL DEFAULT SYSDATETIMEOFFSET(),
    CONSTRAINT FK_TillDenominationCount_TillSession
        FOREIGN KEY ([TillSessionId]) REFERENCES [MotoRent].[TillSession]([TillSessionId])
)

CREATE INDEX IDX_MotoRent_TillDenominationCount_Session
    ON [MotoRent].[TillDenominationCount]([TillSessionId], [CountType])
```

Note: CurrencyBreakdowns are stored in the Json column as a list.
  </action>
  <verify>
    SQL script file exists and follows table naming conventions
  </verify>
  <done>
    SQL table script created with proper indexes and foreign key constraint
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend TillService with Denomination Methods</name>
  <files>
    src/MotoRent.Services/TillService.cs
    src/MotoRent.Domain/DataContext/RentalDataContext.cs
  </files>
  <action>
Add repository registration for TillDenominationCount in RentalDataContext or appropriate DI setup.

Extend TillService with a new region `#region Denomination Count Operations`:

1. **SaveDenominationCountAsync:**
   ```csharp
   public async Task<SubmitOperation> SaveDenominationCountAsync(
       int tillSessionId,
       DenominationCountType countType,
       List<CurrencyDenominationBreakdown> breakdowns,
       string countedByUserName,
       bool isFinal = true,
       string? notes = null)
   ```
   - Validate session exists
   - For Opening type: validate session is Open
   - For Closing type: validate session is Open, populate ExpectedBalance and Variance for each currency
   - Check for existing draft count of same type - overwrite if exists
   - Calculate TotalInThb (THB amount + foreign converted using ExchangeRateService)
   - Create or update TillDenominationCount entity
   - Return SubmitOperation

2. **GetDenominationCountAsync:**
   ```csharp
   public async Task<TillDenominationCount?> GetDenominationCountAsync(
       int tillSessionId,
       DenominationCountType countType)
   ```
   - Query by sessionId and countType
   - Return the most recent (or final) count

3. **GetDenominationCountsAsync:**
   ```csharp
   public async Task<List<TillDenominationCount>> GetDenominationCountsAsync(int tillSessionId)
   ```
   - Return all counts for a session (for history view)

4. **Helper method GetExpectedBalanceForCurrency:**
   - For THB: use session.GetCurrencyBalance(THB)
   - For foreign: use session.GetCurrencyBalance(currency)

Use existing Context and ExchangeRateService patterns from the service.
  </action>
  <verify>
    Build succeeds: `dotnet build src/MotoRent.Services`
  </verify>
  <done>
    TillService has SaveDenominationCountAsync, GetDenominationCountAsync, GetDenominationCountsAsync methods
  </done>
</task>

</tasks>

<verification>
1. Build entire solution: `dotnet build`
2. TillDenominationCount entity compiles with all required properties
3. TillService has new denomination count methods
4. SQL script follows project conventions
</verification>

<success_criteria>
- TillDenominationCount entity exists with proper structure
- SQL table script created for database
- TillService extended with denomination count CRUD methods
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-denomination-counting/06-01-SUMMARY.md`
</output>
