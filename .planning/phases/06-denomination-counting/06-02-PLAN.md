---
phase: 06-denomination-counting
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor
  - src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor.css
  - src/MotoRent.Client/Pages/Staff/TillOpenSessionDialog.razor
  - src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.resx
  - src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.th.resx
  - src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.ms.resx
autonomous: true

must_haves:
  truths:
    - "Staff can enter opening float by denomination for THB"
    - "Staff can optionally add foreign currency denominations"
    - "Total auto-calculates from entered denominations"
    - "Sticky footer shows running total summary"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor"
      provides: "Vertical denomination entry panel for opening float"
      min_lines: 150
    - path: "src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor.css"
      provides: "CSS styling for vertical list layout"
    - path: "src/MotoRent.Client/Pages/Staff/TillOpenSessionDialog.razor"
      provides: "Updated dialog using OpeningFloatPanel"
      contains: "OpeningFloatPanel"
  key_links:
    - from: "TillOpenSessionDialog.razor"
      to: "OpeningFloatPanel"
      via: "Blazor component reference"
      pattern: "<OpeningFloatPanel"
    - from: "OpeningFloatPanel"
      to: "CurrencyDenominations"
      via: "denomination values"
      pattern: "CurrencyDenominations.GetDenominations"
---

<objective>
Create the OpeningFloatPanel component for denomination-based opening float entry, then update TillOpenSessionDialog to use it.

Purpose: Staff can enter opening float with denomination breakdown for accurate starting balance
Output: OpeningFloatPanel component, updated TillOpenSessionDialog
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-denomination-counting/06-CONTEXT.md
@.planning/phases/06-denomination-counting/06-01-SUMMARY.md
@src/MotoRent.Domain/Entities/CurrencyDenominations.cs
@src/MotoRent.Domain/Entities/TillDenominationCount.cs
@src/MotoRent.Client/Components/Till/DenominationEntryPanel.razor
@src/MotoRent.Client/Pages/Staff/TillOpenSessionDialog.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpeningFloatPanel Component</name>
  <files>
    src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor
    src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor.css
  </files>
  <action>
Create OpeningFloatPanel.razor - a vertical denomination entry panel for opening float.

**Component Requirements (from 06-CONTEXT.md):**
- Vertical list layout (single column, larger touch targets for sequential counting)
- THB required, foreign currencies hidden until added via "Add Currency" button
- Single scrollable form with currency sections
- Sticky footer with running total summary (THB + foreign THB equivalents)

**Component Structure:**

```razor
@inherits LocalizedComponentBase<OpeningFloatPanel>
@using MotoRent.Domain.Entities
@inject ExchangeRateService ExchangeRateService
```

**Parameters:**
- `OnBreakdownsChanged` (EventCallback&lt;List&lt;CurrencyDenominationBreakdown&gt;&gt;) - Callback when denominations change
- `Disabled` (bool) - Disable all inputs during save

**State:**
- `m_currencyBreakdowns` (Dictionary&lt;string, Dictionary&lt;decimal, int&gt;&gt;) - Currency -> denomination -> count
- `m_visibleCurrencies` (HashSet&lt;string&gt;) - THB always visible, others added on demand
- `m_exchangeRates` (Dictionary&lt;string, decimal&gt;) - Cached rates for foreign currencies

**Layout Structure:**
1. **THB Section (always visible):**
   - Section header with THB icon and currency name
   - Vertical list of denominations (1000, 500, 100, 50, 20, 10, 5, 2, 1)
   - Each row: denomination value | [-] count [+] | subtotal (denomination * count)
   - Section total at bottom

2. **Foreign Currency Sections (visible when added):**
   - Same structure as THB but with remove button in header
   - Section shows THB equivalent below total

3. **Add Currency Button (when foreign currencies available to add):**
   - Shows available currencies not yet added (USD, EUR, CNY)
   - Click reveals dropdown or immediately adds currency section

4. **Sticky Footer:**
   - Shows grand total breakdown: THB X + USD $Y (= THB Z) + EUR ...
   - Final total in THB prominently displayed
   - Updates in real-time as counts change

**Increment/Decrement Buttons:**
- Each denomination row has [-] [count input] [+] buttons
- Tap-friendly size (44px minimum)
- Count input is editable number field
- Minimum 0, no maximum

**Denomination Row (vertical list style):**
```html
<div class="mr-denom-row">
    <span class="mr-denom-value">฿1,000</span>
    <div class="mr-denom-counter">
        <button class="mr-denom-btn" @onclick="() => Decrement(currency, denom)">-</button>
        <input type="number" class="mr-denom-count" min="0" @bind="counts[denom]" />
        <button class="mr-denom-btn" @onclick="() => Increment(currency, denom)">+</button>
    </div>
    <span class="mr-denom-subtotal">฿5,000</span>
</div>
```

**CSS Requirements (OpeningFloatPanel.razor.css):**
- `.mr-opening-float-panel` - Main container with scrollable content
- `.mr-currency-section` - Section for each currency with header
- `.mr-denom-row` - Single denomination row with flex layout
- `.mr-denom-value` - Denomination label (left-aligned, 25% width)
- `.mr-denom-counter` - Counter controls group (center, 40% width)
- `.mr-denom-btn` - Increment/decrement buttons (44px min touch target)
- `.mr-denom-count` - Count input (60px width, centered)
- `.mr-denom-subtotal` - Row subtotal (right-aligned, 25% width, show only if > 0)
- `.mr-currency-total` - Section total row
- `.mr-sticky-footer` - Sticky positioning at bottom with grand total
- `.mr-add-currency-btn` - Button to add foreign currency

**Methods:**
- `GetTotal(string currency)` - Sum of all denomination counts for a currency
- `GetGrandTotalThb()` - THB total + sum of (foreign total * exchange rate)
- `BuildBreakdowns()` - Convert m_currencyBreakdowns to List&lt;CurrencyDenominationBreakdown&gt;
- `NotifyChanged()` - Call OnBreakdownsChanged with current breakdowns
- `AddCurrency(string currency)` - Add currency to visible list
- `RemoveCurrency(string currency)` - Remove currency from visible list (keep THB)
- `LoadExchangeRates()` - Fetch current rates on component init
  </action>
  <verify>
    Build succeeds: `dotnet build src/MotoRent.Client`
  </verify>
  <done>
    OpeningFloatPanel component with vertical denomination entry, add currency, and sticky footer exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TillOpenSessionDialog to Use Panel</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillOpenSessionDialog.razor
  </files>
  <action>
Update TillOpenSessionDialog.razor to use OpeningFloatPanel instead of simple amount input.

**Changes:**

1. **Add imports and inject:**
```razor
@using MotoRent.Client.Components.Till
```

2. **Replace simple opening float input with OpeningFloatPanel:**

Remove:
```razor
<div class="mb-3">
    <label class="form-label required">@Localizer["OpeningFloat"]</label>
    <div class="input-group input-group-lg">
        <span class="input-group-text">฿</span>
        <input type="number" class="form-control text-end" @bind="m_openingFloat" ... />
    </div>
    <small class="form-hint">@Localizer["CountAllCashHint"]</small>
</div>
```

Add:
```razor
<OpeningFloatPanel
    OnBreakdownsChanged="@OnBreakdownsChanged"
    Disabled="@m_saving" />
```

3. **Update state:**
- Remove `m_openingFloat` (decimal)
- Add `m_currencyBreakdowns` (List&lt;CurrencyDenominationBreakdown&gt;)
- Add computed `OpeningFloatThb` property that sums THB from breakdowns

4. **Add callback handler:**
```csharp
private void OnBreakdownsChanged(List<CurrencyDenominationBreakdown> breakdowns)
{
    m_currencyBreakdowns = breakdowns;
    StateHasChanged();
}

private decimal OpeningFloatThb => m_currencyBreakdowns
    .Where(b => b.Currency == SupportedCurrencies.THB)
    .Sum(b => b.Total);
```

5. **Update SaveAsync to save denomination count:**
- Call existing `TillService.OpenSessionAsync` with THB total (for backward compatibility)
- Additionally call `TillService.SaveDenominationCountAsync` with full breakdowns
- Use `DenominationCountType.Opening`

6. **Update validation:**
- Require THB total > 0 (from breakdowns)
- Show error if no THB denominations entered

7. **Update dialog height:**
- Dialog content should be scrollable
- Consider `ModalSize.Large` or custom height to accommodate vertical list
  </action>
  <verify>
    Build succeeds and dialog shows denomination panel instead of simple input
  </verify>
  <done>
    TillOpenSessionDialog uses OpeningFloatPanel, saves denomination breakdown on session open
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Localization Resources</name>
  <files>
    src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.resx
    src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.th.resx
    src/MotoRent.Client/Resources/Components/Till/OpeningFloatPanel.ms.resx
  </files>
  <action>
Create localization resource files for OpeningFloatPanel.

**Resource Keys:**

| Key | English | Thai | Malay |
|-----|---------|------|-------|
| ThailandBaht | Thailand Baht | บาทไทย | Baht Thailand |
| USDollar | US Dollar | ดอลลาร์สหรัฐ | Dolar AS |
| Euro | Euro | ยูโร | Euro |
| ChineseYuan | Chinese Yuan | หยวนจีน | Yuan Cina |
| Total | Total | รวม | Jumlah |
| GrandTotal | Grand Total | รวมทั้งหมด | Jumlah Besar |
| ThbEquivalent | THB Equivalent | เทียบเท่าบาท | Setara THB |
| AddCurrency | Add Currency | เพิ่มสกุลเงิน | Tambah Mata Wang |
| RemoveCurrency | Remove | ลบ | Buang |
| EnterCount | Enter count | ใส่จำนวน | Masukkan kiraan |
| NoForeignCurrency | No foreign currency added | ไม่มีสกุลเงินต่างประเทศ | Tiada mata wang asing |
| TapToAddCurrency | Tap to add foreign currency if needed | แตะเพื่อเพิ่มสกุลเงินต่างประเทศ | Ketik untuk tambah mata wang asing |

Follow existing .resx file format from other components.
Use XML structure with resheader elements and data elements.
  </action>
  <verify>
    Resource files exist with all required keys in all 4 languages
  </verify>
  <done>
    Localization complete for OpeningFloatPanel in English, Thai, and Malay
  </done>
</task>

</tasks>

<verification>
1. Build entire solution: `dotnet build`
2. Open session dialog shows denomination panel
3. THB section visible by default
4. Can add USD/EUR/CNY sections
5. Running total updates as counts change
6. Sticky footer shows grand total in THB
</verification>

<success_criteria>
- OpeningFloatPanel component renders vertical denomination list
- THB section always visible, foreign currencies can be added
- Totals auto-calculate from denomination counts
- TillOpenSessionDialog uses new panel and saves denomination breakdown
- Localization complete for EN/TH/MS
</success_criteria>

<output>
After completion, create `.planning/phases/06-denomination-counting/06-02-SUMMARY.md`
</output>
