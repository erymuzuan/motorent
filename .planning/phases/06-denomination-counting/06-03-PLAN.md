---
phase: 06-denomination-counting
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/MotoRent.Client/Components/Till/ClosingCountPanel.razor
  - src/MotoRent.Client/Components/Till/ClosingCountPanel.razor.css
  - src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor
  - src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.resx
  - src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.en.resx
  - src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.th.resx
  - src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.ms.resx
autonomous: true

must_haves:
  truths:
    - "Staff can enter closing count by denomination for THB"
    - "Expected balance is shown as reference for each currency"
    - "Variance is calculated inline per currency"
    - "Only currencies with expected balance > 0 are shown"
  artifacts:
    - path: "src/MotoRent.Client/Components/Till/ClosingCountPanel.razor"
      provides: "Vertical denomination entry panel for closing count with variance"
      min_lines: 200
    - path: "src/MotoRent.Client/Components/Till/ClosingCountPanel.razor.css"
      provides: "CSS styling for closing count with variance indicators"
    - path: "src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor"
      provides: "Updated dialog using ClosingCountPanel"
      contains: "ClosingCountPanel"
  key_links:
    - from: "TillCloseSessionDialog.razor"
      to: "ClosingCountPanel"
      via: "Blazor component reference"
      pattern: "<ClosingCountPanel"
    - from: "ClosingCountPanel"
      to: "TillSession.CurrencyBalances"
      via: "expected balance lookup"
---

<objective>
Create the ClosingCountPanel component for denomination-based closing count with expected vs actual comparison, then update TillCloseSessionDialog to use it.

Purpose: Staff can enter closing count with denomination breakdown and see variance per currency
Output: ClosingCountPanel component, updated TillCloseSessionDialog
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-denomination-counting/06-CONTEXT.md
@.planning/phases/06-denomination-counting/06-01-SUMMARY.md
@src/MotoRent.Domain/Entities/CurrencyDenominations.cs
@src/MotoRent.Domain/Entities/TillDenominationCount.cs
@src/MotoRent.Domain/Entities/TillSession.cs
@src/MotoRent.Client/Components/Till/OpeningFloatPanel.razor
@src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClosingCountPanel Component</name>
  <files>
    src/MotoRent.Client/Components/Till/ClosingCountPanel.razor
    src/MotoRent.Client/Components/Till/ClosingCountPanel.razor.css
  </files>
  <action>
Create ClosingCountPanel.razor - a vertical denomination entry panel for closing count with expected balance and variance display.

**Component Requirements (from 06-CONTEXT.md):**
- Vertical list layout matching OpeningFloatPanel
- THB required; foreign currencies shown only if expected balance > 0
- Show expected balance as reference per currency
- Inline variance display per currency (Expected X, Actual Y, Variance Z)
- Single scrollable form with currency sections
- Sticky footer with grand total and overall variance

**Parameters:**
- `ExpectedBalances` (Dictionary&lt;string, decimal&gt;) - Expected balance per currency from TillSession.CurrencyBalances
- `OnBreakdownsChanged` (EventCallback&lt;List&lt;CurrencyDenominationBreakdown&gt;&gt;) - Callback when denominations change
- `Disabled` (bool) - Disable all inputs during save

**State:**
- `m_currencyBreakdowns` (Dictionary&lt;string, Dictionary&lt;decimal, int&gt;&gt;) - Currency -> denomination -> count
- `m_visibleCurrencies` (List&lt;string&gt;) - Currencies with expected balance > 0 (auto-populated)

**Layout Structure:**

1. **Currency Section (for each currency with balance > 0):**
   ```html
   <div class="mr-currency-section">
       <div class="mr-currency-header">
           <span class="mr-currency-name">Thailand Baht</span>
           <span class="mr-expected-badge">Expected: ฿12,500</span>
       </div>

       <!-- Denomination rows -->
       <div class="mr-denom-row">...</div>

       <!-- Section summary -->
       <div class="mr-section-summary">
           <div class="mr-actual">Actual: ฿12,400</div>
           <div class="mr-variance mr-variance-short">Variance: -฿100</div>
       </div>
   </div>
   ```

2. **Denomination Row (same as OpeningFloatPanel):**
   - denomination value | [-] count [+] | subtotal

3. **Section Summary (per currency):**
   - Expected amount (from ExpectedBalances)
   - Actual amount (calculated from counts)
   - Variance (Actual - Expected)
   - Variance styling: green if 0, red if short, blue if over

4. **Sticky Footer:**
   - Overall variance summary
   - Total per currency with variance indicator
   - Grand total in THB
   - Variance acknowledgment message if any variance exists

**Variance Display Logic:**
```csharp
var variance = actualTotal - expectedBalance;
var varianceClass = variance switch
{
    0 => "mr-variance-balanced",
    > 0 => "mr-variance-over",
    < 0 => "mr-variance-short"
};
var varianceIcon = variance switch
{
    0 => "ti-check",
    > 0 => "ti-trending-up",
    < 0 => "ti-trending-down"
};
```

**CSS Requirements (ClosingCountPanel.razor.css):**
- Inherit/match OpeningFloatPanel styles for consistency
- `.mr-expected-badge` - Badge showing expected amount in section header
- `.mr-section-summary` - Summary row with expected/actual/variance
- `.mr-variance` - Base variance styling
- `.mr-variance-balanced` - Green text/icon for balanced
- `.mr-variance-short` - Red text/icon for shortage
- `.mr-variance-over` - Blue/warning text for overage
- `.mr-overall-variance` - Prominent variance display in footer

**Methods:**
- `GetTotal(string currency)` - Sum of denomination counts for currency
- `GetVariance(string currency)` - Actual - Expected for currency
- `GetOverallVarianceThb()` - Sum of all variances converted to THB
- `BuildBreakdowns()` - Convert to List&lt;CurrencyDenominationBreakdown&gt; with Expected and Variance populated
- `NotifyChanged()` - Call OnBreakdownsChanged

**Initialization:**
- On parameter set, determine which currencies to show based on ExpectedBalances > 0
- THB always shown even if 0 (staff must count THB)
- Foreign currencies only shown if ExpectedBalances[currency] > 0
  </action>
  <verify>
    Build succeeds: `dotnet build src/MotoRent.Client`
  </verify>
  <done>
    ClosingCountPanel component with expected/actual/variance display exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TillCloseSessionDialog to Use Panel</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillCloseSessionDialog.razor
  </files>
  <action>
Update TillCloseSessionDialog.razor to use ClosingCountPanel instead of simple amount input.

**Changes:**

1. **Add imports:**
```razor
@using MotoRent.Client.Components.Till
```

2. **Replace session summary and simple input with ClosingCountPanel:**

The existing dialog has:
- Session summary card (Opening, CashIn, CashOut)
- Expected vs Actual simple inputs
- Variance display
- Acknowledgment checkbox

Restructure to:
```razor
@* Session Summary (keep but simplify) *@
<div class="card bg-muted-lt mb-3">
    <div class="card-body py-2">
        <div class="row text-center small">
            <div class="col">Opening: @FormatCurrency(Entity.OpeningFloat)</div>
            <div class="col text-success">+@FormatCurrency(Entity.TotalCashIn)</div>
            <div class="col text-danger">-@FormatCurrency(Entity.TotalCashOut + Entity.TotalDropped)</div>
        </div>
    </div>
</div>

@* Denomination Count Panel *@
<ClosingCountPanel
    ExpectedBalances="@GetExpectedBalances()"
    OnBreakdownsChanged="@OnBreakdownsChanged"
    Disabled="@Saving" />
```

3. **Add helper method:**
```csharp
private Dictionary<string, decimal> GetExpectedBalances()
{
    // Use CurrencyBalances from session, which tracks expected per currency
    return Entity.CurrencyBalances ?? new Dictionary<string, decimal>
    {
        [SupportedCurrencies.THB] = Entity.ExpectedCash
    };
}
```

4. **Update state:**
- Keep `ActualCash` for backward compatibility (computed from breakdowns)
- Add `m_currencyBreakdowns` (List&lt;CurrencyDenominationBreakdown&gt;)
- Update `HasVariance` to check any currency has variance

5. **Add callback handler:**
```csharp
private void OnBreakdownsChanged(List<CurrencyDenominationBreakdown> breakdowns)
{
    m_currencyBreakdowns = breakdowns;
    // Update ActualCash for backward compatibility (THB total only)
    ActualCash = breakdowns
        .Where(b => b.Currency == SupportedCurrencies.THB)
        .Sum(b => b.Total);
    StateHasChanged();
}
```

6. **Update SaveAsync:**
- Call existing `TillService.CloseSessionAsync` with THB actual (for backward compatibility)
- Additionally call `TillService.SaveDenominationCountAsync` with full breakdowns
- Use `DenominationCountType.Closing`

7. **Update CanClose logic:**
- Require THB count entered (from breakdowns)
- Keep variance acknowledgment if any currency has variance

8. **Update dialog size:**
- Use `ModalSize.Large` or adjust for scrollable content
- Keep footer visible with close button

9. **Remove simplified variance display:**
- Panel handles per-currency variance display
- Footer in panel shows overall variance
- Keep acknowledgment checkbox for close validation
  </action>
  <verify>
    Build succeeds and dialog shows denomination panel with variance display
  </verify>
  <done>
    TillCloseSessionDialog uses ClosingCountPanel, shows expected vs actual per currency
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Localization Resources</name>
  <files>
    src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.resx
    src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.en.resx
    src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.th.resx
    src/MotoRent.Client/Resources/Components/Till/ClosingCountPanel.ms.resx
  </files>
  <action>
Create localization resource files for ClosingCountPanel.

**Resource Keys:**

| Key | English | Thai | Malay |
|-----|---------|------|-------|
| ThailandBaht | Thailand Baht | บาทไทย | Baht Thailand |
| USDollar | US Dollar | ดอลลาร์สหรัฐ | Dolar AS |
| Euro | Euro | ยูโร | Euro |
| ChineseYuan | Chinese Yuan | หยวนจีน | Yuan Cina |
| Expected | Expected | คาดว่า | Dijangka |
| Actual | Actual | จริง | Sebenar |
| Variance | Variance | ส่วนต่าง | Varians |
| Balanced | Balanced | ตรงกัน | Seimbang |
| Over | Over | เกิน | Lebih |
| Short | Short | ขาด | Kurang |
| Total | Total | รวม | Jumlah |
| GrandTotal | Grand Total | รวมทั้งหมด | Jumlah Besar |
| OverallVariance | Overall Variance | ส่วนต่างรวม | Varians Keseluruhan |
| NoForeignCurrency | No foreign currency in drawer | ไม่มีสกุลเงินต่างประเทศในลิ้นชัก | Tiada mata wang asing dalam laci |
| CountAllDenominations | Count all denominations carefully | นับธนบัตรและเหรียญทั้งหมดอย่างรอบคอบ | Kira semua denominasi dengan teliti |
| VarianceWarning | Please verify count if variance exists | กรุณาตรวจสอบการนับหากมีส่วนต่าง | Sila sahkan kiraan jika terdapat varians |

Follow existing .resx file format.
  </action>
  <verify>
    Resource files exist with all required keys in all 4 languages
  </verify>
  <done>
    Localization complete for ClosingCountPanel in English, Thai, and Malay
  </done>
</task>

</tasks>

<verification>
1. Build entire solution: `dotnet build`
2. Close session dialog shows denomination panel
3. Expected balance shown per currency
4. Variance calculated and displayed inline
5. Only currencies with balance > 0 shown (except THB always)
6. Overall variance in footer
</verification>

<success_criteria>
- ClosingCountPanel component renders with expected/actual/variance
- THB always shown, foreign currencies only if balance > 0
- Variance styling (green/red/blue) works correctly
- TillCloseSessionDialog uses new panel and saves denomination breakdown
- Localization complete for EN/TH/MS
</success_criteria>

<output>
After completion, create `.planning/phases/06-denomination-counting/06-03-SUMMARY.md`
</output>
