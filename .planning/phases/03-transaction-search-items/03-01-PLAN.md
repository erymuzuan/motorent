---
phase: 03-transaction-search-items
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  - src/MotoRent.Client/Pages/Staff/Till.razor
  - src/MotoRent.Domain/Entities/TillTransactionType.cs
  - src/MotoRent.Services/RentalService.cs
autonomous: true

must_haves:
  truths:
    - "Staff can click 'New Transaction' on till page"
    - "Staff can search for booking by reference number"
    - "Staff can search for booking by customer name or phone"
    - "Staff can search for active rental by renter name"
    - "System auto-detects transaction type from booking/rental status"
    - "Search results show both bookings and rentals grouped by type"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor"
      provides: "Transaction search and selection dialog"
      min_lines: 150
    - path: "src/MotoRent.Domain/Entities/TillTransactionType.cs"
      provides: "Transaction type enum with CheckIn value"
      contains: "CheckIn"
  key_links:
    - from: "src/MotoRent.Client/Pages/Staff/Till.razor"
      to: "TillTransactionDialog"
      via: "DialogService.Create<TillTransactionDialog>"
      pattern: "Create<TillTransactionDialog>"
    - from: "src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor"
      to: "BookingService"
      via: "inject and search"
      pattern: "BookingService"
---

<objective>
Create the transaction search dialog that enables staff to find a booking or rental before processing payment.

Purpose: Staff need a unified entry point to start any transaction (booking deposit, check-in, or check-out). The system should auto-detect the transaction type based on entity status, replacing the current separate buttons approach.

Output:
- TillTransactionDialog.razor with search-then-select UI
- "New Transaction" button on Till.razor replacing individual payment type buttons
- Rental search method added to RentalService
- TillTransactionType enum extended with CheckIn value
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transaction-search-items/03-CONTEXT.md
@.planning/phases/03-transaction-search-items/03-RESEARCH.md

# Key existing patterns
@src/MotoRent.Client/Pages/Staff/TillBookingDepositDialog.razor
@src/MotoRent.Client/Services/ModalFluent.cs
@src/MotoRent.Services/BookingService.cs
@src/MotoRent.Domain/Entities/Booking.cs
@src/MotoRent.Domain/Entities/Rental.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TillTransactionDialog with search functionality</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  </files>
  <action>
    Create TillTransactionDialog.razor following TillBookingDepositDialog.razor pattern:

    1. **Dialog structure:**
       - Inherit from `LocalizedDialogBase<object, TillTransactionDialog>` (returns selected booking/rental)
       - Inject BookingService, RentalService
       - Parameters: SessionId (int), ShopId (int)

    2. **Search UI (Step 1):**
       - Search input with Enter key support (copy pattern from TillBookingDepositDialog)
       - Search hint: "Enter booking ref, customer name, or phone number"
       - Loading spinner during search
       - Recent items list on initial load (last 7 days with balance due or active rentals)

    3. **Search results display:**
       - Group results into two sections: "Bookings" and "Active Rentals"
       - Each result shows: reference/ID, customer name, dates, amount/status
       - Bookings: show BookingRef, CustomerName, dates, BalanceDue
       - Rentals: show RentalId, RenterName, VehicleName, Status

    4. **Search logic:**
       - Search BookingService.GetBookingsAsync with searchTerm for customer name
       - Search BookingService.GetBookingByRefAsync for exact ref match (if 4-8 chars)
       - Search RentalService for active rentals by renter name (needs new method)
       - Combine results, show grouped

    5. **Selection handling:**
       - On booking select: detect type (Pending/Confirmed -> CheckIn, any with BalanceDue -> BookingDeposit)
       - On rental select: type is CheckOut (if Active)
       - Store selected entity and detected type in state
       - Close dialog with result containing {Entity, TransactionType}

    6. **State variables:**
       ```csharp
       private string m_searchTerm = "";
       private List<Booking> m_bookingResults = [];
       private List<Rental> m_rentalResults = [];
       private bool m_loading;
       private bool m_searching;
       private bool m_searched;
       ```

    7. **Localization entries (create all 3 resx files):**
       - SearchTransaction, SearchHint, Bookings, ActiveRentals
       - NoResultsFound, RecentTransactions, SelectToStart
       - BookingDeposit, CheckIn, CheckOut, Due, Active
  </action>
  <verify>
    - File exists: src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
    - File exists: src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
    - Compiles without errors: `dotnet build src/MotoRent.Client`
    - Dialog inherits from LocalizedDialogBase
    - Has search input and results display
  </verify>
  <done>
    TillTransactionDialog.razor created with search-then-select UI that searches both bookings and rentals
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend RentalService and TillTransactionType</name>
  <files>
    src/MotoRent.Services/RentalService.cs
    src/MotoRent.Domain/Entities/TillTransactionType.cs
  </files>
  <action>
    1. **Add rental search method to RentalService:**
       ```csharp
       /// <summary>
       /// Searches active rentals by renter name or rental ID.
       /// </summary>
       public async Task<List<Rental>> SearchActiveRentalsAsync(string searchTerm, int? shopId = null)
       {
           var query = m_context.CreateQuery<Rental>()
               .Where(r => r.Status == "Active");

           if (shopId.HasValue)
           {
               query = query.Where(r => r.RentedFromShopId == shopId.Value);
           }

           var result = await m_context.LoadAsync(query, 1, 50, includeTotalRows: false);

           // Filter by renter name in memory (case-insensitive contains)
           var term = searchTerm.ToLowerInvariant();
           return result.ItemCollection
               .Where(r => r.RenterName?.ToLowerInvariant().Contains(term) ?? false)
               .ToList();
       }
       ```

    2. **Extend TillTransactionType enum:**
       - Add `CheckIn` value if not exists (for check-in transactions)
       - Ensure enum has: BookingDeposit, CheckIn, CheckOut, RentalPayment

       Location: src/MotoRent.Domain/Entities/TillTransactionType.cs
       Add to enum: `CheckIn` (if missing)
  </action>
  <verify>
    - RentalService has SearchActiveRentalsAsync method
    - TillTransactionType has CheckIn value
    - Compiles without errors: `dotnet build src/MotoRent.Services src/MotoRent.Domain`
  </verify>
  <done>
    RentalService extended with search capability, TillTransactionType has CheckIn value
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire dialog to Till page with New Transaction button</name>
  <files>
    src/MotoRent.Client/Pages/Staff/Till.razor
  </files>
  <action>
    1. **Add "New Transaction" button to Till.razor:**
       - Add prominent button in the Quick Payments section or above it
       - Use primary action styling: `mr-btn-primary-action` or similar
       - Icon: `ti ti-receipt-2` or `ti ti-cash-banknote`
       - Label: "New Transaction"

    2. **Add method to launch dialog:**
       ```csharp
       private async Task NewTransactionDialog()
       {
           if (this.m_session is null) return;

           var result = await this.DialogService.Create<TillTransactionDialog>(Localizer["NewTransaction"])
               .WithParameter(x => x.SessionId, this.m_session.TillSessionId)
               .WithParameter(x => x.ShopId, this.m_shopId)
               .WithFullscreen()
               .ShowDialogAsync();

           if (result is { Cancelled: false, Data: not null })
           {
               // Result contains the selected entity and transaction type
               // For now, just reload data - Phase 3 Plan 2 will handle item confirmation
               await this.LoadDataAsync();
           }
       }
       ```

    3. **Update localization:**
       - Add "NewTransaction" key to Till.resx files

    4. **Keep existing Quick Payments buttons** for now (they can be deprecated later once new flow is proven)
  </action>
  <verify>
    - Till.razor has NewTransactionDialog method
    - New Transaction button visible when session is active
    - Compiles without errors: `dotnet build src/MotoRent.Client`
    - Dialog opens in fullscreen when button clicked
  </verify>
  <done>
    Till.razor has New Transaction button that opens TillTransactionDialog in fullscreen mode
  </done>
</task>

</tasks>

<verification>
1. Build project: `dotnet build`
2. Navigate to `/staff/till` with active session
3. Click "New Transaction" button
4. Search for a booking by customer name - results should appear
5. Search for a booking by ref (e.g., "ABC123") - exact match should appear
6. Search for an active rental - should appear under "Active Rentals" section
7. Select a booking with BalanceDue > 0 - dialog should return with BookingDeposit type
8. Select a Confirmed booking - dialog should return with CheckIn type
</verification>

<success_criteria>
1. TillTransactionDialog opens in fullscreen with search input
2. Search finds bookings by ref, customer name, and phone
3. Search finds active rentals by renter name
4. Results grouped by type (Bookings vs Active Rentals)
5. Selecting entity returns {Entity, TransactionType} to calling page
6. Transaction type auto-detected from entity status
</success_criteria>

<output>
After completion, create `.planning/phases/03-transaction-search-items/03-01-SUMMARY.md`
</output>
