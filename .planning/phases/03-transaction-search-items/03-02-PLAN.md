---
phase: 03-transaction-search-items
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
  - src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  - src/MotoRent.Domain/Entities/TransactionLineItem.cs
  - src/MotoRent.Domain/Entities/ReceiptItemCategory.cs
autonomous: true

must_haves:
  truths:
    - "Staff sees customer, vehicle, and date summary after selecting booking/rental"
    - "Staff sees line items with prices (rental, insurance, accessories, deposit)"
    - "Staff can add available accessories to the transaction"
    - "Staff can remove accessories from the transaction"
    - "Staff can change insurance package selection"
    - "Staff can apply percentage discount with reason"
    - "Staff can apply fixed amount discount with reason"
    - "Running total updates when items change"
    - "Layout is two columns on tablet/PC, stacked on mobile"
  artifacts:
    - path: "src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor"
      provides: "Fullscreen item confirmation with edit capabilities"
      min_lines: 400
    - path: "src/MotoRent.Domain/Entities/TransactionLineItem.cs"
      provides: "Line item model for transaction editing"
      min_lines: 20
  key_links:
    - from: "TillTransactionDialog.razor"
      to: "AccessoryService"
      via: "inject AccessoryService"
      pattern: "AccessoryService"
    - from: "TillTransactionDialog.razor"
      to: "InsuranceService"
      via: "inject InsuranceService"
      pattern: "InsuranceService"
---

<objective>
Add fullscreen item confirmation and editing capabilities to TillTransactionDialog.

Purpose: After selecting a booking/rental, staff need to review all line items (rental charges, insurance, accessories, deposit) and make adjustments before proceeding to payment. This includes adding/removing accessories, changing insurance, and applying discounts.

Output:
- Extended TillTransactionDialog with Step 2 (item confirmation)
- TransactionLineItem model for working with line items
- Accessory selection UI
- Insurance change UI
- Discount application UI
- Responsive two-column layout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transaction-search-items/03-CONTEXT.md
@.planning/phases/03-transaction-search-items/03-RESEARCH.md

# Prior plan summary (dependency)
@.planning/phases/03-transaction-search-items/03-01-SUMMARY.md

# Key existing patterns
@src/MotoRent.Domain/Entities/ReceiptItem.cs
@src/MotoRent.Domain/Entities/BookingItem.cs
@src/MotoRent.Domain/Entities/Accessory.cs
@src/MotoRent.Domain/Entities/Insurance.cs
@src/MotoRent.Services/AccessoryService.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TransactionLineItem model and category constants</name>
  <files>
    src/MotoRent.Domain/Entities/TransactionLineItem.cs
    src/MotoRent.Domain/Entities/ReceiptItemCategory.cs
  </files>
  <action>
    1. **Create TransactionLineItem.cs:**
       This is a working model for building line items during transaction editing.
       Similar to ReceiptItem but with edit-specific properties.

       ```csharp
       namespace MotoRent.Domain.Entities;

       /// <summary>
       /// Working line item model for transaction editing.
       /// Converted to ReceiptItem when creating receipt.
       /// </summary>
       public class TransactionLineItem
       {
           /// <summary>Unique identifier for this item (for list manipulation)</summary>
           public string ItemId { get; set; } = Guid.NewGuid().ToString("N")[..8];

           /// <summary>Category: Rental, Insurance, Accessory, Deposit, Discount</summary>
           public string Category { get; set; } = string.Empty;

           /// <summary>Description (e.g., "Honda PCX 160", "Basic Insurance")</summary>
           public string Description { get; set; } = string.Empty;

           /// <summary>Detail line (e.g., "3 days @ 500/day")</summary>
           public string? Detail { get; set; }

           /// <summary>Quantity (days or units)</summary>
           public decimal Quantity { get; set; } = 1;

           /// <summary>Price per unit</summary>
           public decimal UnitPrice { get; set; }

           /// <summary>Total amount for this line</summary>
           public decimal Amount { get; set; }

           /// <summary>Whether this is a deduction (discount, refund)</summary>
           public bool IsDeduction { get; set; }

           /// <summary>Sort order for display</summary>
           public int SortOrder { get; set; }

           /// <summary>For accessories: the accessory ID for removal</summary>
           public int? AccessoryId { get; set; }

           /// <summary>For insurance: the insurance ID for changes</summary>
           public int? InsuranceId { get; set; }

           /// <summary>Whether this item can be removed by staff</summary>
           public bool CanRemove { get; set; }

           /// <summary>Reason for discount (required for Discount category)</summary>
           public string? DiscountReason { get; set; }
       }
       ```

    2. **Create or extend ReceiptItemCategory.cs** (if not exists):
       ```csharp
       namespace MotoRent.Domain.Entities;

       /// <summary>
       /// Standard categories for receipt/transaction line items.
       /// </summary>
       public static class ReceiptItemCategory
       {
           public const string Rental = "Rental";
           public const string Insurance = "Insurance";
           public const string Accessory = "Accessory";
           public const string Deposit = "Deposit";
           public const string Discount = "Discount";
           public const string Damage = "Damage";
           public const string LateFee = "LateFee";
           public const string LocationFee = "LocationFee";
       }
       ```
  </action>
  <verify>
    - File exists: src/MotoRent.Domain/Entities/TransactionLineItem.cs
    - File exists or extended: src/MotoRent.Domain/Entities/ReceiptItemCategory.cs
    - Compiles: `dotnet build src/MotoRent.Domain`
  </verify>
  <done>
    TransactionLineItem model created for transaction editing, ReceiptItemCategory constants defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Add item confirmation UI to TillTransactionDialog</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  </files>
  <action>
    Extend TillTransactionDialog.razor to add Step 2 (item confirmation):

    1. **Add state for Step 2:**
       ```csharp
       // Selected entity
       private Booking? m_selectedBooking;
       private Rental? m_selectedRental;
       private TillTransactionType m_transactionType;

       // Line items
       private List<TransactionLineItem> m_lineItems = [];
       private decimal m_subtotal;
       private decimal m_discountTotal;
       private decimal m_grandTotal;

       // Available options for editing
       private List<Accessory> m_availableAccessories = [];
       private List<Insurance> m_availableInsurances = [];
       ```

    2. **Inject additional services:**
       ```csharp
       @inject AccessoryService AccessoryService
       @inject InsuranceService InsuranceService
       ```

    3. **Add Step 2 UI (item confirmation):**
       Condition: Show when `m_selectedBooking is not null || m_selectedRental is not null`

       **Layout - Responsive two columns:**
       ```html
       <div class="row">
           <div class="col-12 col-md-5 mb-3 mb-md-0">
               <!-- Left: Customer & Booking Summary -->
           </div>
           <div class="col-12 col-md-7">
               <!-- Right: Line Items & Actions -->
           </div>
       </div>
       ```

       **Left column - Summary card:**
       - Customer name, phone
       - Vehicle name
       - Dates (start - end), duration in days
       - Transaction type badge (Booking Deposit / Check-In / Check-Out)

       **Right column - Line items:**
       - Table/list of line items with Category, Description, Amount
       - Each item row shows: icon (by category), description, detail, amount
       - Removable items (accessories, discounts) have X button
       - Subtotal, Discount, Grand Total at bottom

    4. **Add action buttons row:**
       ```html
       <div class="d-flex gap-2 mb-3">
           <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ShowAddAccessoryDialog">
               <i class="ti ti-plus"></i> @Localizer["AddAccessory"]
           </button>
           <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ShowChangeInsuranceDialog">
               <i class="ti ti-shield"></i> @Localizer["ChangeInsurance"]
           </button>
           <button type="button" class="btn btn-outline-warning btn-sm" @onclick="ShowApplyDiscountDialog">
               <i class="ti ti-discount-2"></i> @Localizer["ApplyDiscount"]
           </button>
       </div>
       ```

    5. **Add BuildLineItemsFromBooking method:**
       ```csharp
       private void BuildLineItemsFromBooking(Booking booking)
       {
           m_lineItems.Clear();
           var days = booking.Days;
           int sortOrder = 0;

           foreach (var item in booking.Items)
           {
               // Vehicle rental
               m_lineItems.Add(new TransactionLineItem
               {
                   Category = ReceiptItemCategory.Rental,
                   Description = item.VehicleDisplayName ?? "Vehicle",
                   Detail = $"{days} days @ {item.DailyRate:N0}/day",
                   Quantity = days,
                   UnitPrice = item.DailyRate,
                   Amount = item.DailyRate * days,
                   SortOrder = sortOrder++,
                   CanRemove = false
               });

               // Insurance (if any)
               if (item.InsuranceId.HasValue && item.InsuranceRate > 0)
               {
                   m_lineItems.Add(new TransactionLineItem
                   {
                       Category = ReceiptItemCategory.Insurance,
                       Description = item.InsuranceName ?? "Insurance",
                       Detail = $"{days} days @ {item.InsuranceRate:N0}/day",
                       Quantity = days,
                       UnitPrice = item.InsuranceRate,
                       Amount = item.InsuranceRate * days,
                       InsuranceId = item.InsuranceId,
                       SortOrder = sortOrder++,
                       CanRemove = false // Changed via ChangeInsurance
                   });
               }

               // Security deposit (for check-in)
               if (m_transactionType == TillTransactionType.CheckIn && item.DepositAmount > 0)
               {
                   m_lineItems.Add(new TransactionLineItem
                   {
                       Category = ReceiptItemCategory.Deposit,
                       Description = "Security Deposit",
                       Amount = item.DepositAmount,
                       SortOrder = sortOrder++,
                       CanRemove = false
                   });
               }
           }

           // Location fees
           if (booking.PickupLocationFee > 0)
           {
               m_lineItems.Add(new TransactionLineItem
               {
                   Category = ReceiptItemCategory.LocationFee,
                   Description = $"Pickup: {booking.PickupLocationName}",
                   Amount = booking.PickupLocationFee,
                   SortOrder = sortOrder++,
                   CanRemove = false
               });
           }

           RecalculateTotals();
       }
       ```

    6. **Add RecalculateTotals method:**
       ```csharp
       private void RecalculateTotals()
       {
           m_subtotal = m_lineItems.Where(i => !i.IsDeduction).Sum(i => i.Amount);
           m_discountTotal = m_lineItems.Where(i => i.IsDeduction).Sum(i => Math.Abs(i.Amount));
           m_grandTotal = m_subtotal - m_discountTotal;
       }
       ```

    7. **Footer with navigation:**
       ```html
       <div class="modal-footer sticky-bottom bg-white border-top">
           <button type="button" class="btn btn-ghost-secondary" @onclick="ClearSelection">
               <i class="ti ti-arrow-left"></i> @Localizer["Back"]
           </button>
           <button type="button" class="btn btn-purple btn-lg" @onclick="ProceedToPayment"
                   disabled="@(m_grandTotal <= 0)">
               <i class="ti ti-credit-card"></i>
               @Localizer["ProceedToPayment"] - @(m_grandTotal.ToString("N0")) THB
           </button>
       </div>
       ```

    8. **Add localization entries:**
       - CustomerSummary, VehicleDetails, RentalPeriod, Days
       - LineItems, Subtotal, Discount, Total
       - AddAccessory, ChangeInsurance, ApplyDiscount
       - ProceedToPayment, Back, RemoveItem
       - SecurityDeposit, RentalCharge, InsurancePackage
  </action>
  <verify>
    - TillTransactionDialog.razor has Step 2 UI with responsive layout
    - Line items display after booking selection
    - Compiles: `dotnet build src/MotoRent.Client`
  </verify>
  <done>
    TillTransactionDialog shows fullscreen item confirmation with customer/vehicle summary and line item display
  </done>
</task>

<task type="auto">
  <name>Task 3: Add accessory, insurance, and discount editing</name>
  <files>
    src/MotoRent.Client/Pages/Staff/TillTransactionDialog.razor
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.en.resx
    src/MotoRent.Client/Resources/Pages/Staff/TillTransactionDialog.th.resx
  </files>
  <action>
    Add inline editing capabilities for accessories, insurance, and discounts:

    1. **Add accessory state and dialog:**
       ```csharp
       // Accessory selection state
       private bool m_showAccessorySelector;
       private int? m_selectedAccessoryId;

       private async Task LoadAvailableAccessoriesAsync()
       {
           m_availableAccessories = await AccessoryService.GetAvailableAccessoriesAsync(m_shopId);
       }

       private void ShowAddAccessoryDialog()
       {
           m_showAccessorySelector = true;
           m_selectedAccessoryId = null;
       }

       private void AddAccessory(Accessory accessory)
       {
           var days = m_selectedBooking?.Days ?? 1;
           m_lineItems.Add(new TransactionLineItem
           {
               Category = ReceiptItemCategory.Accessory,
               Description = accessory.Name,
               Detail = $"{days} days @ {accessory.DailyRate:N0}/day",
               Quantity = days,
               UnitPrice = accessory.DailyRate,
               Amount = accessory.DailyRate * days,
               AccessoryId = accessory.AccessoryId,
               CanRemove = true,
               SortOrder = 100 + m_lineItems.Count
           });
           m_showAccessorySelector = false;
           RecalculateTotals();
       }

       private void RemoveLineItem(TransactionLineItem item)
       {
           m_lineItems.Remove(item);
           RecalculateTotals();
       }
       ```

    2. **Add accessory selector UI (inline or modal):**
       ```html
       @if (m_showAccessorySelector)
       {
           <div class="card card-body mb-3">
               <div class="d-flex justify-content-between align-items-center mb-2">
                   <strong>@Localizer["SelectAccessory"]</strong>
                   <button type="button" class="btn btn-sm btn-ghost-secondary" @onclick="@(() => m_showAccessorySelector = false)">
                       <i class="ti ti-x"></i>
                   </button>
               </div>
               <div class="list-group">
                   @foreach (var acc in m_availableAccessories.Where(a => !m_lineItems.Any(li => li.AccessoryId == a.AccessoryId)))
                   {
                       <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between"
                               @onclick="@(() => AddAccessory(acc))">
                           <span>@acc.Name</span>
                           <span class="text-muted">@(acc.DailyRate:N0)/day</span>
                       </button>
                   }
               </div>
           </div>
       }
       ```

    3. **Add insurance change state and UI:**
       ```csharp
       private bool m_showInsuranceSelector;

       private async Task LoadAvailableInsurancesAsync()
       {
           m_availableInsurances = await InsuranceService.GetActiveInsurancesAsync();
       }

       private void ShowChangeInsuranceDialog()
       {
           m_showInsuranceSelector = true;
       }

       private void ChangeInsurance(Insurance insurance)
       {
           var days = m_selectedBooking?.Days ?? 1;

           // Remove existing insurance line item
           var existingInsurance = m_lineItems.FirstOrDefault(i => i.Category == ReceiptItemCategory.Insurance);
           if (existingInsurance != null)
           {
               m_lineItems.Remove(existingInsurance);
           }

           // Add new insurance
           m_lineItems.Add(new TransactionLineItem
           {
               Category = ReceiptItemCategory.Insurance,
               Description = insurance.Name,
               Detail = $"{days} days @ {insurance.DailyRate:N0}/day",
               Quantity = days,
               UnitPrice = insurance.DailyRate,
               Amount = insurance.DailyRate * days,
               InsuranceId = insurance.InsuranceId,
               SortOrder = 10,
               CanRemove = false
           });

           m_showInsuranceSelector = false;
           RecalculateTotals();
       }
       ```

    4. **Add discount state and UI:**
       ```csharp
       private bool m_showDiscountForm;
       private decimal m_discountValue;
       private bool m_discountIsPercent = true;
       private string m_discountReason = "";

       private void ShowApplyDiscountDialog()
       {
           m_showDiscountForm = true;
           m_discountValue = 0;
           m_discountIsPercent = true;
           m_discountReason = "";
       }

       private void ApplyDiscount()
       {
           if (m_discountValue <= 0 || string.IsNullOrWhiteSpace(m_discountReason)) return;

           decimal discountAmount;
           string detail;

           if (m_discountIsPercent)
           {
               discountAmount = m_subtotal * (m_discountValue / 100m);
               detail = $"{m_discountValue}% discount";
           }
           else
           {
               discountAmount = m_discountValue;
               detail = "Fixed discount";
           }

           m_lineItems.Add(new TransactionLineItem
           {
               Category = ReceiptItemCategory.Discount,
               Description = m_discountReason,
               Detail = detail,
               Amount = -discountAmount,
               IsDeduction = true,
               DiscountReason = m_discountReason,
               CanRemove = true,
               SortOrder = 999
           });

           m_showDiscountForm = false;
           RecalculateTotals();
       }
       ```

    5. **Add discount form UI:**
       ```html
       @if (m_showDiscountForm)
       {
           <div class="card card-body mb-3 bg-warning-lt">
               <div class="d-flex justify-content-between align-items-center mb-2">
                   <strong>@Localizer["ApplyDiscount"]</strong>
                   <button type="button" class="btn btn-sm btn-ghost-secondary" @onclick="@(() => m_showDiscountForm = false)">
                       <i class="ti ti-x"></i>
                   </button>
               </div>

               <div class="mb-2">
                   <div class="btn-group w-100" role="group">
                       <input type="radio" class="btn-check" id="discountPercent" @bind="m_discountIsPercent" value="true">
                       <label class="btn btn-outline-primary" for="discountPercent">@Localizer["Percentage"]</label>
                       <input type="radio" class="btn-check" id="discountFixed" @bind="m_discountIsPercent" value="false">
                       <label class="btn btn-outline-primary" for="discountFixed">@Localizer["FixedAmount"]</label>
                   </div>
               </div>

               <div class="mb-2">
                   <div class="input-group">
                       <input type="number" class="form-control" @bind="m_discountValue" min="0"
                              placeholder="@(m_discountIsPercent ? "10" : "100")"/>
                       <span class="input-group-text">@(m_discountIsPercent ? "%" : "THB")</span>
                   </div>
               </div>

               <div class="mb-2">
                   <input type="text" class="form-control" @bind="m_discountReason"
                          placeholder="@Localizer["DiscountReason"]" required />
                   <div class="form-hint">@Localizer["DiscountReasonRequired"]</div>
               </div>

               <button type="button" class="btn btn-warning w-100" @onclick="ApplyDiscount"
                       disabled="@(m_discountValue <= 0 || string.IsNullOrWhiteSpace(m_discountReason))">
                   <i class="ti ti-check"></i> @Localizer["Apply"]
               </button>
           </div>
       }
       ```

    6. **Initialize options when entity selected:**
       ```csharp
       private async Task SelectBooking(Booking booking)
       {
           m_selectedBooking = booking;
           m_transactionType = DetectTransactionType(booking);
           BuildLineItemsFromBooking(booking);
           await LoadAvailableAccessoriesAsync();
           await LoadAvailableInsurancesAsync();
       }

       private TillTransactionType DetectTransactionType(Booking booking)
       {
           if (booking.Status == BookingStatus.Pending || booking.Status == BookingStatus.Confirmed)
           {
               return TillTransactionType.CheckIn;
           }
           return TillTransactionType.BookingDeposit;
       }
       ```

    7. **Add localization entries:**
       - SelectAccessory, NoAccessoriesAvailable
       - SelectInsurance, CurrentInsurance
       - Percentage, FixedAmount, DiscountReason, DiscountReasonRequired, Apply
  </action>
  <verify>
    - Can add accessories to line items
    - Can change insurance package
    - Can apply percentage discount with reason
    - Can apply fixed discount with reason
    - Can remove added accessories and discounts
    - Running total updates on changes
    - Compiles: `dotnet build src/MotoRent.Client`
  </verify>
  <done>
    TillTransactionDialog supports adding accessories, changing insurance, and applying discounts with required reason
  </done>
</task>

</tasks>

<verification>
1. Build project: `dotnet build`
2. Navigate to `/staff/till` with active session
3. Click "New Transaction" and search for a booking
4. Select booking - should show item confirmation with two-column layout
5. Verify customer/vehicle summary in left column
6. Verify line items in right column (rental, insurance, deposit if check-in)
7. Click "Add Accessory" - should show available accessories
8. Add a helmet - line item should appear, total should update
9. Click "Change Insurance" - should show insurance options
10. Change insurance - line item should update, total should recalculate
11. Click "Apply Discount" - should show discount form
12. Apply 10% discount with reason "Returning customer" - discount line should appear
13. Remove discount - total should recalculate back
14. Test on mobile viewport - should stack to single column
</verification>

<success_criteria>
1. Item confirmation shows responsive two-column layout
2. Line items built correctly from booking data
3. Accessories can be added from available list
4. Insurance can be changed to different package
5. Percentage and fixed discounts work with required reason
6. Running total updates in real-time
7. "Proceed to Payment" button shows grand total
8. Mobile layout stacks sections vertically
</success_criteria>

<output>
After completion, create `.planning/phases/03-transaction-search-items/03-02-SUMMARY.md`
</output>
